"use strict";(self.webpackChunk_dashlane_amphora=self.webpackChunk_dashlane_amphora||[]).push([[363],{36636:(e,t,s)=>{s.d(t,{e:()=>a});var r=s(8260),i=s(29986);class a extends((0,r.E)(i.V)){}(0,r.K)(i.V,a)},29986:(e,t,s)=>{s.d(t,{V:()=>o});var r=s(75958),i=s(33672),a=s(75203);const o=(0,r.Q)({name:"authenticationFlow",commands:{changeLogin:a.hW,changeTwoFactorAuthenticationOtpType:a.eG,clearError:a.jq,cancelDeviceTransferRequest:a.Yc,resendEmailToken:a.Gc,resendPushNotification:a.rF,sendAccountEmail:a.A,sendMasterPassword:a.rT,submitPinCode:a.CO,submitBackupCode:a.sH,submitEmailToken:a.XH,submitTotp:a.ad,switchToDevicetoDeviceAuthentication:a.sU,switchToDashlaneAuthenticator:a.K1,switchToMasterPasswordCommand:a.On,switchToEmailToken:a.v5,switchToPinCode:a.WF,retryWebAuthnAuthentication:a.M6,webAuthnAuthenticationFail:a.O3,logout:a.N5,lockSession:a.Y$,loginViaSSO:a.yv,initiateLoginWithSSO:a.Hr,initiateAutologinWithSSOCommand:a.x2},queries:{authenticationFlowStatus:i.DW,getSsoUserSettings:i.Dc,getProviderInfo:i.L2},events:{}})},75203:(e,t,s)=>{s.d(t,{A:()=>a,CO:()=>n,Gc:()=>v,Hr:()=>A,K1:()=>l,M6:()=>w,N5:()=>b,O3:()=>I,On:()=>c,WF:()=>u,XH:()=>p,Y$:()=>E,Yc:()=>T,ad:()=>h,eG:()=>g,hW:()=>o,jq:()=>f,rF:()=>_,rT:()=>y,sH:()=>m,sU:()=>d,v5:()=>S,x2:()=>R,yv:()=>C});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}class o extends((0,r.g)({scope:i.F.Device})){}class n extends((0,r.g)({scope:i.F.Device})){}class c extends((0,r.g)({scope:i.F.Device})){}class d extends((0,r.g)({scope:i.F.Device})){}class l extends((0,r.g)({scope:i.F.Device})){}class u extends((0,r.g)({scope:i.F.Device})){}class p extends((0,r.g)({scope:i.F.Device})){}class h extends((0,r.g)({scope:i.F.Device})){}class m extends((0,r.g)({scope:i.F.Device})){}class g extends((0,r.g)({scope:i.F.Device})){}class v extends((0,r.g)({scope:i.F.Device})){}class y extends((0,r.g)({scope:i.F.Device})){}class _ extends((0,r.g)({scope:i.F.Device})){}class S extends((0,r.g)({scope:i.F.Device})){}class f extends((0,r.g)({scope:i.F.Device})){}class w extends((0,r.g)({scope:i.F.Device})){}class I extends((0,r.g)({scope:i.F.Device})){}class b extends((0,r.g)({scope:i.F.Device})){}class E extends((0,r.g)({scope:i.F.Device})){}class C extends((0,r.g)({scope:i.F.Device})){}class A extends((0,r.g)({scope:i.F.Device})){}class R extends((0,r.g)({scope:i.F.Device})){}class T extends((0,r.g)({scope:i.F.Device})){}},33672:(e,t,s)=>{s.d(t,{DW:()=>a,Dc:()=>o,L2:()=>n});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}class o extends((0,r.k)({scope:i.F.Device})){}class n extends((0,r.k)({scope:i.F.Device})){}},64496:(e,t,s)=>{var r,i,a;s.d(t,{E6:()=>i,UY:()=>a,ao:()=>o,hr:()=>r,vX:()=>n}),function(e){e.SSO="sso",e.MP="master_password"}(r||(r={})),function(e){e.WaitingForTransferRequest="WaitingForTransferRequest",e.DisplayInstructions="DisplayInstructions",e.LoadingPassphrase="LoadingPassphrase",e.DisplayPassphrase="DisplayPassphrase",e.LoadingAccount="LoadingAccount",e.Error="Error",e.DeviceRegistered="DeviceRegistered"}(i||(i={})),function(e){e.GENERIC_ERROR="GENERIC_ERROR",e.TIMEOUT="TIMEOUT",e.REQUEST_REJECTED="REQUEST_REJECTED",e.ACCOUNT_ERROR="ACCOUNT_ERROR",e.RATE_LIMIT="RATE_LIMIT"}(a||(a={}));const o=e=>Object.values(a).includes(e);var n;!function(e){e[e.MP_TO_SSO=0]="MP_TO_SSO",e[e.MP_TO_SSO_WITH_INFO=1]="MP_TO_SSO_WITH_INFO",e[e.SSO_TO_MP=2]="SSO_TO_MP"}(n||(n={}))},66974:(e,t,s)=>{s.d(t,{n:()=>a});var r=s(75958),i=s(85373);const a=(0,r.Q)({name:"authentication",commands:{},events:{},queries:{canLockApp:i._}})},85373:(e,t,s)=>{s.d(t,{I:()=>a,_:()=>o});var r=s(77535),i=s(62149);const a="USER_NOT_LOGGED_IN";class o extends((0,r.k)({scope:i.F.User,noUserError:{tag:a}})){}},42853:(e,t,s)=>{s.d(t,{G:()=>n});var r=s(75958),i=s(319),a=s(96782),o=s(59463);const n=(0,r.Q)({name:"deviceRegistration",commands:{cleanRemotelyRemovedProfiles:i.L,registerDevice:a.J},events:{},queries:{localAccounts:o.a}})},25565:(e,t,s)=>{s.d(t,{z:()=>a});var r=s(8260),i=s(42853);class a extends((0,r.E)(i.G)){}(0,r.K)(i.G,a)},319:(e,t,s)=>{s.d(t,{L:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},96782:(e,t,s)=>{s.d(t,{J:()=>n,Y:()=>o});var r=s(13385),i=s(62149),a=s(7165);const o=a.z.discriminatedUnion("with",[a.z.object({with:a.z.literal("token"),login:a.z.string(),token:a.z.string(),deviceName:a.z.optional(a.z.string()),ignoreAlreadyRegisteredError:a.z.optional(a.z.boolean())}),a.z.object({with:a.z.literal("authTicket"),login:a.z.string(),authTicket:a.z.string(),deviceName:a.z.optional(a.z.string()),ignoreAlreadyRegisteredError:a.z.optional(a.z.boolean())}),a.z.object({with:a.z.literal("deviceKeys"),login:a.z.string(),deviceName:a.z.optional(a.z.string()),ignoreAlreadyRegisteredError:a.z.optional(a.z.boolean()),deviceAccessKey:a.z.string(),deviceSecretKey:a.z.string(),settings:a.z.string(),userAnalyticsId:a.z.string(),serverKey:a.z.optional(a.z.string())})]);class n extends((0,r.g)({scope:i.F.Device})){}},59463:(e,t,s)=>{s.d(t,{a:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},6218:(e,t,s)=>{s.d(t,{F:()=>u});var r=s(75958),i=s(53835),a=s(33969),o=s(97891),n=s(87041),c=s(55870),d=s(48214),l=s(81540);const u=(0,r.Q)({name:"deviceTransfer",commands:{refreshRequest:a.V,cancelRequest:o.b,approveRequest:n.G,rejectRequest:c.a,submitPassphraseChallenge:d.I,returnToDeviceSetupCommand:l.n},events:{},queries:{trustedDeviceFlowStatus:i.N}})},87041:(e,t,s)=>{s.d(t,{G:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},97891:(e,t,s)=>{s.d(t,{b:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},33969:(e,t,s)=>{s.d(t,{V:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},55870:(e,t,s)=>{s.d(t,{a:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},81540:(e,t,s)=>{s.d(t,{n:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},48214:(e,t,s)=>{s.d(t,{I:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},53835:(e,t,s)=>{s.d(t,{N:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},70486:(e,t,s)=>{var r,i;s.d(t,{S:()=>r,T:()=>i}),function(e){e.GENERIC_ERROR="GENERIC_ERROR",e.INVALID_PASSPHRASE="INVALID_PASSPHRASE",e.TIMEOUT="TIMEOUT",e.PASSPHRASE_ATTEMPTS_LIMIT="PASSPHRASE_ATTEMPTS_LIMIT"}(r||(r={})),function(e){e[e.WaitingForNewDeviceRequest=0]="WaitingForNewDeviceRequest",e[e.NewDeviceRequestAvailable=1]="NewDeviceRequestAvailable",e[e.DisplayPassphraseChallenge=2]="DisplayPassphraseChallenge",e[e.DeviceTransferComplete=3]="DeviceTransferComplete",e[e.LoadingChallenge=4]="LoadingChallenge",e[e.DeviceTransferRejected=5]="DeviceTransferRejected",e[e.Error=6]="Error"}(i||(i={}))},28760:(e,t,s)=>{var r;s.d(t,{T:()=>r}),function(e){e.PinCodePasskeyUVRelease="as_web_pincode_passkey_uv_release"}(r||(r={}))},11433:(e,t,s)=>{s.d(t,{i:()=>n});var r=s(75958),i=s(41025),a=s(13744),o=s(13089);const n=(0,r.Q)({name:"identityVerificationFlow",commands:{changeTwoFactorAuthenticationOtpType:a.eG,clearError:a.$5,resendEmailToken:a.Gc,resendPushNotification:a.rF,submitBackupCode:a.sH,submitEmailToken:a.XH,submitTotp:a.ad,switchToDashlaneAuthenticator:a.K1,switchToEmailToken:a.v5,startIdentityVerification:a.qw,cancelIdentityVerification:a.Vs},queries:{identityVerificationFlowStatus:i.O},events:{identityVerificationCompleted:o.w}})},13744:(e,t,s)=>{s.d(t,{$5:()=>o,Gc:()=>n,K1:()=>p,Vs:()=>g,XH:()=>d,ad:()=>u,eG:()=>a,qw:()=>m,rF:()=>c,sH:()=>l,v5:()=>h});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}class o extends((0,r.g)({scope:i.F.Device})){}class n extends((0,r.g)({scope:i.F.Device})){}class c extends((0,r.g)({scope:i.F.Device})){}class d extends((0,r.g)({scope:i.F.Device})){}class l extends((0,r.g)({scope:i.F.Device})){}class u extends((0,r.g)({scope:i.F.Device})){}class p extends((0,r.g)({scope:i.F.Device})){}class h extends((0,r.g)({scope:i.F.Device})){}class m extends((0,r.g)({scope:i.F.Device})){}class g extends((0,r.g)({scope:i.F.Device})){}},13089:(e,t,s)=>{s.d(t,{w:()=>a});var r=s(446),i=s(62149);class a extends((0,r.d)({scope:i.F.Device})){}},41025:(e,t,s)=>{s.d(t,{O:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},81822:(e,t,s)=>{s.d(t,{l:()=>a});var r=s(8260),i=s(11433);class a extends((0,r.E)(i.i)){}(0,r.K)(i.i,a)},12436:(e,t,s)=>{s.r(t),s.d(t,{CancelIdentityVerificationCommand:()=>i.Vs,ChangeTwoFactorAuthenticationOtpTypeCommand:()=>i.eG,ClearIdentityVerificationErrorCommand:()=>i.$5,IdentityVerificationClient:()=>o.l,IdentityVerificationCompletedEvent:()=>n.w,IdentityVerificationFlowStatusQuery:()=>a.O,ResendEmailTokenCommand:()=>i.Gc,ResendPushNotificationCommand:()=>i.rF,StartIdentityVerificationCommand:()=>i.qw,SubmitBackupCodeCommand:()=>i.sH,SubmitEmailTokenCommand:()=>i.XH,SubmitTotpCommand:()=>i.ad,SwitchToDashlaneAuthenticatorCommand:()=>i.K1,SwitchToEmailTokenCommand:()=>i.v5,identityVerificationFlowApi:()=>r.i});var r=s(11433),i=s(13744),a=s(41025),o=s(81822),n=s(13089)},36272:(e,t,s)=>{s.r(t),s.d(t,{ActivateCommand:()=>D.r,AuthenticationClient:()=>V,AuthenticationFeatureFlips:()=>z.T,AuthenticationFlowContracts:()=>r,CanLockAppQuery:()=>K._,CleanRemotelyRemovedProfilesCommand:()=>C.L,DeactivateCommand:()=>U.E,DeviceRegistrationClient:()=>T.z,DeviceTransferContracts:()=>i,GetCurrentUserStatusQuery:()=>x.o,GetStatusQuery:()=>P.D,IdentityVerificationFlowContracts:()=>l,IsPinCodeCorrectQuery:()=>N.M,LocalAccountsQuery:()=>R.a,LoginWithPinCodeCommand:()=>F.c,NO_ACTIVE_PIN_CODE:()=>L.DN,PinCodeClient:()=>G.u,PinCodeServerApiConfig:()=>k,RegisterDeviceCommand:()=>A.J,Request2FaCodesByPhoneCommand:()=>w.x,Request2FaCodesByPhoneErrorCodes:()=>I.A,USER_NOT_LOGGED_IN:()=>K.I,UserVerificationMethods:()=>b.W,UserVerificationMethodsQuery:()=>b.Y,ValidateWebauthnAssertionCommand:()=>w.L,WRONG_PIN_CODE:()=>L.Vh,authenticationApi:()=>M.n,createNoActivePinCodeError:()=>L.Zs,createWrongPinCodeError:()=>L.g5,deviceRegistrationApi:()=>E.G,pinCodeApi:()=>O.n,registrationSchema:()=>A.Y,userVerificationApi:()=>f.M});var r={};s.r(r),s.d(r,{AuthenticationFlowClient:()=>d.e,AuthenticationFlowStatusQuery:()=>n.DW,CancelDeviceTransferRequestCommand:()=>o.Yc,ChangeAccountEmailCommand:()=>o.hW,ChangeTwoFactorAuthenticationOtpTypeCommand:()=>o.eG,ClearErrorCommand:()=>o.jq,DeviceToDeviceAuthenticationErrors:()=>c.UY,DeviceToDeviceAuthenticationFlowStep:()=>c.E6,GetSsoProviderInfoQuery:()=>n.L2,GetSsoUserSettingsQuery:()=>n.Dc,InitiateAutologinWithSSOCommand:()=>o.x2,InitiateLoginWithSSOCommand:()=>o.Hr,LockCommand:()=>o.Y$,LoginViaSSOCommand:()=>o.yv,LogoutCommand:()=>o.N5,ResendEmailTokenCommand:()=>o.Gc,ResendPushNotificationCommand:()=>o.rF,RetryWebAuthnAuthenticationCommand:()=>o.M6,SSOMigrationType:()=>c.vX,SendAccountEmailCommand:()=>o.A,SendMasterPasswordCommand:()=>o.rT,SsoMigrationServerMethod:()=>c.hr,SubmitBackupCodeCommand:()=>o.sH,SubmitEmailTokenCommand:()=>o.XH,SubmitPinCodeCommand:()=>o.CO,SubmitTotpCommand:()=>o.ad,SwitchToDashlaneAuthenticatorCommand:()=>o.K1,SwitchToDevicetoDeviceAuthenticationCommand:()=>o.sU,SwitchToEmailTokenCommand:()=>o.v5,SwitchToMasterPasswordCommand:()=>o.On,SwitchToPinCodeCommand:()=>o.WF,WebAuthnAuthenticationFailCommand:()=>o.O3,authenticationFlowApi:()=>a.V,isDeviceToDeviceAuthenticationError:()=>c.ao});var i={};s.r(i),s.d(i,{ApproveDeviceTransferRequestCommand:()=>h.G,CancelRequestCommand:()=>v.b,RefreshRequestCommand:()=>p.V,RejectDeviceTransferRequestCommand:()=>m.a,ReturnToDeviceSetupCommand:()=>y.n,SubmitPassphraseChallengeCommand:()=>g.I,TrustedDeviceFlowErrors:()=>S.S,TrustedDeviceFlowStatusQuery:()=>_.N,TrustedDeviceFlowStep:()=>S.T,deviceTransferApi:()=>u.F});var a=s(29986),o=s(75203),n=s(33672),c=s(64496),d=s(36636),l=s(12436),u=s(6218),p=s(33969),h=s(87041),m=s(55870),g=s(48214),v=s(97891),y=s(81540),_=s(53835),S=s(70486),f=s(69401),w=s(11088),I=s(83853),b=s(33370),E=s(42853),C=s(319),A=s(96782),R=s(59463),T=s(25565),O=s(89033),D=s(85035),U=s(44878),F=s(73675),P=s(35941),x=s(67160),N=s(66861),G=s(42303);class k{constructor(e){this.env=e}}var L=s(34975),M=s(66974),K=s(85373),j=s(8260);class V extends((0,j.E)(M.n)){}(0,j.K)(M.n,V);var z=s(28760)},89033:(e,t,s)=>{s.d(t,{n:()=>l});var r=s(75958),i=s(85035),a=s(44878),o=s(73675),n=s(66861),c=s(35941),d=s(67160);const l=(0,r.Q)({name:"pinCode",commands:{activate:i.r,deactivate:a.E,loginWithPinCode:o.c},events:{},queries:{isPinCodeCorrect:n.M,getStatus:c.D,getCurrentUserStatus:d.o}})},42303:(e,t,s)=>{s.d(t,{u:()=>a});var r=s(8260),i=s(89033);class a extends((0,r.E)(i.n)){}(0,r.K)(i.n,a)},85035:(e,t,s)=>{s.d(t,{r:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},44878:(e,t,s)=>{s.d(t,{E:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},73675:(e,t,s)=>{s.d(t,{c:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},34975:(e,t,s)=>{s.d(t,{DN:()=>o,Vh:()=>i,Zs:()=>n,g5:()=>a});var r=s(96168);const i="WRONG_PIN_CODE",a=(0,r.Vj)(i,"Entered pin-code is not correct"),o="NO_ACTIVE_PIN_CODE",n=(0,r.Vj)(o,"User has no active pin-code")},67160:(e,t,s)=>{s.d(t,{o:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},35941:(e,t,s)=>{s.d(t,{D:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},66861:(e,t,s)=>{s.d(t,{M:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},83853:(e,t,s)=>{var r;s.d(t,{A:()=>r}),function(e){e.AccountNotEligible="AccountNotEligible",e.NetworkError="NetworkError"}(r||(r={}))},33370:(e,t,s)=>{s.d(t,{W:()=>r,Y:()=>o});var r,i=s(77535),a=s(62149);!function(e){e.Biometrics="Biometrics",e.Pin="Pin",e.MasterPassword="MasterPassword"}(r||(r={}));class o extends((0,i.k)({scope:a.F.User})){}},69401:(e,t,s)=>{s.d(t,{M:()=>o});var r=s(75958),i=s(11088),a=s(33370);const o=(0,r.Q)({name:"userVerification",commands:{validateWebauthnAssertion:i.L,request2FaCodesByPhone:i.x},queries:{userVerificationMethods:a.Y},events:{}})},11088:(e,t,s)=>{s.d(t,{L:()=>a,x:()=>o});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}class o extends((0,r.g)({scope:i.F.Device})){}},76561:(e,t,s)=>{s.d(t,{c:()=>Vt});var r=s(491),i=s(60399),a=s(29986),o=s(14676),n=s(14122),c=s(86006),d=s(86213),l=s(50423),u=s(63604),p=s(69259),h=s(87279),m=s(41511),g=s(5206),v=s(8362),y=s(62149),_=s(63144),S=s(87065);const f=e=>!0;class w extends((0,_.Q)({initialValue:void 0,persist:!1,scope:y.F.Device,storeName:"authentication-flow-machine",storeTypeGuard:f})){}var I=s(56618),b=s(10722);const E=e=>!(!e||"object"!=typeof e)&&"rememberMeForSSOPreference"in e;class C extends((0,_.Q)({codec:b.E,persist:!0,storage:{initialValue:{rememberMeForSSOPreference:!0},schemaVersion:1,typeGuard:E},scope:y.F.Device,storeName:"sso-info",storeTypeGuard:E,capacity:I.Y._001KB})){}const A=e=>!0;class R extends((0,_.Q)({persist:!1,initialValue:{},scope:y.F.Device,storeName:"sso-provider-info",storeTypeGuard:A,capacity:I.Y._001KB})){}var T=s(82874),O=s(75203),D=s(78065),U=s(20916),F=s(92587),P=s(18330),x=s(57357);class N{constructor(e,t){this.interpreter=e,this.carbon=t}execute(){try{const{carbonState:e}=this.carbon.queries;e({path:"userSession.loginDeviceLimitFlow.flow"}).pipe((0,S.U)((e=>{if("success"===e.tag)return e.data}))).subscribe((e=>{Boolean(this.lastDeviceLimitFlowValue)&&!e&&this.interpreter.send({type:"DEVICE_LIMIT_ABORTED"}),this.lastDeviceLimitFlowValue=e}))}catch(e){return Promise.reject(new Error("Unable to subscribe to loginDeviceLimitFlow state"))}}}var G=s(65865),k=s(18275),L=s(9497),M=s(29498);class K extends M.x{}var j=s(89358);let V=class{constructor(e,t){this.carbon=e,this.session=t}async executeWithParams({login:e,masterPassword:t,isRememberMeEnabled:s,serverKey:r}){try{const a=await(0,i.z)(this.session.queries.localSessions());if(!(0,h.d6)(a))throw new Error("Failure querying the session module to get the sessions");if(e in a.data){const i=await this.session.commands.openUserSession({email:e,rememberPassword:s,sessionKey:{type:"mp",masterPassword:t,secondaryKey:r}});if(!(0,h.d6)(i))throw new Error("Failed to open session");return Promise.resolve()}const o=await this.carbon.commands.openSessionWithMasterPassword({login:e,password:t,rememberPassword:s,requiredPermissions:void 0,loginType:"MasterPassword"});if(!(0,h.d6)(o))throw new Error("Failed to open session in carbon");return Promise.resolve()}catch(e){if(e instanceof Error){if(("exception"in e&&e.exception instanceof Error?e.exception.message:e.message).includes("WRONG_PASSWORD on openSessionWithMasterPassword"))return Promise.reject(new K)}return Promise.reject(new Error("UNKNOWN_ERROR"))}}};V=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[n._,j.x])],V);let z=class{constructor(e){this.carbonLegacy=e}async execute(){try{const e=await this.carbonLegacy.commands.carbon({name:"checkDoesLocalRecoveryKeyExist",args:[]});if(!(0,h.d6)(e))throw new Error("Carbon command failed");return{isAccountRecoveryAvailable:e.data.carbonResult.doesExist}}catch(e){return{isAccountRecoveryAvailable:!1}}}};z=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[n._])],z);var W=s(18533),q=s(20195),B=s(53344),$=s(64496);const Y=e=>"object"==typeof e&&"type"in e,Q=e=>{if(e)switch(e){case"sso_member_to_admin":case"sso_member_to_mp_user":return $.vX.SSO_TO_MP;case"mp_user_to_sso_member":return $.vX.MP_TO_SSO;default:return}};let H=class{constructor(e,t){this.ssoProviderInfoStore=e,this.serverApiClient=t,this.ssoProviderInfoStore=e,this.serverApiClient=t}async getSsoMigration(e){const t=await(0,i.z)(this.serverApiClient.v1.authentication.getAuthenticationMethodsForDevice({login:e,methods:["email_token","totp","duo_push","dashlane_authenticator","u2f"]}));if((0,h.hx)(t))return(0,W.EQ)(t.error,{FetchFailedError:()=>{},BusinessError:()=>(0,q.j)("Retrieve of verificationMethods failed"),InternalServerError:()=>(0,q.j)("Retrieve of verificationMethods failed"),InvalidRequest:()=>(0,q.j)("Retrieve of verificationMethods failed"),RateLimited:()=>(0,q.j)("Retrieve of verificationMethods failed"),ServiceUnavailable:()=>(0,q.j)("Retrieve of verificationMethods failed"),UnspecifiedBadStatus:()=>(0,q.j)("Retrieve of verificationMethods failed")});const s=t.data.data.verifications.find(Y);if(!s)throw new Error("No valid verification method");return"sso"===s.type?{serviceProviderUrl:s.ssoInfo.serviceProviderUrl,isNitroProvider:s.ssoInfo.isNitroProvider,migration:s.ssoInfo.migration}:void 0}async executeWithParams({login:e}){const t=await this.getSsoMigration(e);if(t)return await this.ssoProviderInfoStore.set({isNitroProvider:t.isNitroProvider??!1,serviceProviderUrl:t.serviceProviderUrl,migrationType:Q(t.migration)}),{serviceProviderRedirectUrl:t.serviceProviderUrl,isNitroProvider:t.isNitroProvider}}};H=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[R,B.l])],H);let J=class{constructor(e){this.session=e}async executeWithParams(e){const t=await(0,i.z)(this.session.queries.checkSessionKey({email:e.login,sessionKey:{type:"mp",masterPassword:e.masterPassword,secondaryKey:e.serverKey}}));if(!(0,h.d6)(t))throw new Error("Error verifying SK");if(t.data)return!0;throw new K}};J=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[j.x])],J);let Z=class{constructor(e,t,s,r){this.accountRecoveryStatusService=e,this.masterPasswordService=t,this.checkIsMigrationNeededService=s,this.mpVerificationService=r}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},initial:"CheckingAccountRecoveryStatus",id:"MasterPasswordFlowMachine",context:{isRememberMeEnabled:!1,isAccountRecoveryAvailable:!1},states:{CheckingAccountRecoveryStatus:{invoke:{src:"checkAccountRecoveryStatus",onDone:{target:"WaitingForMasterPassword",actions:["assignAccountRecoveryStatus"]}}},WaitingForMasterPassword:{on:{INPUT_MASTER_PASSWORD:{target:"ValidatingMasterPassword",actions:["assignMasterPassword"]},SWITCH_TO_PIN_CODE:{target:"#AuthenticationFlowMachine.PinCode",cond:"hasPinCodeEnabled"},CARBON_WRONG_PASSWORD:{actions:["assignMpError"]}}},ValidatingMasterPassword:{invoke:{src:"validateMasterPassword",onDone:{target:"OpeningSessionWithMasterpassword"},onError:{actions:["assignMaybeMpError"],target:"WaitingForMasterPassword"}},on:{CARBON_LEGACY_ERROR:{target:"WaitingForMasterPassword",actions:["assignError"]},CARBON_WRONG_PASSWORD:{actions:["assignMpError"],target:"WaitingForMasterPassword"}}},OpeningSessionWithMasterpassword:{invoke:{src:"authenticateWithMasterPassword",onError:{actions:["assignMaybeMpError"],target:"WaitingForMasterPassword"},onDone:{target:"CheckingMigrationNeeded"},CARBON_WRONG_PASSWORD:{actions:["assignMpError"],target:"WaitingForMasterPassword"}},on:{CARBON_LEGACY_ERROR:{target:"WaitingForMasterPassword",actions:["assignError"]},DEVICE_LIMIT_ABORTED:{target:"DeviceLimitAborted"}}},CheckingMigrationNeeded:{invoke:{src:"checkIsMigrationNeeded",onDone:{target:"MasterPasswordDone",actions:["assignSSOMigrationStatus"]},onError:{target:"WaitingForMasterPassword",actions:["assignGenericServiceError"]}},on:{CARBON_LEGACY_ERROR:{target:"WaitingForMasterPassword",actions:["assignError"]}}},DeviceLimitAborted:{type:"final",data:{shouldResetAuthenticationFlow:!0}},MasterPasswordDone:{type:"final",data:{shouldResetAuthenticationFlow:!1}}}},options:{actions:{assignMasterPassword:(0,G.f0)({masterPassword:(e,t)=>t.masterPassword,isRememberMeEnabled:(e,t)=>t.rememberMe}),assignAccountRecoveryStatus:(0,G.f0)({isAccountRecoveryAvailable:(e,t)=>t.data.isAccountRecoveryAvailable}),assignError:(0,G.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.error}})}),assignGenericServiceError:(0,G.f0)({error:()=>({code:"unknown_error",data:{message:"UNKNOWN_ERROR"}})}),assignMpError:(0,G.f0)({error:()=>({code:"unknown_error",data:{message:"WRONG_PASSWORD"}})}),assignMaybeMpError:(0,G.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.data instanceof K?"WRONG_PASSWORD":"UNKNOWN_ERROR"}})}),assignSSOMigrationStatus:(0,G.f0)({serviceProviderRedirectUrl:(e,t)=>t.data?.serviceProviderRedirectUrl,isNitroProvider:(e,t)=>t.data?.isNitroProvider})},services:{authenticateWithMasterPassword:e=>{const{login:t,masterPassword:s,isRememberMeEnabled:r,serverKey:i}=e;return this.masterPasswordService.executeWithParams({login:t??"",masterPassword:s??"",isRememberMeEnabled:r,serverKey:i})},checkAccountRecoveryStatus:()=>this.accountRecoveryStatusService.execute(),checkIsMigrationNeeded:e=>this.checkIsMigrationNeededService.executeWithParams({login:e.login??""}),validateMasterPassword:({login:e,masterPassword:t,serverKey:s})=>this.mpVerificationService.executeWithParams({login:e??"",masterPassword:t??"",serverKey:s})},guards:{hasPinCodeEnabled:e=>e.shouldAskPinCode}}}}create(){const{config:e,options:t}=this.desc();return(0,k.C)(e,t)}};Z=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[z,V,H,J])],Z);let X=class{constructor(e){this.carbonLegacy=e}async execute(e){try{return await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSessionResendToken",arg:[{login:e.login??""}]}),Promise.resolve()}catch(e){}}};X=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[n._])],X);let ee=class{constructor(e){this.carbonLegacy=e}async requestCodeAgainstServer(){}async execute({login:e}){return await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSessionWithDashlaneAuthenticator",arg:[{login:e,password:null,persistData:!0,deviceName:""}]}),Promise.resolve()}async cancel(){return await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"cancelDashlaneAuthenticatorRegistration",arg:[]}),Promise.resolve()}};ee=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[n._])],ee);let te=class{constructor(e,t){this.dashlaneAuthenticatorService=e,this.sendEmailToken=t}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"AuthenticatorMachine",context:{isDashlaneAuthenticatorAvailable:!1},initial:"RequestingServerPush",states:{RequestingServerPush:{entry:["updateDashlaneAuthenticatorAvailability"],invoke:{src:"authenticateWithDashlaneAuthenticator"},on:{CARBON_LEGACY_ERROR:{actions:["assignError","updateDashlaneAuthenticatorAvailability"]},RESEND_PUSH_NOTIFICATION:{target:"RequestingServerPush",actions:["clearError"]},SWITCH_TO_EMAIL_TOKEN:{actions:["cancelDashlaneAuthenticator","clearError"],target:"EmailTokenRequested"}}},AuthenticatorPushValidated:{type:"final",data:{switchToEmailToken:!1}},EmailTokenRequested:{entry:["sendEmailToken"],type:"final",data:{switchToEmailToken:!0}}}},options:{actions:{clearError:(0,G.f0)({error:()=>{}}),assignError:(0,G.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.error}})}),switchToEmailToken:(0,G.f0)({switchToEmailToken:()=>!0}),updateDashlaneAuthenticatorAvailability:(0,G.f0)({isDashlaneAuthenticatorAvailable:!0}),cancelDashlaneAuthenticator:()=>{this.dashlaneAuthenticatorService.cancel()},sendEmailToken:e=>{const{login:t}=e;this.sendEmailToken.execute({login:t})}},services:{authenticateWithDashlaneAuthenticator:e=>{const{login:t}=e;return this.dashlaneAuthenticatorService.execute({login:t})}},guards:{}}}}create(){const{config:e,options:t}=this.desc();return(0,k.C)(e,t)}};te=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[ee,X])],te);let se=class{constructor(e){this.carbonLegacy=e}async execute(e){try{await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSessionWithToken",arg:[{login:e.login??"",password:null,token:e.emailToken??"",persistData:!0,deviceName:e.deviceName}]})}catch(e){}}};se=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[n._])],se);let re=class{constructor(e,t){this.authenticateWithEmailToken=e,this.sendEmailToken=t}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"EmailTokenMachine",context:{login:"",emailToken:"",deviceName:""},initial:"WaitingForEmailToken",states:{SendEmailToken:{invoke:{src:"sendEmailToken",onError:{target:"WaitingForEmailToken"},onDone:{target:"WaitingForEmailToken"}}},WaitingForEmailToken:{on:{INPUT_EMAIL_TOKEN:{target:"ValidatingEmailToken",actions:["assignEmailToken"]},RESEND_EMAIL_TOKEN:{target:"SendEmailToken",actions:["clearError"]}}},ValidatingEmailToken:{entry:["authenticateWithEmailToken"],on:{CARBON_LEGACY_ERROR:{target:"WaitingForEmailToken",actions:["assignError"]}}},FinishingEmailToken:{type:"final",data:{switchToDashlaneAuthenticator:!1}},DashlaneAuthenticatorRequested:{type:"final",data:{switchToDashlaneAuthenticator:!0}}},on:{SWITCH_TO_DASHLANE_AUTHENTICATOR:{target:".DashlaneAuthenticatorRequested",internal:!0,actions:["clearError"]}}},options:{actions:{clearError:(0,G.f0)({error:()=>{}}),assignError:(0,G.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.error}})}),assignEmailToken:(0,G.f0)({emailToken:(e,t)=>t.emailToken}),authenticateWithEmailToken:e=>{const{deviceName:t,emailToken:s,login:r}=e;return this.authenticateWithEmailToken.execute({deviceName:t,emailToken:s,login:r})}},services:{sendEmailToken:e=>{const{login:t}=e;return this.sendEmailToken.execute({login:t})}},guards:{}}}}create(){const{config:e,options:t}=this.desc();return(0,k.C)(e,t)}};re=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[se,X])],re);const ie=e=>({initial:e.initial,states:e.states,on:e.on??{}});let ae=class{constructor(e,t){this.authenticatorMachine=e,this.emailTokenMachine=t}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{},guards:{}},id:"DeviceRegistrationMachine",context:{...this.authenticatorMachine.desc().config.context,...this.emailTokenMachine.desc().config.context,registrationMethod:void 0},initial:"StartDeviceRegistration",states:{StartDeviceRegistration:{always:[{target:"EmailToken",cond:"isRegistrationMethodEmailToken"},{target:"DashlaneAuthenticator",cond:"isRegistrationMethodAuthenticator"},{target:"TwoFactorAuthentication",cond:"isRegistrationMethodOTP"}]},DashlaneAuthenticator:{...ie(this.authenticatorMachine.desc().config),onDone:[{target:"EmailToken",cond:"shouldSwitchToEmailToken"},{target:"DeviceRegistrationDone"}]},EmailToken:{...ie(this.emailTokenMachine.desc().config),onDone:[{target:"DashlaneAuthenticator",cond:"shouldSwitchToAuthenticator"},{target:"DeviceRegistrationDone"}]},TwoFactorAuthentication:{onDone:{target:"DeviceRegistrationDone"}},DeviceRegistrationDone:{type:"final"}}},options:{actions:{...this.authenticatorMachine.desc().options.actions,...this.emailTokenMachine.desc().options.actions,assignUnknownDeviceRegistrationError:(0,G.f0)({error:()=>({code:"unknown_error",data:{message:"Unknown device registration error"}})})},services:{...this.authenticatorMachine.desc().options.services,...this.emailTokenMachine.desc().options.services},guards:{...this.authenticatorMachine.desc().options.guards,...this.emailTokenMachine.desc().options.guards,isRegistrationMethodEmailToken:e=>"email_token"===e.registrationMethod,isRegistrationMethodOTP:e=>"otp"===e.registrationMethod,isRegistrationMethodAuthenticator:e=>"dashlane_authenticator"===e.registrationMethod,shouldSwitchToEmailToken:(e,t)=>t.data.switchToEmailToken,shouldSwitchToAuthenticator:(e,t)=>t.data.switchToDashlaneAuthenticator}}}}create(){const{config:e,options:t}=this.desc();return(0,k.C)(e,t)}};ae=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[te,re])],ae);let oe=class{desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"WebAuthnMachine",context:{},initial:"InitWebAuthnAuthentication",states:{InitWebAuthnAuthentication:{on:{WEBAUTHN_AUTHENTICATION_FAIL:{target:"WebAuthnAuthenticationFailed",actions:["assignWebAuthnError"]}}},WebAuthnAuthenticationFailed:{on:{RETRY_WEBAUTHN_AUTHENTICATION:{target:"InitWebAuthnAuthentication",actions:["clearError"]}}},WebAuthnAuthenticationDone:{type:"final",data:{switchToMasterPassword:!1,switchToPinCode:!1}},MasterPasswordRequested:{type:"final",data:{switchToMasterPassword:!0,switchToPinCode:!1}},PinCodeRequested:{type:"final",data:{switchToMasterPassword:!1,switchToPinCode:!0}}},on:{USE_MASTER_PASSWORD:{actions:["clearError"],target:".MasterPasswordRequested",internal:!0},SWITCH_TO_PIN_CODE:{actions:["clearError"],target:".PinCodeRequested",internal:!0}}},options:{actions:{clearError:(0,G.f0)({error:()=>{}}),assignWebAuthnError:(0,G.f0)({error:(e,t)=>t.error})},services:{},guards:{}}}}create(){const{config:e,options:t}=this.desc();return(0,k.C)(e,t)}};oe=(0,r.__decorate)([(0,F.GS)()],oe);let ne=class{constructor(e){this.carbonLegacy=e}executeWithParams({login:e,masterPassword:t,otp:s,twoFactorAuthenticationOtpType:r,otpVerificationMode:i,deviceName:a}){const o={login:e,password:t??null,otp:s,withBackupCode:"backupCode"===r,persistData:!0};try{"otp2"===i?this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSessionWithOTP",arg:[{...o,deviceName:a}]}):"otp1"===i&&this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSessionWithOTPForNewDevice",arg:[o]})}catch(e){}return Promise.resolve()}};ne=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[n._])],ne);let ce=class{constructor(e){this.twoFactorAuthenticationService=e}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"WebAuthnMachine",context:{twoFactorAuthenticationOtpType:"totp"},initial:"WaitingForTotp",states:{WaitingForTotp:{on:{INPUT_TOTP:{target:"ValidatingTwoFactorAuthenticationOtp",actions:["assignTwoFactorAuthenticationOtpValue"]},SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE:{target:"WaitingForBackupCode",actions:["assignTwoFactorAuthenticationOtpType","clearError"]}}},WaitingForBackupCode:{on:{INPUT_BACKUP_CODE:{target:"ValidatingTwoFactorAuthenticationOtp",actions:["assignTwoFactorAuthenticationOtpValue"]},SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE:{target:"WaitingForTotp",actions:["assignTwoFactorAuthenticationOtpType","clearError"]}}},ValidatingTwoFactorAuthenticationOtp:{entry:["authenticateWithTwoFactorAuthentication"],on:{CARBON_LEGACY_ERROR:[{target:"WaitingForBackupCode",cond:"isBackupCode",actions:["assignError"]},{target:"WaitingForTotp",actions:["assignError"]}]}},TwoFactorAuthenticationDone:{type:"final"}}},options:{actions:{assignError:(0,G.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.error}})}),clearError:(0,G.f0)({error:()=>{}}),assignTwoFactorAuthenticationOtpValue:(0,G.f0)({twoFactorAuthenticationOtpValue:(e,t)=>t.twoFactorAuthenticationOtpValue}),assignTwoFactorAuthenticationOtpType:(0,G.f0)({twoFactorAuthenticationOtpType:(e,t)=>t.twoFactorAuthenticationOtpType}),authenticateWithTwoFactorAuthentication:e=>{const t={login:e.login??"",masterPassword:e.masterPassword??null,otp:e.twoFactorAuthenticationOtpValue,twoFactorAuthenticationOtpType:e.twoFactorAuthenticationOtpType,persistData:!0,otpVerificationMode:e.otpVerificationMode,deviceName:e.deviceName};this.twoFactorAuthenticationService.executeWithParams(t)}},services:{},guards:{isBackupCode:e=>"backupCode"===e.twoFactorAuthenticationOtpType}}}}create(){const{config:e,options:t}=this.desc();return(0,k.C)(e,t)}};ce=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[ne])],ce);var de=s(10430),le=s(43902),ue=s(16053);let pe=class{constructor(e){this.d2dAuthenticationService=e}async execute({login:e}){const t=le.getDefaultDeviceName();if(!e||!t)throw new de.z("No user login/device name",$.UY.GENERIC_ERROR);const s=await this.d2dAuthenticationService.requestTransfer(e,t);if((0,h.hx)(s))throw new de.z("Request transfer error",$.UY.GENERIC_ERROR);const{transferId:r,expireDateUnix:i}=s.data;return Promise.resolve({transferId:r,expireDateUnix:i})}};pe=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[ue.C])],pe);var he=s(15652);let me=class{constructor(e,t){this.d2dCryptoService=e,this.d2dAuthenticationService=t}async execute({transferId:e}){if(!e)throw new de.z("No transferId in context",$.UY.GENERIC_ERROR);const{privateKey:t,publicKey:s}=this.d2dCryptoService.generateKeyPair(),r=this.d2dCryptoService.hash(s),i=await this.d2dAuthenticationService.startReceiverKeyExchange(e,r);if((0,h.hx)(i))return Promise.reject(i.error);const{senderPublicKey:a}=i.data;return Promise.resolve({receiverPrivateKey:t,receiverPublicKey:s,senderPublicKey:a})}};me=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[he.q,ue.C])],me);let ge=class{constructor(e){this.d2dAuthenticationService=e}async execute(e){if(!e.transferId||!e.login)throw new de.z("No transferId or user login in the machine context",$.UY.GENERIC_ERROR);const t=await this.d2dAuthenticationService.startTransfer(e.transferId);return(0,h.hx)(t)?Promise.reject(t.error):Promise.resolve(t.data)}};ge=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[ue.C])],ge);let ve=class{constructor(e,t){this.d2dCryptoService=e,this.d2dAuthenticationService=t}async execute(e){if(!e.transferId||!e.login)throw new de.z("No transferId or user login in the machine context",$.UY.GENERIC_ERROR);if(!e.receiverPrivateKey||!e.receiverPublicKey||!e.senderPublicKey)throw new de.z("Missing keys/data in context",$.UY.GENERIC_ERROR);if(!e.sharedSecret)throw new de.z("Missing sharedSecret in context",$.UY.GENERIC_ERROR);if(!e.encryptedData||!e.nonce)throw new de.z("Missing transfer data in context",$.UY.GENERIC_ERROR);const t=this.d2dCryptoService.generateSymmetricKey(e.login,e.transferId,e.sharedSecret),s=this.d2dCryptoService.decryptInvisibleMasterPassword(e.encryptedData,e.nonce,t);await this.d2dAuthenticationService.openSession(s.login,s.token,s.key.value,e.deviceName)}};ve=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[he.q,ue.C])],ve);var ye=s(69605);let _e=class{constructor(e,t,s){this.d2dCryptoService=e,this.d2dAuthenticationService=t,this.passphraseService=s}async execute(e){if(!e.receiverPrivateKey||!e.receiverPublicKey||!e.senderPublicKey)throw new de.z("Keys not found in the state machine context",$.UY.GENERIC_ERROR);if(!e.transferId)throw new de.z("TransferId not found in the state machine context/store",$.UY.GENERIC_ERROR);if(!e.login)throw new de.z("User login not found in state machine context/store",$.UY.GENERIC_ERROR);const t=await this.d2dAuthenticationService.completeKeyExchange(e.transferId,e.receiverPublicKey);if((0,h.hx)(t))throw new de.z("Error with completeKeyExchange",$.UY.GENERIC_ERROR);const s=this.d2dCryptoService.generateReceiverSharedSecret(e.receiverPublicKey,e.receiverPrivateKey,e.senderPublicKey),r=this.d2dCryptoService.generateVisualCheckSeed(e.login,e.transferId,s),{passphrase:i}=await this.passphraseService.generatePassphraseChallenge(r);return Promise.resolve({sharedSecret:s,passphrase:i})}};_e=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[he.q,ue.C,ye.Kp])],_e);let Se=class{constructor(e,t,s,r,i){this.requestDeviceTransfer=e,this.startReceiverKeyExchange=t,this.completeKeyExchangeAndGeneratePassphrase=s,this.startTransfer=r,this.openSession=i}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"DeviceToDeviceAuthenticationFlow",initial:"WaitingForTransferRequest",context:{transferId:void 0},states:{WaitingForTransferRequest:{invoke:{src:"requestDeviceTransfer",onDone:{target:"DisplayInstructions",actions:["assignTransferId"]},onError:{actions:["assignDeviceToDeviceError"],target:"DeviceTransferError"}}},DisplayInstructions:{invoke:{src:"startReceiverKeyExchange",onDone:{actions:["assignKeys"],target:"GeneratePassphrase"},onError:{actions:["assignDeviceToDeviceError"],target:"DeviceTransferError"}}},GeneratePassphrase:{invoke:{src:"completeKeyExchangeAndGeneratePassphrase",onDone:{actions:["assignPassphrase"],target:"StartTransfer"},onError:{actions:["assignDeviceToDeviceError"],target:"DeviceTransferError"}}},StartTransfer:{invoke:{src:"startTransfer",onDone:{actions:["assignTransferData"],target:"OpenSession"},onError:{actions:["assignDeviceToDeviceError"],target:"DeviceTransferError"}}},OpenSession:{invoke:{src:"openSession",onDone:{target:"DeviceRegistered"},onError:{actions:["assignDeviceToDeviceError"],target:"DeviceTransferError"}}},DeviceTransferError:{},DeviceRegistered:{type:"final"}}},options:{actions:{assignTransferId:(0,G.f0)({transferId:(e,t)=>t.data.transferId}),assignKeys:(0,G.f0)({receiverPublicKey:(e,t)=>t.data.receiverPublicKey,receiverPrivateKey:(e,t)=>t.data.receiverPrivateKey,senderPublicKey:(e,t)=>t.data.senderPublicKey}),assignPassphrase:(0,G.f0)({passphrase:(e,t)=>t.data.passphrase,sharedSecret:(e,t)=>t.data.sharedSecret}),assignTransferData:(0,G.f0)({encryptedData:(e,t)=>t.data.encryptedData,nonce:(e,t)=>t.data.nonce}),clearContext:(0,G.f0)({deviceName:()=>{},transferId:()=>{},receiverPublicKey:()=>{},receiverPrivateKey:()=>{},senderPublicKey:()=>{},sharedSecret:()=>{},passphrase:()=>{}}),assignDeviceToDeviceError:(0,G.f0)({error:(e,t)=>t.data instanceof de.z?t.data.code:$.UY.GENERIC_ERROR})},services:{requestDeviceTransfer:e=>this.requestDeviceTransfer.execute(e),startReceiverKeyExchange:e=>this.startReceiverKeyExchange.execute(e),completeKeyExchangeAndGeneratePassphrase:e=>this.completeKeyExchangeAndGeneratePassphrase.execute(e),startTransfer:e=>this.startTransfer.execute(e),openSession:e=>this.openSession.execute(e)}}}}create(){const{config:e,options:t}=this.desc();return(0,k.C)(e,t)}};Se=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[pe,me,_e,ge,ve])],Se);var fe=s(42303);class we extends M.x{constructor(){super("Entered PIN code is wrong")}}let Ie=class{constructor(e){this.pinCodeClient=e}async executeWithParams({loginEmail:e,pinCode:t}){if(!e)throw new Error("No login email");const s=await this.pinCodeClient.commands.loginWithPinCode({email:e,pinCode:t});return(0,h.hx)(s)?Promise.reject((0,W.EQ)(s.error,{NO_ACTIVE_PIN_CODE:()=>new Error("No active pin code"),WRONG_PIN_CODE:()=>new we})):Promise.resolve()}};Ie=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[fe.u])],Ie);let be=class{constructor(e){this.pinCodeVerificationService=e}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"PinCodeMachine",context:{pinCode:""},initial:"WaitingForPinCode",states:{WaitingForPinCode:{on:{INPUT_PIN_CODE:{target:"ValidatingPinCode",actions:["assignPinCode"]},USE_MASTER_PASSWORD:{target:"#AuthenticationFlowMachine.MasterPassword"},USE_DEVICE_TO_DEVICE_AUTHENTICATION:{target:"#AuthenticationFlowMachine.DeviceToDeviceAuthentication"}}},ValidatingPinCode:{invoke:{src:"validatePinCode",onDone:{target:"PinCodeDone"},onError:{actions:["assignPinCodeError"],target:"WaitingForPinCode"}}},PinCodeDone:{type:"final"}}},options:{actions:{assignPinCode:(0,G.f0)({pinCode:(e,t)=>t.pinCode}),assignPinCodeError:(0,G.f0)({error:(e,t)=>({code:t.data instanceof we?"wrong_pin_code":"unknown_error"})}),clearError:(0,G.f0)({error:()=>{}}),clearContext:(0,G.f0)({pinCode:()=>"",error:()=>{}})},services:{validatePinCode:e=>this.pinCodeVerificationService.executeWithParams({loginEmail:e.login,pinCode:e.pinCode})},guards:{}}}}create(){const{config:e,options:t}=this.desc();return(0,k.C)(e,t)}};be=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[Ie])],be);var Ee=s(41842);let Ce=class{constructor(e,t){this.carbonLegacyClient=e,this.pinCodeClient=t}retrieveLocalAccounts(){return(0,i.z)(this.carbonLegacyClient.queries.carbonState({path:"authentication.localAccounts"}).pipe((0,Ee.h)(h.d6),(0,Ee.h)((e=>e.data.accountsListInitialized)),(0,S.U)((e=>e.data.accountsList))))}async getPinCodeStatus(e){if(!e)return!1;const t=await(0,i.z)(this.pinCodeClient.queries.getStatus({loginEmail:e}));return!(0,h.hx)(t)&&t.data.isPinCodeEnabled}async execute(){const e=await this.retrieveLocalAccounts(),t=e?.find((e=>e.isLastSuccessfulLogin)),s=await this.getPinCodeStatus(t?.login);return{localAccounts:e??[],lastUsedLogin:t?.login??"",shouldAskMasterPassword:t?.shouldAskMasterPassword??!1,shouldAskPinCode:s,shouldAskOTP:t?.hasLoginOtp??!1,rememberMeType:t?.rememberMeType??"disabled"}}};Ce=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[n._,fe.u])],Ce);let Ae=class{constructor(e){this.carbonLegacy=e}async execute(e){await this.carbonLegacy.commands.carbon({name:"loginViaSSO",args:[e]})}};Ae=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[n._])],Ae);let Re=class{constructor(e){this.ssoProviderInfoStore=e,this.ssoProviderInfoStore=e}async execute({isNitroProvider:e,serviceProviderRedirectUrl:t}){await this.ssoProviderInfoStore.set({isNitroProvider:e,serviceProviderUrl:t})}};Re=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[R])],Re);let Te=class{constructor(e){this.carbonLegacy=e}async execute({login:e}){await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"openSession",arg:[{login:e??""}]})}};Te=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[n._])],Te);let Oe=class{constructor(e){this.pinCodeClient=e}async execute({login:e}){if(e){const t=await(0,i.z)(this.pinCodeClient.queries.getStatus({loginEmail:e}));if((0,h.d6)(t)&&t.data.isPinCodeEnabled)return Promise.resolve(!0)}return Promise.resolve(!1)}};Oe=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[fe.u])],Oe);let De=class{constructor(e,t,s,r,i,a,o,n,c,d,l){this.deviceRegistrationMachine=e,this.masterPasswordFlowMachine=t,this.twoFactorAuthenticationMachine=s,this.webAuthnMachine=r,this.deviceToDeviceAuthenticationMachine=i,this.pinCodeMachine=a,this.initializeMachineService=o,this.legacySSOLoginService=n,this.checkAccountType=c,this.storeSSOInfoService=d,this.checkPinCodeStatusService=l}desc(e=!1){const t={config:{predictableActionArguments:!0,schema:{events:{},context:{}},initial:"Starting",id:"AuthenticationFlowMachine",context:{...this.deviceRegistrationMachine.desc().config.context,...this.masterPasswordFlowMachine.desc().config.context,...this.twoFactorAuthenticationMachine.desc().config.context,...this.webAuthnMachine.desc().config.context,...this.deviceToDeviceAuthenticationMachine.desc().config.context,...this.pinCodeMachine.desc().config.context,ready:!1,shouldAskMasterPassword:!1,shouldAskOTP:!1,shouldAskPinCode:!1},states:{Starting:{invoke:{src:"initializeMachine",onDone:{actions:["assignInitializationResults"],target:"RememberMeRedirection"}}},RememberMeRedirection:{always:[{target:"MasterPassword",cond:"shouldAskMasterPassword"},{target:"CheckSessionForOtp2",cond:"shouldAskOTP"},{target:"WebAuthn",cond:"rememberMeIsWebAuthn"},{target:"WaitingForEmail"}]},CheckSessionForOtp2:{entry:["checkAccountType"]},WaitingForEmail:{on:{INPUT_ACCOUNT_EMAIL:{target:"ValidatingEmail",actions:["assignAccountEmail","clearError"]}}},ValidatingEmail:{entry:["checkAccountType"],on:{CARBON_LEGACY_ERROR:{target:"WaitingForEmail",actions:["assignError"]}}},PinCode:{...ie(this.pinCodeMachine.desc().config)},DeviceRegistration:{...ie(this.deviceRegistrationMachine.desc().config)},WebAuthn:{...ie(this.webAuthnMachine.desc().config),onDone:[{target:"MasterPassword",cond:"shouldSwitchToMasterPassword"},{target:"PinCode",cond:"shouldSwitchToPinCode"},{target:"MasterPasswordBasedAuthenticationDone"}]},TwoFactorAuthentication:{...ie(this.twoFactorAuthenticationMachine.desc().config),onDone:{target:"MasterPasswordBasedAuthenticationDone"}},SSOAuthentication:{entry:["legacySSOLogin"]},SSORedirectionToIdp:{entry:["assignServiceProviderInfo","storeSSOInfo"],on:{CARBON_LEGACY_ERROR:{target:"WaitingForEmail",actions:["assignError"]}}},CheckPinCodeAvailableForMasterPassword:{invoke:{src:"checkPinCodeStatus",onDone:[{actions:["assignShouldAskPinCode"],cond:"isPinCodeLogin",target:"PinCode"},{actions:["assignShouldAskPinCode"],target:"MasterPassword"}]}},MasterPassword:{...ie(this.masterPasswordFlowMachine.desc().config),onDone:[{target:"WaitingForEmail",cond:"shouldResetAuthenticationFlow"},{target:"MasterPasswordBasedAuthenticationDone"}]},MasterPasswordBasedAuthenticationDone:{on:{CARBON_LEGACY_LOGGED_OUT:{target:"Starting"}}},CheckPinCodeAvailableForPasswordless:{invoke:{src:"checkPinCodeStatus",onDone:[{actions:["assignShouldAskPinCode"],cond:"isPinCodeLogin",target:"PinCode"},{actions:["assignShouldAskPinCode"],target:"DeviceToDeviceAuthentication"}]}},DeviceToDeviceAuthentication:{...ie(this.deviceToDeviceAuthenticationMachine.desc().config),onDone:{target:"DeviceToDeviceAuthenticationDone"}},DeviceToDeviceAuthenticationDone:{type:"final"}},on:{CHANGE_ACCOUNT_EMAIL:[{target:"ValidatingEmail",actions:["clearError","assignAccountEmail"],cond:"isAccountLoginAvailable"},{target:"WaitingForEmail",actions:["clearError","clearEmail"]}],CARBON_LEGACY_ASK_MASTER_PASSWORD:{target:"CheckPinCodeAvailableForMasterPassword",actions:["assignServerKey","clearError"]},CARBON_LEGACY_OPEN_SESSION_TOKEN_SENT:[{target:"DeviceRegistration.EmailToken",actions:["assignAccountEmail","clearError"],cond:"isGrapheneDeviceRegistrationFlow"},{target:"DeviceRegistration.EmailToken",actions:["assignAccountEmail","clearError"]}],CARBON_LEGACY_OPEN_SESSION_DASHLANE_AUTHENTICATOR:{target:"DeviceRegistration.DashlaneAuthenticator",actions:["clearError"]},CARBON_LEGACY_OPEN_SESSION_SSO_REDIRECTION_TO_IDP_REQUIRED:{target:"SSORedirectionToIdp",actions:["clearError"]},CARBON_LEGACY_SSO_LOGIN_BYPASS:{target:"SSOAuthentication",actions:["assignSsoData"]},CARBON_LEGACY_OPEN_SESSION_OTP_SENT:{target:"TwoFactorAuthentication",actions:["assignOtpVerificationMode","clearError"]},CARBON_LEGACY_OPEN_SESSION_DEVICE_TO_DEVICE:{target:"CheckPinCodeAvailableForPasswordless",actions:["assignServerKey","clearError"]},CLEAR_ERROR:{actions:["clearError"]}}},options:{actions:{...this.deviceRegistrationMachine.desc().options.actions,...this.masterPasswordFlowMachine.desc().options.actions,...this.twoFactorAuthenticationMachine.desc().options.actions,...this.webAuthnMachine.desc().options.actions,...this.deviceToDeviceAuthenticationMachine.desc().options.actions,...this.pinCodeMachine.desc().options.actions,assignInitializationResults:(0,G.f0)({login:(e,t)=>t.data.lastUsedLogin,localAccounts:(e,t)=>t.data.localAccounts,shouldAskMasterPassword:(e,t)=>t.data.shouldAskMasterPassword,shouldAskOTP:(e,t)=>t.data.shouldAskOTP,shouldAskPinCode:(e,t)=>t.data.shouldAskPinCode,rememberMeType:(e,t)=>t.data.rememberMeType,ready:()=>!0}),assignAccountEmail:(0,G.f0)({login:(e,t)=>t.login}),assignError:(0,G.f0)({error:(e,t)=>({code:"unknown_error",data:{message:t.error}})}),assignOtpVerificationMode:(0,G.f0)({otpVerificationMode:(e,t)=>t.otpVerificationMode}),assignSsoData:(0,G.f0)({ssoData:(e,t)=>t}),assignServiceProviderInfo:(0,G.f0)({serviceProviderRedirectUrl:(e,t)=>t.serviceProviderRedirectUrl,isNitroProvider:(e,t)=>t.isNitroProvider,rememberMeForSSOPreference:(e,t)=>t.rememberMeForSSOPreference}),assignServerKey:(0,G.f0)({serverKey:(e,t)=>t.serverKey}),assignShouldAskPinCode:(0,G.f0)({shouldAskPinCode:(e,t)=>t.data}),clearEmail:(0,G.f0)({login:void 0}),clearError:(0,G.f0)({error:()=>{}}),clearContext:(0,G.f0)({login:()=>"",shouldAskOTP:()=>!1,shouldAskMasterPassword:()=>!1,twoFactorAuthenticationOtpType:()=>"totp",registrationMethod:()=>{},emailToken:()=>"",deviceName:()=>"",isDashlaneAuthenticatorAvailable:()=>!1,isRememberMeEnabled:()=>!1,isAccountRecoveryAvailable:()=>!1}),legacySSOLogin:(e,t)=>this.legacySSOLoginService.execute(t),checkAccountType:e=>this.checkAccountType.execute(e),storeSSOInfo:(e,t)=>this.storeSSOInfoService.execute(t)},services:{...this.deviceRegistrationMachine.desc().options.services,...this.masterPasswordFlowMachine.desc().options.services,...this.twoFactorAuthenticationMachine.desc().options.services,...this.webAuthnMachine.desc().options.services,...this.deviceToDeviceAuthenticationMachine.desc().options.services,...this.pinCodeMachine.desc().options.services,initializeMachine:()=>this.initializeMachineService.execute(),checkAccountType:e=>this.checkAccountType.execute(e),checkPinCodeStatus:e=>this.checkPinCodeStatusService.execute(e)},guards:{...this.deviceRegistrationMachine.desc().options.guards,...this.twoFactorAuthenticationMachine.desc().options.guards,...this.webAuthnMachine.desc().options.guards,...this.masterPasswordFlowMachine.desc().options.guards,isAccountLoginAvailable:(e,t)=>Boolean(t.login),shouldAskMasterPassword:e=>e.shouldAskMasterPassword&&!e.shouldAskPinCode,shouldAskOTP:e=>!!e.shouldAskOTP&&e.shouldAskOTP,shouldAskPinCode:e=>e.shouldAskPinCode,shouldSwitchToMasterPassword:(e,t)=>t.data.switchToMasterPassword,shouldSwitchToPinCode:(e,t)=>t.data.switchToPinCode,shouldResetAuthenticationFlow:(e,t)=>t.data.shouldResetAuthenticationFlow,rememberMeIsWebAuthn:e=>void 0!==e.rememberMeType&&"webauthn"===e.rememberMeType,isGrapheneDeviceRegistrationFlow:e=>!!e.login&&e.login.includes("kw_test_newdevice"),isPinCodeLogin:(e,t)=>t.data}}};return e&&(0,L.G)(t.config),t}create(e=!1){const{config:t,options:s}=this.desc(e);return(0,k.C)(t,s)}};De=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[ae,Z,ce,oe,Se,be,Ce,Ae,Te,Re,Oe])],De);let Ue=class{constructor(e,t,s,r,i){this.carbon=r,this.allowedToFail=i,this.loginMachineStore=t;const a=e.create(s);this.interpreter=D.kJ(a).onTransition((0,P.V)((e=>this.allowedToFail.doOne((()=>{throw e}))))).onEvent((0,x.V)((e=>this.allowedToFail.doOne((()=>{throw e}))))).onTransition((async()=>{const e=this.interpreter.getSnapshot();await(async(e,t)=>{await e.set(JSON.stringify(t))})(this.loginMachineStore,e)})),this.abortDeviceLimitEventHandler=new N(this.interpreter,this.carbon)}async prepare(){await this.abortDeviceLimitEventHandler.execute();const e=await(async e=>{const t=await e.getState();return t?v.ZM.create(JSON.parse(t)):void 0})(this.loginMachineStore);if(!e){const e=this.interpreter.start();return void await(0,U.x)(e,(e=>e.context.ready),{timeout:3e4})}let t;await this.allowedToFail.doOne((()=>{if(e.done)throw new Error("Restarting a machine which is already in its final state. Starting from scratch instead.");t=this.interpreter.start(e)}),{methodName:"Resuming state machine"}),t||(t=this.interpreter.start()),await(0,U.x)(t,(e=>e.context.ready))}continue(e){this.interpreter.send(e)}};Ue=(0,r.__decorate)([(0,F.GS)(),(0,r.__metadata)("design:paramtypes",[De,w,Boolean,n._,l.J])],Ue);let Fe=class{constructor(e){this.authenticationFlow=e}execute(e){const{login:t}=e.body;return this.authenticationFlow.continue({type:"CHANGE_ACCOUNT_EMAIL",login:t}),Promise.resolve((0,h.Vp)(void 0))}};Fe=(0,r.__decorate)([(0,T.W)(O.hW),(0,r.__metadata)("design:paramtypes",[Ue])],Fe);let Pe=class{constructor(e){this.authenticationFlow=e}execute(e){const{twoFactorAuthenticationOtpType:t}=e.body;return this.authenticationFlow.continue({type:"SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE",twoFactorAuthenticationOtpType:t}),Promise.resolve((0,h.Vp)(void 0))}};Pe=(0,r.__decorate)([(0,T.W)(O.eG),(0,r.__metadata)("design:paramtypes",[Ue])],Pe);let xe=class{constructor(e){this.authenticationFlow=e}execute(){return this.authenticationFlow.continue({type:"CLEAR_ERROR"}),Promise.resolve((0,h.Vp)(void 0))}};xe=(0,r.__decorate)([(0,T.W)(O.jq),(0,r.__metadata)("design:paramtypes",[Ue])],xe);let Ne=class{constructor(e){this.authenticationFlow=e}execute(){return this.authenticationFlow.continue({type:"CANCEL_DEVICE_TRANSFER_REQUEST"}),Promise.resolve((0,h.Vp)(void 0))}};Ne=(0,r.__decorate)([(0,T.W)(O.Yc),(0,r.__metadata)("design:paramtypes",[Ue])],Ne);let Ge=class{constructor(e){this.authenticationFlow=e}execute(){return this.authenticationFlow.continue({type:"RESEND_EMAIL_TOKEN"}),Promise.resolve((0,h.Vp)(void 0))}};Ge=(0,r.__decorate)([(0,T.W)(O.Gc),(0,r.__metadata)("design:paramtypes",[Ue])],Ge);let ke=class{constructor(e){this.authenticationFlow=e}execute(){return this.authenticationFlow.continue({type:"RESEND_PUSH_NOTIFICATION"}),Promise.resolve((0,h.Vp)(void 0))}};ke=(0,r.__decorate)([(0,T.W)(O.rF),(0,r.__metadata)("design:paramtypes",[Ue])],ke);let Le=class{constructor(e){this.authenticationFlow=e}execute(e){const{login:t}=e.body;return this.authenticationFlow.continue({type:"INPUT_ACCOUNT_EMAIL",login:t}),Promise.resolve((0,h.Vp)(void 0))}};Le=(0,r.__decorate)([(0,T.W)(O.A),(0,r.__metadata)("design:paramtypes",[Ue])],Le);let Me=class{constructor(e){this.authenticationFlow=e}execute(e){const{masterPassword:t,rememberMe:s}=e.body;return this.authenticationFlow.continue({type:"INPUT_MASTER_PASSWORD",masterPassword:t,rememberMe:s}),Promise.resolve((0,h.Vp)(void 0))}};Me=(0,r.__decorate)([(0,T.W)(O.rT),(0,r.__metadata)("design:paramtypes",[Ue])],Me);let Ke=class{constructor(e){this.authenticationFlow=e}execute(e){const{twoFactorAuthenticationOtpValue:t}=e.body;return this.authenticationFlow.continue({type:"INPUT_BACKUP_CODE",twoFactorAuthenticationOtpValue:t}),Promise.resolve((0,h.Vp)(void 0))}};Ke=(0,r.__decorate)([(0,T.W)(O.sH),(0,r.__metadata)("design:paramtypes",[Ue])],Ke);let je=class{constructor(e){this.authenticationFlow=e}execute(e){const{emailToken:t,deviceName:s}=e.body;return this.authenticationFlow.continue({type:"INPUT_EMAIL_TOKEN",emailToken:t,deviceName:s}),Promise.resolve((0,h.Vp)(void 0))}};je=(0,r.__decorate)([(0,T.W)(O.XH),(0,r.__metadata)("design:paramtypes",[Ue])],je);let Ve=class{constructor(e){this.authenticationFlow=e}execute(e){const{twoFactorAuthenticationOtpValue:t}=e.body;return this.authenticationFlow.continue({type:"INPUT_TOTP",twoFactorAuthenticationOtpValue:t}),Promise.resolve((0,h.Vp)(void 0))}};Ve=(0,r.__decorate)([(0,T.W)(O.ad),(0,r.__metadata)("design:paramtypes",[Ue])],Ve);let ze=class{constructor(e){this.authenticationFlow=e}execute(){return this.authenticationFlow.continue({type:"SWITCH_TO_DASHLANE_AUTHENTICATOR"}),Promise.resolve((0,h.Vp)(void 0))}};ze=(0,r.__decorate)([(0,T.W)(O.K1),(0,r.__metadata)("design:paramtypes",[Ue])],ze);let We=class{constructor(e){this.authenticationFlow=e}execute(){return this.authenticationFlow.continue({type:"SWITCH_TO_EMAIL_TOKEN"}),Promise.resolve((0,h.Vp)(void 0))}};We=(0,r.__decorate)([(0,T.W)(O.v5),(0,r.__metadata)("design:paramtypes",[Ue])],We);let qe=class{constructor(e){this.authenticationFlow=e}execute(){return this.authenticationFlow.continue({type:"USE_DEVICE_TO_DEVICE_AUTHENTICATION"}),Promise.resolve((0,h.Vp)(void 0))}};qe=(0,r.__decorate)([(0,T.W)(O.sU),(0,r.__metadata)("design:paramtypes",[Ue])],qe);let Be=class{constructor(e){this.authenticationFlow=e}execute(){return this.authenticationFlow.continue({type:"RETRY_WEBAUTHN_AUTHENTICATION"}),Promise.resolve((0,h.Vp)(void 0))}};Be=(0,r.__decorate)([(0,T.W)(O.M6),(0,r.__metadata)("design:paramtypes",[Ue])],Be);let $e=class{constructor(e){this.authenticationFlow=e}execute(e){const{webAuthnError:t}=e.body;return this.authenticationFlow.continue({type:"WEBAUTHN_AUTHENTICATION_FAIL",error:t}),Promise.resolve((0,h.Vp)(void 0))}};$e=(0,r.__decorate)([(0,T.W)(O.O3),(0,r.__metadata)("design:paramtypes",[Ue])],$e);var Ye=s(90318);let Qe=class{constructor(e,t){this.carbonLegacy=e,this.logger=t}async execute(){try{await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"closeSession",arg:[{}]})}catch(e){this.logger.trace("Logout Command error :"+e)}return Promise.resolve((0,h.Vp)(void 0))}};Qe=(0,r.__decorate)([(0,T.W)(O.N5),(0,r.__metadata)("design:paramtypes",[n._,Ye.V])],Qe);let He=class{constructor(e,t){this.carbonLegacy=e,this.logger=t}async execute(){try{await this.carbonLegacy.commands.carbonLegacyLeeloo({name:"lockSession",arg:[{}]})}catch(e){this.logger.trace("LockSession command handler: "+e)}return Promise.resolve((0,h.Vp)(void 0))}};He=(0,r.__decorate)([(0,T.W)(O.Y$),(0,r.__metadata)("design:paramtypes",[n._,Ye.V])],He);let Je=class{constructor(e){this.authenticationFlow=e}execute(e){return this.authenticationFlow.continue({type:"CARBON_LEGACY_SSO_LOGIN_BYPASS",...e.body}),Promise.resolve((0,h.Vp)(void 0))}};Je=(0,r.__decorate)([(0,T.W)(O.yv),(0,r.__metadata)("design:paramtypes",[Ue])],Je);var Ze=s(28489),Xe=s(53932),et=s(43991);class tt{}let st=class{constructor(e,t,s,r){this.carbonLegacyClient=e,this.ssoUserSettingsStore=s,this.client=t,this.authenticationFlowInfraContext=r}async retrieveSSOInfo(){const e=await(0,i.z)(this.carbonLegacyClient.queries.carbonState({path:"userSession.ssoSettings"}).pipe((0,S.U)((e=>{if(!((0,h.d6)(e)&&(t=e.data,t&&"object"==typeof t&&(0,Ze.l$)(t,"ssoUser")&&(0,Ze.l$)(t,"serviceProviderUrl"))))throw new Error("SsoSettings is not of the expected type");var t;return e.data}))));return{isNitroProvider:e.isNitroProvider??!1,serviceProviderUrl:e.serviceProviderUrl}}async execute(e){const{loginUserWithEnclaveSSO:t}=this.client.getClient(et.y).commands,s=await this.retrieveSSOInfo(),{login:r,rememberMeForSSOPreference:i}=e.body;return await this.ssoUserSettingsStore.set({rememberMeForSSOPreference:i}),s.isNitroProvider?await t({userEmailAddress:r}):this.authenticationFlowInfraContext.redirectUserToExternalUrl({externalUrl:s.serviceProviderUrl,tabFocus:!0}),Promise.resolve((0,h.Vp)(void 0))}};st=(0,r.__decorate)([(0,T.W)(O.Hr),(0,r.__metadata)("design:paramtypes",[n._,Xe.w,C,tt])],st);var rt=s(74081);const it=e=>!!e&&"object"==typeof e&&(0,Ze.l$)(e,"type")&&"sso"===e.type;let at=class{constructor(e,t,s,r,i){this.allowToFail=i,this.client=t,this.carbonLegacyClient=e,this.authenticationFlowInfraContext=s,this.serverApiClient=r}getDeviceAccessKeys(e){return this.carbonLegacyClient.queries.carbonState({path:"authentication.localUsers"}).pipe((0,Ee.h)(h.d6),(0,S.U)((t=>t.data[e])))}async checkSSOInfo(e){const t=(await(0,i.z)(this.getDeviceAccessKeys(e).pipe((0,S.U)((t=>this.serverApiClient.v1.authentication.getAuthenticationMethodsForLogin({login:e,deviceAccessKey:t.deviceAccessKey,methods:["email_token","totp","duo_push","dashlane_authenticator"]}))),(0,rt.J)(),(0,Ee.h)(h.d6),(0,S.U)((e=>e.data.data))))).verifications.find(it);if(t){const e=t.ssoInfo;return{isNitroProvider:e.isNitroProvider,serviceProviderUrl:e.serviceProviderUrl}}throw new Error("No SSO authentication available for the user")}async execute(e){const{login:t}=e.body,{loginUserWithEnclaveSSO:s}=this.client.getClient(et.y).commands;return await this.allowToFail.doOne((async()=>{const e=await this.checkSSOInfo(t);e.isNitroProvider?await s({userEmailAddress:t,tabFocus:!1}):this.authenticationFlowInfraContext.redirectUserToExternalUrl({externalUrl:e.serviceProviderUrl,tabFocus:!1})}),{methodName:"InitiateAutologinWithSSOCommandHandler.execute"}),Promise.resolve((0,h.Vp)(void 0))}};at=(0,r.__decorate)([(0,T.W)(O.x2),(0,r.__metadata)("design:paramtypes",[n._,Xe.w,tt,B.l,l.J])],at);var ot=s(85798),nt=s(40923);let ct=class{constructor(e,t,s,r){this.authenticationFlow=e,this.ssoUserSettingsStore=t,this.carbon=s,this.ssoInfos=r}getLoginFlowMigrationKillswitch(){return(0,i.z)(this.carbon.queries.carbonState({path:"device.killswitch.disableLoginFlowMigration"}).pipe((0,Ee.h)(h.d6),(0,S.U)((e=>e))))}async handle(e){const t=await this.getLoginFlowMigrationKillswitch();let s=!1;if("undefined"!=typeof self&&self.localStorage){const e=self.localStorage.getItem("extng.loginFlow.forceLegacyFallback");s=Boolean(e)&&"true"===e}if("success"===t.tag&&t.data||s)return console.warn("[Authentication-flow] Ignoring carbon event due to legacy login fallback",{isKillSwitchEnabled:t,isForceLoginFlowFallbackOptionEnabled:s}),Promise.resolve();switch(e.body.eventName){case"openSessionMasterPasswordLess":this.authenticationFlow.continue({type:"CARBON_LEGACY_OPEN_SESSION_DEVICE_TO_DEVICE"});break;case"openSessionTokenSent":if(!e.body.eventData||"object"!=typeof e.body.eventData||!("login"in e.body.eventData)||"string"!=typeof e.body.eventData.login)throw new Error("login not in eventData");this.authenticationFlow.continue({type:"CARBON_LEGACY_OPEN_SESSION_TOKEN_SENT",login:e.body.eventData.login});break;case"openSessionAskMasterPassword":{const e=await(0,i.z)(this.carbon.queries.getMasterPasswordAndServerKey());if((0,h.hx)(e))throw new Error("Failed to get  server key from carbon");const{serverKey:t}=e.data;this.authenticationFlow.continue({type:"CARBON_LEGACY_ASK_MASTER_PASSWORD",serverKey:t})}break;case"openSessionDashlaneAuthenticator":this.authenticationFlow.continue({type:"CARBON_LEGACY_OPEN_SESSION_DASHLANE_AUTHENTICATOR"});break;case"openSessionOTPSent":case"openSessionOTPForNewDeviceRequired":this.authenticationFlow.continue({type:"CARBON_LEGACY_OPEN_SESSION_OTP_SENT",otpVerificationMode:"openSessionOTPSent"===e.body.eventName?"otp2":"otp1"});break;case"openSessionSsoRedirectionToIdpRequired":{const t=e.body.eventData,{rememberMeForSSOPreference:s}=await this.ssoUserSettingsStore.getState();this.authenticationFlow.continue({type:"CARBON_LEGACY_OPEN_SESSION_SSO_REDIRECTION_TO_IDP_REQUIRED",serviceProviderRedirectUrl:t.serviceProviderRedirectUrl,isNitroProvider:t.isNitroProvider,rememberMeForSSOPreference:s})}break;case"openSessionFailed":{const t=e.body.eventData;return"WRONG_PASSWORD"===t.errorCode?this.authenticationFlow.continue({type:"CARBON_WRONG_PASSWORD"}):this.authenticationFlow.continue({type:"CARBON_LEGACY_ERROR",error:t.errorCode})}case"carbonLoginStatusChanged":{e.body.eventData.loggedIn||this.authenticationFlow.continue({type:"CARBON_LEGACY_LOGGED_OUT"});const t=await(0,i.z)(this.carbon.queries.getSSOMigrationInfo().pipe((0,Ee.h)(h.d6),(0,S.U)((e=>e.data))));await this.ssoInfos.update((e=>({...e,migrationType:t.migration})))}}return Promise.resolve()}};ct=(0,r.__decorate)([(0,ot.b)(nt.Dj),(0,r.__metadata)("design:paramtypes",[Ue,C,n._,R])],ct);var dt=s(6136),lt=s(46449),ut=s(33672),pt=s(69885),ht=s(6220);const mt=e=>({step:"EmailStep",loginEmail:e.context.login,localAccounts:e.context.localAccounts??[],isLoading:e.matches("ValidatingEmail")&&!e.context.error,error:e.context.error?.data?.message}),gt=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:$.E6.WaitingForTransferRequest,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error}),vt=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:$.E6.DisplayInstructions,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error}),yt=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:$.E6.LoadingPassphrase,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error}),_t=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:$.E6.DisplayPassphrase,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,passphrase:e.context.passphrase?.split(ye.iy)||[],error:e.context.error}),St=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:$.E6.LoadingAccount,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error}),ft=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:$.E6.Error,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error??$.UY.GENERIC_ERROR}),wt=e=>({step:"DeviceToDeviceAuthenticationStep",deviceToDeviceStep:$.E6.DeviceRegistered,localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,error:e.context.error}),It=e=>({step:"EmailTokenStep",localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,isLoading:e.matches({DeviceRegistration:{EmailToken:"ValidatingEmailToken"}})&&!e.context.error,error:e.context.error?.data?.message,emailToken:e.context.emailToken,isDashlaneAuthenticatorAvailable:e.context.isDashlaneAuthenticatorAvailable}),bt=e=>({step:"DashlaneAuthenticatorStep",localAccounts:e.context.localAccounts??[],isLoading:e.matches({DeviceRegistration:{DashlaneAuthenticator:"RequestingServerPush"}})&&!e.context.error,error:e.context.error?.data?.message}),Et=e=>({step:"TwoFactorAuthenticationOtpStep",localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,isLoading:e.matches({TwoFactorAuthentication:"ValidatingTwoFactorAuthenticationOtp"})&&!e.context.error,error:e.context.error?.data?.message,twoFactorAuthenticationOtpValue:e.context.twoFactorAuthenticationOtpValue,twoFactorAuthenticationOtpType:e.context.twoFactorAuthenticationOtpType}),Ct=e=>({step:"WebAuthnStep",localAccounts:e.context.localAccounts??[],loginEmail:e.context.login??"",isLoading:e.matches({WebAuthn:"InitWebAuthnAuthentication"})&&!e.context.error,error:e.context.error?.data?.message}),At=e=>({step:"SSORedirectionToIdpStep",loginEmail:e.context.login,serviceProviderRedirectUrl:e.context.serviceProviderRedirectUrl??"",isNitroProvider:e.context.isNitroProvider??!1,rememberMeForSSOPreference:e.context.rememberMeForSSOPreference,isLoading:e.matches({SSORedirectionToIdp:"InitSSOAuthentication"})&&!e.context.error,error:e.context.error?.data?.message,localAccounts:e.context.localAccounts??[]}),Rt=(e,t)=>({step:"MasterPasswordStep",loginEmail:e.context.login??"",localAccounts:e.context.localAccounts??[],isLoading:(e.matches({MasterPassword:"ValidatingMasterPassword"})||e.matches({MasterPassword:"CheckingMigrationNeeded"})||e.matches({MasterPassword:"OpeningSessionWithMasterpassword"})||e.matches("MasterPasswordBasedAuthenticationDone"))&&!e.context.error,isAccountRecoveryAvailable:e.context.isAccountRecoveryAvailable,error:e.context.error?.data?.message,serviceProviderRedirectUrl:e.context.serviceProviderRedirectUrl,isNitroProvider:e.context.isNitroProvider??!1,isAuthenticationDone:t}),Tt=e=>{if(!e.context.login)throw new Error("No email login");return{step:"PinCodeStep",localAccounts:e.context.localAccounts??[],loginEmail:e.context.login,isLoading:e.matches({PinCode:"ValidatingPinCode"})&&!e.context.error,error:e.context.error?.code}},Ot=e=>({step:"StartingStep",localAccounts:e.context.localAccounts??[]});const Dt=e=>(0,pt.of)((0,h.Vp)(function(e){return e.matches("Starting")?Ot(e):e.matches("WaitingForEmail")||e.matches("ValidatingEmail")||e.matches("CheckPinCodeAvailableForMasterPassword")||e.matches("CheckPinCodeAvailableForPasswordless")?mt(e):e.matches({DeviceRegistration:{EmailToken:"SendEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"WaitingForEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"ValidatingEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"FinishingEmailToken"}})?It(e):e.matches({DeviceRegistration:{DashlaneAuthenticator:"RequestingServerPush"}})||e.matches({DeviceRegistration:{DashlaneAuthenticator:"AuthenticatorPushFailed"}})||e.matches({DeviceRegistration:{DashlaneAuthenticator:"AuthenticatorPushValidated"}})?bt(e):e.matches({TwoFactorAuthentication:"WaitingForTotp"})||e.matches({TwoFactorAuthentication:"WaitingForBackupCode"})||e.matches({TwoFactorAuthentication:"ValidatingTwoFactorAuthenticationOtp"})||e.matches({TwoFactorAuthentication:"FinishingTwoFactorAuthenticationOtp"})?Et(e):e.matches({WebAuthn:"InitWebAuthnAuthentication"})||e.matches({WebAuthn:"WebAuthnAuthenticationFailed"})||e.matches({WebAuthn:"WebAuthnAuthenticationValidated"})?Ct(e):e.matches("SSORedirectionToIdp")?At(e):e.matches({DeviceToDeviceAuthentication:"WaitingForTransferRequest"})?gt(e):e.matches({DeviceToDeviceAuthentication:"DisplayInstructions"})?vt(e):e.matches({DeviceToDeviceAuthentication:"GeneratePassphrase"})?yt(e):e.matches({DeviceToDeviceAuthentication:"StartTransfer"})?_t(e):e.matches({DeviceToDeviceAuthentication:"OpenSession"})?St(e):e.matches({DeviceToDeviceAuthentication:"DeviceTransferError"})?ft(e):e.matches({DeviceToDeviceAuthentication:"DeviceRegistered"})||e.matches("DeviceToDeviceAuthenticationDone")?wt(e):e.matches({PinCode:"WaitingForPinCode"})||e.matches({PinCode:"ValidatingPinCode"})||e.matches({PinCode:"PinCodeError"})?Tt(e):e.matches({MasterPassword:"CheckingAccountRecoveryStatus"})||e.matches({MasterPassword:"WaitingForMasterPassword"})||e.matches({MasterPassword:"ValidatingMasterPassword"})||e.matches({MasterPassword:"OpeningSessionWithMasterpassword"})||e.matches({MasterPassword:"CheckingMigrationNeeded"})||e.matches({MasterPassword:"OpeningSessionWithMasterpassword"})?Rt(e):e.matches("MasterPasswordBasedAuthenticationDone")?Rt(e,!0):void console.warn("[Auth] - No view associated to state ",JSON.stringify(e.value))}(e))),Ut=e=>e.pipe((0,ht.z)(Dt));var Ft=s(30045);let Pt=class{constructor(e,t){this.authenticationFlow=e,this.loginMachineStore=t}execute(){return(e=this.loginMachineStore,e.state$.pipe((0,S.U)((e=>e?v.ZM.create(JSON.parse(e)):void 0)))).pipe((0,Ee.h)(Boolean),(0,dt.x)(((e,t)=>((e,t)=>{const s=t.matches(e.value),r=(0,Ft.Z)(e.context,t.context);return s&&r})(e,t))),Ut);var e}};Pt=(0,r.__decorate)([(0,lt.e)(ut.DW),(0,r.__metadata)("design:paramtypes",[Ue,w])],Pt);let xt=class{constructor(e){this.ssoUserSettingsStore=e,this.ssoUserSettingsStore=e}execute(){return this.ssoUserSettingsStore.state$.pipe((0,S.U)((e=>(0,h.Vp)({rememberMeForSSOPreference:e.rememberMeForSSOPreference}))))}};xt=(0,r.__decorate)([(0,lt.e)(ut.Dc),(0,r.__metadata)("design:paramtypes",[C])],xt);let Nt=class{constructor(e){this.ssoProviderInfoStore=e,this.ssoProviderInfoStore=e}execute(){return this.ssoProviderInfoStore.state$.pipe((0,S.U)((e=>(0,h.Vp)({serviceProviderUrl:e.serviceProviderUrl,isNitroProvider:e.isNitroProvider,migrationType:e.migrationType}))))}};Nt=(0,r.__decorate)([(0,lt.e)(ut.L2),(0,r.__metadata)("design:paramtypes",[R])],Nt);const Gt=e=>!0;class kt extends((0,_.Q)({initialValue:void 0,persist:!1,scope:y.F.Device,storeName:"device-registration-flow-store",storeTypeGuard:Gt})){}var Lt=s(3786);let Mt=class{constructor(e){this.authenticationFlow=e}execute(e){const{pinCode:t}=e.body;return this.authenticationFlow.continue({type:"INPUT_PIN_CODE",pinCode:t}),Promise.resolve((0,h.Vp)(void 0))}};Mt=(0,r.__decorate)([(0,T.W)(O.CO),(0,r.__metadata)("design:paramtypes",[Ue])],Mt);let Kt=class{constructor(e){this.authenticationFlow=e}execute(){return this.authenticationFlow.continue({type:"USE_MASTER_PASSWORD"}),Promise.resolve((0,h.Vp)(void 0))}};Kt=(0,r.__decorate)([(0,T.W)(O.On),(0,r.__metadata)("design:paramtypes",[Ue])],Kt);let jt=class{constructor(e){this.authenticationFlow=e}execute(){return this.authenticationFlow.continue({type:"SWITCH_TO_PIN_CODE"}),Promise.resolve((0,h.Vp)(void 0))}};jt=(0,r.__decorate)([(0,T.W)(O.WF),(0,r.__metadata)("design:paramtypes",[Ue])],jt);let Vt=class{};Vt=(0,r.__decorate)([(0,c.Yl)({api:a.V,handlers:{commands:{changeLogin:Fe,changeTwoFactorAuthenticationOtpType:Pe,clearError:xe,cancelDeviceTransferRequest:Ne,resendEmailToken:Ge,resendPushNotification:ke,sendAccountEmail:Le,sendMasterPassword:Me,submitBackupCode:Ke,submitEmailToken:je,submitTotp:Ve,submitPinCode:Mt,switchToMasterPassword:Kt,switchToDashlaneAuthenticator:ze,switchToEmailToken:We,switchToDevicetoDeviceAuthentication:qe,switchToPinCode:jt,retryWebAuthnAuthentication:Be,webAuthnAuthenticationFail:$e,logout:Qe,lockSession:He,loginViaSSO:Je,initiateLoginWithSSO:st,initiateAutologinWithSSO:at},events:{...(0,c.g4)(o.W,{carbonLegacy:ct})},queries:{authenticationFlowStatus:Pt,getSsoUserSettings:xt,getProviderInfo:Nt}},configurations:{authenticationFlowContextInfrastructure:{token:tt}},providers:[te,ae,re,oe,Z,ce,Se,...(0,d.H)(Ue,{inject:[De,w,n._,u.c,l.J],asyncFactory:async(e,t,s,r,a)=>{let o=!1;const n=await(0,i.z)(r.queries.platformInfo());!(0,h.d6)(n)||n.data.buildType!==p.P.DEV&&n.data.buildType!==p.P.NIGHTLY||(o=!0);const c=new Ue(e,t,o,s,a);return await c.prepare(),c}}),De,be,Ie,Ce,Ae,z,H,ee,se,V,ne,Te,X,Re,Oe,pe,J,me,_e,ge,ve,he.q,ue.C,ye.Kp,ye.Ny],stores:[w,kt,C,R],imports:[m.n,g.i,Lt.I]})],Vt)},10430:(e,t,s)=>{s.d(t,{z:()=>r});class r extends Error{constructor(e,t){super(e),this.code=t}}},13460:(e,t,s)=>{s.d(t,{R:()=>g});var r=s(491),i=s(86006),a=s(66974),o=s(85373),n=s(42303),c=s(14122),d=s(46449),l=s(87279),u=s(85390),p=s(87065),h=s(6136);let m=class{constructor(e,t){this.carbon=e,this.pinCode=t}execute(){const e=this.carbon.queries.liveWebAuthnAuthenticationOptedIn(void 0),t=this.pinCode.queries.getCurrentUserStatus();return(0,u.a)({webAuthnQuery:e,pinCodeQuery:t}).pipe((0,p.U)((({pinCodeQuery:e,webAuthnQuery:t})=>{if((0,l.hx)(e)||(0,l.hx)(t))throw new Error("failed to query");return e.data.isPinCodeEnabled||t.data})),(0,h.x)(),(0,p.U)(l.Vp))}};m=(0,r.__decorate)([(0,d.e)(o._),(0,r.__metadata)("design:paramtypes",[c._,n.u])],m);let g=class{};g=(0,r.__decorate)([(0,i.Yl)({api:a.n,handlers:{commands:{},events:{},queries:{canLockApp:m}}})],g)},38487:(e,t,s)=>{s.d(t,{_:()=>N});var r=s(491),i=s(86006),a=s(42853),o=s(162),n=s(87065),c=s(46449),d=s(87279),l=s(59463),u=s(14122);let p=class{constructor(e){this.carbon=e}isLocalAccounts(e){if(!Array.isArray(e))return!1;if(0===e.length)return!0;const t=e[0];return"object"==typeof t&&"login"in t}isCarbonLocalAccountResult(e){return!(!e||"object"!=typeof e||!("localAccounts"in e))&&this.isLocalAccounts(e.localAccounts)}execute(){return(0,o.D)(this.carbon.commands.carbonLegacyLeeloo({name:"getLocalAccountsList",arg:[]})).pipe((0,n.U)((e=>{if((0,d.hx)(e))throw new Error("Unable to retrieve local accounts list");const t=(0,d.db)(e).carbonResult;if(!this.isCarbonLocalAccountResult(t))throw new Error("Carbon result is not of type local accounts");return(0,d.Vp)({localAccounts:t.localAccounts})})))}};p=(0,r.__decorate)([(0,c.e)(l.a),(0,r.__metadata)("design:paramtypes",[u._])],p);var h=s(82874),m=s(319);let g=class{constructor(e){this.carbon=e}async execute(){const e=await this.carbon.commands.cleanRemotelyRemovedProfiles();if((0,d.hx)(e))throw new Error("clean remotely removed profiles failed");return(0,d.Vp)(void 0)}};g=(0,r.__decorate)([(0,h.W)(m.L),(0,r.__metadata)("design:paramtypes",[u._])],g);var v=s(96782),y=s(18533),_=s(95087),S=s(60399),f=s(89238),w=s(92587),I=s(53344),b=s(66610),E=s(20195);const C="ZZ";const A="und";function R(e){return e?e.replace(/https?:\/\//g," "):e}var T=s(43902);const O={tag:"InvalidTokenError"},D={tag:"NetworkError"};let U=class{constructor(e,t,s){this.serverApiClient=e,this.carbon=t,this.contextless=s}async hasRegisteredDevice(e){const t=await(0,S.z)(this.carbon.queries.getLocalAccounts());if((0,d.hx)(t))throw new Error("Failed to query carbon");return t.data.some((t=>t.login===e))}async registerDeviceWithToken(e,t,s){const r=await(0,S.z)(this.serverApiClient.v1.authentication.performExtraDeviceVerification({login:e,token:t}));if(!(0,d.d6)(r))return(0,d.Rn)(O);const{authTicket:i}=r.data.data;return this.registerDeviceWithTicket(e,i,s)}async registerDeviceWithTicket(e,t,s){const r=await(0,S.z)(this.carbon.queries.getPlatformInfo());if(!(0,d.d6)(r))throw new Error("Failed to get status from carbon");const i=r.data;if("server_carbon_unknown"===i.platformName)throw new Error("unexpected server_carbon_unknown");const a={deviceName:R(s??T.getDefaultDeviceName()),appVersion:i.appVersion,platform:i.platformName,osCountry:(n=i.country,!n||n.length<2||n.length>5?C:n),osLanguage:(o=i.lang,!o||o.length<2||o.length>5?A:o),temporary:!1};var o,n;const c=await(0,S.z)(this.serverApiClient.v1.authentication.completeDeviceRegistrationWithAuthTicket({authTicket:t,login:e,device:a}));if(!(0,d.d6)(c))return(0,y.EQ)(c.error,{BusinessError:()=>(0,E.j)("Failed to register on server"),FetchFailedError:()=>(0,d.Rn)(D),InternalServerError:()=>(0,E.j)("Failed to register on server"),InvalidRequest:()=>(0,E.j)("Failed to register on server"),RateLimited:()=>(0,E.j)("Failed to register on server"),ServiceUnavailable:()=>(0,E.j)("Failed to register on server"),UnspecifiedBadStatus:()=>(0,E.j)("Failed to register on server")});const{deviceAccessKey:l,deviceSecretKey:u,settings:p,serverKey:h}=c.data.data;return await this.registerDeviceWithKeys({deviceAccessKey:l,deviceSecretKey:u,login:e,settingsContent:p.content,serverKey:h})}async registerDeviceWithKeys({deviceAccessKey:e,deviceSecretKey:t,settingsContent:s,serverKey:r,login:i}){const a=await(0,S.z)(this.contextless.v1.account.accountInfo({deviceAccessKey:e,deviceSecretKey:t,login:i}));if(!(0,d.d6)(a))return(0,y.EQ)(a.error,{BusinessError:()=>(0,E.j)("Failed to get account infos"),FetchFailedError:()=>(0,d.Rn)(D),InternalServerError:()=>(0,E.j)("Failed to get account infos"),InvalidRequest:()=>(0,E.j)("Failed to get account infos"),RateLimited:()=>(0,E.j)("Failed to get account infos"),ServiceUnavailable:()=>(0,E.j)("Failed to get account infos"),UnspecifiedBadStatus:()=>(0,E.j)("Failed to get account infos")});const{creationDateUnix:o,publicUserId:n,deviceAnalyticsId:c,userAnalyticsId:l}=a.data.data,u=await this.carbon.commands.registerDevice({deviceAccessKey:e,deviceAnalyticsId:c??"",deviceSecretKey:t,settings:{action:"BACKUP_EDIT",backupDate:o,content:s,identifier:"SETTINGS_userId",time:o,type:"SETTINGS"},serverKey:r,publicUserId:n,userAnalyticsId:l??"",isDataPersisted:f.jP.PERSIST_DATA_YES,login:i});if((0,d.hx)(u))throw new Error("Failed to register in carbon");return(0,d.Vp)(void 0)}};U=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:paramtypes",[I.l,u._,b.B])],U);const F={tag:"DeviceAlreadyRegistered"};let P=class{constructor(e){this.service=e}async execute({body:e}){const{login:t,ignoreAlreadyRegisteredError:s,deviceName:r}=e;if(!s){if(await this.service.hasRegisteredDevice(t))return(0,d.Rn)(F)}switch(e.with){case"authTicket":return this.service.registerDeviceWithTicket(t,e.authTicket,r);case"token":return(0,y.EQ)(await this.service.registerDeviceWithToken(t,e.token,r),{success:()=>(0,d.Vp)(void 0),failure:e=>(0,y.EQ)(e.error,{InvalidTokenError:e=>(0,d.Rn)(e),NetworkError:e=>(0,d.Rn)(e)})});case"deviceKeys":return await this.service.registerDeviceWithKeys({deviceAccessKey:e.deviceAccessKey,deviceSecretKey:e.deviceSecretKey,login:t,settingsContent:e.settings,serverKey:e.serverKey});default:return(0,_.U)(e)}}};P=(0,r.__decorate)([(0,h.W)(v.J),(0,r.__metadata)("design:paramtypes",[U])],P);var x=s(41511);let N=class{};N=(0,r.__decorate)([(0,i.Yl)({api:a.G,imports:[x.n],handlers:{commands:{cleanRemotelyRemovedProfiles:g,registerDevice:P},events:{},queries:{localAccounts:p}},providers:[U]})],N)},65871:(e,t,s)=>{s.d(t,{E:()=>n,V:()=>c});var r=s(491),i=s(75377),a=s.n(i),o=s(92587);let n=class{constructor(e){this.sodium=e}generateNonce(){return this.sodium.randombytes_buf(this.sodium.crypto_box_NONCEBYTES)}generateKeyPair(){return this.sodium.crypto_kx_keypair()}hash(e,t){return this.sodium.crypto_generichash(this.sodium.crypto_secretbox_KEYBYTES,e,t)}compare(e,t){return this.sodium.memcmp(e,t)}generateClientSharedSecret(e,t,s){return this.sodium.crypto_kx_client_session_keys(e,t,s)}generateServerSharedSecret(e,t,s){return this.sodium.crypto_kx_server_session_keys(e,t,s)}encrypt(e,t,s){return this.sodium.crypto_secretbox_easy(e,t,s)}decrypt(e,t,s){return this.sodium.crypto_secretbox_open_easy(e,t,s)}};function c(){return{token:n,asyncFactory:async()=>{await a().ready;const e=a();return new n(e)}}}n=(0,r.__decorate)([(0,o.GS)(),(0,r.__metadata)("design:paramtypes",[Object])],n)},46484:(e,t,s)=>{s.d(t,{KF:()=>i,dJ:()=>a});var r=s(29498);const i=3;class a extends r.x{constructor(e,t){super(e),this.code=t}}},3786:(e,t,s)=>{s.d(t,{I:()=>oe});var r=s(491),i=s(6218),a=s(86006),o=s(86213),n=s(41511),c=s(65871),d=s(8362),l=s(87065),u=s(62149),p=s(63144);const h=e=>!0;class m extends((0,p.Q)({initialValue:void 0,persist:!1,scope:u.F.Device,storeName:"trusted-device-flow-machine",storeTypeGuard:h})){}const g=e=>e.state$.pipe((0,l.U)((e=>e?d.ZM.create(JSON.parse(e)):void 0)));var v=s(78065),y=s(24966),_=s(92587),S=s(18275),f=s(65865),w=s(70486),I=s(46484),b=s(87279),E=s(16053);let C=class{constructor(e){this.d2dAuthenticationService=e}async execute(){const e=await this.d2dAuthenticationService.getKeyExchangeTransferInfo();if((0,b.hx)(e))throw new Error("Error with getKeyExchangeTransferInfo");const{transferId:t,receiver:s}=e.data.transfer;return Promise.resolve({transferId:t,requestTimestamp:s.requestedAtDateUnix,untrustedDeviceName:s.deviceName,untrustedDeviceLocation:`${s.city}, ${s.countryCode}`,untrustedDeviceHashedPublicKey:s.hashedPublicKey})}};C=(0,r.__decorate)([(0,_.GS)(),(0,r.__metadata)("design:paramtypes",[E.C])],C);var A=s(15652),R=s(69605);let T=class{constructor(e,t,s){this.d2dCryptoService=e,this.d2dAuthenticationService=t,this.passphraseService=s}async execute(e){const{privateKey:t,publicKey:s}=this.d2dCryptoService.generateKeyPair();if(!e.transferId)throw new Error("No transferId in context");const r=await this.d2dAuthenticationService.startSenderKeyExchange(e.transferId,s);if((0,b.hx)(r))return Promise.reject(r.error);const{receiverPublicKey:i}=r.data,a=e.untrustedDeviceHashedPublicKey;if(!this.d2dCryptoService.verifyUntrustedDevicePublicKey(a,i))throw new Error("Receiver public key doesn't match");const o=this.d2dCryptoService.generateSenderSharedSecret(s,t,i),n=await this.d2dAuthenticationService.getCurrentUserLogin();if((0,b.hx)(n)||!n.data)throw new Error("No user login in context");const c=this.d2dCryptoService.generateVisualCheckSeed(n.data,e.transferId,o),{passphrase:d,missingWordIndex:l}=await this.passphraseService.generatePassphraseChallenge(c);return{sharedSecret:o,passphrase:d,passhraseMissingWordIndex:l}}};T=(0,r.__decorate)([(0,_.GS)(),(0,r.__metadata)("design:paramtypes",[A.q,E.C,R.Kp])],T);let O=class{constructor(e,t,s){this.passphraseService=e,this.d2dCryptoService=t,this.d2dAuthenticationService=s}async execute(e){if(!this.passphraseService.verifyChallenge(e.passphrase,e.passphraseGuess))throw new I.dJ("Passphrase incorrect",e.passphraseAttemptsLeft>1?w.S.INVALID_PASSPHRASE:w.S.PASSPHRASE_ATTEMPTS_LIMIT);const t=await this.d2dAuthenticationService.getCurrentUserLogin();if((0,b.hx)(t)||!t.data||!e.transferId)throw new Error("No user login or no transferId");const s=await this.d2dAuthenticationService.getUserInvisibleMasterPassword(),r=await this.d2dAuthenticationService.requestAuthTicket();if((0,b.hx)(r))throw new Error("Couldn't get authTicket");const{encryptedData:i,nonce:a}=this.d2dCryptoService.encryptInvisibleMasterPassword(t.data,r.data,s,e.transferId,e.sharedSecret),o=await this.d2dAuthenticationService.completeTransfer(i,a,e.transferId);return(0,b.hx)(o)?Promise.reject(o.error):Promise.resolve()}};O=(0,r.__decorate)([(0,_.GS)(),(0,r.__metadata)("design:paramtypes",[R.Kp,A.q,E.C])],O);let D=class{constructor(e,t,s){this.getPendingDeviceTransferRequestService=e,this.approveDeviceTransferRequestService=t,this.verifyPassphraseChallengeService=s}create(){return(0,S.C)({predictableActionArguments:!0,schema:{events:{},context:{}},initial:"WaitingForNewDeviceTransferRequest",id:"TrustedDeviceFlowMachine",context:{transferId:void 0,untrustedDeviceName:"",untrustedDeviceHashedPublicKey:"",untrustedDeviceLocation:"",sharedSecret:"",passphrase:"",passphraseGuess:"",passphraseMissingWordIndex:-1,passphraseAttemptsLeft:I.KF},states:{Idle:{on:{REFRESH_REQUEST:{target:"WaitingForNewDeviceTransferRequest"}}},WaitingForNewDeviceTransferRequest:{invoke:{src:"getPendingDeviceTransferRequest",onDone:[{actions:["assignUntrustedDeviceData"],cond:"isDeviceTransferRequestAvailable",target:"NewDeviceTransferRequest"},{target:"Idle"}],onError:{actions:["assignTrustedDeviceFlowError"],target:"Idle"}}},NewDeviceTransferRequest:{on:{APPROVE_REQUEST:{target:"HandlingDeviceTransferRequest"},REJECT_REQUEST:{actions:["clearContext"],target:"DeviceTransferRejected"},RETURN_TO_DEVICE_SETUP:{actions:["clearContext"],target:"Idle"}}},HandlingDeviceTransferRequest:{invoke:{src:"approveDeviceTransferRequest",onDone:{actions:["assignPassphraseChallengeData"],target:"DisplayPassphraseChallenge"},onError:{actions:["assignTrustedDeviceFlowError"],target:"DeviceTransferFailed"}}},DisplayPassphraseChallenge:{on:{SUBMIT_PASSPHRASE_CHALLENGE:{actions:["assignPassphraseGuess","clearError"],target:"VerifyingPassphraseChallenge"},CANCEL_REQUEST:{actions:["clearContext"],target:"Idle"}}},VerifyingPassphraseChallenge:{invoke:{src:"verifyPassphraseChallenge",onDone:{target:"DeviceTransferComplete"},onError:[{actions:["assignTrustedDeviceFlowError","updatePassphraseAttempts"],target:"DisplayPassphraseChallenge",cond:"isInvalidPassphraseError"},{actions:["assignTrustedDeviceFlowError","updatePassphraseAttempts"],target:"DeviceTransferFailed"}]}},DeviceTransferComplete:{on:{RETURN_TO_DEVICE_SETUP:{actions:["clearContext"],target:"Idle"}}},DeviceTransferRejected:{on:{RETURN_TO_DEVICE_SETUP:{target:"Idle"}}},DeviceTransferFailed:{on:{RETURN_TO_DEVICE_SETUP:{actions:["clearContext"],target:"Idle"}}}}},{actions:{assignUntrustedDeviceData:(0,f.f0)({transferId:(e,t)=>t.data.transferId,untrustedDeviceName:(e,t)=>t.data.untrustedDeviceName,untrustedDeviceHashedPublicKey:(e,t)=>t.data.untrustedDeviceHashedPublicKey,untrustedDeviceLocation:(e,t)=>t.data.untrustedDeviceLocation,requestTimestamp:(e,t)=>t.data.requestTimestamp}),clearContext:(0,f.f0)({transferId:()=>{},untrustedDeviceName:()=>"",untrustedDeviceHashedPublicKey:()=>"",untrustedDeviceLocation:()=>"",sharedSecret:()=>"",passphrase:()=>"",passphraseGuess:()=>"",passphraseMissingWordIndex:()=>-1,passphraseAttemptsLeft:()=>I.KF,error:()=>{}}),clearError:(0,f.f0)({error:()=>{}}),assignTrustedDeviceFlowError:(0,f.f0)({error:(e,t)=>t.data instanceof I.dJ?t.data.code:w.S.GENERIC_ERROR}),assignPassphraseChallengeData:(0,f.f0)({sharedSecret:(e,t)=>t.data.sharedSecret,passphrase:(e,t)=>t.data.passphrase,passphraseMissingWordIndex:(e,t)=>t.data.passhraseMissingWordIndex}),assignPassphraseGuess:(0,f.f0)({passphraseGuess:(e,t)=>t.passphraseChallenge}),updatePassphraseAttempts:(0,f.f0)({passphraseAttemptsLeft:(e,t)=>t.data instanceof I.dJ&&t.data.code===w.S.INVALID_PASSPHRASE?e.passphraseAttemptsLeft-1:e.passphraseAttemptsLeft})},services:{getPendingDeviceTransferRequest:()=>this.getPendingDeviceTransferRequestService.execute(),approveDeviceTransferRequest:e=>this.approveDeviceTransferRequestService.execute(e),verifyPassphraseChallenge:e=>this.verifyPassphraseChallengeService.execute(e)},guards:{isDeviceTransferRequestAvailable:(e,t)=>!!t.data.transferId,isInvalidPassphraseError:(e,t)=>t.data instanceof I.dJ&&"INVALID_PASSPHRASE"===t.data.code}})}};D=(0,r.__decorate)([(0,_.GS)(),(0,r.__metadata)("design:paramtypes",[C,T,O])],D);let U=class{constructor(e,t){this.trustedDeviceMachineStore=t;const s=e.create();this.interpreter=v.kJ(s).onTransition((async e=>{e.changed||"xstate.init"===e.event.type||console.warn(`[D2D Trusted Device Flow] State is unchanged. Unexpected transition on ${JSON.stringify(e.value)} with event ${e.event.type} `);try{const e=this.interpreter?.getSnapshot();e&&await(async(e,t)=>{await e.set(JSON.stringify(t))})(this.trustedDeviceMachineStore,e)}catch(e){console.warn("[D2D Trusted Device Flow] Unable to get snapshot",e)}}))}async prepare(){if(this.interpreter)try{const e=await(async e=>{const t=await e.getState();return t?d.ZM.create(JSON.parse(t)):void 0})(this.trustedDeviceMachineStore);try{this.interpreter.start(e)}catch(e){console.error("[D2D Trusted Device Flow] Unable to reuse the stored state: ",e),this.interpreter.start()}}catch(e){console.error("[D2D Trusted Device Flow] Unable to start machine",e)}}ready(){return new y.X(!0)}continue(e){if(!this.interpreter)throw new Error("TrustedDevice flow not started");this.interpreter.send(e)}stop(){this.isStarted()&&(this.interpreter=void 0)}isStarted(){return Boolean(this.interpreter)}};U=(0,r.__decorate)([(0,_.GS)(),(0,r.__metadata)("design:paramtypes",[D,m])],U);var F=s(43978),P=s(90171),x=s(83695),N=s(85390),G=s(41842),k=s(6136),L=s(30045),M=s(46449),K=s(53835),j=s(69885),V=s(6220),z=s(69126);const W=e=>(0,j.of)((0,b.Vp)(function(e){if(e.matches("Idle")||e.matches("WaitingForNewDeviceTransferRequest"))return{step:w.T.WaitingForNewDeviceRequest};if(e.matches("NewDeviceTransferRequest"))return(0,z.Xn)(e.context.requestTimestamp)<=0?{step:w.T.Error,errorCode:w.S.TIMEOUT}:{step:w.T.NewDeviceRequestAvailable,untrustedDeviceName:e.context.untrustedDeviceName,untrustedDeviceLocation:e.context.untrustedDeviceLocation,requestTimestamp:e.context.requestTimestamp};if(e.matches("HandlingDeviceTransferRequest"))return{step:w.T.LoadingChallenge};if(e.matches("DisplayPassphraseChallenge")||e.matches("VerifyingPassphraseChallenge")){const{passphrase:t,passphraseMissingWordIndex:s,untrustedDeviceName:r,error:i}=e.context,a=t.split(R.iy).map(((e,t)=>t===s?"":e));return{step:w.T.DisplayPassphraseChallenge,untrustedDeviceName:r,passphrase:a,error:i}}if(e.matches("DeviceTransferComplete"))return{step:w.T.DeviceTransferComplete,untrustedDeviceName:e.context.untrustedDeviceName};if(e.matches("DeviceTransferRejected"))return{step:w.T.DeviceTransferRejected,untrustedDeviceName:e.context.untrustedDeviceName};if(e.matches("DeviceTransferFailed"))return{step:w.T.Error,errorCode:e.context.error};throw new Error("[D2D Trusted Device] - No view associated to state")}(e))),q=e=>e.pipe((0,V.z)(W));let B=class{constructor(e,t){this.trustedDeviceFlow=e,this.trustedDeviceFlowMachineStore=t}execute(){const e=g(this.trustedDeviceFlowMachineStore).pipe((0,G.h)(Boolean),(0,l.U)((e=>e.context.requestTimestamp?(0,z.Xn)(e.context.requestTimestamp):0))).pipe((0,F.w)((e=>(0,P.H)(e))),(0,x.O)(0));return(0,N.a)([g(this.trustedDeviceFlowMachineStore),this.trustedDeviceFlow.ready(),e],((e,t,s)=>{if(e&&t)return e})).pipe((0,G.h)(Boolean),q,(0,k.x)(((e,t)=>(0,L.Z)(e,t))))}};B=(0,r.__decorate)([(0,M.e)(K.N),(0,r.__metadata)("design:paramtypes",[U,m])],B);var $=s(82874),Y=s(87041);let Q=class{constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}execute(){return this.trustedDeviceFlow.continue({type:"APPROVE_REQUEST"}),Promise.resolve((0,b.Vp)(void 0))}};Q=(0,r.__decorate)([(0,$.W)(Y.G),(0,r.__metadata)("design:paramtypes",[U])],Q);var H=s(33969);let J=class{constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}execute(){return this.trustedDeviceFlow.continue({type:"REFRESH_REQUEST"}),Promise.resolve((0,b.Vp)(void 0))}};J=(0,r.__decorate)([(0,$.W)(H.V),(0,r.__metadata)("design:paramtypes",[U])],J);var Z=s(55870);let X=class{constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}execute(){return this.trustedDeviceFlow.continue({type:"REJECT_REQUEST"}),Promise.resolve((0,b.Vp)(void 0))}};X=(0,r.__decorate)([(0,$.W)(Z.a),(0,r.__metadata)("design:paramtypes",[U])],X);var ee=s(97891);let te=class{constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}execute(){return this.trustedDeviceFlow.continue({type:"CANCEL_REQUEST"}),Promise.resolve((0,b.Vp)(void 0))}};te=(0,r.__decorate)([(0,$.W)(ee.b),(0,r.__metadata)("design:paramtypes",[U])],te);var se=s(48214);let re=class{constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}execute(e){const{passphraseChallenge:t}=e.body;return this.trustedDeviceFlow.continue({type:"SUBMIT_PASSPHRASE_CHALLENGE",passphraseChallenge:t}),Promise.resolve((0,b.Vp)(void 0))}};re=(0,r.__decorate)([(0,$.W)(se.I),(0,r.__metadata)("design:paramtypes",[U])],re);var ie=s(81540);let ae=class{constructor(e){this.trustedDeviceFlow=e,this.trustedDeviceFlow=e}execute(){return this.trustedDeviceFlow.continue({type:"RETURN_TO_DEVICE_SETUP"}),Promise.resolve((0,b.Vp)(void 0))}};ae=(0,r.__decorate)([(0,$.W)(ie.n),(0,r.__metadata)("design:paramtypes",[U])],ae);let oe=class{};oe=(0,r.__decorate)([(0,a.Yl)({api:i.F,stores:[m],imports:[n.n],exports:[A.q,c.E],providers:[(0,c.V)(),...(0,o.H)(U,{inject:[D,m],asyncFactory:async(e,t)=>{const s=new U(e,t);return await s.prepare(),s}}),c.E,R.Kp,A.q,E.C,C,T,O,D,R.Ny],handlers:{commands:{approveRequest:Q,refreshRequest:J,rejectRequest:X,cancelRequest:te,submitPassphraseChallenge:re,returnToDeviceSetup:ae},events:{},queries:{trustedDeviceFlowStatus:B}}})],oe)},16053:(e,t,s)=>{s.d(t,{C:()=>w});var r=s(491),i=s(60399),a=s(43902),o=s(89238),n=s(14122),c=s(53344),d=s(25994),l=s(92587),u=s(48844),p=s(87279),h=s(18533),m=s(20195),g=s(89358),v=s(64496),y=s(70486),_=s(69126),S=s(10430),f=s(46484);let w=class{constructor(e,t,s){this.serverApiClient=e,this.sessionClient=t,this.carbon=s}async getCurrentUserLogin(){return await(0,i.z)(this.sessionClient.queries.selectedOpenedSession().pipe((0,u.DZ)((()=>(0,p.Rn)(new Error("No user login found")))),(0,u.lk)((e=>(0,p.Vp)(e)))))}getUserInvisibleMasterPassword(){const{carbonState:e}=this.carbon.queries;return(0,i.z)(e({path:"userSession.session.masterPassword"}).pipe((0,u.nb)({success:e=>e,failure:()=>{throw new Error("Failure getting user invisible master password info")}})))}async requestAuthTicket(){return await(0,i.z)(this.serverApiClient.v1.authentication.requestExtraDeviceRegistration({tokenType:"googleAccountNewDevice"}).pipe((0,u.DZ)((e=>(0,h.EQ)(e,{BusinessError:()=>(0,p.Rn)(e),FetchFailedError:()=>(0,p.Rn)(e),UnspecifiedBadStatus:()=>(0,p.Rn)(e),InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j}))),(0,u.lk)((e=>(0,p.Vp)(e.data.token)))))}async getKeyExchangeTransferInfo(){return await(0,i.z)(this.serverApiClient.v1.secretTransfer.getKeyExchangeTransferInfo({}).pipe((0,u.DZ)((e=>(0,h.EQ)(e,{BusinessError:()=>(0,p.Rn)(e),FetchFailedError:()=>(0,p.Rn)(e),UnspecifiedBadStatus:()=>(0,p.Rn)(e),InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j}))),(0,u.lk)((e=>(0,p.Vp)(e.data)))))}async startReceiverKeyExchange(e,t){return await(0,i.z)(this.serverApiClient.v1.secretTransfer.startReceiverKeyExchange({transferId:e,receiverHashedPublicKey:t},{timeout:6e4}).pipe((0,u.DZ)((e=>(0,h.EQ)(e,{BusinessError:m.j,FetchFailedError:()=>{throw new S.z("User offline or request timeout",v.UY.TIMEOUT)},UnspecifiedBadStatus:({response:t})=>{if(t.status===d.W.GatewayTimeout)return new S.z("Request has timed out",v.UY.TIMEOUT);(0,m.j)(e)},InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j}))),(0,u.lk)((e=>(0,p.Vp)(e.data)))))}async completeKeyExchange(e,t){return await(0,i.z)(this.serverApiClient.v1.secretTransfer.completeKeyExchange({receiverPublicKey:t,transferId:e}).pipe((0,u.DZ)((e=>(0,h.EQ)(e,{BusinessError:()=>(0,p.Rn)(e),FetchFailedError:()=>(0,p.Rn)(e),UnspecifiedBadStatus:()=>(0,p.Rn)(e),InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j}))),(0,u.lk)((e=>(0,p.Vp)(e.data)))))}async startTransfer(e){return await(0,i.z)(this.serverApiClient.v1.secretTransfer.startTransfer({transferId:e,transferType:"universal"},{timeout:6e4}).pipe((0,u.DZ)((e=>(0,h.EQ)(e,{BusinessError:m.j,FetchFailedError:m.j,UnspecifiedBadStatus:({response:t})=>t.status===d.W.GatewayTimeout?new S.z("Request has timed out",v.UY.TIMEOUT):(0,m.j)(e),InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j}))),(0,u.lk)((e=>(0,p.Vp)(e.data)))))}async requestTransfer(e,t){return await(0,i.z)(this.serverApiClient.v1.secretTransfer.requestTransfer({transfer:{login:e,receiverDeviceName:t,transferType:"universal"}}).pipe((0,u.DZ)((e=>(0,h.EQ)(e,{BusinessError:()=>{throw new Error("[D2D]: Business Error")},FetchFailedError:()=>{throw new Error("[D2D]: Network error")},UnspecifiedBadStatus:m.j,InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j}))),(0,u.lk)((e=>(0,p.Vp)(e.data)))))}async startSenderKeyExchange(e,t){return await(0,i.z)(this.serverApiClient.v1.secretTransfer.startSenderKeyExchange({transferId:e,senderPublicKey:t},{timeout:6e4}).pipe((0,u.DZ)((e=>(0,h.EQ)(e,{BusinessError:e=>{if("TRANSFER_DOES_NOT_EXISTS"===e.code)throw new f.dJ("Transfer request has expired",y.S.TIMEOUT);throw new Error("[D2D]: Business Error")},FetchFailedError:()=>{throw new Error("[D2D]: Network error")},UnspecifiedBadStatus:({response:e})=>{if(e.status===d.W.GatewayTimeout)return new f.dJ("Request has timed out",y.S.TIMEOUT);throw new Error("[D2D]: Bad status error")},InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j}))),(0,u.lk)((e=>(0,p.Vp)(e.data)))))}async completeTransfer(e,t,s){return await(0,i.z)(this.serverApiClient.v1.secretTransfer.completeTransfer({transfer:{encryptedData:e,nonce:t,transferId:s,transferType:"universal"}}).pipe((0,u.DZ)((e=>(0,h.EQ)(e,{BusinessError:e=>{if("TRANSFER_DOES_NOT_EXISTS"===e.error.code)return new f.dJ("Request timed out",y.S.TIMEOUT);throw new Error("[D2D]: Business Error")},FetchFailedError:()=>{throw new Error("[D2D]: Network error")},UnspecifiedBadStatus:m.j,InternalServerError:m.j,InvalidRequest:m.j,RateLimited:m.j,ServiceUnavailable:m.j}))),(0,u.lk)((e=>(0,p.Vp)(e.data)))))}async openSession(e,t,s,r){const n=await(0,i.z)(this.serverApiClient.v1.authentication.performExtraDeviceVerification({login:e,token:t}));if(!(0,p.d6)(n))throw new S.z("Perform extra device verification failed",v.UY.ACCOUNT_ERROR);const{authTicket:c}=n.data.data,d=await(0,i.z)(this.carbon.queries.getPlatformInfo());if(!(0,p.d6)(d))throw new S.z("No platform info available",v.UY.ACCOUNT_ERROR);const l=d.data,u={deviceName:(0,_.$f)(r||a.getDefaultDeviceName()),appVersion:l.appVersion,platform:l.platformName,osCountry:(0,_.Yb)(l.country),osLanguage:(0,_._$)(l.lang),temporary:!1},h=await(0,i.z)(this.serverApiClient.v1.authentication.completeDeviceRegistrationWithAuthTicket({authTicket:c,login:e,device:u}));if(!(0,p.d6)(h))throw new S.z("Device registration with authTicket failed",v.UY.ACCOUNT_ERROR);const{deviceAccessKey:m,deviceAnalyticsId:g,deviceSecretKey:y,settings:f,serverKey:w,publicUserId:I,userAnalyticsId:b}=h.data.data;await this.carbon.commands.registerDevice({deviceAccessKey:m,deviceAnalyticsId:g,deviceSecretKey:y,settings:f,serverKey:w,publicUserId:I,userAnalyticsId:b,isDataPersisted:o.jP.PERSIST_DATA_YES,login:e});const E=await this.carbon.commands.openSessionWithMasterPassword({login:e,password:s,rememberPassword:!0,requiredPermissions:void 0,serverKey:"",loginType:"DeviceToDevice"});if(!(0,p.d6)(E))throw new S.z("Open session with deciphered password failed",v.UY.ACCOUNT_ERROR)}};w=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:paramtypes",[c.l,g.x,n._])],w)},15652:(e,t,s)=>{s.d(t,{q:()=>c});var r=s(491),i=s(10370),a=s(92587),o=s(65871),n=s(69126);let c=class{constructor(e){this.cryptoToolboxService=e}verifyUntrustedDevicePublicKey(e,t){return this.cryptoToolboxService.compare((0,n.tp)(e),(0,n.tp)(this.hash(t)))}generateReceiverSharedSecret(e,t,s){return(0,i.s)(this.cryptoToolboxService.generateClientSharedSecret((0,n.tp)(e),(0,n.tp)(t),(0,n.tp)(s)).sharedRx)}generateSenderSharedSecret(e,t,s){return(0,i.s)(this.cryptoToolboxService.generateServerSharedSecret((0,n.tp)(e),(0,n.tp)(t),(0,n.tp)(s)).sharedTx)}generateSymmetricKey(e,t,s){return(0,i.s)(this.cryptoToolboxService.hash((new TextEncoder).encode(`DASHLANE_D2D_SYMMETRIC_KEY${e.length}${e}${t}`),(0,n.tp)(s)))}hash(e){return(0,i.s)(this.cryptoToolboxService.hash((0,n.tp)(e)))}generateKeyPair(){const e=this.cryptoToolboxService.generateKeyPair();return{publicKey:(0,i.s)(e.publicKey),privateKey:(0,i.s)(e.privateKey)}}generateVisualCheckSeed(e,t,s){return(0,i.s)(this.cryptoToolboxService.hash((new TextEncoder).encode(`DASHLANE_D2D_SAS_SEED${e.length}${e}${t}`),(0,n.tp)(s)))}encryptInvisibleMasterPassword(e,t,s,r,a){const o=(e=>(new TextEncoder).encode(JSON.stringify(e)))({login:e,key:{type:"invisible_master_password",value:s},token:t,version:1}),c=this.generateSymmetricKey(e,r,a),d=this.cryptoToolboxService.generateNonce(),l=this.cryptoToolboxService.encrypt(o,d,(0,n.tp)(c));return{encryptedData:(0,i.s)(l),nonce:(0,i.s)(d)}}decryptInvisibleMasterPassword(e,t,s){const r=this.cryptoToolboxService.decrypt((0,n.tp)(e),(0,n.tp)(t),(0,n.tp)(s)),i=new TextDecoder("utf-8").decode(r);return JSON.parse(i)}};c=(0,r.__decorate)([(0,a.GS)(),(0,r.__metadata)("design:paramtypes",[o.E])],c)},69605:(e,t,s)=>{s.d(t,{Kp:()=>u,Ny:()=>l,iy:()=>c});var r=s(491),i=s(7531),a=s(92587),o=s(23337),n=s(69126);const c=" ",d=Math.pow(2,32)-1;let l=class extends i.K{constructor(e){super("assets/eff_large_wordlist.json",e)}loadResource(e){if(!e||!Array.isArray(e))throw new Error("Failed to load word list");return e}};l=(0,r.__decorate)([(0,a.GS)(),(0,r.__metadata)("design:paramtypes",[o.X])],l);let u=class{constructor(e){this.fetcher=e}getWordList(){return this.fetcher.get()}async generatePassphraseChallenge(e){const t=await this.getWordList(),s=[],r=Math.floor(d/t.length)*t.length;for(let i=0;i<e.length;i+=4){const{buffer:a,byteOffset:o}=new Uint8Array((0,n.tp)(e).slice(i,i+4)),c=new DataView(a).getUint32(o,!0);if(c<r){const e=t[c%t.length];s.push(e)}if(5===s.length)break}return{passphrase:s.join(c),missingWordIndex:Math.floor(5*Math.random())}}verifyChallenge(e,t){if(!e)throw new Error("[DEVICE-TRANSFER]: Passphrase challenge not generated yet");if(!t)throw new Error("[DEVICE-TRANSFER]: Passphrase guess not saved to machine context");return e===t}};u=(0,r.__decorate)([(0,a.GS)(),(0,r.__metadata)("design:paramtypes",[l])],u)},69126:(e,t,s)=>{s.d(t,{$f:()=>l,Xn:()=>i,Yb:()=>n,_$:()=>d,tp:()=>a});var r=s(7502);const i=e=>1e3*e+6e4-Date.now(),a=e=>new Uint8Array((0,r.R)(e)),o="ZZ";function n(e){return!e||e.length<2||e.length>5?o:e}const c="und";function d(e){return!e||e.length<2||e.length>5?c:e}function l(e){return e?e.replace(/https?:\/\//g," "):e}},99600:(e,t,s)=>{s.d(t,{f:()=>De});var r,i,a,o,n,c=s(491),d=s(86006),l=s(86213),u=s(41511),p=s(11433),h=s(92587),m=s(65865),g=s(18275),v=s(87279),y=s(60399),_=s(53344),S=s(48844),f=s(18533),w=s(95087),I=s(20195),b=s(96168);!function(e){e.VERIFICATION_FAILED="verification_failed",e.VERIFICATION_TIMEOUT="verification_timeout",e.VERIFICATION_REQUIRES_REQUEST="verification_requires_request",e.ACCOUNT_BLOCKED_CONTACT_SUPPORT="account_blocked_contact_support",e.INVALID_OTP_ALREADY_USED="invalid_otp_already_used",e.INVALID_OTP_BLOCKED="invalid_otp_blocked"}(r||(r={}));class E extends((0,b.Hu)(r.VERIFICATION_FAILED,"")){}class C extends((0,b.Hu)(r.VERIFICATION_TIMEOUT,"")){}class A extends((0,b.Hu)(r.VERIFICATION_REQUIRES_REQUEST,"")){}class R extends((0,b.Hu)(r.ACCOUNT_BLOCKED_CONTACT_SUPPORT,"")){}class T extends((0,b.Hu)(r.INVALID_OTP_ALREADY_USED,"")){}class O extends((0,b.Hu)(r.INVALID_OTP_BLOCKED,"")){}class D extends((0,b.Hu)("network_error","")){}!function(e){e.TOKEN_NOT_VALID="TOKEN_NOT_VALID",e.TOKEN_EXPIRED="TOKEN_EXPIRED",e.TOKEN_TOO_MANY_ATTEMPTS="TOKEN_TOO_MANY_ATTEMPTS",e.TOKEN_ACCOUNT_LOCKED="TOKEN_ACCOUNT_LOCKED"}(i||(i={})),function(e){e.OTP_NOT_VALID="OTP_NOT_VALID",e.OTP_TOO_MANY_ATTEMPTS="OTP_TOO_MANY_ATTEMPTS",e.OTP_ALREADY_USED="OTP_ALREADY_USED",e.BACKUP_CODE_NOT_VALID="BACKUP_CODE_NOT_VALID"}(a||(a={})),function(e){e.DASHLANE_AUTHENTICATOR_PUSH_NOTIFICATION_DENIED="DASHLANE_AUTHENTICATOR_PUSH_NOTIFICATION_DENIED",e.TOKEN_EXPIRED="TOKEN_EXPIRED"}(o||(o={})),function(e){e.NETWORK_ERROR="NETWORK_ERROR",e.UNKNOWN_ERROR="UNKNOWN_ERROR"}(n||(n={}));let U=class{constructor(e){this.serverApiClient=e}async performEmailTokenVerification(e,t){return await(0,y.z)(this.serverApiClient.v1.authentication.performEmailTokenVerification({login:e,token:t}).pipe((0,S.DZ)((e=>(0,f.EQ)(e,{BusinessError:e=>{switch(e.code){case r.VERIFICATION_FAILED:return new E;case r.VERIFICATION_TIMEOUT:return new C;case r.VERIFICATION_REQUIRES_REQUEST:return new A;case r.ACCOUNT_BLOCKED_CONTACT_SUPPORT:return new R;default:(0,w.U)(e.code)}},FetchFailedError:()=>new D,UnspecifiedBadStatus:I.j,InternalServerError:I.j,InvalidRequest:I.j,RateLimited:I.j,ServiceUnavailable:I.j}))),(0,S.lk)((e=>(0,v.Vp)(e.data.authTicket)))))}async performTotpVerification(e,t){return await(0,y.z)(this.serverApiClient.v1.authentication.performTotpVerification({login:e,otp:t}).pipe((0,S.DZ)((e=>(0,f.EQ)(e,{BusinessError:e=>{switch(e.code){case r.VERIFICATION_FAILED:return new E;case r.INVALID_OTP_ALREADY_USED:return new T;case r.INVALID_OTP_BLOCKED:return new O;default:(0,w.U)(e.code)}},FetchFailedError:()=>new D,UnspecifiedBadStatus:I.j,InternalServerError:I.j,InvalidRequest:I.j,RateLimited:I.j,ServiceUnavailable:I.j}))),(0,S.lk)((e=>(0,v.Vp)(e.data.authTicket)))))}async performDashlaneAuthenticatorValidation(e,t){return await(0,y.z)(this.serverApiClient.v1.authentication.performDashlaneAuthenticatorVerification({login:e,deviceName:t}).pipe((0,S.DZ)((e=>(0,f.EQ)(e,{BusinessError:e=>{switch(e.code){case r.VERIFICATION_FAILED:return new E;case r.VERIFICATION_TIMEOUT:return new C;default:(0,w.U)(e.code)}},FetchFailedError:()=>new D,UnspecifiedBadStatus:I.j,InternalServerError:I.j,InvalidRequest:I.j,RateLimited:I.j,ServiceUnavailable:I.j}))),(0,S.lk)((e=>(0,v.Vp)(e.data.authTicket)))))}async askServerToSendToken(e){return await(0,y.z)(this.serverApiClient.v1.authentication.requestEmailTokenVerification({login:e}).pipe((0,S.DZ)((e=>{throw e})),(0,S.lk)((()=>(0,v.Vp)(void 0)))))}};U=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[_.l])],U);let F=class{constructor(e){this.identityVerificationService=e,this.identityVerificationService=e}async execute({login:e}){if(e){const t=await this.identityVerificationService.askServerToSendToken(e);if((0,v.hx)(t))return Promise.reject(t.error)}Promise.resolve(void 0)}};F=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[U])],F);var P=s(13800);let x=class extends P.f{};x=(0,c.__decorate)([(0,h.GS)()],x);let N=class{constructor(e,t){this.identityVerificationService=e,this.eventEmitter=t}mapFunctionalErrorToErrorCode(e){switch(e.tag){case r.VERIFICATION_FAILED:return o.DASHLANE_AUTHENTICATOR_PUSH_NOTIFICATION_DENIED;case r.VERIFICATION_TIMEOUT:return o.TOKEN_EXPIRED;default:return n.UNKNOWN_ERROR}}async execute({login:e}){if(!e)throw new Error("Something went wrong");const t=await this.identityVerificationService.performDashlaneAuthenticatorValidation(e,"");if((0,v.hx)(t)){const e=this.mapFunctionalErrorToErrorCode(t.error);return Promise.reject(e)}return this.eventEmitter.sendEvent("identityVerificationCompleted",{authTicket:t.data}),Promise.resolve()}};N=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[U,x])],N);let G=class{constructor(e,t){this.dashlaneAuthenticatorService=e,this.sendEmailToken=t}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"AuthenticatorMachine",context:{isDashlaneAuthenticatorAvailable:!1},initial:"RequestingServerPush",states:{RequestingServerPush:{entry:["updateDashlaneAuthenticatorAvailability"],invoke:{src:"authenticateWithDashlaneAuthenticator",onDone:{target:"AuthenticatorPushValidated"},onError:{actions:["assignError","updateDashlaneAuthenticatorAvailability"]}},on:{RESEND_PUSH_NOTIFICATION:{target:"RequestingServerPush",actions:["clearError"]},SWITCH_TO_EMAIL_TOKEN:{actions:["clearError"],target:"EmailTokenRequested"}}},AuthenticatorPushValidated:{type:"final",data:{switchToEmailToken:!1}},EmailTokenRequested:{entry:["sendEmailToken"],type:"final",data:{switchToEmailToken:!0}}}},options:{actions:{clearError:(0,m.f0)({error:()=>{}}),assignError:(0,m.f0)({error:(e,t)=>t.data}),switchToEmailToken:(0,m.f0)({switchToEmailToken:()=>!0}),updateDashlaneAuthenticatorAvailability:(0,m.f0)({isDashlaneAuthenticatorAvailable:!0}),sendEmailToken:e=>{const{login:t}=e;this.sendEmailToken.execute({login:t})}},services:{authenticateWithDashlaneAuthenticator:e=>{const{login:t}=e;return this.dashlaneAuthenticatorService.execute({login:t})}},guards:{}}}}create(){const{config:e,options:t}=this.desc();return(0,g.C)(e,t)}};G=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[N,F])],G);const k=/^\d{6}$/;let L=class{constructor(e,t){this.identityVerificationService=e,this.eventEmitter=t}mapFunctionalErrorToErrorCode(e){switch(e.tag){case r.VERIFICATION_FAILED:return i.TOKEN_NOT_VALID;case r.VERIFICATION_TIMEOUT:return i.TOKEN_EXPIRED;case r.VERIFICATION_REQUIRES_REQUEST:return i.TOKEN_TOO_MANY_ATTEMPTS;case r.ACCOUNT_BLOCKED_CONTACT_SUPPORT:return i.TOKEN_ACCOUNT_LOCKED;default:return n.UNKNOWN_ERROR}}async executeWithParams(e){if(!e.login||!e.emailToken||0===e.emailToken.length||!k.test(e.emailToken))return Promise.reject(n.UNKNOWN_ERROR);const t=await this.identityVerificationService.performEmailTokenVerification(e.login,e.emailToken);if((0,v.hx)(t)){const e=this.mapFunctionalErrorToErrorCode(t.error);return Promise.reject(e)}const s=t.data;return this.eventEmitter.sendEvent("identityVerificationCompleted",{authTicket:s}),Promise.resolve()}};L=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[U,x])],L);let M=class{constructor(e,t){this.authenticateWithEmailToken=e,this.sendEmailToken=t}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"EmailTokenMachine",context:{login:"",emailToken:"",deviceName:""},initial:"SendEmailToken",states:{SendEmailToken:{invoke:{src:"sendEmailToken",onError:{target:"WaitingForEmailToken"},onDone:{target:"WaitingForEmailToken"}}},WaitingForEmailToken:{on:{INPUT_EMAIL_TOKEN:{target:"ValidatingEmailToken",actions:["assignEmailToken"]},RESEND_EMAIL_TOKEN:{target:"SendEmailToken",actions:["clearError"]}}},ValidatingEmailToken:{invoke:{src:"authenticateWithEmailToken",onDone:{target:"FinishingEmailToken"},onError:{target:"WaitingForEmailToken",actions:["assignError"]}}},FinishingEmailToken:{type:"final",data:{switchToDashlaneAuthenticator:!1}},DashlaneAuthenticatorRequested:{type:"final",data:{switchToDashlaneAuthenticator:!0}}},on:{SWITCH_TO_DASHLANE_AUTHENTICATOR:{target:".DashlaneAuthenticatorRequested",internal:!0,actions:["clearError"]}}},options:{actions:{assignError:(0,m.f0)({error:(e,t)=>t.data}),clearError:(0,m.f0)({error:()=>{}}),assignEmailToken:(0,m.f0)({emailToken:(e,t)=>t.emailToken})},services:{sendEmailToken:e=>{const{login:t}=e;return this.sendEmailToken.execute({login:t})},authenticateWithEmailToken:e=>{const{deviceName:t,emailToken:s,login:r}=e;return this.authenticateWithEmailToken.executeWithParams({deviceName:t,emailToken:s,login:r})}},guards:{}}}}create(){const{config:e,options:t}=this.desc();return(0,g.C)(e,t)}};M=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[L,F])],M);const K=e=>({initial:e.initial,states:e.states,on:e.on??{}});let j=class{constructor(e,t){this.authenticatorMachine=e,this.emailTokenMachine=t}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{},guards:{}},id:"DeviceRegistrationMachine",context:{...this.authenticatorMachine.desc().config.context,...this.emailTokenMachine.desc().config.context,registrationMethod:void 0},initial:"StartDeviceRegistration",states:{StartDeviceRegistration:{always:[{target:"EmailToken",cond:"isRegistrationMethodEmailToken"},{target:"DashlaneAuthenticator",cond:"isRegistrationMethodAuthenticator"},{target:"TwoFactorAuthentication",cond:"isRegistrationMethodOTP"}]},DashlaneAuthenticator:{...K(this.authenticatorMachine.desc().config),onDone:[{target:"EmailToken",cond:"shouldSwitchToEmailToken"},{target:"DeviceRegistrationDone"}]},EmailToken:{...K(this.emailTokenMachine.desc().config),onDone:[{target:"DashlaneAuthenticator",cond:"shouldSwitchToAuthenticator"},{target:"DeviceRegistrationDone"}]},TwoFactorAuthentication:{onDone:{target:"DeviceRegistrationDone"}},DeviceRegistrationDone:{type:"final"}}},options:{actions:{...this.authenticatorMachine.desc().options.actions,...this.emailTokenMachine.desc().options.actions,assignUnknownDeviceRegistrationError:(0,m.f0)({error:()=>({code:"unknown_error",data:{message:"Unknown device registration error"}})})},services:{...this.authenticatorMachine.desc().options.services,...this.emailTokenMachine.desc().options.services},guards:{...this.authenticatorMachine.desc().options.guards,...this.emailTokenMachine.desc().options.guards,isRegistrationMethodEmailToken:e=>"email_token"===e.registrationMethod,isRegistrationMethodOTP:e=>"otp"===e.registrationMethod,isRegistrationMethodAuthenticator:e=>"dashlane_authenticator"===e.registrationMethod,shouldSwitchToEmailToken:(e,t)=>t.data.switchToEmailToken,shouldSwitchToAuthenticator:(e,t)=>t.data.switchToDashlaneAuthenticator}}}}create(){const{config:e,options:t}=this.desc();return(0,g.C)(e,t)}};j=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[G,M])],j);var V=s(62149),z=s(63144);const W=e=>!0;class q extends((0,z.Q)({initialValue:void 0,persist:!1,scope:V.F.Device,storeName:"device-registration-flow-store",storeTypeGuard:W})){}let B=class{constructor(e,t){this.identityVerificationService=e,this.eventEmitter=t}mapFunctionalErrorToErrorCode(e){switch(e.tag){case r.VERIFICATION_FAILED:return a.OTP_NOT_VALID;case r.INVALID_OTP_ALREADY_USED:return a.OTP_ALREADY_USED;case r.INVALID_OTP_BLOCKED:return a.OTP_TOO_MANY_ATTEMPTS;default:return n.UNKNOWN_ERROR}}async executeWithParams(e){if(!e.login||!e.otp||0===e.otp.length||"totp"===e.twoFactorAuthenticationOtpType&&!k.test(e.otp))return Promise.reject(n.UNKNOWN_ERROR);const t=await this.identityVerificationService.performTotpVerification(e.login,e.otp);if((0,v.hx)(t)){const e=this.mapFunctionalErrorToErrorCode(t.error);return Promise.reject(e)}return this.eventEmitter.sendEvent("identityVerificationCompleted",{authTicket:t.data}),Promise.resolve()}};B=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[U,x])],B);let $=class{constructor(e){this.twoFactorAuthenticationService=e}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},id:"TwoFactorAuthenticationMachine",context:{twoFactorAuthenticationOtpType:"totp"},initial:"WaitingForTotp",states:{WaitingForTotp:{on:{INPUT_TOTP:{target:"ValidatingTwoFactorAuthenticationOtp",actions:["assignTwoFactorAuthenticationOtpValue"]},SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE:{target:"WaitingForBackupCode",actions:["assignTwoFactorAuthenticationOtpType","clearError"]}}},WaitingForBackupCode:{on:{INPUT_BACKUP_CODE:{target:"ValidatingTwoFactorAuthenticationOtp",actions:["assignTwoFactorAuthenticationOtpValue"]},SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE:{target:"WaitingForTotp",actions:["assignTwoFactorAuthenticationOtpType","clearError"]}}},ValidatingTwoFactorAuthenticationOtp:{invoke:{src:"authenticateWithTwoFactorAuthentication",onDone:{target:"TwoFactorAuthenticationDone"},onError:[{target:"WaitingForBackupCode",cond:"isBackupCode",actions:["assignError"]},{target:"WaitingForTotp",actions:["assignError"]}]}},TwoFactorAuthenticationDone:{type:"final"}}},options:{actions:{assignError:(0,m.f0)({error:(e,t)=>t.data}),clearError:(0,m.f0)({error:()=>{}}),assignTwoFactorAuthenticationOtpValue:(0,m.f0)({twoFactorAuthenticationOtpValue:(e,t)=>t.twoFactorAuthenticationOtpValue}),assignTwoFactorAuthenticationOtpType:(0,m.f0)({twoFactorAuthenticationOtpType:(e,t)=>t.twoFactorAuthenticationOtpType})},services:{authenticateWithTwoFactorAuthentication:e=>{const t={login:e.login??"",masterPassword:e.masterPassword??null,otp:e.twoFactorAuthenticationOtpValue,twoFactorAuthenticationOtpType:e.twoFactorAuthenticationOtpType,persistData:!0,otpVerificationMode:e.otpVerificationMode,deviceName:e.deviceName};return this.twoFactorAuthenticationService.executeWithParams(t)}},guards:{isBackupCode:e=>"backupCode"===e.twoFactorAuthenticationOtpType}}}}create(){const{config:e,options:t}=this.desc();return(0,g.C)(e,t)}};$=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[B])],$);let Y=class{constructor(e,t){this.deviceRegistrationMachine=e,this.twoFactorAuthenticationMachine=t}desc(){return{config:{predictableActionArguments:!0,schema:{events:{},context:{}},initial:"Starting",id:"IdentityVerificationFlowMachine",context:{...this.deviceRegistrationMachine.desc().config.context,...this.twoFactorAuthenticationMachine.desc().config.context,ready:!1,shouldAskOTP:!1},states:{Starting:{entry:["assignInitializationResults"]},DeviceRegistration:{...K(this.deviceRegistrationMachine.desc().config)},TwoFactorAuthentication:{...K(this.twoFactorAuthenticationMachine.desc().config),onDone:{target:"AuthenticationDone"}},AuthenticationDone:{type:"final"}},on:{VERIFY_IDENTITY_WITH_TOKEN:{target:"DeviceRegistration.EmailToken",actions:["assignAccountEmail"]},VERIFY_IDENTITY_WITH_DASHLANE_AUTHENTICATOR:{target:"DeviceRegistration.DashlaneAuthenticator",actions:["assignAccountEmail"]},VERIFY_IDENTITY_WITH_TOTP:{target:"TwoFactorAuthentication",actions:["assignAccountEmail"]},CANCEL_IDENTITY_VERIFICATION:{target:"Starting",actions:["clearContext"]},CLEAR_ERROR:{actions:["clearError"]}}},options:{actions:{...this.deviceRegistrationMachine.desc().options.actions,...this.twoFactorAuthenticationMachine.desc().options.actions,assignInitializationResults:(0,m.f0)({ready:()=>!0}),assignAccountEmail:(0,m.f0)({login:(e,t)=>t.login}),clearContext:(0,m.f0)({login:()=>"",shouldAskOTP:()=>!1,twoFactorAuthenticationOtpType:()=>"totp",registrationMethod:()=>{},emailToken:()=>"",deviceName:()=>"",isDashlaneAuthenticatorAvailable:()=>!1}),clearError:(0,m.f0)({error:()=>{}})},services:{...this.deviceRegistrationMachine.desc().options.services,...this.twoFactorAuthenticationMachine.desc().options.services},guards:{...this.deviceRegistrationMachine.desc().options.guards,...this.twoFactorAuthenticationMachine.desc().options.guards,isGrapheneDeviceRegistrationFlow:e=>!!e.login&&e.login.includes("kw_test_newdevice")}}}}create(){const{config:e,options:t}=this.desc();return(0,g.C)(e,t)}};Y=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[j,$])],Y);var Q=s(85390),H=s(41842),J=s(6136),Z=s(46449),X=s(41025),ee=s(69885),te=s(6220);const se=e=>({step:"EmailTokenStep",isLoading:e.matches({DeviceRegistration:{EmailToken:"ValidatingEmailToken"}})&&!e.context.error,error:e.context.error,emailToken:e.context.emailToken,isDashlaneAuthenticatorAvailable:e.context.isDashlaneAuthenticatorAvailable}),re=e=>({step:"DashlaneAuthenticatorStep",isLoading:e.matches({DeviceRegistration:{DashlaneAuthenticator:"RequestingServerPush"}})&&!e.context.error,error:e.context.error}),ie=e=>({step:"TwoFactorAuthenticationOtpStep",isLoading:e.matches({TwoFactorAuthentication:"ValidatingTwoFactorAuthenticationOtp"})&&!e.context.error,error:e.context.error,twoFactorAuthenticationOtpValue:e.context.twoFactorAuthenticationOtpValue,twoFactorAuthenticationOtpType:e.context.twoFactorAuthenticationOtpType});const ae=e=>(0,ee.of)((0,v.Vp)(function(e){return e.matches("Starting")?{step:"StartingStep"}:e.matches({DeviceRegistration:{EmailToken:"SendEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"WaitingForEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"ValidatingEmailToken"}})||e.matches({DeviceRegistration:{EmailToken:"FinishingEmailToken"}})?se(e):e.matches({DeviceRegistration:{DashlaneAuthenticator:"RequestingServerPush"}})||e.matches({DeviceRegistration:{DashlaneAuthenticator:"AuthenticatorPushFailed"}})||e.matches({DeviceRegistration:{DashlaneAuthenticator:"AuthenticatorPushValidated"}})?re(e):e.matches({TwoFactorAuthentication:"WaitingForTotp"})||e.matches({TwoFactorAuthentication:"WaitingForBackupCode"})||e.matches({TwoFactorAuthentication:"ValidatingTwoFactorAuthenticationOtp"})||e.matches({TwoFactorAuthentication:"FinishingTwoFactorAuthenticationOtp"})?ie(e):void console.warn("[Auth Ticket] - No view associated to state ",JSON.stringify(e.value))}(e))),oe=e=>e.pipe((0,te.z)(ae));var ne=s(8362),ce=s(87065);const de=e=>!0;class le extends((0,z.Q)({initialValue:void 0,persist:!1,scope:V.F.Device,storeName:"identity-verification-flow-machine",storeTypeGuard:de})){}var ue=s(30045);var pe=s(24966),he=s(78065),me=s(20916);let ge=class{constructor(e,t){this.identityVerificationMachineStore=t,this.initFlag=new pe.X(!1);const s=e.create();this.delayedEvents=[],this.interpreter=he.kJ(s).onTransition((async e=>{e.changed||"xstate.init"===e.event.type||console.warn(`[Auth Ticket] State is unchanged. Unexpected transition on ${JSON.stringify(e.value)} with event ${e.event.type} `);try{const e=this.interpreter?.getSnapshot();e&&await(async(e,t)=>{await e.set(JSON.stringify(t))})(this.identityVerificationMachineStore,e)}catch(e){console.warn("[Auth Ticket] Unable to get snapshot",e)}}))}async prepare(){if(this.interpreter)try{const e=await(async e=>{const t=await e.getState();return t?ne.ZM.create(JSON.parse(t)):void 0})(this.identityVerificationMachineStore);let t;try{t=this.interpreter.start(e)}catch(e){console.error("[Auth Ticket] Unable to reuse the stored state: ",e),t=this.interpreter.start()}await(0,me.x)(t,(e=>e.context.ready)),this.interpreter.send(this.delayedEvents),this.delayedEvents=[],this.initFlag.next(!0)}catch(e){console.error("[Auth Ticket] Unable to start machine",e)}}ready(){return this.initFlag}continue(e){if(!this.interpreter)throw new Error("Authentication flow not started");this.interpreter.getSnapshot().context.ready?this.interpreter.send(e):this.delayedEvents.push(e)}stop(){this.isStarted()&&(this.interpreter=void 0)}isStarted(){return Boolean(this.interpreter)}};ge=(0,c.__decorate)([(0,h.GS)(),(0,c.__metadata)("design:paramtypes",[Y,le])],ge);let ve=class{constructor(e,t){this.identityVerificationFlow=e,this.identityVerificationMachineStore=t}execute(){return(0,Q.a)([(e=this.identityVerificationMachineStore,e.state$.pipe((0,ce.U)((e=>e?ne.ZM.create(JSON.parse(e)):void 0)))),this.identityVerificationFlow.ready()],((e,t)=>{if(e&&t)return e})).pipe((0,H.h)(Boolean),(0,J.x)(((e,t)=>((e,t)=>{const s=t.matches(e.value),r=(0,ue.Z)(e.context,t.context);return s&&r})(e,t))),oe);var e}};ve=(0,c.__decorate)([(0,Z.e)(X.O),(0,c.__metadata)("design:paramtypes",[ge,le])],ve);var ye=s(82874),_e=s(13744);let Se=class{constructor(e){this.identityVerificationFlow=e}execute(e){const{twoFactorAuthenticationOtpType:t}=e.body;return this.identityVerificationFlow.continue({type:"SWITCH_TWO_FACTOR_AUTHENTICATION_TYPE",twoFactorAuthenticationOtpType:t}),Promise.resolve((0,v.Vp)(void 0))}};Se=(0,c.__decorate)([(0,ye.W)(_e.eG),(0,c.__metadata)("design:paramtypes",[ge])],Se);let fe=class{constructor(e){this.identityVerificationFlow=e}execute(){return this.identityVerificationFlow.continue({type:"CLEAR_ERROR"}),Promise.resolve((0,v.Vp)(void 0))}};fe=(0,c.__decorate)([(0,ye.W)(_e.$5),(0,c.__metadata)("design:paramtypes",[ge])],fe);let we=class{constructor(e){this.identityVerificationFlow=e}execute(){return this.identityVerificationFlow.continue({type:"RESEND_EMAIL_TOKEN"}),Promise.resolve((0,v.Vp)(void 0))}};we=(0,c.__decorate)([(0,ye.W)(_e.Gc),(0,c.__metadata)("design:paramtypes",[ge])],we);let Ie=class{constructor(e){this.identityVerificationFlow=e}execute(){return this.identityVerificationFlow.continue({type:"RESEND_PUSH_NOTIFICATION"}),Promise.resolve((0,v.Vp)(void 0))}};Ie=(0,c.__decorate)([(0,ye.W)(_e.rF),(0,c.__metadata)("design:paramtypes",[ge])],Ie);let be=class{constructor(e){this.identityVerificationFlow=e}execute(e){const{twoFactorAuthenticationOtpValue:t}=e.body;return this.identityVerificationFlow.continue({type:"INPUT_BACKUP_CODE",twoFactorAuthenticationOtpValue:t}),Promise.resolve((0,v.Vp)(void 0))}};be=(0,c.__decorate)([(0,ye.W)(_e.sH),(0,c.__metadata)("design:paramtypes",[ge])],be);let Ee=class{constructor(e){this.identityVerificationFlow=e}execute(e){const{emailToken:t,deviceName:s}=e.body;return this.identityVerificationFlow.continue({type:"INPUT_EMAIL_TOKEN",emailToken:t,deviceName:s}),Promise.resolve((0,v.Vp)(void 0))}};Ee=(0,c.__decorate)([(0,ye.W)(_e.XH),(0,c.__metadata)("design:paramtypes",[ge])],Ee);let Ce=class{constructor(e){this.identityVerificationFlow=e}execute(e){const{twoFactorAuthenticationOtpValue:t}=e.body;return this.identityVerificationFlow.continue({type:"INPUT_TOTP",twoFactorAuthenticationOtpValue:t}),Promise.resolve((0,v.Vp)(void 0))}};Ce=(0,c.__decorate)([(0,ye.W)(_e.ad),(0,c.__metadata)("design:paramtypes",[ge])],Ce);let Ae=class{constructor(e){this.identityVerificationFlow=e}execute(){return this.identityVerificationFlow.continue({type:"SWITCH_TO_DASHLANE_AUTHENTICATOR"}),Promise.resolve((0,v.Vp)(void 0))}};Ae=(0,c.__decorate)([(0,ye.W)(_e.K1),(0,c.__metadata)("design:paramtypes",[ge])],Ae);let Re=class{constructor(e){this.identityVerificationFlow=e}execute(){return this.identityVerificationFlow.continue({type:"SWITCH_TO_EMAIL_TOKEN"}),Promise.resolve((0,v.Vp)(void 0))}};Re=(0,c.__decorate)([(0,ye.W)(_e.v5),(0,c.__metadata)("design:paramtypes",[ge])],Re);let Te=class{constructor(e){this.identityVerificationFlow=e}execute(e){const{login:t,verificationMethod:s}=e.body;switch(s){case"email_token":this.identityVerificationFlow.continue({type:"VERIFY_IDENTITY_WITH_TOKEN",login:t});break;case"totp":this.identityVerificationFlow.continue({type:"VERIFY_IDENTITY_WITH_TOTP",login:t});break;case"dashlane_authenticator":this.identityVerificationFlow.continue({type:"VERIFY_IDENTITY_WITH_DASHLANE_AUTHENTICATOR",login:t})}return Promise.resolve((0,v.Vp)(void 0))}};Te=(0,c.__decorate)([(0,ye.W)(_e.qw),(0,c.__metadata)("design:paramtypes",[ge])],Te);let Oe=class{constructor(e){this.identityVerificationFlow=e}execute(){return this.identityVerificationFlow.continue({type:"CANCEL_IDENTITY_VERIFICATION"}),Promise.resolve((0,v.Vp)(void 0))}};Oe=(0,c.__decorate)([(0,ye.W)(_e.Vs),(0,c.__metadata)("design:paramtypes",[ge])],Oe);let De=class{};De=(0,c.__decorate)([(0,d.Yl)({api:p.i,handlers:{commands:{changeTwoFactorAuthenticationOtpType:Se,clearError:fe,resendEmailToken:we,resendPushNotification:Ie,submitBackupCode:be,submitEmailToken:Ee,submitTotp:Ce,switchToDashlaneAuthenticator:Ae,switchToEmailToken:Re,startIdentityVerification:Te,cancelIdentityVerification:Oe},events:{},queries:{identityVerificationFlowStatus:ve}},providers:[j,G,N,M,$,...(0,l.H)(ge,{inject:[Y,le],asyncFactory:async(e,t)=>{const s=new ge(e,t);return await s.prepare(),s}}),Y,L,B,F,U,x],imports:[u.n],exports:[ge],stores:[le,q]})],De)},51442:(e,t,s)=>{s.d(t,{N:()=>de});var r=s(491),i=s(86006),a=s(89033),o=s(16624),n=s(41511),c=s(85035),d=s(82874),l=s(87279),u=s(34975),p=s(14122),h=s(92587),m=s(50423),g=s(36041),v=s(81929),y=s(53344),_=s(10370),S=s(7502),f=s(60198),w=s(18533),I=s(20195),b=s(95087),E=s(89358),C=s(87065),A=s(89618),R=s(25313),T=s(41842),O=s(85390),D=s(60399);let U=null;async function F(){if(!U){const{client:e}=await async function(){const{client:e,ready:t}=await Promise.all([s.e(642),s.e(633),s.e(877),s.e(495),s.e(373),s.e(139)]).then(s.bind(s,6504));return await t,{client:e}}();U=e}return U}var P=s(62149),x=s(63144),N=s(56618),G=s(7165),k=s(10722);const L=G.z.object({localAccounts:G.z.record(G.z.string(),G.z.object({salt:G.z.string(),encryptedSessionKey:G.z.string(),serverSessionKey:G.z.string(),attemptsLeft:G.z.number()}))}),M=e=>L.safeParse(e).success;class K extends((0,x.Q)({persist:!0,storage:{initialValue:{localAccounts:{}},schemaVersion:1,typeGuard:M,migrateStorageSchema:()=>({localAccounts:{}})},codec:k.E,scope:P.F.Device,storeName:"pincode",capacity:N.Y._001KB})){}var j=s(92402),V=s(85603),z=s(94805),W=s(16698);let q=class{constructor(e,t){this.flexibleEncryptor=e,this.flexibleDecryptor=t}async encryptSessionKeyWithPinKey(e,t){return await this.flexibleEncryptor.encrypt(t,e,z.oo,W.gO)}async decryptSessionKeyWithPinKey(e,t){return await this.flexibleDecryptor.decrypt(t,e)}};q=(0,r.__decorate)([(0,h.GS)(),(0,r.__metadata)("design:paramtypes",[j._,V.a])],q);var B=s(7531),$=s(23337);let Y=class extends B.K{constructor(e,t){super(`/assets/pin-code.${"https://api.dashlane.com"===t.baseUrl?"prod":"staging"}.config.json`,e)}loadResource(e){if(!((t=e)&&"object"==typeof t&&"serverIdentifier"in t&&"serverPublicKey"in t))throw new Error("File corrupted");var t;return e}};Y=(0,r.__decorate)([(0,h.GS)(),(0,r.__metadata)("design:paramtypes",[$.X,y.l])],Y);let Q=class{constructor(e,t,s,r,i,a,o,n,c){this.pinCodeStore=e,this.session=t,this.keyGenerator=s,this.hmacSigner=r,this.sessionKeyCrypto=i,this.serverApi=a,this.allowToFail=o,this.carbonClient=n,this.pinCodeServerConfigResourceLoader=c}getPinCodeStatus(e){return this.pinCodeStore.state$.pipe((0,C.U)((t=>{const s=e in t.localAccounts;return(0,l.Vp)(s?{isPinCodeEnabled:!0,attemptsLeft:t.localAccounts[e].attemptsLeft}:{isPinCodeEnabled:!1})})))}getCurrentUserPinCodeStatus(){const e=this.session.queries.selectedOpenedSession().pipe((0,A.V)({first:5e3,with:()=>(0,R._)((()=>new Error("No current active user")))}),(0,C.U)((e=>(0,l.d6)(e)&&e.data?e.data:"")),(0,T.h)((e=>!!e)));return(0,O.a)([e,this.pinCodeStore.state$]).pipe((0,C.U)((([e,t])=>{const s=e in t.localAccounts;return(0,l.Vp)(s?{isPinCodeEnabled:!0,attemptsLeft:t.localAccounts[e].attemptsLeft}:{isPinCodeEnabled:!1})})))}async activatePinCode(e){const t=await this.getCurrentUserEmail(),s=await(0,D.z)(this.carbonClient.queries.carbonState({path:"state.authentication.currentUser.rememberMeType"}));(0,l.d6)(s)&&"autologin"===s.data&&await this.carbonClient.commands.disableAutologin();const r=await this.pinCodeStore.getState(),i=await this.getExportedSessionKey(),a=(0,_.s)(await this.keyGenerator.generate()),o=await F(),n=(0,_.s)(await this.hmacSigner.sign((0,S.R)(a),(new TextEncoder).encode(e))),{clientRegistrationState:c,registrationRequest:d}=o.startRegistration({password:n}),u=await(0,D.z)(this.serverApi.v1.authentication.pincodeRequestActivation({activationRequest:d})),p=(0,w.EQ)(u,{success:e=>e.data.data.activationResponse,failure:e=>(0,w.EQ)(e.error,{BusinessError:e=>{switch(e.code){case"FAILED_TO_PROCESS_ACTIVATION_REQUEST":case"SSO_USER_NOT_ALLOWED":return(0,I.j)(e.code);default:(0,b.U)(e)}},FetchFailedError:I.j,InternalServerError:I.j,InvalidRequest:I.j,RateLimited:I.j,ServiceUnavailable:I.j,UnspecifiedBadStatus:I.j})}),h=await this.pinCodeServerConfigResourceLoader.get(),{registrationRecord:m,exportKey:g,serverStaticPublicKey:v}=o.finishRegistration({clientRegistrationState:c,registrationResponse:p,password:n,identifiers:{client:t,server:h.serverIdentifier}});if(v!==h.serverPublicKey)throw new Error("OPAQUEs serverStaticPublicKey does not match api configs.");const y=await(0,D.z)(this.serverApi.v1.authentication.pincodeCompleteActivation({pinCodeRecord:m})),E=(0,w.EQ)(y,{success:e=>e.data.data.sessionKey,failure:e=>(0,w.EQ)(e.error,{BusinessError:e=>{switch(e.code){case"ACTIVATION_REQUEST_NOT_FOUND":case"EMPTY_PIN_CODE_RECORD":return(0,I.j)(e.code);default:(0,b.U)(e)}},FetchFailedError:I.j,InternalServerError:I.j,InvalidRequest:I.j,RateLimited:I.j,ServiceUnavailable:I.j,UnspecifiedBadStatus:I.j})}),C=(0,f.N)(g),A=await this.sessionKeyCrypto.encryptSessionKeyWithPinKey(i,C);await this.pinCodeStore.set({...r,localAccounts:{...r.localAccounts,[t]:{...r.localAccounts[t],serverSessionKey:E,salt:a,encryptedSessionKey:(0,_.s)(A),attemptsLeft:3}}})}async removePinCodeFromStore(e){const t=await this.pinCodeStore.getState();delete t.localAccounts[e],await this.pinCodeStore.set(t)}async deactivatePinCode(){const e=await this.getCurrentUserEmail();e in(await this.pinCodeStore.getState()).localAccounts&&(await this.removePinCodeFromStore(e),await this.allowToFail.doOne((async()=>await(0,D.z)(this.serverApi.v1.authentication.pincodeDisable({}))),{methodName:"Deactivate pin code"}))}async computePinKey(e,t){const s=await this.pinCodeStore.getState();if(!(t in s.localAccounts))return(0,l.Rn)((0,u.Zs)());const{serverSessionKey:r,salt:i}=s.localAccounts[t],a=(0,_.s)(await this.hmacSigner.sign((0,S.R)(i),(new TextEncoder).encode(e))),o=await F(),{clientLoginState:n,startLoginRequest:c}=o.startLogin({password:a}),d=await(0,D.z)(this.serverApi.v1.authentication.pincodeRequestLogin({loginRequest:c,sessionKey:r})),p=(0,w.EQ)(d,{success:e=>(0,l.Vp)(e.data.data),failure:e=>(0,w.EQ)(e.error,{BusinessError:e=>{switch(e.code){case"INVALID_SESSION_KEY":case"NO_PIN_CODE_ACTIVATED":case"FAILED_TO_PROCESS_LOGIN_REQUEST":case"MAX_ATTEMPTS_REACHED":return(0,l.Rn)((0,u.Zs)());default:(0,b.U)(e)}},FetchFailedError:I.j,InternalServerError:I.j,InvalidRequest:I.j,RateLimited:I.j,ServiceUnavailable:I.j,UnspecifiedBadStatus:I.j})});if(!(0,l.d6)(p))return await this.removePinCodeFromStore(t),p;const{loginResponse:h,attemptsLeft:m}=p.data,g=await this.pinCodeStore.getState();await this.pinCodeStore.set({...g,localAccounts:{...g.localAccounts,[t]:{...g.localAccounts[t],attemptsLeft:m}}});const v=await this.pinCodeServerConfigResourceLoader.get(),y=o.finishLogin({clientLoginState:n,loginResponse:h,password:a,identifiers:{client:t,server:v.serverIdentifier}});if(!y)return 0===m&&await this.removePinCodeFromStore(t),(0,l.Rn)((0,u.g5)());if(y.serverStaticPublicKey!==v.serverPublicKey)throw new Error("OPAQUEs serverStaticPublicKey does not match api configs.");const{exportKey:E,finishLoginRequest:C}=y;return await this.allowToFail.doOne((async()=>await(0,D.z)(this.serverApi.v1.authentication.pincodeCompleteLogin({sessionKey:r,completeLoginRequest:C}))),{methodName:"Complete login with pin code"}),(0,l.Vp)((0,f.N)(E))}async loginWithPinCode(e,t){const s=await this.pinCodeStore.getState();if(!(e in s.localAccounts))return(0,l.Rn)((0,u.Zs)());const{encryptedSessionKey:r}=s.localAccounts[e],i=await this.computePinKey(t,e);if(!(0,l.d6)(i))return i;const a=i.data,o=await this.sessionKeyCrypto.decryptSessionKeyWithPinKey((0,S.R)(r),a),n=await this.session.commands.openUserSession({email:e,rememberPassword:!1,sessionKey:{type:"exported",content:(0,_.s)(o)}});if(!(0,l.d6)(n))throw new Error("Failed to open the session");return(0,l.Vp)(void 0)}async validatePinCode(e,t){return(0,w.EQ)(await this.computePinKey(e,t),{success:()=>(0,l.Vp)({isPinCodeCorrect:!0}),failure:e=>(0,w.EQ)(e.error,{NO_ACTIVE_PIN_CODE:I.j,WRONG_PIN_CODE:async()=>{const e=await(0,D.z)(this.getCurrentUserPinCodeStatus());return(0,l.ho)(e).isPinCodeEnabled||await this.session.commands.closeUserSession({email:t}),(0,l.Vp)({isPinCodeCorrect:!1})}})})}async getCurrentUserEmail(){const e=await(0,D.z)(this.session.queries.selectedOpenedSession());if(!(0,l.d6)(e)||!e.data)throw new Error("No current session was found");return e.data}async getExportedSessionKey(){const e=await(0,D.z)(this.session.queries.exportSessionKey());if(!(0,l.d6)(e))throw new Error("Failed to export session key");return(0,S.R)(e.data.content)}};Q=(0,r.__decorate)([(0,h.GS)(),(0,r.__metadata)("design:paramtypes",[K,E.x,g.c,v.q,q,y.l,m.J,p._,Y])],Q);let H=class{constructor(e){this.pinCodeService=e}async execute({body:e}){return await this.pinCodeService.activatePinCode(e.pinCode),(0,l.Vp)(void 0)}};H=(0,r.__decorate)([(0,d.W)(c.r),(0,r.__metadata)("design:paramtypes",[Q])],H);var J=s(44878);let Z=class{constructor(e){this.pinCodeService=e}async execute(){return await this.pinCodeService.deactivatePinCode(),(0,l.Vp)(void 0)}};Z=(0,r.__decorate)([(0,d.W)(J.E),(0,r.__metadata)("design:paramtypes",[Q])],Z);var X=s(73675);let ee=class{constructor(e){this.pinCodeService=e}async execute({body:e}){return await this.pinCodeService.loginWithPinCode(e.email,e.pinCode)}};ee=(0,r.__decorate)([(0,d.W)(X.c),(0,r.__metadata)("design:paramtypes",[Q])],ee);var te=s(35941),se=s(46449);let re=class{constructor(e){this.pinCodeService=e}execute(e){return this.pinCodeService.getPinCodeStatus(e.body.loginEmail)}};re=(0,r.__decorate)([(0,se.e)(te.D),(0,r.__metadata)("design:paramtypes",[Q])],re);var ie=s(66861),ae=s(43978);let oe=class{constructor(e,t){this.pinCodeService=e,this.session=t}execute(e){return this.session.queries.selectedOpenedSession().pipe((0,ae.w)((async t=>{if(!(0,l.d6)(t)||!t.data)throw new Error("No user logged in");return await this.pinCodeService.validatePinCode(e.body.pinCode,t.data)})))}};oe=(0,r.__decorate)([(0,se.e)(ie.M),(0,r.__metadata)("design:paramtypes",[Q,E.x])],oe);var ne=s(67160);let ce=class{constructor(e){this.pinCodeService=e}execute(){return this.pinCodeService.getCurrentUserPinCodeStatus()}};ce=(0,r.__decorate)([(0,se.e)(ne.o),(0,r.__metadata)("design:paramtypes",[Q])],ce);let de=class{};de=(0,r.__decorate)([(0,i.Yl)({api:a.n,stores:[K],imports:[o.D,n.n],handlers:{commands:{activate:H,deactivate:Z,loginWithPinCode:ee},events:{},queries:{isPinCodeCorrect:oe,getStatus:re,getCurrentUserStatus:ce}},providers:[Q,q,Y]})],de)},16930:(e,t,s)=>{s.d(t,{Z:()=>k});var r=s(491),i=s(69401),a=s(28760),o=s(86006),n=s(41511),c=s(13460),d=s(11088),l=s(82874),u=s(66610),p=s(87279),h=s(89358),m=s(60399),g=s(14122),v=s(92587),y=s(87065);let _=class{constructor(e){this.carbon=e}getSessionCredentialsForUser(e){const{queries:{carbonStateList:t}}=this.carbon;return(0,m.z)(t({paths:["authentication.currentUser.deviceKeys","userSession.localSettings.uki","userSession.account.login","userSession.session.sessionKeys"]}).pipe((0,y.U)((e=>{if((0,p.hx)(e))throw new Error("Failed to get credentials from carbon");return(0,p.db)(e)})),(0,y.U)(this.carbonStateToRequestUserSessionCredentials(e))))}carbonStateToRequestUserSessionCredentials(e){return([t,s,r,i])=>{if(!t&&!s||r!==e)throw new Error("No user device credentials available for active user");if(!i)throw new Error("No session credentials available for active user");let a;if(s){if("string"!=typeof s)throw new Error("Unexpected UKI state shape received from carbon");a=function(e){const t=e.split("-");if(t.length>0){const[s]=t;return{accessKey:s,secretKey:e}}throw new Error("Invalid UKI format")}(s)}else{if(!function(e){return!!(e&&"object"==typeof e&&"accessKey"in e&&"secretKey"in e)&&"string"==typeof e.accessKey&&"string"==typeof e.secretKey}(t))throw new Error("Unexpected user device state shape received from carbon");a=t}if(!function(e){return!!(e&&"object"==typeof e&&"accessKey"in e&&"secretKey"in e&&"expirationTimeSeconds"in e)&&"string"==typeof e.accessKey&&"string"==typeof e.secretKey&&"number"==typeof e.expirationTimeSeconds}(i))throw new Error("Unexpected session keys state shape received from carbon");return{login:e,deviceAccessKey:a.accessKey,sessionAccessKey:i.accessKey,sessionSecretKey:i.secretKey}}}};_=(0,r.__decorate)([(0,v.GS)(),(0,r.__metadata)("design:paramtypes",[g._])],_);let S=class{constructor(e,t,s){this.contextLessServerApiClient=e,this.rememberMeSessionKeysRepository=t,this.sessionClient=s}async execute(e){const t=await(0,m.z)(this.sessionClient.queries.selectedOpenedSession()),s=(0,p.d6)(t)?(0,p.db)(t):e.body.login;if(void 0===s)throw new Error("Logged out and no login specified");const{id:r,type:i,rawId:a,response:o}=e.body.assertion,n=await(0,m.z)(this.contextLessServerApiClient.v1.authentication.completeRememberMeOpenSession(await this.rememberMeSessionKeysRepository.getSessionCredentialsForUser(s),{authenticator:{authenticationType:"webauthn.get",credential:{type:i,id:r,rawId:a,response:o}}}));if((0,p.hx)(n))throw new Error(`Assertion could not be validated: ${n.error.name}`);return(0,p.Vp)(void 0)}};S=(0,r.__decorate)([(0,l.W)(d.L),(0,r.__metadata)("design:paramtypes",[u.B,_,h.x])],S);var f=s(61798),w=s(53344),I=s(18533),b=s(25535),E=s(20195),C=s(83853);function A(e){return()=>(0,p.Rn)({tag:e})}let R=class{constructor(e){this.server=e}async execute({body:{email:e}}){const t=await(0,m.z)(this.server.v1.authentication.requestOtpRecoveryCodesByPhone({login:e}));return(0,I.EQ)(t,{success:()=>(0,p.Vp)(void 0),failure:e=>(0,I.EQ)(e.error,{...f.J,FetchFailedError:A(C.A.NetworkError),BusinessError:e=>(0,b.G)(e.code,{INVALID_RECOVERY_PHONE:A(C.A.AccountNotEligible),SMS_ERROR:()=>(0,E.j)("Dashlane servers failed to send SMS"),SMS_OPT_OUT:A(C.A.AccountNotEligible),USER_NOT_FOUND:A(C.A.AccountNotEligible),WRONG_OTP_STATUS:A(C.A.AccountNotEligible)})})})}};R=(0,r.__decorate)([(0,l.W)(d.x),(0,r.__metadata)("design:paramtypes",[w.l])],R);var T=s(33370),O=s(42303),D=s(46449),U=s(43651),F=s(41842),P=s(43978),x=s(69885),N=s(85390);let G=class{constructor(e,t,s){this.pin=e,this.carbon=t,this.featureFlips=s}execute(){const e=this.carbon.queries.liveWebAuthnAuthenticationOptedIn(void 0).pipe((0,F.h)(p.d6),(0,y.U)((e=>e.data))),t=this.carbon.queries.liveIsSSOUser(void 0).pipe((0,F.h)(p.d6),(0,y.U)((e=>e.data))).pipe((0,P.w)((e=>e?(0,x.of)(!1):this.carbon.queries.getAccountAuthenticationType().pipe((0,F.h)(p.d6),(0,y.U)((e=>"masterPassword"===e.data)))))),s=this.pin.queries.getCurrentUserStatus().pipe((0,F.h)(p.d6),(0,y.U)((e=>e.data.isPinCodeEnabled))),{userFeatureFlips:r}=this.featureFlips.queries,i=r().pipe((0,y.U)((e=>{if((0,p.d6)(e)){return(0,p.db)(e)[a.T.PinCodePasskeyUVRelease]}throw new Error("Failed to get featureFlips")}))),o=(0,N.a)({isMpUser:t,isPinCodeEnabled:s,hasFeatureFlip:i}).pipe((0,y.U)((({isMpUser:e,isPinCodeEnabled:t,hasFeatureFlip:s})=>(0,p.Vp)(!e&&t&&s))),(0,F.h)(p.d6),(0,y.U)((e=>e.data)));return(0,N.a)({hasBiometrics:e,isPasswordlessUser:o,isMpUser:t}).pipe((0,y.U)((({hasBiometrics:e,isPasswordlessUser:t,isMpUser:s})=>(0,p.Vp)([...e?[T.W.Biometrics]:[],...t?[T.W.Pin]:[],...s?[T.W.MasterPassword]:[]]))))}};G=(0,r.__decorate)([(0,D.e)(T.Y),(0,r.__metadata)("design:paramtypes",[O.u,g._,U.P])],G);let k=class{};k=(0,r.__decorate)([(0,o.Yl)({api:i.M,handlers:{commands:{validateWebauthnAssertion:S,request2FaCodesByPhone:R},events:{},queries:{userVerificationMethods:G}},imports:[n.n,c.R],requiredFeatureFlips:Object.values(a.T),providers:[_]})],k)},17556:(e,t,s)=>{s.d(t,{e:()=>r});class r{redirectUserToExternalUrl(e){!async function(){try{await chrome.tabs.create({url:e.externalUrl,active:e.tabFocus})}catch(t){console.warn("[Auto-SSO] No window available. Delaying tab creation");const s=()=>{chrome.tabs.create({url:e.externalUrl,active:e.tabFocus}),chrome.windows.onCreated.removeListener(s)};chrome.windows.onCreated.addListener(s)}}()}}},73346:(e,t,s)=>{s.d(t,{c:()=>n});var r=s(75958),i=s(30709),a=s(22769),o=s(82435);const n=(0,r.Q)({name:"deviceManagement",commands:{RevokeAuthorisedDeviceCommand:i.hr,RenameAuthorisedDeviceCommand:o.nT},events:{},queries:{ListAuthorisedDeviceQuery:a.p}})},82435:(e,t,s)=>{s.d(t,{nT:()=>a});var r=s(13385),i=s(62149);(0,s(96168).Vj)("RENAME_DEVICE_ERROR","Failed to rename the device");class a extends((0,r.g)({scope:i.F.User})){}},30709:(e,t,s)=>{s.d(t,{hr:()=>a});var r=s(13385),i=s(62149);(0,s(96168).Vj)("REVOKE_DEVICE_ERROR","Failed to revoke the device");class a extends((0,r.g)({scope:i.F.User})){}},22769:(e,t,s)=>{s.d(t,{p:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},20922:(e,t,s)=>{s.d(t,{B:()=>R});var r=s(491),i=s(73346),a=s(86006),o=s(41511),n=s(62149),c=s(63144),d=s(56618);const l=e=>!e||"object"!=typeof e;class u extends((0,c.Q)({initialValue:[],persist:!1,scope:n.F.User,storeName:"device-management",storeTypeGuard:l,capacity:d.Y._010KB})){}var p=s(30709),h=s(82874),m=s(87279),g=s(60399),v=s(14122),y=s(92587),_=s(53344);let S=class{constructor(e,t,s){this.serverApi=e,this.carbonLegacyClient=t,this.store=s}async refreshDeviceManagementList(){const e=await(0,g.z)(this.carbonLegacyClient.queries.carbonState({path:"authentication.currentUser.deviceKeys"})),t=await(0,g.z)(this.serverApi.v1.devices.listDevices());if(!(0,m.d6)(t))throw new Error("Unable to retrieve Authorised Devices list: Server call failed");await this.store.set(t.data.data.devices.map((t=>({deviceId:t.deviceId,deviceName:t.deviceName,devicePlatform:t.devicePlatform,creationDate:t.creationDateUnix,lastUpdateDate:t.lastUpdateDateUnix,isCurrentDevice:(0,m.d6)(e)&&e.data.accessKey===t.deviceId}))))}async revokeDevice(e){const t=await this.store.getState(),s=await(0,g.z)(this.serverApi.v1.devices.deactivateDevice({deviceId:e}));if(!(0,m.d6)(s))throw new Error("Failure to revoke device: Server call failed");return await this.store.set(t.filter((t=>t.deviceId!==e))),(0,m.Vp)(void 0)}async renameDevice(e,t){const s=await this.store.getState(),r=await(0,g.z)(this.serverApi.v1.devices.renameDevice({accessKey:e,updatedName:t}));if(!(0,m.d6)(r))throw new Error("Failure to rename device: Server call failed");return await this.store.set(s.map((s=>s.deviceId===e?{...s,deviceName:t}:s))),(0,m.Vp)(void 0)}};S=(0,r.__decorate)([(0,y.GS)(),(0,r.__metadata)("design:paramtypes",[_.l,v._,u])],S);let f=class{constructor(e){this.deviceManagementService=e}async execute({body:e}){const{deviceId:t}=e,s=await this.deviceManagementService.revokeDevice(t);if((0,m.hx)(s))throw new Error("Failed to revoke device: Server error");return(0,m.Vp)(void 0)}};f=(0,r.__decorate)([(0,h.W)(p.hr),(0,r.__metadata)("design:paramtypes",[S])],f);var w=s(43978),I=s(22769),b=s(46449);let E=class{constructor(e,t){this.deviceManagementService=e,this.store=t}execute(){return this.store.state$.pipe((0,w.w)((async e=>(e.length||await this.deviceManagementService.refreshDeviceManagementList(),(0,m.Vp)(e)))))}};E=(0,r.__decorate)([(0,b.e)(I.p),(0,r.__metadata)("design:paramtypes",[S,u])],E);var C=s(82435);let A=class{constructor(e){this.deviceManagementService=e}async execute({body:e}){const{deviceId:t,updatedName:s}=e,r=await this.deviceManagementService.renameDevice(t,s);if((0,m.hx)(r))throw new Error("Failed to rename device: Server error");return(0,m.Vp)(void 0)}};A=(0,r.__decorate)([(0,h.W)(C.nT),(0,r.__metadata)("design:paramtypes",[S])],A);let R=class{};R=(0,r.__decorate)([(0,a.Yl)({api:i.c,imports:[o.n],handlers:{commands:{revokeAuthorisedDevice:f,renameAuthorisedDevice:A},events:{},queries:{listAuthorisedDevice:E}},providers:[S],stores:[u],domainName:"device"})],R)},75962:(e,t,s)=>{s.d(t,{J:()=>u});var r=s(75958),i=s(80673),a=s(88030),o=s(30600),n=s(5105),c=s(22730),d=s(86695),l=s(23913);const u=(0,r.Q)({name:"masterPasswordSecurity",commands:{dismissMasterPasswordNotification:i.T,temporaryCheckMasterPassword:a.T,temporaryResetMasterPasswordLeaked:o.j,temporaryCheckMasterPasswordWeak:n.B},events:{},queries:{isMasterPasswordLeaked:c.B,isMasterPasswordWeak:d.D,isMasterPasswordNotificationDismissed:l.F}})},80673:(e,t,s)=>{s.d(t,{T:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},5105:(e,t,s)=>{s.d(t,{B:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},88030:(e,t,s)=>{s.d(t,{T:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},30600:(e,t,s)=>{s.d(t,{j:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},22730:(e,t,s)=>{s.d(t,{B:()=>i});var r=s(77535);class i extends((0,r.k)()){}},23913:(e,t,s)=>{s.d(t,{F:()=>i});var r=s(77535);class i extends((0,r.k)()){}},86695:(e,t,s)=>{s.d(t,{D:()=>i});var r=s(77535);class i extends((0,r.k)()){}},56680:(e,t,s)=>{s.d(t,{f:()=>Ue});var r=s(86006),i=s(75962),a=s(16624),o=s(41511),n=s(70305),c=s(46449),d=s(22730),l=s(62149),u=s(63144),p=s(56618),h=s(10722),m=s(7165);const g=m.z.object({isMasterPasswordLeaked:m.z.boolean(),isMasterPasswordNotificationDismissed:m.z.boolean(),isMasterPasswordWeak:m.z.boolean(),lastCheckTimestamp:m.z.number()}),v=m.z.union([m.z.object({isMasterPasswordLeaked:m.z.boolean(),isMasterPasswordLeakedNotificationDismissed:m.z.boolean(),isMasterPasswordWeak:m.z.boolean(),lastCheckTimestamp:m.z.number()}),g]),y=e=>g.safeParse(e).success,_=e=>v.safeParse(e).success;function S(e){const{content:t,version:s}=e;if(1===s&&_(t))return y(t)?t:{isMasterPasswordWeak:t.isMasterPasswordWeak,isMasterPasswordLeaked:t.isMasterPasswordLeaked,isMasterPasswordNotificationDismissed:t.isMasterPasswordLeakedNotificationDismissed,lastCheckTimestamp:t.lastCheckTimestamp};throw new Error(`Unable to migrate unexpected master-password-security schema version ${s}`)}const f={isMasterPasswordWeak:!1,isMasterPasswordLeaked:!1,isMasterPasswordNotificationDismissed:!1,lastCheckTimestamp:0};class w extends((0,u.Q)({persist:!0,storage:{initialValue:f,typeGuard:y,schemaVersion:2,migrateStorageSchema:S},scope:l.F.User,isCache:!0,storeName:"master-password-security",codec:h.E,capacity:p.Y._001KB})){}var I=s(87279),b=s(87065),E=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},C=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let A=class{constructor(e){this.masterPasswordSecurityStore=e}execute(){return this.masterPasswordSecurityStore.state$.pipe((0,b.U)((e=>(0,I.Vp)(e.isMasterPasswordLeaked))))}};A=E([(0,c.e)(d.B),C("design:paramtypes",[w])],A);var R=s(86695),T=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},O=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let D=class{constructor(e){this.masterPasswordSecurityStore=e}execute(){return this.masterPasswordSecurityStore.state$.pipe((0,b.U)((e=>(0,I.Vp)(e.isMasterPasswordWeak))))}};D=T([(0,c.e)(R.D),O("design:paramtypes",[w])],D);var U=s(23913),F=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},P=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let x=class{constructor(e){this.masterPasswordSecurityStore=e}execute(){return this.masterPasswordSecurityStore.state$.pipe((0,b.U)((e=>(0,I.Vp)(e.isMasterPasswordNotificationDismissed))))}};x=F([(0,c.e)(U.F),P("design:paramtypes",[w])],x);var N=s(82874),G=s(80673),k=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},L=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let M=class{constructor(e){this.masterPasswordSecurityStore=e}async execute(){const e=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...e,isMasterPasswordNotificationDismissed:!0}),Promise.resolve((0,I.Vp)(void 0))}};M=k([(0,N.W)(G.T),L("design:paramtypes",[w])],M);var K=s(88030),j=s(92587),V=s(53344),z=s(60399),W=s(6453),q=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},B=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let $=class{constructor(e,t,s){this.serverApiClient=e,this.masterPasswordSecurityStore=t,this.passwordHasher=s}shouldBeChecked(){return(0,z.z)(this.masterPasswordSecurityStore.state$.pipe((0,b.U)((e=>!e.isMasterPasswordLeaked&&e.lastCheckTimestamp+864e5<=Date.now()))))}async check(e){const t=await this.passwordHasher.hash(e),s=await(0,z.z)(this.serverApiClient.v1.pwleak.getHashes({hashPrefix:t.substring(0,6)}));if((0,I.hx)(s))throw new Error("Error while retrieving list of hashes for MP checking");const r=s.data.data.includes(t),i=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...i,isMasterPasswordLeaked:r,lastCheckTimestamp:Date.now()})}};$=q([(0,j.GS)(),B("design:paramtypes",[V.l,w,W.T])],$);var Y=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},Q=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let H=class{constructor(e){this.masterPasswordSecurityStore=e}async reset(){const e=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...e,isMasterPasswordNotificationDismissed:!1})}};H=Y([(0,j.GS)(),Q("design:paramtypes",[w])],H);var J=s(53932),Z=s(5574),X=s(50756),ee=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},te=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let se=class{constructor(e,t){this.masterPasswordSecurityStore=e,this.cqrsClient=t}async send(){const{commands:{trackEvent:e}}=this.cqrsClient.getClient(Z.Yu),t=await this.masterPasswordSecurityStore.getState();await e({event:new X.AnonymousMasterPasswordHealthReportEvent({isLeaked:t.isMasterPasswordLeaked})})}};se=ee([(0,j.GS)(),te("design:paramtypes",[w,J.w])],se);var re=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},ie=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let ae=class{constructor(e,t,s){this.checkMasterPasswordService=e,this.resetMasterPasswordNotification=t,this.anonymousMasterPasswordLeakedTrackingEventSender=s}async execute({body:e}){return await this.resetMasterPasswordNotification.reset(),await this.checkMasterPasswordService.shouldBeChecked()?(await this.checkMasterPasswordService.check(e.password),this.anonymousMasterPasswordLeakedTrackingEventSender.send(),Promise.resolve((0,I.Vp)(void 0))):Promise.resolve((0,I.Vp)(void 0))}};ae=re([(0,N.W)(K.T),ie("design:paramtypes",[$,H,se])],ae);var oe=s(30600),ne=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},ce=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let de=class{constructor(e){this.masterPasswordSecurityStore=e}async execute(){const e=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...e,lastCheckTimestamp:0,isMasterPasswordLeaked:!1,isMasterPasswordNotificationDismissed:!1}),Promise.resolve((0,I.Vp)(void 0))}};de=ne([(0,N.W)(oe.j),ce("design:paramtypes",[w])],de);var le=s(5105),ue=s(85465);const pe=async e=>{if(e)return await(async e=>(await(0,ue.evaluate)(e)).score)(e)/25};var he=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},me=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let ge=class{constructor(e){this.masterPasswordSecurityStore=e}async check(e){const t=(await pe(e)??5)<3,s=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...s,isMasterPasswordWeak:t})}};ge=he([(0,j.GS)(),me("design:paramtypes",[w])],ge);var ve=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},ye=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let _e=class{constructor(e,t){this.masterPasswordSecurityStore=e,this.cqrsClient=t}async send(){const{commands:{trackEvent:e}}=this.cqrsClient.getClient(Z.Yu),t=await this.masterPasswordSecurityStore.getState();await e({event:new X.AnonymousMasterPasswordHealthReportEvent({isWeak:t.isMasterPasswordWeak})})}};_e=ve([(0,j.GS)(),ye("design:paramtypes",[w,J.w])],_e);var Se=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},fe=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let we=class{constructor(e,t,s){this.checkMasterPasswordWeakService=e,this.anonymousMasterPasswordWeakTrackingEventSender=t,this.resetMasterPasswordNotification=s}async execute({body:e}){return await this.resetMasterPasswordNotification.reset(),await this.checkMasterPasswordWeakService.check(e.password),this.anonymousMasterPasswordWeakTrackingEventSender.send(),Promise.resolve((0,I.Vp)(void 0))}};we=Se([(0,N.W)(le.B),fe("design:paramtypes",[ge,_e,H])],we);var Ie=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},be=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let Ee=class{constructor(e){this.masterPasswordSecurityStore=e}async reset(){const e=await this.masterPasswordSecurityStore.getState();return await this.masterPasswordSecurityStore.set({...e,isMasterPasswordWeak:!1})}};Ee=Ie([(0,j.GS)(),be("design:paramtypes",[w])],Ee);var Ce=s(85798),Ae=s(67490),Re=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},Te=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let Oe=class{constructor(e){this.resetMasterPasswordWeak=e}handle(){return this.resetMasterPasswordWeak.reset(),Promise.resolve(void 0)}};Oe=Re([(0,Ce.b)(Ae.D),Te("design:paramtypes",[Ee])],Oe);var De=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o};let Ue=class{};Ue=De([(0,r.Yl)({api:i.J,handlers:{commands:{dismissMasterPasswordNotification:M,temporaryCheckMasterPassword:ae,temporaryResetMasterPasswordLeaked:de,temporaryCheckMasterPasswordWeak:we},events:{...(0,r.g4)(n.v,{masterPasswordChanged:Oe})},queries:{isMasterPasswordLeaked:A,isMasterPasswordWeak:D,isMasterPasswordNotificationDismissed:x}},providers:[$,W.T,H,ge,se,_e,Ee],imports:[a.D,o.n],stores:[w]})],Ue)},6453:(e,t,s)=>{s.d(t,{T:()=>d});var r=s(92587),i=s(71171),a=s(96303),o=s(54066),n=function(e,t,s,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(a<3?i(o):a>3?i(t,s,o):i(t,s))||o);return a>3&&o&&Object.defineProperty(t,s,o),o},c=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let d=class{constructor(e){this.argon2dDeriver=e}async hash(e){return(0,a.k)(await this.argon2dDeriver.derive((0,o.u)(e),(0,o.u)("z8CXohryCcGAa7CESNHYnedqbDyp"),{tCost:3,mCost:32768,parallelism:2}))}};d=n([(0,r.GS)(),c("design:paramtypes",[i.y])],d)},57578:(e,t,s)=>{s.d(t,{y:()=>n});var r=s(75958),i=s(75183),a=s(43832),o=s(46938);const n=(0,r.Q)({name:"userConsents",commands:{UpdateConsentsCommand:i.a},events:{},queries:{getConsents:a.o,getEmailPreferenceLink:o.UE}})},75183:(e,t,s)=>{s.d(t,{a:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},43832:(e,t,s)=>{s.d(t,{o:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},46938:(e,t,s)=>{s.d(t,{UE:()=>c,Wp:()=>n});var r,i=s(96168),a=s(77535),o=s(62149);!function(e){e.NO_USER_FOR_KEY="no_user_for_key"}(r||(r={}));const n=(0,i.Vj)(r.NO_USER_FOR_KEY,"No user for this subscription code");class c extends((0,a.k)({scope:o.F.User})){}},78840:(e,t,s)=>{s.d(t,{K:()=>E});var r=s(491),i=s(86006),a=s(57578);var o=s(82874),n=s(75183),c=s(60399),d=s(87065),l=s(6220),u=s(92587),p=s(53344),h=s(48844),m=s(87279),g=s(46938),v=s(95115);let y=class{constructor(e,t){this.serverApiClient=e,this.subscriptionCodeApi=t}async updateConsents({triggerBy:e,consents:t}){return await(0,c.z)(this.serverApiClient.v1.userconsents.updateConsents({triggerBy:e,consents:t}).pipe((0,h.DZ)((e=>{throw new Error(e.message)})))),(0,m.Vp)(void 0)}getEmailPreferenceCenterLink(){return this.getSubscriptionCode().pipe((0,d.U)((e=>e))).pipe((0,l.z)((e=>this.serverApiClient.v1.communication.getUserEmailSubscriptionInfo({userKey:e}).pipe((0,d.U)((e=>(0,m.hx)(e)?(0,m.Rn)((0,g.Wp)()):(0,m.Vp)(e.data.data.prefCenterLink)))))))}getSubscriptionCode(){const{getSubscriptionCode:e}=this.subscriptionCodeApi.queries;return e().pipe((0,d.U)((e=>{if(!(0,m.d6)(e))throw new Error(e.error.message);return(0,m.db)(e)})))}};y=(0,r.__decorate)([(0,u.GS)(),(0,r.__metadata)("design:paramtypes",[p.l,v._])],y);let _=class{constructor(e){this.userConsentsService=e}execute({body:{triggerBy:e,consents:t}}){return this.userConsentsService.updateConsents({triggerBy:e,consents:t})}};_=(0,r.__decorate)([(0,o.W)(n.a),(0,r.__metadata)("design:paramtypes",[y])],_);var S=s(46449),f=s(43832);let w=class{constructor(e){this.serverApiClient=e}execute(){return this.serverApiClient.v1.userconsents.getConsents({format:"two-consents"}).pipe((0,h.Qn)((e=>e.data)),(0,h.DZ)((e=>{throw new Error(e.message)})))}};w=(0,r.__decorate)([(0,S.e)(f.o),(0,r.__metadata)("design:paramtypes",[p.l])],w);let I=class{constructor(e){this.userConsentsService=e}execute(){return this.userConsentsService.getEmailPreferenceCenterLink()}};I=(0,r.__decorate)([(0,S.e)(g.UE),(0,r.__metadata)("design:paramtypes",[y])],I);var b=s(41511);let E=class{};E=(0,r.__decorate)([(0,i.Yl)({api:a.y,imports:[b.n],providers:[y],handlers:{commands:{updateConsents:_},events:{},queries:{getConsents:w,getEmailPreferenceLink:I}},requiredFeatureFlips:[...Object.values({EMAIL_PREFERENCE_CENTER:"ecommerce_web_admin_email_preference_center"})]})],E)},39623:(e,t,s)=>{s.d(t,{R:()=>u});var r=s(75958),i=s(20360),a=s(64548),o=s(53032),n=s(43200),c=s(6553),d=s(4809),l=s(59039);const u=(0,r.Q)({name:"nudges",commands:{ValidateNudgesInstallationCommand:i.u,SendNudgeCommand:a.P,UpdateTeamNudgeCommand:o.X,UninstallNudgesCommand:n.Q},events:{},queries:{CheckNudgesInstallationQuery:c.W,GetHealthAndNudgeReportQuery:d.N,GetTeamNudgesQuery:l.w}})},64548:(e,t,s)=>{s.d(t,{P:()=>o,m:()=>a});var r=s(13385),i=s(62149);const a="SLACK_MESSAGE_NOT_DELIVERED";class o extends((0,r.g)({scope:i.F.User})){}},43200:(e,t,s)=>{s.d(t,{Q:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},53032:(e,t,s)=>{s.d(t,{X:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},20360:(e,t,s)=>{s.d(t,{u:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},6553:(e,t,s)=>{s.d(t,{W:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},4809:(e,t,s)=>{s.d(t,{N:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},59039:(e,t,s)=>{s.d(t,{w:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},3659:(e,t,s)=>{s.d(t,{_:()=>G});var r=s(491),i=s(86006),a=s(75421),o=s(39623),n=s(82874),c=s(76500),d=s(87279),l=s(20360),u=s(25917),p=s(60399);let h=class{constructor(e,t){this.enclaveApiClient=e,this.teamEnclaveClient=t}async execute({body:{authCode:e}}){try{const{adminProvisioningKey:t,teamUuid:s}=await this.getTeamIdentifiers();if(!t||!s){const t=await this.teamEnclaveClient.commands.createTeamInEnclave();if((0,d.hx)(t))throw new Error("ValidateNudgesInstallation: failed to create team "+t.error);return this.execute(new l.u({authCode:e}))}return await this.enclaveApiClient.slack.installSlackApp({adminProvisioningKey:t,slackAuthGrant:e,teamUuid:s}),(0,d.Vp)(void 0)}catch(e){throw new Error(`ValidateNudgesInstallation: ${e}`)}}async getTeamIdentifiers(){const e=await(0,p.z)(this.teamEnclaveClient.queries.getTeamIdentifiers());if((0,d.hx)(e))return{teamUuid:void 0,adminProvisioningKey:void 0};const{teamUuid:t,adminProvisioningKey:s}=(0,d.db)(e);return{teamUuid:t,adminProvisioningKey:s}}};h=(0,r.__decorate)([(0,n.W)(l.u),(0,r.__metadata)("design:paramtypes",[c.l,u.G])],h);var m=s(53344),g=s(18533),v=s(20195),y=s(64548);let _=class{constructor(e){this.serverApiClient=e,this.getFunctionalError=e=>{if(e===y.m)return(0,d.Rn)({tag:"SLACK_MESSAGE_NOT_DELIVERED"});throw new Error(`SendNudge: error ${e}`)}}async execute({body:{type:e}}){const{testSlackMessageForAdmin:t}=this.serverApiClient.v1.integration;try{const s="welcome"===e?void 0:e,r=await(0,p.z)(t({nudge:s}));return(0,d.hx)(r)?(0,g.EQ)(r.error,{BusinessError:e=>this.getFunctionalError(e.code),FetchFailedError:()=>{throw new Error("Fetch Failed error")},BadStatus:v.j,InternalServerError:v.j,InvalidRequest:v.j,RateLimited:v.j,ServiceUnavailable:v.j,UnspecifiedBadStatus:v.j}):(0,d.Vp)(void 0)}catch(e){throw new Error("SendNudge: unable to send nudge"+e)}}};_=(0,r.__decorate)([(0,n.W)(y.P),(0,r.__metadata)("design:paramtypes",[m.l])],_);var S=s(53032);let f=class{constructor(e){this.serverApiClient=e}async execute({body:e}){const{updateTeamNudge:t}=this.serverApiClient.v1.integration;try{const s=await(0,p.z)(t(e));if((0,d.hx)(s))throw new Error(s.error.message);return(0,d.Vp)(void 0)}catch(e){throw new Error("UpdateTeamNudge: "+e)}}};f=(0,r.__decorate)([(0,n.W)(S.X),(0,r.__metadata)("design:paramtypes",[m.l])],f);var w=s(43200);let I=class{constructor(e,t){this.enclaveApiClient=e,this.teamEnclaveClient=t}async execute(){try{const e=await(0,p.z)(this.teamEnclaveClient.queries.getTeamIdentifiers());if((0,d.hx)(e))throw new Error("UninstallNudges: team not provisioned in nitro");const{adminProvisioningKey:t,teamUuid:s}=(0,d.db)(e);if(!t)throw new Error("UninstallNudges: adminProvisioningKey is missing. Could not uninstall nudges");return await this.enclaveApiClient.slack.uninstallSlackApp({teamUuid:s,adminProvisioningKey:t}),(0,d.Vp)(void 0)}catch(e){throw new Error(`UninstallNudges: ${e}`)}}};I=(0,r.__decorate)([(0,n.W)(w.Q),(0,r.__metadata)("design:paramtypes",[c.l,u.G])],I);var b=s(87065),E=s(46449),C=s(6553);let A=class{constructor(e){this.teamEnclaveClient=e}execute(){return this.teamEnclaveClient.queries.getTeamFromEnclave().pipe((0,b.U)((e=>{if((0,d.hx)(e))return(0,d.Vp)(!1);const{messageIntegrations:{slackStatus:t}}=(0,d.db)(e);return(0,d.Vp)(t)})))}};A=(0,r.__decorate)([(0,E.e)(C.W),(0,r.__metadata)("design:paramtypes",[u.G])],A);var R=s(48844),T=s(4809);let O=class{constructor(e){this.serverApiClient=e}execute({body:{numberOfDays:e}}){const{getHealthAndNudgeReport:t}=this.serverApiClient.v1.teams;return t({numberOfDays:e}).pipe((0,R.Qn)((e=>e.data)),(0,R.DZ)((e=>{throw new Error(e.message)})))}};O=(0,r.__decorate)([(0,E.e)(T.N),(0,r.__metadata)("design:paramtypes",[m.l])],O);var D=s(59039);let U=class{constructor(e){this.serverApiClient=e}execute(){const{getTeamNudges:e}=this.serverApiClient.v1.integration;return e().pipe((0,R.Qn)((e=>e.data)),(0,R.DZ)((e=>{throw new Error(e.message)})))}};U=(0,r.__decorate)([(0,E.e)(D.w),(0,r.__metadata)("design:paramtypes",[m.l])],U);var F=s(5206),P=s(41511),x=s(19961),N=s(73820);let G=class{};G=(0,r.__decorate)([(0,i.Yl)({api:o.R,handlers:{commands:{validateNudgesInstallation:h,sendNudge:_,updateTeamNudge:f,uninstallNudges:I},events:{},queries:{checkNudgesInstallation:A,getHealthAndNudgeReport:O,getTeamNudges:U}},imports:[a.X,F.i,N.Z,P.n,x.G],providers:[],requiredFeatureFlips:["ace_tac_slack_integration"]})],G)},89193:(e,t,s)=>{s.d(t,{g:()=>d});var r=s(75958),i=s(79448),a=s(56073),o=s(98976),n=s(57571),c=s(60678);const d=(0,r.Q)({name:"activityLogs",commands:{initiateActivityLogsRetrieval:i.b,loadNextActivityLogs:a.X,storeActivityLogs:o.M},events:{},queries:{activityLogs:n.I,areSensitiveLogsEnabled:c._}})},91943:(e,t,s)=>{s.d(t,{_:()=>a});var r=s(8260),i=s(89193);class a extends((0,r.E)(i.g)){}(0,r.K)(i.g,a)},79448:(e,t,s)=>{s.d(t,{b:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},56073:(e,t,s)=>{s.d(t,{X:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},98976:(e,t,s)=>{s.d(t,{M:()=>o,W:()=>r});var r,i=s(13385),a=s(62149);!function(e){e.AUDIT_LOG_MISSING_JSON_SCHEMA="AUDIT_LOG_MISSING_JSON_SCHEMA",e.AUDIT_LOG_INVALID_JSON_FOR_JSON_SCHEMA="AUDIT_LOG_INVALID_JSON_FOR_JSON_SCHEMA",e.AUDIT_LOG_INVALID_LOG_SCHEMA_TYPE_OR_VERSION="AUDIT_LOG_INVALID_LOG_SCHEMA_TYPE_OR_VERSION",e.AUDIT_LOG_ERROR_READING_JSON_SCHEMA="AUDIT_LOG_ERROR_READING_JSON_SCHEMA",e.STORING_SENSITIVE_AUDIT_LOGS_NOT_ALLOWED="STORING_SENSITIVE_AUDIT_LOGS_NOT_ALLOWED",e.AUDIT_LOG_TYPE_NOT_CLIENT_SIDE="AUDIT_LOG_TYPE_NOT_CLIENT_SIDE",e.AUDIT_LOG_TYPE_NOT_TEAM_DEVICE_OR_CLIENT_SIDE="AUDIT_LOG_TYPE_NOT_TEAM_DEVICE_OR_CLIENT_SIDE",e.AUDIT_LOG_MISSING_CATEGORY_TO_LOG_TYPE_MAPPING="AUDIT_LOG_MISSING_CATEGORY_TO_LOG_TYPE_MAPPING",e.AUDIT_LOG_NON_SECURITY_MONITORING_IN_MASS_DEPLOYMENT="AUDIT_LOG_NON_SECURITY_MONITORING_IN_MASS_DEPLOYMENT"}(r||(r={}));class o extends((0,i.g)({scope:a.F.User})){}},67873:(e,t,s)=>{var r;s.d(t,{q:()=>r}),function(e){e.SharingVaultTacAuditLogsProtectedItemRevealed="sharingVault_tac_audit_logs_protected_item_revealed"}(r||(r={}))},57571:(e,t,s)=>{s.d(t,{I:()=>o,Q:()=>a});var r=s(77535),i=s(62149);const a={NOT_LOADED:"NOT_LOADED",LOADING:"LOADING",READY:"READY",ERROR:"ERROR"};class o extends((0,r.k)({scope:i.F.User})){}},60678:(e,t,s)=>{s.d(t,{_:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},55920:(e,t,s)=>{var r,i;s.d(t,{p:()=>i,z:()=>r}),function(e){e.UserInvited="user_invited",e.UserReinvited="user_reinvited",e.UserRemoved="user_removed",e.TeamCaptainAdded="team_captain_added",e.TeamCaptainRemoved="team_captain_removed",e.GroupManagerAdded="group_manager_added",e.GroupManagerRemoved="group_manager_removed",e.MasterPasswordResetAccepted="master_password_reset_accepted",e.MasterPasswordResetRefused="master_password_reset_refused",e.BillingAdminAdded="billing_admin_added",e.BillingAdminRemoved="billing_admin_removed",e.UserGroupCreated="user_group_created",e.UserGroupRenamed="user_group_renamed",e.UserGroupDeleted="user_group_deleted",e.UserJoinedUserGroup="user_joined_user_group",e.UserLeftUserGroup="user_left_user_group",e.UserInvitedToUserGroup="user_invited_to_user_group",e.UserDeclinedInviteToUserGroup="user_declined_invite_to_user_group",e.UserRemovedFromUserGroup="user_removed_from_user_group",e.DomainRequested="domain_requested",e.DomainValidated="domain_validated",e.SensitiveLogsEnabled="collect_sensitive_data_audit_logs_enabled",e.SensitiveLogsDisabled="collect_sensitive_data_audit_logs_disabled",e.SsoIdpMetadataSet="sso_idp_metadata_set",e.SsoServiceProviderUrlSet="sso_service_provider_url_set",e.SsoEnabled="sso_enabled",e.SsoDisabled="sso_disabled",e.NitroUserProvisioningActivated="nitro_user_provisioning_activated",e.NitroUserProvisioningDeactivated="nitro_user_provisioning_deactivated",e.NitroGroupProvisioningActivated="nitro_group_provisioning_activated",e.NitroGroupProvisioningDeactivated="nitro_group_provisioning_deactivated",e.NitroSiemActivated="nitro_siem_activated",e.NitroSiemDeactivated="nitro_siem_deactivated",e.NitroSiemEdited="nitro_siem_edited",e.NitroSsoDomainProvisioned="nitro_sso_domain_provisioned",e.NitroSsoDomainRemoved="nitro_sso_domain_removed",e.NitroSsoDomainVerified="nitro_sso_domain_verified",e.NitroSsoSetupStarted="nitro_sso_setup_started",e.TeamNameChanged="team_name_changed",e.NewBillingPeriodCreated="new_billing_period_created",e.SeatsAdded="seats_added",e.ContactEmailChanged="contact_email_changed",e.MasterPasswordMobileResetEnabled="master_password_mobile_reset_enabled",e.MasterPasswordMobileResetDisabled="master_password_mobile_reset_disabled",e.MasterPasswordMobileReset="master_password_mobile_reset",e.MasterPasswordChanged="master_password_changed",e.MpToViewPasswordsEnabled="mp_to_view_passwords_enabled",e.MpToViewPasswordsDisabled="mp_to_view_passwords_disabled",e.TwoFactorAuthenticationFailed="two_factor_authentication_failed",e.TwoFactorAuthenticationLoginMethodAdded="two_factor_authentication_login_method_added",e.TwoFactorAuthenticationLoginMethodRemoved="two_factor_authentication_login_method_removed",e.BiometricSignInDisabled="biometric_sign_in_disabled",e.DWMEmailAdded="dwm_email_added",e.DWMEmailRemoved="dwm_email_removed",e.DWMAlertReceived="dwm_alert_received",e.UserDeviceAdded="user_device_added",e.UserDeviceRemoved="user_device_removed",e.UserDeviceLogin="user_device_login",e.MasterPasswordReset="master_password_reset",e.RequestedAccountRecovery="requested_account_recovery",e.CompletedAccountRecovery="completed_account_recovery",e.UserSharedCredentialWithGroup="user_shared_credential_with_group",e.UserSharedCredentialWithEmail="user_shared_credential_with_email",e.UserSharedCredentialWithExternal="user_shared_credential_with_external",e.UserSharedSecureNoteWithGroup="user_shared_secure_note_with_group",e.UserSharedSecureNoteWithEmail="user_shared_secure_note_with_email",e.UserSharedSecureNoteWithExternal="user_shared_secure_note_with_external",e.UserRevokedSharedCredentialGroup="user_revoked_shared_credential_group",e.UserRevokedSharedCredentialEmail="user_revoked_shared_credential_email",e.UserRevokedSharedCredentialExternal="user_revoked_shared_credential_external",e.UserRevokedSharedSecureNoteGroup="user_revoked_shared_secure_note_group",e.UserRevokedSharedSecureNoteEmail="user_revoked_shared_secure_note_email",e.UserRevokedSharedSecureNoteExternal="user_revoked_shared_secure_note_external",e.UserAcceptedSharingInviteSecureNote="user_accepted_sharing_invite_secure_note",e.UserRejectedSharingInviteSecureNote="user_rejected_sharing_invite_secure_note",e.UserAcceptedSharingInviteCredential="user_accepted_sharing_invite_credential",e.UserRejectedSharingInviteCredential="user_rejected_sharing_invite_credential",e.UserAddedCredentialToCollection="user_added_credential_to_collection",e.UserCreatedCollection="user_created_collection",e.UserDeletedCollection="user_deleted_collection",e.UserImportedCollection="user_imported_collection",e.UserRemovedCredentialFromCollection="user_removed_credential_from_collection",e.UserRenamedCollection="user_renamed_collection",e.UserSharedCollectionWithUser="user_shared_collection_with_user",e.UserSharedCollectionWithGroup="user_shared_collection_with_usergroup",e.UserAcceptedCollection="user_accepted_collection_invite",e.UserRejectedCollection="user_rejected_collection_invite",e.UserAddedItemToCollection="user_added_credential_to_shared_collection",e.UserRemovedItemFromCollection="user_removed_credential_from_shared_collection",e.UserUpdatedGroupRoleInCollection="user_updated_collection_usergroup",e.UserUpdatedUserRoleInCollection="user_updated_collection_user",e.UserRenamedSharedCollection="user_renamed_shared_collection",e.UserRevokedGroupFromCollection="user_revoked_collection_usergroup",e.UserRevokedUserFromCollection="user_revoked_collection_user",e.UserCreatedCredential="user_created_credential",e.UserModifiedCredential="user_modified_credential",e.UserDeletedCredential="user_deleted_credential",e.UserImportedCredentials="user_imported_credentials",e.UserCreatedSecureNote="user_created_secure_note",e.UserModifiedSecureNote="user_modified_secure_note",e.UserDeletedSecureNote="user_deleted_secure_note",e.NudgeExecuted="nudge_executed",e.NudgeConfigured="nudge_configured",e.NitroIntegrationAppInstalled="nitro_integration_app_installed",e.NitroIntegrationAppUninstalled="nitro_integration_app_uninstalled",e.UserReceivedNudge="user_received_nudge",e.MassDeploymentConfigurationUpdated="mass_deployment_configuration_updated",e.UserTypedCompromisedPassword="user_typed_compromised_password",e.UserTypedWeakPassword="user_typed_weak_password",e.UserTypedPassword="user_typed_password",e.UserPerformedAutofillCredential="user_performed_autofill_credential",e.UserPerformedAutofillPayment="user_performed_autofill_payment",e.UserAuthenticatedWithPasskey="user_authenticated_with_passkey",e.UserRevealedCredentialField="user_revealed_credential_field",e.UserRevealedCreditCardField="user_revealed_credit_card_field",e.UserRevealedBankAccountField="user_revealed_bank_account_field",e.UserRevealedSecureNote="user_revealed_secure_note_field",e.UserRevealedSecret="user_revealed_secret_field"}(r||(r={})),function(e){e.Account="account",e.Authentication="authentication",e.DarkWebMonitoring="dark_web_monitoring",e.Groups="groups",e.ImportExport="import_export",e.ItemUsage="item_usage",e.TeamSettings="team_settings",e.TeamSettingsActiveDirectory="team_settings_activedirectory",e.TeamSettingsPolicies="team_settings_policies",e.TeamSettingsSAMLProvisioning="team_settings_samlprovisioning",e.TeamSettingsSIEM="team_settings_siem",e.TeamSettingsSCIM="team_settings_scim",e.TeamSettingsSSO="team_settings_sso",e.Sharing="sharing",e.UserSettings="user_settings",e.UserSettingsAccountRecovery="user_settings_accountrecovery",e.Users="users",e.VaultCollections="vault_collections",e.VaultIDs="vault_ids",e.VaultPasswords="vault_passwords",e.VaultPayments="vault_payments",e.VaultPersonalInfo="vault_personalinfo",e.VaultSecureNotes="vault_securenotes",e.TeamNudges="team_nudges",e.SecurityMonitoring="security_monitoring",e.RiskDetection="risk_detection"}(i||(i={}))},55634:(e,t,s)=>{s.r(t),s.d(t,{ActivityLogCategory:()=>l.p,ActivityLogFeatureFlips:()=>u.q,ActivityLogType:()=>l.z,ActivityLogsClient:()=>i._,ActivityLogsQuery:()=>c.I,AnalysePasswordForRisksQuery:()=>w.S,AreSensitiveLogsEnabledQuery:()=>d._,GenerateAndDownloadMassDeploymentScriptCommand:()=>S.U,GenerateMassDeploymentTeamKeyCommand:()=>v.tv,GenerateMassDeploymentTeamKeyCommandErrorCodes:()=>v.rI,GetLastLogDateQuery:()=>I.k,GetMassDeploymentSecurityMonitoringConfigurationQuery:()=>b.g,GetMassDeploymentSetupInformationQuery:()=>E.a,GetRiskDetectionInsightsQuery:()=>C.p,GetRiskDetectionInsightsQueryErrorCodes:()=>R.Zq,GetSiemConfigurationErrorCode:()=>N.At,GetSiemConfigurationQuery:()=>N.pr,InitiateActivityLogsRetrievalCommand:()=>a.b,IsLoggedOutMonitoringEnabledForDeviceQuery:()=>A.m,IsLoggedOutMonitoringEnabledForDeviceQueryErrorCodes:()=>g,LoadNextActivityLogsCommand:()=>o.X,LoadingStatus:()=>c.Q,LoggedOutMonitoringClient:()=>m,LoggedOutMonitoringFeatureFlips:()=>f.q,MassDeploymentSecurityMonitoringConfigurationErrorCodes:()=>D.k,SUPPORTED_BROWSERS_TO_EXTENSION_ID_MAPPING:()=>U.NB,SUPPORTED_BROWSERS_TO_EXTENSION_PREFERENCE_DOMAINS:()=>U.Xd,SUPPORTED_BROWSERS_TO_PREFERENCE_DOMAINS:()=>U.Zf,SUPPORTED_BROWSERS_TO_UPDATE_URL_MAPPING:()=>U.m2,SUPPORTED_BROWSERS_TO_WINDOWS_REGISTRY_PATH:()=>U.Y,SUPPORTED_MASS_DEPLOYMENT_BROWSERS:()=>U.Qh,SUPPORTED_MASS_DEPLOYMENT_OSS:()=>U.I3,SUPPORTED_MASS_DEPLOYMENT_SOFTWARES:()=>U.T4,SendRiskyPasswordLoggedOutLogCommand:()=>y.r,SetSiemConfigurationCommand:()=>x.Qj,SetSiemConfigurationErrorCode:()=>x.M7,StoreActivityLogsCommand:()=>n.M,StoreActivityLogsInvalidLogsError:()=>n.W,UpdateLoggedOutMonitoringActiveStatusCommand:()=>_.a,activityLogsApi:()=>r.g,createCantGetMassDeploymentTeamKeyFromBrowserPoliciesError:()=>O,createGetActivityLogsError:()=>R.LS,createInitiateActivityLogsRetrievalError:()=>R.y9,createLoadNextActivityLogsError:()=>R.We,createServerCallNotAuthorizedError:()=>D.x,createTeamNotFoundMassDeploymentError:()=>v.o1,createValidMassDeploymentTeamKeyAlreadyExistsForTeamError:()=>v.$m,getSiemGenericError:()=>N.Nv,invalidUrlError:()=>x.q0,isIntuneSetupInformationResult:()=>F.Ss,isJamfSetupInformationResult:()=>F.kv,isSupportedMassDeploymentBrowser:()=>F.US,isSupportedMassDeploymentOS:()=>F.TY,isSupportedMassDeploymentSoftware:()=>F.GI,loggedOutMonitoringApi:()=>p.i,mismatchingAdminProvisioningKeyError:()=>x.HC,noSiemConfigurationUpdateError:()=>x.$3,setSiemGenericError:()=>x.SC,siemApi:()=>P.v,teamNotFoundError:()=>x.gY});var r=s(89193),i=s(91943),a=s(79448),o=s(56073),n=s(98976),c=s(57571),d=s(60678),l=s(55920),u=s(67873),p=s(30049),h=s(8260);class m extends((0,h.E)(p.i)){}(0,h.K)(p.i,m);var g,v=s(23035),y=s(67426),_=s(4087),S=s(28953),f=s(48847),w=s(87954),I=s(19958),b=s(57325),E=s(65682),C=s(76736),A=s(18221),R=s(51708),T=s(96168);!function(e){e.CANT_GET_MASS_DEPLOYMENT_TEAM_KEY_FROM_BROWSER_POLICIES="CANT_GET_MASS_DEPLOYMENT_TEAM_KEY_FROM_BROWSER_POLICIES"}(g||(g={}));const O=(0,T.Vj)(g.CANT_GET_MASS_DEPLOYMENT_TEAM_KEY_FROM_BROWSER_POLICIES,"[Mass Deployment - Is Logged-out Monitoring Enabled for device] - Failed to get mass deployment team key from browser policies");var D=s(46035),U=s(75147),F=s(68567),P=s(55102),x=s(24170),N=s(42668)},30049:(e,t,s)=>{s.d(t,{i:()=>m});var r=s(75958),i=s(23035),a=s(67426),o=s(4087),n=s(28953),c=s(87954),d=s(19958),l=s(57325),u=s(65682),p=s(76736),h=s(18221);const m=(0,r.Q)({name:"loggedOutMonitoring",commands:{generateMassDeploymentTeamKey:i.tv,sendRiskyPasswordLoggedOutLog:a.r,updateLoggedOutMonitoringActiveStatus:o.a,generateAndDownloadMassDeploymentScriptCommand:n.U},events:{},queries:{analysePasswordForRisks:c.S,getLastLogDate:d.k,getMassDeploymentSecurityMonitoringConfigurationQuery:l.g,getMassDeploymentSetupInformation:u.a,getRiskDetectionInsights:p.p,isLoggedOutMonitoringEnabledForDevice:h.m}})},28953:(e,t,s)=>{s.d(t,{U:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},23035:(e,t,s)=>{s.d(t,{$m:()=>c,o1:()=>n,rI:()=>r,tv:()=>d});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.TEAM_NOT_FOUND="TEAM_NOT_FOUND",e.VALID_MASS_DEPLOYMENT_TEAM_KEY_ALREADY_EXISTS_FOR_TEAM="VALID_MASS_DEPLOYMENT_TEAM_KEY_ALREADY_EXISTS_FOR_TEAM"}(r||(r={}));const n=(0,o.Vj)(r.TEAM_NOT_FOUND,"[Mass Deployment - Generate Key] - Team not found"),c=(0,o.Vj)(r.VALID_MASS_DEPLOYMENT_TEAM_KEY_ALREADY_EXISTS_FOR_TEAM,"[Mass Deployment - Generate Key] - A valid mass deployment team key already exists for the team");class d extends((0,i.g)({scope:a.F.User})){}},67426:(e,t,s)=>{s.d(t,{r:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},4087:(e,t,s)=>{s.d(t,{a:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},48847:(e,t,s)=>{var r;s.d(t,{q:()=>r}),function(e){e.RiskDetectionDev="setupAndRollout_web_lomo_dev",e.RiskDetectionV1BetaTesters="setupAndRollout_web_lomo",e.RiskDetectionV2Prod="lomo_web_v2-risk-detection",e.RiskDetectionV2OnDemand="lomo_web_risk-detection-capability"}(r||(r={}))},87954:(e,t,s)=>{s.d(t,{S:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},19958:(e,t,s)=>{s.d(t,{k:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},57325:(e,t,s)=>{s.d(t,{g:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},65682:(e,t,s)=>{s.d(t,{a:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},76736:(e,t,s)=>{s.d(t,{p:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},18221:(e,t,s)=>{s.d(t,{m:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},51708:(e,t,s)=>{s.d(t,{LS:()=>a,We:()=>o,Zq:()=>r,y9:()=>n});var r,i=s(96168);!function(e){e.ERROR_GETTING_ACTIVITY_LOGS="ERROR_GETTING_ACTIVITY_LOGS",e.ERROR_INITIATING_ACTIVITY_LOGS_RETRIEVAL="ERROR_INITIATING_ACTIVITY_LOGS_RETRIEVAL",e.ERROR_LOADING_NEXT_ACTIVITY_LOGS="ERROR_LOADING_NEXT_ACTIVITY_LOGS"}(r||(r={}));const a=(0,i.Vj)(r.ERROR_GETTING_ACTIVITY_LOGS,"[Risk Detection Insights - get-risk-detection-insights] - Failed to get activity logs"),o=(0,i.Vj)(r.ERROR_LOADING_NEXT_ACTIVITY_LOGS,"[Risk Detection Insights - get-risk-detection-insights] - Failed to load next activity logs"),n=(0,i.Vj)(r.ERROR_INITIATING_ACTIVITY_LOGS_RETRIEVAL,"[Risk Detection Insights - get-risk-detection-insights] - Failed to initiate activity logs retrieval")},46035:(e,t,s)=>{s.d(t,{k:()=>r,x:()=>a});var r,i=s(96168);!function(e){e.NOT_AUTHORIZED="NOT_AUTHORIZED"}(r||(r={}));const a=(0,i.Vj)(r.NOT_AUTHORIZED,"[Mass Deployment - Update Logged-out Monitoring Active Status] - Server call not authorized")},68567:(e,t,s)=>{s.d(t,{GI:()=>i,Ss:()=>n,TY:()=>a,US:()=>o,kv:()=>c});var r=s(75147);function i(e){return"string"==typeof e&&r.T4.includes(e)}function a(e){return"string"==typeof e&&r.I3.includes(e)}function o(e){return"string"==typeof e&&r.Qh.includes(e)}function n(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&"massDeploymentPoliciesScript"in e&&"string"==typeof e.massDeploymentPoliciesScript&&"massDeploymentExtensionIDsAndUpdateURLs"in e&&"object"==typeof e.massDeploymentExtensionIDsAndUpdateURLs&&null!==e.massDeploymentExtensionIDsAndUpdateURLs&&!Array.isArray(e.massDeploymentExtensionIDsAndUpdateURLs)&&Object.keys(e.massDeploymentExtensionIDsAndUpdateURLs).every(o)&&Object.values(e.massDeploymentExtensionIDsAndUpdateURLs).every((e=>"string"==typeof e))}function c(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&"extensionPreferenceDomains"in e&&"object"==typeof e.extensionPreferenceDomains&&null!==e.extensionPreferenceDomains&&!Array.isArray(e.extensionPreferenceDomains)&&Object.keys(e.extensionPreferenceDomains).every(o)&&Object.values(e.extensionPreferenceDomains).every((e=>"string"==typeof e))&&"extensionPoliciesValue"in e&&"string"==typeof e.extensionPoliciesValue&&"browsersPreferenceDomains"in e&&"object"==typeof e.browsersPreferenceDomains&&null!==e.browsersPreferenceDomains&&!Array.isArray(e.browsersPreferenceDomains)&&Object.keys(e.browsersPreferenceDomains).every(o)&&Object.values(e.browsersPreferenceDomains).every((e=>"string"==typeof e))&&"browsersForceInstallValues"in e&&"object"==typeof e.browsersForceInstallValues&&null!==e.browsersForceInstallValues&&!Array.isArray(e.browsersForceInstallValues)&&Object.keys(e.browsersForceInstallValues).every(o)&&Object.values(e.browsersForceInstallValues).every((e=>"string"==typeof e))}},75147:(e,t,s)=>{s.d(t,{I3:()=>i,NB:()=>o,Qh:()=>a,T4:()=>r,Xd:()=>d,Y:()=>c,Zf:()=>l,m2:()=>n});const r=["jamf","microsoft-intune"],i=["macos","windows","linux"],a=["chrome","firefox","edge"],o={chrome:"fdjamakpfbbddfjaooikfcpapjohcfmg",firefox:"",edge:"gehmmocbbkpblljhkekmfhjpfbkclbph"},n={chrome:"https://clients2.google.com/service/update2/crx",firefox:"",edge:"https://edge.microsoft.com/extensionwebstorebase/v1/crx"},c={chrome:"HKLM:\\SOFTWARE\\Policies\\Google\\Chrome\\3rdparty\\extensions\\fdjamakpfbbddfjaooikfcpapjohcfmg\\policy",firefox:"",edge:"HKLM:\\SOFTWARE\\Policies\\Microsoft\\Edge\\3rdparty\\extensions\\gehmmocbbkpblljhkekmfhjpfbkclbph\\policy"},d={chrome:"com.google.Chrome.extensions.fdjamakpfbbddfjaooikfcpapjohcfmg",edge:"com.microsoft.Edge.extensions.gehmmocbbkpblljhkekmfhjpfbkclbph",firefox:""},l={chrome:"com.google.Chrome",edge:"com.microsoft.Edge",firefox:""}},55102:(e,t,s)=>{s.d(t,{v:()=>o});var r=s(75958),i=s(24170),a=s(42668);const o=(0,r.Q)({name:"siem",commands:{setSiemConfiguration:i.Qj},events:{},queries:{getSiemConfiguration:a.pr}})},24170:(e,t,s)=>{s.d(t,{$3:()=>d,HC:()=>c,M7:()=>r,Qj:()=>p,SC:()=>u,gY:()=>n,q0:()=>l});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.GENERIC_ERROR="GENERIC_ERROR",e.TEAM_NOT_FOUND="TEAM_NOT_FOUND",e.MISMATCHING_ADMIN_PROVISIONING_KEY="MISMATCHING_ADMIN_PROVISIONING_KEY",e.NO_SIEM_CONFIGURATION_UPDATE="NO_SIEM_CONFIGURATION_UPDATE",e.INVALID_URL="INVALID_URL"}(r||(r={}));const n=(0,o.Vj)(r.TEAM_NOT_FOUND,"Team not found"),c=(0,o.Vj)(r.MISMATCHING_ADMIN_PROVISIONING_KEY,"Mismatching admin provisioning key"),d=(0,o.Vj)(r.NO_SIEM_CONFIGURATION_UPDATE,"There's nothing to update"),l=(0,o.Vj)(r.INVALID_URL,"Invalid URL"),u=(0,o.Vj)(r.GENERIC_ERROR,"Generic error");class p extends((0,i.g)({scope:a.F.User})){}},42668:(e,t,s)=>{s.d(t,{At:()=>r,Nv:()=>n,pr:()=>c});var r,i=s(77535),a=s(62149),o=s(96168);!function(e){e.GENERIC_ERROR="GENERIC_ERROR"}(r||(r={}));const n=(0,o.Vj)(r.GENERIC_ERROR,"Generic error");class c extends((0,i.k)({scope:a.F.User})){}},64904:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.changeMasterPasswordApi=void 0;const r=s(71931),i=s(60618),a=s(42394);t.changeMasterPasswordApi=(0,r.defineModuleApi)({name:"changeMasterPassword",commands:{temporarySendMasterPasswordChangedEvent:a.TemporarySendMasterPasswordChangedEventCommand},events:{masterPasswordChanged:i.MasterPasswordChangedEvent},queries:{}})},42394:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(71058),t)},71058:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TemporarySendMasterPasswordChangedEventCommand=void 0;const r=s(71931);class i extends((0,r.defineCommand)({scope:r.UseCaseScope.User})){}t.TemporarySendMasterPasswordChangedEventCommand=i},60618:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(79151),t)},79151:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MasterPasswordChangedEvent=void 0;const r=s(71931);class i extends((0,r.defineEvent)({scope:r.UseCaseScope.User})){}t.MasterPasswordChangedEvent=i},13336:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(64904),t),i(s(60618),t),i(s(42394),t)},26938:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(99314),t),i(s(13336),t),i(s(43527),t)},62884:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.sessionApi=void 0;const r=s(71931),i=s(78049),a=s(54148),o=s(25885),n=s(55998),c=s(51561),d=s(38320),l=s(95700);t.sessionApi=(0,r.defineModuleApi)({name:"session",commands:{FlushLocalDataCommand:o.FlushLocalDataCommand,PrepareLocalDataFlushCommand:o.PrepareLocalDataFlushCommand,CreateUserSessionCommand:o.CreateUserSessionCommand,OpenUserSessionCommand:o.OpenUserSessionCommand,CloseUserSessionCommand:o.CloseUserSessionCommand,DeleteLocalSessionCommand:o.DeleteLocalSessionCommand,CopyUserDataAndOpenSessionCommand:o.CopyUserDataAndOpenSessionCommand,UpdateUserSessionKeyCommand:d.UpdateUserSessionKeyCommand},queries:{selectedOpenedSession:c.SelectedOpenedSessionQuery,checkSessionKey:i.CheckSessionKeyQuery,exportSessionKey:i.ExportSessionKeyQuery,currentSessionInfo:l.CurrentSessionInfoQuery,localSessions:i.LocalSessionsQuery},events:{SessionOpenedEvent:a.SessionOpenedEvent,SessionClosingEvent:a.SessionClosingEvent,SessionClosedEvent:a.SessionClosedEvent,SessionOpeningEvent:n.SessionOpeningEvent}})},67977:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CloseUserSessionCommand=void 0;const r=s(71931);class i extends((0,r.defineCommand)({scope:r.UseCaseScope.Device})){}t.CloseUserSessionCommand=i},71988:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CreateUserSessionCommand=t.SessionAlreadyExists=t.SessionCreationErrorTypes=void 0;const r=s(71931),i=s(59420);var a;!function(e){e.AlreadyExists="alreadyExists"}(a=t.SessionCreationErrorTypes||(t.SessionCreationErrorTypes={}));class o extends((0,i.FunctionalError)(a.AlreadyExists,"The session already exists. Delete it first.")){}t.SessionAlreadyExists=o;class n extends((0,r.defineCommand)({scope:r.UseCaseScope.Device})){}t.CreateUserSessionCommand=n},44227:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DeleteLocalSessionCommand=void 0;const r=s(71931);class i extends((0,r.defineCommand)({scope:r.UseCaseScope.Device})){}t.DeleteLocalSessionCommand=i},49741:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FlushLocalDataCommand=void 0;const r=s(71931);class i extends((0,r.defineCommand)({scope:r.UseCaseScope.User})){}t.FlushLocalDataCommand=i},25885:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(49741),t),i(s(11938),t),i(s(67977),t),i(s(71988),t),i(s(35753),t),i(s(44227),t),i(s(38320),t),i(s(78438),t)},78438:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CopyUserDataAndOpenSessionCommand=void 0;const r=s(71931);class i extends((0,r.defineCommand)({scope:r.UseCaseScope.Device})){}t.CopyUserDataAndOpenSessionCommand=i},35753:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OpenUserSessionCommand=t.MultiAccountNotYetSupported=t.SessionAlreadyOpened=t.SessionNotCreated=t.SessionOpenErrorTypes=void 0;const r=s(71931),i=s(59420);var a;!function(e){e.NotCreated="notCreated",e.AlreadyOpened="alreadyOpened",e.MultiAccountNotYetSupported="multiAccountNotYetSupported"}(a=t.SessionOpenErrorTypes||(t.SessionOpenErrorTypes={}));class o extends((0,i.FunctionalError)(a.NotCreated,"The session has not been created. Create it first.")){}t.SessionNotCreated=o;class n extends((0,i.FunctionalError)(a.AlreadyOpened,"The session is already opened for this user. Close it first.")){}t.SessionAlreadyOpened=n;class c extends((0,i.FunctionalError)(a.MultiAccountNotYetSupported,"Another session is opened. Close it first.")){}t.MultiAccountNotYetSupported=c;class d extends((0,r.defineCommand)({scope:r.UseCaseScope.Device})){}t.OpenUserSessionCommand=d},11938:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PrepareLocalDataFlushCommand=void 0;const r=s(71931);class i extends((0,r.defineCommand)({scope:r.UseCaseScope.User})){}t.PrepareLocalDataFlushCommand=i},38320:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateUserSessionKeyCommand=t.UnableToUpdateSessionSessionNotOpened=t.UnableToUpdateSessionKeyForNonExistingAccount=t.ChangeSessionKeyErrorTypes=void 0;const r=s(71931),i=s(59420);var a;!function(e){e.NotCreated="notCreated",e.NotOpened="notOpened"}(a=t.ChangeSessionKeyErrorTypes||(t.ChangeSessionKeyErrorTypes={}));class o extends((0,i.FunctionalError)(a.NotCreated,"The session has not been created. Create it first.")){}t.UnableToUpdateSessionKeyForNonExistingAccount=o;class n extends((0,i.FunctionalError)(a.NotOpened,"The session has not been opened")){}t.UnableToUpdateSessionSessionNotOpened=n;class c extends((0,r.defineCommand)({scope:r.UseCaseScope.Device})){}t.UpdateUserSessionKeyCommand=c},54148:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(7180),t),i(s(780),t),i(s(1405),t),i(s(55998),t)},7180:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SessionClosedEvent=t.SessionCloseMode=void 0;const r=s(71931);!function(e){e.Close="close",e.Lock="lock"}(t.SessionCloseMode||(t.SessionCloseMode={}));class i extends((0,r.defineEvent)({scope:r.UseCaseScope.Device})){}t.SessionClosedEvent=i},780:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SessionClosingEvent=void 0;const r=s(71931);class i extends((0,r.defineEvent)({scope:r.UseCaseScope.User})){}t.SessionClosingEvent=i},1405:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SessionOpenedEvent=void 0;const r=s(71931);class i extends((0,r.defineEvent)({scope:r.UseCaseScope.User})){}t.SessionOpenedEvent=i},55998:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SessionOpeningEvent=void 0;const r=s(71931);class i extends((0,r.defineEvent)({scope:r.UseCaseScope.User})){}t.SessionOpeningEvent=i},9483:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SESSION_FEATURE_FLIPS=void 0,t.SESSION_FEATURE_FLIPS={BrazeWithDesignSystemDev:"ecommerce_web_braze_with_design_system_dev"}},99314:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(62884),t),i(s(25885),t),i(s(78049),t),i(s(54148),t),i(s(91719),t),i(s(55588),t),i(s(9483),t)},8368:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CheckSessionKeyQuery=void 0;const r=s(71931);class i extends((0,r.defineQuery)({scope:r.UseCaseScope.Device})){}t.CheckSessionKeyQuery=i},86230:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LocalSessionsQuery=t.SessionStates=void 0;const r=s(71931);t.SessionStates=Object.freeze({Open:"open",Closed:"closed",Opening:"opening"});class i extends((0,r.defineQuery)({scope:r.UseCaseScope.Device})){}t.LocalSessionsQuery=i},71417:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ExportSessionKeyQuery=void 0;const r=s(71931);class i extends((0,r.defineQuery)({scope:r.UseCaseScope.User})){}t.ExportSessionKeyQuery=i},78049:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(51561),t),i(s(8368),t),i(s(71417),t),i(s(95700),t),i(s(86230),t)},51561:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SelectedOpenedSessionQuery=void 0;const r=s(71931);class i extends((0,r.defineQuery)({scope:r.UseCaseScope.Device})){}t.SelectedOpenedSessionQuery=i},95700:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CurrentSessionInfoQuery=t.NoUserLoggedInError=t.NO_USER_LOGGED_IN=void 0;const r=s(71931),i=s(59420);t.NO_USER_LOGGED_IN="no-user-logged-in",t.NoUserLoggedInError=(0,i.defineFunctionalError)(t.NO_USER_LOGGED_IN,"User is not logged in")();class a extends((0,r.defineQuery)({scope:r.UseCaseScope.User,noUserError:t.NoUserLoggedInError})){}t.CurrentSessionInfoQuery=a},55588:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(56749),t)},56749:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SessionKeyChecker=t.CheckSessionSessionNotCreated=t.CheckSessionKeyErrorTypes=void 0;const r=s(59420);var i;!function(e){e.SessionNotCreated="notCreated"}(i=t.CheckSessionKeyErrorTypes||(t.CheckSessionKeyErrorTypes={}));class a extends((0,r.FunctionalError)(i.SessionNotCreated,"The session has not been created. Create it first.")){}t.CheckSessionSessionNotCreated=a;t.SessionKeyChecker=class{}},91719:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SessionClient=void 0;const r=s(71931),i=s(62884);class a extends((0,r.defineModuleClient)(i.sessionApi)){}t.SessionClient=a,(0,r.registerModuleClient)(i.sessionApi,a)},14729:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.vaultAccessApi=void 0;const r=s(71931),i=s(90161),a=s(66641);t.vaultAccessApi=(0,r.defineModuleApi)({name:"vaultAccess",commands:{},events:{},queries:{isAllowed:i.IsAllowedQuery,deviceLimit:a.DeviceLimitQuery}})},52744:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.VaultAccessClient=void 0;const r=s(71931),i=s(14729);class a extends((0,r.defineModuleClient)(i.vaultAccessApi)){}t.VaultAccessClient=a,(0,r.registerModuleClient)(i.vaultAccessApi,a)},43527:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(14729),t),i(s(52744),t),i(s(66641),t)},32721:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceLimitQuery=t.PlatformView=void 0;const r=s(71931);!function(e){e.Android="android",e.DesktopMacOS="macosx",e.DesktopWindows="windows",e.IPad="ipad",e.IPhone="iphone",e.IPod="ipod",e.Other="other",e.StandaloneExtension="saex",e.TeamAdminConsole="tac",e.WebApp="webapp"}(t.PlatformView||(t.PlatformView={}));class i extends((0,r.defineQuery)({scope:r.UseCaseScope.User})){}t.DeviceLimitQuery=i},66641:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(s(90161),t),i(s(32721),t)},90161:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.IsAllowedQuery=t.UserNotLogged=t.NotAllowedReason=void 0;const r=s(71931),i=s(59420);!function(e){e.DeviceLimited="DeviceLimited",e.Requires2FAEnforcement="Requires2FAEnforcement",e.RequiresSSO2MPMigration="RequiresSSO2MPMigration",e.RequiresMP2SSOMigration="RequiresMP2SSOMigration",e.RequiresSettingUpRecoveryKey="RequiresSettingUpRecoveryKey",e.RequiresSettingUpPin="RequiresSettingUpPin",e.NoActiveUser="NoActiveUser"}(t.NotAllowedReason||(t.NotAllowedReason={}));class a extends((0,i.FunctionalError)("UserNotLogged","Please log the user")){}t.UserNotLogged=a;class o extends((0,r.defineQuery)({scope:r.UseCaseScope.Device})){}t.IsAllowedQuery=o},70305:(e,t,s)=>{s.d(t,{v:()=>o});var r=s(75958),i=s(67490),a=s(98193);const o=(0,r.Q)({name:"changeMasterPassword",commands:{temporarySendMasterPasswordChangedEvent:a.n},events:{masterPasswordChanged:i.D},queries:{}})},98193:(e,t,s)=>{s.d(t,{n:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},67490:(e,t,s)=>{s.d(t,{D:()=>a});var r=s(446),i=s(62149);class a extends((0,r.d)({scope:i.F.User})){}},90475:(e,t,s)=>{s.d(t,{Q:()=>b});var r=s(75958),i=s(45911),a=s(74156),o=s(38237),n=s(5237),c=s(446),d=s(62149);class l extends((0,c.d)({scope:d.F.User})){}var u=s(66134),p=s(42858),h=s(15473),m=s(69207),g=s(37334),v=s(86334),y=s(54703),_=s(56443);class S extends((0,c.d)({scope:d.F.User})){}var f=s(66229),w=s(90032),I=s(96447);const b=(0,r.Q)({name:"session",commands:{FlushLocalDataCommand:p.e,PrepareLocalDataFlushCommand:h.X,CreateUserSessionCommand:m.lk,OpenUserSessionCommand:g.Dx,CloseUserSessionCommand:v.V,DeleteLocalSessionCommand:y.G,CopyUserDataAndOpenSessionCommand:_.k,UpdateUserSessionKeyCommand:w.yt},queries:{selectedOpenedSession:f._,checkSessionKey:i.Z,exportSessionKey:a.w,currentSessionInfo:I.EP,localSessions:o.a},events:{SessionOpenedEvent:n.M,SessionClosingEvent:l,SessionClosedEvent:u.X,SessionOpeningEvent:S}})},86334:(e,t,s)=>{s.d(t,{V:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},69207:(e,t,s)=>{s.d(t,{X0:()=>n,lk:()=>c});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.AlreadyExists="alreadyExists"}(r||(r={}));class n extends((0,o.Hu)(r.AlreadyExists,"The session already exists. Delete it first.")){}class c extends((0,i.g)({scope:a.F.Device})){}},54703:(e,t,s)=>{s.d(t,{G:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},42858:(e,t,s)=>{s.d(t,{e:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},56443:(e,t,s)=>{s.d(t,{k:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},37334:(e,t,s)=>{s.d(t,{Dx:()=>l,aK:()=>n,mR:()=>c,y9:()=>d});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.NotCreated="notCreated",e.AlreadyOpened="alreadyOpened",e.MultiAccountNotYetSupported="multiAccountNotYetSupported"}(r||(r={}));class n extends((0,o.Hu)(r.NotCreated,"The session has not been created. Create it first.")){}class c extends((0,o.Hu)(r.AlreadyOpened,"The session is already opened for this user. Close it first.")){}class d extends((0,o.Hu)(r.MultiAccountNotYetSupported,"Another session is opened. Close it first.")){}class l extends((0,i.g)({scope:a.F.Device})){}},15473:(e,t,s)=>{s.d(t,{X:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},90032:(e,t,s)=>{s.d(t,{nA:()=>c,pX:()=>n,yt:()=>d});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.NotCreated="notCreated",e.NotOpened="notOpened"}(r||(r={}));class n extends((0,o.Hu)(r.NotCreated,"The session has not been created. Create it first.")){}class c extends((0,o.Hu)(r.NotOpened,"The session has not been opened")){}class d extends((0,i.g)({scope:a.F.Device})){}},66134:(e,t,s)=>{s.d(t,{K:()=>r,X:()=>o});var r,i=s(446),a=s(62149);!function(e){e.Close="close",e.Lock="lock"}(r||(r={}));class o extends((0,i.d)({scope:a.F.Device})){}},5237:(e,t,s)=>{s.d(t,{M:()=>a});var r=s(446),i=s(62149);class a extends((0,r.d)({scope:i.F.User})){}},45911:(e,t,s)=>{s.d(t,{Z:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},38237:(e,t,s)=>{s.d(t,{U:()=>a,a:()=>o});var r=s(77535),i=s(62149);const a=Object.freeze({Open:"open",Closed:"closed",Opening:"opening"});class o extends((0,r.k)({scope:i.F.Device})){}},74156:(e,t,s)=>{s.d(t,{w:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},66229:(e,t,s)=>{s.d(t,{_:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},96447:(e,t,s)=>{s.d(t,{EP:()=>o});var r=s(77535),i=s(62149);const a=(0,s(96168).Vj)("no-user-logged-in","User is not logged in")();class o extends((0,r.k)({scope:i.F.User,noUserError:a})){}},89358:(e,t,s)=>{s.d(t,{x:()=>a});var r=s(8260),i=s(90475);class a extends((0,r.E)(i.Q)){}(0,r.K)(i.Q,a)},65766:(e,t,s)=>{s.d(t,{Y:()=>o});var r=s(75958),i=s(57755),a=s(49273);const o=(0,r.Q)({name:"vaultAccess",commands:{},events:{},queries:{isAllowed:i.bY,deviceLimit:a.X}})},49273:(e,t,s)=>{s.d(t,{X:()=>o});var r,i=s(77535),a=s(62149);!function(e){e.Android="android",e.DesktopMacOS="macosx",e.DesktopWindows="windows",e.IPad="ipad",e.IPhone="iphone",e.IPod="ipod",e.Other="other",e.StandaloneExtension="saex",e.TeamAdminConsole="tac",e.WebApp="webapp"}(r||(r={}));class o extends((0,i.k)({scope:a.F.User})){}},57755:(e,t,s)=>{s.d(t,{Oq:()=>r,bY:()=>c});var r,i=s(77535),a=s(62149),o=s(96168);!function(e){e.DeviceLimited="DeviceLimited",e.Requires2FAEnforcement="Requires2FAEnforcement",e.RequiresSSO2MPMigration="RequiresSSO2MPMigration",e.RequiresMP2SSOMigration="RequiresMP2SSOMigration",e.RequiresSettingUpRecoveryKey="RequiresSettingUpRecoveryKey",e.RequiresSettingUpPin="RequiresSettingUpPin",e.NoActiveUser="NoActiveUser"}(r||(r={}));class n extends((0,o.Hu)("UserNotLogged","Please log the user")){}class c extends((0,i.k)({scope:a.F.Device})){}},28365:(e,t,s)=>{s.d(t,{M:()=>h});var r=s(491),i=s(86006),a=s(70305),o=s(13800),n=s(92587);let c=class extends o.f{};c=(0,r.__decorate)([(0,n.GS)()],c);var d=s(98193),l=s(82874),u=s(87279);let p=class{constructor(e){this.eventEmitter=e}execute(){return this.eventEmitter.sendEvent("masterPasswordChanged",void 0),Promise.resolve((0,u.Vp)(void 0))}};p=(0,r.__decorate)([(0,l.W)(d.n),(0,r.__metadata)("design:paramtypes",[c])],p);let h=class{};h=(0,r.__decorate)([(0,i.Yl)({api:a.v,handlers:{commands:{temporarySendMasterPasswordChangedEvent:p},events:{},queries:{}},providers:[c]})],h)},32109:(e,t,s)=>{s.d(t,{P:()=>i});var r=s(94805);const i=e=>{const[,,t]=e.split("$");return"pbkdf2"===t?r.E1:r.mr}},23573:(e,t,s)=>{s.d(t,{h:()=>a});var r=s(35267),i=s(22631);class a extends i.b{async isUserIdle(e){return"idle"===await(0,r.q)(e)}}},22631:(e,t,s)=>{s.d(t,{b:()=>a});var r=s(491),i=s(92587);let a=class{};a=(0,r.__decorate)([(0,i.GS)()],a)},87918:(e,t,s)=>{s.d(t,{t:()=>u});var r=s(491),i=s(60399),a=s(14122),o=s(92587),n=s(54066),c=s(43293),d=s(48844),l=s(85603);let u=class{constructor(e,t){this.carbonLegacyClient=e,this.flexibleDecryptor=t}async decrypt(e){const{carbonStateList:t}=this.carbonLegacyClient.queries;return await(0,i.z)(t({paths:["userSession.session.localKey","userSession.session.masterPassword","userSession.session.serverKey"]}).pipe((0,d.nb)({success:([t,s,r])=>{if("string"==typeof t)return this.flexibleDecryptor.decrypt((0,n.u)(t),e);if("string"==typeof s&&"string"==typeof r){const t=r+s,i=(0,c.N)(t);return this.flexibleDecryptor.decrypt((0,n.u)(i),e)}throw new Error("Wrong types for local data key")},failure:()=>{throw new Error("Failure getting state list")}})))}};u=(0,r.__decorate)([(0,o.GS)(),(0,r.__metadata)("design:paramtypes",[a._,l.a])],u)},58813:(e,t,s)=>{s.d(t,{Y:()=>n});var r=s(491),i=s(92587),a=s(87918),o=s(81805);let n=class{constructor(e,t){this.localDataKeyDecryptor=e,this.localDatKeyaEncryptor=t}encode(e){return this.localDatKeyaEncryptor.encrypt(e)}decode(e){return this.localDataKeyDecryptor.decrypt(e)}};n=(0,r.__decorate)([(0,i.GS)(),(0,r.__metadata)("design:paramtypes",[a.t,o.n])],n)},81805:(e,t,s)=>{s.d(t,{n:()=>v});var r=s(491),i=s(60399),a=s(92587),o=s(14122),n=s(48844),c=s(94805),d=s(16698),l=s(54066),u=s(43293),p=s(7502),h=s(92402),m=s(66329),g=s(32109);let v=class{constructor(e,t,s){this.carbonLegacyClient=e,this.flexibleEncryptor=t,this.randomValuesGetter=s}async encrypt(e){const{carbonStateList:t}=this.carbonLegacyClient.queries;return await(0,i.z)(t({paths:["userSession.session.localKey","userSession.session.masterPassword","userSession.session.serverKey","userSession.personalSettings.CryptoFixedSalt","userSession.personalSettings.CryptoUserPayload"]}).pipe((0,n.nb)({success:([t,s,r,i,a])=>{if("string"==typeof t)return this.flexibleEncryptor.encrypt((0,l.u)(t),e,c.oo,d.gO);if("string"==typeof s&&"string"==typeof r){const t=r+s,o=(0,u.N)(t),n="string"==typeof a?(0,g.P)(a):c.mr,{saltLength:h}=n,m="string"===i?(0,p.R)(i):this.randomValuesGetter.get(h);return this.flexibleEncryptor.encrypt((0,l.u)(o),e,n,d.Nw,{salt:m})}throw new Error("Wrong types for local data key")},failure:()=>{throw new Error("Failure getting state list")}})))}};v=(0,r.__decorate)([(0,a.GS)(),(0,r.__metadata)("design:paramtypes",[o._,h._,m.Y])],v)},75799:(e,t,s)=>{s.d(t,{_:()=>$e});var r,i=s(491),a=s(86006),o=s(62149),n=s(90475),c=s(96168);!function(e){e.SessionNotCreated="notCreated"}(r||(r={}));class d extends((0,c.Hu)(r.SessionNotCreated,"The session has not been created. Create it first.")){}class l{}var u=s(16624),p=s(14676),h=s(87918),m=s(81805),g=s(58813),v=s(92587),y=s(85603),_=s(7502),S=s(82933),f=s(54066),w=s(95087);let I=class{constructor(e){this.flexibleDecryptor=e}decrypt(e,t){const{flexibleDecryptor:s}=this;let r;switch(t.type){case"sso":r=(0,_.R)(t.ssoKey);break;case"mp":r=(0,S.K)((0,f.u)(t.masterPassword),(0,_.R)(t.secondaryKey??""));break;default:(0,w.U)(t)}return s.decrypt(r,e)}};I=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[y.a])],I);var b=s(92402),E=s(16698);let C=class{constructor(e){this.flexibleEncryptor=e}encrypt(e,t,s){const{flexibleEncryptor:r}=this,{derivation:i,salt:a}=s,{algorithm:o}=i;if("noderivation"===o)throw new Error("Session key requires derivation");let n;switch(t.type){case"sso":n=(0,_.R)(t.ssoKey);break;case"mp":n=(0,S.K)((0,f.u)(t.masterPassword),(0,_.R)(t.secondaryKey??""));break;default:(0,w.U)(t)}return r.encrypt(n,e,i,E.Nw,{salt:(0,_.R)(a)})}};C=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[b._])],C);var A=s(87279),R=s(87065),T=s(63144),O=s(56618),D=s(10722);const U=e=>!(!e||"object"!=typeof e)&&(0===Object.keys(e).length||Object.entries(e).every((([,e])=>"object"==typeof e&&"derivation"in e&&"salt"in e)));class F extends((0,T.Q)({storeName:"sessions-crypto-settings-store",scope:o.F.Device,capacity:O.Y._010KB,persist:!0,storage:{schemaVersion:1,initialValue:{},typeGuard:U},codec:D.E})){}let P=class{constructor(e){this.sessionsCryptoSettingsStore=e}getConfig(e){return this.sessionsCryptoSettingsStore.state$.pipe((0,R.U)((t=>{if(e in t){const{derivation:s,salt:r}=t[e];return(0,A.Vp)({derivation:s,salt:r})}throw new Error("No crypto settings found for this user")})))}};P=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[F])],P);var x=s(82874),N=s(63419),G=s(42858);let k=class{constructor(e){this.storeFlusher=e}async execute(){return await this.storeFlusher.flush(),Promise.resolve((0,A.Vp)(void 0))}};k=(0,i.__decorate)([(0,x.W)(G.e),(0,i.__metadata)("design:paramtypes",[N.X])],k);var L=s(15473);let M=class{constructor(e){this.storeFlusher=e}async execute(){return await this.storeFlusher.prepare(),Promise.resolve((0,A.Vp)(void 0))}};M=(0,i.__decorate)([(0,x.W)(L.X),(0,i.__metadata)("design:paramtypes",[N.X])],M);var K=s(14122),j=s(69207),V=s(64987),z=s(60399),W=s(10370);let q=class{constructor(e,t){this.encryptor=e,this.settings=t}decode(e){const t={};for(const[s,r]of Object.entries(e))t[s]={status:"closed",encryptedLocalKey:r.encryptedLocalKey};return t}async encode(e){const t={};for(const[s,r]of Object.entries(e)){if("closed"===r.status){t[s]={encryptedLocalKey:r.encryptedLocalKey};continue}if("sso"===r.sessionKey.type)continue;if(!r.localKey){t[s]={encryptedLocalKey:null};continue}const e=await(0,z.z)(this.settings.getConfig(s));if(!(0,A.d6)(e))throw new Error("Fail to get crypto settings");t[s]={encryptedLocalKey:(0,W.s)(await this.encryptor.encrypt((0,_.R)(r.localKey),r.sessionKey,e.data))}}return t}};q=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[C,P])],q);class B extends((0,T.Q)({storeName:"sessions-state-store",scope:o.F.Device,capacity:O.Y._010KB,persist:!0,isCache:!0,codec:q,storage:{initialValue:{},schemaVersion:2,typeGuard:e=>!0,migrateStorageSchema:()=>({})}})){}const $=new V.WU;var Y=s(6220);let Q=class{constructor(e,t,s){this.carbon=e,this.store=t,this.settings=s}getLocalKey(e){const t=this.generate.bind(this),s=this.changeLocalKey.bind(this);return this.store.state$.pipe((0,Y.z)((async r=>{if(e in r){const t=r[e];if("open"!==t.status)throw new Error("Session is not open ");const s=t.localKey;return s?(0,_.R)(s):null}const i=await t();return await s(e,i),i})))}async changeLocalKey(e,t){const{store:s}=this,r=await(0,z.z)(this.settings.getConfig(e));if(!(0,A.d6)(r))throw new Error("Fail to get crypto settings");await $.runExclusive((async()=>{const r=await s.getState();if(!(e in r))throw new Error("Session is not created");const i=r[e];if("open"!==i.status)throw new Error("Session is not open");await s.set({...r,[e]:{status:"open",localKey:t?(0,W.s)(t):null,sessionKey:i.sessionKey}})}))}async generateKeyIfNotExist(e){await(0,z.z)(this.getLocalKey(e))}async generate(){const{carbonStateList:e}=this.carbon.queries,t=await(0,z.z)(e({paths:["userSession.session.localKey"]}));if((0,A.hx)(t))throw new Error("Failure getting state list");const[s]=t.data;return"string"==typeof s?(0,f.u)(s):null}};Q=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[K._,B,P])],Q);var H=s(32109);class J extends((0,T.Q)({persist:!0,codec:D.E,scope:o.F.Device,storage:{initialValue:{},schemaVersion:0,typeGuard:e=>"object"==typeof e&&null!==e&&(!("encryptionKey"in e)||"string"==typeof e.encryptionKey)},storeName:"exported-session-keys-crypto",capacity:O.Y._001KB})){}var Z=s(34987),X=s(36041);let ee=class{constructor(e,t){this.store=e,this.keyGenerator=t}async updateAndSetEncryptionKey(){const e=await this.keyGenerator.generate();return await this.store.set({encryptionKey:(0,W.s)(e)}),e}getOrCreateEncryptionKey(){return this.store.state$.pipe((0,Z.b)((async e=>e.encryptionKey?(0,_.R)(e.encryptionKey):await this.updateAndSetEncryptionKey())))}};ee=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[J,X.c])],ee);let te=class{constructor(e,t){this.cryptoManager=e,this.flexibleDecryptor=t}async import(e){const t=await(0,z.z)(this.cryptoManager.getOrCreateEncryptionKey()),s=await this.flexibleDecryptor.decrypt(t,(0,_.R)(e.content)),r=(new TextDecoder).decode(s),i=JSON.parse(r);return Promise.resolve(i)}};te=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[ee,y.a])],te);let se=class{constructor(e,t,s,r,i){this.carbon=e,this.store=t,this.localKeyRepository=s,this.encryptor=r,this.importer=i}async execute({body:{sessionKey:e,email:t,personalSettings:s}}){const r="exported"===e.type?await this.importer.import(e):e,i=await this.localKeyRepository.generate(),a=i?await this.encryptor.encrypt(i,r,{derivation:(0,H.P)(s.CryptoUserPayload),salt:s.CryptoFixedSalt}):null;return $.runExclusive((async()=>{const e=await this.store.getState();if(t in e)return(0,A.Rn)(new j.X0);switch(r.type){case"mp":{await this.store.set({...e,[t]:{status:"closed",encryptedLocalKey:a?(0,W.s)(a):null}});const s=await this.carbon.commands.openSessionWithMasterPassword({login:t,password:r.masterPassword,rememberPassword:!1,requiredPermissions:void 0,serverKey:r.secondaryKey,loginType:"MasterPassword"});if((0,A.hx)(s))throw new Error("Failed to create the session in carbon");return(0,A.Vp)(void 0)}case"sso":throw new Error("Creating a SSO session in session module is not supported");default:return(0,w.U)(r)}}))}};se=(0,i.__decorate)([(0,x.W)(j.lk),(0,i.__metadata)("design:paramtypes",[K._,B,Q,C,te])],se);var re=s(13800);let ie=class extends re.f{};ie=(0,i.__decorate)([(0,v.GS)()],ie);var ae=s(66134),oe=s(86334),ne=s(96498);let ce=class{constructor(e,t,s){this.emitter=e,this.requestContextClient=t,this.carbonLegacyClient=s}async execute({body:{email:e}}){return await this.emitter.sendEvent("sessionClosing",void 0),await this.carbonLegacyClient.commands.carbonLegacyLeeloo({name:"closeSession",arg:[{}]}),await this.emitter.sendEvent("sessionClosed",{email:e,mode:ae.K.Close}),await this.requestContextClient.commands.setActiveUser({userName:void 0}),Promise.resolve((0,A.Vp)(void 0))}};ce=(0,i.__decorate)([(0,x.W)(oe.V),(0,i.__metadata)("design:paramtypes",[ie,ne.Q,K._])],ce);var de=s(37334);let le=class{constructor(e,t,s,r){this.carbon=e,this.sessionStore=t,this.sessionKeyDecryptor=s,this.importer=r}async execute({body:{email:e,sessionKey:t,rememberPassword:s}}){const r="exported"===t.type?await this.importer.import(t):t;if("sso"===r.type)throw new Error("not implemented");const{sessionStore:i,carbon:a}=this;return await $.runExclusive((async()=>{const t=await i.getState();if(!(e in t))return(0,A.Rn)(new de.aK);if(Object.values(t).some((e=>"open"===e.status)))return(0,A.Rn)(new de.y9);const o=t[e];if("open"===o.status||"opening"===o.status)return(0,A.Rn)(new de.mR);await i.set({...t,[e]:{status:"opening",sessionKey:r,localKey:o.encryptedLocalKey?(0,W.s)(await this.sessionKeyDecryptor.decrypt((0,_.R)(o.encryptedLocalKey),r)):null}});let n=!1;try{const t=await a.commands.openSessionWithMasterPassword({login:e,password:r.masterPassword,rememberPassword:s,requiredPermissions:void 0,serverKey:r.secondaryKey,loginType:"MasterPassword"});if(!(0,A.d6)(t))throw new Error("Failed to open session in carbon");return n=!0,(0,A.Vp)(void 0)}finally{n||await i.set(t)}}))}};le=(0,i.__decorate)([(0,x.W)(de.Dx),(0,i.__metadata)("design:paramtypes",[K._,B,I,te])],le);var ue=s(6136),pe=s(46449),he=s(38237),me=s(66229);let ge=class{constructor(e){this.sessionsStateStore=e}execute(){return this.sessionsStateStore.state$.pipe((0,R.U)((e=>{let t;for(const s in e)e[s].status===he.U.Open&&(t=s);return t})),(0,ue.x)(),(0,R.U)(A.Vp))}};ge=(0,i.__decorate)([(0,pe.e)(me._),(0,i.__metadata)("design:paramtypes",[B])],ge);var ve=s(54703);let ye=class{execute(){return Promise.resolve((0,A.Vp)(void 0))}};ye=(0,i.__decorate)([(0,x.W)(ve.G)],ye);var _e=s(85798),Se=s(40923),fe=s(94805),we=s(66329);let Ie=class{constructor(e,t,s,r,i,a,o,n,c){this.carbon=e,this.sessionsStateStore=t,this.sessionsCryptoSettingsStore=s,this.eventEmitter=r,this.randomValuesGetter=i,this.localKeyRepo=a,this.encryptor=o,this.settings=n,this.context=c}async getUserCryptoSettings(){const{getUserCryptoSettings:e}=this.carbon.queries,t=await(0,z.z)(e());if(!(0,A.d6)(t))throw new Error("Fail to fetch crypto settings from carbon");const{cryptoUserPayload:s,cryptoFixedSalt:r}=t.data;return{cryptoUserPayload:s,cryptoFixedSalt:r}}async getSessionKey(e){const{getMasterPasswordAndServerKey:t,getIsSSOUser:s}=this.carbon.queries,r=await(0,z.z)(s());if(!(0,A.d6)(r))throw new Error("Fail to fetch is sso user from carbon");if(r.data||e)return{type:"sso",ssoKey:""};const i=await(0,z.z)(t());if(!(0,A.d6)(i))throw new Error("Fail to fetch master password and server key from carbon");const{password:a,serverKey:o}=i.data;return{type:"mp",masterPassword:a,secondaryKey:o}}async handleLogin(e,t){const s=await $.runExclusive((async()=>{const{cryptoUserPayload:s,cryptoFixedSalt:r}=await this.getUserCryptoSettings(),i=s?(0,H.P)(s):fe.mr,a=r||(0,W.s)(this.randomValuesGetter.get(i.saltLength)),o=await this.sessionsCryptoSettingsStore.getState();this.sessionsCryptoSettingsStore.set({...o,[e]:{derivation:i,salt:a}});const n=await this.getSessionKey(t),c=await this.sessionsStateStore.getState(),d=await this.localKeyRepo.generate();if(e in c)await this.sessionsStateStore.set({...c,[e]:{status:"open",sessionKey:n,localKey:d?(0,W.s)(d):null}});else{const t={status:"open",sessionKey:n,localKey:d?(0,W.s)(d):null};await this.sessionsStateStore.set({...c,[e]:t})}return n}));await this.context.commands.setActiveUser({userName:e}),await this.eventEmitter.sendEvent("sessionOpening",void 0),await this.eventEmitter.sendEvent("sessionOpened",{sessionKey:s,login:e})}async handleLogout(){const e=new Array;await $.runExclusive((async()=>{const t=await this.sessionsStateStore.getState(),s={};for(const[r,i]of Object.entries(t)){if("closed"===i.status){s[r]=i;continue}if("sso"===i.sessionKey.type){e.push(r);continue}const t=await(0,z.z)(this.settings.getConfig(r));if(!(0,A.d6)(t))throw new Error("Fail to get crypto settings");const a=t.data,o=i.localKey?(0,W.s)(await this.encryptor.encrypt((0,_.R)(i.localKey),i.sessionKey,a)):null;s[r]={status:"closed",encryptedLocalKey:o},e.push(r)}await this.sessionsStateStore.set(s)}));for(const t of e)await this.eventEmitter.sendEvent("sessionClosed",{mode:ae.K.Close,email:t})}async handle(e){if("carbonLoginStatusChanged"===e.body.eventName){const t=e.body.eventData;t.loggedIn?await this.handleLogin(t.login,!!t.needsSSOMigration):await this.handleLogout()}"openSessionFailed"===e.body.eventName&&this.handleLogout()}};Ie=(0,i.__decorate)([(0,_e.b)(Se.Dj),(0,i.__metadata)("design:paramtypes",[K._,B,F,ie,we.Y,Q,C,P,ne.Q])],Ie);var be=s(39988);let Ee=class{constructor(e){this.flexibleVerifier=e}verify(e,t){const{flexibleVerifier:s}=this;let r;switch(t.type){case"sso":r=(0,_.R)(t.ssoKey);break;case"mp":r=(0,S.K)((0,f.u)(t.masterPassword),(0,_.R)(t.secondaryKey??""));break;default:(0,w.U)(t)}return s.verifySignature(r,e)}};Ee=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[be.y])],Ee);let Ce=class extends l{constructor(e,t){super(),this.sessionsStateStore=e,this.verifier=t}async checkSessionKey(e,t){if("mp"!==t.type)return(0,A.Vp)(!0);const s=await(0,z.z)(this.sessionsStateStore.state$);if(!(e in s))return(0,A.Vp)(!0);const r=s[e];if("open"===r.status||"opening"===r.status)return(0,A.Vp)(function(e,t){switch(e.type){case"mp":return"mp"===t.type&&e.masterPassword===t.masterPassword&&e.secondaryKey===t.secondaryKey;case"sso":return"sso"===t.type&&e.ssoKey===t.ssoKey;default:(0,w.U)(e)}}(r.sessionKey,t));if(!r.encryptedLocalKey)return(0,A.Vp)(!0);const i=(0,_.R)(r.encryptedLocalKey);return(0,A.Vp)(await this.verifier.verify(i,t))}};Ce=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[B,Ee])],Ce);var Ae=s(45911),Re=s(162);let Te=class{constructor(e){this.checker=e}execute({body:{email:e,sessionKey:t}}){return(0,Re.D)(this.checker.checkSessionKey(e,t))}};Te=(0,i.__decorate)([(0,pe.e)(Ae.Z),(0,i.__metadata)("design:paramtypes",[l])],Te);let Oe=class{constructor(e){this.store=e}async handle({body:{user:e}}){await $.runExclusive((async()=>{const t=await this.store.getState();delete t[e],await this.store.set(t)}))}};Oe=(0,i.__decorate)([(0,_e.b)(Se.E1),(0,i.__metadata)("design:paramtypes",[B])],Oe);var De=s(90032);let Ue=class{constructor(e,t){this.store=e,this.importer=t}async execute({body:{email:e,sessionKey:t}}){const s="exported"===t.type?await this.importer.import(t):t;return await $.runExclusive((async()=>{const t=await this.store.getState();if(!(e in t))return(0,A.Rn)(new De.pX);const r=t[e];return"closed"===r.status?(0,A.Rn)(new De.nA):(t[e]={status:"open",localKey:r.localKey,sessionKey:s},await this.store.set(t),(0,A.Vp)(void 0))}))}};Ue=(0,i.__decorate)([(0,x.W)(De.yt),(0,i.__metadata)("design:paramtypes",[B,te])],Ue);var Fe=s(22631);let Pe=class{constructor(e,t){this.carbonLegacyClient=e,this.conf=t}async run(){await this.carbonLegacyClient.commands.carbonLegacyLeeloo({name:"closeSession",arg:[{}]})}async isRunnable(){const e=await(0,z.z)(this.carbonLegacyClient.queries.getPremiumStatus());if(!(0,A.d6)(e)||!e.data.spaces)return!1;const t=e.data.spaces.find((e=>"accepted"===e.status)),s=t?.info.forceAutomaticLogout;if(!s)return!1;return await this.conf.isUserIdle(60*s)}};Pe=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[K._,Fe.b])],Pe);let xe=class{constructor(e,t){this.cryptoManager=e,this.flexibleEncryptor=t}async export(e){const t=JSON.stringify(e),s=(new TextEncoder).encode(t),r=await(0,z.z)(this.cryptoManager.getOrCreateEncryptionKey()),i=await this.flexibleEncryptor.encrypt(r,s,fe.oo,E.gO);return Promise.resolve({type:"exported",content:(0,W.s)(i)})}};xe=(0,i.__decorate)([(0,v.GS)(),(0,i.__metadata)("design:paramtypes",[ee,b._])],xe);var Ne=s(74156);let Ge=class{constructor(e,t){this.store=e,this.exporter=t}execute(){return this.store.state$.pipe((0,Z.b)((async e=>{let t;for(const s in e)e[s].status===he.U.Open&&(t=s);if(!t)throw new Error("No opened session");const s=e[t];if("open"!==s.status)throw new Error("No opened session");return(0,A.Vp)(await this.exporter.export(s.sessionKey))})))}};Ge=(0,i.__decorate)([(0,pe.e)(Ne.w),(0,i.__metadata)("design:paramtypes",[B,xe])],Ge);var ke=s(96447),Le=s(77011);let Me=class{constructor(e){this.repository=e}execute(){return this.repository.getInfos().pipe((0,R.U)((({analytics:e,deviceAccessKey:t,login:s,deviceKeys:r,publicUserId:i})=>(0,A.Vp)({analytics:e,deviceAccessKey:t,login:s,deviceKeys:r,publicUserId:i}))))}};Me=(0,i.__decorate)([(0,pe.e)(ke.EP),(0,i.__metadata)("design:paramtypes",[Le.h])],Me);var Ke=s(28489),je=s(85390);let Ve=class{constructor(e,t){this.carbon=e,this.store=t}execute(){return(0,je.a)([this.carbon.queries.carbonStateList({paths:["authentication.localUsers"]}),this.store.state$]).pipe((0,R.U)((([e,t])=>{if(!(0,A.d6)(e))throw new Error("failed to get data from carbon");const[s]=e.data,r=Object.entries(t).reduce(((e,[t,r])=>({...e,[t]:(0,Ke.Ay)({login:t,deviceAccessKey:s[t].deviceAccessKey,state:r.status})})),(0,Ke.Ay)({}));return(0,A.Vp)(r)})))}};Ve=(0,i.__decorate)([(0,pe.e)(he.a),(0,i.__metadata)("design:paramtypes",[K._,B])],Ve);var ze=s(65702),We=s(25565),qe=s(56443);let Be=class{constructor(e,t,s,r,i,a){this.carbon=e,this.store=t,this.encryptor=s,this.currentSessionInfoRepository=r,this.deviceRegistration=i,this.cryptoSettingsStore=a}async execute({body:{currentEmail:e,newEmail:t,personalSettings:s}}){const r=await this.store.getState();if(!(e in r)||"open"!==r[e].status)return(0,A.Rn)({tag:"Current email is not authenticated"});const{localKey:i,sessionKey:a}=r[e];if("sso"===a.type)return(0,A.Rn)({tag:"SSO not supported yet"});const{analytics:o,deviceKeys:n,cryptoSettings:c}=await(0,z.z)(this.currentSessionInfoRepository.getInfos()),d=await this.deviceRegistration.commands.registerDevice({with:"deviceKeys",deviceAccessKey:n.accessKey,deviceSecretKey:n.secretKey,login:t,settings:s.content,userAnalyticsId:o.userId});if(!(0,A.d6)(d))return(0,A.Rn)({tag:`Device registration failed with code: ${d.error.tag}`});const l=i?await this.encryptor.encrypt((0,f.u)(i),a,{derivation:(0,H.P)(c.cryptoUserPayload),salt:c.cryptoFixedSalt}):null,u=await this.cryptoSettingsStore.getState();await this.cryptoSettingsStore.set({...u,[t]:{derivation:(0,H.P)(c.cryptoUserPayload),salt:c.cryptoFixedSalt}}),await this.store.set({...r,[e]:{status:"closed",encryptedLocalKey:l?(0,W.s)(l):null},[t]:{status:"closed",encryptedLocalKey:l?(0,W.s)(l):null}});try{const e=await this.carbon.commands.openSessionWithMasterPassword({login:t,password:a.masterPassword,rememberPassword:!1,serverKey:a.secondaryKey,loginType:"MasterPassword"});if((0,A.hx)(e))return(0,A.Rn)({tag:"Failed to open session in carbon"})}catch(e){return(0,A.Rn)({tag:"Failed to open session in carbon"})}return(0,A.Vp)(void 0)}};Be=(0,i.__decorate)([(0,x.W)(qe.k),(0,i.__metadata)("design:paramtypes",[K._,B,C,Le.h,We.z,F])],Be);let $e=class{};$e=(0,i.__decorate)([(0,a.Yl)({api:n.Q,crons:[{handler:Pe,periodInMinutes:1,name:"close-session-idle-cron",scope:o.F.User}],handlers:{commands:{flushLocalData:k,prepareLocalDataFlush:M,closeUserSession:ce,createUserSession:se,openUserSession:le,deleteLocalSession:ye,copyUserDataAndOpenSession:Be,updateUserSessionKey:Ue},events:{...(0,a.g4)(p.W,{carbonLegacy:Ie,CarbonLegacyDeviceRemotelyDeleted:Oe})},queries:{selectedOpenedSession:ge,checkSessionKey:Te,exportSessionKey:Ge,currentSessionInfo:Me,localSessions:Ve}},providers:[ie,h.t,m.n,g.Y,Q,I,C,Ee,P,q,Le.h,ze.w,{provide:l,useClass:Ce},xe,te,ee],exports:[h.t,m.n,g.Y,l,Le.h,ze.w],stores:[B,F,J],imports:[u.D],configurations:{session:{token:Fe.b}},requiredFeatureFlips:Object.values({BrazeWithDesignSystemDev:"ecommerce_web_braze_with_design_system_dev"})})],$e)},65702:(e,t,s)=>{s.d(t,{w:()=>n});var r=s(491),i=s(92587),a=s(77011),o=s(60399);let n=class{constructor(e){this.repository=e}async getDeviceCredentialsForUser(e){const t=await(0,o.z)(this.repository.getInfos());if(t.login!==e)throw new Error("Cant get the credentials of another user");return{deviceAccessKey:t.deviceKeys.accessKey,deviceSecretKey:t.deviceKeys.secretKey,login:t.login}}};n=(0,r.__decorate)([(0,i.GS)(),(0,r.__metadata)("design:paramtypes",[a.h])],n)},77011:(e,t,s)=>{s.d(t,{h:()=>l});var r=s(491),i=s(43978),a=s(14122),o=s(92587),n=s(87279),c=s(28489);function d(e,t){if((s=e)&&"object"==typeof s&&"accessKey"in s&&"secretKey"in s&&"string"==typeof s.accessKey&&"string"==typeof s.secretKey)return e;var s;if(function(e){return"string"==typeof e}(t))return function(e){const t=e.split("-");if(t.length>0){const[s]=t;return{accessKey:s,secretKey:e}}throw new Error("Invalid UKI format")}(t);throw new Error("unable to get device keys")}let l=class{constructor(e){this.carbon=e}getInfos(){return this.carbon.queries.carbonStateList({paths:["userSession.account.login","authentication.currentUser.deviceKeys","userSession.localSettings.uki","userSession.session.analyticsIds","userSession.session.publicUserId","userSession.personalSettings.CryptoUserPayload","userSession.personalSettings.CryptoFixedSalt"]}).pipe((0,i.w)((async e=>{if(!(0,n.d6)(e))throw new Error("failed to get carbon data");const[t,s,r,i,a,o,l]=e.data;if(!((u=i)&&"object"==typeof u&&"userAnalyticsId"in u&&"deviceAnalyticsId"in u&&"string"==typeof u.userAnalyticsId&&"string"==typeof u.deviceAnalyticsId))throw new Error("analytics not of type string");var u;const p=d(s,r);return(0,c.Ay)({login:String(t),deviceAccessKey:p.accessKey,analytics:{deviceId:i.deviceAnalyticsId,userId:i.userAnalyticsId},deviceKeys:p,publicUserId:a,cryptoSettings:{cryptoUserPayload:o,cryptoFixedSalt:l}})})))}};l=(0,r.__decorate)([(0,o.GS)(),(0,r.__metadata)("design:paramtypes",[a._])],l)},53061:(e,t,s)=>{s.d(t,{r:()=>$});var r=s(491),i=s(86006),a=s(11553),o=s(65766),n=s(87065),c=s(46449),d=s(87279),l=s(57755),u=s(43978),p=s(69885),h=s(37182),m=s(89618),g=s(85390),v=s(6136),y=s(92587),_=s(89422),S=s(89358),f=s(14122),w=s(56186);const I=e=>!!e?.name&&e.name!==w.s.DeviceLimitDone&&e.name!==w.s.OpeningSessionAfterDeviceLimitRemoval;var b=s(54691);let E=class{constructor(e,t){this.carbon=e,this.anomalyReporter=t,this.name="device-limit"}check(){const{liveLoginDeviceLimitFlow:e}=this.carbon.queries;return e(void 0).pipe((0,n.U)((e=>{if(!(0,d.d6)(e))return console.log("loginDeviceLimitFlow query has failed"),this.anomalyReporter.commands.reportAnomaly({criticality:"warning",message:"loginDeviceLimitFlow query has failed",moduleName:"vault-access",useCaseName:"isAllowedQuery",applicationComponent:"",anomalyType:"other"}),[];return I(e.data)?[l.Oq.DeviceLimited]:[]})))}};E=(0,r.__decorate)([(0,y.GS)(),(0,r.__metadata)("design:paramtypes",[f._,b.G])],E);var C=s(8260),A=s(78443);class R extends((0,C.E)(A.j)){}(0,C.K)(A.j,R);const T={masterPassword:!1,invisibleMasterPassword:!0};let O=class{constructor(e,t,s){this.carbon=e,this.ark=t,this.anomalyReporter=s,this.name="enforce-ark"}check(e){if(!e)throw new Error("No user login provided");const{getAccountAuthenticationType:t}=this.carbon.queries,s=t(),r=this.ark.queries.accountRecoveryKeyStatus({login:e});return(0,g.a)({accountAuthenticationType:s,accountRecoveryKeyStatus:r}).pipe((0,n.U)((({accountAuthenticationType:e,accountRecoveryKeyStatus:t})=>{if(!(0,d.d6)(e)||!(0,d.d6)(t))return console.log("One of these queries has failed: [accountAuthenticationType, accountRecoveryKeyStatus]"),this.anomalyReporter.commands.reportAnomaly({criticality:"warning",message:"One of these queries has failed: [accountAuthenticationType, accountRecoveryKeyStatus]",moduleName:"vault-access",useCaseName:"isAllowedQuery",applicationComponent:"",anomalyType:"other"}),[];return T[e.data]&&!t.data.isEnabled?[l.Oq.RequiresSettingUpRecoveryKey]:[]})))}};O=(0,r.__decorate)([(0,y.GS)(),(0,r.__metadata)("design:paramtypes",[f._,R,b.G])],O);var D=s(42303);const U={masterPassword:!1,invisibleMasterPassword:!0};let F=class{constructor(e,t,s){this.carbon=e,this.pinCode=t,this.anomalyReporter=s,this.name="enforce-pin"}check(e){if(!e)throw new Error("No user login provided");const{getAccountAuthenticationType:t}=this.carbon.queries,s=t(),r=this.pinCode.queries.getCurrentUserStatus();return(0,g.a)({accountAuthenticationType:s,pinCodeStatus:r}).pipe((0,n.U)((({accountAuthenticationType:e,pinCodeStatus:t})=>{if(!(0,d.d6)(e)||!(0,d.d6)(t))return console.log("One of these queries has failed: [accountAuthenticationType, pinCodeStatus]"),this.anomalyReporter.commands.reportAnomaly({criticality:"warning",message:"One of these queries has failed: [accountAuthenticationType, pinCodeStatus]",moduleName:"vault-access",useCaseName:"isAllowedQuery",applicationComponent:"",anomalyType:"other"}),[];return U[e.data]&&!t.data.isPinCodeEnabled?[l.Oq.RequiresSettingUpPin]:[]})))}};F=(0,r.__decorate)([(0,y.GS)(),(0,r.__metadata)("design:paramtypes",[f._,D.u,b.G])],F);var P=s(41842),x=s(83695),N=s(34445),G=s(62760);let k=class{constructor(e){this.carbon=e,this.name="enforce-two-factor-authentication"}check(){const{liveTwoFactorAuthenticationInfo:e}=this.carbon.queries;return e(void 0).pipe((0,P.h)((e=>!(0,d.d6)(e)||(e.data.status===N.dN.READY||e.data.status===N.dN.ERROR))),(0,n.U)((e=>{if(!(0,d.d6)(e))throw new Error("twoFactorAuthenticationInfo query has failed");return e.data.status===N.dN.READY&&e.data.shouldEnforceTwoFactorAuthentication?[l.Oq.Requires2FAEnforcement]:[]})),(0,x.O)([]),(0,v.x)(((e,t)=>(0,G.shallowEqualArrays)(e,t))))}};k=(0,r.__decorate)([(0,y.GS)(),(0,r.__metadata)("design:paramtypes",[f._])],k);var L=s(36636),M=s(95255);const K={[M.vX.MP_TO_SSO]:l.Oq.RequiresMP2SSOMigration,[M.vX.MP_TO_SSO_WITH_INFO]:l.Oq.RequiresMP2SSOMigration,[M.vX.SSO_TO_MP]:l.Oq.RequiresSSO2MPMigration};let j=class{constructor(e,t){this.authentication=e,this.anomalyReporter=t,this.name="sso-migration"}check(){const{getProviderInfo:e}=this.authentication.queries;return e(void 0).pipe((0,n.U)((e=>(0,d.d6)(e)?void 0!==e.data.migrationType?[K[e.data.migrationType]]:[]:(console.log("ssoMigrationType query has failed"),this.anomalyReporter.commands.reportAnomaly({criticality:"warning",message:"ssoMigrationType query has failed",moduleName:"vault-access",useCaseName:"SsoMigrationCheckerService",applicationComponent:"",anomalyType:"other"}),[]))))}};j=(0,r.__decorate)([(0,y.GS)(),(0,r.__metadata)("design:paramtypes",[L.e,b.G])],j);const V={isAllowed:!0};let z=class{constructor(e,t,s,r,i,a,o){this.session=e,this.exceptionLogger=t,this.postLoginRequirements=[s,r,i,a,o]}execute(){const{selectedOpenedSession:e}=this.session.queries;return e(void 0).pipe((0,u.w)((e=>{if(!(0,d.d6)(e))throw new Error("Failed to get active user's login");if(!e.data)return(0,p.of)({isAllowed:!1,reasons:[l.Oq.NoActiveUser]});const t=this.postLoginRequirements.map((t=>t.check(e.data).pipe((0,h.K)((()=>(console.log(`${t.name} query has failed`),this.exceptionLogger.captureException(new Error(`${t.name} query has failed`),{useCaseName:"isAllowedQuery"}),(0,p.of)([])))),(0,m.V)({first:3e3,with:()=>(console.log(`${t.name} query has timed out`),this.exceptionLogger.captureException(new Error(`${t.name} query has timed out`),{useCaseName:"isAllowedQuery"}),(0,p.of)([]))}))));return(0,g.a)(t).pipe((0,n.U)((e=>{const t=e.flat();return t.length>0?{isAllowed:!1,reasons:t}:V})),(0,v.x)())})))}};z=(0,r.__decorate)([(0,y.GS)(),(0,r.__metadata)("design:paramtypes",[S.x,_.v,E,O,F,k,j])],z);let W=class{constructor(e){this.postLoginRequirementsChecker=e}execute(){return this.postLoginRequirementsChecker.execute().pipe((0,n.U)(d.Vp))}};W=(0,r.__decorate)([(0,c.e)(l.bY),(0,r.__metadata)("design:paramtypes",[z])],W);var q=s(49273);let B=class{constructor(e){this.carbon=e}execute(){const{liveLoginDeviceLimitFlow:e}=this.carbon.queries;return e(void 0).pipe((0,n.U)((e=>{if(!(0,d.d6)(e))throw new Error("liveLoginDeviceLimitFlow failed");return(0,d.Vp)({isLimited:I(e.data)})})))}};B=(0,r.__decorate)([(0,c.e)(q.X),(0,r.__metadata)("design:paramtypes",[f._])],B);let $=class{};$=(0,r.__decorate)([(0,i.Yl)({api:o.Y,handlers:{commands:{},events:{},queries:{isAllowed:W,deviceLimit:B}},providers:[E,z,E,k,O,F,j],imports:[a.G]})],$)},67051:(e,t,s)=>{s.d(t,{J:()=>c});var r=s(75958),i=s(16362),a=s(17380),o=s(84895),n=s(11280);const c=(0,r.Q)({name:"permissions",commands:{addGroupManager:i.B,removeGroupManager:a.d},events:{permissionsLoadedEvent:o.L},queries:{userPermissions:n.l}})},16362:(e,t,s)=>{s.d(t,{B:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},17380:(e,t,s)=>{s.d(t,{d:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},84895:(e,t,s)=>{s.d(t,{L:()=>a});var r=s(446),i=s(62149);class a extends((0,r.d)({scope:i.F.User})){}},11280:(e,t,s)=>{s.d(t,{l:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},19272:(e,t,s)=>{s.d(t,{Iy:()=>a,K$:()=>o,fp:()=>i});var r=s(7165);const i=r.z.enum(["ALL","BILLING_EDIT","BILLING_READ","GROUP_CREATE","GROUP_DELETE","GROUP_EDIT","GROUP_READ"]),a=i,o=r.z.array(i)},38586:(e,t,s)=>{s.d(t,{B:()=>K});var r,i=s(491),a=s(86006),o=s(67051),n=s(90475),c=s(41511),d=s(60399),l=s(92587),u=s(53344),p=s(14122),h=s(87279),m=s(48844);!function(e){e[e.GroupManager=0]="GroupManager"}(r||(r={}));class g{async addRole({role:e,params:t}){if(0===e)return await this.addGroupManager(t)}async removeRole({role:e,params:t}){if(0===e)return await this.removeGroupManager(t)}async getSpecialUserGroupRevision(e){const{commands:{carbon:t}}=this.carbonLegacyClient,s=await t({name:"getSpecialUserGroupRevision",args:[{teamId:e}]});let r;if(!(0,h.d6)(s))throw s.error.error;{const{carbonResult:e}=s.data,{specialUserGroupRevision:t}=e;r=t}return r}async removeGroupManager({memberLogin:e,teamId:t}){const s=await this.getSpecialUserGroupRevision(t);return await(0,d.z)(this.serverApiClient.v1.teams.removeGroupManager({memberLogin:e,userGroupRevision:s}).pipe((0,m.DZ)((e=>{throw new Error(e.message)})),(0,m.lk)((e=>{if(e.data)return(0,h.Vp)(void 0);throw new Error("Unknown server error occurred while attempting to remove group manager")}))))}async addGroupManager({memberLogin:e,teamId:t}){const s=await this.getSpecialUserGroupRevision(t),{commands:{carbon:r}}=this.carbonLegacyClient,i=await r({name:"getSpecialUserGroupInviteValuesForMemberInTeam",args:[{memberLogin:e,teamId:t}]});let a="",o="";if(!(0,h.d6)(i))throw i.error.error;{const{carbonResult:e}=i.data,{groupKey:t,proposeSignature:s}=e;a=t,o=s}return await(0,d.z)(this.serverApiClient.v1.teams.addGroupManager({memberLogin:e,groupKey:a,proposeSignature:o,userGroupRevision:s}).pipe((0,m.DZ)((e=>{throw new Error(e.message)})),(0,m.lk)((e=>{if(e.data)return(0,h.Vp)(void 0);throw new Error("Unknown server error occurred while attempting to add group manager")}))))}constructor(e,t){this.serverApiClient=e,this.carbonLegacyClient=t}}g=(0,i.__decorate)([(0,l.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===u.l?Object:u.l,void 0===p._?Object:p._])],g);var v=s(63144),y=s(56618),_=s(10722),S=s(62149),f=s(19272);const w=e=>f.K$.safeParse(e).success;class I extends((0,v.Q)({storage:{schemaVersion:1,initialValue:[],typeGuard:w},persist:!0,scope:S.F.User,storeName:"permissions-store",capacity:y.Y._010KB,codec:_.E})){}var b=s(5237),E=s(85798),C=s(43978),A=s(69885),R=s(87065),T=s(13800);class O extends T.f{}O=(0,i.__decorate)([(0,l.GS)()],O);class D{async refreshState(){const{getActiveSpaces:e}=this.carbon.queries;return await(0,d.z)(e().pipe((0,C.w)((e=>{if(!(0,h.d6)(e))throw new Error("Cannot retrieve user spaces from carbon");return e.data.length?this.serverApiClient.v1.teams.getUserPermissions().pipe((0,R.U)((e=>{if((0,h.hx)(e))throw new Error(`getUserPermissions failed with error: ${e}`);this.permissionsStore.set(this.serverToDomainPermissionsMapper(e.data.data.permissions)),this.eventEmitter.sendEvent("permissionsLoaded",void 0)}))):(0,A.of)(void 0)}))))}getActiveUserPermissions(){return this.permissionsStore.state$.pipe((0,R.U)(h.Vp))}serverToDomainPermissionsMapper(e){return e.filter((e=>f.Iy.safeParse(e).success))}constructor(e,t,s,r){this.carbon=e,this.serverApiClient=t,this.permissionsStore=s,this.eventEmitter=r}}D=(0,i.__decorate)([(0,l.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===p._?Object:p._,void 0===u.l?Object:u.l,void 0===I?Object:I,void 0===O?Object:O])],D);class U{async handle(){await this.permissionsService.refreshState()}constructor(e){this.permissionsService=e}}U=(0,i.__decorate)([(0,E.b)(b.M),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D])],U);var F=s(82874),P=s(16362);class x{async execute({body:e}){return await this.roleService.addRole({role:r.GroupManager,params:e})}constructor(e){this.roleService=e}}x=(0,i.__decorate)([(0,F.W)(P.B),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===g?Object:g])],x);var N=s(17380);class G{async execute({body:e}){return await this.roleService.removeRole({role:r.GroupManager,params:e})}constructor(e){this.roleService=e}}G=(0,i.__decorate)([(0,F.W)(N.d),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===g?Object:g])],G);var k=s(11280),L=s(46449);class M{execute(){return this.permissionsService.getActiveUserPermissions()}constructor(e){this.permissionsService=e}}M=(0,i.__decorate)([(0,L.e)(k.l),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D])],M);class K{}K=(0,i.__decorate)([(0,a.Yl)({api:o.J,imports:[c.n],providers:[O,D,g],stores:[I],handlers:{commands:{addGroupManager:x,removeGroupManager:G},events:{...(0,a.g4)(n.Q,{sessionOpened:U})},queries:{userPermissions:M}}})],K)},78443:(e,t,s)=>{s.d(t,{j:()=>C});var r=s(75958),i=s(93807),a=s(22692),o=s(64261),n=s(97236),c=s(20715),d=s(88254),l=s(92043),u=s(31848),p=s(85986),h=s(22463),m=s(4842),g=s(92350),v=s(21382),y=s(38443),_=s(33608),S=s(37240),f=s(85606),w=s(31856),I=s(74062),b=s(92253),E=s(74564);const C=(0,r.Q)({name:"accountRecoveryKey",commands:{acknowledgeRecoveryActivation:i.yZ,goToActivationNextStep:a.Z,goToActivationPrevStep:o.H,requestActivation:n.e,resetActivationFlow:c.W,cancelGeneration:d.r,confirmActivation:l.W,confirmNewPassword:u.v,deactivate:p.E,submitRecoveryKey:h.Y,tryAgainRecovery:m.d,cancelRecoveryFlow:g.b,startRecoveryFlow:v.Q,clearWrongRecoveryKeyError:y.u,createPin:_.f,submitPin:S.W},queries:{shouldNotifyOfRecoveryActivation:f.a,activationFlowStatus:w.S,accountRecoveryKeyStatus:I.D,recoveryFlowStatus:b.y,recoveryMethodsInfo:E.V},events:{}})},93807:(e,t,s)=>{s.d(t,{yZ:()=>a});var r=s(13385),i=s(62149);(0,s(96168).Vj)("unable_to_acknowledge_notification","Unable to acknowledge notification");class a extends((0,r.g)({scope:i.F.User})){}},88254:(e,t,s)=>{s.d(t,{r:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},92350:(e,t,s)=>{s.d(t,{b:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},38443:(e,t,s)=>{s.d(t,{u:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},92043:(e,t,s)=>{s.d(t,{W:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},31848:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},33608:(e,t,s)=>{s.d(t,{f:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},85986:(e,t,s)=>{s.d(t,{E:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},22692:(e,t,s)=>{s.d(t,{Z:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},64261:(e,t,s)=>{s.d(t,{H:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},97236:(e,t,s)=>{s.d(t,{e:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},20715:(e,t,s)=>{s.d(t,{W:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},21382:(e,t,s)=>{s.d(t,{Q:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},37240:(e,t,s)=>{s.d(t,{W:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},22463:(e,t,s)=>{s.d(t,{Y:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},4842:(e,t,s)=>{s.d(t,{d:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},74062:(e,t,s)=>{s.d(t,{D:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},31856:(e,t,s)=>{s.d(t,{S:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},92253:(e,t,s)=>{s.d(t,{y:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},74564:(e,t,s)=>{s.d(t,{V:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},85606:(e,t,s)=>{s.d(t,{a:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},98419:(e,t,s)=>{s.d(t,{D:()=>Jt});var r=s(491),i=s(60399),a=s(78443),o=s(11433),n=s(86006),c=s(86213),d=s(50423),l=s(63604),u=s(69259),p=s(41511),h=s(16624),m=s(87279),g=s(90475),v=s(90904),y=s(41842),_=s(87065),S=s(14122),f=s(53344),w=s(92587),I=s(48844),b=s(18533),E=s(20195),C=s(62149),A=s(63144),R=s(56618);const T=e=>!(!e||"object"!=typeof e)&&"isEnabled"in e;class O extends((0,A.Q)({initialValue:{isEnabled:void 0,login:void 0},persist:!1,scope:C.F.Device,storeName:"account-recovery-key",storeTypeGuard:T,capacity:R.Y._001KB})){}const D=["email_token","totp","duo_push","dashlane_authenticator"],U=e=>"object"==typeof e&&"type"in e;var F,P=s(96168);!function(e){e.GENERIC_ERROR="GENERIC_ERROR",e.NETWORK_ERROR="NETWORK_ERROR",e.PIN_MISMATCH_ERROR="PIN_MISMATCH_ERROR",e.INITIALIZE_MACHINE_ERROR="INITIALIZE_MACHINE_ERROR",e.WRONG_RECOVERY_KEY_ERROR="WRONG_RECOVERY_KEY_ERROR",e.CHANGE_MASTER_PASSWORD_ERROR="CHANGE_MASTER_PASSWORD_ERROR"}(F||(F={}));class x extends((0,P.Hu)("NETWORK_ERROR","There is an issue with your connection")){}class N{getAuthTicketInfo(){const{carbonState:e}=this.carbon.queries;return(0,i.z)(e({path:"userSession.authTicketInfo"}).pipe((0,I.nb)({success:e=>e,failure:()=>{throw new Error("Failure getting auth ticket info")}})))}retrieveLocalAccounts(){const{carbonState:e}=this.carbon.queries;return(0,i.z)(e({path:"authentication.localAccounts"}).pipe((0,y.h)(m.d6),(0,y.h)((e=>e.data.accountsListInitialized)),(0,_.U)((e=>e.data.accountsList))))}async getCurrentPersonalSettings(){const{carbonStateList:e}=this.carbon.queries;return await(0,i.z)(e({paths:["userSession.personalSettings.AccountRecoveryKey","userSession.personalSettings.AccountRecoveryKeyId"]}).pipe((0,I.nb)({success:([e,t])=>({AccountRecoveryKey:e,AccountRecoveryKeyId:t}),failure:()=>{throw new Error("Failure getting state list")}})))}getCurrentRecoveryKey(){return this.getCurrentPersonalSettings()}getLastAuthenticatedUserRecoveryData(){return this.store.state$.pipe((0,_.U)((e=>({isEnabled:e.isEnabled,login:e.login}))))}async updateLastAuthenticatedUserRecoveryStatus(e){if(!e)throw new Error("No user login provided");const t=await(0,i.z)(this.serverApiClient.v1.accountrecovery.getStatus({login:e}));if((0,m.hx)(t))throw new Error("Server call failed");await this.store.set({isEnabled:t.data.data.enabled,login:e})}async generateRecoveryKey(){const{carbon:e}=this.carbon.commands,t={length:28,digits:!0,letters:!0,avoidAmbiguous:!0,symbols:!1};return await e({name:"generatePassword",args:[{settings:t}]})}async setPersonalSettings(e){const{updateAccountRecoveryKeyPersonalSettings:t}=this.carbon.commands;return await t(e)}async getAccountInfo(e){return await(0,i.z)(this.serverApiClient.v1.authentication.getAuthenticationMethodsForDevice({login:e,methods:D}).pipe((0,I.DZ)((e=>(0,b.EQ)(e,{BusinessError:()=>{throw new Error(F.GENERIC_ERROR)},FetchFailedError:()=>new x,InternalServerError:E.j,InvalidRequest:E.j,RateLimited:E.j,ServiceUnavailable:E.j,UnspecifiedBadStatus:E.j}))),(0,I.lk)((e=>{const t=e.data.verifications.find(U);if(t)return(0,m.Vp)({verificationMethod:t,accountType:e.data.accountType});throw new Error("Unsupported authentication method")}))))}async requestActivation(e){return await(0,i.z)(this.serverApiClient.v1.accountrecovery.requestActivation({encryptedVaultKey:e}).pipe((0,I.DZ)((e=>(0,b.EQ)(e,{BusinessError:()=>{throw new Error(F.GENERIC_ERROR)},FetchFailedError:()=>new x,UnspecifiedBadStatus:E.j,InternalServerError:E.j,InvalidRequest:E.j,RateLimited:E.j,ServiceUnavailable:E.j}))),(0,I.lk)((e=>{if(e.data.recoveryId)return(0,m.Vp)(e.data.recoveryId);throw new Error(F.GENERIC_ERROR)}))))}async confirmActivation(e){return await(0,i.z)(this.serverApiClient.v1.accountrecovery.confirmActivation({recoveryId:e}).pipe((0,I.DZ)((e=>(0,b.EQ)(e,{BusinessError:()=>{throw new Error(F.GENERIC_ERROR)},FetchFailedError:()=>new x,UnspecifiedBadStatus:E.j,InternalServerError:E.j,InvalidRequest:E.j,RateLimited:E.j,ServiceUnavailable:E.j}))),(0,I.lk)((()=>(0,m.Vp)(void 0)))))}async deactivate(e){return await(0,i.z)(this.serverApiClient.v1.accountrecovery.deactivate({reason:e}).pipe((0,I.DZ)((e=>(0,b.EQ)(e,{BusinessError:()=>{throw new Error(F.GENERIC_ERROR)},FetchFailedError:()=>new x,UnspecifiedBadStatus:E.j,InternalServerError:E.j,InvalidRequest:E.j,RateLimited:E.j,ServiceUnavailable:E.j}))),(0,I.lk)((()=>(0,m.Vp)(void 0)))))}async getEncryptedVaultKey(e,t){return await(0,i.z)(this.serverApiClient.v1.accountrecovery.getEncryptedVaultKey({login:e,authTicket:t}).pipe((0,I.DZ)((e=>(0,b.EQ)(e,{BusinessError:()=>{throw new Error(F.GENERIC_ERROR)},FetchFailedError:()=>new x,UnspecifiedBadStatus:E.j,InternalServerError:E.j,InvalidRequest:E.j,RateLimited:E.j,ServiceUnavailable:E.j}))),(0,I.lk)((e=>{const{encryptedVaultKey:t,recoveryId:s}=e.data;if(t&&s)return(0,m.Vp)({encryptedVaultKey:t,recoveryId:s});throw new Error(F.GENERIC_ERROR)}))))}constructor(e,t,s){this.store=e,this.serverApiClient=t,this.carbon=s}}N=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===O?Object:O,void 0===f.l?Object:f.l,void 0===S._?Object:S._])],N);var G=s(85603);class k{async decrypt(e,t){return(new TextDecoder).decode(await this.flexibleDecryptor.decrypt(e,t))}constructor(e){this.flexibleDecryptor=e}}k=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===G.a?Object:G.a])],k);var L=s(92402),M=s(7502),K=s(94805),j=s(16698);class V{makeDerivationConfig(e){const[,,t]=e.split("$");return"pbkdf2"===t?K.E1:K.mr}async getUserCryptoConfig(){const{carbonStateList:e}=this.carbon.queries;return await(0,i.z)(e({paths:["userSession.personalSettings.CryptoFixedSalt","userSession.personalSettings.CryptoUserPayload"]}).pipe((0,I.nb)({success:([e,t])=>{if("string"!=typeof e)throw new Error("Fixed salt is not a string");if("string"!=typeof t)throw new Error("Marker is not a string");return{fixedSalt:e,derivationConfig:this.makeDerivationConfig(t)}},failure:()=>{throw new Error("Failure getting state list")}})))}async getUserMasterPassword(){const{carbonState:e}=this.carbon.queries;return await(0,i.z)(e({path:"userSession.session.masterPassword"}).pipe((0,_.U)((e=>{if(!(0,m.d6)(e))throw new Error("Error when fetching master password from session");const t=e.data;if("string"!=typeof t)throw new Error("Result data is not a string");return(new TextEncoder).encode(t)}))))}async encrypt(e){const t=await this.getUserMasterPassword(),{derivationConfig:s,fixedSalt:r}=await this.getUserCryptoConfig();return await this.flexibleEncryptor.encrypt(e,t,s,j.Nw,{salt:(0,M.R)(r)})}constructor(e,t){this.carbon=e,this.flexibleEncryptor=t}}V=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S._?Object:S._,void 0===L._?Object:L._])],V);var z=s(10370),W=s(90318),q=s(43651),B=s(10722),$=s(7165);const Y=$.z.object({lastCheckedIntegrityKeyId:$.z.optional($.z.string())}),Q=e=>Y.safeParse(e).success;class H extends((0,A.Q)({persist:!0,storeName:"integrity",codec:B.E,scope:C.F.User,storage:{initialValue:{},schemaVersion:0,typeGuard:Q},isCache:!1,capacity:R.Y._001KB})){}var J=s(50756),Z=s(90993),X=s(89358);class ee{async executeWithParams(e,t){const s=await this.accountRecoveryKeyService.getCurrentPersonalSettings(),r={AccountRecoveryKey:e,AccountRecoveryKeyId:t};if(await this.accountRecoveryKeyService.setPersonalSettings(r),(0,m.hx)(await this.syncService.waitForSync(J.Trigger.SettingsChange)))return await this.accountRecoveryKeyService.setPersonalSettings(s),(0,m.Rn)({tag:F.GENERIC_ERROR});const a=await this.accountRecoveryKeyService.confirmActivation(t);if((0,m.hx)(a))return await this.accountRecoveryKeyService.setPersonalSettings(s),(0,m.hx)(await this.syncService.waitForSync(J.Trigger.SettingsChange))?(0,m.Rn)({tag:F.GENERIC_ERROR}):(0,m.Rn)({tag:a.error.tag});const o=await(0,i.z)(this.session.queries.selectedOpenedSession());if(!(0,m.d6)(o)||!o.data)throw new Error("No users logged in");return await this.accountRecoveryKeyService.updateLastAuthenticatedUserRecoveryStatus(o.data),Promise.resolve((0,m.Vp)(void 0))}constructor(e,t,s){this.accountRecoveryKeyService=e,this.syncService=t,this.session=s}}ee=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===N?Object:N,void 0===Z._?Object:Z._,void 0===X.x?Object:X.x])],ee);const te="authentication_ark_integrity_fixup_web_dev";class se{async shouldCheck(){const e=await this.arkService.getCurrentRecoveryKey();if(!e.AccountRecoveryKey)return!1;if((await this.store.getState()).lastCheckedIntegrityKeyId===e.AccountRecoveryKeyId)return!1;return await(0,i.z)(this.ffClient.queries.userFeatureFlip({featureFlip:te}).pipe((0,_.U)((e=>((0,m.d6)(e)&&e.data)??!1))))}async updateLastCheck(e){await this.store.set({lastCheckedIntegrityKeyId:e})}async renewEncryptedVaultKeyIfUnusuable(e,t=!1){if(!t&&!await this.shouldCheck())return;const{arkService:s,decryptor:r,encryptor:a}=this,o=await s.getCurrentRecoveryKey();if(!o.AccountRecoveryKey)return;const n=(new TextEncoder).encode(o.AccountRecoveryKey),c=await(0,i.z)(this.server.v1.accountrecovery.getAuthenticatedEncryptedVaultKey());if(!(0,m.d6)(c))throw new Error("Failed to check encrypted vault key on server side");const{data:{encryptedVaultKey:d}}=c.data,l=(0,M.R)(d);await r.decrypt(n,l)===e&&this.logger.log("ARK encryped key has been fixed!");const u=await a.encrypt(n),p=await s.requestActivation((0,z.s)(u));if(!(0,m.d6)(p))throw new Error("Could not get current encrypted VK");const h=p.data,g=await this.activationService.executeWithParams(o.AccountRecoveryKey,h);if(!(0,m.d6)(g))throw new Error("Failed to confirm");await this.updateLastCheck(h)}constructor(e,t,s,r,i,a,o,n){this.arkService=e,this.encryptor=t,this.decryptor=s,this.ffClient=r,this.server=i,this.store=a,this.logger=o,this.activationService=n}}se=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===N?Object:N,void 0===V?Object:V,void 0===k?Object:k,void 0===q.P?Object:q.P,void 0===f.l?Object:f.l,void 0===H?Object:H,void 0===W.V?Object:W.V,void 0===ee?Object:ee])],se);var re=s(9036),ie=s(85798),ae=s(5237);class oe{async handle({body:{sessionKey:e}}){if("mp"!==e.type)return;const{masterPassword:t}=e;await Promise.race([()=>new Promise((e=>setTimeout(e,100))),this.allowedToFail.doOne((()=>this.service.renewEncryptedVaultKeyIfUnusuable(t)),{methodName:"SessionOpenedEventHandler:handle",criticality:re.T.CRITICAL})])}constructor(e,t){this.service=e,this.allowedToFail=t}}oe=(0,r.__decorate)([(0,ie.b)(ae.M),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===se?Object:se,void 0===d.J?Object:d.J])],oe);var ne=s(78065),ce=s(24966),de=s(18330),le=s(57357),ue=s(8362);const pe=e=>!0;class he extends((0,A.Q)({initialValue:void 0,persist:!1,scope:C.F.Device,storeName:"activation-flow-machine",storeTypeGuard:pe})){}var me=s(65865),ge=s(18275);var ve=s(9497);class ye{async execute(){try{const e=await(0,i.z)(this.recoveryKeyService.getLastAuthenticatedUserRecoveryData());return Promise.resolve({isFeatureEnabled:e.isEnabled,recoveryKey:"",recoveryId:"",encryptedVaultKey:""})}catch(e){return Promise.reject(new Error("Unable to retrieve initialization data"))}}constructor(e){this.recoveryKeyService=e}}ye=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===N?Object:N])],ye);var _e=s(54066),Se=s(89685);class fe{async executeWithParams(e){if(e.recoveryKey)return(0,m.Vp)({recoveryKey:e.recoveryKey,encryptedVaultKey:e.encryptedVaultKey,recoveryId:e.recoveryId});const t=await this.accountRecoveryKeyService.generateRecoveryKey();if((0,m.hx)(t))return(0,m.Rn)({tag:F.GENERIC_ERROR});const s=(0,_e.u)(t.data.carbonResult.password.toUpperCase()),r=await this.recoveryKeyEncryptor.encrypt(s),i=(0,z.s)(r),a=await this.accountRecoveryKeyService.requestActivation(i);return(0,m.hx)(a)?(0,m.Rn)({tag:a.error.tag}):(0,m.Vp)({recoveryKey:(0,Se.v)(s),encryptedVaultKey:i,recoveryId:a.data})}constructor(e,t){this.accountRecoveryKeyService=e,this.recoveryKeyEncryptor=t}}fe=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===N?Object:N,void 0===V?Object:V])],fe);class we{desc(e=!1){const t={config:{predictableActionArguments:!0,schema:{events:{},context:{}},initial:"Starting",id:"ActivationFlowMachine",context:{isFeatureEnabled:!1,recoveryKey:"",recoveryId:"",encryptedVaultKey:""},states:{Starting:{invoke:{src:"initializeMachine",onDone:[{actions:["assignInitialContext"],target:"InitAccountRecoveryKeyActivation",cond:"isActivationFlow"},{actions:["assignInitialContext"],target:"GenerateNewAccountRecoveryKey"}]}},InitAccountRecoveryKeyActivation:{on:{REQUEST_ACTIVATION:{target:"RequestingActivation"}}},RequestingActivation:{invoke:{src:"requestActivation",onDone:[{cond:"isFunctionalError",actions:["assignFunctionalError"],target:"AccountRecoveryKeyActivationError"},{actions:["assignKeys"],target:"DisplayAccountRecoveryKey"}],onError:{actions:["assignGenericError"],target:"AccountRecoveryKeyActivationError"}}},DisplayAccountRecoveryKey:{on:{GO_TO_NEXT_STEP:{target:"ConfirmAccountRecoveryKey"}}},ConfirmAccountRecoveryKey:{on:{GO_TO_NEXT_STEP:{target:"FinalisingAccountRecoveryKeyActivation"},GO_TO_PREV_STEP:{target:"DisplayAccountRecoveryKey"}}},FinalisingAccountRecoveryKeyActivation:{invoke:{src:"confirmActivation",onDone:[{cond:"isFunctionalError",actions:["assignFunctionalError"],target:"AccountRecoveryKeyActivationError"},{target:"AccountRecoveryKeyActivationDone"}],onError:{actions:["assignGenericError"],target:"AccountRecoveryKeyActivationError"}}},AccountRecoveryKeyActivationDone:{},GenerateNewAccountRecoveryKey:{on:{REQUEST_ACTIVATION:{target:"RequestingActivation"},CANCEL_GENERATION:{target:"CancelNewAccountRecoveryKey"}}},CancelNewAccountRecoveryKey:{on:{GO_TO_PREV_STEP:{target:"GenerateNewAccountRecoveryKey"}}},AccountRecoveryKeyActivationError:{on:{GO_TO_PREV_STEP:{target:"RequestingActivation"}}}},on:{RESET_FLOW:{actions:["clearContext"],target:"Starting"}}},options:{actions:{assignInitialContext:(0,me.f0)({encryptedVaultKey:(e,t)=>t.data.encryptedVaultKey,recoveryKey:(e,t)=>t.data.recoveryKey,recoveryId:(e,t)=>t.data.recoveryId,isFeatureEnabled:(e,t)=>t.data.isFeatureEnabled}),assignKeys:(0,me.f0)({recoveryKey:(e,t)=>t.data.data.recoveryKey,encryptedVaultKey:(e,t)=>t.data.data.encryptedVaultKey,recoveryId:(e,t)=>t.data.data.recoveryId}),assignFunctionalError:(0,me.f0)({error:(e,t)=>t.data.error.tag}),assignGenericError:(0,me.f0)({error:()=>F.GENERIC_ERROR}),clearContext:(0,me.f0)({encryptedVaultKey:()=>"",recoveryKey:()=>"",recoveryId:()=>"",error:()=>{}})},services:{initializeMachine:()=>this.initializeMachineService.execute(),requestActivation:e=>this.requestActivationService.executeWithParams(e),confirmActivation:e=>this.confirmActivationService.executeWithParams(e.recoveryKey,e.recoveryId)},guards:{isActivationFlow:(e,t)=>function(e){return e.type.startsWith("done.invoke.ActivationFlowMachine.Starting")}(t)&&!t.data.isFeatureEnabled,isFunctionalError:(e,t)=>(function(e){return e.type.startsWith("done.invoke.ActivationFlowMachine.RequestingActivation")}(t)||function(e){return e.type.startsWith("done.invoke.ActivationFlowMachine.FinalisingAccountRecoveryKeyActivation")}(t))&&(0,m.hx)(t.data)}}};return e&&(0,ve.G)(t.config),t}create(e=!1){const{config:t,options:s}=this.desc(e);return(0,ge.C)(t,s)}constructor(e,t,s){this.initializeMachineService=e,this.requestActivationService=t,this.confirmActivationService=s,this.initializeMachineService=e,this.requestActivationService=t,this.confirmActivationService=s}}we=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ye?Object:ye,void 0===fe?Object:fe,void 0===ee?Object:ee])],we);class Ie{async prepare(){if(this.interpreter)try{const e=await(async e=>{const t=await e.getState();return t?ue.ZM.create(JSON.parse(t)):void 0})(this.activationMachineStore);try{this.interpreter.start(e)}catch(e){console.error("[ARK Activation] Unable to reuse the stored state: ",e),this.interpreter.start()}}catch(e){console.error("[ARK Activation] Unable to start machine",e)}}ready(){return new ce.X(!0)}continue(e){if(!this.interpreter)throw new Error("Activation flow not started");this.interpreter.send(e)}stop(){this.isStarted()&&(this.interpreter=void 0)}isStarted(){return Boolean(this.interpreter)}constructor(e,t,s,r){this.activationMachineStore=s,this.allowedToFail=r,this.activationMachineStore=s;const i=e.create(t);this.interpreter=ne.kJ(i).onTransition((0,de.V)((e=>{this.allowedToFail.doOne((()=>{throw e}))}))).onEvent((0,le.V)((e=>{this.allowedToFail.doOne((()=>{throw e}))}))).onTransition((async()=>{const e=this.interpreter?.getSnapshot();e&&await(async(e,t)=>{await e.set(JSON.stringify(t))})(this.activationMachineStore,e)}))}}Ie=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===we?Object:we,Boolean,void 0===he?Object:he,void 0===d.J?Object:d.J])],Ie);var be=s(8260),Ee=s(65766);class Ce extends((0,be.E)(Ee.Y)){}(0,be.K)(Ee.Y,Ce);var Ae=s(61076);class Re extends((0,A.Q)({initialValue:{},persist:!1,scope:C.F.Device,storeName:"admin-assisted-recovery-notification",capacity:R.Y._001KB})){}var Te=s(57755);class Oe{async acknowledgeRecoveryActivation(){const{commands:e}=this.carbonLegacyClient;return await e.activateAccountRecovery(),await this.store.set({seenAt:Date.now()}),(0,m.Vp)(void 0)}constructor(e,t,s){this.store=e,this.carbonLegacyClient=t,this.vaultAccessClient=s,this.getShouldNotifyOfAARActivation$=()=>{const{carbonState:e}=this.carbonLegacyClient.queries,{queries:t}=this.carbonLegacyClient,s=e({path:"userSession.session.isFirstSessionAfterAccountCreation"}),r=this.vaultAccessClient.queries.isAllowed(),i=t.getIsRecoveryEnabled(),a=t.getNodePremiumStatus(),o=t.getIsSSOUser(),n=t.getRecoveryOptInSetting();return this.store.state$.pipe((0,Ae.V)(r,i,a,o,s,n),(0,_.U)((([e,t,s,r,i,a,o])=>{if((0,m.hx)(t)||(0,m.hx)(s)||(0,m.hx)(r)||(0,m.hx)(i)||(0,m.hx)(a)||(0,m.hx)(o))throw new Error("Failed to query recovery activation notification");const n=(e=>{const t=e.seenAt;return!(!t||(s=1,r=t,Date.now()-r>=36e5*s));var s,r})(e),c=!(d=(0,m.db)(t)).isAllowed&&d.reasons.includes(Te.Oq.Requires2FAEnforcement);var d;const l=Boolean((0,m.db)(a)),u=Boolean((0,m.db)(i)),p=Boolean((0,m.db)(o)),h=Boolean((0,m.db)(s)),g=(e=>!0===e.b2bStatus?.currentTeam?.isSoftDiscontinued)((0,m.db)(r)),v=(({isFirstSessionAfterAccountCreation:e,isSSOUser:t,requires2FAEnforcement:s,accountRecoveryNotificationAlreadyAcknowledged:r,isAdminAssistedRecoveryEnabled:i,isTeamSoftDiscontinued:a,userAdminAssistedRecoveryOptIn:o})=>!(e||t||s||a||r)&&i&&!o)({isFirstSessionAfterAccountCreation:l,isSSOUser:u,requires2FAEnforcement:c,accountRecoveryNotificationAlreadyAcknowledged:n,isAdminAssistedRecoveryEnabled:h,isTeamSoftDiscontinued:g,userAdminAssistedRecoveryOptIn:p});return(0,m.Vp)(v)})))}}}Oe=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Re?Object:Re,void 0===S._?Object:S._,void 0===Ce?Object:Ce])],Oe);const De=e=>!0;class Ue extends((0,A.Q)({initialValue:void 0,persist:!1,scope:C.F.Device,storeName:"recovery-flow-machine",storeTypeGuard:De})){}class Fe{async executeWithParams(e){try{const{authTicket:t}=await this.recoveryKeyService.getAuthTicketInfo(),s=await this.recoveryKeyService.getAccountInfo(e);if((0,m.hx)(s))throw new Error("Unable to retrieve verifications methods for login");return Promise.resolve({authTiket:t??"",accountType:s.data.accountType,verificationMethod:s.data.verificationMethod})}catch(e){return Promise.reject(new Error("Unable to retrieve initialization data"))}}constructor(e){this.recoveryKeyService=e}}Fe=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===N?Object:N])],Fe);class Pe{async executeWithParams({login:e,authTicket:t,recoveryKey:s}){try{const r=await this.accountRecoveryKeyService.getEncryptedVaultKey(e,t);if((0,m.hx)(r))return Promise.reject(F.GENERIC_ERROR);const i=(0,_e.u)(s),a=(0,M.R)(r.data.encryptedVaultKey),o=await this.recoveryKeyDecryptor.decrypt(i,a);return Promise.resolve({oldPassword:o})}catch(e){return(r=e)instanceof Error&&r.message.includes("Signature cannot be verified")?Promise.reject(F.WRONG_RECOVERY_KEY_ERROR):Promise.reject(F.GENERIC_ERROR)}var r}constructor(e,t){this.accountRecoveryKeyService=e,this.recoveryKeyDecryptor=t}}Pe=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===N?Object:N,void 0===k?Object:k])],Pe);var xe=s(95075),Ne=s(25565);class Ge{async executeWithParams(e){const{commands:t}=this.carbon;try{const{cleanRemotelyRemovedProfiles:s,registerDevice:r}=this.deviceRegistration.commands,{localAccounts:a}=this.deviceRegistration.queries;await s();const o=await(0,i.z)(a());if((0,m.hx)(o))return Promise.reject(new Error(`[ARK] - Error while fetching local accounts: ${o.error}`));o.data.localAccounts.some((t=>t.login===e.login))||await r({with:"authTicket",login:e.login,authTicket:e.authTicket});const n=await t.openSessionWithMasterPassword({login:e.login,password:e.oldPassword,rememberPassword:!1,requiredPermissions:void 0,loginType:"ARK"});if((0,m.hx)(n))return Promise.reject(new Error(`[ARK] - Error while trying to open session with deciphered recovery key: ${n.error}`));const c=await t.changeMasterPassword({newPassword:e.newPassword,currentPassword:e.oldPassword,flow:xe.pT.ACCOUNT_RECOVERY_KEY});return(0,m.hx)(c)||!c.data.success?Promise.reject(new Error(`[ARK] - Error while changing user Master Password (${"failure"===c.tag?c.error:""})`)):Promise.resolve(void 0)}catch(e){return Promise.reject(new Error(`[ARK] - Unable to change user Master Password: ${e}`))}}constructor(e,t){this.carbon=e,this.deviceRegistration=t}}Ge=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S._?Object:S._,void 0===Ne.z?Object:Ne.z])],Ge);var ke=s(12436),Le=s(81822);class Me{executeWithParams(e,t){try{return this.identityVerification.commands.startIdentityVerification({login:e,verificationMethod:t.type}),Promise.resolve(void 0)}catch(e){return Promise.reject(new Error("Something went wrong..."))}}constructor(e){this.identityVerification=e,this.identityVerification=e}}Me=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ke||void 0===Le.l?Object:Le.l])],Me);var Ke=s(42303);class je{async executeWithParams(e){const{commands:t,queries:s}=this.carbon;if(e.newPinCode!==e.confirmedPinCode)return Promise.reject(F.PIN_MISMATCH_ERROR);try{const{cleanRemotelyRemovedProfiles:s,registerDevice:r}=this.deviceRegistration.commands,{localAccounts:a}=this.deviceRegistration.queries;await s();const o=await(0,i.z)(a());if((0,m.hx)(o))return Promise.reject(new Error(`[ARK] - Error while fetching local accounts: ${o.error}`));o.data.localAccounts.some((t=>t.login===e.login))||await r({with:"authTicket",login:e.login,authTicket:e.authTicket});const n=await t.openSessionWithMasterPassword({login:e.login,password:e.oldPassword,rememberPassword:!1,requiredPermissions:void 0,loginType:"ARK"});return(0,m.hx)(n)?Promise.reject(new Error(`[ARK] - Error while trying to open session with deciphered recovery key: ${n.error}`)):(await this.pinCode.commands.activate({pinCode:e.newPinCode}),Promise.resolve(void 0))}catch(e){const r=await(0,i.z)(s.carbonState({path:"userSession.account.isAuthenticated"}));return(0,m.d6)(r)&&r.data&&await t.carbonLegacyLeeloo({name:"closeSession",arg:[{}]}),Promise.reject(F.GENERIC_ERROR)}}constructor(e,t,s){this.carbon=e,this.pinCode=t,this.deviceRegistration=s}}je=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S._?Object:S._,void 0===Ke.u?Object:Ke.u,void 0===Ne.z?Object:Ne.z])],je);class Ve{desc(e=!1){const t={config:{predictableActionArguments:!0,schema:{events:{},context:{}},initial:"Idle",id:"RecoveryFlowMachine",context:{login:"",authTicket:"",newPassword:"",recoveryKey:"",oldPassword:"",encryptedVaultKey:"",newPinCode:"",confirmedPinCode:""},states:{Idle:{entry:["clearContext"],on:{START_RECOVERY_FLOW:{target:"Starting",actions:["assignAccountEmail"]}}},Starting:{invoke:{src:"initializeMachine",onDone:[{actions:["assignInitialContext"],target:"IdentityVerification",cond:"isAuthTicketNeeded"},{actions:["assignInitialContext"],target:"EnterRecoveryKey"}]}},IdentityVerification:{entry:["triggerIdentityVerification"]},EnterRecoveryKey:{on:{SUBMIT_RECOVERY_KEY:{actions:["assignRecoveryKey"],target:"CheckAccountRecoveryKey"}}},CheckAccountRecoveryKey:{invoke:{src:"checkAccountRecoveryKey",onDone:[{actions:["assignOldPassword"],cond:"isPasswordlessUser",target:"EnterPin"},{actions:["assignOldPassword"],target:"ChangeMasterPassword"}],onError:[{actions:["assignError"],cond:"isWrongRecoveryKeyError",target:"EnterRecoveryKey"},{actions:["assignError"],target:"CheckAccountRecoveryKeyError"}]}},CheckAccountRecoveryKeyError:{on:{TRY_AGAIN:{actions:["clearError"],target:"EnterRecoveryKey"}}},EnterPin:{on:{CREATE_PIN:{actions:["assignNewPinCode"],target:"ConfirmPin"}}},ConfirmPin:{on:{SUBMIT_PIN:{actions:["assignConfirmedPinCode"],target:"OpenPasswordlessSession"}}},OpenPasswordlessSession:{invoke:{src:"openSession",onDone:{target:"RecoverySuccess"},onError:[{actions:["assignError"],cond:"isPinMismatchError",target:"ConfirmPin"},{actions:["assignError"],target:"ChangeMasterPasswordError"}]}},ChangeMasterPassword:{on:{CONFIRM_NEW_PASSWORD:{actions:["assignNewPassword"],target:"FinalisingRecovery"}}},FinalisingRecovery:{invoke:{src:"changeMasterPassword",onDone:{target:"RecoverySuccess"},onError:{actions:["assignError"],target:"ChangeMasterPasswordError"}}},ChangeMasterPasswordError:{on:{TRY_AGAIN:{target:"ChangeMasterPassword"}}},RecoverySuccess:{type:"final"}},on:{CLEAR_ERROR:{actions:["clearError"]},IDENTITY_VERIFICATION_COMPLETE:{actions:["assignAuthTicket"],target:"EnterRecoveryKey"},CANCEL_RECOVERY_FLOW:{actions:["clearError"],target:"Idle"}}},options:{actions:{assignAccountEmail:(0,me.f0)({login:(e,t)=>t.login}),assignInitialContext:(0,me.f0)({authTicket:(e,t)=>t.data.authTiket,accountType:(e,t)=>t.data.accountType,verificationMethod:(e,t)=>t.data.verificationMethod}),assignAuthTicket:(0,me.f0)({authTicket:(e,t)=>t.authTicket}),assignNewPassword:(0,me.f0)({newPassword:(e,t)=>t.password}),assignRecoveryKey:(0,me.f0)({recoveryKey:(e,t)=>t.recoveryKey}),assignOldPassword:(0,me.f0)({oldPassword:(e,t)=>t.data.oldPassword}),assignNewPinCode:(0,me.f0)({newPinCode:(e,t)=>t.pinCode}),assignConfirmedPinCode:(0,me.f0)({confirmedPinCode:(e,t)=>t.pinCode}),assignError:(0,me.f0)({error:(e,t)=>t.data}),clearError:(0,me.f0)({error:()=>{}}),triggerIdentityVerification:e=>{if(!e.verificationMethod)throw new Error("No verification method found, initialization went wrong");return this.triggerIdentityVerificationService.executeWithParams(e.login,e.verificationMethod)},clearContext:(0,me.f0)({login:()=>"",newPassword:()=>"",localAccounts:()=>[],recoveryKey:()=>"",oldPassword:()=>"",encryptedVaultKey:()=>"",authTicket:()=>""})},services:{initializeMachine:e=>this.initializeMachineService.executeWithParams(e.login),checkAccountRecoveryKey:e=>this.checkAccountRecoveryKeyService.executeWithParams(e),changeMasterPassword:e=>this.changeMasterPasswordService.executeWithParams(e),openSession:e=>this.openSessionPasswordLessService.executeWithParams(e)},guards:{isAuthTicketNeeded:(e,t)=>!t.data.authTiket,isPasswordlessUser:e=>"invisibleMasterPassword"===e.accountType,isWrongRecoveryKeyError:(e,t)=>t.data===F.WRONG_RECOVERY_KEY_ERROR,isPinMismatchError:(e,t)=>t.data===F.PIN_MISMATCH_ERROR}}};return e&&(0,ve.G)(t.config),t}create(e=!1){const{config:t,options:s}=this.desc(e);return(0,ge.C)(t,s)}constructor(e,t,s,r,i){this.initializeMachineService=e,this.checkAccountRecoveryKeyService=t,this.changeMasterPasswordService=s,this.triggerIdentityVerificationService=r,this.openSessionPasswordLessService=i}}Ve=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Fe?Object:Fe,void 0===Pe?Object:Pe,void 0===Ge?Object:Ge,void 0===Me?Object:Me,void 0===je?Object:je])],Ve);class ze{async prepare(){if(this.interpreter)try{const e=await(async e=>{const t=await e.getState();return t?ue.ZM.create(JSON.parse(t)):void 0})(this.recoveryMachineStore);try{this.interpreter.start(e)}catch(e){console.error("[ARK Recovery] Unable to reuse the stored state: ",e),this.interpreter.start()}}catch(e){console.error("[ARK Recovery] Unable to start machine",e)}}ready(){return new ce.X(!0)}continue(e){if(!this.interpreter)throw new Error("Recovery flow not started");this.interpreter.send(e)}stop(){this.isStarted()&&(this.interpreter=void 0)}isStarted(){return Boolean(this.interpreter)}constructor(e,t,s,r){this.recoveryMachineStore=s,this.allowedToFail=r,this.recoveryMachineStore=s;const i=e.create(t);this.interpreter=ne.kJ(i).onTransition((0,de.V)((e=>this.allowedToFail.doOne((()=>{throw e}))))).onEvent((0,le.V)((e=>this.allowedToFail.doOne((()=>{throw e}))))).onTransition((async()=>{const e=this.interpreter?.getSnapshot();e&&await(async(e,t)=>{await e.set(JSON.stringify(t))})(this.recoveryMachineStore,e)}))}}ze=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Ve?Object:Ve,Boolean,void 0===Ue?Object:Ue,void 0===d.J?Object:d.J])],ze);var We=s(82874),qe=s(93807);class Be{execute(){return this.recoveryActivationNotification.acknowledgeRecoveryActivation()}constructor(e){this.recoveryActivationNotification=e}}Be=(0,r.__decorate)([(0,We.W)(qe.yZ),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Oe?Object:Oe])],Be);var $e=s(22692);class Ye{execute(){return this.activationFlow.continue({type:"GO_TO_NEXT_STEP"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.activationFlow=e}}Ye=(0,r.__decorate)([(0,We.W)($e.Z),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Ie?Object:Ie])],Ye);var Qe=s(64261);class He{execute(){return this.activationFlow.continue({type:"GO_TO_PREV_STEP"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.activationFlow=e}}He=(0,r.__decorate)([(0,We.W)(Qe.H),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Ie?Object:Ie])],He);var Je=s(97236);class Ze{execute(){return this.activationFlow.continue({type:"REQUEST_ACTIVATION"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.activationFlow=e}}Ze=(0,r.__decorate)([(0,We.W)(Je.e),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Ie?Object:Ie])],Ze);var Xe=s(20715);class et{execute(){return this.activationFlow.continue({type:"RESET_FLOW"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.activationFlow=e}}et=(0,r.__decorate)([(0,We.W)(Xe.W),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Ie?Object:Ie])],et);var tt=s(88254);class st{execute(){return this.activationFlow.continue({type:"CANCEL_GENERATION"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.activationFlow=e}}st=(0,r.__decorate)([(0,We.W)(tt.r),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Ie?Object:Ie])],st);var rt=s(92043);class it{execute(){return this.activationFlow.continue({type:"GO_TO_NEXT_STEP"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.activationFlow=e}}it=(0,r.__decorate)([(0,We.W)(rt.W),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Ie?Object:Ie])],it);var at=s(31848);class ot{execute(e){return this.recoveryFlow.continue({type:"CONFIRM_NEW_PASSWORD",password:e.body.password}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.recoveryFlow=e,this.recoveryFlow=e}}ot=(0,r.__decorate)([(0,We.W)(at.v),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ze?Object:ze])],ot);var nt=s(85986);class ct{async execute(e){const{reason:t}=e.body,s=await this.accountRecoveryKeyService.deactivate(t);if((0,m.hx)(s))return this.logger.trace("Deactivate ARK: "+s.error.message),(0,m.Rn)({tag:s.error.tag});const r=await(0,i.z)(this.session.queries.selectedOpenedSession());return(0,m.hx)(r)||!r.data?(this.logger.trace("Deactivate ARK: No user login provided"),(0,m.Rn)({tag:F.GENERIC_ERROR})):(await this.accountRecoveryKeyService.updateLastAuthenticatedUserRecoveryStatus(r.data),this.activationFlow.continue({type:"RESET_FLOW"}),await this.accountRecoveryKeyService.setPersonalSettings({AccountRecoveryKey:void 0,AccountRecoveryKeyId:void 0}),await this.allowedToFail.doOne((()=>this.syncService.waitForSync(J.Trigger.SettingsChange)),{methodName:"waitForSync"}),(0,m.Vp)(void 0))}constructor(e,t,s,r,i,a){this.accountRecoveryKeyService=e,this.activationFlow=t,this.syncService=s,this.logger=r,this.allowedToFail=i,this.session=a}}ct=(0,r.__decorate)([(0,We.W)(nt.E),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===N?Object:N,void 0===Ie?Object:Ie,void 0===Z._?Object:Z._,void 0===W.V?Object:W.V,void 0===d.J?Object:d.J,void 0===X.x?Object:X.x])],ct);var dt=s(22463);class lt{execute(e){return this.recoveryFlow.continue({type:"SUBMIT_RECOVERY_KEY",recoveryKey:e.body.recoveryKey}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.recoveryFlow=e}}lt=(0,r.__decorate)([(0,We.W)(dt.Y),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ze?Object:ze])],lt);var ut=s(4842);class pt{execute(){return this.recoveryFlow.continue({type:"TRY_AGAIN"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.recoveryFlow=e}}pt=(0,r.__decorate)([(0,We.W)(ut.d),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ze?Object:ze])],pt);var ht=s(92350),mt=s(53932);class gt{execute(){return this.recoveryFlow.continue({type:"CANCEL_RECOVERY_FLOW"}),this.cqrsClient.getClient(o.i).commands.cancelIdentityVerification(),Promise.resolve((0,m.Vp)(void 0))}constructor(e,t){this.recoveryFlow=e,this.cqrsClient=t,this.recoveryFlow=e}}gt=(0,r.__decorate)([(0,We.W)(ht.b),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ze?Object:ze,void 0===mt.w?Object:mt.w])],gt);var vt=s(21382);class yt{execute(e){const{login:t}=e.body;return this.recoveryFlow.continue({type:"START_RECOVERY_FLOW",login:t}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.recoveryFlow=e,this.recoveryFlow=e}}yt=(0,r.__decorate)([(0,We.W)(vt.Q),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ze?Object:ze])],yt);var _t=s(38443);class St{execute(){return this.recoveryFlow.continue({type:"CLEAR_ERROR"}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.recoveryFlow=e}}St=(0,r.__decorate)([(0,We.W)(_t.u),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ze?Object:ze])],St);var ft=s(33608);class wt{execute(e){return this.recoveryFlow.continue({type:"CREATE_PIN",pinCode:e.body.pinCode}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.recoveryFlow=e,this.recoveryFlow=e}}wt=(0,r.__decorate)([(0,We.W)(ft.f),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ze?Object:ze])],wt);var It=s(37240);class bt{execute(e){return this.recoveryFlow.continue({type:"SUBMIT_PIN",pinCode:e.body.pinCode}),Promise.resolve((0,m.Vp)(void 0))}constructor(e){this.recoveryFlow=e,this.recoveryFlow=e}}bt=(0,r.__decorate)([(0,We.W)(It.W),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ze?Object:ze])],bt);var Et=s(13089);class Ct{handle(e){const{authTicket:t}=e.body;return this.recoveryFlow.continue({type:"IDENTITY_VERIFICATION_COMPLETE",authTicket:t}),Promise.resolve()}constructor(e){this.recoveryFlow=e,this.recoveryFlow=e}}Ct=(0,r.__decorate)([(0,ie.b)(Et.w),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ze?Object:ze])],Ct);var At=s(46449),Rt=s(85606);class Tt{execute(){return this.recoveryActivationNotification.getShouldNotifyOfAARActivation$()}constructor(e){this.recoveryActivationNotification=e}}Tt=(0,r.__decorate)([(0,At.e)(Rt.a),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Oe?Object:Oe])],Tt);var Ot,Dt,Ut=s(85390),Ft=s(6136),Pt=s(31856),xt=s(69885),Nt=s(6220);!function(e){e[e.InitActivation=0]="InitActivation",e[e.RequestActivation=1]="RequestActivation",e[e.DisplayKey=2]="DisplayKey",e[e.ConfirmKey=3]="ConfirmKey",e[e.FinaliseActivation=4]="FinaliseActivation",e[e.ActivationDone=5]="ActivationDone",e[e.ShowError=6]="ShowError",e[e.GenerateNewKey=7]="GenerateNewKey",e[e.CancelGenerateNewKey=8]="CancelGenerateNewKey"}(Ot||(Ot={})),function(e){e[e.InitRecovery=0]="InitRecovery",e[e.IdentityVerification=1]="IdentityVerification",e[e.EnterRecoveryKey=2]="EnterRecoveryKey",e[e.ChangeMasterPassword=3]="ChangeMasterPassword",e[e.EnterPin=4]="EnterPin",e[e.ConfirmPin=5]="ConfirmPin",e[e.Finalising=6]="Finalising",e[e.Success=7]="Success",e[e.Failure=8]="Failure"}(Dt||(Dt={}));const Gt=e=>(0,xt.of)((0,m.Vp)(function(e){if(!e.matches("Starting"))return e.matches("InitAccountRecoveryKeyActivation")?{step:Ot.InitActivation,isFeatureEnabled:e.context.isFeatureEnabled}:e.matches("RequestingActivation")?{step:Ot.RequestActivation,isFeatureEnabled:e.context.isFeatureEnabled}:e.matches("DisplayAccountRecoveryKey")?{step:Ot.DisplayKey,recoveryKey:e.context.recoveryKey,isFeatureEnabled:e.context.isFeatureEnabled}:e.matches("ConfirmAccountRecoveryKey")?{step:Ot.ConfirmKey,recoveryKey:e.context.recoveryKey,isFeatureEnabled:e.context.isFeatureEnabled}:e.matches("FinalisingAccountRecoveryKeyActivation")?{step:Ot.FinaliseActivation,isFeatureEnabled:e.context.isFeatureEnabled}:e.matches("AccountRecoveryKeyActivationDone")?{step:Ot.ActivationDone,isFeatureEnabled:e.context.isFeatureEnabled}:e.matches("AccountRecoveryKeyActivationError")?{step:Ot.ShowError,error:e.context.error,isFeatureEnabled:e.context.isFeatureEnabled}:e.matches("GenerateNewAccountRecoveryKey")?{step:Ot.GenerateNewKey,isFeatureEnabled:e.context.isFeatureEnabled}:e.matches("CancelNewAccountRecoveryKey")?{step:Ot.CancelGenerateNewKey,isFeatureEnabled:e.context.isFeatureEnabled}:void console.warn("[ARK Activation] - No view associated to state ",e.value)}(e))),kt=e=>e.pipe((0,Nt.z)(Gt));var Lt=s(52800);const Mt=(e,t)=>{const s=t.matches(e.value),r=(0,Lt.Z)(e.context,t.context);return s&&r};class Kt{execute(){return(0,Ut.a)([(e=this.activationFlowMachineStore,e.state$.pipe((0,_.U)((e=>e?ue.ZM.create(JSON.parse(e)):void 0)))),this.activationFlow.ready()],((e,t)=>{if(e&&t)return e})).pipe((0,y.h)(Boolean),(0,Ft.x)(((e,t)=>Mt(e,t))),kt);var e}constructor(e,t){this.activationFlow=e,this.activationFlowMachineStore=t}}Kt=(0,r.__decorate)([(0,At.e)(Pt.S),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Ie?Object:Ie,void 0===he?Object:he])],Kt);var jt=s(43978),Vt=s(74062);class zt{execute({body:e}){const{login:t}=e;return""===t?(0,xt.of)((0,m.Vp)({isEnabled:!1})):this.accountRecoveryKeyService.getLastAuthenticatedUserRecoveryData().pipe((0,jt.w)((async e=>(void 0!==e.isEnabled&&t===e.login||await this.accountRecoveryKeyService.updateLastAuthenticatedUserRecoveryStatus(t),e))),(0,_.U)((e=>(0,m.Vp)({isEnabled:e.isEnabled}))))}constructor(e){this.accountRecoveryKeyService=e}}zt=(0,r.__decorate)([(0,At.e)(Vt.D),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===N?Object:N])],zt);var Wt=s(74564);class qt{execute(){const e=this.session.queries.selectedOpenedSession().pipe((0,jt.w)((e=>{if(!(0,m.d6)(e)||!e.data)throw new Error("no user provided ");return this.accountRecoveryKeyService.updateLastAuthenticatedUserRecoveryStatus(e.data)})),(0,jt.w)((()=>this.carbonLegacyClient.queries.carbonState({path:"userSession.personalSettings.RecoveryOptIn"}))),(0,y.h)(m.d6),(0,_.U)((e=>"boolean"==typeof e.data&&e.data))),t=this.accountRecoveryKeyService.getLastAuthenticatedUserRecoveryData().pipe((0,_.U)((e=>void 0!==e.isEnabled&&e.isEnabled)));return(0,Ut.a)([e,t]).pipe((0,_.U)((([e,t])=>(0,m.Vp)({adminAssistedRecovery:e,accountRecoveryKey:t}))))}constructor(e,t,s){this.accountRecoveryKeyService=e,this.carbonLegacyClient=t,this.session=s}}qt=(0,r.__decorate)([(0,At.e)(Wt.V),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===N?Object:N,void 0===S._?Object:S._,void 0===X.x?Object:X.x])],qt);var Bt=s(92253);const $t=e=>(0,xt.of)((0,m.Vp)(function(e){return e.matches("Starting")?{step:Dt.InitRecovery,error:e.context.error}:e.matches("IdentityVerification")?{step:Dt.IdentityVerification,login:e.context.login}:e.matches("EnterRecoveryKey")||e.matches("CheckAccountRecoveryKey")?{step:Dt.EnterRecoveryKey,error:e.context.error,accountType:e.context.accountType}:e.matches("ChangeMasterPassword")?{step:Dt.ChangeMasterPassword,error:e.context.error}:e.matches("EnterPin")?{step:Dt.EnterPin,error:e.context.error}:e.matches("ConfirmPin")?{step:Dt.ConfirmPin,error:e.context.error,pinCode:e.context.newPinCode}:e.matches("FinalisingRecovery")||e.matches("OpenPasswordlessSession")?{step:Dt.Finalising}:e.matches("RecoverySuccess")?{step:Dt.Success}:e.matches("CheckAccountRecoveryKeyError")||e.matches("ChangeMasterPasswordError")?{step:Dt.Failure}:void console.warn("[ARK Recovery] - No view associated to state ",e.value)}(e))),Yt=e=>e.pipe((0,Nt.z)($t));class Qt{execute(){return(0,Ut.a)([(e=this.recoveryFlowMachineStore,e.state$.pipe((0,_.U)((e=>e?ue.ZM.create(JSON.parse(e)):void 0)))),this.recoveryFlow.ready()],((e,t)=>{if(e&&t)return e})).pipe((0,y.h)(Boolean),(0,Ft.x)(((e,t)=>Mt(e,t))),Yt);var e}constructor(e,t){this.recoveryFlow=e,this.recoveryFlowMachineStore=t}}Qt=(0,r.__decorate)([(0,At.e)(Bt.y),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ze?Object:ze,void 0===Ue?Object:Ue])],Qt);class Ht{async executeWithParams(e,t){const s=await this.accountRecoveryKeyService.deactivate(t);return(0,m.hx)(s)?(this.logger.trace("Deactivate ARK: "+s.error.message),(0,m.Rn)({tag:s.error.tag})):(await this.accountRecoveryKeyService.updateLastAuthenticatedUserRecoveryStatus(e),this.activationFlow.continue({type:"RESET_FLOW"}),await this.accountRecoveryKeyService.setPersonalSettings({AccountRecoveryKey:void 0,AccountRecoveryKeyId:void 0}),await this.allowedToFail.doOne((()=>this.syncService.waitForSync(J.Trigger.SettingsChange)),{methodName:"waitForSync"}),(0,m.Vp)(void 0))}constructor(e,t,s,r,i){this.accountRecoveryKeyService=e,this.activationFlow=t,this.syncService=s,this.logger=r,this.allowedToFail=i}}Ht=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===N?Object:N,void 0===Ie?Object:Ie,void 0===Z._?Object:Z._,void 0===W.V?Object:W.V,void 0===d.J?Object:d.J])],Ht);class Jt{}Jt=(0,r.__decorate)([(0,n.Yl)({api:a.j,stores:[he,Ue,O,Re,H],imports:[p.n,h.D,v.R],handlers:{commands:{acknowledgeRecoveryActivation:Be,goToActivationNextStep:Ye,goToActivationPrevStep:He,requestActivation:Ze,resetActivationFlow:et,cancelGeneration:st,confirmActivation:it,confirmNewPassword:ot,deactivate:ct,submitRecoveryKey:lt,tryAgainRecovery:pt,cancelRecoveryFlow:gt,startRecoveryFlow:yt,clearWrongRecoveryKeyError:St,createPin:wt,submitPin:bt},events:{...(0,n.g4)(o.i,{identityVerificationCompleted:Ct}),...(0,n.g4)(g.Q,{sessionOpened:oe})},queries:{shouldNotifyOfRecoveryActivation:Tt,activationFlowStatus:Kt,accountRecoveryKeyStatus:zt,recoveryMethodsInfo:qt,recoveryFlowStatus:Qt}},providers:[...(0,c.H)(Ie,{inject:[we,he,l.c,d.J],asyncFactory:async(e,t,s,r)=>{let a=!1;const o=await(0,i.z)(s.queries.platformInfo());!(0,m.d6)(o)||o.data.buildType!==u.P.DEV&&o.data.buildType!==u.P.NIGHTLY||(a=!0);const n=new Ie(e,a,t,r);return await n.prepare(),n}}),...(0,c.H)(ze,{inject:[Ve,Ue,l.c,d.J],asyncFactory:async(e,t,s,r)=>{let a=!1;const o=await(0,i.z)(s.queries.platformInfo());!(0,m.d6)(o)||o.data.buildType!==u.P.DEV&&o.data.buildType!==u.P.NIGHTLY||(a=!0);const n=new ze(e,a,t,r);return await n.prepare(),n}}),we,Ve,ye,Fe,Pe,Me,N,fe,ee,k,V,Ge,je,Ht,se,Oe],requiredFeatureFlips:[te]})],Jt)},66811:(e,t,s)=>{s.d(t,{X:()=>d});var r=s(75958),i=s(45315),a=s(2551),o=s(43179),n=s(95822),c=s(6641);const d=(0,r.Q)({name:"accountCreation",commands:{createPasswordlessAccount:i.ck,markMassDeployFirstInitDone:a.$,requestTeamInviteTokenSending:o.V},events:{},queries:{accountCreationMassDeployPolicies:n.d,inviteLinkData:c.$}})},45315:(e,t,s)=>{s.d(t,{G2:()=>a,ck:()=>o});var r=s(13385),i=s(62149);const a=(0,s(96168).Vj)("NetworkError","The user appears offline");class o extends((0,r.g)({scope:i.F.Device})){}},2551:(e,t,s)=>{s.d(t,{$:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},43179:(e,t,s)=>{s.d(t,{V:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},95822:(e,t,s)=>{s.d(t,{d:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},6641:(e,t,s)=>{s.d(t,{$:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},57978:(e,t,s)=>{s.d(t,{v:()=>c});var r=s(75958),i=s(62508),a=s(25298),o=s(58402),n=s(77588);const c=(0,r.Q)({name:"accountManagement",commands:{initChangeLoginEmail:i.j,completeChangeLoginEmail:a.b,resendVerificationCode:o.h},events:{},queries:{changeLoginEmailStatus:n.w}})},25298:(e,t,s)=>{s.d(t,{b:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},62508:(e,t,s)=>{s.d(t,{j:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},58402:(e,t,s)=>{s.d(t,{h:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},77588:(e,t,s)=>{s.d(t,{v:()=>r,w:()=>o});var r,i=s(77535),a=s(62149);!function(e){e.TOKEN_VALIDATION_FAILED="TOKEN_VALIDATION_FAILED",e.LOGIN_CHANGE_FAILED="LOGIN_CHANGE_FAILED"}(r||(r={}));class o extends((0,i.k)({scope:a.F.Device})){}},35936:(e,t,s)=>{s.d(t,{l:()=>n});var r=s(75958),i=s(32389),a=s(59020),o=s(75449);const n=(0,r.Q)({name:"accountReferral",commands:{inviteByEmail:i.PI},events:{},queries:{getSharingLink:a.h,getInvitationsHistory:o.g}})},32389:(e,t,s)=>{s.d(t,{PI:()=>o,qM:()=>a});var r=s(13385),i=s(62149);const a=(0,s(96168).Vj)("user_already_exists","The user invited already exists");class o extends((0,r.g)({scope:i.F.User})){}},75449:(e,t,s)=>{s.d(t,{g:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},59020:(e,t,s)=>{s.d(t,{h:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},12892:(e,t,s)=>{s.d(t,{d:()=>c});var r=s(75958),i=s(84238),a=s(68817),o=s(81377),n=s(65104);const c=(0,r.Q)({name:"deleteOrResetAccount",commands:{completeFlow:i.I,initiateFlow:a.O},events:{},queries:{userAuthenticationMethod:o.c,isFlowCompleted:n.h}})},84238:(e,t,s)=>{s.d(t,{I:()=>n,O:()=>r});var r,i=s(13385),a=s(62149),o=s(7165);!function(e){e.INVALID_OTP_ALREADY_USED="INVALID_OTP_ALREADY_USED",e.INVALID_OTP_BLOCKED="INVALID_OTP_BLOCKED",e.VERIFICATION_FAILED="VERIFICATION_FAILED",e.ACCOUNT_BLOCKED_CONTACT_SUPPORT="ACCOUNT_BLOCKED_CONTACT_SUPPORT",e.VERIFICATION_REQUIRES_REQUEST="VERIFICATION_REQUIRES_REQUEST",e.VERIFICATION_TIMEOUT="VERIFICATION_TIMEOUT"}(r||(r={})),o.z.object({tag:o.z.nativeEnum(r)});class n extends((0,i.g)({scope:a.F.Device})){}},68817:(e,t,s)=>{s.d(t,{O:()=>n,U:()=>r});var r,i=s(13385),a=s(62149),o=s(7165);!function(e){e.UNKNOWN_USER="user_not_found",e.SSO_BLOCKED="SSO_BLOCKED"}(r||(r={})),o.z.object({tag:o.z.nativeEnum(r)});class n extends((0,i.g)({scope:a.F.Device})){}},65104:(e,t,s)=>{s.d(t,{h:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},81377:(e,t,s)=>{s.d(t,{c:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},20691:(e,t,s)=>{s.d(t,{N:()=>a});var r=s(75958),i=s(25200);const a=(0,r.Q)({name:"subscriptionCode",commands:{},events:{},queries:{getSubscriptionCode:i.aD}})},95115:(e,t,s)=>{s.d(t,{_:()=>a});var r=s(8260),i=s(20691);class a extends((0,r.E)(i.N)){}(0,r.K)(i.N,a)},25200:(e,t,s)=>{s.d(t,{KJ:()=>a,aD:()=>o});var r=s(77535),i=s(62149);const a=(0,s(96168).Vj)("no_key_for_user","The user appears offline");class o extends((0,r.k)({scope:i.F.User})){}},63481:(e,t,s)=>{s.d(t,{Z:()=>fe});var r=s(491),i=s(66811),a=s(86006),o=s(41511),n=s(16624),c=s(45368);var d=s(87279),l=s(92587);class u{}class p extends u{async retrieveAccountCreationBrowserPolicies(){try{const e=await(0,c.U)();return void 0===e?(0,d.Vp)({teamKey:"",isExtensionMassDeployed:!1}):(0,d.Vp)({teamKey:e.team_key||"",isExtensionMassDeployed:e.is_extension_mass_deployed||!1})}catch{return(0,d.Vp)({teamKey:"",isExtensionMassDeployed:!1})}}}p=(0,r.__decorate)([(0,l.GS)()],p);var h=s(62149),m=s(63144),g=s(56618),v=s(10722);const y=e=>!(!e||"object"!=typeof e)&&("firstMassDeployOpening"in e&&"teamKey"in e);class _ extends((0,m.Q)({codec:v.E,persist:!0,scope:h.F.Device,storeName:"account-creation-browser-policies-store",capacity:g.Y._001KB,storage:{schemaVersion:1,initialValue:{firstMassDeployOpening:!0,teamKey:""},typeGuard:y}})){}class S{async onFrameworkInit(){const{firstMassDeployOpening:e}=await this.acBrowserPoliciesStore.getState(),t=await this.massDeployBrowserPoliciesService.retrieveAccountCreationBrowserPolicies();(0,d.ty)(t,(({teamKey:t,isExtensionMassDeployed:s})=>{this.acBrowserPoliciesStore.set({teamKey:t,firstMassDeployOpening:e&&s})}))}constructor(e,t){this.acBrowserPoliciesStore=e,this.massDeployBrowserPoliciesService=t}}S=(0,r.__decorate)([(0,l.ar)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===_?Object:_,void 0===u?Object:u])],S);var f,w,I=s(7165);!function(e){e.LOADING="loading",e.NOT_LOADED="not_loaded",e.READY="ready"}(f||(f={})),function(e){e.TEAM_DOES_NOT_EXIST="TEAM_DOES_NOT_EXIST",e.USER_NOT_PROPOSED_IN_TEAM="USER_NOT_PROPOSED_IN_TEAM",e.USER_TEAM_INVITE_TOKEN_NOT_FOUND="USER_TEAM_INVITE_TOKEN_NOT_FOUND"}(w||(w={})),I.z.object({tag:I.z.nativeEnum(w)});class b extends((0,m.Q)({persist:!1,scope:h.F.Device,storeName:"invite-link-store",initialValue:{status:f.NOT_LOADED},capacity:g.Y._001KB})){}var E=s(82874),C=s(45315),A=s(14122),R=s(18533),T=s(85465),O=s(60399),D=s(41842),U=s(89358),F=s(42303),P=s(63604),x=s(53344),N=s(66329),G=s(92402),k=s(48702),L=s(20195),M=s(78776);const K="ZZ";function j(e){return!e||e.length<2||e.length>5?K:e}const V="und";function z(e){return!e||e.length<2||e.length>5?V:e}const W="Device";function q(e){return e||W}function B(e){return e?e.replace(/https?:\/\//g," "):e}function $(){return`{${(0,M.Z)().toUpperCase()}}`}var Y=s(10370),Q=s(21131),H=s(86286),J=s(9034),Z=s(94805),X=s(16698),ee=s(25565);class te{async createAccount({login:e,accountType:t,password:s,consents:r,deviceName:i}){const a=await(0,O.z)(this.platformInfoClient.queries.platformInfo());if(!(0,d.d6)(a))throw new Error("failed to get platform info");const o=a.data,n=Math.round(Date.now()/1e3),c=this.random.get(16),l=function({AnonymousUserId:e,CryptoFixedSalt:t,CryptoUserPayload:s,UsagelogToken:r,accountCreationDatetime:i}){return`<?xml version="1.0" encoding="UTF-8"?>\n<root>\n    <KWSettingsManagerApp> \n        <KWDataItem key="AnonymousUserId"><![CDATA[${e}]]></KWDataItem>\n        <KWDataItem key="CryptoFixedSalt"><![CDATA[${t}]]></KWDataItem>\n        <KWDataItem key="CryptoUserPayload"><![CDATA[${s}]]></KWDataItem>  \n        <KWDataItem key="SyncBackup"><![CDATA[YES]]></KWDataItem>\n        <KWDataItem key="UsagelogToken"><![CDATA[${r}]]></KWDataItem>\n        <KWDataItem key="accountCreationDatetime"><![CDATA[${i}]]></KWDataItem>\n    </KWSettingsManagerApp>\n</root>`}({accountCreationDatetime:n,AnonymousUserId:$(),CryptoFixedSalt:(0,Y.s)(c),CryptoUserPayload:"$1$argon2d$16$3$32768$2$aes256$cbchmac$16$",Login:e,UsagelogToken:$()}),u=(0,Q.n)((new TextEncoder).encode(l)),p=async e=>await this.flexibleEncryptor.encrypt((new TextEncoder).encode(s),e,Z.mr,X.Nw,{salt:c}),h=await p(u),{privateKey:m,publicKey:g}=await this.rsaKeyGenerator.generate(),v=(0,H.R)(m),y=(0,J.y)(g),_=await p((new TextEncoder).encode(v));if("server_carbon_unknown"===o.platformName)throw new Error("Invalid platform info");const S=await(0,O.z)(this.serverApiClient.v1.account.createUser({appVersion:o.appVersion,consents:[{consentType:"emailsOffersAndTips",status:r.offers},{consentType:"privacyPolicyAndToS",status:r.tosAndPrivacy}],country:j(o.country),deviceName:q(B(i)),language:z(o.lang),login:e,osCountry:j(o.country),osLanguage:z(o.lang),platform:o.platformName,settings:{time:n,content:(0,Y.s)(h)},sharingKeys:{publicKey:y,privateKey:(0,Y.s)(_)},temporaryDevice:!1,accountType:t,contactEmail:e}));if(!(0,d.d6)(S))return(0,R.EQ)(S.error,{BusinessError:()=>(0,L.j)("failed to create account"),FetchFailedError:()=>(0,d.Rn)((0,C.G2)()),InternalServerError:()=>(0,L.j)("failed to create account"),InvalidRequest:()=>(0,L.j)("failed to create account"),RateLimited:()=>(0,L.j)("failed to create account"),ServiceUnavailable:()=>(0,L.j)("failed to create account"),UnspecifiedBadStatus:()=>(0,L.j)("failed to create account")});const{deviceAccessKey:f,deviceSecretKey:w,userAnalyticsId:I}=S.data.data,b=await this.deviceRegistration.commands.registerDevice({with:"deviceKeys",deviceAccessKey:f,deviceSecretKey:w,login:e,settings:(0,Y.s)(h),userAnalyticsId:I,deviceName:i,ignoreAlreadyRegisteredError:!0});return(0,d.d6)(b)?(0,d.Vp)(void 0):(0,R.EQ)(b.error,{DeviceAlreadyRegistered:()=>(0,L.j)("failed to register device in carbon"),InvalidTokenError:()=>(0,L.j)("failed to register device in carbon"),NetworkError:()=>(0,d.Rn)((0,C.G2)())})}constructor(e,t,s,r,i,a){this.serverApiClient=e,this.platformInfoClient=t,this.random=s,this.flexibleEncryptor=r,this.rsaKeyGenerator=i,this.deviceRegistration=a}}te=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===x.l?Object:x.l,void 0===P.c?Object:P.c,void 0===N.Y?Object:N.Y,void 0===G._?Object:G._,void 0===k.e?Object:k.e,void 0===ee.z?Object:ee.z])],te);const se={avoidAmbiguous:!1,length:40,letters:!0,digits:!0,symbols:!0};class re{async execute({body:{consents:e,email:t,pinCode:s,deviceName:r}}){const i=(0,T.generate)(se),a=await this.creator.createAccount({accountType:"invisibleMasterPassword",login:t,consents:e,password:i,deviceName:r});if(!(0,d.d6)(a))return(0,R.EQ)(a.error,{NetworkError:e=>(0,d.Rn)(e)});const o=await this.carbon.commands.openSessionWithMasterPassword({login:t,password:i,rememberPassword:!1,requiredPermissions:void 0,loginType:"CreatedPasswordlessAccount"});if(!(0,d.d6)(o))throw new Error("failed to login in carbon");return await(0,O.z)(this.session.queries.selectedOpenedSession().pipe((0,D.h)((e=>(0,d.d6)(e)&&e.data===t)))),await this.pinCode.commands.activate({pinCode:s}),(0,d.Vp)(void 0)}constructor(e,t,s,r){this.creator=e,this.carbon=t,this.session=s,this.pinCode=r}}re=(0,r.__decorate)([(0,E.W)(C.ck),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===te?Object:te,void 0===A._?Object:A._,void 0===U.x?Object:U.x,void 0===F.u?Object:F.u])],re);var ie=s(2551);class ae{async execute(){const e=await this.acBrowserPoliciesStore.getState();return this.acBrowserPoliciesStore.set({...e,firstMassDeployOpening:!1}),(0,d.Vp)(void 0)}constructor(e){this.acBrowserPoliciesStore=e}}ae=(0,r.__decorate)([(0,E.W)(ie.$),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===_?Object:_])],ae);var oe=s(43179),ne=s(48844);class ce{constructor(e,t){this.serverApiClient=e,this.inviteLinkStore=t,this.getFunctionalError=e=>{switch(e){case w.TEAM_DOES_NOT_EXIST:return{tag:w.TEAM_DOES_NOT_EXIST};case w.USER_NOT_PROPOSED_IN_TEAM:return{tag:w.USER_NOT_PROPOSED_IN_TEAM};case w.USER_TEAM_INVITE_TOKEN_NOT_FOUND:return{tag:w.USER_TEAM_INVITE_TOKEN_NOT_FOUND};default:throw new Error(`RequestTeamInviteToken: error ${e}`)}},this.loadInviteLinkData=async e=>{const t=await this.inviteLinkStore.getState();if(t.status===f.LOADING||t.status===f.READY&&e===t.teamKey)return;await this.inviteLinkStore.set({status:f.LOADING});const s=await(0,O.z)(this.serverApiClient.v1.teams.getTeamSignUpPage({teamKey:e}).pipe((0,ne.Qn)((({data:e})=>e))));if((0,d.hx)(s))return this.inviteLinkStore.set({status:f.NOT_LOADED});const{disabled:r,displayName:i,teamUuid:a}=s.data;return this.inviteLinkStore.set({teamKey:e,teamUuid:a,displayName:i,disabled:r,status:f.READY})},this.requestTeamInviteTokenSending=(e,t)=>(0,O.z)(this.serverApiClient.v1.teams.requestTeamInviteToken({login:e,teamUuid:t}).pipe((0,ne.DZ)((e=>(0,R.EQ)(e,{BusinessError:e=>this.getFunctionalError(e.code),FetchFailedError:()=>{throw new Error("Fetch Failed error")},InternalServerError:L.j,InvalidRequest:L.j,RateLimited:L.j,ServiceUnavailable:L.j,UnspecifiedBadStatus:L.j}))),(0,ne.Qn)((({data:e})=>e))))}}ce=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===x.l?Object:x.l,void 0===b?Object:b])],ce);class de{async execute({body:e}){const{login:t,teamUuid:s}=e,r=await this.inviteLinkService.requestTeamInviteTokenSending(t,s);return(0,d.hx)(r)?Promise.resolve(r):(0,d.Vp)(void 0)}constructor(e){this.inviteLinkService=e}}de=(0,r.__decorate)([(0,E.W)(oe.V),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ce?Object:ce])],de);var le=s(6136),ue=s(87065),pe=s(62760),he=s(46449),me=s(95822);class ge{execute(){return this.acBrowserPoliciesStore.state$.pipe((0,le.x)(pe.shallowEqualObjects),(0,ue.U)(d.Vp))}constructor(e){this.acBrowserPoliciesStore=e}}ge=(0,r.__decorate)([(0,he.e)(me.d),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===_?Object:_])],ge);var ve=s(69885),ye=s(25859),_e=s(6641);class Se{execute({body:e}){const{teamKey:t}=e;return""===t?(0,ve.of)((0,d.Vp)(null)):(0,ye.P)((()=>(this.inviteLinkService.loadInviteLinkData(t),this.inviteLinkStore.state$.pipe((0,ue.U)((e=>e.status!==f.READY?(0,d.Vp)(null):(0,d.Vp)({teamKey:e.teamKey,teamUuid:e.teamUuid,displayName:e.displayName,disabled:e.disabled})))))))}constructor(e,t){this.inviteLinkStore=e,this.inviteLinkService=t}}Se=(0,r.__decorate)([(0,he.e)(_e.$),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===b?Object:b,void 0===ce?Object:ce])],Se);class fe{}fe=(0,r.__decorate)([(0,a.Yl)({api:i.X,providers:[{provide:u,useClass:p},te,ce],exports:[u],onFrameworkInit:[S],stores:[_,b],handlers:{commands:{createPasswordlessAccount:re,markMassDeployFirstInitDone:ae,requestTeamInviteTokenSending:de},events:{},queries:{accountCreationMassDeployPolicies:ge,inviteLinkData:Se}},imports:[o.n,n.D]})],fe)},2075:(e,t,s)=>{s.d(t,{c:()=>P});var r,i=s(491),a=s(86006),o=s(41511),n=s(57978);!function(e){e.ChangeLoginEmailWebDev="account_management_change_login_email_web_dev"}(r||(r={}));var c=s(82874),d=s(87279),l=s(62508),u=s(60399),p=s(92587),h=s(53344),m=s(48844),g=s(18533),v=s(20195),y=s(89358);class _{async requestChangeLoginEmail(e){return await(0,u.z)(this.serverClient.v1.user.requestLoginChange({newLogin:e}).pipe((0,m.DZ)((e=>(0,g.EQ)(e,{BusinessError:e=>({tag:e.code}),FetchFailedError:v.j,InternalServerError:v.j,InvalidRequest:v.j,RateLimited:v.j,ServiceUnavailable:v.j,UnspecifiedBadStatus:v.j}))),(0,m.lk)(d.Vp)))}async completeChangeLoginEmail(e){return await(0,u.z)(this.serverClient.v1.user.completeLoginChange({validationToken:e}).pipe((0,m.DZ)((e=>(0,g.EQ)(e,{BusinessError:e=>({tag:e.code}),FetchFailedError:v.j,InternalServerError:v.j,InvalidRequest:v.j,RateLimited:v.j,ServiceUnavailable:v.j,UnspecifiedBadStatus:v.j}))),(0,m.lk)(d.Vp)))}async resendLoginChangeToken(){return await(0,u.z)(this.serverClient.v1.user.sendLoginChangeToken().pipe((0,m.DZ)(v.j),(0,m.lk)(d.Vp)))}async migrateSessionDataAndChangeEmail(e){const t=await(0,u.z)(this.sessionClient.queries.selectedOpenedSession());if(!(0,d.d6)(t)||!t.data)throw new Error("Current user's email not found");const s=await(0,u.z)(this.serverClient.v1.sync.getLatestContent({needsKeys:!1,teamAdminGroups:!1,transactions:["SETTINGS_userId"],timestamp:0}));if(!(0,d.d6)(s))throw new Error("Could not retrieve user's PersonalSettings");const r=s.data.data.transactions.find((e=>"BACKUP_EDIT"===e.action&&"SETTINGS"===e.type));if(!r||"BACKUP_REMOVE"===r.action)throw new Error("Could not retrieve user's PersonalSettings in user's transactions");const i=await this.sessionClient.commands.copyUserDataAndOpenSession({currentEmail:t.data,newEmail:e,personalSettings:r});if(!(0,d.d6)(i))throw new Error(`Error while migrating user session details: ${i.error.tag}`);return(0,d.Vp)(void 0)}constructor(e,t){this.sessionClient=e,this.serverClient=t}}_=(0,i.__decorate)([(0,p.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===y.x?Object:y.x,void 0===h.l?Object:h.l])],_);class S{async execute({body:e}){const t=await this.changeLoginEmailService.requestChangeLoginEmail(e.newEmail);if(!(0,d.d6)(t)){const{tag:e}=t.error;if("LOGIN_UNAVAILABLE"===e)return(0,d.Rn)({tag:e});throw new Error("Request to change login email failed")}return(0,d.Vp)(void 0)}constructor(e){this.changeLoginEmailService=e}}S=(0,i.__decorate)([(0,c.W)(l.j),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===_?Object:_])],S);var f=s(50423),w=s(77588),I=s(25298),b=s(62149),E=s(63144),C=s(56618);class A extends((0,E.Q)({persist:!1,scope:b.F.Device,storeName:"change-login-email",initialValue:{status:"no_request"},capacity:C.Y._001KB})){}class R{async execute({body:{newEmail:e,verificationCode:t}}){await this.changeLoginEmailStore.set({status:"in_progress"});return await this.allowedToFail.doOne((async()=>{const s=await this.changeLoginEmailService.completeChangeLoginEmail(t);(0,d.d6)(s)?(await this.changeLoginEmailService.migrateSessionDataAndChangeEmail(e),await this.changeLoginEmailStore.set({status:"success"})):await this.changeLoginEmailStore.set({status:"failed",error:w.v[s.error.tag]})}),{criticality:"critical",methodName:"change-login-email"})||await this.changeLoginEmailStore.set({status:"failed",error:w.v.LOGIN_CHANGE_FAILED}),(0,d.Vp)(void 0)}constructor(e,t,s){this.changeLoginEmailService=e,this.changeLoginEmailStore=t,this.allowedToFail=s}}R=(0,i.__decorate)([(0,c.W)(I.b),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===_?Object:_,void 0===A?Object:A,void 0===f.J?Object:f.J])],R);var T=s(87065),O=s(46449);class D{execute(){return this.store.state$.pipe((0,T.U)((e=>(0,d.Vp)(e))))}constructor(e){this.store=e}}D=(0,i.__decorate)([(0,O.e)(w.w),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===A?Object:A])],D);var U=s(58402);class F{async execute(){return await this.changeLoginEmailService.resendLoginChangeToken(),(0,d.Vp)(void 0)}constructor(e){this.changeLoginEmailService=e}}F=(0,i.__decorate)([(0,c.W)(U.h),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===_?Object:_])],F);class P{}P=(0,i.__decorate)([(0,a.Yl)({api:n.v,imports:[o.n],providers:[_],stores:[A],handlers:{commands:{initChangeLoginEmail:S,completeChangeLoginEmail:R,resendVerificationCode:F},events:{},queries:{changeLoginEmailStatus:D}},domainName:"account",requiredFeatureFlips:Object.values(r)})],P)},12444:(e,t,s)=>{s.d(t,{o:()=>C});var r=s(491),i=s(86006),a=s(35936),o=s(41511),n=s(60399),c=s(82874),d=s(32389),l=s(25200),u=s(95115),p=s(53344),h=s(87279),m=s(87065),g=s(92587);class v{async getIsExistingLogin(e){const t=this.serverApiClient.v1.authentication.get2FaStatusUnauthenticated({login:e});return await(0,n.z)(t.pipe((0,m.U)((e=>(0,h.d6)(e)))))}constructor(e){this.serverApiClient=e}}v=(0,r.__decorate)([(0,g.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===p.l?Object:p.l])],v);class y{async execute({body:{email:e}}){try{const t=await(0,n.z)(this.subscriptionCodeApi.queries.getSubscriptionCode());if(await this.accountExistsService.getIsExistingLogin(e))return(0,h.Rn)((0,d.qM)());if(!(0,h.d6)(t))return(0,h.Rn)((0,l.KJ)());const s=await(0,n.z)(this.serverApiClient.v1.invitation.invite({userKey:t.data,identifiers:[e],type:"manual"}));if((0,h.hx)(s))throw new Error("InviteByEmailCommand failure: something went wrong in call to /invitation/invite");return(0,h.Vp)(void 0)}catch(e){throw new Error("InviteByEmailCommand failure: something went wrong in execute method")}}constructor(e,t,s){this.serverApiClient=e,this.accountExistsService=t,this.subscriptionCodeApi=s}}y=(0,r.__decorate)([(0,c.W)(d.PI),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===p.l?Object:p.l,void 0===v?Object:v,void 0===u._?Object:u._])],y);var _=s(34987),S=s(46449),f=s(59020),w=s(48844);class I{execute(){return this.subscriptionCodeApi.queries.getSubscriptionCode().pipe((0,_.b)((e=>this.serverApiClient.v1.invitation.getSharingLink({userKey:"success"===e.tag?e.data:""}).pipe((0,w.Qn)((e=>e.data)),(0,w.DZ)((e=>{throw new Error(e.message)}))))))}constructor(e,t){this.serverApiClient=e,this.subscriptionCodeApi=t}}I=(0,r.__decorate)([(0,S.e)(f.h),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===p.l?Object:p.l,void 0===u._?Object:u._])],I);var b=s(75449);class E{execute(){return this.serverApiClient.v1.invitation.getInvitationsHistory().pipe((0,w.Qn)((e=>e.data)),(0,w.DZ)((e=>(0,h.Rn)({tag:`GetInvitationsHistoryQueryHandler failure: ${e.message}`}))))}constructor(e){this.serverApiClient=e}}E=(0,r.__decorate)([(0,S.e)(b.g),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===p.l?Object:p.l])],E);class C{}C=(0,r.__decorate)([(0,i.Yl)({api:a.l,imports:[o.n],handlers:{commands:{inviteByEmail:y},events:{},queries:{getSharingLink:I,getInvitationsHistory:E}},providers:[v]})],C)},99813:(e,t,s)=>{s.d(t,{T:()=>U});var r=s(491),i=s(86006),a=s(41511),o=s(12892),n=s(60399),c=s(87065),d=s(84238),l=s(68817),u=s(92587),p=s(53344),h=s(48844),m=s(18533),g=s(20195),v=s(87279);class y{getAuthenticationMethodsForReset(e){return this.serverApiClient.v1.authentication.getAuthenticationMethodsForReset({login:e,methods:["email_token","totp"]}).pipe((0,h.DZ)((e=>(0,m.EQ)(e,{BusinessError:e=>this.getFunctionalError(e.code),FetchFailedError:()=>{throw new Error("Fetch Failed error")},BadStatus:g.j,InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j,UnspecifiedBadStatus:g.j}))),(0,h.Qn)((e=>{if(e.data.verifications.length>=1)return e.data.verifications[0].type;throw new Error("GetAuthenticationMethodsForReset: couldn't retrieve any method")})))}requestEmailTokenVerificationSending(e){return(0,n.z)(this.serverApiClient.v1.authentication.requestEmailTokenVerification({login:e}).pipe((0,c.U)((e=>(0,v.d6)(e)))))}getVerifyTokenFunctionalError(e){switch(e){case"invalid_otp_already_used":return{tag:d.O.INVALID_OTP_ALREADY_USED};case"invalid_otp_blocked":return{tag:d.O.INVALID_OTP_BLOCKED};case"verification_failed":return{tag:d.O.VERIFICATION_FAILED};case"account_blocked_contact_support":return{tag:d.O.ACCOUNT_BLOCKED_CONTACT_SUPPORT};case"verification_requires_request":return{tag:d.O.VERIFICATION_REQUIRES_REQUEST};case"verification_timeout":return{tag:d.O.VERIFICATION_TIMEOUT};default:throw new Error("performTokenVerification: Business error not handled")}}verifyTOTPToken(e,t){return(0,n.z)(this.serverApiClient.v1.authentication.performTotpVerification({login:e,otp:t,intent:"account_delete_or_reset"}).pipe((0,h.DZ)((e=>(0,m.EQ)(e,{BusinessError:e=>this.getVerifyTokenFunctionalError(e.code),FetchFailedError:g.j,BadStatus:g.j,InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j,UnspecifiedBadStatus:g.j}))),(0,h.Qn)((e=>e.data.authTicket))))}verifyEmailToken(e,t){return(0,n.z)(this.serverApiClient.v1.authentication.performEmailTokenVerification({login:e,token:t,intent:"account_delete_or_reset"}).pipe((0,h.DZ)((e=>(0,m.EQ)(e,{BusinessError:e=>this.getVerifyTokenFunctionalError(e.code),FetchFailedError:g.j,BadStatus:g.j,InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j,UnspecifiedBadStatus:g.j}))),(0,h.Qn)((e=>e.data.authTicket))))}deleteOrResetAccount(e,t,s=!0){return(0,n.z)(this.serverApiClient.v1.account.deleteOrResetAccount({authTicket:t,isDelete:s,login:e}).pipe((0,h.DZ)((e=>(0,m.EQ)(e,{BusinessError:g.j,FetchFailedError:g.j,BadStatus:g.j,InternalServerError:g.j,InvalidRequest:g.j,RateLimited:g.j,ServiceUnavailable:g.j,UnspecifiedBadStatus:g.j}))),(0,h.Qn)((()=>!0))))}constructor(e){this.serverApiClient=e,this.getFunctionalError=e=>{switch(e){case l.U.UNKNOWN_USER:return{tag:l.U.UNKNOWN_USER};case l.U.SSO_BLOCKED:return{tag:l.U.SSO_BLOCKED};default:throw new Error(`GetAuthenticationMethodsForReset: error ${e}`)}}}}y=(0,r.__decorate)([(0,u.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===p.l?Object:p.l])],y);var _,S=s(62149),f=s(63144),w=s(56618);class I extends((0,f.Q)({persist:!1,scope:S.F.Device,storeName:"account-deletion",initialValue:{login:"",userAuthenticationMethod:null,isFlowCompleted:!1},capacity:w.Y._001KB})){}!function(e){e.EMAIL="EMAIL",e.TOTP="TOTP"}(_||(_={}));var b=s(82874);class E{async execute({body:e}){const{token:t,isDelete:s}=e,r=await this.deleteOrResetAccountStore.getState(),{userAuthenticationMethod:i,login:a}=r,o=i===_.EMAIL?await this.deleteOrResetAccountService.verifyEmailToken(a,t):await this.deleteOrResetAccountService.verifyTOTPToken(a,t);if((0,v.hx)(o))return Promise.resolve(o);const n=await this.deleteOrResetAccountService.deleteOrResetAccount(a,o.data,s);if((0,v.hx)(n))throw new Error("CompleteFlowCommand : error while deleting the account");return this.deleteOrResetAccountStore.set({...r,isFlowCompleted:!0}),Promise.resolve((0,v.Vp)(void 0))}constructor(e,t){this.deleteOrResetAccountStore=e,this.deleteOrResetAccountService=t}}E=(0,r.__decorate)([(0,b.W)(d.I),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===I?Object:I,void 0===y?Object:y])],E);class C{async execute({body:e}){const{login:t}=e,s=await(0,n.z)(this.deleteOrResetAccountService.getAuthenticationMethodsForReset(t).pipe((0,h.Qn)((e=>"email_token"===e?_.EMAIL:_.TOTP))));if((0,v.hx)(s))return Promise.resolve(s);s.data===_.EMAIL&&this.deleteOrResetAccountService.requestEmailTokenVerificationSending(t);const r=await this.deleteOrResetAccountStore.getState();return await this.deleteOrResetAccountStore.set({...r,login:t,userAuthenticationMethod:s.data}),Promise.resolve((0,v.Vp)(void 0))}constructor(e,t){this.deleteOrResetAccountStore=e,this.deleteOrResetAccountService=t}}C=(0,r.__decorate)([(0,b.W)(l.O),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===I?Object:I,void 0===y?Object:y])],C);var A=s(46449),R=s(81377);class T{execute(){return this.deleteOrResetAccountStore.state$.pipe((0,c.U)((e=>(0,v.Vp)(e.userAuthenticationMethod))))}constructor(e){this.deleteOrResetAccountStore=e}}T=(0,r.__decorate)([(0,A.e)(R.c),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===I?Object:I])],T);var O=s(65104);class D{execute(){return this.deleteOrResetAccountStore.state$.pipe((0,c.U)((e=>(0,v.Vp)(e.isFlowCompleted))))}constructor(e){this.deleteOrResetAccountStore=e}}D=(0,r.__decorate)([(0,A.e)(O.h),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===I?Object:I])],D);class U{}U=(0,r.__decorate)([(0,i.Yl)({api:o.d,handlers:{commands:{completeFlow:E,initiateFlow:C},events:{},queries:{userAuthenticationMethod:T,isFlowCompleted:D}},stores:[I],imports:[a.n],providers:[y]})],U)},79925:(e,t,s)=>{s.d(t,{q:()=>D});var r=s(491),i=s(41511),a=s(90475),o=s(86006),n=s(20691),c=s(5237),d=s(85798),l=s(60399),u=s(92587),p=s(53344),h=s(48844),m=s(87279),g=s(7165),v=s(62149),y=s(63144),_=s(56618),S=s(10722);const f=g.z.object({code:g.z.string().nullable(),error:g.z.union([g.z.string(),g.z.undefined()])}),w=e=>f.safeParse(e).success;class I extends((0,y.Q)({storage:{schemaVersion:1,initialValue:{code:null},typeGuard:w},persist:!0,scope:v.F.User,storeName:"plan-cancellation-store",capacity:_.Y._001KB,codec:S.E})){}class b{async refresh(){const e=await(0,l.z)(this.serverApiClient.v1.premium.getSubscriptionCode({}).pipe((0,h.Qn)((({data:e})=>e))));(0,m.d6)(e)?this.subscriptionCodeStore.set({code:e.data.subscriptionCode}):this.subscriptionCodeStore.set({code:null,error:e.error.message})}constructor(e,t){this.serverApiClient=e,this.subscriptionCodeStore=t}}b=(0,r.__decorate)([(0,u.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===p.l?Object:p.l,void 0===I?Object:I])],b);class E{async handle(){this.subscriptionCodeService.refresh()}constructor(e){this.subscriptionCodeService=e}}E=(0,r.__decorate)([(0,d.b)(c.M),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===b?Object:b])],E);var C=s(87065),A=s(6136),R=s(46449),T=s(25200);class O{execute(){return this.subscriptionCodeStore.state$.pipe((0,C.U)((e=>"no_key_for_user"!==e.error&&e.code?(0,m.Vp)(e.code):(0,m.Rn)((0,T.KJ)()))),(0,A.x)())}constructor(e){this.subscriptionCodeStore=e}}O=(0,r.__decorate)([(0,R.e)(T.aD),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===I?Object:I])],O);class D{}D=(0,r.__decorate)([(0,o.Yl)({api:n.N,handlers:{commands:{},events:{...(0,o.g4)(a.Q,{sessionOpened:E})},queries:{getSubscriptionCode:O}},stores:[I],imports:[i.n],providers:[b]})],D)},11526:(e,t,s)=>{s.d(t,{D:()=>a});var r=s(75958),i=s(89689);const a=(0,r.Q)({name:"overrides",commands:{},events:{},queries:{OverridesQuery:i.N}})},89689:(e,t,s)=>{s.d(t,{N:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.Device})){}},50618:(e,t,s)=>{s.d(t,{x:()=>m});var r=s(491),i=s(86006);var a=s(11526),o=s(47830),n=s(46449),c=s(89689),d=s(87279),l=s(1598),u=s(87065);class p{execute(){return this.rfuClient.streamFileUpdate().pipe((0,u.U)((e=>(0,d.Vp)({overrides:e}))))}constructor(e){this.rfuClient=e}}p=(0,r.__decorate)([(0,n.e)(c.N),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===l.w?Object:l.w])],p);const h=(0,o.Q)("overrides.json",(e=>null!=e&&"object"==typeof e&&Object.values(e).every((e=>Array.isArray(e)&&e.every((e=>(e=>{if(!e||"object"!=typeof e)return!1;const t="type"in e&&void 0!==e.type&&("startsWith"===e.type||"regexp"===e.type),s="value"in e&&void 0!==e.value&&(Array.isArray(e.value)&&e.value.every((e=>"string"==typeof e))||"string"==typeof e.value),r="conditions"in e&&void 0!==e.conditions&&Array.isArray(e.conditions)&&e.conditions.every((e=>(e=>{const t="type"in e&&void 0!==e.type&&("css"===e.type||"xpath"===e.type),s="selector"in e&&void 0!==e.selector&&"string"==typeof e.selector;return t&&s})(e))),i="actions"in e&&void 0!==e.actions&&Array.isArray(e.actions)&&e.actions.every((e=>(e=>{const t="type"in e&&void 0!==e.type&&("set"===e.type||"ignore"===e.type),s="cssSelector"in e&&void 0!==e.cssSelector&&"string"==typeof e.cssSelector;return t&&s})(e)));return t&&s&&r&&i})(e)))))));class m{}m=(0,r.__decorate)([(0,i.Yl)({api:a.D,composes:[h],handlers:{commands:{},events:{},queries:{overrides:p}}})],m)},67053:(e,t,s)=>{s.d(t,{c:()=>n});var r=s(75958),i=s(23032),a=s(37931),o=s(49164);const n=(0,r.Q)({name:"autofillData",commands:{},events:{},queries:{getSingleAutofillData:i.a,getMultipleAutofillData:a.N,searchAutofillData:o.w}})},37931:(e,t,s)=>{s.d(t,{N:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},23032:(e,t,s)=>{s.d(t,{a:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},49164:(e,t,s)=>{s.d(t,{w:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},32671:(e,t,s)=>{s.d(t,{Y:()=>o});var r=s(75958),i=s(43814),a=s(91056);const o=(0,r.Q)({name:"autofillTracking",commands:{temporaryEmitPasswordAutofillPerformedEvent:i.q},events:{passwordAutofillPerformedEvent:a.p},queries:{}})},43814:(e,t,s)=>{s.d(t,{q:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},91056:(e,t,s)=>{s.d(t,{p:()=>a});var r=s(446),i=s(62149);class a extends((0,r.d)({scope:i.F.User})){}},63433:(e,t,s)=>{var r;s.d(t,{S:()=>r}),function(e){e.AutofillWebOneClickFormFill="autofill_web_oneClickFormFill",e.AutofillWebAskBeforeAutologin="autofill_web_askBeforeAutologin",e.AutofillWebNewSubdomainManagement="autofill_web_newSubdomainManagement",e.AutofillWebInjectScriptOnStartDev="autofill_web_injectScriptOnStart_dev",e.ReplaceInputListeners="autofill_web_replaceInputListeners",e.ReplaceInputListenersDev="autofill_web_replaceInputListeners_dev",e.PasskeySupport="autofill_web_passkey_support",e.PhishingPreventionOnPasteDev="autofill_web_phishing_prevention_on_paste_dev",e.PhishingPreventionOnPaste="autofill_web_phishing_prevention_on_paste_2",e.ImproveImpalaVisibility="autofill_web_improveImpalaVisibility",e.ImproveImpalaVisibilityDev="autofill_web_improveImpalaVisibility_dev",e.DisableAutologin="autofill_web_disableAutologin",e.AdminTabDev="ace_admin_tab_dev",e.AdminTab="ace_admin_tab",e.DisableEmailPasswordWarningDev="ace_disable_email_password_warning_dev",e.DisableEmailPasswordWarning="ace_disable_email_password_warning",e.RestrictPasswordFreePlanPhase1="b2c_web_restrict_password_free_plan_phase1",e.RestrictPasswordFreePlanPhase2="b2c_web_restrict_password_free_plan_phase2",e.EnableAdditionalInputEventInTimeout="ace_web_enableAdditionalInputEventInTimeout",e.EnableTextFillV2="ace_enable_textfillV2",e.AdminInterview="ace_admin_tab_interview",e.AdminInterviewDev="ace_admin_tab_interview_dev",e.LinkedWebsitesInContextDev="ace_web_linkedWebsitesInContext_dev",e.GrapheneMigrationV3Dev="ace_web_graphene_migration_v3_dev",e.SecretsAttachment="ace_secrets_vault_attachment",e.InAppPasswordHealthBadges="ace_inapp_passwordhealth_indicators",e.NewUserVerificationForItemUnlock="ace_web_new_uv_item_unlock",e.SharedCollectionInSaveWebcard="shared_collection_in_save_webcard_dev",e.AutofillAuditLogs="ace_item_usage_auditlogs",e.UninstallNudges="ace_nudges_uninstall_slack"}(r||(r={}))},34255:(e,t,s)=>{s.d(t,{Pw:()=>o,q_:()=>i,rF:()=>n,up:()=>r});const r=["KWAddress","KWBankStatement","KWCompany","KWDriverLicence","KWEmail","KWFiscalStatement","KWIDCard","KWIdentity","KWMerchand","KWPassport","KWPaymentMean_creditCard","KWPaymentMean_paypal","KWPersonalWebsite","KWPhone","KWSecureNote","KWSecureNoteCategory","KWSocialSecurityStatement"],i=["KWAuthentifiant","KWGeneratedPassword","KWPasskey"],a=[...r,...i],o=e=>!!e&&"string"==typeof e&&a.includes(e),n=e=>!!e&&"object"==typeof e&&Array.isArray(e)&&e.every(o)},4427:(e,t,s)=>{s.d(t,{P:()=>r,w:()=>i});const r=e=>e instanceof Array&&!e.find((e=>{return!("object"==typeof(t=e)&&null!==t&&"id"in t&&"fieldIdentifier"in t&&"domain"in t);var t})),i=e=>"none"===e.correctedDataSource},28216:(e,t,s)=>{var r;s.d(t,{M:()=>r}),function(e){e[e.CannotDisable=0]="CannotDisable",e[e.DisableSpecificVaultItem=1]="DisableSpecificVaultItem",e[e.DisableGeneralSetting=2]="DisableGeneralSetting"}(r||(r={}))},30812:(e,t,s)=>{var r;s.d(t,{k:()=>r}),function(e){e.Address="Address",e.BankAccount="BankAccount",e.Company="Company",e.Credential="Credential",e.DriverLicense="DriverLicense",e.Email="Email",e.FiscalId="FiscalId",e.GeneratedPassword="GeneratedPassword",e.IdCard="IdCard",e.Identity="Identity",e.NoteCategory="NoteCategory",e.Note="Note",e.Passport="Passport",e.Passkey="Passkey",e.PaymentCard="PaymentCard",e.PersonalWebsite="PersonalWebsite",e.Phone="Phone",e.Secret="Secret",e.SocialSecurityId="SocialSecurityId"}(r||(r={}))},73084:(e,t,s)=>{s.r(t),s.d(t,{AddDisabledSourceTypesCommand:()=>x.g,AddLinkedWebsiteCommand:()=>ee.vp,AddLinkedWebsiteErrors:()=>ee.hy,AnalysisStatus:()=>D._,AutofillFeatureFlips:()=>l.S,AutofillSettingsApiClient:()=>O.W,CREDENTIAL_DATA_MODELS:()=>v.q_,CountriesForAutofill:()=>u,DisableAnalysisCommand:()=>N.u,DisableAutofillOnFormsCommand:()=>k.t,DisableAutofillOnLoginsCommand:()=>L.f,DisableAutologinCommand:()=>G.T,DisableFollowUpNotificationCommand:()=>M.y,DisablePhishingPreventionForUrlCommand:()=>R.z,EnableAnalysisCommand:()=>K.c,EnableAutofillOnFormsCommand:()=>V.a,EnableAutofillOnLoginsCommand:()=>z.I,EnableAutologinCommand:()=>j.i,EnableFollowUpNotificationCommand:()=>W.B,FORM_DATA_MODELS:()=>v.up,GetAnalysisStatusOnUrlQuery:()=>D.h,GetAutofillDisabledOnLoginsAndFormsNotificationStatusQuery:()=>w.z,GetAutofillProtectionContextQuery:()=>b.u,GetAutofillSettingsQuery:()=>U.T,GetDashlaneDefinedLinkedWebsitesQuery:()=>J.J,GetMultipleAutofillDataQuery:()=>a.N,GetMultipleDashlaneDefinedLinkedWebsitesQuery:()=>Z.E,GetPreferencesForCredentialsQuery:()=>P.g,GetSingleAutofillDataQuery:()=>i.a,GetUserAutofillCorrectionsQuery:()=>F.w,LinkedWebsitesClient:()=>H.X,OtherSourceType:()=>p,PasswordAutofillPerformedEvent:()=>c.p,PhishingPreventionDisabledForUrlQuery:()=>C.v,PhishingPreventionEnabledQuery:()=>E.i,RemoveDisabledSourceTypesCommand:()=>q.v,RemoveLinkedWebsiteCommand:()=>te.M7,RemoveLinkedWebsiteErrors:()=>te.E6,ResetProtectedItemAutofillTimerCommand:()=>A.y,SearchAutofillDataQuery:()=>o.w,SetAutofillDisabledOnLoginsAndFormsNotificationStatusCommand:()=>f.a,SetUserAutofillCorrectionsCommand:()=>$.S,TemporaryEmitPasswordAutofillPerformedEventCommand:()=>d.q,ToggleDashlaneCommand:()=>B.r,UpdateCredentialPreferencesCommand:()=>Y.J,UpdateLinkedWebsitesCommand:()=>X.A,VaultItemDisableProtectionMode:()=>_.M,VaultSourceType:()=>h.k,autofillDataApi:()=>r.c,autofillNotificationsApi:()=>S._,autofillSecurityApi:()=>I.V,autofillSettingsApi:()=>T.I,autofillTrackingApi:()=>n.Y,createAddLinkedWebsiteCredentialNotFound:()=>ee.i6,createAddLinkedWebsiteErrorOnUpdatingVault:()=>ee.R6,createAddLinkedWebsiteWebsiteAlreadyLinked:()=>ee.lD,createRemoveLinkedWebsiteCredentialNotFound:()=>te.W4,createRemoveLinkedWebsiteErrorOnUpdatingVault:()=>te.cQ,isArrayOfAutofillableDataModel:()=>v.rF,isArrayOfUserAutofillCorrections:()=>y.P,isAutofillableDataModel:()=>v.Pw,isDashlaneDisabledPermanently:()=>y.w,isOtherSourceType:()=>m,isVaultSourceType:()=>g,linkedWebsitesApi:()=>Q.G});var r=s(67053),i=s(23032),a=s(37931),o=s(49164),n=s(32671),c=s(91056),d=s(43814),l=s(63433);const u=Object.freeze({NO_TYPE:"NO_TYPE",UNIVERSAL:"UNIVERSAL",AD:"AD",AE:"AE",AF:"AF",AG:"AG",AI:"AI",AL:"AL",AM:"AM",AO:"AO",AR:"AR",AS:"AS",AT:"AT",AU:"AU",AW:"AW",AZ:"AZ",BA:"BA",BB:"BB",BD:"BD",BE:"BE",BF:"BF",BG:"BG",BH:"BH",BI:"BI",BJ:"BJ",BL:"BL",BM:"BM",BN:"BN",BO:"BO",BR:"BR",BS:"BS",BT:"BT",BW:"BW",BY:"BY",BZ:"BZ",CA:"CA",CD:"CD",CF:"CF",CG:"CG",CH:"CH",CI:"CI",CK:"CK",CL:"CL",CM:"CM",CN:"CN",CO:"CO",CR:"CR",CU:"CU",CV:"CV",CY:"CY",CZ:"CZ",DE:"DE",DJ:"DJ",DK:"DK",DM:"DM",DO:"DO",DZ:"DZ",EC:"EC",EE:"EE",EG:"EG",ER:"ER",ES:"ES",ET:"ET",FI:"FI",FJ:"FJ",FK:"FK",FM:"FM",FO:"FO",FR:"FR",GA:"GA",GB:"GB",GD:"GD",GE:"GE",GF:"GF",GG:"GG",GH:"GH",GI:"GI",GL:"GL",GM:"GM",GN:"GN",GP:"GP",GQ:"GQ",GR:"GR",GT:"GT",GU:"GU",GW:"GW",GY:"GY",HK:"HK",HN:"HN",HR:"HR",HT:"HT",HU:"HU",ID:"ID",IE:"IE",IL:"IL",IM:"IM",IN:"IN",IO:"IO",IQ:"IQ",IR:"IR",IS:"IS",IT:"IT",JE:"JE",JM:"JM",JO:"JO",JP:"JP",KE:"KE",KG:"KG",KH:"KH",KI:"KI",KM:"KM",KN:"KN",KP:"KP",KR:"KR",KW:"KW",KY:"KY",KZ:"KZ",LA:"LA",LB:"LB",LC:"LC",LI:"LI",LK:"LK",LR:"LR",LS:"LS",LT:"LT",LU:"LU",LV:"LV",LY:"LY",MA:"MA",MC:"MC",MD:"MD",ME:"ME",MF:"MF",MG:"MG",MH:"MH",MK:"MK",ML:"ML",MM:"MM",MN:"MN",MO:"MO",MP:"MP",MQ:"MQ",MR:"MR",MS:"MS",MT:"MT",MU:"MU",MV:"MV",MW:"MW",MX:"MX",MY:"MY",MZ:"MZ",NA:"NA",NC:"NC",NE:"NE",NF:"NF",NG:"NG",NI:"NI",NL:"NL",NO:"NO",NP:"NP",NR:"NR",NU:"NU",NZ:"NZ",OM:"OM",PA:"PA",PE:"PE",PF:"PF",PG:"PG",PH:"PH",PK:"PK",PL:"PL",PM:"PM",PR:"PR",PS:"PS",PT:"PT",PW:"PW",PY:"PY",QA:"QA",RE:"RE",RO:"RO",RS:"RS",RU:"RU",RW:"RW",SA:"SA",SB:"SB",SC:"SC",SD:"SD",SE:"SE",SG:"SG",SH:"SH",SI:"SI",SK:"SK",SL:"SL",SM:"SM",SN:"SN",SO:"SO",SR:"SR",ST:"ST",SV:"SV",SY:"SY",SZ:"SZ",TC:"TC",TD:"TD",TF:"TF",TG:"TG",TH:"TH",TJ:"TJ",TK:"TK",TL:"TL",TM:"TM",TN:"TN",TO:"TO",TR:"TR",TT:"TT",TV:"TV",TW:"TW",TZ:"TZ",UA:"UA",UG:"UG",US:"US",UY:"UY",UZ:"UZ",VA:"VA",VC:"VC",VE:"VE",VG:"VG",VI:"VI",VN:"VN",VU:"VU",WF:"WF",WS:"WS",XK:"XK",YE:"YE",YT:"YT",ZA:"ZA",ZM:"ZM",ZW:"ZW",AQ:"AQ",AX:"AX",BV:"BV",CC:"CC",CX:"CX",EH:"EH",GS:"GS",HM:"HM",PN:"PN",SJ:"SJ",UM:"UM"});var p,h=s(30812);!function(e){e.NewPassword="newPassword",e.SubmitButton="submitButton",e.WebauthnConditionalUI="WebauthnConditionalUI"}(p||(p={}));const m=e=>Object.values(p).includes(e),g=e=>e in h.k;var v=s(34255),y=s(4427),_=s(28216),S=s(10839),f=s(1006),w=s(24584),I=s(56979),b=s(49739),E=s(97653),C=s(16743),A=s(8126),R=s(84471),T=s(98716),O=s(19216),D=s(37233),U=s(56226),F=s(50672),P=s(50072),x=s(62181),N=s(60355),G=s(56858),k=s(64912),L=s(41733),M=s(41908),K=s(91970),j=s(94702),V=s(79798),z=s(33898),W=s(3499),q=s(76751),B=s(18880),$=s(23187),Y=s(66069),Q=s(85324),H=s(81813),J=s(73328),Z=s(34674),X=s(92712),ee=s(56231),te=s(23425)},85324:(e,t,s)=>{s.d(t,{G:()=>d});var r=s(75958),i=s(56231),a=s(23425),o=s(92712),n=s(73328),c=s(34674);const d=(0,r.Q)({name:"linkedWebsites",commands:{addLinkedWebsite:i.vp,removeLinkedWebsite:a.M7,updateLinkedWebsites:o.A},events:{},queries:{getDashlaneDefinedLinkedWebsites:n.J,getMultipleDashlaneDefinedLinkedWebsites:c.E}})},81813:(e,t,s)=>{s.d(t,{X:()=>a});var r=s(8260),i=s(85324);class a extends((0,r.E)(i.G)){}(0,r.K)(i.G,a)},56231:(e,t,s)=>{s.d(t,{R6:()=>d,hy:()=>r,i6:()=>n,lD:()=>c,vp:()=>l});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.CREDENTIAL_NOT_FOUND="credential_not_found",e.WEBSITE_ALREADY_LINKED="website_already_linked",e.ERROR_ON_UPDATING_VAULT="error_on_updating_vault"}(r||(r={}));const n=(0,o.Vj)("credential_not_found","Couldn't retrieve the credential"),c=(0,o.Vj)("website_already_linked","Website alredy linked to this credential"),d=(0,o.Vj)("error_on_updating_vault","Error while updating the credential");class l extends((0,i.g)({scope:a.F.User})){}},23425:(e,t,s)=>{s.d(t,{E6:()=>r,M7:()=>d,W4:()=>n,cQ:()=>c});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.CREDENTIAL_NOT_FOUND="credential_not_found",e.ERROR_ON_UPDATING_VAULT="error_on_updating_vault"}(r||(r={}));const n=(0,o.Vj)("credential_not_found","Couldn't retrieve the credential"),c=(0,o.Vj)("error_on_updating_vault","Error while updating the credential");class d extends((0,i.g)({scope:a.F.User})){}},92712:(e,t,s)=>{s.d(t,{A:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},73328:(e,t,s)=>{s.d(t,{J:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},34674:(e,t,s)=>{s.d(t,{E:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},10839:(e,t,s)=>{s.d(t,{_:()=>o});var r=s(75958),i=s(1006),a=s(24584);const o=(0,r.Q)({name:"autofillNotifications",commands:{setAutofillDisabledOnLoginsAndFormsNotificationStatus:i.a},events:{},queries:{getAutofillDisabledOnLoginsAndFormsNotificationStatus:a.z}})},1006:(e,t,s)=>{s.d(t,{a:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},24584:(e,t,s)=>{s.d(t,{z:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},56979:(e,t,s)=>{s.d(t,{V:()=>d});var r=s(75958),i=s(84471),a=s(8126),o=s(49739),n=s(97653),c=s(16743);const d=(0,r.Q)({name:"autofillSecurity",commands:{disablePhishingPreventionForUrl:i.z,resetProtectedItemAutofillTimer:a.y},events:{},queries:{getAutofillProtectionContext:o.u,isPhishingPreventionCapabilityEnabled:n.i,isPhishingPreventionDisabledForUrl:c.v}})},84471:(e,t,s)=>{s.d(t,{z:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},8126:(e,t,s)=>{s.d(t,{y:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.Device})){}},49739:(e,t,s)=>{s.d(t,{u:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},97653:(e,t,s)=>{s.d(t,{i:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},16743:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},98716:(e,t,s)=>{s.d(t,{I:()=>b});var r=s(75958),i=s(76751),a=s(62181),o=s(18880),n=s(91970),c=s(94702),d=s(79798),l=s(33898),u=s(3499),p=s(60355),h=s(56858),m=s(64912),g=s(41733),v=s(41908),y=s(23187),_=s(66069),S=s(37233),f=s(56226),w=s(50672),I=s(50072);const b=(0,r.Q)({name:"autofillSettings",commands:{toggleDashlane:o.r,enableAnalysis:n.c,enableAutologin:c.i,enableAutofillOnForms:d.a,enableAutofillOnLogins:l.I,enableFollowUpNotification:u.B,disableAnalysis:p.u,disableAutologin:h.T,disableAutofillOnForms:m.t,disableAutofillOnLogins:g.f,disableFollowUpNotification:v.y,addDisabledSourceTypes:a.g,removeDisabledSourceTypes:i.v,setUserAutofillCorrections:y.S,updateCredentialPreferences:_.J},events:{},queries:{getAnalysisStatusOnUrl:S.h,getAutofillSettings:f.T,getUserAutofillCorrections:w.w,getPreferencesForCredentials:I.g}})},19216:(e,t,s)=>{s.d(t,{W:()=>a});var r=s(8260),i=s(98716);class a extends((0,r.E)(i.I)){}(0,r.K)(i.I,a)},62181:(e,t,s)=>{s.d(t,{g:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},60355:(e,t,s)=>{s.d(t,{u:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},64912:(e,t,s)=>{s.d(t,{t:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},41733:(e,t,s)=>{s.d(t,{f:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},56858:(e,t,s)=>{s.d(t,{T:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},41908:(e,t,s)=>{s.d(t,{y:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},91970:(e,t,s)=>{s.d(t,{c:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},79798:(e,t,s)=>{s.d(t,{a:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},33898:(e,t,s)=>{s.d(t,{I:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},94702:(e,t,s)=>{s.d(t,{i:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},3499:(e,t,s)=>{s.d(t,{B:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},76751:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},23187:(e,t,s)=>{s.d(t,{S:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},18880:(e,t,s)=>{s.d(t,{r:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},66069:(e,t,s)=>{s.d(t,{J:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},37233:(e,t,s)=>{s.d(t,{_:()=>r,h:()=>o});var r,i=s(77535),a=s(62149);!function(e){e.ANALYSIS_ENABLED="ANALYSIS_ENABLED",e.ANALYSIS_DISABLED_BY_USER="ANALYSIS_DISABLED_BY_USER",e.ANALYSIS_DISABLED_BY_B2B_ADMIN="ANALYSIS_DISABLED_BY_B2B_ADMIN",e.ANALYSIS_DISABLED_BY_KILLSWITCH="ANALYSIS_DISABLED_BY_KILLSWITCH",e.ANALYSIS_DISABLED_BY_2FA_ENFORCEMENT="ANALYSIS_DISABLED_BY_2FA_ENFORCEMENT"}(r||(r={}));class o extends((0,i.k)({scope:a.F.Device})){}},56226:(e,t,s)=>{s.d(t,{T:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},50072:(e,t,s)=>{s.d(t,{g:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},50672:(e,t,s)=>{s.d(t,{w:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},76347:(e,t,s)=>{s.d(t,{U:()=>z});var r=s(491),i=s(86006),a=s(67053),o=s(87065),n=s(30812),c=s(92587),d=s(87279),l=s(48844),u=s(39431),p=s(29289),h=s(50879),m=s(22449);const g={[n.k.Address]:u.U.Address,[n.k.BankAccount]:u.U.BankAccount,[n.k.Company]:u.U.Company,[n.k.Credential]:u.U.Credential,[n.k.DriverLicense]:u.U.DriversLicense,[n.k.Email]:u.U.Email,[n.k.FiscalId]:u.U.FiscalId,[n.k.GeneratedPassword]:null,[n.k.IdCard]:u.U.IdCard,[n.k.Identity]:u.U.Identity,[n.k.Note]:u.U.SecureNote,[n.k.Passkey]:u.U.Passkey,[n.k.Passport]:u.U.Passport,[n.k.PaymentCard]:u.U.PaymentCard,[n.k.PersonalWebsite]:u.U.Website,[n.k.Phone]:u.U.Phone,[n.k.SocialSecurityId]:u.U.SocialSecurityId,[n.k.Secret]:u.U.Secret,[n.k.NoteCategory]:null};class v{getAutofillData(e,t,s,r,i,a){const n=g[e];if(!n)throw new Error("autofill-data.repository: bad vault item type in `getAutofillData`");return this.getVaultItem(n,t?[t]:void 0,s,r,i,a).pipe((0,o.U)((e=>{if((0,d.hx)(e))throw new Error("autofill-data.repository: the following error occured while requesting the vault API "+e.tag);if(t&&e.data[p.N[n]].matchCount<1)throw new Error("autofill-data.repository: no vault item corresponding to the provided id");return e})))}searchAutofillData(e,t,s,r,i){let a;return t?.length&&(a=t.map((e=>g[e])).filter((e=>!!e))),this.searchVaultItem(e,a,s,r,i).pipe((0,l.DZ)((e=>{throw new Error("autofill-data.repository: the following error occured while requesting the search vault API "+e)})))}getVaultItem(e,t,s,r,i,a){const{query:o}=this.vaultClient.queries;return o({vaultItemTypes:[e],ids:t,propertySorting:s,propertyFilters:r,pageNumber:a,pageSize:i})}searchVaultItem(e,t,s,r,i){const{search:a}=this.searchClient.queries;return a({searchQuery:e,vaultItemTypes:t,propertySorting:s,pageSize:r,pageNumber:i,needDashlaneLinkedWebsites:!0})}constructor(e,t){this.vaultClient=e,this.searchClient=t}}v=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===h.L?Object:h.L,void 0===m.T?Object:m.T])],v);var y,_=s(60399),S=s(19216),f=s(81813),w=s(13252),I=s(35594),b=s(13134),E=s(50756);!function(e){e.MainWebsite="MainWebsite",e.DashlaneDefinedLinkedWebsite="DashlaneDefinedLinkedWebsite",e.UserDefinedLinkedWebsite="UserDefinedLinkedWebsite",e.None="None"}(y||(y={}));const C=(e,t,s)=>{const r=((e,t,s)=>{if(!e)return"None";const r=new b.Y(e).getRootDomain();return r===new b.Y(t.URL).getRootDomain()?"MainWebsite":s.map((e=>new b.Y(e).getRootDomain())).includes(r)?"DashlaneDefinedLinkedWebsite":t.linkedURLs.map((e=>new b.Y(e).getRootDomain())).includes(r)?"UserDefinedLinkedWebsite":"None"})(e,t,s);switch(r){case"DashlaneDefinedLinkedWebsite":return E.MatchType.AssociatedWebsite;case"UserDefinedLinkedWebsite":return E.MatchType.UserAssociatedWebsite;default:return E.MatchType.Regular}},A=e=>new Date(1e3*e),R=e=>{if(!e)return null;const t=(e=>{if(!e)return 0;const[t,s,r]=e.split(/[-/]/).map((e=>Number.parseInt(e,10))),i=new Date;i.setUTCHours(0,0,0,0);const a=i.setUTCFullYear(t,s-1,r);return Math.floor(a/1e3)})(e);return Number.isNaN(t)?null:t},T=e=>{const t=new Date(0).getUTCFullYear(),s=A(R(e.birthDate)??0),r=new Date(Date.now()-s.getTime());return Math.abs(r.getUTCFullYear()-t)},O=e=>e??"",D=e=>e??0;class U{getAutofillViewForItems(e,{data:t},s){return this.mapVaultItemToAutofillView[e](t,s)}isCredentialsList(e){return e.length>0&&e[0].vaultType===n.k.Credential}isPasskeysList(e){return e.length>0&&e[0].vaultType===n.k.Passkey}baseItemAutofillView(e){return{id:e.id,lastUse:e.lastUse,localeFormat:e.localeFormat,spaceId:O(e.spaceId)}}addressAutofillView(e){return Promise.all(e.addressesResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.Address,addressFull:`${e.streetNumber} ${e.streetName}`.trim(),stateCode:O(e.stateNumber),addressName:O(e.itemName),streetTitle:O(e.streetName),building:O(e.building),city:O(e.city),country:O(e.country),zipCode:O(e.zipCode),streetName:O(e.streetName),streetNumber:O(e.streetNumber),state:O(e.state),stairs:O(e.stairs),digitCode:O(e.digitCode),stateLevel2:"",door:O(e.door),floor:O(e.floor)}))))}bankAccountAutofillView(e){return Promise.all(e.bankAccountsResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.BankAccount,name:O(e.accountName),owner:O(e.ownerName),IBAN:O(e.IBAN),BIC:O(e.BIC),bank:"",bankCode:O(e.bankCode),country:O(e.country)}))))}companyAutofillView(e){return Promise.all(e.companiesResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.Company,name:O(e.companyName),jobTitle:O(e.jobTitle)}))))}filteredCredentials(e,t,s){const r=s.map((e=>new b.Y(e).getRootDomain()));return e.filter((e=>{const s=new b.Y(e.URL).getRootDomain();return s===t||(!!r.includes(s)||!!e.linkedURLs.map((e=>new b.Y(e).getRootDomain())).includes(t))}))}async credentialAutofillView(e,t){const{getDashlaneDefinedLinkedWebsites:s}=this.linkedWebsitesClient.queries,{getPreferencesForCredentials:r}=this.autofillSettings.queries,i=await(0,_.z)(s({url:t??""}));if((0,d.hx)(i))throw new Error("Failed to retrieve dashlane linked website for domain: "+i.error);const a=t?this.filteredCredentials(e.credentialsResult.items,t,i.data):e.credentialsResult.items,o=a.map((({id:e})=>e)),c=await(0,_.z)(r({credentialIds:o}));if((0,d.hx)(c))throw new Error("Failed to retrieve preferences result: "+c.error);const l=c.data;return Promise.all(a.map((async e=>{const r=l.find((({id:t})=>t===e.id)),i=await(0,_.z)(s({url:e.URL}));if(!r||(0,d.hx)(i))throw new Error("Failed to map Credential to autofill view");const a=await this.getSharingInfoForItem(e.id),{data:o}=i,{useAutoLogin:c,requireMasterPassword:u,onlyAutofillExactDomain:p}=r;return{...this.baseItemAutofillView(e),vaultType:n.k.Credential,title:O(e.itemName),url:O(e.URL),secondaryLogin:O(e.alternativeUsername),email:O(e.email),password:O(e.password),otpSecret:O(e.otpSecret),matchType:C(t??"",e,o),login:O(e.username),hasOtp:Boolean(e.otpURL)||Boolean(e.otpSecret),otpUrl:O(e.otpURL),autoLogin:c,autoProtected:u,subdomainOnly:p,userAddedLinkedWebsites:e.linkedURLs,sharingStatus:a}})))}async getSharingInfoForItem(e){const{getPermissionForItem:t}=this.sharingItemsClient.queries,s=await(0,_.z)(t({itemId:e}));if((0,d.hx)(s))throw new Error("Failed to get sharing info for item in `autofill-data.service`");const{permission:r}=s.data;return r?{isShared:!0,hasAdminPermission:r===w.y3.Admin}:{isShared:!1}}driverLicenseAutofillView(e){return Promise.all(e.driversLicensesResult.items.map((e=>{const t=A(D(R(e.expirationDate))),s=A(D(R(e.issueDate)));return{...this.baseItemAutofillView(e),vaultType:n.k.DriverLicense,expirationDay:t.getDate(),expirationMonth:t.getMonth()+1,expirationYear:t.getFullYear(),expirationDateFull:`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`,idNumber:O(e.idNumber),issueDay:s.getDate(),issueMonth:s.getMonth()+1,issueYear:s.getFullYear(),issueDateFull:`${s.getFullYear()}-${s.getMonth()+1}-${s.getDate()}`,country:O(e.country),creationDate:D(e.creationDatetime),name:O(e.idName),state:O(e.state)}})))}emailAutofillView(e){return Promise.all(e.emailsResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.Email,email:O(e.emailAddress),name:O(e.itemName),type:e.type??"NO_TYPE"}))))}fiscalIdAutofillView(e){return Promise.all(e.fiscalIdsResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.FiscalId,creationDate:D(e.creationDatetime),country:O(e.country),idNumber:O(e.fiscalNumber),teledeclarantNumber:O(e.teledeclarantNumber)}))))}identityAutofillView(e){return Promise.all(e.identitiesResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.Identity,age:T(e),birthDate:O(e.birthDate),birthPlace:O(e.birthPlace),firstName:O(e.firstName),lastName2:O(e.lastName2),lastName:O(e.lastName),middleName:O(e.middleName),middleNameInitial:O(e.middleName),pseudo:O(e.pseudo),title:O(e.title)}))))}idCardAutofillView(e){return Promise.all(e.idCardsResult.items.map((e=>{const t=A(D(R(e.expirationDate))),s=A(D(R(e.issueDate)));return{...this.baseItemAutofillView(e),vaultType:n.k.IdCard,country:O(e.country),creationDate:D(e.creationDatetime),expirationDay:t.getDate(),expirationMonth:t.getMonth()+1,expirationYear:t.getFullYear(),expirationDateFull:`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`,idNumber:O(e.idNumber),issueDay:s.getDate(),issueMonth:s.getMonth()+1,issueYear:s.getFullYear(),issueDateFull:`${s.getFullYear()}-${s.getMonth()+1}-${s.getDate()}`,name:O(e.idName)}})))}noteAutofillView(e){return Promise.all(e.secureNotesResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.Note}))))}secretAutofillView(e){return Promise.all(e.secretsResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.Secret}))))}passportAutofillView(e){return Promise.all(e.passportsResult.items.map((e=>{const t=A(D(R(e.expirationDate))),s=A(D(R(e.issueDate)));return{...this.baseItemAutofillView(e),vaultType:n.k.Passport,country:e.country,creationDate:D(e.creationDatetime),deliveryPlace:e.issuePlace,expirationDay:t.getDate(),expirationMonth:t.getMonth()+1,expirationYear:t.getFullYear(),expirationDateFull:`${t.getFullYear()}-${t.getMonth()+1}-${t.getDate()}`,idNumber:O(e.idNumber),issueDay:s.getDate(),issueMonth:s.getMonth()+1,issueYear:s.getFullYear(),issueDateFull:`${s.getFullYear()}-${s.getMonth()+1}-${s.getDate()}`,name:O(e.idName)}})))}paymentCardAutofillView(e){return Promise.all(e.paymentCardsResult.items.map((e=>{let t="";return e.cardNumber&&e.cardNumber.trim().length>0&&(t=e.cardNumber.trim().slice(-4)),{...this.baseItemAutofillView(e),vaultType:n.k.PaymentCard,bank:"",cardNumber:O(e.cardNumber),cardNumberLastDigits:t,color:e.color||"BLUE_1",expireMonth:O(e.expireMonth),expireYear:O(e.expireYear),name:O(e.itemName),ownerName:O(e.ownerName),securityCode:O(e.securityCode),type:"PAYMENT_TYPE_MASTERCARD"}})))}personalWebsiteAutofillView(e){return Promise.all(e.websitesResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.PersonalWebsite,name:O(e.itemName),website:O(e.URL)}))))}phoneAutofillView(e){return Promise.all(e.phonesResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.Phone,name:O(e.itemName),numberInternational:O(e.numberInternational),number:O(e.phoneNumber),type:e.type}))))}socialSecurityIdAutofillView(e){return Promise.all(e.socialSecurityIdsResult.items.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.SocialSecurityId,name:O(e.idName),idNumber:O(e.idNumber),country:O(e.country),creationDate:D(e.creationDatetime)}))))}filterPasskeys(e,t){return e.filter((e=>{const s=new b.Y(e.rpId).getHostname(),r=new b.Y(t).getHostname();return r===s||r.endsWith(`.${s}`)}))}passkeyAutofillView(e,t){const s=t?this.filterPasskeys(e.passkeysResult.items,t):e.passkeysResult.items;return Promise.all(s.map((e=>({...this.baseItemAutofillView(e),vaultType:n.k.Passkey,credentialId:e.credentialId,rpId:e.rpId,rpName:e.rpName,userDisplayName:e.userDisplayName,userHandle:e.userHandle,counter:e.counter,keyAlgorithm:e.keyAlgorithm}))))}constructor(e,t,s){this.autofillSettings=e,this.linkedWebsitesClient=t,this.sharingItemsClient=s,this.mapVaultItemToAutofillView={[n.k.Address]:this.addressAutofillView.bind(this),[n.k.BankAccount]:this.bankAccountAutofillView.bind(this),[n.k.Company]:this.companyAutofillView.bind(this),[n.k.Credential]:this.credentialAutofillView.bind(this),[n.k.DriverLicense]:this.driverLicenseAutofillView.bind(this),[n.k.Email]:this.emailAutofillView.bind(this),[n.k.FiscalId]:this.fiscalIdAutofillView.bind(this),[n.k.GeneratedPassword]:()=>{},[n.k.IdCard]:this.idCardAutofillView.bind(this),[n.k.Identity]:this.identityAutofillView.bind(this),[n.k.Passkey]:this.passkeyAutofillView.bind(this),[n.k.Passport]:this.passportAutofillView.bind(this),[n.k.PaymentCard]:this.paymentCardAutofillView.bind(this),[n.k.Phone]:this.phoneAutofillView.bind(this),[n.k.Secret]:this.secretAutofillView.bind(this),[n.k.Note]:this.noteAutofillView.bind(this),[n.k.SocialSecurityId]:this.socialSecurityIdAutofillView.bind(this),[n.k.PersonalWebsite]:this.personalWebsiteAutofillView.bind(this),[n.k.NoteCategory]:()=>{}}}}U=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S.W?Object:S.W,void 0===f.X?Object:f.X,void 0===I.s?Object:I.s])],U);var F=s(41842),P=s(43978),x=s(23032),N=s(46449);class G{execute({body:{itemId:e,itemType:t,rootDomain:s}}){return this.autofillDataRepository.getAutofillData(t,e).pipe((0,F.h)((e=>(0,d.d6)(e))),(0,P.w)((e=>this.autofillDataService.getAutofillViewForItems(t,e,s))),(0,o.U)((e=>e[0])),(0,o.U)(d.Vp))}constructor(e,t){this.autofillDataRepository=e,this.autofillDataService=t}}G=(0,r.__decorate)([(0,N.e)(x.a),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===v?Object:v,void 0===U?Object:U])],G);var k=s(16433),L=s(37182),M=s(37931);class K{execute({body:{itemType:e,domain:t,sorting:s,filters:r,pagination:i}}){return this.autofillDataRepository.getAutofillData(e,void 0,s,r,i?.pageSize,i?.pageNumber).pipe((0,F.h)((e=>(0,d.d6)(e))),(0,k.q)(1),(0,P.w)((s=>this.autofillDataService.getAutofillViewForItems(e,s,t))),(0,L.K)((e=>{throw new Error("get-multiple-autofill-data: error occured while mapping to autofill views: "+e)})),(0,o.U)(d.Vp))}constructor(e,t){this.autofillDataRepository=e,this.autofillDataService=t}}K=(0,r.__decorate)([(0,N.e)(M.N),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===v?Object:v,void 0===U?Object:U])],K);var j=s(49164);class V{execute({body:{searchQuery:e,itemTypes:t,domain:s,sorting:r,pagination:i}}){const a=t??[...Object.values(n.k).filter((e=>e!==n.k.GeneratedPassword&&e!==n.k.NoteCategory))];return this.autofillDataRepository.searchAutofillData(e,t,r,i?.pageSize,i?.pageNumber).pipe((0,F.h)((e=>(0,d.d6)(e))),(0,P.w)((e=>Promise.all(a.map((t=>this.autofillDataService.getAutofillViewForItems(t,e,s)))))),(0,L.K)((e=>{throw new Error("search-autofill-data: error occured while mapping to autofill views: "+e)})),(0,o.U)((e=>e.flatMap((e=>e)))),(0,o.U)(d.Vp))}constructor(e,t){this.autofillDataRepository=e,this.autofillDataService=t}}V=(0,r.__decorate)([(0,N.e)(j.w),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===v?Object:v,void 0===U?Object:U])],V);class z{}z=(0,r.__decorate)([(0,i.Yl)({api:a.c,handlers:{commands:{},events:{},queries:{getSingleAutofillData:G,getMultipleAutofillData:K,searchAutofillData:V}},providers:[v,U]})],z)},32611:(e,t,s)=>{s.d(t,{V:()=>h});var r=s(491),i=s(86006),a=s(32671),o=s(13800),n=s(92587);class c extends o.f{}c=(0,r.__decorate)([(0,n.GS)()],c);var d=s(82874),l=s(87279),u=s(43814);class p{execute({body:e}){const{credentialId:t}=e;return t&&this.autofillTrackingEventsEmitter.sendEvent("passwordAutofillPerformed",{credentialId:t}),Promise.resolve((0,l.Vp)(void 0))}constructor(e){this.autofillTrackingEventsEmitter=e}}p=(0,r.__decorate)([(0,d.W)(u.q),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===c?Object:c])],p);class h{}h=(0,r.__decorate)([(0,i.Yl)({api:a.Y,handlers:{commands:{temporaryEmitPasswordAutofillPerformedEvent:p},events:{},queries:{}},providers:[c]})],h)},67206:(e,t,s)=>{s.d(t,{J:()=>N});var r=s(491),i=s(86006),a=s(85324),o=s(69885),n=s(87065),c=s(60399),d=s(95502),l=s(14122),u=s(13134),p=s(92587),h=s(87279),m=s(93843),g=s(48501),v=s(21543);const y=e=>Object.keys(e).map((t=>[t].concat(e[t]))),_=e=>[...e].sort();var S=s(2585),f=s(39431),w=s(50879);class I{getDashlaneDefinedLinkedWebsites$(e){return(0,o.of)(this._getDashlaneDefinedLinkedWebsites(e)).pipe((0,n.U)(h.Vp))}getDashlaneDefinedLinkedWebsitesByList$(e){return(0,o.of)(this._getDashlaneDefinedLinkedWebsitesByList(e)).pipe((0,n.U)(h.Vp))}constructor(e,t){this.carbonLegacyClient=e,this.vaultItemsCrudClient=t,this.updateLinkedWebsites=async(e,t)=>{const s=await this.getCredentialById(t),r=this.getUserAddedLinkedWebsiteDomains(s),i=[...new Set(e)].filter(Boolean);var a,o;if(o=i,(a=r).length===o.length&&_(a).join("")===_(o).join(""))return;const n=0===i.length?[]:this.mergeLinkedWebsites(s,r,i),c={...s.LinkedServices,associated_domains:n},d=await this.carbonLegacyClient.commands.carbon({name:"updateCredential",args:[{id:t,update:{linkedServices:c}}]});if((0,h.hx)(d))throw new Error("Error when updating linked websites using updateCredential query from Carbon")},this.getCredentialByIdGraphene=e=>(0,c.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[f.U.Credential],ids:[e]}).pipe((0,n.U)((e=>(0,h.d6)(e)&&1===e.data.credentialsResult.matchCount?e.data.credentialsResult.items[0]:null)))),this.populateDashlaneDefinedLinkedWebsitesIndex=e=>{const t={};return e.forEach((e=>{e.forEach((s=>{t[s]=e}))})),t},this.mergeLinkedDomainsIntoList=(e,t)=>{const s=[],r=[];e.forEach((e=>{return i=t,e.some((e=>i.includes(e)))?s.push(e):r.push(e);var i}));const i=s.concat([t]).flat();return r.concat([i])},this.reduceLinkedDomainsLists=(e,t,s)=>e.concat(t,s).reduce(this.mergeLinkedDomainsIntoList,[]),this._getDashlaneDefinedLinkedWebsites=e=>{const t=new u.Y(e).getRootDomain();return t?this.allDashlaneDefinedLinkedWebsitesIndex[t]||[t]:[]},this._getDashlaneDefinedLinkedWebsitesByList=e=>e.map((e=>this._getDashlaneDefinedLinkedWebsites(e))),this.getCredentialById=e=>{const{carbonState:t}=this.carbonLegacyClient.queries;return(0,c.z)(t({path:"userSession.personalData.credentials"}).pipe((0,n.U)((t=>{if(!(0,h.d6)(t)||!(0,S.A)(t.data))throw new Error("Bad credential format");const s=t.data.find((t=>t.Id===e));if(s)return s;throw new Error("Cannot find credential")}))))},this.getUserAddedLinkedWebsiteDomains=e=>e.LinkedServices?.associated_domains?.flatMap((({domain:e})=>Boolean(e)?e:[]))??[],this.getNewLinkedWebsitesToAdd$=(e,t)=>t.filter((t=>!e.includes(t))).map(this.linkedWebsiteFormatter),this.linkedWebsiteFormatter=e=>({domain:e,source:d.k.Manual}),this.mergeLinkedWebsites=(e,t,s)=>[...(e.LinkedServices?.associated_domains??[]).filter((e=>s.includes(e.domain))),...this.getNewLinkedWebsitesToAdd$(t,s)],this.allDashlaneDefinedLinkedWebsitesIndex=this.populateDashlaneDefinedLinkedWebsitesIndex(this.reduceLinkedDomainsLists(m,y(v),y(g)).map((e=>[...new Set(e)])))}}I=(0,r.__decorate)([(0,p.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===l._?Object:l._,void 0===w.L?Object:w.L])],I);var b=s(82874),E=s(56231);class C{async execute({body:{credentialId:e,linkedWebsite:t}}){const s=await this.repository.getCredentialByIdGraphene(e);if(!s)return(0,h.Rn)((0,E.i6)());if(s.linkedURLs.find((e=>e===t)))return(0,h.Rn)((0,E.lD)());const r=await this.vaultItemsCrudClient.commands.updateVaultItem({vaultItemType:f.U.Credential,id:e,content:{linkedURLs:[...s.linkedURLs,t]}});return(0,h.hx)(r)?(0,h.Rn)((0,E.R6)()):(0,h.Vp)(void 0)}constructor(e,t){this.repository=e,this.vaultItemsCrudClient=t}}C=(0,r.__decorate)([(0,b.W)(E.vp),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===I?Object:I,void 0===w.L?Object:w.L])],C);var A=s(23425);class R{async execute({body:{credentialId:e,linkedWebsite:t}}){const s=await this.repository.getCredentialByIdGraphene(e);if(!s)return(0,h.Rn)((0,A.W4)());const r=await this.vaultItemsCrudClient.commands.updateVaultItem({vaultItemType:f.U.Credential,id:e,content:{linkedURLs:[...s.linkedURLs.filter((e=>e!==t))]}});return(0,h.hx)(r)?(0,h.Rn)((0,A.cQ)()):(0,h.Vp)(void 0)}constructor(e,t){this.repository=e,this.vaultItemsCrudClient=t}}R=(0,r.__decorate)([(0,b.W)(A.M7),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===I?Object:I,void 0===w.L?Object:w.L])],R);var T=s(92712);class O{async execute({body:{credentialId:e,updatedLinkedWebsitesList:t}}){try{return await this.linkedWebsites.updateLinkedWebsites(t,e),(0,h.Vp)(void 0)}catch(e){return(0,h.Rn)({tag:"",error:e instanceof Error?e:new Error("Update linked websites command failed")})}}constructor(e){this.linkedWebsites=e}}O=(0,r.__decorate)([(0,b.W)(T.A),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===I?Object:I])],O);var D=s(46449),U=s(73328);class F{execute({body:{url:e=""}}){return this.linkedWebsites.getDashlaneDefinedLinkedWebsites$(e)}constructor(e){this.linkedWebsites=e}}F=(0,r.__decorate)([(0,D.e)(U.J),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===I?Object:I])],F);var P=s(34674);class x{execute({body:{urls:e}}){return this.linkedWebsites.getDashlaneDefinedLinkedWebsitesByList$(e)}constructor(e){this.linkedWebsites=e}}x=(0,r.__decorate)([(0,D.e)(P.E),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===I?Object:I])],x);class N{}N=(0,r.__decorate)([(0,i.Yl)({api:a.G,handlers:{commands:{addLinkedWebsite:C,removeLinkedWebsite:R,updateLinkedWebsites:O},events:{},queries:{getDashlaneDefinedLinkedWebsites:F,getMultipleDashlaneDefinedLinkedWebsites:x}},providers:[I]})],N)},53183:(e,t,s)=>{s.d(t,{r:()=>b});var r=s(491),i=s(10839),a=s(63433),o=s(86006),n=s(82874),c=s(87279),d=s(1006),l=s(92587),u=s(63144),p=s(56618),h=s(62149),m=s(10722);const g=e=>void 0!==e&&"boolean"==typeof e;class v extends((0,u.Q)({persist:!0,storage:{initialValue:!1,typeGuard:g,schemaVersion:1},scope:h.F.User,storeName:"autofill-disabled-notification",capacity:p.Y._001KB,codec:m.E})){}class y{get autofillDisabledOnLoginsAndFormsNotificationStatus(){return{get$:this._getAutofillDisabledOnLoginsAndFormsNotificationStatus$,set:this._setAutofillDisabledOnLoginsAndFormsNotificationStatus.bind(this)}}get _getAutofillDisabledOnLoginsAndFormsNotificationStatus$(){return this.store.state$}async _setAutofillDisabledOnLoginsAndFormsNotificationStatus(e){try{await this.store.set(e)}catch{throw new Error("SetAutofillDisabledOnLoginsAndFormsNotificationStatus command from autofill-core failed")}}constructor(e){this.store=e}}y=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===v?Object:v])],y);class _{async execute({body:e}){const{status:t}=e;return await this.autofillDisabledNotificationRepository.autofillDisabledOnLoginsAndFormsNotificationStatus.set(t),(0,c.Vp)(void 0)}constructor(e){this.autofillDisabledNotificationRepository=e}}_=(0,r.__decorate)([(0,n.W)(d.a),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===y?Object:y])],_);var S=s(87065),f=s(46449),w=s(24584);class I{execute(){return this.repository.autofillDisabledOnLoginsAndFormsNotificationStatus.get$.pipe((0,S.U)(c.Vp))}constructor(e){this.repository=e}}I=(0,r.__decorate)([(0,f.e)(w.z),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===y?Object:y])],I);class b{}b=(0,r.__decorate)([(0,o.Yl)({api:i._,handlers:{commands:{setAutofillDisabledOnLoginsAndFormsNotificationStatus:_},events:{},queries:{getAutofillDisabledOnLoginsAndFormsNotificationStatus:I}},stores:[v],providers:[y],requiredFeatureFlips:Object.values(a.S)})],b)},39331:(e,t,s)=>{s.d(t,{k:()=>k});var r=s(491),i=s(56979),a=s(63433),o=s(86006),n=s(82874),c=s(87279),d=s(84471),l=s(60399),u=s(92587),p=s(63144),h=s(56618),m=s(62149),g=s(10722);const v=e=>!!e&&"object"==typeof e&&Object.values(e).every((e=>Array.isArray(e)))&&Object.keys(e).every((e=>"string"==typeof e));class y extends((0,p.Q)({persist:!0,storage:{initialValue:{},typeGuard:v,schemaVersion:1},scope:m.F.User,storeName:"phishing-prevention-optouts",capacity:h.Y._010KB,codec:g.E})){}class _{get phishingPreventionOptOuts(){return{get$:this._getPhishingPreventionOptOuts$,set$:this._setPhishingPreventionOptOut.bind(this)}}async disablePhishingPreventionForUrl(e,t){const s=await(0,l.z)(this._getPhishingPreventionOptOuts$),r={...s,[e]:Array.from(new Set(s[e]??[]).add(t))};await this._setPhishingPreventionOptOut(r)}get _getPhishingPreventionOptOuts$(){return this.store.state$}async _setPhishingPreventionOptOut(e){try{await this.store.set(e)}catch{throw new Error("SetPhishingPreventionOptOut command from autofill-core has failed")}}constructor(e){this.store=e}}_=(0,r.__decorate)([(0,u.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===y?Object:y])],_);class S{async execute({body:{credentialUrl:e,pasteDestinationUrl:t}}){return await this.phishingPreventionRepository.disablePhishingPreventionForUrl(e,t),(0,c.Vp)(void 0)}constructor(e){this.phishingPreventionRepository=e}}S=(0,r.__decorate)([(0,n.W)(d.z),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===_?Object:_])],S);var f=s(46449),w=s(49739),I=s(87065),b=s(85390),E=s(69885),C=s(14122),A=s(30812),R=s(28216),T=s(2585);class O{getIsVaultItemProtected$(e,t){return this._isVaultItemProtected(e,t).pipe((0,I.U)(c.Vp))}getIsPhishingPreventionEnabled$(){return this._isPhishingPreventionEnabled().pipe((0,I.U)(c.Vp))}constructor(e){this.carbonLegacyClient=e,this.isUserSSO=()=>{const{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.localSettings.premiumStatus"}).pipe((0,I.U)((e=>{if(!(0,c.d6)(e))throw new Error("Cannot retrieve premium status");return e.spaces})),(0,I.U)((e=>e?.[0].isSSOUser??!1)))},this.areProtectedItemsUnlocked=()=>{const{carbonState:e}=this.carbonLegacyClient.queries;return(0,b.a)([e({path:"userSession.session.lastMasterPasswordCheck"}),e({path:"userSession.account.login"})]).pipe((0,I.U)((([e,t])=>{if(!(0,c.d6)(e)||"number"!=typeof e.data)throw new Error("Cannot retrieve last master password check");if(!(0,c.d6)(t)||"string"!=typeof t.data)throw new Error("No active login");const s=e.data,r=t.data;return Date.now()-s<(/^kw_test_auto_fmpc_.*/.test(r)?5e3:3e5)})))},this.isItemUnlocked=()=>(0,b.a)([this.areProtectedItemsUnlocked(),this.isUserSSO()]).pipe((0,I.U)((([e,t])=>e||t))),this.isGlobalCredentialProtectionSettingOn=()=>{const{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.personalSettings.ProtectPasswords"}).pipe((0,I.U)((e=>{if(!(0,c.d6)(e)||"boolean"!=typeof e.data)throw new Error("No global setting found");return e.data})))},this.getCredentialProtectionStatus=e=>{const{carbonState:t}=this.carbonLegacyClient.queries;return t({path:"userSession.personalData.credentials"}).pipe((0,I.U)((t=>{if(!(0,c.d6)(t)||!(0,T.A)(t.data))throw new Error("Bad credential format");const s=t.data;return s.find((t=>t.Id===e))?.AutoProtected??!1})))},this.getIsMPRequiredForCreditCardOrSocialSecurityId=()=>{const{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.personalSettings.SecuredDataAutofillCreditcard"}).pipe((0,I.U)((e=>!(0,c.d6)(e)||"boolean"!=typeof e.data||e.data)))},this._isVaultItemProtected=(e,t)=>e===A.k.PaymentCard||e===A.k.SocialSecurityId?(0,b.a)([this.isItemUnlocked(),this.getIsMPRequiredForCreditCardOrSocialSecurityId()]).pipe((0,I.U)((([e,t])=>({disableMode:R.M.CannotDisable,isProtected:t&&!e})))):e===A.k.Credential?(0,b.a)([this.isItemUnlocked(),this.isGlobalCredentialProtectionSettingOn(),this.getCredentialProtectionStatus(t)]).pipe((0,I.U)((([e,t,s])=>t?{disableMode:R.M.DisableGeneralSetting,isProtected:!e}:{disableMode:R.M.DisableSpecificVaultItem,isProtected:s&&!e}))):(0,E.of)({disableMode:R.M.CannotDisable,isProtected:!1}),this._isPhishingPreventionEnabled=()=>{const{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.localSettings.nodePremiumStatus"}).pipe((0,I.U)((e=>{if(!(0,c.d6)(e))throw new Error("Cannot retrieve premium status");const t=e.data;return t.capabilities?.autofillWithPhishingPrevention.enabled??!1})))}}}O=(0,r.__decorate)([(0,u.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===C._?Object:C._])],O);class D{execute({body:e}){const{vaultItemId:t,vaultType:s}=e;return this.autofillSecurity.getIsVaultItemProtected$(s,t)}constructor(e){this.autofillSecurity=e}}D=(0,r.__decorate)([(0,f.e)(w.u),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===O?Object:O])],D);var U=s(97653);class F{execute(){return this.autofillSecurity.getIsPhishingPreventionEnabled$()}constructor(e){this.autofillSecurity=e}}F=(0,r.__decorate)([(0,f.e)(U.i),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===O?Object:O])],F);var P=s(16743);class x{execute({body:{credentialUrl:e,pasteDestinationUrl:t}}){return this.phishingPreventionRepository.phishingPreventionOptOuts.get$.pipe((0,I.U)((s=>e in s&&(s[e]??[]).includes(t))),(0,I.U)(c.Vp))}constructor(e){this.phishingPreventionRepository=e}}x=(0,r.__decorate)([(0,f.e)(P.v),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===_?Object:_])],x);var N=s(8126);class G{async execute(){const{carbon:e}=this.carbonLegacyClient.commands,t=await e({name:"resetProtectedItemAutofillTimer",args:[]});return(0,c.hx)(t)?(0,c.Rn)({tag:"ResetProtectedItemAutofillTimer command from autofill/security failed"}):(0,c.Vp)(void 0)}constructor(e){this.carbonLegacyClient=e}}G=(0,r.__decorate)([(0,n.W)(N.y),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===C._?Object:C._])],G);class k{}k=(0,r.__decorate)([(0,o.Yl)({api:i.V,handlers:{commands:{resetProtectedItemAutofillTimer:G,disablePhishingPreventionForUrl:S},events:{},queries:{getAutofillProtectionContext:D,isPhishingPreventionCapabilityEnabled:F,isPhishingPreventionDisabledForUrl:x}},stores:[y],providers:[O,_],requiredFeatureFlips:Object.values(a.S)})],k)},2585:(e,t,s)=>{s.d(t,{A:()=>i});var r=s(96500);const i=e=>Array.isArray(e)&&e.every((e=>null!==e&&"object"==typeof e&&"kwType"in e&&(0,r.G)(e)))},75644:(e,t,s)=>{s.d(t,{P:()=>fe});var r=s(491),i=s(98716),a=s(63433),o=s(86006),n=s(82874),c=s(87279),d=s(62181),l=s(60399),u=s(87065),p=s(97280),h=s(14122),m=s(92587),g=s(34255),v=s(28489);var y=s(2585),_=s(39431);class S{get credentialsPreferences(){return{getByIds:this._getPreferencesForCredentials$.bind(this),set:this._setCredentialPreferences.bind(this)}}get isAutofillDisabled(){return{get$:this._getIsAutofillDisabled$,set:this._setIsAutofillDisabled.bind(this)}}get isAutologinDisabled(){return{get$:this._getIsAutologinDisabled$,set:this._setIsAutologinDisabled.bind(this)}}get disabledDomains(){return{get$:this._getDisabledDomains$,set:this._setDisabledDomains.bind(this),add:this._addDisabledDomains.bind(this),remove:this._removeDisabledDomains.bind(this)}}get disabledSourceTypes(){return{get$:this._getDisabledSourceTypes$,set:this._setDisabledSourceTypes.bind(this),add:this._addDisabledSourceTypes.bind(this),remove:this._removeDisabledSourceTypes.bind(this)}}get isFollowUpNotificationEnabled(){return{get$:this._getIsFollowUpNotificationEnabled$,set:this._setIsFollowUpNotificationEnabled.bind(this)}}async _updateSettings(e){const t=e.isAutofillDisabled??await(0,l.z)(this._getIsAutofillDisabled$),s=e.isAutologinDisabled??await(0,l.z)(this._getIsAutologinDisabled$),r=e.disabledDomains??await(0,l.z)(this._getDisabledDomains$),i=e.disabledSourceTypes??await(0,l.z)(this._getDisabledSourceTypes$),a=e.isFollowUpNotificationEnabled??await(0,l.z)(this._getIsFollowUpNotificationEnabled$),o=await this.carbonLegacyClient.commands.carbon({name:"updateAutofillSettings",args:[{AutofillSettings:{disabledDomains:r,disabledSourceTypes:i,isAutofillDisabled:t,isAutologinDisabled:s,isFollowUpNotificationEnabled:a}}]});if((0,c.hx)(o))throw new Error("Error when updating autofill settings using updateAutofillSettings query from Carbon")}get _getAutofillSettings$(){const{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.personalSettings.AutofillSettings"}).pipe((0,u.U)((e=>{if(!(0,c.d6)(e)||!(e=>!!e&&"object"==typeof e&&(0,v.l$)(e,"isAutofillDisabled")&&"boolean"==typeof e.isAutofillDisabled&&(0,v.l$)(e,"isAutologinDisabled")&&"boolean"==typeof e.isAutologinDisabled&&(0,v.l$)(e,"disabledSourceTypes")&&(0,g.rF)(e.disabledSourceTypes)&&(0,v.l$)(e,"disabledDomains")&&Array.isArray(e.disabledDomains)&&e.disabledDomains.every((e=>"string"==typeof e))&&(0,v.l$)(e,"isFollowUpNotificationEnabled")&&"boolean"==typeof e.isFollowUpNotificationEnabled)(e.data))throw new Error("AutofillSettings is not of the expected type");return e.data})),(0,p.d)(1))}async _setCredentialPreferences({credentialId:e,credentialUrl:t,onlyAutofillExactDomain:s,requireMasterPassword:r,useAutoLogin:i,shouldSkipSync:a}){const{carbonLegacyLeeloo:o}=this.carbonLegacyClient.commands,n=await o({name:"savePersonalDataItem",arg:[{kwType:_.U.Credential,origin:"MANUAL",content:{id:e,url:t,onlyForThisSubdomain:s,autoLogin:i,protectWithMasterPassword:r},shouldSkipSync:a}]});if((0,c.hx)(n))throw new Error(`Failed to update credential preferences for: ${e}`)}_getPreferencesForCredentials$(e){const{carbonState:t}=this.carbonLegacyClient.queries;return t({path:"userSession.personalData.credentials"}).pipe((0,u.U)((t=>{if((0,c.hx)(t)||!(0,y.A)(t.data))throw new Error("Bad credentials format when retrieving credential preferences");const s=e.length?t.data.filter((t=>e.includes(t.Id))):t.data;if(e.length&&s.length!==e.length)throw new Error("not able to find one or more credentials corresponding to the provided ids");return(0,c.Vp)(s.map((e=>({id:e.Id,useAutoLogin:Boolean(e.AutoLogin),onlyAutofillExactDomain:Boolean(e.SubdomainOnly),requireMasterPassword:Boolean(e.AutoProtected)}))))})))}get _getIsAutofillDisabled$(){return this._getAutofillSettings$.pipe((0,u.U)((({isAutofillDisabled:e})=>e)))}_setIsAutofillDisabled(e){return this._updateSettings({isAutofillDisabled:e})}get _getIsAutologinDisabled$(){return this._getAutofillSettings$.pipe((0,u.U)((({isAutologinDisabled:e})=>e)))}_setIsAutologinDisabled(e){return this._updateSettings({isAutologinDisabled:e})}_setIsFollowUpNotificationEnabled(e){return this._updateSettings({isFollowUpNotificationEnabled:e})}get _getDisabledDomains$(){return this._getAutofillSettings$.pipe((0,u.U)((({disabledDomains:e})=>e)))}_setDisabledDomains(e){return this._updateSettings({disabledDomains:e})}async _addDisabledDomains(e){const t=await(0,l.z)(this._getDisabledDomains$);return this._setDisabledDomains([...new Set([...t,...e])])}async _removeDisabledDomains(e){const t=await(0,l.z)(this._getDisabledDomains$);return this._setDisabledDomains(t.filter((t=>!e.includes(t))))}get _getDisabledSourceTypes$(){return this._getAutofillSettings$.pipe((0,u.U)((({disabledSourceTypes:e})=>e)))}_setDisabledSourceTypes(e){return this._updateSettings({disabledSourceTypes:e})}async _addDisabledSourceTypes(e){const t=await(0,l.z)(this._getDisabledSourceTypes$);return this._setDisabledSourceTypes([...new Set([...t,...e])])}async _removeDisabledSourceTypes(e){const t=await(0,l.z)(this._getDisabledSourceTypes$);return this._setDisabledSourceTypes(t.filter((t=>!e.includes(t))))}get _getIsFollowUpNotificationEnabled$(){return this._getAutofillSettings$.pipe((0,u.U)((({isFollowUpNotificationEnabled:e})=>e)))}constructor(e){this.carbonLegacyClient=e}}S=(0,r.__decorate)([(0,m.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===h._?Object:h._])],S);class f{async execute({body:{sourceTypes:e}}){return await this.settings.disabledSourceTypes.add(e),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}f=(0,r.__decorate)([(0,n.W)(d.g),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],f);var w=s(60355);class I{async execute(){return await this.settings.isAutofillDisabled.set(!0),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}I=(0,r.__decorate)([(0,n.W)(w.u),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],I);var b=s(64912);class E{async execute(){return await this.settings.disabledSourceTypes.add([...g.up]),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}E=(0,r.__decorate)([(0,n.W)(b.t),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],E);var C=s(41733);class A{async execute(){return await this.settings.disabledSourceTypes.add([...g.q_]),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}A=(0,r.__decorate)([(0,n.W)(C.f),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],A);var R=s(56858);class T{async execute(){return await this.settings.isAutologinDisabled.set(!0),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}T=(0,r.__decorate)([(0,n.W)(R.T),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],T);var O=s(41908);class D{async execute(){return await this.settings.isFollowUpNotificationEnabled.set(!1),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}D=(0,r.__decorate)([(0,n.W)(O.y),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],D);var U=s(91970);class F{async execute(){return await this.settings.isAutofillDisabled.set(!1),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}F=(0,r.__decorate)([(0,n.W)(U.c),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],F);var P=s(79798);class x{async execute(){return await this.settings.disabledSourceTypes.remove([...g.up]),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}x=(0,r.__decorate)([(0,n.W)(P.a),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],x);var N=s(33898);class G{async execute(){return await this.settings.disabledSourceTypes.remove([...g.q_]),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}G=(0,r.__decorate)([(0,n.W)(N.I),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],G);var k=s(94702);class L{async execute(){return await this.settings.isAutologinDisabled.set(!1),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}L=(0,r.__decorate)([(0,n.W)(k.i),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],L);var M=s(3499);class K{async execute(){return await this.settings.isFollowUpNotificationEnabled.set(!0),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}K=(0,r.__decorate)([(0,n.W)(M.B),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],K);var j=s(76751);class V{async execute({body:{sourceTypes:e}}){return await this.settings.disabledSourceTypes.remove(e),(0,c.Vp)(void 0)}constructor(e){this.settings=e}}V=(0,r.__decorate)([(0,n.W)(j.v),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],V);var z=s(23187),W=s(4427),q=s(63144),B=s(56618),$=s(62149),Y=s(10722);const Q=e=>!!e&&(0,W.P)(e);class H extends((0,q.Q)({persist:!0,storage:{initialValue:[],typeGuard:Q,schemaVersion:1},scope:$.F.Device,storeName:"user-autofill-corrections",capacity:B.Y._100KB,codec:Y.E})){}class J{get userAutofillCorrections(){return{get$:this._getUserAutofillCorrections$,set:this._setUserAutofillCorrections.bind(this)}}get _getUserAutofillCorrections$(){return this.store.state$}async _setUserAutofillCorrections(e){try{await this.store.set(e)}catch{throw new Error("SetUserAutofillCorrections command from core-autofill failed")}}constructor(e){this.store=e}}J=(0,r.__decorate)([(0,m.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===H?Object:H])],J);class Z{async execute({body:e}){const{corrections:t}=e;return await this.correctionsRepository.userAutofillCorrections.set(t),(0,c.Vp)(void 0)}constructor(e){this.correctionsRepository=e}}Z=(0,r.__decorate)([(0,n.W)(z.S),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===J?Object:J])],Z);var X=s(18880);class ee{async execute({body:e}){const{isAutofillEnabled:t,url:s}=e,{carbon:r}=this.carbonLegacyClient.commands,i=await r({name:"toggleDashlane",args:[{where:"site",autofill:t,autologin:t,url:s}]});if((0,c.hx)(i))throw new Error("Toggle Dashlane command from core-autofill failed");return(0,c.Vp)(void 0)}constructor(e){this.carbonLegacyClient=e}}ee=(0,r.__decorate)([(0,n.W)(X.r),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===h._?Object:h._])],ee);var te=s(66069);class se{async execute({body:e}){try{return await this.autofillSettings.credentialsPreferences.set(e),(0,c.Vp)(void 0)}catch(e){const t=e instanceof Error?e.message:"unable to update credential preferences";return(0,c.Rn)({tag:"error",errorMessage:t})}}constructor(e){this.autofillSettings=e}}se=(0,r.__decorate)([(0,n.W)(te.J),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],se);var re=s(85390),ie=s(43978),ae=s(46449),oe=s(13134),ne=s(37233);var ce,de,le;!function(e){e[e.UNKNOWN_ERROR=0]="UNKNOWN_ERROR"}(ce||(ce={})),function(e){e.EMAIL_TOKEN="email_token",e.DEVICE_REGISTRATION="totp_device_registration",e.LOGIN="totp_login",e.SSO="sso"}(de||(de={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.PENDING=1]="PENDING",e[e.ERROR=2]="ERROR",e[e.READY=3]="READY"}(le||(le={}));const ue=e=>{if(!(t=e)||"object"!=typeof t||!(0,v.l$)(t,"status")||"number"!=typeof t.status)throw new Error("twoFactorAuthentication is not of the expected type");var t;return 3===e.status&&e.shouldEnforceTwoFactorAuthentication},pe=e=>!!e&&"object"==typeof e&&Array.isArray(e)&&e.every((e=>"string"==typeof e));class he{execute({body:{url:e}}){const{carbonState:t}=this.carbonLegacyClient.queries,s=new oe.Y(e),r=s.getRootDomain(),i=s.getHost(),a=t({path:"device.killswitch.disableAutofill"}).pipe((0,u.U)((e=>{if(!(0,c.d6)(e)||!(e=>"boolean"==typeof e)(e.data))throw new Error("Error when fetching killswitch.disableAutofill");return e.data}))),o=(0,re.a)({isAutofillDisabled:this.settings.isAutofillDisabled.get$,disabledDomains:this.settings.disabledDomains.get$}).pipe((0,ie.w)((async({isAutofillDisabled:e,disabledDomains:t})=>e||t.includes(await r)))),n=t({path:"userSession.spaceData.spaces"}).pipe((0,ie.w)((async e=>{if(!(0,c.d6)(e)||!(e=>!!e&&"object"==typeof e&&Array.isArray(e)&&e.every((e=>(0,v.l$)(e,"details")&&(0,v.l$)(e.details,"info"))))(e.data))throw new Error("Error when fetching spaceData.spaces");const t=e.data.reduce(((e,t)=>{const s=t.details.info.autologinDomainDisabledArray;return[...e,...pe(s)?s:[]]}),[]),s=await i;return t.some((e=>{const t=new oe.Y(e).getHost();return t===s||s.endsWith(`.${t}`)}))}))),d=t({path:"authentication.twoFactorAuthentication"}).pipe((0,u.U)((e=>{if(!(0,c.d6)(e))throw new Error("Error when fetching authentication.twoFactorAuthentication");return ue(e.data)})));return(0,re.a)({isAutofillDisabledByB2BAdmin:n,isAutofillDisabledByKillswitch:a,isAutofillDisabledByUser:o,isAutofillDisabledBy2FAEnforcement:d}).pipe((0,u.U)((({isAutofillDisabledBy2FAEnforcement:e,isAutofillDisabledByB2BAdmin:t,isAutofillDisabledByKillswitch:s,isAutofillDisabledByUser:r})=>{let i=ne._.ANALYSIS_ENABLED;return s?i=ne._.ANALYSIS_DISABLED_BY_KILLSWITCH:t?i=ne._.ANALYSIS_DISABLED_BY_B2B_ADMIN:r?i=ne._.ANALYSIS_DISABLED_BY_USER:e&&(i=ne._.ANALYSIS_DISABLED_BY_2FA_ENFORCEMENT),(0,c.Vp)({analysisStatus:i})})))}constructor(e,t){this.carbonLegacyClient=e,this.settings=t}}he=(0,r.__decorate)([(0,ae.e)(ne.h),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===h._?Object:h._,void 0===S?Object:S])],he);var me=s(56226);class ge{execute(){return(0,re.a)({disabledDomains:this.settings.disabledDomains.get$,disabledSourceTypes:this.settings.disabledSourceTypes.get$,isAutofillDisabled:this.settings.isAutofillDisabled.get$,isAutologinDisabled:this.settings.isAutologinDisabled.get$,isFollowUpNotificationEnabled:this.settings.isFollowUpNotificationEnabled.get$}).pipe((0,u.U)(c.Vp))}constructor(e){this.settings=e}}ge=(0,r.__decorate)([(0,ae.e)(me.T),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],ge);var ve=s(50672);class ye{execute(){return this.settings.userAutofillCorrections.get$.pipe((0,u.U)(c.Vp))}constructor(e){this.settings=e}}ye=(0,r.__decorate)([(0,ae.e)(ve.w),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===J?Object:J])],ye);var _e=s(50072);class Se{execute({body:{credentialIds:e=[]}}){return this.autofillSettingsRepository.credentialsPreferences.getByIds(e)}constructor(e){this.autofillSettingsRepository=e}}Se=(0,r.__decorate)([(0,ae.e)(_e.g),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],Se);class fe{}fe=(0,r.__decorate)([(0,o.Yl)({api:i.I,handlers:{commands:{toggleDashlane:ee,enableAnalysis:F,enableAutologin:L,enableAutofillOnForms:x,enableAutofillOnLogins:G,enableFollowUpNotification:K,disableAnalysis:I,disableAutologin:T,disableAutofillOnForms:E,disableAutofillOnLogins:A,disableFollowUpNotification:D,addDisabledSourceTypes:f,removeDisabledSourceTypes:V,setUserAutofillCorrections:Z,updateCredentialPreferences:se},events:{},queries:{getAnalysisStatusOnUrl:he,getAutofillSettings:ge,getUserAutofillCorrections:ye,getPreferencesForCredentials:Se}},stores:[H],providers:[S,J],requiredFeatureFlips:Object.values(a.S)})],fe)},96023:(e,t,s)=>{s.d(t,{K:()=>n});var r=s(75958),i=s(232),a=s(54154),o=s(84556);const n=(0,r.Q)({name:"teamEnclave",commands:{createTeamInEnclave:i.f},events:{},queries:{getTeamFromEnclave:a.m3,getTeamIdentifiers:o.r}})},25917:(e,t,s)=>{s.d(t,{G:()=>a});var r=s(8260),i=s(96023);class a extends((0,r.E)(i.K)){}(0,r.K)(i.K,a)},232:(e,t,s)=>{s.d(t,{f:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},54154:(e,t,s)=>{s.d(t,{SM:()=>n,m3:()=>c});var r,i=s(77535),a=s(62149),o=s(96168);!function(e){e.TEAM_NOT_PROVISIONED_IN_ENCLAVE="TEAM_NOT_PROVISIONED_IN_ENCLAVE"}(r||(r={}));const n=(0,o.Vj)("TEAM_NOT_PROVISIONED_IN_ENCLAVE","Team not provisioned in enclave");class c extends((0,i.k)({scope:a.F.User})){}},84556:(e,t,s)=>{s.d(t,{r:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},73820:(e,t,s)=>{s.d(t,{Z:()=>Z});var r=s(491),i=s(86006),a=s(75421),o=s(5206),n=s(19961),c=s(67051),d=s(96023),l=s(43991),u=s(63144),p=s(56618),h=s(62149);const m=e=>null!==e&&"object"==typeof e&&"adminProvisioningKey"in e&&"string"==typeof e.adminProvisioningKey&&"teamUuid"in e&&"string"==typeof e.teamUuid;class g extends((0,u.Q)({persist:!1,scope:h.F.User,storeName:"enclave-team-info",storeTypeGuard:m,initialValue:{adminProvisioningKey:void 0,teamUuid:void 0},capacity:p.Y._001KB})){}var v=s(82874),y=s(232),_=s(76500),S=s(14122),f=s(31108),w=s(87279),I=s(7165),b=s(54591);const E=I.z.object({data:I.z.object({deviceAccessKey:I.z.string(),deviceSecretKey:I.z.string()})}),C=I.z.object({data:I.z.object({devicePrivateKey:I.z.string(),devicePublicKey:I.z.string()})});class A{async execute(){let e;try{const t=await this.getTeamUuid(),s=await this.registerTeamDeviceWithAccount();e=s.deviceAccessKey;const r=await this.enclaveApiClient.teams.createTeam({teamDeviceCredentials:{teamUuid:t,accessKey:s.deviceAccessKey,secretKey:s.deviceSecretKey,sharingPublicKey:s.devicePublicKey,sharingPrivateKey:s.devicePrivateKey}});if((0,w.hx)(r))return r;const{adminProvisioningKey:i}=(0,w.db)(r);return await this.runSideEffects(t,i),(0,w.Vp)(void 0)}catch(t){switch(e&&await this.rollBackTeamCreation(e),t.message){case"TeamIdNotFound":return(0,w.Rn)({tag:"TeamIdNotFound"});case"RegisterTeamDeviceFailed":return(0,w.Rn)({tag:"RegisterTeamDeviceFailed"});default:return(0,w.Rn)({tag:"CreateTeamInEnclaveApiError"})}}}async getTeamUuid(){const{teamUuid:e}=await this.teamInfoStore.getState();if(!e)throw new Error("TeamIdNotFound");return e}async registerTeamDeviceWithAccount(){const e=await(async e=>{const t=await e.commands.registerTeamDevice({platform:b.h.NITRO,deviceName:"Nitro Encryption Service"});if((0,w.hx)(t))return t;const{data:{deviceAccessKey:s,deviceSecretKey:r}}=E.parse((0,w.db)(t)),i=await e.commands.registerTeamDeviceAccount({deviceAccessKey:s,shouldGenerateDeviceKeyPair:!0});if((0,w.hx)(i))return i;const{data:{devicePrivateKey:a,devicePublicKey:o}}=C.parse((0,w.db)(i));return(0,w.Vp)({deviceAccessKey:s,deviceSecretKey:r,devicePrivateKey:a,devicePublicKey:o})})(this.carbonClient);if((0,w.hx)(e))throw new Error("RegisterTeamDeviceFailed");return(0,w.db)(e)}async runSideEffects(e,t){await this.carbonClient.commands.persistAdminProvisioningKey({adminProvisioningKey:t}),await this.teamInfoStore.set({teamUuid:e,adminProvisioningKey:t})}async rollBackTeamCreation(e){await this.carbonClient.commands.deactivateTeamDevice({teamDeviceAccessKey:e})}constructor(e,t,s,r){this.enclaveApiClient=e,this.carbonClient=t,this.teamPlanClient=s,this.teamInfoStore=r}}A=(0,r.__decorate)([(0,v.W)(y.f),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===_.l?Object:_.l,void 0===S._?Object:S._,void 0===f.e?Object:f.e,void 0===g?Object:g])],A);var R=s(85798),T=s(19272),O=s(84895),D=s(8260);class U extends((0,D.E)(c.J)){}(0,D.K)(c.J,U);var F=s(60399),P=s(48844);const x=I.z.object({adminProvisioningKey:I.z.object({adminProvisioningKey:I.z.ostring().nullable(),itemId:I.z.ostring().nullable()}).optional().nullable()});var N=s(89238);const G=I.z.object({enabled:I.z.boolean()}).optional(),k=I.z.object({teamInfo:I.z.object({uuid:I.z.ostring().nullable(),ssoEnabled:I.z.boolean(),ssoIsNitroProvider:I.z.boolean(),ssoServiceProviderUrl:I.z.ostring().nullable(),ssoIdpMetadata:I.z.ostring().nullable(),ssoIdpEntrypoint:I.z.ostring().nullable()}),capabilities:I.z.object({sso:G})}),L=I.z.object({data:k}),M=I.z.object({message:I.z.string(),reason:I.z.nativeEnum(N._V)});class K{async handle(){if(!await this.isUserFullAdminRights())return;const e=await this.getTeamUuid(),t=await this.getAdminProvisioningKey();await this.teamInfoStore.set({teamUuid:e,adminProvisioningKey:t})}async getTeamUuid(){const e=await(async e=>{const{getTeamInfo:t}=e.commands,s=await t();if((0,w.hx)(s))switch(M.parse(s.error).reason){case N._V.UNAUTHORIZED:return(0,w.Rn)({tag:"UserNotAuthorized"});case N._V.UNKNOWN_ERROR:return(0,w.Rn)({tag:"CouldNotGetTeamStatus"});default:throw new Error("An unexpected error happened while trying to retrieve team info")}const{data:{teamInfo:r,capabilities:i}}=L.parse(s.data);return(0,w.Vp)({teamInfo:r,capabilities:i})})(this.carbonClient);if((0,w.hx)(e))throw new Error("[Enclave] - cannot retrieve team Uuid");const{teamInfo:{uuid:t}}=e.data;if(!t)throw new Error("[Enclave] - cannot retrieve team Uuid");return t}async getAdminProvisioningKey(){const e=await(0,F.z)(this.teamPlansClient.queries.getTeamId());if((0,w.hx)(e))throw new Error("[Enclave] - cannot retrieve team info");const t=e.data.teamId??"";return await((e,t)=>{const s=t({path:`userSession.teamAdminData.teams.${e}`}).pipe((0,P.nb)({success:e=>{const t=x.safeParse(e);if(!t.success)throw t.error;return t.data.adminProvisioningKey?.adminProvisioningKey??null},failure:()=>""}));return(0,F.z)(s)})(t,this.carbonClient.queries.carbonState)??void 0}async isUserFullAdminRights(){const e=await(0,F.z)(this.permissionsClient.queries.userPermissions());if((0,w.hx)(e))throw new Error("[Enclave] - Cannot get user permissions");return(0,w.db)(e).includes(T.fp.enum.ALL)}constructor(e,t,s,r){this.teamInfoStore=e,this.carbonClient=t,this.teamPlansClient=s,this.permissionsClient=r}}K=(0,r.__decorate)([(0,R.b)(O.L),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===g?Object:g,void 0===S._?Object:S._,void 0===f.e?Object:f.e,void 0===U?Object:U])],K);var j=s(27326);class V{async handle(){const e=await this.teamInfoStore.getState();this.teamInfoStore.set({teamUuid:e.teamUuid,adminProvisioningKey:void 0})}constructor(e){this.teamInfoStore=e}}V=(0,r.__decorate)([(0,R.b)(j.z),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===g?Object:g])],V);var z=s(43978),W=s(69885),q=s(162),B=s(46449),$=s(54154);class Y{execute(){return this.teamInfoStore.state$.pipe((0,z.w)((({teamUuid:e,adminProvisioningKey:t})=>{if(!e)throw new Error("GetTeamFromEnclave: Team UUID is missing");return t?(0,q.D)(this.enclaveApiClient.teams.getTeam({teamUuid:e,adminProvisioningKey:t})):(0,W.of)((0,w.Rn)((0,$.SM)()))})))}constructor(e,t){this.enclaveApiClient=e,this.teamInfoStore=t}}Y=(0,r.__decorate)([(0,B.e)($.m3),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===_.l?Object:_.l,void 0===g?Object:g])],Y);var Q=s(84556),H=s(87065);class J{execute(){return this.teamInfoStore.state$.pipe((0,H.U)((({teamUuid:e,adminProvisioningKey:t})=>{if(!e)throw new Error("GetTeamIdentifiersQueryHandler: Could not fetch any team identifiers");return(0,w.Vp)({teamUuid:e,adminProvisioningKey:t})})))}constructor(e){this.teamInfoStore=e}}J=(0,r.__decorate)([(0,B.e)(Q.r),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===g?Object:g])],J);class Z{}Z=(0,r.__decorate)([(0,i.Yl)({api:d.K,imports:[a.X,o.i,n.G],stores:[g],handlers:{commands:{createTeamInEnclave:A},events:{...(0,i.g4)(c.J,{permissionsLoaded:K}),...(0,i.g4)(l.y,{confidentialSsoSettingsReset:V})},queries:{getTeamFromEnclave:Y,getTeamIdentifiers:J}},domainName:"enclave"})],Z)},11712:(e,t,s)=>{s.d(t,{B:()=>a});var r=s(75958),i=s(43890);const a=(0,r.Q)({name:"notifications",commands:{},events:{},queries:{GetUserMessagesQuery:i.m}})},43890:(e,t,s)=>{s.d(t,{m:()=>o});var r,i=s(77535),a=s(62149);!function(e){e.DEFAULT="default",e.TRIAL_EXPIRED="trial_expired",e.WEB_STORE="web_store",e.DASHBOARD_UPGRADE="dashboard_upgrade",e.SHARING_CENTER_FAMILY="sharing_center_family",e.SHARING_CENTER_WORK="sharing_center_work"}(r||(r={}));class o extends((0,i.k)({scope:a.F.User})){}},32127:(e,t,s)=>{s.d(t,{F:()=>p});var r=s(491),i=s(86006),a=s(11712),o=s(41511),n=s(46449),c=s(14122),d=s(43890),l=s(48844);class u{execute(){const{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.localSettings.userMessages"}).pipe((0,l.Qn)((e=>e)))}constructor(e){this.carbonLegacyClient=e}}u=(0,r.__decorate)([(0,n.e)(d.m),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===c._?Object:c._])],u);class p{}p=(0,r.__decorate)([(0,i.Yl)({api:a.B,handlers:{commands:{},events:{},queries:{getUserMessages:u}},imports:[o.n],providers:[]})],p)},23765:(e,t,s)=>{var r;s.d(t,{G:()=>r}),function(e){e.OnboardingWebProfileNewUsers="onboarding_web_profileNewUsers_prod",e.OnboardingWebAVGSGForEmployeeOrB2C="onboarding_web_avgsg_for_employee_b2c_dev",e.OnboardingWebConfirmSite="onboarding_web_onboarding",e.OnboardingWebExtensionInstallStaticBanner="onboarding_web_extensionInstallStaticBanner",e.SaexOnboardingHubAddPasswords="saexOnboardingHubAddPasswords"}(r||(r={}))},47071:(e,t,s)=>{s.d(t,{U:()=>u});var r=s(75958),i=s(46221),a=s(59771),o=s(31867),n=s(50299),c=s(84119),d=s(74779),l=s(55267);const u=(0,r.Q)({name:"getStarted",commands:{dismissGetStarted:i.A,markAdminConsoleOpened:a.T},events:{},queries:{hasAddedMobileOnWeb:o.c,hasCompletedAutofillTutorial:n.G,hasCompletedCredentialTutorial:c.x,hasOpenedAdminConsole:d.s,isGetStartedDismissed:l.A}})},46221:(e,t,s)=>{s.d(t,{A:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},59771:(e,t,s)=>{s.d(t,{T:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},31867:(e,t,s)=>{s.d(t,{c:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},50299:(e,t,s)=>{s.d(t,{G:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},84119:(e,t,s)=>{s.d(t,{x:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},74779:(e,t,s)=>{s.d(t,{s:()=>i});var r=s(77535);class i extends((0,r.k)()){}},55267:(e,t,s)=>{s.d(t,{A:()=>i});var r=s(77535);class i extends((0,r.k)()){}},52862:(e,t,s)=>{s.d(t,{d:()=>c});var r=s(75958),i=s(58985),a=s(30986),o=s(63914),n=s(85183);const c=(0,r.Q)({name:"profileAdmin",commands:{markProfilingFormSeen:i.v,saveAnswer:a.L},events:{},queries:{answers:o.G,hasSeenProfilingForm:n.v}})},58985:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},30986:(e,t,s)=>{s.d(t,{L:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},63914:(e,t,s)=>{s.d(t,{G:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},85183:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},55743:(e,t,s)=>{s.d(t,{$:()=>k});var r=s(491),i=s(86006),a=s(47071),o=s(23765),n=s(62149),c=s(63144),d=s(56618),l=s(10722),u=s(7165);const p=u.z.object({hasOpenedAdminConsole:u.z.boolean(),isGetStartedDismissed:u.z.boolean()}),h=e=>p.safeParse(e).success;class m extends((0,c.Q)({storage:{schemaVersion:1,initialValue:{hasOpenedAdminConsole:!1,isGetStartedDismissed:!1},typeGuard:h},persist:!0,scope:n.F.User,storeName:"onboarding-get-started-store",capacity:d.Y._010KB,codec:l.E})){}var g=s(82874),v=s(87279),y=s(46221);class _{async execute(){const e=await this.store.getState();return await this.store.set({...e,isGetStartedDismissed:!0}),Promise.resolve((0,v.Vp)(void 0))}constructor(e){this.store=e}}_=(0,r.__decorate)([(0,g.W)(y.A),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===m?Object:m])],_);var S=s(59771);class f{async execute(){const e=await this.store.getState();return await this.store.set({...e,hasOpenedAdminConsole:!0}),Promise.resolve((0,v.Vp)(void 0))}constructor(e){this.store=e}}f=(0,r.__decorate)([(0,g.W)(S.T),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===m?Object:m])],f);var w=s(46449),I=s(31867),b=s(92587),E=s(14122),C=s(87065),A=s(6136);class R{get(){return this.carbonLegacyClient.queries.getWebOnboardingMode().pipe((0,C.U)((e=>{if(!(0,v.d6)(e))throw new Error("Error while retrieving the legacy onboarding state");return e.data.completedSteps})))}getAutofillTaskCompletion(){return this.get().pipe((0,C.U)((e=>!!e?.tryAutofillOnWeb)),(0,A.x)(),(0,C.U)(v.Vp))}getCredentialTaskCompletion(){return this.get().pipe((0,C.U)((e=>!!e?.saveCredentialOnWeb)),(0,A.x)(),(0,C.U)(v.Vp))}addMobileTaskCompletion(){return this.get().pipe((0,C.U)((e=>!!e?.addMobileOnWeb)),(0,A.x)(),(0,C.U)(v.Vp))}constructor(e){this.carbonLegacyClient=e}}R=(0,r.__decorate)([(0,b.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===E._?Object:E._])],R);class T{execute(){return this.onboardingStateGetterService.addMobileTaskCompletion()}constructor(e){this.onboardingStateGetterService=e}}T=(0,r.__decorate)([(0,w.e)(I.c),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===R?Object:R])],T);var O=s(50299);class D{execute(){return this.onboardingStateGetterService.getAutofillTaskCompletion()}constructor(e){this.onboardingStateGetterService=e}}D=(0,r.__decorate)([(0,w.e)(O.G),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===R?Object:R])],D);var U=s(84119);class F{execute(){return this.onboardingStateGetterService.getCredentialTaskCompletion()}constructor(e){this.onboardingStateGetterService=e}}F=(0,r.__decorate)([(0,w.e)(U.x),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===R?Object:R])],F);var P=s(74779);class x{execute(){return this.store.state$.pipe((0,C.U)((e=>(0,v.Vp)(e.hasOpenedAdminConsole))))}constructor(e){this.store=e}}x=(0,r.__decorate)([(0,w.e)(P.s),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===m?Object:m])],x);var N=s(55267);class G{execute(){return this.store.state$.pipe((0,C.U)((e=>(0,v.Vp)(e.isGetStartedDismissed))))}constructor(e){this.store=e}}G=(0,r.__decorate)([(0,w.e)(N.A),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===m?Object:m])],G);class k{}k=(0,r.__decorate)([(0,i.Yl)({api:a.U,stores:[m],handlers:{commands:{dismissGetStarted:_,markAdminConsoleOpened:f},events:{},queries:{hasAddedMobileOnWeb:T,hasCompletedAutofillTutorial:D,hasCompletedCredentialTutorial:F,hasOpenedAdminConsole:x,isGetStartedDismissed:G}},providers:[R],requiredFeatureFlips:Object.values(o.G)})],k)},88427:(e,t,s)=>{s.d(t,{y:()=>T});var r=s(491),i=s(86006),a=s(52862),o=s(23765),n=s(87065),c=s(46449),d=s(87279),l=s(63914),u=s(62149),p=s(63144),h=s(56618),m=s(10722),g=s(7165);const v=g.z.object({questionKey:g.z.string(),completed:g.z.boolean(),selectedAnswers:g.z.array(g.z.string())}),y=g.z.object({hasSeenProfilingForm:g.z.boolean(),answers:g.z.array(v)}),_=e=>y.safeParse(e).success;class S extends((0,p.Q)({persist:!0,capacity:h.Y._010KB,scope:u.F.User,storeName:"profile-admin-store",codec:m.E,storage:{schemaVersion:1,initialValue:{answers:[],hasSeenProfilingForm:!1},typeGuard:_}})){}class f{execute(){return this.profileAdminStore.state$.pipe((0,n.U)((e=>(0,d.Vp)({answers:e.answers}))))}constructor(e){this.profileAdminStore=e}}f=(0,r.__decorate)([(0,c.e)(l.G),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],f);var w=s(85183);class I{execute(){return this.profileAdminStore.state$.pipe((0,n.U)((e=>(0,d.Vp)({hasSeenProfilingForm:e.hasSeenProfilingForm}))))}constructor(e){this.profileAdminStore=e}}I=(0,r.__decorate)([(0,c.e)(w.v),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],I);var b=s(82874),E=s(58985);class C{async execute(){const e=await this.profileAdminStore.getState();return this.profileAdminStore.set({...e,hasSeenProfilingForm:!0}),Promise.resolve((0,d.Vp)(void 0))}constructor(e){this.profileAdminStore=e}}C=(0,r.__decorate)([(0,b.W)(E.v),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],C);var A=s(30986);class R{async execute({body:e}){const t=await this.profileAdminStore.getState(),s=t.answers.findIndex((t=>t.questionKey===e.questionKey));return-1===s?t.answers.push(e):t.answers[s]=e,this.profileAdminStore.set(t),Promise.resolve((0,d.Vp)(void 0))}constructor(e){this.profileAdminStore=e}}R=(0,r.__decorate)([(0,b.W)(A.L),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S?Object:S])],R);class T{}T=(0,r.__decorate)([(0,i.Yl)({api:a.d,stores:[S],handlers:{commands:{markProfilingFormSeen:C,saveAnswer:R},events:{},queries:{answers:f,hasSeenProfilingForm:I}},requiredFeatureFlips:Object.values(o.G)})],T)},25593:(e,t,s)=>{s.d(t,{J:()=>o});var r=s(75958),i=s(3100),a=s(17308);const o=(0,r.Q)({name:"antiphishing",commands:{addAutoRedirectedDomain:i.A},events:{},queries:{isAutoRedirectedDomain:a.U}})},3100:(e,t,s)=>{s.d(t,{A:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},17308:(e,t,s)=>{s.d(t,{U:()=>i});var r=s(77535);class i extends((0,r.k)()){}},66706:(e,t,s)=>{s.d(t,{H:()=>c});var r=s(75958),i=s(87425),a=s(29362),o=s(60466),n=s(5202);const c=(0,r.Q)({name:"breaches",commands:{dismissBreach:i.n,markBreachAsSeen:a.Q},events:{},queries:{breach:o.i,unreadBreachesCount:n.L}})},71926:(e,t,s)=>{var r,i;s.d(t,{J:()=>r}),function(e){e.PENDING="PENDING",e.VIEWED="VIEWED",e.ACKNOWLEDGED="ACKNOWLEDGED"}(r||(r={})),function(e){e.Username="username",e.Password="password",e.Email="email",e.CreditCard="creditcard",e.Phone="phone",e.Address="address",e.SSN="ssn",e.IP="ip",e.Location="geolocation",e.PersonalInfo="personalinfo",e.SocialNetwork="social"}(i||(i={}))},87425:(e,t,s)=>{s.d(t,{n:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},29362:(e,t,s)=>{s.d(t,{Q:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},60466:(e,t,s)=>{s.d(t,{i:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},5202:(e,t,s)=>{s.d(t,{L:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},36282:(e,t,s)=>{s.d(t,{M:()=>d});var r=s(75958),i=s(92452),a=s(11959),o=s(49590),n=s(27655),c=s(43473);const d=(0,r.Q)({name:"emailMonitoring",commands:{dismissOnboardingNotification:i.n,optinEmail:a.P5,optoutEmail:o.Lc},events:{},queries:{emailList:n.dB,onboardingNotificationState:c.p}})},92452:(e,t,s)=>{s.d(t,{n:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},11959:(e,t,s)=>{s.d(t,{Dq:()=>o,Iy:()=>c,P5:()=>p,Qj:()=>l,XX:()=>n,pK:()=>d,tp:()=>u});var r=s(13385),i=s(62149),a=s(96168);const o="OK";var n;!function(e){e.INVALID_EMAIL="EMAIL_IS_INVALID",e.ALREADY_SUBSCRIBED="USER_HAS_ALREADY_AN_ACTIVE_SUBSCRIPTION",e.TOO_MANY_SUBSCRIPTIONS="USER_HAS_TOO_MANY_SUBSCRIPTIONS",e.GENERIC_ERROR="GENERIC_ERROR"}(n||(n={}));const c=(0,a.Vj)("EMAIL_IS_INVALID",""),d=(0,a.Vj)("USER_HAS_ALREADY_AN_ACTIVE_SUBSCRIPTION",""),l=(0,a.Vj)("USER_HAS_TOO_MANY_SUBSCRIPTIONS",""),u=(0,a.Vj)("GENERIC_ERROR","");class p extends((0,r.g)({scope:i.F.User})){}},49590:(e,t,s)=>{s.d(t,{KP:()=>n,Lc:()=>u,QS:()=>o,h1:()=>d,uD:()=>c,v4:()=>l});var r=s(13385),i=s(62149),a=s(96168);const o="OK";var n;!function(e){e.INVALID_EMAIL="EMAIL_IS_INVALID",e.NO_SUBSCRIPTION="USER_HAS_NO_SUBSCRIPTION",e.GENERIC_ERROR="GENERIC_ERROR"}(n||(n={}));class c extends((0,a.Hu)("EMAIL_IS_INVALID","")){}class d extends((0,a.Hu)("USER_HAS_NO_SUBSCRIPTION","")){}class l extends((0,a.Hu)("GENERIC_ERROR","")){}class u extends((0,r.g)({scope:i.F.User})){}},27655:(e,t,s)=>{s.d(t,{a2:()=>a,dB:()=>o,wp:()=>r});var r,i=s(77535);function a(e){return"pending"===e||"active"===e||"disabled"===e}!function(e){e.PENDING="pending",e.ACTIVE="active",e.DISABLED="disabled"}(r||(r={}));class o extends((0,i.k)()){}},43473:(e,t,s)=>{s.d(t,{p:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},6538:(e,t,s)=>{s.d(t,{i:()=>n});var r=s(75958),i=s(34621),a=s(85869),o=s(81721);const n=(0,r.Q)({name:"otp",commands:{setupOtpCodeForCredential:i.z},events:{},queries:{otpCode:a.J,otpCodeForSecretOrUrl:o.S}})},34621:(e,t,s)=>{s.d(t,{z:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},85869:(e,t,s)=>{s.d(t,{J:()=>n,c:()=>o});var r=s(77535),i=s(62149),a=s(96168);class o extends((0,a.Hu)("Cannot generate OTP code due to no OtpSecret or OtpUrl found for credential","")){}class n extends((0,r.k)({scope:i.F.User})){}},81721:(e,t,s)=>{s.d(t,{S:()=>n,k:()=>o});var r=s(77535),i=s(62149),a=s(96168);class o extends((0,a.Hu)("Cannot generate OTP code for secret or url","")){}class n extends((0,r.k)({scope:i.F.User})){}},68754:(e,t,s)=>{s.d(t,{d:()=>v});var r=s(75958),i=s(90797),a=s(45101),o=s(52835),n=s(94388),c=s(17430),d=s(22231),l=s(44955),u=s(25374),p=s(35642),h=s(69134),m=s(61613),g=s(94449);const v=(0,r.Q)({name:"passwordHealth",commands:{updateIsCredentialExcluded:a.v,recalculatePasswordHealth:o.t,updateHealthState:i.V},events:{passwordHealthComputationFinished:n.w},queries:{credentialHealthData:c.w,filterCredentials:d.Q,filterCredentialsIds:l.M,score:u.e,compromisedCredentials:p.v,compromisedCredentialsIdsForBreach:h.A,passwordHealthReport:m.b,scoreForPassword:g.c}})},45101:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},52835:(e,t,s)=>{s.d(t,{t:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},90797:(e,t,s)=>{s.d(t,{V:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},94388:(e,t,s)=>{s.d(t,{w:()=>a});var r=s(446),i=s(62149);class a extends((0,r.d)({scope:i.F.User})){}},69134:(e,t,s)=>{s.d(t,{A:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},35642:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},17430:(e,t,s)=>{s.d(t,{w:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},44955:(e,t,s)=>{s.d(t,{M:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},22231:(e,t,s)=>{s.d(t,{Q:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},61613:(e,t,s)=>{s.d(t,{b:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},94449:(e,t,s)=>{s.d(t,{c:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},25374:(e,t,s)=>{s.d(t,{e:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},97203:(e,t,s)=>{s.d(t,{f:()=>r});const r=(0,s(75958).Q)({name:"vaultReport",commands:{},events:{},queries:{}})},53195:(e,t,s)=>{s.d(t,{v:()=>I});var r=s(491),i=s(86006),a=s(25593),o=s(62149),n=s(63144),c=s(56618),d=s(10722),l=s(7165);const u=l.z.object({autoredirection:l.z.record(l.z.boolean())}),p=e=>u.safeParse(e).success;class h extends((0,n.Q)({persist:!0,storage:{initialValue:{autoredirection:{}},typeGuard:p,schemaVersion:1},scope:o.F.Device,storeName:"antiphishing",codec:d.E,capacity:c.Y._001KB})){}var m=s(82874),g=s(87279),v=s(3100);class y{async execute({body:e}){const{domain:t}=e;if(t){const e=await this.antiphishingStore.getState();await this.antiphishingStore.set({...e,autoredirection:{...e.autoredirection,[t]:!0}})}return Promise.resolve((0,g.Vp)(void 0))}constructor(e){this.antiphishingStore=e}}y=(0,r.__decorate)([(0,m.W)(v.A),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===h?Object:h])],y);var _=s(46449),S=s(17308),f=s(87065);class w{execute({body:e}){return this.antiphishingStore.state$.pipe((0,f.U)((t=>(0,g.Vp)(!!e.domain&&!!t.autoredirection[e.domain]))))}constructor(e){this.antiphishingStore=e}}w=(0,r.__decorate)([(0,_.e)(S.U),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===h?Object:h])],w);class I{}I=(0,r.__decorate)([(0,i.Yl)({api:a.J,handlers:{commands:{addAutoRedirectedDomain:y},events:{},queries:{isAutoRedirectedDomain:w}},stores:[h]})],I)},99002:(e,t,s)=>{s.d(t,{b:()=>a});const r=e=>void 0===e||"string"==typeof e,i=e=>void 0===e||"number"==typeof e,a=e=>{if(!e||!Array.isArray(e))return!1;if(0===e.length)return!0;const t=e[0];return"string"==typeof t.Id&&i(t.LastBackupTime)&&r(t.kwType)&&r(t.BreachId)&&i(t.ContentRevision)}},89315:(e,t,s)=>{s.d(t,{T:()=>c,l:()=>n});var r=s(71926),i=s(70942);const a=({name:e,domains:t})=>{if(e)return e;if(t.length>0){const[e]=t;return e}return""},o=e=>(0,i.Tc)(e)?"private":"public",n=e=>[...e.reduce(((e,t)=>{const s=e.get(t.BreachId);return(!s||s.LastBackupTime&&t.LastBackupTime&&s.LastBackupTime<t.LastBackupTime)&&e.set(t.BreachId,t),e}),new Map).values()],c=(e,t)=>{const s=n(e.filter(i.rY)).find((e=>e.Id===t));if(!s)throw new Error("Breach not found");return(e=>{const t=e.Content,s=(0,i.Tc)(e)?e.Content.impactedEmails:[];return{breachId:e.BreachId,breachType:o(e),domains:t.domains,eventDate:t.eventDate,id:e.Id,impactedEmails:s,kwType:e.kwType??"KWSecurityBreach",leakedData:t.leakedData??[],leakedPasswords:e.LeakedPasswords??[],name:a(t),status:e.Status??r.J.PENDING}})(s)}},70942:(e,t,s)=>{s.d(t,{F7:()=>o,Tc:()=>n,rY:()=>a});const r=e=>"object"==typeof e,i=e=>(e=>r(e)&&"breachModelVersion"in e&&"number"==typeof e.breachModelVersion)(e)&&1===e.breachModelVersion&&"domains"in e&&Array.isArray(e.domains)&&"eventDate"in e&&"string"==typeof e.eventDate&&"id"in e&&"string"==typeof e.id,a=e=>{return r(t=e)&&"kwType"in t&&"string"==typeof t.kwType&&"KWSecurityBreach"===t.kwType&&i(e.Content);var t},o=e=>(e=>{const t=e;return"impactedEmails"in t&&Array.isArray(t.impactedEmails)})(e)&&e.impactedEmails.length>0,n=e=>a(e)&&o(e.Content)},24981:(e,t,s)=>{s.d(t,{t:()=>E});var r=s(491),i=s(86006),a=s(66706),o=s(82874),n=s(87279),c=s(71926),d=s(87425),l=s(14122);class u{async execute({body:e}){const{commands:{carbon:t}}=this.carbonLegacyClient;return await t({name:"updateBreachStatus",args:[{id:e.id,status:c.J.ACKNOWLEDGED}]}),Promise.resolve((0,n.Vp)(void 0))}constructor(e){this.carbonLegacyClient=e}}u=(0,r.__decorate)([(0,o.W)(d.n),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===l._?Object:l._])],u);var p=s(29362);class h{async execute({body:e}){const{commands:{carbon:t}}=this.carbonLegacyClient;return await t({name:"updateBreachStatus",args:[{id:e.id,status:c.J.VIEWED}]}),Promise.resolve((0,n.Vp)(void 0))}constructor(e){this.carbonLegacyClient=e}}h=(0,r.__decorate)([(0,o.W)(p.Q),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===l._?Object:l._])],h);var m=s(48844),g=s(46449),v=s(60466),y=s(89315),_=s(99002);class S{execute({body:e}){const{id:t}=e,{queries:{carbonState:s}}=this.carbonLegacyClient;return s({path:"userSession.personalData.securityBreaches"}).pipe((0,m.Qn)((e=>{if(!(0,_.b)(e))throw new Error("Bad Breaches format");return e})),(0,m.Qn)((e=>(0,y.T)(e,t))))}constructor(e){this.carbonLegacyClient=e}}S=(0,r.__decorate)([(0,g.e)(v.i),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===l._?Object:l._])],S);var f=s(87065),w=s(5202),I=s(70942);class b{execute(){const{queries:{carbonState:e}}=this.carbonLegacyClient;return e({path:"userSession.personalData.securityBreaches"}).pipe((0,m.Qn)((e=>{if(!(0,_.b)(e))throw new Error("Bad Breaches format");return e})),(0,f.U)((e=>{if((0,n.hx)(e))throw new Error("Error while fetching data");const t=(0,y.l)(e.data.filter(I.rY)).filter((e=>e.Status===c.J.PENDING&&(0,I.Tc)(e)));return(0,n.Vp)({count:t.length})})))}constructor(e){this.carbonLegacyClient=e}}b=(0,r.__decorate)([(0,g.e)(w.L),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===l._?Object:l._])],b);class E{}E=(0,r.__decorate)([(0,i.Yl)({api:a.H,handlers:{commands:{dismissBreach:u,markBreachAsSeen:h},events:{},queries:{breach:S,unreadBreachesCount:b}}})],E)},41892:(e,t,s)=>{s.d(t,{S:()=>M});var r,i=s(491),a=s(86006),o=s(36282),n=s(62149),c=s(63144);!function(e){e.UNKNOWN="UNKNOWN",e.SEEN="SEEN",e.NOT_SEEN="NOT_SEEN"}(r||(r={}));var d=s(10722);const l=e=>(e=>!(!e||"object"!=typeof e)&&"onboardingStatus"in e&&"emails"in e)(e)&&function(e){return"UNKNOWN"===e||"SEEN"===e||"NOT_SEEN"===e}(e.onboardingStatus)&&Array.isArray(e.emails);class u extends((0,c.Q)({persist:!0,storage:{schemaVersion:1,initialValue:{onboardingStatus:r.NOT_SEEN,emails:[]},typeGuard:l},scope:n.F.User,storeName:"email-monitoring-state",storeTypeGuard:l,codec:d.E,isCache:!0})){}var p=s(11959),h=s(27655),m=s(82874),g=s(48844),v=s(87279),y=s(53344),_=s(60399),S=s(82567);class f{async execute({body:{email:e}}){return await(0,_.z)(this.serverApiClient.v1.darkwebmonitoring.registerEmail({email:e}).pipe((0,g.DZ)((e=>{throw new Error(e.message)})),(0,g.lk)((e=>e.data.result===p.Dq?(0,v.Vp)(void 0):(0,v.Rn)((e=>{switch(e){case p.XX.INVALID_EMAIL:return(0,p.Iy)();case p.XX.ALREADY_SUBSCRIBED:return(0,p.pK)();case p.XX.TOO_MANY_SUBSCRIPTIONS:return(0,p.Qj)();default:return(0,p.tp)()}})(e.data.result)))),(0,S.b)((async t=>{(0,v.d6)(t)&&await this.store.update((t=>({...t,emails:[...t.emails,{email:e,state:h.wp.PENDING}]})))}))))}constructor(e,t){this.serverApiClient=e,this.store=t}}f=(0,i.__decorate)([(0,m.W)(p.P5),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===y.l?Object:y.l,void 0===u?Object:u])],f);var w=s(41511),I=s(49590);class b{async execute({body:{email:e}}){return await(0,_.z)(this.serverApiClient.v1.darkwebmonitoring.deregisterEmail({email:e}).pipe((0,g.DZ)((e=>{throw new Error(e.message)})),(0,g.lk)((e=>e.data.result===I.QS?(0,v.Vp)(void 0):(0,v.Rn)(this.getFunctionalError(e.data.result)))),(0,S.b)((async t=>{(0,v.d6)(t)&&await this.store.update((t=>({...t,emails:[...t.emails.filter((t=>t.email!==e))]})))}))))}constructor(e,t){this.serverApiClient=e,this.store=t,this.getFunctionalError=e=>{switch(e){case I.KP.NO_SUBSCRIPTION:return new I.h1;case I.KP.INVALID_EMAIL:return new I.uD;case I.KP.GENERIC_ERROR:default:return new I.v4}}}}b=(0,i.__decorate)([(0,m.W)(I.Lc),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===y.l?Object:y.l,void 0===u?Object:u])],b);var E=s(92452),C=s(92587);function A(e){return{...e,onboardingStatus:r.SEEN}}class R{async execute(){await this.store.update(A)}constructor(e){this.store=e}}R=(0,i.__decorate)([(0,C.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===u?Object:u])],R);class T{async execute(){return await this.dismissOnboardingNotificationService.execute(),Promise.resolve((0,v.Vp)(void 0))}constructor(e){this.dismissOnboardingNotificationService=e}}T=(0,i.__decorate)([(0,m.W)(E.n),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===R?Object:R])],T);var O=s(87065),D=s(6136),U=s(43978),F=s(90171),P=s(69885),x=s(46449);class N{constructor(e,t){this.serverApiClient=e,this.store=t,this.execute=()=>{this.serverApiClient.v1.darkwebmonitoring.listRegistrations({}).pipe((0,g.Qn)((({data:e})=>e.emails.map((e=>({email:e.email,state:(0,h.a2)(e.state)?e.state:h.wp.PENDING}))))),(0,g.Qn)((e=>{this.store.update((t=>({...t,emails:e})))})),(0,g.DZ)((e=>{throw e}))).subscribe()}}}N=(0,i.__decorate)([(0,C.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===y.l?Object:y.l,void 0===u?Object:u])],N);class G{execute(){this.syncMonitoredEmails.execute();return this.store.state$.pipe((0,O.U)((e=>e.emails)),(0,D.x)(((e,t)=>JSON.stringify(e)===JSON.stringify(t))),(0,O.U)((e=>(0,v.Vp)(e)))).pipe((0,U.w)((e=>{const t=()=>(this.syncMonitoredEmails.execute(),e),s=e=>(0,F.H)(0,e).pipe((0,U.w)((()=>(0,P.of)(t()))));return(0,v.hx)(e)||e.data.some((e=>e.state===h.wp.PENDING))?s(3e4):(0,P.of)(e)})))}constructor(e,t){this.syncMonitoredEmails=e,this.store=t}}G=(0,i.__decorate)([(0,x.e)(h.dB),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===N?Object:N,void 0===u?Object:u])],G);var k=s(43473);class L{execute(){return this.store.state$.pipe((0,O.U)((e=>e.onboardingStatus)),(0,D.x)(),(0,O.U)(v.Vp))}constructor(e){this.store=e}}L=(0,i.__decorate)([(0,x.e)(k.p),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===u?Object:u])],L);class M{}M=(0,i.__decorate)([(0,a.Yl)({api:o.M,stores:[u],handlers:{commands:{dismissOnboardingNotification:T,optinEmail:f,optoutEmail:b},events:{},queries:{emailList:G,onboardingNotificationState:L}},imports:[w.n],providers:[R,N]})],M)},72481:(e,t,s)=>{s.d(t,{f:()=>q});var r=s(491),i=s(86006),a=s(6538),o=s(87065),n=s(14122),c=s(92587),d=s(48844),l=s(87279);const u=e=>void 0===e||"string"==typeof e;class p{getById(e){const{queries:{carbonState:t}}=this.carbonLegacyClient;return t({path:"state.userSession.personalData.credentials"}).pipe((0,d.Qn)((e=>{if(!(e=>!!Array.isArray(e)&&(0===e.length||e.every((e=>{const t=e;return"string"==typeof t.Id&&u(t.OtpSecret)&&u(t.OtpUrl)}))))(e))throw new Error("Bad credential format");return e})),(0,o.U)((t=>{if((0,l.hx)(t))return(0,l.Vp)(null);const s=t.data.reduce(((t,s)=>s.Id===e?{Id:s.Id,OtpSecret:s.OtpSecret,OtpUrl:s.OtpUrl}:t),null);return(0,l.Vp)(s)})))}constructor(e){this.carbonLegacyClient=e}}p=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===n._?Object:n._])],p);var h,m=s(46449),g=s(81721);!function(e){e.SHA1="SHA-1",e.SHA256="SHA-256",e.SHA384="SHA-384",e.SHA512="SHA-512"}(h||(h={}));const v=["totp","hotp"],y=e=>{const t=new URL(e),s=(e=>{const t=e.hostname?e.hostname:/\/\/([th]otp)\//.exec(e.pathname)?.[1]??"";return v.includes(t)?t:null})(t),r=t.searchParams.get("secret")?.toUpperCase();if(!s||!r)throw new Error("Corrupted OTP url");const i=t.searchParams.get("digits"),a=t.searchParams.get("counter"),o=t.searchParams.get("period"),n=t.searchParams.get("algorithm");return{secret:r,algorithm:n?h[n]:h.SHA1,counter:a?Number.parseInt(a,10):0,digits:i?Number.parseInt(i,10):6,period:o?Number.parseInt(o,10):30}},_=e=>({secret:e.toUpperCase(),algorithm:h.SHA1,counter:0,digits:6,period:30}),S=e=>{try{return y(e)}catch{return _(e)}},f=e=>{const{secret:t,algorithm:s,digits:r,period:i}=e;return`otpauth://totp/?secret=${t.toLowerCase()}&algorithm=${s.toUpperCase().replace("-","")}&digits=${r}&period=${i}&lock=false`};var w=s(90171),I=s(41842),b=s(43978),E=s(81929);var C=s(76884),A=s(97112);const R=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9],T=async(e,t,s)=>{const r=(e=>{const t=new Uint8Array(e),s=15&t[t.length-1],r=t.slice(s,s+4).reduce(((e,t)=>e.concat(t.toString(16).toString().padStart(2,"0"))),"");return 2147483647&Number.parseInt(r,16)})(await e((0,A.n)(t)));return(r%(s<=9?R[s]:Math.pow(10,s))).toString().padStart(s,"0")};class O{async computeOtpCode({counter:e,digits:t,period:s}){const r=this.getStep(e,s);return await T(this.signer,r,t)}constructor(e,t){this.signer=e,this.getStep=t}}class D{createCodeGenerator({secret:e,algorithm:t}){try{const s=(0,C.K)(e);return new O((e=>this.hmacSigner.sign(s,e,t)),this.getStep)}catch(e){return null}}getNextOtpRefreshTimestamp(e,t){if(e)return(e=>{const t=1e3*e,s=Math.floor(Date.now()/t)*t;return new Date(s+t).getTime()})(t);throw new Error("Not supported for non time based OTP type")}constructor(e){this.hmacSigner=e}}class U extends D{getStep(e,t){return((e,t)=>Math.floor(e/t))(e||(new Date).getTime(),1e3*t)}constructor(e){super(e)}}U=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===E.q?Object:E.q])],U);class F{async withGeneratedCodeAndValidity(e,t){try{const s=await t.computeOtpCode(e),r=this.otpGeneratorService.getNextOtpRefreshTimestamp(!0,e.period);return(0,l.Vp)({code:s,validityEndDate:r,validityTime:1e3*e.period,url:f(e)})}catch{return(0,l.Rn)(void 0)}}otpCodes$(e,t){return(0,w.H)(0,1e3).pipe((0,I.h)((t=>{if(0===t)return!0;return((e,t)=>e-Date.now()>=1e3*t-1e3)(this.otpGeneratorService.getNextOtpRefreshTimestamp(!0,e.period),e.period)})),(0,b.w)((()=>this.withGeneratedCodeAndValidity(e,t))))}constructor(e){this.otpGeneratorService=e}}F=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===U?Object:U])],F);var P=s(69885);class x{execute({body:e}){const{secretOrUrl:t}=e;if(!t)return(0,P.of)((0,l.Rn)(new g.k));const s=S(t.replaceAll(" ","")),r=this.otpGeneratorService.createCodeGenerator(s);return null===r?(0,P.of)((0,l.Rn)(new g.k)):this.otpCodeService.otpCodes$(s,r).pipe((0,d.DZ)((()=>new g.k)))}constructor(e,t){this.otpGeneratorService=e,this.otpCodeService=t}}x=(0,r.__decorate)([(0,m.e)(g.S),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===U?Object:U,void 0===F?Object:F])],x);var N=s(82874),G=s(34621),k=s(39431),L=s(50879);class M{async execute({body:e}){const{updateVaultItem:t}=this.vaultCrudClient.commands,{credentialId:s,otpUrl:r}=e;return await t({vaultItemType:k.U.Credential,content:{otpSecret:"",otpURL:r},id:s}),(0,l.Vp)(void 0)}constructor(e){this.vaultCrudClient=e}}M=(0,r.__decorate)([(0,N.W)(G.z),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===L.L?Object:L.L])],M);var K=s(85869);class j{withCodeGenerator(e){return{codeGenerator:this.otpGeneratorService.createCodeGenerator(e),params:e}}execute({body:e}){const{credentialId:t}=e;return this.credentialOTPGetter.getById(t).pipe((0,o.U)((e=>{if((0,l.hx)(e)||!e.data)throw new Error("Credential not found");return e.data})),(0,o.U)((e=>{if(!e.OtpUrl&&!e.OtpSecret)return{params:null,codeGenerator:null};const t=(e=>{const{OtpSecret:t,OtpUrl:s}=e;if(!t&&!s)throw new Error("Otp config missing for this credential");return s?S(s):_(t??"")})(e);return this.withCodeGenerator(t)})),(0,b.w)((({params:e,codeGenerator:t})=>null===e||null===t?(0,P.of)((0,l.Rn)(new K.c)):this.otpCodeService.otpCodes$(e,t).pipe((0,o.U)((e=>(0,l.hx)(e)?(0,l.Vp)({code:"",validityEndDate:Date.now(),validityTime:Date.now(),url:""}):e))))))}constructor(e,t,s){this.credentialOTPGetter=e,this.otpGeneratorService=t,this.otpCodeService=s}}j=(0,r.__decorate)([(0,m.e)(K.J),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===p?Object:p,void 0===U?Object:U,void 0===F?Object:F])],j);class V extends D{getStep(e,t){return e}constructor(e){super(e)}}V=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===E.q?Object:E.q])],V);var z=s(16624);class W{}W=(0,r.__decorate)([(0,i.Yl)({sharedModuleName:"otp-generator",providers:[U,V],exports:[U,V],imports:[z.D]})],W);class q{}q=(0,r.__decorate)([(0,i.Yl)({api:a.i,handlers:{commands:{setupOtpCodeForCredential:M},events:{},queries:{otpCode:j,otpCodeForSecretOrUrl:x}},imports:[W],providers:[p,F]})],q)},88559:(e,t,s)=>{s.d(t,{U:()=>l});var r=s(491),i=s(14122),a=s(92587),o=s(48844),n=s(99002),c=s(89315),d=s(70942);class l{getSupportedBreaches(){const{queries:{carbonState:e}}=this.carbonLegacyClient;return e({path:"userSession.personalData.securityBreaches"}).pipe((0,o.Qn)((e=>{if(!(0,n.b)(e))throw new Error("Bad Breaches format");return e})),(0,o.Qn)((e=>e.filter(d.rY))))}get(){const{queries:{carbonState:e}}=this.carbonLegacyClient;return e({path:"userSession.personalData.securityBreaches"}).pipe((0,o.Qn)((e=>{if(!(0,n.b)(e))throw new Error("Bad Breaches format");return e})),(0,o.Qn)((e=>(0,c.l)(e.filter(d.rY)))))}constructor(e){this.carbonLegacyClient=e}}l=(0,r.__decorate)([(0,a.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===i._?Object:i._])],l)},74643:(e,t,s)=>{s.d(t,{C:()=>Bt});var r,i=s(491),a=s(68754);!function(e){e.DisablePasswordHealth="web_disable_password_health",e.PasswordHealthPaginationDev="sharingVault_web_password_health_pagination_dev",e.PasswordHealthPaginationProd="sharingVault_web_password_health_pagination_prod",e.PasswordHealthHourlySyncDev="sharingVault_web_passwordHealthHourlySync_dev",e.PasswordHealthHourlySyncProd="sharingVault_web_passwordHealthHourlySync_prod"}(r||(r={}));var o,n,c,d,l=s(41511),u=s(52987),p=s(86006),h=s(32671),m=s(70433),g=s(62149),v=s(63144),y=s(56618),_=s(10722),S=s(7165);!function(e){e.Weak="weak",e.Reused="reused",e.Compromised="compromised",e.Excluded="excluded"}(o||(o={})),function(e){e.All="all",e.Weak="weak",e.Reused="reused",e.Compromised="compromised",e.Excluded="excluded"}(n||(n={})),function(e){e.WEAK="weak",e.EXTREMELY_WEAK="extremely_weak"}(c||(c={})),function(e){e.COMMON="common",e.STRONG="strong"}(d||(d={}));const f=S.z.object({breachId:S.z.string(),domains:S.z.array(S.z.string()),date:S.z.string()}),w=S.z.object({riskType:S.z.literal(o.Compromised),breaches:S.z.array(f)}),I=S.z.object({riskType:S.z.literal(o.Weak),strength:S.z.number()}),b=S.z.object({riskType:S.z.literal(o.Reused),credentialIds:S.z.array(S.z.string())}),E=S.z.discriminatedUnion("riskType",[w,I,b]),C=S.z.object({id:S.z.string(),excluded:S.z.boolean(),title:S.z.string(),login:S.z.string(),email:S.z.string(),autoLogin:S.z.boolean(),autoProtected:S.z.boolean(),otpSecret:S.z.string(),otpUrl:S.z.string(),spaceId:S.z.string(),shared:S.z.boolean(),domains:S.z.array(S.z.string())});C.extend({password:S.z.string()});const A=C.extend({isImportant:S.z.boolean(),risks:S.z.array(E)}),R=S.z.object({compromised:S.z.array(S.z.string()),reused:S.z.array(S.z.string()),weak:S.z.array(S.z.string()),excluded:S.z.array(S.z.string()),corruptedCount:S.z.number(),importantCorruptedCount:S.z.number()}),T=S.z.object({credentialsAtRisk:S.z.record(A),index:S.z.record(R)}),O=e=>T.safeParse(e).success;class D extends((0,v.Q)({persist:!0,storage:{initialValue:{credentialsAtRisk:{},index:{}},typeGuard:O,schemaVersion:1},scope:g.F.User,storeName:"password-health-state",storeTypeGuard:O,codec:_.E,isCache:!0,capacity:y.Y.Unlimited})){}var U=s(14122),F=s(92587),P=s(48844),x=s(87279),N=s(13134),G=s(61076),k=s(87065);const L=e=>void 0===e||"string"==typeof e,M=e=>void 0===e||"string"==typeof e||"boolean"==typeof e;class K{vaultBooleanFormatter(e,t=!1){return void 0===e?t:"string"==typeof e?"true"===e.toLocaleLowerCase():e}get(){const{queries:{carbonState:e}}=this.carbonLegacyClient,t=e({path:"state.userSession.spaceData.spaces"}).pipe((0,P.Qn)((e=>{if(!(e=>!!Array.isArray(e)&&(0===e.length||e.every((e=>{const t=e;return"string"==typeof t.teamId&&"object"==typeof t.details&&"string"==typeof t.details.status}))))(e))throw new Error("Bad space item format");return new Set(e.filter((e=>"accepted"===e.details.status)).map((e=>e.teamId)))}))),s=e({path:"userSession.sharingData.items"}).pipe((0,P.Qn)((e=>{if(!(e=>!!Array.isArray(e)&&(0===e.length||e.every((e=>{const t=e;return"string"==typeof t.content&&"string"==typeof t.itemId&&"number"==typeof t.timestamp}))))(e))throw new Error("Bad shared items format");return e.map((e=>e.itemId))})));return e({path:"state.userSession.personalData.credentials"}).pipe((0,P.Qn)((e=>{if(!(e=>!!Array.isArray(e)&&(0===e.length||e.every((e=>{const t=e;return"string"==typeof t.Id&&M(t.AutoLogin)&&M(t.AutoProtected)&&L(t.Email)&&L(t.Login)&&L(t.OtpSecret)&&L(t.OtpUrl)&&L(t.Password)&&L(t.Title)&&L(t.Url)&&L(t.SpaceId)&&M(t.Checked)}))))(e))throw new Error("Bad credential format");return e})),(0,G.V)(s,t),(0,k.U)((([e,t,s])=>{const r={};return(0,x.hx)(e)||(0,x.hx)(s)||e.data.forEach((e=>{const i=new N.Y(e.Url).getRootDomain();var a;e.SpaceId&&""!==e.SpaceId&&!s.data.has(e.SpaceId)||(r[e.Id]={domains:i?[i]:[],autoLogin:this.vaultBooleanFormatter(e.AutoLogin),autoProtected:this.vaultBooleanFormatter(e.AutoProtected),email:e.Email??"",excluded:this.vaultBooleanFormatter(e.Checked),id:e.Id,login:e.Login??"",otpSecret:e.OtpSecret??"",otpUrl:e.OtpUrl??"",password:e.Password??"",spaceId:e.SpaceId??"",shared:(a=e.Id,!(0,x.hx)(t)&&t.data.includes(a)),title:e.Title??""})})),(0,x.Vp)(r)})))}constructor(e){this.carbonLegacyClient=e}}K=(0,i.__decorate)([(0,F.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===U._?Object:U._])],K);var j=s(88559);const V=e=>{if(!e)return;const t=e;if(!((s=t.spaces)&&Array.isArray(s)&&0!==s.length&&(e=>{if(!e)return!1;const t=e;return!!(t.associatedEmail&&t.billingAdmins&&t.color&&t.info&&t.letter&&t.planType&&t.status&&t.teamAdmins&&t.teamId&&t.teamName&&t.tier)})(s.find((e=>"accepted"===e.status)))))return;var s;const r=t.spaces.find((e=>"accepted"===e.status));return r?.teamId};class z{get(){const{queries:{carbonState:e}}=this.carbon;return e({path:"userSession.localSettings.premiumStatus"}).pipe((0,P.Qn)(V))}constructor(e){this.carbon=e}}z=(0,i.__decorate)([(0,F.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===U._?Object:U._])],z);var W=s(7531),q=s(23337);class B extends W.K{loadResource(e){if(!(t=e)||!Array.isArray(t))throw new Error("Important domains file corrupted");var t;return new Set(e)}constructor(e){super("assets/domains/importantDomains.json",e)}}B=(0,i.__decorate)([(0,F.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===q.X?Object:q.X])],B);var $=s(53932),Y=s(23297);var Q=s(13800);class H extends Q.f{}H=(0,i.__decorate)([(0,F.GS)()],H);const J=e=>{const t=e.risks.filter((e=>e.riskType===o.Reused));return 1===t.length?t[0]:void 0},Z=(e,t)=>e?.risks.find((e=>e.riskType===t)),X=(e,t)=>e.risks.filter((e=>e.riskType!==t)),ee=(e,t,s)=>[...s,{riskType:o.Reused,credentialIds:[...t.credentialIds].filter((t=>e!==t))}],te=(e,t)=>{const s=J(t);return{...t,risks:X(t,o.Reused).concat([{riskType:o.Reused,credentialIds:s?[...s.credentialIds].concat(e.id):[e.id]}])}},se=e=>({id:e.id,title:e.title,email:e.email,excluded:e.excluded,login:e.login,autoLogin:e.autoLogin,autoProtected:e.autoProtected,otpSecret:e.otpSecret,otpUrl:e.otpUrl,spaceId:e.spaceId,shared:e.shared,domains:e.domains}),re=e=>({...se(e),risks:[],isImportant:!1}),ie=(e,t,s)=>{const r=X(t,o.Reused),i=s&&s.length>0,a=r.length>0;return i||a?{...re(e),risks:i?r.concat([{riskType:o.Reused,credentialIds:s}]):r}:void 0},ae=e=>!!Z(e,o.Weak),oe=e=>!!J(e),ne=e=>!!Z(e,o.Compromised),ce=e=>e.excluded,de=3,le=5;function ue(e,t,s=de,r=le){if(!e||!t)return!1;const i=e.length,a=t.length;if(Math.abs(i-a)>s)return!1;if(i<r||a<r)return e===t;if(e===t)return!0;let o=new Array(a+1),n=new Array(a+1),c=!1;for(let e=0;e<a+1;e++)o[e]=e;for(let r=0;r<i;r++){n[0]=r+1,c=n[0]>s;for(let i=0;i<a;i++){const a=o[i+1]+1,d=n[i]+1;let l=o[i];e[r]!==t[i]&&l++,n[i+1]=Math.min(a,Math.min(d,l)),c=c&&n[i+1]>s}const i=o;if(o=n,n=i,c)break}return o[a]<=s}const pe=(e,t,s)=>{const r=((e,t)=>Object.keys(t).reduce(((s,r)=>ue(r,e.password)?[...s,...t[r]]:s),[]))(e,s);if(!t&&0===r.length)return{};const i=(e=>{if(0!==e.length)return{riskType:o.Compromised,breaches:e}})(r),a=t?X(t,o.Compromised):[],n={...re(e),risks:i?a.concat(i):a};return{[e.id]:0===n.risks.length?void 0:n}},he=(e,t,s)=>{if(!s)return Promise.resolve({});const r=t[e.id]??re(e),i=r.risks.length>0,a=((e,t)=>Object.keys(t).map((e=>t[e])).filter((t=>t.id!==e.id&&ue(t.password,e.password))).map((e=>e.id)))(e,s);if(0===a.length&&!i)return Promise.resolve({});const n=J(r)?.credentialIds??[],c=((e,t,s,r)=>{const i=s.filter((e=>!t.includes(e)));if(0===i.length)return{};const a={};for(const t of i){const s=r[t];if(!s)continue;const i=J(s);if(!i)continue;const n=X(s,o.Reused);1===i.credentialIds.length&&0===n.length?a[t]=void 0:a[t]={...s,risks:1===i.credentialIds.length?n:ee(e,i,n)}}return a})(e.id,a,n,t),d=((e,t,s,r,i)=>{const a=t.filter((e=>!s.includes(e)));if(0===a.length)return{};const n={};for(const t of a){const s=r[t];if(s)n[t]=te(e,s);else{const s=i[t];n[t]={...re(s),risks:[{riskType:o.Reused,credentialIds:[e.id]}]}}}return n})(e,a,n,t,s),l=ie(e,r,a);return Promise.resolve({...c,...d,[e.id]:l})};var me=s(85465);const ge=async e=>{if(e)return await(async e=>(await(0,me.evaluate)(e)).score)(e)/25},ve=async(e,t)=>{const s=await ge(e.password),r=t??re(e),i=X(r,o.Weak),a=void 0!==s&&s<2;return a||0!==i.length?{[e.id]:{...r,...se(e),risks:a?i.concat([{riskType:o.Weak,strength:s}]):i}}:{[e.id]:void 0}},ye=(e,t,s)=>{if(!t)return{};const r=e.domains.some((e=>s.has(e))),i={...t,isImportant:r};return{[t.id]:i}},_e=e=>{const t={};if(!Object.keys(e).length)return t;for(const s in e){if(!e[s])continue;const r=e[s]?.spaceId??"";void 0===t[r]&&(t[r]={[o.Reused]:[],[o.Weak]:[],[o.Compromised]:[],[o.Excluded]:[],corruptedCount:0,importantCorruptedCount:0}),e[s]?.excluded?t[r][o.Excluded].push(s):(t[r].corruptedCount++,e[s]?.isImportant&&t[r].importantCorruptedCount++,e[s]?.risks.forEach((e=>t[r][e.riskType].push(s))))}return t},Se=e=>{const t={};return Object.keys(e).forEach((s=>{const r=e[s];r&&(t[s]=r)})),t},fe=(e=0)=>new Promise((t=>setTimeout((()=>t()),e))),we=(e,t)=>Array.from({length:Math.ceil(t.length/e)},((s,r)=>t.slice(r*e,r*e+e))),Ie=100,be=async({credentialUpdates:e,allCredentials:t,breaches:s,importantDomains:r,hasUpdatedBreaches:i,healthState:a,deletedCredentialIds:n})=>{const c=(e=>{const t={};return e.forEach((e=>{e.LeakedPasswords&&e.LeakedPasswords.forEach((s=>{Object.prototype.hasOwnProperty.call(t,s)?t[s].push({breachId:e.Id,date:e.Content.eventDate,domains:e.Content.domains}):t[s]=[{breachId:e.Id,date:e.Content.eventDate,domains:e.Content.domains}]}))})),t})(s),d=0===e.length&&0===n.length&&!i,l={...a?.credentialsAtRisk??{}},u=e=>Object.keys(e).forEach((t=>l[t]=e[t]));n.length>0&&u(((e=[])=>e.reduce(((e,t)=>({...e,[t]:void 0})),{}))(n));const p={},h={};for(const e of Object.keys(t))t[e].excluded?p[e]=re(t[e]):h[e]=t[e];const m=[],g=[];for(const t of e)t.excluded?g.push(t):n.includes(t.id)||m.push(t);if(u(((e,t)=>{const s={};for(const r of Object.values(t)){if(!r)continue;const t=J(r);if(!t)continue;const i=t.credentialIds.filter((t=>!e.includes(t)));if(i.length!==t.credentialIds.length){const e=X(r,o.Reused);0===i.length&&0===e.length?s[r.id]=void 0:s[r.id]={...r,risks:0===i.length?e:[...e,{...t,credentialIds:i}]}}}return s})([...Object.values(g).map((e=>e.id)),...n],l)),d){u(await(async e=>{const t={},s=we(Ie,e);for(let r=0;r<s.length;r++){await fe();const i=s[r];for(let s=0;s<i.length;s++){const a=i[s],n=a.password,c=a.id,d=[];for(let i=r*Ie+s+1;i<e.length;i++){const s=e[i].id,r=e[i].password,l=e[i];if(ue(n,r)){const e=t[s]??re(l),r=Z(e,o.Reused),i=r?.credentialIds??[];t[s]=ie(a,e,i.concat(c)),d.push(s)}}const l=t[c]??re(a),u=Z(l,o.Reused),p=u?.credentialIds??[];t[c]=ie(a,l,d.concat(p))}}return t})(Object.values(h)))}const v=d?Object.values(h):m;if(i)for await(const e of Object.values(h)){u(pe(e,l[e.id],c))}const y=we(Ie,v);for await(const e of y){await fe();for await(const t of e){if(!i){u(pe(t,l[t.id],c))}if(!d){u(await he(t,l,h))}u(await ve(t,l[t.id])),u(ye(t,l[t.id],r))}}return u(p),{credentialsAtRisk:Se(l),index:_e(l)}};var Ee=s(60399);class Ce{async run({updatedCredentialIds:e,deletedCredentialIds:t,hasUpdatedBreaches:s=!1}){const{userFeatureFlips:i}=this.client.getClient(Y.cV).queries,a=await(0,Ee.z)(i());if((0,x.d6)(a)&&a.data[r.DisablePasswordHealth])return await this.store.set({credentialsAtRisk:{},index:{}}),void this.eventEmitter.sendEvent("passwordHealthComputationFinished",null);const o=await this.store.getState(),n=await(0,Ee.z)(this.credentialsGetter.get()),c=await(0,Ee.z)(this.breachesGetter.get()),d=await this.importantDomains.get();if((0,x.hx)(n)||(0,x.hx)(c))throw new Error("Failure getting vault data");const l=e?.length??0,u=t?.length??0,p=l>0||u>0||s,h=l+u<=50,m=p&&h?o:void 0,g=p?((e,t)=>e.reduce(((e,s)=>void 0===t[s]?e:[...e,t[s]]),[]))(e??[],n.data):[],v=await be({hasUpdatedBreaches:s,credentialUpdates:h?g:[],allCredentials:n.data,breaches:c.data,importantDomains:d,healthState:m,deletedCredentialIds:h?[...t??[]]:[]});await this.store.set({...v}),this.eventEmitter.sendEvent("passwordHealthComputationFinished",null)}constructor(e,t,s,r,i,a){this.store=e,this.credentialsGetter=t,this.breachesGetter=s,this.importantDomains=r,this.eventEmitter=i,this.client=a}}Ce=(0,i.__decorate)([(0,F.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D,void 0===K?Object:K,void 0===j.U?Object:j.U,void 0===B?Object:B,void 0===H?Object:H,void 0===$.w?Object:$.w])],Ce);const Ae=S.z.object({lastSentDate:S.z.number()});S.z.object({lastSentDate:S.z.number(),lastHash:S.z.string()});const Re=e=>Ae.safeParse(e).success;class Te extends((0,v.Q)({persist:!0,storage:{initialValue:{lastSentDate:0,lastHash:""},typeGuard:Re,schemaVersion:2,migrateStorageSchema:()=>({lastSentDate:0,lastHash:""})},scope:g.F.User,storeName:"user-activity-state",storeTypeGuard:Re,codec:_.E,capacity:y.Y._001KB,isCache:!0})){}const Oe=S.z.object({isOutdated:S.z.literal(!0),lastUpdateTimestamp:S.z.number(),updatedCredentialIds:S.z.record(S.z.string()),deletedCredentialIds:S.z.record(S.z.string()),hasUpdatedBreaches:S.z.boolean()}),De=S.z.object({isOutdated:S.z.literal(!1),lastUpdateTimestamp:S.z.number()}),Ue=S.z.discriminatedUnion("isOutdated",[Oe,De]),Fe=e=>Ue.safeParse(e).success;class Pe extends((0,v.Q)({persist:!0,storage:{initialValue:{isOutdated:!1,lastUpdateTimestamp:0},typeGuard:Fe,schemaVersion:1},scope:g.F.User,storeName:"health-cache-state",storeTypeGuard:Fe,codec:_.E,isCache:!0,capacity:y.Y.Unlimited})){}const xe=(e,t)=>({...e,...t.slice(0,51).reduce(((e,t)=>(e[t]=t,e)),{})});var Ne=s(64987);const Ge=new Ne.WU;class ke{update(e){Ge.runExclusive((async()=>{const t=await this.store.getState();this.store.set(((e,t)=>{if(!t.isOutdated)return{isOutdated:!1,lastUpdateTimestamp:e.lastUpdateTimestamp};const{updatedCredentialIds:s,deletedCredentialIds:r,hasUpdatedBreaches:i}=t,a=e.isOutdated?{...e}:{isOutdated:!0,lastUpdateTimestamp:e.lastUpdateTimestamp,updatedCredentialIds:{},deletedCredentialIds:{},hasUpdatedBreaches:!1};return s&&(a.updatedCredentialIds=xe(a.updatedCredentialIds,s)),r&&(a.deletedCredentialIds=xe(a.deletedCredentialIds,r)),i&&(a.hasUpdatedBreaches=i),a})(t,e))}))}async updateHealthState(){await Ge.runExclusive((async()=>{const e=await this.store.getState();(e.isOutdated||0===e.lastUpdateTimestamp||e.lastUpdateTimestamp+864e5<Date.now())&&(await this.passwordHealthCalculationService.run(this.prepCacheStateProps(e)),await this.markAsUpToDate())}))}prepCacheStateProps(e){return e.isOutdated?{updatedCredentialIds:Object.keys(e.updatedCredentialIds),deletedCredentialIds:Object.keys(e.deletedCredentialIds),hasUpdatedBreaches:e.hasUpdatedBreaches}:{}}async markAsUpToDate(){await this.store.set({isOutdated:!1,lastUpdateTimestamp:(new Date).getTime()})}constructor(e,t){this.store=e,this.passwordHealthCalculationService=t}}ke=(0,i.__decorate)([(0,F.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===Pe?Object:Pe,void 0===Ce?Object:Ce])],ke);class Le{async run(){await this.healthCacheUpdater.updateHealthState()}constructor(e){this.healthCacheUpdater=e}}Le=(0,i.__decorate)([(0,F.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===ke?Object:ke])],Le);var Me=s(53344),Ke=s(96303),je=s(54066),Ve=s(18969);const ze=e=>null===e?null:Math.round(100*e),We=0;function qe(e){const t={};return Object.keys(e).forEach((s=>{const r=e[s].spaceId;void 0===t[r]?t[r]=1:t[r]++})),t}const Be=e=>Math.floor(e/1e3);class $e{async sendIfReportUpdated(){const e=await this.getTeamId();if(!e)return(0,x.Rn)("Missing team ID.");const t=await this.userActivityStore.getState(),{currentTime:s,relativeEnd:r,relativeStart:i}=this.getTimes(t.lastSentDate),a=await this.getTeamContent(e),o=(0,Ke.k)(this.md5Hasher.compute((0,je.u)(JSON.stringify(a))));return t.lastHash===o?(0,x.Rn)("Health data has not changed from previous run."):(await this.createReport(e,s,r,i,a,o),(0,x.Vp)(void 0))}async sendReport(){const e=await this.getTeamId();if(!e)return(0,x.Rn)("Missing team ID.");const t=await this.userActivityStore.getState(),{currentTime:s,relativeEnd:r,relativeStart:i}=this.getTimes(t.lastSentDate),a=await this.getTeamContent(e);return await this.createReport(e,s,r,i,a,""),(0,x.Vp)(void 0)}getTimes(e){const t=Date.now();return{currentTime:t,relativeEnd:Be(t),relativeStart:Be(e||t)}}async getTeamContent(e){const t=await this.store.getState(),s=await this.getPerSpaceTotal();return function(e,t,s){const r=e[s],i=t[s]??0;return r?{checkedPasswords:r.excluded.length,compromisedPasswords:r.compromised.length,nbrPasswords:i,reused:r.reused.length,safePasswords:i-r.corruptedCount,securityIndex:ze((0,Ve.R9)(r.corruptedCount,r.importantCorruptedCount,i-r.excluded.length))??We,weakPasswords:r.weak.length}:{checkedPasswords:0,compromisedPasswords:0,nbrPasswords:i,reused:0,safePasswords:i,securityIndex:i<Ve.RG?We:Ve.JK,weakPasswords:0}}(t.index,s,e)}async createReport(e,t,s,r,i,a){await(0,Ee.z)(this.serverApiClient.v1.useractivity.create({userActivity:{securityIndex:0},teamActivity:e?{teamId:parseInt(e,10),activity:i}:void 0,relativeEnd:s,relativeStart:r})),this.userActivityStore.set({lastSentDate:t,lastHash:a})}async getTeamId(){const e=await(0,Ee.z)(this.currentSpaceGetter.get());if(!(0,x.d6)(e))throw new Error("Error while retrieving current space for activity report");return(0,x.db)(e)}async getPerSpaceTotal(){const e=await(0,Ee.z)(this.credentialsGetter.get());if(!(0,x.d6)(e))throw new Error("Error while retrieving credentials");return qe(e.data)}constructor(e,t,s,r,i,a){this.serverApiClient=e,this.userActivityStore=t,this.credentialsGetter=s,this.store=r,this.md5Hasher=i,this.currentSpaceGetter=a}}$e=(0,i.__decorate)([(0,F.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===Me.l?Object:Me.l,void 0===Te?Object:Te,void 0===K?Object:K,void 0===D?Object:D,void 0===u.f?Object:u.f,void 0===z?Object:z])],$e);var Ye=s(94449),Qe=s(46449),He=s(162);class Je{execute({body:e}){const{password:t}=e;return(0,He.D)(ge(t)).pipe((0,k.U)((e=>(0,x.Vp)(e))))}constructor(){}}Je=(0,i.__decorate)([(0,Qe.e)(Ye.c),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[])],Je);var Ze=s(44955);const Xe=(e,t)=>t===n.All?[...new Set([...e[o.Compromised],...e[o.Reused],...e[o.Weak],...e[o.Excluded]])]:e[t],et=(e,t)=>{const s=((e,t)=>{if(0!==t.length)switch(e){case n.All:{const e={[o.Compromised]:3,[o.Weak]:2,[o.Reused]:1,[o.Excluded]:0};return t.reduce(((t,s)=>t?e[s.riskType]>e[t.riskType]?s:t:s),void 0)}case n.Compromised:return t.find((e=>e.riskType===o.Compromised));case n.Weak:return t.find((e=>e.riskType===o.Weak));case n.Reused:return t.find((e=>e.riskType===o.Reused));default:return}})(e,t);if(!s)return;const r={severity:d.COMMON};switch(s.riskType){case o.Compromised:{const e=[...s.breaches].sort(((e,t)=>{const s=Date.parse(e.date),r=Date.parse(t.date);return s===r?0:s<r?1:-1}))[0];return{...r,riskType:o.Compromised,date:e.date,domain:e.domains[0]??null,severity:d.STRONG}}case o.Reused:return{...r,riskType:o.Reused,reuseCount:s.credentialIds.length};case o.Weak:return{...r,riskType:o.Weak,strength:s.strength>=1?c.WEAK:c.EXTREMELY_WEAK}}},tt=(e,t,s,r,i)=>{let a;return a=null!==e?Xe(t[e],s):s===n.All?Object.keys(r):Object.keys(t).reduce(((e,r)=>[...e,...Xe(t[r],s)]),[]),i&&(a=a.filter((e=>i.includes(e)))),a.map((e=>((e,t)=>{const{id:s,title:r,login:i,email:a,autoProtected:o,shared:n,excluded:c,domains:d,risks:l}=e;return{id:s,title:r,login:i,email:a,autoProtected:o,shared:n,excluded:c,domainIcon:void 0,corruptionData:et(t,l),domain:d[0]}})(r[e],s)))};class st{execute({body:e}){const{credentialIds:t,spaceId:s,healthFilter:r}=e;return this.store.state$.pipe((0,k.U)((e=>null!==s&&void 0===e.index[s]?(0,x.Vp)([]):(0,x.Vp)(tt(s,e.index,r||n.All,e.credentialsAtRisk,t)))))}constructor(e){this.store=e}}st=(0,i.__decorate)([(0,Qe.e)(Ze.M),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D])],st);var rt=s(43651),it=s(16433);class at{isRunnable(){return(0,Ee.z)(this.isHourlyActivityReportEnabled())}async run(){await this.userActivitySenderService.sendReport()}isHourlyActivityReportEnabled(){return this.featureFlipsClient.queries.userFeatureFlips().pipe((0,k.U)((e=>{if((0,x.hx)(e))return!1;const t=!e.data[r.DisablePasswordHealth],s=e.data[r.PasswordHealthHourlySyncProd],i=e.data[r.PasswordHealthHourlySyncDev];return t&&(s||i)})),(0,k.U)((e=>e??!1)),(0,it.q)(1))}constructor(e,t){this.userActivitySenderService=e,this.featureFlipsClient=t}}at=(0,i.__decorate)([(0,F.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===$e?Object:$e,void 0===rt.P?Object:rt.P])],at);var ot=s(82874),nt=s(90797);class ct{async execute(){return await this.healthCacheUpdater.updateHealthState(),(0,x.Vp)(void 0)}constructor(e){this.healthCacheUpdater=e}}ct=(0,i.__decorate)([(0,ot.W)(nt.V),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===ke?Object:ke])],ct);var dt=s(45101);class lt{async execute({body:e}){const{commands:{carbon:t}}=this.carbonLegacyClient;return await t({name:"updateCredential",args:[{id:e.credentialId,update:{isExcludedFromHealth:e.excluded}}]}),this.store.update((t=>{const s={...t.credentialsAtRisk[e.credentialId],excluded:e.excluded},r={...t};return r.credentialsAtRisk[e.credentialId]=s,r.index=_e(t.credentialsAtRisk),r})),Promise.resolve((0,x.Vp)(void 0))}constructor(e,t){this.store=e,this.carbonLegacyClient=t}}lt=(0,i.__decorate)([(0,ot.W)(dt.v),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D,void 0===U._?Object:U._])],lt);var ut=s(52835);class pt{execute(){return this.healthCacheUpdaterService.update({isOutdated:!0}),Promise.resolve((0,x.Vp)(void 0))}constructor(e){this.healthCacheUpdaterService=e}}pt=(0,i.__decorate)([(0,ot.W)(ut.t),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===ke?Object:ke])],pt);var ht=s(94388),mt=s(85798);class gt{async handle(){const e=await this.isPasswordHealthEnabled(),t=await this.isHourlyActivityReportEnabled();if(e)if(t){await this.isFirstRun()&&await this.userActivitySender.sendReport()}else await this.userActivitySender.sendIfReportUpdated()}async isFirstRun(){const{lastSentDate:e}=await this.userActivityStore.getState();return 0===e}async isPasswordHealthEnabled(){const{userFeatureFlips:e}=this.featureFlips.queries,t=await(0,Ee.z)(e());return!!(0,x.hx)(t)||!(0,x.db)(t)[r.DisablePasswordHealth]}async isHourlyActivityReportEnabled(){const{userFeatureFlips:e}=this.featureFlips.queries,t=await(0,Ee.z)(e());if((0,x.hx)(t))return!1;const s=(0,x.db)(t),i=s[r.PasswordHealthHourlySyncProd],a=s[r.PasswordHealthHourlySyncDev];return i||a}constructor(e,t,s){this.featureFlips=e,this.userActivitySender=t,this.userActivityStore=s}}gt=(0,i.__decorate)([(0,mt.b)(ht.w),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===rt.P?Object:rt.P,void 0===$e?Object:$e,void 0===Te?Object:Te])],gt);var vt=s(5574),yt=s(91056),_t=s(50756);class St{async handle({body:e}){const{credentialId:t}=e,{commands:{trackEvent:s}}=this.cqrsClient.getClient(vt.Yu),r=(e=>({is_excluded:!!e&&ce(e),is_weak:!!e&&ae(e),is_reused:!!e&&oe(e),is_compromised:!!e&&ne(e)}))((await(0,Ee.z)(this.store.state$)).credentialsAtRisk[t]);return s({event:new _t.UserCredentialHealthReportEvent({credentialSecurityStatus:r,itemId:t})}),Promise.resolve(void 0)}constructor(e,t){this.store=e,this.cqrsClient=t}}St=(0,i.__decorate)([(0,mt.b)(yt.p),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D,void 0===$.w?Object:$.w])],St);var ft=s(39431),wt=s(34086);class It{handle({body:e}){const{ids:t,vaultItemType:s}=e;return s===ft.U.Credential&&this.healthCacheUpdater.update({isOutdated:!0,updatedCredentialIds:t}),Promise.resolve(void 0)}constructor(e){this.healthCacheUpdater=e}}It=(0,i.__decorate)([(0,mt.b)(wt.V),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===ke?Object:ke])],It);var bt=s(25666);class Et{handle({body:e}){const{ids:t,vaultItemType:s}=e;return s===ft.U.Credential&&this.healthCacheUpdater.update({isOutdated:!0,updatedCredentialIds:t}),Promise.resolve(void 0)}constructor(e){this.healthCacheUpdater=e}}Et=(0,i.__decorate)([(0,mt.b)(bt.J),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===ke?Object:ke])],Et);var Ct=s(46578);class At{handle({body:e}){const{ids:t,vaultItemType:s}=e;return s===ft.U.Credential&&this.healthCacheUpdater.update({isOutdated:!0,deletedCredentialIds:t}),Promise.resolve(void 0)}constructor(e){this.healthCacheUpdater=e}}At=(0,i.__decorate)([(0,mt.b)(Ct.s),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===ke?Object:ke])],At);var Rt=s(17430);class Tt{execute({body:e}){const{credentialId:t}=e;return this.store.state$.pipe((0,k.U)((e=>e.credentialsAtRisk[t]?(0,x.Vp)((e=>{const{excluded:t,risks:s}=e;return{excluded:t,corruptionData:et(n.All,s)}})(e.credentialsAtRisk[t])):(0,x.Vp)(null))))}constructor(e){this.store=e}}Tt=(0,i.__decorate)([(0,Qe.e)(Rt.w),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D])],Tt);var Ot=s(25374);const Dt=(e,t)=>{const{excluded:s,compromised:r,reused:i,weak:a,corruptedCount:o,importantCorruptedCount:n}=e,c=s.length,d=ze((0,Ve.R9)(o,n,t-c));return{total:t,excluded:c,compromised:r.length,reused:i.length,weak:a.length,score:d}},Ut=(e,t)=>{let s=0,r=0,i=0,a=0,o=0,n=0;for(const t of Object.values(e)){const{compromised:e,reused:c,weak:d,corruptedCount:l,importantCorruptedCount:u,excluded:p}=t;s+=e.length,r+=c.length,i+=d.length,a+=l,o+=u,n+=p.length}const c=(0,Ve.R9)(a,o,t-n);return{compromised:s,reused:r,total:t,weak:i,score:ze(c),excluded:n}};function Ft(e,t){return(0,x.hx)(e)?0:Object.keys(e.data).filter((s=>e.data[s].spaceId===t)).length}class Pt{execute({body:e}){const{spaceId:t=null}=e;return this.store.state$.pipe((0,G.V)(this.credentialsGetter.get(),this.cacheStateStore.state$),(0,k.U)((([e,s,r])=>{if(null!==t&&void 0===e.index[t]){const e=Ft(s,t);return(0,x.Vp)({counters:{compromised:0,reused:0,score:100,total:e,weak:0,excluded:0},isInitialized:r.lastUpdateTimestamp>0})}if(null===t){const t=(0,x.hx)(s)?0:Object.keys(s.data).length;return(0,x.Vp)({counters:Ut(e.index,t),isInitialized:r.lastUpdateTimestamp>0})}const i=Ft(s,t);return(0,x.Vp)({counters:Dt(e.index[t],i),isInitialized:r.lastUpdateTimestamp>0})})))}constructor(e,t,s){this.cacheStateStore=e,this.credentialsGetter=t,this.store=s}}Pt=(0,i.__decorate)([(0,Qe.e)(Ot.e),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===Pe?Object:Pe,void 0===K?Object:K,void 0===D?Object:D])],Pt);var xt=s(6136),Nt=s(22231);const Gt={[o.Compromised]:1,[o.Reused]:2,[o.Weak]:3,[o.Excluded]:4},kt=e=>[...e].sort(((e,t)=>{const s=Gt[e.corruptionData?.riskType??o.Excluded],r=Gt[t.corruptionData?.riskType??o.Excluded];if(s===r){const s=((e,t)=>e?.riskType===o.Compromised&&t?.riskType===o.Compromised?Date.parse(t.date)-Date.parse(e.date):e?.riskType===o.Reused&&t?.riskType===o.Reused?t.reuseCount-e.reuseCount:e?.riskType===o.Weak&&t?.riskType===o.Weak?e.strength===t.strength?0:e.strength===c.WEAK?1:-1:0)(e.corruptionData,t.corruptionData);return 0!==s?s:e.title.localeCompare(t.title)}return s-r})),Lt=20;class Mt{isPasswordHealthPaginationEnabled(){return this.featureFlipsClient.queries.userFeatureFlips().pipe((0,k.U)((e=>{if((0,x.hx)(e))return!1;const t=e.data[r.PasswordHealthPaginationProd],s=e.data[r.PasswordHealthPaginationDev];return t||s})),(0,it.q)(1))}execute({body:e}){const{healthFilter:t,spaceId:s,pageNumber:r=1,pageSize:i=Lt}=e;return this.store.state$.pipe((0,k.U)((e=>{if(null!==s&&void 0===e.index[s])return[];return kt(tt(s,e.index,t||n.All,e.credentialsAtRisk))})),(0,G.V)(this.isPasswordHealthPaginationEnabled()),(0,k.U)((([e,t])=>{const s=e.length;let a=e;if(t){const t=i*r;a=e.slice(0,t)}return{items:a,matchCount:s}})),(0,xt.x)(((e,t)=>{const s=0===e.matchCount&&0===t.matchCount,r=0===e.items.length&&0===t.items.length;return!(!s||!r)})),(0,k.U)(x.Vp))}constructor(e,t){this.store=e,this.featureFlipsClient=t}}Mt=(0,i.__decorate)([(0,Qe.e)(Nt.Q),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D,void 0===rt.P?Object:rt.P])],Mt);var Kt=s(35642);class jt{execute({body:e}){const{credentialIds:t}=e;return this.store.state$.pipe((0,k.U)((e=>(0,x.Vp)(((e,t)=>Object.keys(e).reduce(((t,s)=>[...t,...e[s].compromised]),[]).filter((e=>t.includes(e))))(e.index,t)))))}constructor(e){this.store=e}}jt=(0,i.__decorate)([(0,Qe.e)(Kt.v),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D])],jt);var Vt=s(69134);class zt{execute({body:e}){const{breachId:t}=e;return this.store.state$.pipe((0,k.U)((e=>(0,x.Vp)(((e,t)=>Object.keys(e.index).reduce(((s,r)=>[...s,...e.index[r].compromised.filter((s=>{const r=Z(e.credentialsAtRisk[s],o.Compromised);return r?.breaches.some((e=>e.breachId===t))}))]),[]))(e,t)))))}constructor(e){this.store=e}}zt=(0,i.__decorate)([(0,Qe.e)(Vt.A),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D])],zt);var Wt=s(61613);class qt{execute(){return this.store.state$.pipe((0,G.V)(this.credentialsGetter.get()),(0,k.U)((([e,t])=>{const s={};if(!(0,x.d6)(t))throw new Error("Error while retrieving credentials");const r=qe(t.data),i=Object.keys(t.data).length,a=function(e){const t={};return Object.keys(e).forEach((s=>{const r=Z(e[s],o.Compromised),i=e[s].spaceId;if(void 0===r)return;void 0===t[i]&&(t[i]={breaches:new Set,compromisedByBreaches:{}});const a=r.breaches.map((e=>e.breachId));t[i].breaches=new Set([...t[i].breaches,...a]),t[i].compromisedByBreaches[s]=new Set(a)})),t}(e.credentialsAtRisk);let n=new Set([]),c={},d=0;return Object.keys(e.index).forEach((t=>{const i=e.index[t],o=Dt(i,r[t]);s[t]={...o,breaches:a[t]?.breaches??new Set,compromisedByBreach:a[t]?.compromisedByBreaches??{},corrupted:i.corruptedCount},n=new Set([...n,...a[t]?.breaches??new Set]),c={...c,...a[t]?.compromisedByBreaches??{}},d+=i.corruptedCount})),s.global={...Ut(e.index,i),breaches:n,compromisedByBreach:c,corrupted:d},(0,x.Vp)(s)})))}constructor(e,t){this.store=e,this.credentialsGetter=t}}qt=(0,i.__decorate)([(0,Qe.e)(Wt.b),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===D?Object:D,void 0===K?Object:K])],qt);class Bt{}Bt=(0,i.__decorate)([(0,p.Yl)({api:a.d,crons:[{handler:Le,name:"health-cache",periodInMinutes:15,scope:g.F.User},{handler:at,name:"user-activity-report",periodInMinutes:60,scope:g.F.User}],handlers:{commands:{updateIsCredentialExcluded:lt,recalculatePasswordHealth:pt,updateHealthState:ct},events:{...(0,p.g4)(a.d,{passwordHealthComputationFinished:gt}),...(0,p.g4)(h.Y,{passwordAutofillPerformed:St}),...(0,p.g4)(m.L,{updated:It,created:Et,deleted:At})},queries:{credentialHealthData:Tt,score:Pt,filterCredentials:Mt,filterCredentialsIds:st,compromisedCredentials:jt,compromisedCredentialsIdsForBreach:zt,passwordHealthReport:qt,scoreForPassword:Je}},imports:[l.n],stores:[D,Te,Pe],providers:[K,j.U,B,Ce,ke,Le,H,$e,D,u.f,z,at],requiredFeatureFlips:[r.DisablePasswordHealth,r.PasswordHealthPaginationDev,r.PasswordHealthPaginationProd,r.PasswordHealthHourlySyncDev,r.PasswordHealthHourlySyncProd]})],Bt)},18969:(e,t,s)=>{s.d(t,{JK:()=>c,R9:()=>d,RG:()=>r});const r=5,i=.6,a=1,o=1,n=.2,c=100;function d(e,t,s){if(s<r)return null;const c=t/s,d=e/s,l=i*Math.pow(1-c,a),u=(1-i)*Math.pow(1-d,o);return n+(1-n)*(l+u)}},61573:(e,t,s)=>{s.d(t,{E:()=>B});var r=s(491),i=s(86006),a=s(97203),o=s(68754),n=s(60399),c=s(19216),d=s(8260);class l extends((0,d.E)(o.d)){}(0,d.K)(o.d,l);var u=s(92587),p=s(24418),h=s(87279),m=s(50756),g=s(20980),v=s(35594),y=s(39431),_=s(77802),S=s(50879),f=s(88559),w=s(62149),I=s(63144),b=s(56618),E=s(28489),C=s(10722);const A=e=>!(!e||"object"!=typeof e)&&((0,E.l$)(e,"lastSentDate")&&"number"==typeof e.lastSentDate);class R extends((0,I.Q)({codec:C.E,persist:!0,storage:{initialValue:{lastSentDate:0},schemaVersion:1,typeGuard:A},scope:w.F.User,storeName:"vault-report",storeTypeGuard:A,capacity:b.Y._001KB,isCache:!0})){}const T="global",O={collectionsCount:-1,collectionsSharedCount:-1,multipleCollectionsCount:-1,multipleCollectionsSharedCount:-1,singleCollectionCount:-1,singleCollectionSharedCount:-1};function D(e){if(0===e.length)return 0;const t=e.flatMap((e=>e.vaultItems)),s=new Set(t.map((e=>e.id))).size;return Math.round(t.length/s)}function U(e){if(0===e.length)return 0;let t=0,s=0;for(const r of e)r.vaultItems.length>0&&(s+=r.vaultItems.length,t++);return Math.round(s/t)}function F(e){let t=0,s=0,r=0,i=0;const a=e.reduce(((e,t)=>(t.vaultItems.forEach((s=>{const r=s.id;e[r]?(e[r].all++,t.isShared&&e[r].shared++):e[r]={all:1,shared:t.isShared?1:0}})),e)),{});return Object.values(a).forEach((e=>{e.all>1?t++:1===e.all&&s++,e.shared>1?r++:1===e.shared&&i++})),{collectionsCount:e.length,collectionsSharedCount:e.filter((e=>e.isShared)).length,multipleCollectionsCount:t,multipleCollectionsSharedCount:r,singleCollectionCount:s,singleCollectionSharedCount:i}}var P=s(70942);const x=e=>e.reduce(((e,t)=>({...e,[t.id]:{...t}})),{});const N=(e,t=[])=>{const s={[T]:{totalCount:0,sharedCount:0}};return e.forEach((e=>{const r=e.spaceId;void 0===s[r]&&(s[r]={totalCount:0,sharedCount:0}),s[r].totalCount++,s[T].totalCount++,t.includes(e.id)&&(s[r].sharedCount++,s[T].sharedCount++)})),s};var G=s(18969);const k=(e,t)=>({total_count:t?.totalCount??0,shared_count:t?.sharedCount??0,collections_count:e?.collectionsCount??0,collections_shared_count:e?.collectionsSharedCount??0,multiple_collections_count:e?.multipleCollectionsCount??0,multiple_collections_shared_count:e?.multipleCollectionsSharedCount??0,single_collection_count:e?.singleCollectionCount??0,single_collection_shared_count:e?.singleCollectionSharedCount??0}),L=[y.U.Email,y.U.Address,y.U.Company,y.U.Phone,y.U.Website,y.U.Identity],M=[y.U.BankAccount,y.U.PaymentCard],K=[y.U.DriversLicense,y.U.FiscalId,y.U.IdCard,y.U.Passport,y.U.SocialSecurityId],j=[y.U.Credential,y.U.SecureNote,y.U.Secret,y.U.Passkey,...L,...M,...K];class V{getSpaceScope(e){switch(e){case"":return m.Scope.Personal;case T:return m.Scope.Global;default:return m.Scope.Team}}async send(){const e=await(0,n.z)(this.passwordHealth.queries.passwordHealthReport());if((0,h.hx)(e))return Promise.reject(new Error("Error while retrieving health report for creating the vault report"));const t=await(0,n.z)(this.breachesGetter.getSupportedBreaches());if((0,h.hx)(t))return Promise.reject(new Error("Error while retrieving breaches for creating the vault report"));const s=await(0,n.z)(this.vaultCrud.queries.query({vaultItemTypes:j}));if((0,h.hx)(s))return Promise.reject(new Error("Error while retrieving credentials for creating the vault report"));const r=(0,h.db)(s).credentialsResult,i=await(0,n.z)(this.autofillSettings.queries.getPreferencesForCredentials({}));if((0,h.hx)(i))return Promise.reject(new Error("Error while retrieving credential preferences for creating the vault report"));const a=await(0,n.z)(this.vault.queries.queryCollections({}));if((0,h.hx)(a))return Promise.reject(new Error("Error while retrieving collections for creating the vault report"));const o=await(0,n.z)(this.sharedCollections.queries.sharedCollectionsWithItems());if((0,h.hx)(o))return Promise.reject(new Error("Error while retrieving shared collections for creating the vault report"));const c=await(0,n.z)(this.sharedItems.queries.sharedItemsIds());if((0,h.hx)(c))return Promise.reject(new Error("Error while retrieving shared items ids for creating the vault report"));const d=function(e,t,s){const r=x(e),i=x(t),a={[T]:{domainsWithoutAutofillCount:0,totalCount:0,sharedCount:0,passwordsWithOtpCount:0,passwordsProtectedWithMasterPasswordCount:0}};return Object.keys(r).forEach((e=>{const t=r[e].spaceId;void 0===a[t]&&(a[t]={domainsWithoutAutofillCount:0,totalCount:0,sharedCount:0,passwordsWithOtpCount:0,passwordsProtectedWithMasterPasswordCount:0}),a[t].totalCount++,a[T].totalCount++,s.includes(e)&&(a[t].sharedCount++,a[T].sharedCount++),i[e].useAutoLogin||(a[t].domainsWithoutAutofillCount++,a[T].domainsWithoutAutofillCount++),(r[e].otpSecret||r[e].otpURL)&&(a[t].passwordsWithOtpCount++,a[T].passwordsWithOtpCount++),i[e].requireMasterPassword&&(a[t].passwordsProtectedWithMasterPasswordCount++,a[T].passwordsProtectedWithMasterPasswordCount++)})),a}(r.items,(0,h.db)(i),c.data),l=function(e,t){const s=new Set,r=new Set;e.forEach((e=>{(0,P.F7)(e.Content)?r.add(e.Id):s.add(e.Id)}));const i=new Set,a=new Set,o={global:{activePrivateBreachAlerts:0,activePublicBreachAlerts:0,passwordsCompromisedThroughPrivateBreaches:0,privateBreachAlerts:r.size,publicBreachAlerts:s.size}};return Object.keys(t).forEach((e=>{if(e===T)return;const n=t[e];void 0===o[e]&&(o[e]={activePrivateBreachAlerts:0,activePublicBreachAlerts:0,passwordsCompromisedThroughPrivateBreaches:0,privateBreachAlerts:r.size,publicBreachAlerts:s.size}),[...n.breaches].forEach((t=>{s.has(t)?(o[e].activePublicBreachAlerts++,i.add(t)):r.has(t)&&(o[e].activePrivateBreachAlerts++,a.add(t))})),Object.keys(n.compromisedByBreach).forEach((t=>{[...n.compromisedByBreach[t]].some((e=>r.has(e)))&&o[e].passwordsCompromisedThroughPrivateBreaches++})),o[T].passwordsCompromisedThroughPrivateBreaches+=o[e].passwordsCompromisedThroughPrivateBreaches})),o[T].activePrivateBreachAlerts=a.size,o[T].activePublicBreachAlerts=i.size,o}(t.data,e.data);return Object.keys(d).forEach((t=>{const r=e.data[t],i=function(e,t,s){const r=[...e,...t].filter((e=>s===T||s&&e.spaceId||!s&&!e.spaceId)),i=s?t.length:0,a=i+(s===T?e.length:e.filter((e=>s&&e.spaceId||!s&&!e.spaceId)).length);return{itemsPerCollectionAverageCount:U(r),collectionsPerItemAverageCount:D(r),ids:O,passwords:F(r),payments:O,personalInfo:O,secureNotes:O,collectionsSharedCount:i,collectionsTotalCount:a}}((0,h.db)(a).collections,o.data,t),n={scope:this.getSpaceScope(t),...i,...d[t],...l[t]},u=((e,t)=>e?{passwordsSafeCount:t.totalCount-e.corrupted,passwordsExcludedCount:e.excluded,passwordsCompromisedCount:e.compromised,passwordsReusedCount:e.reused,securityScore:e.score??void 0,passwordsWeakCount:e.weak}:{passwordsSafeCount:t.totalCount,passwordsExcludedCount:0,passwordsCompromisedCount:0,passwordsReusedCount:0,securityScore:t.totalCount<G.RG?void 0:G.JK,passwordsWeakCount:0})(r,d[t]),p=((e,t,s,r,i)=>{const a=N([...t.idCardsResult.items,...t.socialSecurityIdsResult.items,...t.driversLicensesResult.items,...t.fiscalIdsResult.items,...t.passportsResult.items]),o=N(t.secureNotesResult.items,i),n=N(t.secretsResult.items,i),c=N(t.passkeysResult.items,i),d=N([...t.paymentCardsResult.items,...t.bankAccountsResult.items]),l=N([...t.addressesResult.items,...t.emailsResult.items,...t.phonesResult.items,...t.websitesResult.items,...t.companiesResult.items,...t.identitiesResult.items]),{totalCount:u,sharedCount:p}=((e,t)=>t.reduce(((t,s)=>({totalCount:t.totalCount+(s[e]?.totalCount??0),sharedCount:t.sharedCount+(s[e]?.sharedCount??0)})),{totalCount:0,sharedCount:0}))(e,[s,a,l,d,n,o,c]);return{itemsTotalCount:u,itemsSharedCount:p,ids:k(r.ids,a[e]),personalInfo:k(r.personalInfo,l[e]),secureNotes:k(r.secureNotes,o[e]),secrets:k(void 0,n[e]),passkeys:k(void 0,c[e]),payments:k(r.payments,d[e]),passwords:k(r.passwords,s[e])}})(t,s.data,d,i,c.data),g=new m.UserVaultReportEvent({...n,...u,...p});this.analytics.commands.trackEvent({event:g})})),this.store.set({lastSentDate:Date.now()}),Promise.resolve()}async shouldBeSent(){return(await(0,n.z)(this.store.state$)).lastSentDate+864e5<Date.now()}constructor(e,t,s,r,i,a,o,n,c){this.autofillSettings=e,this.breachesGetter=t,this.store=s,this.analytics=r,this.passwordHealth=i,this.vault=a,this.vaultCrud=o,this.sharedCollections=n,this.sharedItems=c}}V=(0,r.__decorate)([(0,u.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===c.W?Object:c.W,void 0===f.U?Object:f.U,void 0===R?Object:R,void 0===p.R?Object:p.R,void 0===l?Object:l,void 0===_.C?Object:_.C,void 0===S.L?Object:S.L,void 0===g.L?Object:g.L,void 0===v.s?Object:v.s])],V);var z=s(94388),W=s(85798);class q{async handle(){await this.vaultReportSender.shouldBeSent()&&this.vaultReportSender.send()}constructor(e){this.vaultReportSender=e}}q=(0,r.__decorate)([(0,W.b)(z.w),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===V?Object:V])],q);class B{}B=(0,r.__decorate)([(0,i.Yl)({api:a.f,handlers:{commands:{},events:{...(0,i.g4)(o.d,{passwordHealthComputationFinished:q})},queries:{}},providers:[f.U,V],stores:[R]})],B)},4350:(e,t,s)=>{s.d(t,{v:()=>r});const r="ecommerce_cancel_flow_discounts"},77404:(e,t,s)=>{s.d(t,{c:()=>n});var r=s(75958),i=s(42616),a=s(74475),o=s(56314);const n=(0,r.Q)({name:"b2cPlansApi",commands:{},events:{},queries:{getB2CPlanPricing:i.W,getCancelationCouponDiscount:a.x,getB2CSubscriptionInfo:o.O}})},42616:(e,t,s)=>{s.d(t,{W:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},56314:(e,t,s)=>{s.d(t,{O:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},74475:(e,t,s)=>{s.d(t,{x:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},58428:(e,t,s)=>{s.d(t,{X:()=>A});var r=s(491),i=s(86006),a=s(77404);var o=s(41511),n=s(92587),c=s(53344),d=s(48844),l=s(87279);class u{getPlanPricing({login:e,userKey:t,couponCode:s,language:r,hasEssentials:i}){return this.serverApiClient.v1.payments.getAccessibleWebOffers({login:e,userKey:t,couponCode:s,language:r,forceFamily:!0,hasEssentials:i}).pipe((0,d.DZ)((e=>{throw new Error(`GetPlanPricing failed with error: ${e}`)})),(0,d.lk)((e=>{const{plans:t,currency:s}=e.data,{family:r,premium:i}=t,{offers:a,...o}=r,{offers:n,...c}=i,d={plans:{family:{offers:a.map((({price:e,duration:t,...s})=>({price:.01*(e??0),billingPeriod:{periodicity:this.getPeriodicity(t.unit,t.value),value:t.value},...s}))),...o},premium:{offers:n.map((({price:e,duration:t,...s})=>({price:.01*(e??0),billingPeriod:{periodicity:this.getPeriodicity(t.unit,t.value),value:t.value},...s}))),...c}},currency:s};return(0,l.Vp)(d)})))}constructor(e){this.serverApiClient=e,this.getPeriodicity=(e,t)=>"d"===e&&t>=30||"M"===e&&1===t?"monthly":"y"===e&&1===t||"M"===e&&12===t?"yearly":"other"}}u=(0,r.__decorate)([(0,n.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===c.l?Object:c.l])],u);class p{constructor(e){this.serverApiClient=e,this.getCancelationCouponDiscount=()=>this.serverApiClient.v1.premium.getB2CCancellationCoupon({}).pipe((0,d.DZ)((e=>{throw new Error(`GetB2CCancellationCoupon failed with error: ${e}`)})),(0,d.lk)((e=>(0,l.Vp)({couponCode:e.data.couponCode??null}))))}}p=(0,r.__decorate)([(0,n.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===c.l?Object:c.l])],p);var h=s(87065),m=s(3843);class g{getB2CSubscriptionInfo(){return this.serverApiClient.v1.premium.getSubscriptionInfo({}).pipe((0,h.U)((e=>{if(!(0,l.d6)(e))throw new Error(`Cannot retrieve subscription info. Error: ${e.error} `);const{billingInformation:t}=e.data.data.b2cSubscription;return(0,l.Vp)({last4DigitsFormatted:this.formatCardLast4Digits(Number(t?.last4)),expirationDateFormatted:t?.exp_year&&t.exp_month?`${t.exp_month}/${t.exp_year.toString().substring(2)}`:"",hasCreditCardPaymentMethod:!!t?.last4,isExpired:this.isBillingMethodExpired(t),billingCountry:t?.country??"",cardType:t?.type??""})})))}constructor(e){this.serverApiClient=e,this.isBillingMethodExpired=e=>!(!e?.exp_year||!e.exp_month)&&(0,m.Z)(new Date(e.exp_year,e.exp_month,0)),this.formatCardLast4Digits=e=>e.toLocaleString("en-US",{minimumIntegerDigits:4,useGrouping:!1})}}g=(0,r.__decorate)([(0,n.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===c.l?Object:c.l])],g);var v=s(41842),y=s(43978),_=s(46449),S=s(14122),f=s(42616);class w{execute(){const{carbonState:e}=this.carbonLegacyClient.queries;return e({path:"userSession.account.login"}).pipe((0,v.h)(l.d6),(0,h.U)((e=>e.data)),(0,y.w)((e=>this.webOffersService.getPlanPricing({login:e}))))}constructor(e,t){this.carbonLegacyClient=e,this.webOffersService=t}}w=(0,r.__decorate)([(0,_.e)(f.W),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===S._?Object:S._,void 0===u?Object:u])],w);var I=s(74475);class b{execute(){return this.cancelationService.getCancelationCouponDiscount()}constructor(e){this.cancelationService=e}}b=(0,r.__decorate)([(0,_.e)(I.x),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===p?Object:p])],b);var E=s(56314);class C{execute(){return this.subscriptionInfoService.getB2CSubscriptionInfo()}constructor(e){this.subscriptionInfoService=e}}C=(0,r.__decorate)([(0,_.e)(E.O),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===g?Object:g])],C);class A{}A=(0,r.__decorate)([(0,i.Yl)({api:a.c,handlers:{commands:{},events:{},queries:{getB2CPlanPricing:w,getCancelationCouponDiscount:b,getB2CSubscriptionInfo:C}},imports:[o.n],providers:[u,p,g],requiredFeatureFlips:Object.values({CANCEL_DISCOUNT_FF:"b2c_ecommerce_web_optimize_cancel_flow_phase1",CANCEL_DISCOUNT_PHASE2_FF:"b2c_ecommerce_web_optimize_cancel_flow_phase2",ACCOUNT_REFERRAL_PHASE3_FF:"b2c_ecommerce_web_optimize_cancel_flow_phase3",CANCEL_FLOW_OPTIMIZATIONS_DEV:"b2c_ecommerce_web_optimize_cancel_flow_dev"})})],A)},93381:(e,t,s)=>{s.d(t,{Z:()=>$});var r=s(491),i=s(86006),a=s(41511),o=s(89193),n=s(67873),c=s(77153),d=s(62149),l=s(63144),u=s(56618),p=s(10722);const h=e=>!(!e||"object"!=typeof e)&&("activityLogsQueue"in e&&Array.isArray(e.activityLogsQueue));class m extends((0,l.Q)({persist:!0,storage:{initialValue:{activityLogsQueue:[]},typeGuard:h,schemaVersion:1},scope:d.F.User,storeName:"activity-logs",storeTypeGuard:h,codec:p.E,capacity:u.Y._010KB})){}var g=s(64987),v=s(98976),y=s(82874),_=s(87279),S=s(60399),f=s(14122),w=s(92587),I=s(48844);class b{get(){const{queries:{carbonState:e}}=this.carbonLegacyClient;return e({path:"state.userSession.spaceData.spaces"}).pipe((0,I.Qn)((e=>{if(!(e=>!!Array.isArray(e)&&(0===e.length||e.every((e=>{const t=e;return"string"==typeof t?.teamId&&"object"==typeof t?.details&&"string"==typeof t?.details.status}))))(e))throw new Error("Bad space item format");const t=e.find((e=>"accepted"===e.details.status)),s=t?.details.info.collectSensitiveDataAuditLogsEnabled;return Boolean(s)})))}constructor(e){this.carbonLegacyClient=e}}b=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===f._?Object:f._])],b);const E=new g.WU;class C{async execute({body:{activityLogs:e}}){const t=await(0,S.z)(this.sensitiveLogsEnabledGetter.get());if(!(0,_.d6)(t))throw new Error("Error while getting sensitive logs enabled data");const s=e.filter((e=>!e.is_sensitive||t.data));return s.length&&await this.updateActivityLogsState(s),Promise.resolve((0,_.Vp)(void 0))}async updateActivityLogsState(e){await E.runExclusive((async()=>{const t=await this.activityLogsStore.getState();await this.activityLogsStore.set({...t,activityLogsQueue:[...t.activityLogsQueue,...e]})}))}constructor(e,t){this.activityLogsStore=e,this.sensitiveLogsEnabledGetter=t}}C=(0,r.__decorate)([(0,y.W)(v.M),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===m?Object:m,void 0===b?Object:b])],C);var A=s(50423),R=s(53344),T=s(57986),O=s(43651);class D{async sendLogs(e){if(await this.hasEncryptedLogsFF()){const t=await this.enclaveProxyClient.auditLogs.store(e);return(0,_.hx)(t)?t:t.data.invalidAuditLogs.length?(0,_.Vp)(this.serverToTechnicalSchemaErrorsMapper(t.data.invalidAuditLogs)):(0,_.Vp)(void 0)}return await(0,S.z)(this.serverApiClient.v1.teams.storeAuditLogs({auditLogs:e}).pipe((0,I.DZ)((()=>(0,_.Rn)("storeActivityLogs failed with an unknown HTTP error"))),(0,I.lk)((e=>e.data.invalidAuditLogs.length?(0,_.Vp)(this.serverToTechnicalSchemaErrorsMapper(e.data.invalidAuditLogs)):(0,_.Vp)(void 0)))))}serverToTechnicalSchemaErrorsMapper(e){return{invalidActivityLogs:e.map((e=>({uuid:e.uuid,error:v.W[e.error]})))}}async startAuditLogQuery(e,t){return await this.hasEncryptedLogsFF()?this.enclaveProxyClient.auditLogs.queryStart({startDateRangeUnixMs:1e3*e,endDateRangeUnixMs:1e3*t}):(0,S.z)(this.serverApiClient.v1.teams.startAuditLogsQuery({startDateRangeUnix:e,endDateRangeUnix:t}).pipe((0,I.DZ)((()=>{throw new Error("Error while starting audit log query")})),(0,I.Qn)((e=>e.data.queryExecutionId))))}async getAuditLogQueryResults({queryExecutionId:e,nextToken:t,maxResults:s}){if(await this.hasEncryptedLogsFF()){const r=await this.enclaveProxyClient.auditLogs.queryResults({queryExecutionId:e,nextToken:t,maxResults:s});return(0,_.hx)(r)?r:(0,_.Vp)({nextToken:r.data.nextToken??void 0,state:r.data.state,logs:r.data.results?.map((e=>JSON.parse(e)))||[]})}return(0,S.z)(this.serverApiClient.v1.teams.getAuditLogQueryResults({queryExecutionId:e,nextToken:t,maxResults:s??100}).pipe((0,I.DZ)((()=>{throw new Error("Error while retrieving audit log query result")})),(0,I.Qn)((e=>({state:e.data.state,nextToken:e.data.nextToken,logs:e.data.results.map((e=>JSON.parse(e)))})))))}async hasEncryptedLogsFF(){const e=await(0,S.z)(this.featureFlipsClient.queries.userFeatureFlip({featureFlip:"setup_rollout_encrypted_logsin_transit"}));return(0,_.d6)(e)&&Boolean(e.data)}constructor(e,t,s){this.enclaveProxyClient=e,this.serverApiClient=t,this.featureFlipsClient=s}}D=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.X?Object:T.X,void 0===R.l?Object:R.l,void 0===O.P?Object:O.P])],D);class U{async isRunnable(){const{activityLogsQueue:e}=await this.activityLogsStore.getState();return e.length>0}async run(){const{activityLogsQueue:e}=await this.activityLogsStore.getState();await this.attemptSendLogsToServer(e)}async attemptSendLogsToServer(e){const t=[...e];for(;t.length>0;){const e=t.splice(0,40);await this.sendLogsToServer(e)}}async sendLogsToServer(e){const t=await this.activityLogsService.sendLogs(e);if((0,_.hx)(t))return;const s=e.map((e=>e.uuid));if(await this.removeSentLogsFromActivityLogsQueue(s),t.data?.invalidActivityLogs){const s=this.createLogsTypeMap(e),r=e=>()=>{const t=s.get(e.uuid);throw new Error(`An activity log with a log type of ${t} has been detected to have a technical/schema error. (${e.error})`)};await this.allowedToFail.do((t.data.invalidActivityLogs??[]).map(r))}}createLogsTypeMap(e){const t=new Map;return e.forEach((e=>{t.set(e.uuid,e.log_type)})),t}async removeSentLogsFromActivityLogsQueue(e){const{activityLogsQueue:t}=await this.activityLogsStore.getState(),s=t.filter((t=>!e.includes(t.uuid)));await this.activityLogsStore.set({activityLogsQueue:[...s]})}constructor(e,t,s){this.activityLogsService=e,this.allowedToFail=t,this.activityLogsStore=s}}U=(0,r.__decorate)([(0,w.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===D?Object:D,void 0===A.J?Object:A.J,void 0===m?Object:m])],U);var F=s(57571);class P extends((0,l.Q)({persist:!1,isCache:!0,scope:d.F.User,storeName:"activity-logs-data",initialValue:{status:F.Q.NOT_LOADED},capacity:u.Y._100KB})){}var x=s(56073),N=s(55920);const G=(e,t)=>{if(!t)return e;const{categories:s,domain:r,logTypes:i,login:a}=t;return e.filter((e=>{if(a&&!e.properties?.author_login?.includes(a))return!1;if(s&&!s.some((t=>e.category===t)))return!1;if(i&&!i.some((t=>e.log_type===t)))return!1;if(r){const t=e.properties;if(!t.domain_url?.includes(r))return!1}return!0}))},k=e=>e.filter((e=>e.log_type===N.z.UserTypedPassword&&"safe"===e.properties?.health_status?null:e)),L=e=>e.map((e=>e.category===N.p.SecurityMonitoring?{...e,category:N.p.RiskDetection}:e));class M{async execute({body:e}){const{maxResults:t,target:s="all"}=e,r=await this.logsStore.getState(),{queryInfo:i}=r;return i?.queryExecutionId&&i.nextToken?(this.logsStore.set({...r,queryInfo:{...i,nextToken:void 0},status:F.Q.LOADING}),this.loadNextActivityLogs({state:r,maxResults:t,target:s})):Promise.resolve((0,_.Vp)(void 0))}async loadNextActivityLogs({state:e,maxResults:t,target:s}){if(!e.queryInfo?.queryExecutionId||!e.queryInfo.nextToken)return Promise.resolve((0,_.Vp)(void 0));const r=await this.activityLogService.getAuditLogQueryResults({queryExecutionId:e.queryInfo.queryExecutionId,nextToken:e.queryInfo.nextToken,maxResults:t});if((0,_.hx)(r))return this.logsStore.set({status:F.Q.ERROR}),Promise.resolve((0,_.Vp)(void 0));const{logs:i,nextToken:a}=r.data,o=L(i),n="table"===s?k(G(o,e.queryInfo.filters)):G(o,e.queryInfo.filters);return 0===n.length&&a?this.loadNextActivityLogs({state:{...e,queryInfo:{...e.queryInfo,nextToken:a}},target:s}):(this.logsStore.set({...e,status:F.Q.READY,queryInfo:{...e.queryInfo,nextToken:a},logs:[...e.logs??[],...n]}),Promise.resolve((0,_.Vp)(void 0)))}constructor(e,t){this.logsStore=e,this.activityLogService=t}}M=(0,r.__decorate)([(0,y.W)(x.X),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===P?Object:P,void 0===D?Object:D])],M);var K=s(79448);class j{async execute({body:{startDate:e,endDate:t,filters:s,target:r="all"}}){this.logsStore.set({status:F.Q.LOADING,queryInfo:{filters:s}});const i=await this.activityLogService.startAuditLogQuery(e,t);if((0,_.hx)(i))return this.logsStore.set({status:F.Q.ERROR}),Promise.resolve((0,_.Vp)(void 0));const{data:a}=i;let o=!1;do{const e=await this.activityLogService.getAuditLogQueryResults({queryExecutionId:a});if((0,_.hx)(e)||"CANCELLED"===e.data.state||"FAILED"===e.data.state){this.logsStore.set({status:F.Q.ERROR});break}const{state:t,nextToken:i,logs:n}=e.data;if("QUEUED"===t){await new Promise((e=>setTimeout((()=>e()),1e3)));continue}if("RUNNING"===t){await new Promise((e=>setTimeout((()=>e()),500)));continue}const c=L(n),d="table"===r?k(G(c,s)):G(c,s);this.logsStore.set({status:F.Q.READY,logs:d,queryInfo:{queryExecutionId:a,nextToken:i,filters:s}}),o=!0}while(!o);return Promise.resolve((0,_.Vp)(void 0))}constructor(e,t){this.logsStore=e,this.activityLogService=t}}j=(0,r.__decorate)([(0,y.W)(K.b),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===P?Object:P,void 0===D?Object:D])],j);var V=s(46449),z=s(87065);class W{execute(){return this.logsStore.state$.pipe((0,z.U)((e=>(0,_.Vp)({logs:e.logs??[],hasMoreData:!!e.queryInfo?.nextToken,status:e.status}))))}constructor(e){this.logsStore=e}}W=(0,r.__decorate)([(0,V.e)(F.I),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===P?Object:P])],W);var q=s(60678);class B{execute(){return this.sensitiveLogsEnabledGetter.get()}constructor(e){this.sensitiveLogsEnabledGetter=e}}B=(0,r.__decorate)([(0,V.e)(q._),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===b?Object:b])],B);class ${}$=(0,r.__decorate)([(0,i.Yl)({api:o.g,imports:[a.n,c.y],providers:[D,b],stores:[m,P],crons:[{handler:U,periodInMinutes:1,name:"activity-logs-cron",scope:d.F.User}],handlers:{commands:{initiateActivityLogsRetrieval:j,loadNextActivityLogs:M,storeActivityLogs:C},events:{},queries:{activityLogs:W,areSensitiveLogsEnabled:B}},requiredFeatureFlips:["setup_rollout_encrypted_logsin_transit",n.q.SharingVaultTacAuditLogsProtectedItemRevealed]})],$)},74898:(e,t,s)=>{s.d(t,{a:()=>We});var r=s(491),i=s(86006),a=s(48302),o=s(16624),n=s(41511),c=s(60590),d=s(30049),l=s(48847),u=s(56680),p=s(6453),h=s(77153),m=s(63144),g=s(56618),v=s(62149),y=s(7165);const _=y.z.object({active:y.z.boolean(),teamId:y.z.number().nullable(),configuration:y.z.nullable(y.z.object({}))}),S=e=>_.safeParse(e).success,f=y.z.object({active:y.z.boolean(),teamId:y.z.number().nullable(),configuration:y.z.nullable(y.z.object({})),lastUpdateTimestamp:y.z.number()}),w=e=>f.safeParse(e).success,I=y.z.array(y.z.object({startDate:y.z.number(),endDate:y.z.number(),nLogins:y.z.number(),nWeak:y.z.number(),nCompromised:y.z.number()})),b=y.z.object({week:y.z.object({insights:y.z.object({nLogins:y.z.number().nullable(),nWeak:y.z.number().nullable(),nCompromised:y.z.number().nullable()}),history:I}),month:y.z.object({insights:y.z.object({nLogins:y.z.number().nullable(),nWeak:y.z.number().nullable(),nCompromised:y.z.number().nullable()}),history:I}),year:y.z.object({insights:y.z.object({nLogins:y.z.number().nullable(),nWeak:y.z.number().nullable(),nCompromised:y.z.number().nullable()}),history:I}),lastUpdateTimestamp:y.z.number(),lastLogDateTime:y.z.number(),hasLogsInLastYear:y.z.boolean()}),E=e=>b.safeParse(e).success;class C extends((0,m.Q)({persist:!1,scope:v.F.User,storeName:"risk-detection-insights",initialValue:{week:{insights:{nLogins:null,nWeak:null,nCompromised:null},history:[]},month:{insights:{nLogins:null,nWeak:null,nCompromised:null},history:[]},year:{insights:{nLogins:null,nWeak:null,nCompromised:null},history:[]},lastUpdateTimestamp:0,lastLogDateTime:0,hasLogsInLastYear:!1},storeTypeGuard:E,capacity:g.Y._010KB})){}var A=s(60399),R=s(92587),T=s(53344),O=s(87279);class D{async check(e){const t=await this.passwordHasher.hash(e),s=await(0,A.z)(this.serverApiClient.v1.pwleak.getHashes({hashPrefix:t.substring(0,6)}));if((0,O.hx)(s))throw new Error("Error while retrieving list of hashes for password leak check");return s.data.data.includes(t)}constructor(e,t){this.serverApiClient=e,this.passwordHasher=t}}D=(0,r.__decorate)([(0,R.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.l?Object:T.l,void 0===p.T?Object:p.T])],D);var U=s(55920),F=s(98976),P=s(57986),x=s(45368);class N extends((0,m.Q)({persist:!1,scope:v.F.Device,storeName:"mass-deployment-security-monitoring-configuration-for-extension",initialValue:{active:!1,teamId:null,configuration:{},lastUpdateTimestamp:0},storeTypeGuard:w,capacity:g.Y._001KB})){}class G{async refreshStateIfOutdated(){const e=await this.configurationForExtensionStore.getState();if(0===e.lastUpdateTimestamp||e.lastUpdateTimestamp+3e5<Date.now()){const e=await this.getConfiguration();if((0,O.d6)(e)){const t={...e.data,lastUpdateTimestamp:Date.now()};return this.configurationForExtensionStore.set(t),(0,O.Vp)(t)}return(0,O.Rn)(void 0)}return(0,O.Vp)(e)}async getConfiguration(){const e=await(0,A.z)(this.serverApiClient.v1.massdeployment.getMassDeploymentSecurityMonitoringConfigForExtension());return(0,O.hx)(e)?(0,O.Rn)(void 0):(0,O.Vp)(e.data.data)}async getUsernameFromBrowserPolicies(){const e="Username";try{const t=await(0,x.U)();if("object"==typeof t&&null!==t&&e in t&&"string"==typeof t[e]&&t[e].length)return{username:t[e]}}catch(e){throw new Error("Error getting Username property from Mass-Deployed Browser Policies.")}return{username:void 0}}constructor(e,t){this.serverApiClient=e,this.configurationForExtensionStore=t}}G=(0,r.__decorate)([(0,R.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.l?Object:T.l,void 0===N?Object:N])],G);class k{async sendLogs(e){const t=await this.enclaveProxyClient.auditLogsMassDeployment.store(e);return(0,O.hx)(t)?(0,O.Rn)("massdeployment/storeActivityLogs failed with an unknown HTTP error"):t.data.invalidAuditLogs.length?(0,O.Vp)(this.serverToTechnicalSchemaErrorsMapper(t.data.invalidAuditLogs)):(0,O.Vp)(void 0)}async createLog({dateTime:e,domain:t,uuid:s,healthStatus:r}){try{const i=(await this.massDeploymentConfigurationForExtensionService.getUsernameFromBrowserPolicies()).username,a=await this.platformInfoService.getPlatformInfo();return{uuid:s,author_client:{platform:a.platformName,version:a.appVersion},category:U.p.RiskDetection,log_type:U.z.UserTypedPassword,date_time:e,schema_version:"1.0.0",properties:{domain_url:t,author_login:i,health_status:r}}}catch{return null}}serverToTechnicalSchemaErrorsMapper(e){return{invalidActivityLogs:e.map((e=>({uuid:e.uuid,error:F.W[e.error]})))}}constructor(e,t,s,r){this.serverApiClient=e,this.massDeploymentConfigurationForExtensionService=t,this.platformInfoService=s,this.enclaveProxyClient=r}}k=(0,r.__decorate)([(0,R.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.l?Object:T.l,void 0===G?Object:G,void 0===c.t?Object:c.t,void 0===P.X?Object:P.X])],k);var L=s(48844),M=s(18533),K=s(20195),j=s(23035);class V{generateMassDeploymentTeamKey(){return(0,A.z)(this.serverApiClient.v1.massdeployment.generateMassDeploymentTeamKey().pipe((0,L.DZ)((e=>(0,M.EQ)(e,{BusinessError:e=>this.getFunctionalError(e.code),FetchFailedError:K.j,BadStatus:K.j,InternalServerError:K.j,InvalidRequest:K.j,RateLimited:K.j,ServiceUnavailable:K.j,UnspecifiedBadStatus:K.j}))),(0,L.Qn)((e=>e.data))))}getFunctionalError(e){switch(e){case j.rI.TEAM_NOT_FOUND:return(0,j.o1)();case j.rI.VALID_MASS_DEPLOYMENT_TEAM_KEY_ALREADY_EXISTS_FOR_TEAM:return(0,j.$m)();default:throw new Error(`GenerateMassDeploymentTeamKey: error ${e}`)}}constructor(e){this.serverApiClient=e}}V=(0,r.__decorate)([(0,R.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.l?Object:T.l])],V);var z=s(46035);class W extends((0,m.Q)({persist:!1,scope:v.F.User,storeName:"mass-deployment-security-monitoring-configuration",initialValue:{active:!1,teamId:null,configuration:{}},storeTypeGuard:S,capacity:g.Y._001KB})){}class q{async refreshState(){const e=await this.getMassDeploymentSecurityMonitoringConfiguration();return(0,O.d6)(e)&&this.massDeploymentSecurityConfigurationStore.set({...e.data}),e}async updateLoggedOutMonitoringActiveStatus(e){const t=await(0,A.z)(this.serverApiClient.v1.massdeployment.updateMassDeploymentSecurityMonitoringConfiguration({active:e}));return(0,O.hx)(t)?(0,O.Rn)((0,z.x)()):(this.refreshState(),(0,O.Vp)(void 0))}async getMassDeploymentSecurityMonitoringConfiguration(){const e=await(0,A.z)(this.serverApiClient.v1.massdeployment.getMassDeploymentSecurityMonitoringConfiguration());return(0,O.hx)(e)?(0,O.Rn)((0,z.x)()):(0,O.Vp)(e.data.data)}constructor(e,t){this.serverApiClient=e,this.massDeploymentSecurityConfigurationStore=t}}q=(0,r.__decorate)([(0,R.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.l?Object:T.l,void 0===W?Object:W])],q);var B=s(162),$=s(69885),Y=s(18154),Q=s(51708),H=s(57571),J=s(91943),Z=s(91273),X=s(6969),ee=s(11615),te=s(42094),se=s(38027),re=s(17254),ie=s(26874),ae=s(25573),oe=s(80774);var ne=s(22067);const ce=e=>e.reduce(((e,t)=>({nWeak:e.nWeak+t.nWeak,nCompromised:e.nCompromised+t.nCompromised})),{nWeak:0,nCompromised:0}),de=(e,t)=>{const s=[];for(let e=0;e<t.length-1;e++)s.push({startDate:t[e],endDate:t[e+1]-1,logins:new Set,nWeak:0,nCompromised:0});const r=new Set;let i=0;return e.forEach((e=>{s.forEach(((t,r)=>{(0,ne.Z)(e.date_time,{start:t.startDate,end:t.endDate})&&(e.properties?.author_login&&s[r].logins.add(e.properties.author_login),(e=>e.log_type===U.z.UserTypedCompromisedPassword||e.log_type===U.z.UserTypedPassword&&"compromised"===e.properties?.health_status)(e)?s[r].nCompromised=s[r].nCompromised+1:(e=>e.log_type===U.z.UserTypedWeakPassword||e.log_type===U.z.UserTypedPassword&&"weak"===e.properties?.health_status)(e)&&(s[r].nWeak=s[r].nWeak+1))})),e.properties?.author_login&&r.add(e.properties.author_login),i=Math.max(i,e.date_time)})),{history:s.map((e=>({...e,nLogins:[...e.logins].length}))),nLogins:[...r].length,lastLogDateTime:i}},le={logTypes:[U.z.UserTypedCompromisedPassword,U.z.UserTypedWeakPassword,U.z.UserTypedPassword]};class ue{async getAllRiskDetectionLogsBetweenDates(e,t){try{await this.activityLogsApiClient.commands.initiateActivityLogsRetrieval({startDate:e,endDate:t,filters:le})}catch{return(0,B.D)((0,$.of)((0,O.Rn)((0,Q.y9)())))}return this.activityLogsApiClient.queries.activityLogs().pipe((0,L.lk)((e=>{if(e.status===H.Q.ERROR)return(0,O.Rn)((0,Q.LS)());if(e.hasMoreData)try{this.activityLogsApiClient.commands.loadNextActivityLogs({target:"all"})}catch{return(0,O.Rn)((0,Q.We)())}return(0,O.Vp)(e)})),(0,Y.n)((e=>(0,O.d6)(e)&&e.data.hasMoreData)),(0,L.lk)((e=>(0,O.Vp)(e.logs))))}async refreshRiskDetectionInsights(){const{startDate:e,endDate:t,intervals:s}=(()=>{const e=Date.now(),t={week:(0,Z.Z)({start:(0,X.Z)(e,{days:6}),end:(0,ee.Z)((0,te.Z)(e,1))}).map((e=>e.valueOf())),month:(0,se.Z)({start:(0,X.Z)(e,{weeks:4}),end:(0,re.Z)(e)},{weekStartsOn:1}).map((e=>e.valueOf())),year:(0,ie.Z)({start:(0,X.Z)(e,{months:11}),end:(0,ae.Z)((0,oe.Z)(e,1))}).map((e=>e.valueOf()))};return{startDate:t.year[0],endDate:e,intervals:t}})(),r=await this.riskDetectionInsightsStore.getState();if(0===r.lastUpdateTimestamp||r.lastUpdateTimestamp+3e5<Date.now()){const r=(await this.getAllRiskDetectionLogsBetweenDates(Math.ceil(e/1e3),Math.ceil(t/1e3))).pipe((0,L.lk)((e=>{const t={week:{insights:{nWeak:0,nCompromised:0,nLogins:0},history:[]},month:{insights:{nWeak:0,nCompromised:0,nLogins:0},history:[]},year:{insights:{nWeak:0,nCompromised:0,nLogins:0},history:[]},lastUpdateTimestamp:Date.now(),lastLogDateTime:0,hasLogsInLastYear:!!e.length};return["week","month","year"].forEach((r=>{const{history:i,nLogins:a,lastLogDateTime:o}=de(e.filter((e=>e.date_time>=s[r][0])),s[r]),n={...ce(i),nLogins:a};t[r]={insights:n,history:i},t.lastLogDateTime=Math.max(t.lastLogDateTime,o)})),this.riskDetectionInsightsStore.set(t),(0,O.Vp)(t)})));return(0,A.z)(r)}return(0,O.Vp)(r)}constructor(e,t){this.activityLogsApiClient=e,this.riskDetectionInsightsStore=t}}ue=(0,r.__decorate)([(0,R.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===J._?Object:J._,void 0===C?Object:C])],ue);var pe=s(93381),he=s(14122),me=s(82874);class ge{async execute(){const e=await this.massDeploymentTeamKeyService.generateMassDeploymentTeamKey();if((0,O.hx)(e))return e;const{massDeploymentTeamAccessKey:t,massDeploymentTeamSecretKey:s}=(0,O.db)(e);return await this.carbonLegacyClient.commands.persistMassDeploymentTeamKey({massDeploymentTeamAccessKey:t,massDeploymentTeamSecretKey:s}),(0,O.Vp)(void 0)}constructor(e,t){this.massDeploymentTeamKeyService=e,this.carbonLegacyClient=t}}ge=(0,r.__decorate)([(0,me.W)(j.tv),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===V?Object:V,void 0===he._?Object:he._])],ge);var ve=s(67426);class ye{async execute({body:e}){const t=await this.loggedOutMonitoringLogsService.createLog(e);return t&&this.loggedOutMonitoringLogsService.sendLogs([t]),(0,O.Vp)(void 0)}constructor(e){this.loggedOutMonitoringLogsService=e}}ye=(0,r.__decorate)([(0,me.W)(ve.r),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===k?Object:k])],ye);var _e=s(4087);class Se{async execute({body:{active:e}}){return this.massDeploymentSecurityMonitoringConfigurationService.updateLoggedOutMonitoringActiveStatus(e)}constructor(e){this.massDeploymentSecurityMonitoringConfigurationService=e}}Se=(0,r.__decorate)([(0,me.W)(_e.a),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===q?Object:q])],Se);var fe=s(79594),we=s(28953),Ie=s(75147),be=s(68567);const Ee=(e,t,s)=>{const r=t.reduce(((e,t)=>(e[t]=`${Ie.NB[t]};${Ie.m2[t]}`,e)),{});if("windows"===s){if(0===t.length)return;let s=`$username = $null\n# Wait for username to be populated\nwhile ($username -eq $null) {\n    $username = (Get-CimInstance Win32_Process -Filter 'name = "explorer.exe"' | Invoke-CimMethod -MethodName getowner).User\n    if ($username -is [array]) {\n        $username = $username[0]\n    }\n    $username = $username -replace ' ', '.'\n    Start-Sleep -Seconds 5 # Sleep for 5 seconds (optional)\n}\n\n$massDeploymentTeamKey = "${e}"\n`;for(const e of t){if(!(0,be.US)(e))return;s+=`# Set the registry path for ${e}\n$registry_path_${e} = "${Ie.Y[e]}"\n$parent_path_${e} = Split-Path -Path $registry_path_${e}\n\nif (!(Test-Path $parent_path_${e})) {\n    New-Item -Path $parent_path_${e} -Force -ItemType Directory | Out-Null\n}\n\nif (!(Test-Path $parent_path_${e}\\policy)) {\n    New-Item -Path ("$parent_path_${e}\\policy") -Force -ItemType Directory | Out-Null\n}\n\n# Set the MassDeployedTeamKey and Username in the registry for ${e}\n\nSet-ItemProperty -Path $registry_path_${e} -Name "MassDeployedTeamKey" -Value $massDeploymentTeamKey\nSet-ItemProperty -Path $registry_path_${e} -Name "Username" -Value $username\nSet-ItemProperty -Path $registry_path_${e} -Name "silent_deploy" -Value 1\n`}return s+="\nexit 0",{massDeploymentPoliciesScript:s,massDeploymentExtensionIDsAndUpdateURLs:r}}},Ce=(e,t,s)=>{if("macos"!==s)return;return{extensionPreferenceDomains:t.reduce(((e,t)=>(e[t]=Ie.Xd[t],e)),{}),extensionPoliciesValue:`<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n  <dict>\n    <key>Username</key>\n      <string>$USERNAME</string>\n    <key>MassDeployedTeamKey</key>\n      <string>${e}</string>\n    <key>silent_deploy</key>\n      <true/>\n  </dict>\n</plist>\n    `,browsersPreferenceDomains:t.reduce(((e,t)=>(e[t]=Ie.Zf[t],e)),{}),browsersForceInstallValues:t.reduce(((e,t)=>(e[t]=`<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n  <dict>\n    <key>ExtensionSettings</key>\n    <dict>\n      <key>${Ie.NB[t]}</key>\n      <dict>\n        <key>installation_mode</key>\n          <string>force_installed</string>\n        <key>update_url</key>\n          <string>${Ie.m2[t]}</string>\n      </dict>\n    </dict>\n  </dict>\n</plist>`,e)),{})}};function Ae(e,t,s,r){switch(t){case"microsoft-intune":return Ee(e,r,s);case"jamf":return Ce(e,r,s);default:return}}class Re{areMassDeploymentTeamKeysUndefined(e){const{massDeploymentTeamAccessKey:t,massDeploymentTeamSecretKey:s}=(0,O.db)(e);return!t||!s}async execute({body:e}){const t=await(0,A.z)(this.carbonLegacyClient.queries.getMassDeploymentTeamKey());if(!(0,O.d6)(t)||this.areMassDeploymentTeamKeysUndefined(t))throw new Error("Trying to generate a MassDeployment script without a MassDeploymentTeamKey",{cause:"MassDeploymentTeamKey is not available from the CarbonLegacyClient. Either the key for this team was never generated or it was not persisted correctly in the team admin data."});const{massDeploymentTeamAccessKey:s,massDeploymentTeamSecretKey:r}=(0,O.db)(t),i=`${s}-${r}`,{targetedMassDeploymentSoftware:a,targetedBrowsers:o}=e;if("microsoft-intune"!==a)throw new Error("Trying to generate a MassDeployment script for an unsupported mass-deployment software",{cause:"The configuration provided by the admin is not supported for Mass Deployment. This is likely a bug in the UI that should have prevented this configuration from being selected."});const n=Ee(i,o,"windows");if(!n)throw new Error("Something went wrong while generating the Mass Deployment script for Intune",{cause:"The targeted browsers might not be correct. This is likely a bug in the UI that should have prevented this configuration from being selected."});const c=(new TextEncoder).encode(n.massDeploymentPoliciesScript).buffer;return this.fileDownloaderService.downloadFile("Dashlane-Risk-Detection-Policies-Script.ps1","text/plain",c),(0,O.Vp)(void 0)}constructor(e,t){this.carbonLegacyClient=e,this.fileDownloaderService=t}}Re=(0,r.__decorate)([(0,me.W)(we.U),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===he._?Object:he._,void 0===fe._?Object:fe._])],Re);var Te=s(87065),Oe=s(46449),De=s(87954),Ue=s(85465);class Fe{execute({body:{password:e}}){const t=(e=>(0,Ue.evaluate)(e).score/25<3)(e);return(0,B.D)(this.checkPasswordCompromisedService.check(e)).pipe((0,Te.U)((e=>(0,O.Vp)({isWeak:t,isCompromised:e}))))}constructor(e){this.checkPasswordCompromisedService=e}}Fe=(0,r.__decorate)([(0,Oe.e)(De.S),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===D?Object:D])],Fe);var Pe=s(6136),xe=s(19958);class Ne{execute(){return(0,B.D)(this.loggedOutMonitoringLogsService.refreshRiskDetectionInsights()).pipe((0,Y.n)((e=>(0,O.d6)(e)&&0===e.data.lastUpdateTimestamp)),(0,Pe.x)(((e,t)=>(0,O.d6)(e)&&(0,O.d6)(t)&&e.data.lastLogDateTime===t.data.lastLogDateTime)),(0,L.lk)((e=>(0,O.Vp)({lastLogDate:e.lastLogDateTime}))))}constructor(e){this.loggedOutMonitoringLogsService=e}}Ne=(0,r.__decorate)([(0,Oe.e)(xe.k),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ue?Object:ue])],Ne);var Ge=s(57325);class ke{execute(){return this.massDeploymentSecurityMonitoringConfigurationStore.state$.pipe((0,Te.U)((e=>(e.teamId||this.massDeploymentSecurityMonitoringConfigurationService.refreshState(),e))),(0,Y.n)((e=>!e.teamId)),(0,Te.U)(O.Vp))}constructor(e,t){this.massDeploymentSecurityMonitoringConfigurationService=e,this.massDeploymentSecurityMonitoringConfigurationStore=t}}ke=(0,r.__decorate)([(0,Oe.e)(Ge.g),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===q?Object:q,void 0===W?Object:W])],ke);var Le=s(65682);class Me{execute({body:e}){const t=this.carbonLegacyClient.queries.liveMassDeploymentTeamKey(void 0).pipe((0,Te.U)((e=>{if((0,O.d6)(e)){const{massDeploymentTeamAccessKey:t,massDeploymentTeamSecretKey:s}=(0,O.db)(e);if(t&&s)return`${t}-${s}`}})),(0,Pe.x)());return e?t.pipe((0,Te.U)((t=>t?(0,O.Vp)({massDeploymentTeamKey:t,massDeploymentSetupInformation:Ae(t,e.targetedMassDeploymentSoftware,e.targetedOS,e.targetedBrowsers)}):(0,O.Vp)({massDeploymentTeamKey:void 0,massDeploymentSetupInformation:void 0})))):t.pipe((0,Te.U)((e=>(0,O.Vp)({massDeploymentTeamKey:e,massDeploymentSetupInformation:void 0}))))}constructor(e){this.carbonLegacyClient=e}}Me=(0,r.__decorate)([(0,Oe.e)(Le.a),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===he._?Object:he._])],Me);var Ke=s(76736);class je{execute({body:{timeScale:e="week"}}){return(0,B.D)(this.loggedOutMonitoringLogsService.refreshRiskDetectionInsights()).pipe((0,Y.n)((e=>(0,O.d6)(e)&&0===e.data.lastUpdateTimestamp)),(0,Pe.x)(((t,s)=>(0,O.d6)(t)&&(0,O.d6)(s)&&t.data[e].insights.nCompromised===s.data[e].insights.nCompromised&&t.data[e].insights.nLogins===s.data[e].insights.nLogins&&t.data[e].insights.nWeak===s.data[e].insights.nWeak&&t.data[e].history[0].startDate===s.data[e].history[0].startDate)),(0,L.lk)((t=>(0,O.Vp)({insights:t[e].insights,riskDetectionHistory:t[e].history,hasLogsInLastYear:t.hasLogsInLastYear}))))}constructor(e){this.loggedOutMonitoringLogsService=e}}je=(0,r.__decorate)([(0,Oe.e)(Ke.p),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ue?Object:ue])],je);var Ve=s(18221);class ze{execute(){return(0,B.D)(this.configurationForExtensionService.refreshStateIfOutdated()).pipe((0,Y.n)((e=>(0,O.d6)(e)&&0===e.data.lastUpdateTimestamp)),(0,Te.U)((e=>(0,O.d6)(e)?(0,O.Vp)({isEnabled:!!e.data.active}):(0,O.Vp)({isEnabled:!1}))))}constructor(e){this.configurationForExtensionService=e}}ze=(0,r.__decorate)([(0,Oe.e)(Ve.m),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===G?Object:G])],ze);class We{}We=(0,r.__decorate)([(0,i.Yl)({api:d.i,imports:[pe.Z,o.D,a.l,u.f,n.n,h.y],providers:[D,k,V,q,G,p.T,c.t,ue],stores:[W,N,C],handlers:{commands:{generateMassDeploymentTeamKey:ge,sendRiskyPasswordLoggedOutLog:ye,updateLoggedOutMonitoringActiveStatus:Se,generateAndDownloadMassDeploymentScript:Re},events:{},queries:{analysePasswordForRisks:Fe,getLastLogDate:Ne,getMassDeploymentSecurityMonitoringConfiguration:ke,getMassDeploymentSetupInformation:Me,getRiskDetectionInsights:je,isLoggedOutMonitoringEnabledForDevice:ze}},requiredFeatureFlips:Object.values(l.q)})],We)},15090:(e,t,s)=>{s.d(t,{g:()=>F});var r=s(491),i=s(86006),a=s(19961),o=s(55102),n=s(73820),c=s(43991),d=s(62149),l=s(63144),u=s(56618);const p={token:null,instanceURL:null,active:!1,siemType:null,isSelfSignedCertificateAllowed:!1};class h extends((0,l.Q)({initialValue:!1,persist:!1,scope:d.F.User,storeName:"siem-config",capacity:u.Y._001KB})){}var m=s(92587),g=s(87279),v=s(76500),y=s(25917),_=s(42668),S=s(24170),f=s(7165);const w=f.z.object({token:f.z.string().nullable(),instanceURL:f.z.string().nullable(),active:f.z.boolean(),siemType:f.z.enum(["splunk"]).nullable(),isSelfSignedCertificateAllowed:f.z.boolean()});var I=s(60399);class b{async getSiemConfiguration(){try{const{teamUuid:e,adminProvisioningKey:t}=await this.getTeamInfo(),s=await this.enclaveApiClient.siem.getSiemConfiguration({teamUuid:e,adminProvisioningKey:t});return(0,g.hx)(s)?Promise.reject((0,_.Nv)()):w.parse((0,g.db)(s))}catch(e){return Promise.reject((0,_.Nv)())}}async setSiemConfiguration(e){try{const{teamUuid:t,adminProvisioningKey:s}=await this.getTeamInfo(),r=await this.enclaveApiClient.siem.setSiemConfiguration({teamUuid:t,adminProvisioningKey:s,token:e.token??void 0,active:e.active,instanceURL:e.instanceURL??void 0,siemType:e.siemType,isSelfSignedCertificateAllowed:e.isSelfSignedCertificateAllowed??void 0});return(0,g.hx)(r)?Promise.reject((0,_.Nv)()):w.parse((0,g.db)(r))}catch(e){switch(e.message){case S.M7.INVALID_URL:return Promise.reject((0,S.q0)());case S.M7.MISMATCHING_ADMIN_PROVISIONING_KEY:return Promise.reject((0,S.HC)());case S.M7.NO_SIEM_CONFIGURATION_UPDATE:return Promise.reject((0,S.$3)());case S.M7.TEAM_NOT_FOUND:return Promise.reject((0,S.gY)());default:return Promise.reject((0,S.SC)())}}}async getTeamInfo(){const e=await(0,I.z)(this.teamEnclaveClient.queries.getTeamIdentifiers());if((0,g.hx)(e))throw new Error("TeamInfoNotFound");const{teamUuid:t,adminProvisioningKey:s}=(0,g.db)(e);if(!s)throw new Error("TeamInfoNotFound");return{teamUuid:t,adminProvisioningKey:s}}constructor(e,t){this.enclaveApiClient=e,this.teamEnclaveClient=t}}b=(0,r.__decorate)([(0,m.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===v.l?Object:v.l,void 0===y.G?Object:y.G])],b);var E=s(46449),C=s(43978);class A{execute(){return this.siemStore.state$.pipe((0,C.w)((async e=>{if(!e)try{const e=await this.siemService.getSiemConfiguration();return await this.siemStore.set(e),(0,g.Vp)(e)}catch(e){return(0,g.Vp)(p)}return(0,g.Vp)(e)})))}constructor(e,t){this.siemStore=e,this.siemService=t}}A=(0,r.__decorate)([(0,E.e)(_.pr),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===h?Object:h,void 0===b?Object:b])],A);var R=s(82874);class T{async execute({body:e}){const{token:t,instanceURL:s,active:r,isSelfSignedCertificateAllowed:i}=e;try{const e=await this.siemService.setSiemConfiguration({active:r,instanceURL:s,token:t,siemType:"splunk",isSelfSignedCertificateAllowed:i});return this.siemConfigStore.set(e),(0,g.Vp)(void 0)}catch(e){return(0,g.Rn)(e)}}constructor(e,t){this.siemConfigStore=e,this.siemService=t}}T=(0,r.__decorate)([(0,R.W)(S.Qj),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===h?Object:h,void 0===b?Object:b])],T);var O=s(85798),D=s(27326);class U{async handle(){await this.siemConfigStore.clear()}constructor(e){this.siemConfigStore=e}}U=(0,r.__decorate)([(0,O.b)(D.z),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===h?Object:h])],U);class F{}F=(0,r.__decorate)([(0,i.Yl)({api:o.v,stores:[h],providers:[b],imports:[n.Z,a.G],handlers:{commands:{setSiemConfiguration:T},events:{...(0,i.g4)(c.y,{confidentialSsoSettingsReset:U})},queries:{getSiemConfiguration:A}},requiredFeatureFlips:["setup_rollout_splunk_integration_prod","setup_rollout_siem_self_signed_certificate"]})],F)},13252:(e,t,s)=>{s.d(t,{IP:()=>u,Iy:()=>n,Uv:()=>d,bd:()=>c,dg:()=>p,i:()=>h,qb:()=>i,y$:()=>o,y2:()=>l,y3:()=>r});var r,i,a=s(7165);!function(e){e.Admin="admin",e.Limited="limited"}(r||(r={})),function(e){e.Pending="pending",e.Accepted="accepted",e.Refused="refused",e.Revoked="revoked"}(i||(i={}));const o=a.z.nativeEnum(i),n=a.z.nativeEnum(r),c=a.z.union([a.z.literal("noKey"),a.z.literal("publicKey"),a.z.literal("sharingKeys")]);var d,l,u;!function(e){e.User="user",e.UserGroup="group",e.CollectionUser="collectionUser",e.CollectionUserGroup="collectionUserGroup"}(d||(d={})),function(e){e.Secret="secret",e.Credential="password",e.SecureNote="note"}(l||(l={})),function(e){e.Group="group",e.Collection="collection",e.User="user"}(u||(u={}));const p=a.z.nativeEnum(d),h=a.z.nativeEnum(u)},9661:(e,t,s)=>{s.r(t),s.d(t,{ATTACHMENT_IN_COLLECTION:()=>re.Pf,AcceptCollectionInviteCommand:()=>N.cD,AcceptCollectionInviteFailedError:()=>N.nu,AcceptCollectionInviteResultErrorCode:()=>N.Ti,AcceptSharedItemInviteCommand:()=>G.C,AcceptUserGroupInviteCommand:()=>k.Q,AddItemsToCollectionsCommand:()=>se.k,CollectionUserAccessSchema:()=>F.v,CollectionUserGroupAccessSchema:()=>F.r8,CreateSharedCollectionCommand:()=>re.I4,DeleteSharedCollectionCommand:()=>ie.U,DirectAccessSchema:()=>F.eA,GetAllAcceptedGroupsQuery:()=>ve.J,GetCollectionPermissionsForUserQuery:()=>Q.y,GetCollectionRoleForGroupQuery:()=>H.L,GetCollectionsForUserOrGroupQuery:()=>J.Q,GetInvitesQuery:()=>V.q,GetIsLastAdminForItemQuery:()=>m.X,GetItemGroupIdForItemIdQuery:()=>l,GetItemIdsInSharedCollectionsQuery:()=>Y.q,GetItemIdsInSharedCollectionsSchema:()=>he.Po,GetPendingCollectionsQuery:()=>z.D,GetPermissionForItemQuery:()=>p.C,GetPermissionForItemsQuery:()=>h.R,GetSharedAccessForItemIdsQuery:()=>b.D,GetSharedAccessQuery:()=>I.w,GetSharedCollectionsCountQuery:()=>X.C,GetSharedCollectionsQuery:()=>Z.$,GetSharedItemForIdQuery:()=>f.L,GetSharedItemsForItemIdsQuery:()=>n.z,GetSharedItemsQuery:()=>w.w,GetSharingGroupByIdQuery:()=>ye.e,GetSharingGroupsQuery:()=>_e.f,GetSharingStatusForItemQuery:()=>u.S,GetSharingTeamLoginsQuery:()=>a.G,GetSharingUsersQuery:()=>Se.K,GetTeamAdminSharingDataQuery:()=>be.k,GetUserSharedVaultItemsQuery:()=>v.v,HasInvitesQuery:()=>W._,InviteCollectionMembersCommand:()=>ae.Q,IsSharingAllowedQuery:()=>_.B,MoveCollectionItemsToBusinessSpaceCommand:()=>pe.g,PendingCollectionSchema:()=>q.of,PendingInviteSchema:()=>q.ju,PendingItemGroupSchema:()=>q.vH,PendingSharedItemInviteSchema:()=>q.jd,PendingUserGroupSchema:()=>q._P,Permission:()=>r.y3,PermissionSchema:()=>r.Iy,RecipientTypeSchema:()=>r.i,RecipientTypes:()=>r.IP,RefuseCollectionInviteCommand:()=>L.UC,RefuseCollectionInviteFailedError:()=>L.R$,RefuseCollectionInviteResultErrorCode:()=>L.eT,RefuseItemGroupInviteAuthorHasInvalidStatusError:()=>M.bp,RefuseItemGroupInviteCommand:()=>M.gm,RefuseItemGroupInviteGroupHasInvalidStatusError:()=>M.Xj,RefuseItemGroupInviteInvalidItemGroupRevisionError:()=>M.Ne,RefuseItemGroupInviteNotEnoughAdminsError:()=>M.Ix,RefuseItemGroupInviteNotFoundError:()=>M.fL,RefuseItemGroupInviteResultErrorCode:()=>M.dI,RefuseItemGroupInviteUserGroupIsNotInItemGroupError:()=>M.Te,RefuseItemGroupInviteUserIsNotInItemGroupError:()=>M.hp,RefuseItemGroupInviteUserIsNotInPendingStatusError:()=>M.gR,RefuseSharedItemBeforeDeletionCommand:()=>C.OL,RefuseSharedItemBeforeDeletionCommandErrors:()=>C.m$,RefuseSharedItemCommand:()=>E.l,RefuseUserGroupInviteAuthorHasInvalidStatusError:()=>K.K8,RefuseUserGroupInviteCommand:()=>K.Fo,RefuseUserGroupInviteGroupHasInvalidStatusError:()=>K.kh,RefuseUserGroupInviteInsufficientPrivilegesError:()=>K.FO,RefuseUserGroupInviteInvalidItemGroupRevisionError:()=>K.Uf,RefuseUserGroupInviteInvalidTeamIdError:()=>K.Ix,RefuseUserGroupInviteNotFoundError:()=>K.i6,RefuseUserGroupInviteResultErrorCode:()=>K.xC,RefuseUserGroupInviteUserGroupIsNotFoundError:()=>K.U1,RefuseUserGroupInviteUserGroupUpdateConflictError:()=>K.Xp,RefuseUserGroupInviteUserIsNotInPendingStatusError:()=>K.PZ,RefuseUserGroupInviteUserIsNotInUserGroupError:()=>K.xz,RemoteControlSharedItemsCommand:()=>A.v,RemoveItemFromCollectionsCommand:()=>ne.B,RenameCollectionCommand:()=>oe.r,RevokeCollectionMembersCommand:()=>ce.q,RevokeSharedItemCommand:()=>T.V,RsaStatusSchema:()=>r.bd,RunSharingSyncCommand:()=>Ie.N,ShareItemFailureReason:()=>S.z,ShareItemsCommand:()=>R.S2,ShareItemsErrorType:()=>R.Mb,ShareItemsErrorsQuery:()=>S.f,ShareableCollectionSchema:()=>ee.JQ,ShareableCollectionVaultItemSchema:()=>ee.FN,ShareableItemType:()=>r.y2,SharedAccessEntrySchema:()=>F.wQ,SharedAccessForItemQuery:()=>g.v,SharedAccessSchema:()=>F.Im,SharedCollectionAccessSchema:()=>he.Ng,SharedCollectionRole:()=>he.Yt,SharedCollectionSchema:()=>he.MX,SharedCollectionUserGroupSchema:()=>he.yD,SharedCollectionUserOrGroupViewSchema:()=>he.fg,SharedCollectionUserSchema:()=>he.Me,SharedCollectionsWithItemsQuery:()=>ee.MO,SharedItemAccessLinkTypes:()=>r.Uv,SharedItemAccessLinkTypesSchema:()=>r.dg,SharedItemDecryptionLinkSchema:()=>F.I2,SharedItemRecipientIdsSchema:()=>F.QT,SharedItemSchema:()=>F.m$,SharedItemsIdsQuery:()=>y.c,SharedVaultItemType:()=>F.nC,SharingCollectionsClient:()=>me.L,SharingDisabledReason:()=>he.Hz,SharingEnabledQuery:()=>o.N,SharingInvitesClient:()=>B.h,SharingItemsClient:()=>U.s,SharingItemsFeatureFlips:()=>P.o,SharingSyncFeatureFlips:()=>Ee.d,SharingUserSchema:()=>fe.g,SortDirection:()=>fe.S,Status:()=>r.qb,StatusSchema:()=>r.y$,TeamAdminSharingDataSchema:()=>be.m,UpdateCollectionMembersCommand:()=>le.c,UpdatePendingCollectionsCommand:()=>j.r,UpdatePermissionForCollectionItemCommand:()=>ue.a,UpdateSharedCollectionsCommand:()=>de.M,UpdateSharedItemContentCommand:()=>D.l,UpdateSharedItemPermissionCommand:()=>O.W,UserGroupAccessSchema:()=>F.Ho,UsersAndGroupsInCollectionQuery:()=>te.O,UsersAndGroupsInCollectionSchema:()=>he.a7,createAttachmentInCollectionError:()=>re.LG,createForbiddenGroupItemError:()=>C.Vf,createForbiddenLastAdminError:()=>C.V$,createLimitExceededError:()=>R.Kb,createPartialSuccessError:()=>R.$u,getRefuseItemGroupInviteFunctionalError:()=>M.fr,getRefuseUserGroupInviteFunctionalError:()=>K.cz,isSharedVaultItemType:()=>F.RP,sharingCollectionsApi:()=>$.a,sharingInvitesApi:()=>x.t,sharingItemsApi:()=>i.X,sharingRecipientsApi:()=>ge.A,sharingSyncApi:()=>we.k});var r=s(13252),i=s(61582),a=s(38638),o=s(36155),n=s(95803),c=s(77535),d=s(62149);class l extends((0,c.k)({scope:d.F.User})){}var u=s(95038),p=s(46234),h=s(62176),m=s(11108),g=s(47670),v=s(39672),y=s(52715),_=s(54933),S=s(32725),f=s(90878),w=s(80160),I=s(89623),b=s(38661),E=s(24701),C=s(40102),A=s(43656),R=s(33472),T=s(98721),O=s(2741),D=s(95196),U=s(35594),F=s(88981),P=s(23122),x=s(95940),N=s(64549),G=s(83405),k=s(27122),L=s(37210),M=s(51571),K=s(11050),j=s(97675),V=s(57885),z=s(5650),W=s(71763),q=s(18091),B=s(64978),$=s(62048),Y=s(7134),Q=s(13312),H=s(41869),J=s(10829),Z=s(34282),X=s(14947),ee=s(13575),te=s(54665),se=s(51607),re=s(53384),ie=s(21998),ae=s(22210),oe=s(46733),ne=s(94020),ce=s(88621),de=s(76001),le=s(31105),ue=s(63792),pe=s(91132),he=s(11797),me=s(20980),ge=s(87581),ve=s(31839),ye=s(48782),_e=s(70633),Se=s(53529),fe=s(35863),we=s(29390),Ie=s(76763),be=s(15292),Ee=s(6489)},62048:(e,t,s)=>{s.d(t,{a:()=>b});var r=s(75958),i=s(51607),a=s(53384),o=s(21998),n=s(22210),c=s(31105),d=s(94020),l=s(46733),u=s(88621),p=s(76001),h=s(63792),m=s(91132),g=s(10829),v=s(7134),y=s(34282),_=s(13312),S=s(41869),f=s(14947),w=s(13575),I=s(54665);const b=(0,r.Q)({name:"sharingCollections",commands:{addItemsToCollections:i.k,createSharedCollection:a.I4,deleteSharedCollection:o.U,inviteCollectionMembers:n.Q,updateCollectionMembers:c.c,removeItemFromCollections:d.B,renameCollection:l.r,revokeCollectionMembers:u.q,updateSharedCollections:p.M,updatePermissionForCollectionItem:h.a,moveCollectionItemsToBusinessSpace:m.g},events:{},queries:{getCollectionsForUserOrGroup:g.Q,getItemIdsInSharedCollections:v.q,getSharedCollections:y.$,getCollectionPermissionsForUser:_.y,getCollectionRoleForGroup:S.L,getSharedCollectionsCount:f.C,sharedCollectionsWithItems:w.MO,usersAndGroupsInCollection:I.O}})},51607:(e,t,s)=>{s.d(t,{k:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},53384:(e,t,s)=>{s.d(t,{I4:()=>c,LG:()=>n,Pf:()=>o});var r=s(13385),i=s(62149),a=s(96168);const o="ATTACHMENT_IN_COLLECTION",n=(0,a.Vj)(o,"Unable to share collections containing secure notes with attachments.");class c extends((0,r.g)({scope:i.F.User})){}},21998:(e,t,s)=>{s.d(t,{U:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},22210:(e,t,s)=>{s.d(t,{Q:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},91132:(e,t,s)=>{s.d(t,{g:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},94020:(e,t,s)=>{s.d(t,{B:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},46733:(e,t,s)=>{s.d(t,{r:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},88621:(e,t,s)=>{s.d(t,{q:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},31105:(e,t,s)=>{s.d(t,{c:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},63792:(e,t,s)=>{s.d(t,{a:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},76001:(e,t,s)=>{s.d(t,{M:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},7134:(e,t,s)=>{s.d(t,{q:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},41869:(e,t,s)=>{s.d(t,{L:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},13312:(e,t,s)=>{s.d(t,{y:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},10829:(e,t,s)=>{s.d(t,{Q:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},14947:(e,t,s)=>{s.d(t,{C:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},34282:(e,t,s)=>{s.d(t,{$:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},13575:(e,t,s)=>{s.d(t,{FN:()=>o,JQ:()=>n,MO:()=>c});var r=s(7165),i=s(77535),a=s(62149);const o=r.z.object({id:r.z.string(),type:r.z.string(),url:r.z.optional(r.z.string())}),n=r.z.object({id:r.z.string(),name:r.z.string(),spaceId:r.z.string(),vaultItems:r.z.array(o),isShared:r.z.optional(r.z.boolean())});class c extends((0,i.k)({scope:a.F.User})){}},54665:(e,t,s)=>{s.d(t,{O:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},20980:(e,t,s)=>{s.d(t,{L:()=>a});var r=s(8260),i=s(62048);class a extends((0,r.E)(i.a)){}(0,r.K)(i.a,a)},11797:(e,t,s)=>{s.d(t,{Hz:()=>m,MX:()=>d,Me:()=>o,Ng:()=>p,Po:()=>u,Yt:()=>h,a7:()=>l,fg:()=>c,yD:()=>n});var r=s(7165),i=s(13252),a=s(88981);const o=r.z.object({acceptSignature:r.z.optional(r.z.nullable(r.z.string())),collectionKey:r.z.optional(r.z.nullable(r.z.string())),login:r.z.string(),permission:i.Iy,proposeSignature:r.z.optional(r.z.string()),proposeSignatureUsingAlias:r.z.optional(r.z.boolean()),referrer:r.z.string(),rsaStatus:r.z.optional(i.bd),status:i.y$}),n=r.z.object({acceptSignature:r.z.optional(r.z.nullable(r.z.string())),collectionKey:r.z.optional(r.z.nullable(r.z.string())),name:r.z.string(),permission:i.Iy,proposeSignature:r.z.optional(r.z.string()),referrer:r.z.optional(r.z.string()),status:i.y$,uuid:r.z.string()}),c=r.z.object({label:r.z.string(),status:i.y$,permission:i.Iy,id:r.z.string()}),d=r.z.object({name:r.z.string(),privateKey:r.z.string(),publicKey:r.z.string(),revision:r.z.number(),userGroups:r.z.optional(r.z.array(n)),users:r.z.optional(r.z.array(o)),uuid:r.z.string(),authorLogin:r.z.optional(r.z.string())}),l=r.z.object({userGroups:r.z.optional(r.z.array(c)),users:r.z.optional(r.z.array(c))}),u=r.z.array(r.z.string()),p=r.z.object({users:r.z.array(a.wQ),userGroups:r.z.array(a.wQ)});var h,m;!function(e){e.Editor="editor",e.Manager="manager"}(h||(h={})),function(e){e.DisabledInTAC="disabledInTac",e.EditorRole="editorRole",e.LimitedRightItems="limitedRightItems"}(m||(m={}))},95940:(e,t,s)=>{s.d(t,{t:()=>m});var r=s(75958),i=s(27122),a=s(83405),o=s(64549),n=s(37210),c=s(51571),d=s(11050),l=s(97675),u=s(57885),p=s(5650),h=s(71763);const m=(0,r.Q)({name:"sharingInvites",commands:{AcceptUserGroupInviteCommand:i.Q,AcceptSharedItemInviteCommand:a.C,AcceptCollectionInviteCommand:o.cD,RefuseCollectionInviteCommand:n.UC,RefuseItemGroupInviteCommand:c.gm,RefuseUserGroupInviteCommand:d.Fo,UpdatePendingCollectionsCommand:l.r},events:{},queries:{GetInvitesQuery:u.q,GetPendingCollectionsQuery:p.D,HasInvitesQuery:h._}})},64549:(e,t,s)=>{s.d(t,{Ti:()=>r,cD:()=>c,nu:()=>n});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.AcceptFailed="AcceptFailed"}(r||(r={}));class n extends((0,o.Hu)("AcceptFailed","Failed to accept collection")){}class c extends((0,i.g)({scope:a.F.User})){}},83405:(e,t,s)=>{s.d(t,{C:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},27122:(e,t,s)=>{s.d(t,{Q:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},37210:(e,t,s)=>{s.d(t,{R$:()=>n,UC:()=>c,eT:()=>r});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.RefuseFailed="RefuseFailed"}(r||(r={}));class n extends((0,o.Hu)("RefuseFailed","Failed to refuse collection")){}class c extends((0,i.g)({scope:a.F.User})){}},51571:(e,t,s)=>{s.d(t,{Ix:()=>h,Ne:()=>p,Te:()=>u,Xj:()=>d,bp:()=>c,dI:()=>r,fL:()=>n,fr:()=>g,gR:()=>m,gm:()=>v,hp:()=>l});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.ItemGroupNotFound="ItemGroupNotFound",e.AuthorHasInvalidStatus="AuthorHasInvalidStatus",e.GroupHasInvalidStatus="GroupHasInvalidStatus",e.UserIsNotInItemGroup="UserIsNotInItemGroup",e.UserGroupIsNotInItemGroup="UserGroupIsNotInItemGroup",e.InvalidItemGroupRevision="InvalidItemGroupRevision",e.NotEnoughAdmins="NotEnoughAdmins",e.UserIsNotInPendingStatus="UserIsNotInPendingStatus"}(r||(r={}));class n extends((0,o.Hu)("ItemGroupNotFound","Item Group not found")){}class c extends((0,o.Hu)("AuthorHasInvalidStatus","User is not in accepted/pending status (already refused or revoked)")){}class d extends((0,o.Hu)("GroupHasInvalidStatus","UserGroup is not in accepted/pending status (already refused or revoked)")){}class l extends((0,o.Hu)("UserIsNotInItemGroup","User is not part of item group")){}class u extends((0,o.Hu)("UserGroupIsNotInItemGroup","User group is not part of item group")){}class p extends((0,o.Hu)("InvalidItemGroupRevision","Item group revision is not valid")){}class h extends((0,o.Hu)("NotEnoughAdmins","The operation would let the item group with no admin")){}class m extends((0,o.Hu)("UserIsNotInPendingStatus",'User is not in "pending" status or not part of a group')){}function g(e){switch(e){case"AUTHOR_HAS_INVALID_STATUS":return new c;case"GROUP_HAS_INVALID_STATUS":return new d;case"USER_IS_NOT_IN_ITEM_GROUP":return new l;case"USER_GROUP_IS_NOT_IN_ITEM_GROUP":return new u;case"INVALID_ITEM_GROUP_REVISION":return new p;case"NOT_ENOUGH_ADMINS":return new h;case"USER_IS_NOT_IN_PENDING_STATUS":return new m;default:throw new Error("Unknown server error")}}class v extends((0,i.g)({scope:a.F.User})){}},11050:(e,t,s)=>{s.d(t,{FO:()=>p,Fo:()=>_,Ix:()=>c,K8:()=>v,PZ:()=>m,U1:()=>d,Uf:()=>l,Xp:()=>u,cz:()=>y,i6:()=>n,kh:()=>g,xC:()=>r,xz:()=>h});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.UserGroupNotFound="UserGroupNotFound",e.InvalidTeamId="InvalidTeamId",e.UserGroupIsNotFound="UserGroupIsNotFound",e.InvalidItemGroupRevision="InvalidItemGroupRevision",e.UserGroupUpdateConflict="UserGroupUpdateConflict",e.InsufficientPrivileges="InsufficientPrivileges",e.UserIsNotInUserGroup="UserIsNotInUserGroup",e.UserIsNotInPendingStatus="UserIsNotInPendingStatus",e.GroupHasInvalidStatus="GroupHasInvalidStatus",e.AuthorHasInvalidStatus="AuthorHasInvalidStatus"}(r||(r={}));class n extends((0,o.Hu)("UserGroupNotFound","User Group not found")){}class c extends((0,o.Hu)("InvalidTeamId","Provided Team ID is not a number")){}class d extends((0,o.Hu)("UserGroupIsNotFound","User group for provided ID does not exist")){}class l extends((0,o.Hu)("InvalidItemGroupRevision","User group revision is not valid")){}class u extends((0,o.Hu)("UserGroupUpdateConflict","Conflict between users attempting to update the same user group")){}class p extends((0,o.Hu)("InsufficientPrivileges","The user does not have User Group permission to refuse the invitation")){}class h extends((0,o.Hu)("UserIsNotInUserGroup","User is not part of a group")){}class m extends((0,o.Hu)("UserIsNotInPendingStatus",'User is not in "pending" status or not part of a group')){}class g extends((0,o.Hu)("GroupHasInvalidStatus",'UserGroup is not in "accepted" or "pending" status (already refused or revoked)')){}class v extends((0,o.Hu)("AuthorHasInvalidStatus","User is not in accepted/pending status (already refused or revoked)")){}function y(e){switch(e){case"INVALID_TEAM_ID":return new c;case"USER_GROUP_IS_NOT_FOUND":return new d;case"INVALID_USER_GROUP_REVISION":return new l;case"USER_GROUP_UPDATE_CONFLICT":return new u;case"INSUFFICIENT_PRIVILEGES":return new p;case"USER_IS_NOT_IN_USER_GROUP":return new h;case"USER_IS_NOT_IN_PENDING_STATUS":return new m;case"GROUP_HAS_INVALID_STATUS":return new g;case"AUTHOR_HAS_INVALID_STATUS":return new v;default:throw new Error("Unknown server error")}}class _ extends((0,i.g)({scope:a.F.User})){}},97675:(e,t,s)=>{s.d(t,{r:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},57885:(e,t,s)=>{s.d(t,{q:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},5650:(e,t,s)=>{s.d(t,{D:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},71763:(e,t,s)=>{s.d(t,{_:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},64978:(e,t,s)=>{s.d(t,{h:()=>a});var r=s(8260),i=s(95940);class a extends((0,r.E)(i.t)){}(0,r.K)(i.t,a)},18091:(e,t,s)=>{s.d(t,{_P:()=>n,jd:()=>m,ju:()=>d,of:()=>a,vH:()=>o});var r=s(7165),i=s(13252);const a=r.z.object({uuid:r.z.string(),name:r.z.string(),referrer:r.z.string(),permission:r.z.nativeEnum(i.y3)}),o=r.z.object({itemGroupId:r.z.string(),referrer:r.z.string(),permission:r.z.enum(["admin","limited"]),items:r.z.array(r.z.any())}),n=r.z.object({groupId:r.z.string(),name:r.z.string(),referrer:r.z.string(),permission:r.z.enum(["admin","limited"])}),c=r.z.object({referrer:r.z.string(),permission:i.Iy}),d=c.extend({id:r.z.string(),name:r.z.string()}),l=c.extend({vaultItemId:r.z.string(),sharedItemId:r.z.string(),revision:r.z.number(),title:r.z.string(),spaceId:r.z.optional(r.z.string())}),u=l.extend({itemType:r.z.literal(i.y2.Credential),url:r.z.optional(r.z.string()),login:r.z.optional(r.z.string()),secondaryLogin:r.z.optional(r.z.string()),email:r.z.optional(r.z.string()),linkedDomains:r.z.optional(r.z.array(r.z.string()))}),p=l.extend({itemType:r.z.literal(i.y2.SecureNote),color:r.z.optional(r.z.string()),secured:r.z.boolean()}),h=l.extend({itemType:r.z.literal(i.y2.Secret),secured:r.z.boolean()}),m=r.z.union([u,p,h])},61582:(e,t,s)=>{s.d(t,{X:()=>R});var r=s(75958),i=s(2741),a=s(95196),o=s(98721),n=s(24701),c=s(40102),d=s(43656),l=s(33472),u=s(89623),p=s(38661),h=s(80160),m=s(90878),g=s(54933),v=s(38638),y=s(36155),_=s(95803),S=s(95038),f=s(46234),w=s(62176),I=s(11108),b=s(47670),E=s(39672),C=s(52715),A=s(32725);const R=(0,r.Q)({name:"sharingItems",commands:{updateSharedItemPermission:i.W,updateSharedItemContent:a.l,revokeSharedItem:o.V,refuseSharedItem:n.l,refuseSharedItemBeforeDeletion:c.OL,remoteControlSharedItems:d.v,shareItems:l.S2},events:{},queries:{getSharedAccess:u.w,getSharedAccessForItemIds:p.D,getSharedItems:h.w,getSharedItemForId:m.L,isSharingAllowed:g.B,getSharingTeamLogins:v.G,sharingEnabled:y.N,getSharedItemsForItemIds:_.z,getSharingStatusForItem:S.S,getPermissionForItem:f.C,getPermissionForItems:w.R,getIsLastAdminForItem:I.X,sharedAccessForItem:b.v,getUserSharedVaultItems:E.v,sharedItemsIds:C.c,shareItemsErrors:A.f}})},40102:(e,t,s)=>{s.d(t,{OL:()=>d,V$:()=>c,Vf:()=>n,m$:()=>o});var r=s(13385),i=s(62149),a=s(96168);const o=Object.freeze({FORBIDDEN_GROUP_ITEM:"FORBIDDEN_GROUP_ITEM",FORBIDDEN_LAST_ADMIN:"FORBIDDEN_LAST_ADMIN"}),n=(0,a.Vj)(o.FORBIDDEN_GROUP_ITEM,"The Vault Item cannot be deleted while shared via user group."),c=(0,a.Vj)(o.FORBIDDEN_LAST_ADMIN,"The Vault Item cannot be deleted while the current user is the last admin.");class d extends((0,r.g)({scope:i.F.User})){}},24701:(e,t,s)=>{s.d(t,{l:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},43656:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},98721:(e,t,s)=>{s.d(t,{V:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},33472:(e,t,s)=>{s.d(t,{$u:()=>c,Kb:()=>n,Mb:()=>r,S2:()=>d});var r,i=s(13385),a=s(62149),o=s(96168);!function(e){e.LIMIT_EXCEEDED="LIMIT_EXCEEDED",e.PARTIAL_SUCCESS="PARTIAL_SUCCESS"}(r||(r={}));const n=(0,o.Vj)("LIMIT_EXCEEDED","Sharing limit exceeded"),c=(0,o.Vj)("PARTIAL_SUCCESS","Some items were shared successfully, but not all");class d extends((0,i.g)({scope:a.F.User})){}},95196:(e,t,s)=>{s.d(t,{l:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},2741:(e,t,s)=>{s.d(t,{W:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},23122:(e,t,s)=>{var r;s.d(t,{o:()=>r}),function(e){e.SharingItemsGrapheneMigrationDev="sharingVault_web_shareItemsGrapheneMigration_dev"}(r||(r={}))},11108:(e,t,s)=>{s.d(t,{X:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},46234:(e,t,s)=>{s.d(t,{C:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},62176:(e,t,s)=>{s.d(t,{R:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},38661:(e,t,s)=>{s.d(t,{D:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},89623:(e,t,s)=>{s.d(t,{w:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},90878:(e,t,s)=>{s.d(t,{L:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},95803:(e,t,s)=>{s.d(t,{z:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},80160:(e,t,s)=>{s.d(t,{w:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},95038:(e,t,s)=>{s.d(t,{S:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},38638:(e,t,s)=>{s.d(t,{G:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},39672:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},54933:(e,t,s)=>{s.d(t,{B:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},32725:(e,t,s)=>{s.d(t,{f:()=>o,z:()=>r});var r,i=s(77535),a=s(62149);!function(e){e[e.ITEM_DOESNT_EXIST=0]="ITEM_DOESNT_EXIST",e[e.LIMIT_EXCEEDED=1]="LIMIT_EXCEEDED",e[e.ITEM_HAS_ATTACHMENTS=2]="ITEM_HAS_ATTACHMENTS",e[e.INVALID_REVISION=3]="INVALID_REVISION",e[e.SHARING_FAILED=4]="SHARING_FAILED"}(r||(r={}));class o extends((0,i.k)({scope:a.F.User})){}},47670:(e,t,s)=>{s.d(t,{v:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},52715:(e,t,s)=>{s.d(t,{c:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},36155:(e,t,s)=>{s.d(t,{N:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},35594:(e,t,s)=>{s.d(t,{s:()=>a});var r=s(8260),i=s(61582);class a extends((0,r.E)(i.X)){}(0,r.K)(i.X,a)},88981:(e,t,s)=>{s.d(t,{Ho:()=>n,I2:()=>l,Im:()=>h,QT:()=>u,RP:()=>v,eA:()=>o,m$:()=>m,nC:()=>g,r8:()=>d,v:()=>c,wQ:()=>p});var r=s(7165),i=s(13252);const a=r.z.object({permission:i.Iy,proposeSignature:r.z.optional(r.z.string()),acceptSignature:r.z.optional(r.z.nullable(r.z.string())),encryptedResourceKey:r.z.string(),accessType:i.dg}),o=a.extend({accessType:r.z.literal(i.Uv.User)}),n=a.extend({accessType:r.z.literal(i.Uv.UserGroup),groupEncryptedKey:r.z.optional(r.z.string()),groupPrivateKey:r.z.optional(r.z.string()),groupPublicKey:r.z.optional(r.z.string())}),c=a.extend({accessType:r.z.literal(i.Uv.CollectionUser),collectionEncryptedKey:r.z.optional(r.z.string()),collectionPrivateKey:r.z.optional(r.z.string()),collectionPublicKey:r.z.optional(r.z.string())}),d=a.extend({accessType:r.z.literal(i.Uv.CollectionUserGroup),collectionEncryptedKey:r.z.optional(r.z.string()),collectionPrivateKey:r.z.optional(r.z.string()),groupEncryptedKey:r.z.optional(r.z.string()),groupPrivateKey:r.z.optional(r.z.string()),collectionPublicKey:r.z.optional(r.z.string())}),l=r.z.union([o,n,c,d]),u=r.z.object({userIds:r.z.optional(r.z.nullable(r.z.array(r.z.string()))),collectionIds:r.z.optional(r.z.nullable(r.z.array(r.z.string()))),userGroupIds:r.z.optional(r.z.nullable(r.z.array(r.z.string())))}),p=r.z.object({id:r.z.string(),name:r.z.string(),permission:i.Iy,status:r.z.optional(i.y$)}),h=r.z.object({users:r.z.array(p),userGroups:r.z.array(p),collections:r.z.array(p)}),m=r.z.object({accessLink:r.z.optional(l),sharedItemId:r.z.string(),itemId:r.z.string(),itemKey:r.z.string(),revision:r.z.number(),recipientIds:u,permission:i.Iy,isLastAdmin:r.z.boolean()});var g;!function(e){e.Credential="KWAuthentifiant",e.Secret="KWSecret",e.SecureNote="KWSecureNote"}(g||(g={}));const v=e=>Object.values(g).includes(e)},87581:(e,t,s)=>{s.d(t,{A:()=>c});var r=s(75958),i=s(31839),a=s(53529),o=s(70633),n=s(48782);const c=(0,r.Q)({name:"sharingRecipients",commands:{},events:{},queries:{getAllAcceptedGroupsQuery:i.J,getSharingUsersQuery:a.K,getSharingGroupsQuery:o.f,getSharingGroupByIdQuery:n.e}})},31839:(e,t,s)=>{s.d(t,{J:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},48782:(e,t,s)=>{s.d(t,{e:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},70633:(e,t,s)=>{s.d(t,{f:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},53529:(e,t,s)=>{s.d(t,{K:()=>a});var r=s(77535),i=s(62149);class a extends((0,r.k)({scope:i.F.User})){}},35863:(e,t,s)=>{s.d(t,{S:()=>o,g:()=>a});var r=s(7165),i=s(13252);const a=r.z.object({userId:r.z.string(),proposeSignature:r.z.optional(r.z.string()),acceptSignature:r.z.optional(r.z.nullable(r.z.string())),status:r.z.optional(i.y$),referrer:r.z.optional(r.z.string()),groupKey:r.z.optional(r.z.nullable(r.z.string()))});var o;!function(e){e.Ascend="ascend",e.Descend="descend"}(o||(o={}))},29390:(e,t,s)=>{s.d(t,{k:()=>o});var r=s(75958),i=s(76763),a=s(15292);const o=(0,r.Q)({name:"sharingSync",commands:{runSharingSync:i.N},events:{},queries:{getTeamAdminSharingData:a.k}})},76763:(e,t,s)=>{s.d(t,{N:()=>a});var r=s(13385),i=s(62149);class a extends((0,r.g)({scope:i.F.User})){}},6489:(e,t,s)=>{var r;s.d(t,{d:()=>r}),function(e){e.SharingSyncGrapheneMigrationDev="sharingVault_web_sharingSyncGrapheneMigration_dev"}(r||(r={}))},15292:(e,t,s)=>{s.d(t,{k:()=>p,m:()=>u});var r=s(7165),i=s(77535),a=s(62149),o=s(13252);const n=r.z.object({userId:r.z.string(),alias:r.z.string(),referrer:r.z.string(),groupKey:r.z.string().nullable().optional(),permission:r.z.enum(["admin","limited"]),rsaStatus:o.bd,status:o.y$}),c=r.z.object({groupId:r.z.string(),name:r.z.string(),type:r.z.literal("teamAdmins"),publicKey:r.z.string(),privateKey:r.z.string(),revision:r.z.number(),users:r.z.array(n)}),d=r.z.object({groupId:r.z.string(),items:r.z.array(r.z.object({itemId:r.z.string(),itemKey:r.z.string()})).optional(),revision:r.z.number(),type:r.z.literal("userGroupKeys"),users:r.z.array(n)}),l=r.z.object({content:r.z.string(),timestamp:r.z.number(),itemId:r.z.string()}),u=r.z.object({specialItemGroup:d.optional(),specialUserGroup:c.optional(),specialItems:r.z.record(l).optional()});class p extends((0,i.k)({scope:a.F.User})){}},14139:(e,t,s)=>{s.d(t,{y:()=>h});var r=s(491),i=s(86006),a=s(44449),o=s(93986),n=s(51612),c=s(57452),d=s(35635),l=s(523),u=s(22952),p=s(74929);class h{}h=(0,r.__decorate)([(0,i.Yl)({sharedModuleName:"sharing-carbon-helpers",providers:[o.E,n.J,c.n,d.a,a.V,l.H,u.F,p.B],exports:[o.E,n.J,c.n,d.a,a.V,l.H,u.F,p.B],imports:[]})],h)},51612:(e,t,s)=>{s.d(t,{J:()=>d});var r=s(491),i=s(60399),a=s(96500),o=s(14122),n=s(92587),c=s(87279);class d{async getCarbonCredentialsByItemIds(e){const{queries:{carbonState:t}}=this.client,s=await(0,i.z)(t({path:"userSession.personalData.credentials"}));if((0,c.hx)(s))throw new Error("Unable to access credentials from carbon");const r=s.data;if(!r)throw new Error("No credentials found");if(o=r,!Array.isArray(o)||!o.every(a.G))throw new Error("Credentials are invalid");var o;const n=r.reduce(((e,t)=>(e[t.Id]=t,e)),{});return e.reduce(((e,t)=>(t in n&&e.push(n[t]),e)),[])}constructor(e){this.client=e}}d=(0,r.__decorate)([(0,n.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===o._?Object:o._])],d)},57452:(e,t,s)=>{s.d(t,{n:()=>l});var r=s(491),i=s(6136),a=s(10705),o=s(14122),n=s(92587),c=s(48844);const d=e=>{if(!e)return{teamId:"",isSharingEnabled:!1,isCollectionsSharingEnabled:!1,areSensitiveLogsEnabled:!1};const t=e;if(!((s=t.spaces)&&Array.isArray(s)&&0!==s.length&&(e=>{if(!e)return!1;const t=e;return!!(t.associatedEmail&&t.billingAdmins&&t.color&&t.info&&t.letter&&t.planType&&t.status&&t.teamAdmins&&t.teamId&&t.teamName&&t.tier)})(s.find((e=>"accepted"===e.status)))))return{teamId:"",isSharingEnabled:!0,isCollectionsSharingEnabled:!1,areSensitiveLogsEnabled:!1};var s;const r=t.spaces.find((e=>"accepted"===e.status)),i=Boolean(t.capabilities?.collectionSharing.enabled),a=t.capabilities?.sharingLimit.info?.limit;return{teamId:r?.teamId??"",isSharingEnabled:Boolean(r&&!r.info.sharingDisabled),areSensitiveLogsEnabled:Boolean(r?.info.collectSensitiveDataAuditLogsEnabled),isCollectionsSharingEnabled:i,sharedItemsLimit:a}};class l{get(){const{getNodePremiumStatus:e}=this.carbon.queries;return e().pipe((0,c.Qn)(d),(0,i.x)(((e,t)=>(0,a.Z)(e,t))))}constructor(e){this.carbon=e}}l=(0,r.__decorate)([(0,n.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===o._?Object:o._])],l)},35635:(e,t,s)=>{s.d(t,{a:()=>c});var r=s(491),i=s(60399),a=s(14122),o=s(92587),n=s(48844);class c{async getCurrentUserWithKeys(){const{queries:{carbonStateList:e}}=this.client;return await(0,i.z)(e({paths:["userSession.account.login","userSession.session.keyPair.publicKey","userSession.session.keyPair.privateKey"]}).pipe((0,n.nb)({success:([e,t,s])=>{if("string"!=typeof e||"string"!=typeof t||"string"!=typeof s)throw new Error("Invalid format of current user keys");return{login:e,publicKey:t,privateKey:s}},failure:()=>{throw new Error("Failure getting current user and key pair")}})))}constructor(e){this.client=e}}c=(0,r.__decorate)([(0,o.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===a._?Object:a._])],c)},44449:(e,t,s)=>{s.d(t,{V:()=>c});var r=s(491),i=s(14122),a=s(92587),o=s(48844),n=s(82181);class c{get(){const{queries:{carbonState:e}}=this.carbonLegacyClient;return e({path:"userSession.sharingSync"}).pipe((0,o.Qn)((e=>{if(!(0,n.o)(e))throw new Error("Bad SharingSync format");return e})))}constructor(e){this.carbonLegacyClient=e}}c=(0,r.__decorate)([(0,a.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===i._?Object:i._])],c)},93986:(e,t,s)=>{s.d(t,{E:()=>u});var r=s(491),i=s(14122),a=s(92587),o=s(48844),n=s(63877);function c(e){switch(e){case"admin":return n.y3.Admin;case"limited":return n.y3.Limited}}function d(e){switch(e){case"pending":return n.qb.Pending;case"accepted":return n.qb.Accepted;case"refused":return n.qb.Refused;case"revoked":return n.qb.Revoked}}function l(e){return{groupId:e.groupId,revision:e.revision,type:e.type,teamId:e.teamId,items:e.items,users:e.users?[...e.users.map((e=>({...e,permission:c(e.permission),status:d(e.status)})))]:void 0,groups:e.groups?[...e.groups.map((e=>({...e,permission:c(e.permission),status:d(e.status)})))]:void 0,collections:e.collections?[...e.collections?.map((e=>({...e,permission:c(e.permission),status:d(e.status)})))??[]]:void 0}}class u{get(){const{queries:{carbonState:e}}=this.client;return e({path:"userSession.sharingData.itemGroups"}).pipe((0,o.Qn)((e=>e.map(l))))}getForItemId(e){return this.get().pipe((0,o.Qn)((t=>t.find((t=>t.items?.some((t=>e===t.itemId)))))))}getForItemGroupId(e){return this.get().pipe((0,o.Qn)((t=>t.find((t=>t.groupId===e)))))}getForItemsIds(e){return this.get().pipe((0,o.Qn)((t=>t.filter((t=>t.items?.some((t=>e.includes(t.itemId))))))))}getForCollectionId(e){return this.get().pipe((0,o.Qn)((t=>t.filter((t=>t.collections?.some((t=>e.includes(t.uuid))))))))}constructor(e){this.client=e}}u=(0,r.__decorate)([(0,a.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===i._?Object:i._])],u)},523:(e,t,s)=>{s.d(t,{H:()=>d});var r=s(491),i=s(60399),a=s(69956),o=s(14122),n=s(92587),c=s(87279);class d{async getCarbonNotesByItemIds(e){const{queries:{carbonState:t}}=this.client,s=await(0,i.z)(t({path:"userSession.personalData.notes"}));if((0,c.hx)(s))throw new Error("Unable to access notes from carbon");const r=s.data;if(!r)throw new Error("No notes found");if(o=r,!Array.isArray(o)||!o.every(a.gi))throw new Error("Notes are invalid");var o;const n=r.reduce(((e,t)=>(e[t.Id]=t,e)),{});return e.reduce(((e,t)=>(t in n&&e.push(n[t]),e)),[])}constructor(e){this.client=e}}d=(0,r.__decorate)([(0,n.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===o._?Object:o._])],d)},22952:(e,t,s)=>{s.d(t,{F:()=>d});var r=s(491),i=s(60399),a=s(47380),o=s(14122),n=s(92587),c=s(87279);class d{async getCarbonSecretsByItemIds(e){const{queries:{carbonState:t}}=this.client,s=await(0,i.z)(t({path:"userSession.personalData.secrets"}));if((0,c.hx)(s))throw new Error("Unable to access secrets from carbon");const r=s.data;if(!r)throw new Error("No secrets found");if(o=r,!Array.isArray(o)||!o.every(a.k))throw new Error("Secrets are invalid");var o;const n=r.reduce(((e,t)=>(e[t.Id]=t,e)),{});return e.reduce(((e,t)=>(t in n&&e.push(n[t]),e)),[])}constructor(e){this.client=e}}d=(0,r.__decorate)([(0,n.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===o._?Object:o._])],d)},74929:(e,t,s)=>{s.d(t,{B:()=>g});var r=s(491),i=s(60399),a=s(87065),o=s(7165),n=s(14122),c=s(92587),d=s(87279),l=s(63877);function u(e){switch(e){case"admin":return l.y3.Admin;case"limited":return l.y3.Limited}}function p(e){switch(e){case"pending":return l.qb.Pending;case"accepted":return l.qb.Accepted;case"refused":return l.qb.Refused;case"revoked":return l.qb.Revoked}}function h(e){return{groupId:e.groupId,revision:e.revision,type:e.type,teamId:e.teamId,name:e.name,privateKey:e.privateKey,publicKey:e.publicKey,externalId:e.externalId,familyId:e.familyId,users:[...e.users.map((e=>({...e,permission:u(e.permission),status:p(e.status)})))]}}const m=o.z.array(o.z.object({groupId:o.z.string(),name:o.z.string(),externalId:o.z.string().nullable().optional(),teamId:o.z.number().optional(),type:o.z.enum(["users","teamAdmins"]),publicKey:o.z.string(),privateKey:o.z.string(),revision:o.z.number(),users:o.z.array(o.z.object({userId:o.z.string(),alias:o.z.string(),referrer:o.z.string(),groupKey:o.z.string().nullable().optional(),acceptSignature:o.z.string().nullable().optional(),permission:o.z.enum(["admin","limited"]),rsaStatus:o.z.enum(["noKey","publicKey","sharingKeys"]),status:o.z.enum(["pending","accepted","refused","revoked"]),proposeSignatureUsingAlias:o.z.boolean().optional(),proposeSignature:o.z.string().optional()}))}));class g{getRawCarbon$(){const{queries:{carbonState:e}}=this.client;return e({path:"userSession.sharingData.userGroups"})}async getRawCarbon(){const e=await(0,i.z)(this.getRawCarbon$());if((0,d.hx)(e))throw new Error("Failure getting user groups state from carbon sharing data");return e.data}async get(){const e=await this.getRawCarbon(),t=m.safeParse(e);if(!t.success)throw new Error("Invalid format of user group state");return t.data}async getForGroupIds(e){return(await this.get()).filter((t=>e.includes(t.groupId)))}async getCarbonUserGroupForGroupId(e){return(await this.getCarbonUserGroups()).find((t=>t.groupId===e))}async getCarbonUserGroupForGroupIds(e){return(await this.getCarbonUserGroups()).filter((t=>e.includes(t.groupId)))}getCarbonUserGroups$(){return this.getRawCarbon$().pipe((0,a.U)((e=>{if((0,d.hx)(e))throw new Error("Failure getting user groups state from carbon sharing data");const t=m.safeParse(e.data);if(!t.success)throw new Error("Failure parsing ser groups state from carbon sharing data");return t.data.map(h)})))}async getCarbonUserGroups(){return(await this.getRawCarbon()).map(h)}constructor(e){this.client=e}}g=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===n._?Object:n._])],g)},91969:(e,t,s)=>{s.d(t,{V:()=>u,c:()=>l});var r=s(491),i=s(87065),a=s(92587),o=s(87279),n=s(13252),c=s(11797),d=s(63784);const l=e=>({users:e.users?.map((e=>({id:e.login,name:e.login,permission:e.permission,status:e.status})))??[],userGroups:e.userGroups?.map((e=>({id:e.uuid,name:e.name,permission:e.permission,status:e.status})))??[]});class u{async getCollectionsByIds(e){return(await this.store.getState()).sharedCollections.filter((t=>e.includes(t.uuid)))}async getCollections(){return(await this.store.getState()).sharedCollections}collections$(){return this.store.state$.pipe((0,i.U)((e=>e.sharedCollections)))}collection$(e){return this.collections$().pipe((0,i.U)((t=>t.find((t=>t.uuid===e)))))}async getCollection(e){const t=(await this.store.getState()).sharedCollections.find((t=>t.uuid===e));if(t)return t}async updateCollections(e){await this.store.set({sharedCollections:[...e]})}getGroupRoleInCollection$(e,t){return this.collection$(e).pipe((0,i.U)((e=>{if(!e)throw new Error("Shared collection not found");const s=e.userGroups?.find((e=>e.uuid===t));return s?.permission===n.y3.Admin?c.Yt.Manager:c.Yt.Editor})))}usersAndGroupsInCollection(e){return this.collections$().pipe((0,i.U)((t=>{const s=t.filter((t=>e.includes(t.uuid))),r=s.flatMap((e=>e.users?e.users:[])).map((e=>({id:e.login,label:e.login,status:e.status,permission:e.permission}))),i=s.flatMap((e=>e.userGroups?e.userGroups:[])).map((e=>({id:e.uuid,label:e.name,status:e.status,permission:e.permission})));return(0,o.Vp)({userGroups:i,users:r})})))}constructor(e){this.store=e}}u=(0,r.__decorate)([(0,a.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===d.C?Object:d.C])],u)},32336:(e,t,s)=>{s.d(t,{T_:()=>m,cx:()=>p});var r=s(7165),i=s(13252),a=s(11797),o=s(78262);const n=r.z.nativeEnum(o.o),c=r.z.object({permission:i.Iy,proposeSignature:r.z.optional(r.z.string()),acceptSignature:r.z.optional(r.z.nullable(r.z.string())),encryptedResourceKey:r.z.string(),accessType:n}),d=c.extend({accessType:r.z.literal(o.o.User)}),l=c.extend({accessType:r.z.literal(o.o.UserGroup),groupEncryptedKey:r.z.optional(r.z.string()),groupPrivateKey:r.z.optional(r.z.string())}),u=r.z.union([d,l]),p=r.z.object({sharedCollections:r.z.array(a.MX)}),h=r.z.object({id:r.z.string(),name:r.z.string(),privateKey:r.z.string(),publicKey:r.z.string(),revision:r.z.number(),isAccepted:r.z.boolean(),permission:i.Iy,accessLink:r.z.optional(u),isLastAdmin:r.z.boolean(),pendingDirectAccess:r.z.optional(r.z.object({referrer:r.z.string(),permission:i.Iy}))}),m=r.z.object({collections:r.z.record(h),sharedCollectionsAccess:r.z.record(a.Ng)})},5482:(e,t,s)=>{s.d(t,{U:()=>r});class r{}},71275:(e,t,s)=>{s.d(t,{G:()=>r});class r{}},64222:(e,t,s)=>{s.d(t,{a:()=>St});var r=s(491),i=s(86006),a=s(62048),o=s(41511),n=s(16624),c=s(63784),d=s(92587);class l{}var u=s(85337),p=s(6554),h=s(99291);class m{async createCollection(e,t,s,r,i){const a=await this.sharingCrypto.createResourceKey(),o={resourceKey:a,uuid:e},n=await this.sharingUsers.createSignedUserInvites(r,o),c=i.length>0?await this.sharingUserGroups.createSignedUserGroupInvites(i,o):void 0,{publicKey:d,privateKey:l}=await this.sharingCrypto.createRecipientKeyPair(a);return this.sharingCollectionsGateway.createCollection({collectionId:e,collectionName:s,publicKey:d,privateKey:l,users:n,userGroups:c,teamId:Number(t)})}async renameCollection(e,t){const{revision:s,uuid:r}=e;await this.sharingCollectionsGateway.renameCollection({collectionId:r,revision:s,updatedName:t})}async inviteCollectionMembers(e,t,s,r,i){const a=r.length?this.sharingUsers.createSignedUserInvites(r,{resourceKey:s,uuid:e},!1):void 0,o=i.length?this.sharingUserGroups.createSignedUserGroupInvites(i,{resourceKey:s,uuid:e}):void 0,[n,c]=await Promise.all([a,o]);return await this.sharingCollectionsGateway.inviteCollectionMembers({revision:t,collectionId:e,users:n,userGroups:c})}async updateCollectionMembers(e,t,s){const{revision:r,uuid:i}=e;return await this.sharingCollectionsGateway.updateCollectionMembers({revision:r,collectionId:i,users:t,userGroups:s})}constructor(e,t,s,r){this.sharingCollectionsGateway=e,this.sharingCrypto=t,this.sharingUserGroups=s,this.sharingUsers=r}}m=(0,r.__decorate)([(0,d.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===l?Object:l,void 0===h.O?Object:h.O,void 0===u.o?Object:u.o,void 0===p.E?Object:p.E])],m);var g=s(60399),v=s(87279),y=s(13252),_=s(53384),S=s(35594),f=s(523),w=s(7502),I=s(89685),b=s(91943),E=s(39431),C=s(50879),A=s(13134),R=s(44801),T=s(71996);class O{async getDomainForCredential(e){const t=await(0,g.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[E.U.Credential],ids:[e]}));if((0,v.hx)(t))throw new Error("Unable to find selected item");const s=t.data.credentialsResult.items[0];return new A.Y(s.URL).getRootDomain()}async createCollectionInvites(e,t,s){const r=await Promise.all(t.map((async t=>{const r=await this.sharingDecryption.decryptItemGroupKey(t);if(null===r)throw new Error("Unable to decrypt item group key");const i=await this.sharingDecryption.decryptSharedCollectionKeyForCurrentUser(e);if(!i)throw new Error("Unable to decrypt collection key");const a=await this.sharingCrypto.decryptSecureData(i,(0,w.R)(e.privateKey)),{proposeSignature:o,acceptSignature:n,resourceKey:c}=await this.sharingInvitesCrypto.createSignedInvite(e.id,{resourceKey:r,uuid:t.sharedItemId},e.publicKey,(0,I.v)(a));if(!c)throw new Error("Could not create resource key when generating user group invite for collection");if(!n)throw new Error("should not happen");const d=await(0,g.z)(this.activityLogs.queries.areSensitiveLogsEnabled());if((0,v.hx)(d))throw new Error("Unable find preferences");const l=await(0,g.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[E.U.Credential,E.U.SecureNote],ids:[t.itemId]}));if((0,v.hx)(l))throw new Error("Unable to find selected item");const u=l.data.credentialsResult.items.length?{domain:await this.getDomainForCredential(t.itemId),type:y.y2.Credential}:void 0;return{id:t.sharedItemId,permission:s,resourceKey:c,proposeSignature:o,acceptSignature:n,auditLogData:u}})));return{collectionId:e.id,revision:e.revision,itemGroups:r}}constructor(e,t,s,r,i){this.sharingInvitesCrypto=e,this.sharingCrypto=t,this.sharingDecryption=s,this.vaultItemsCrudClient=r,this.activityLogs=i}}O=(0,r.__decorate)([(0,d.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.h?Object:T.h,void 0===h.O?Object:h.O,void 0===R.c?Object:R.c,void 0===C.L?Object:C.L,void 0===b._?Object:b._])],O);var D=s(40217),U=s(51612);class F{async addItemsToCollections(e,t,s){const r=await(0,g.z)(this.sharingItemsClient.queries.getSharedItemsForItemIds({itemIds:t}));if((0,v.hx)(r))throw new Error("Unable to find item groups for items");const i=(0,v.db)(r).sharedItems;if(!i.every((e=>e.permission===y.y3.Admin)))throw new Error("User does not have access to share selected items");const a=await this.credentialsGetter.getCarbonCredentialsByItemIds(t),o=await this.notesGetter.getCarbonNotesByItemIds(t),n=[...a,...o];if(o.some((e=>e.Attachments?.length)))return(0,v.Rn)((0,_.LG)());const c=[...n.filter((({Id:e})=>!i.some((t=>t.itemId===e))))],d=c.length>0?await this.sharingItemGroups.createMultipleItemGroups(c):[];return await Promise.all(e.map((async e=>{const t=await this.collectionInvitesService.createCollectionInvites(e,[...i,...d],s.find((t=>t.collectionId===e.id))?.permission??y.y3.Admin);await this.sharingCollectionsApi.addItemGroupsToCollection(t)}))),(0,v.Vp)(void 0)}constructor(e,t,s,r,i,a){this.collectionInvitesService=e,this.sharingItemGroups=t,this.sharingCollectionsApi=s,this.credentialsGetter=r,this.notesGetter=i,this.sharingItemsClient=a}}F=(0,r.__decorate)([(0,d.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===O?Object:O,void 0===D.k?Object:D.k,void 0===l?Object:l,void 0===U.J?Object:U.J,void 0===f.H?Object:f.H,void 0===S.s?Object:S.s])],F);var P=s(16712),x=s(82874),N=s(43651),G=s(6489),k=s(51607);function L(e){return void 0!==e}var M=s(71275),K=s(5482),j=s(89720),V=s(21003),z=s(80629);class W{async execute({body:e}){const{collectionPermissions:t,itemIds:s,shouldSkipSync:r}=e,{userFeatureFlip:i}=this.featureFlips.queries,a=await(0,g.z)(i({featureFlip:G.d.SharingSyncGrapheneMigrationDev})),o=!!(0,v.d6)(a)&&!!(0,v.db)(a)?await this.collectionsNewRepository.getCollectionsById(t.map((({collectionId:e})=>e))):await this.getCollectionLegacy(t),n=await this.sharingCollectionItems.addItemsToCollections(o.filter(L),s,t);if((0,v.hx)(n))throw new Error("Failed adding an item to a list of collections");return r||await this.sharingSync.scheduleSync(),(0,v.Vp)(void 0)}async getCollectionLegacy(e){const t=await this.collectionsRepository.getCollectionsByIds(e.map((e=>e.collectionId)));if(t.length!==e.length)throw new Error("Unable to find some of the collections in the list");const s=Object.values(await this.userGroupsRepository.getUserGroups()),r=this.getCurrentUserLogin();if(!r)throw new Error("No loged in user available when adding items to collections");return t.map((e=>(0,V.E)(e,s,r)))}getCurrentUserLogin(){return this.context.get(P.l.UserName)}constructor(e,t,s,r,i,a,o){this.sharingCollectionItems=e,this.sharingSync=t,this.collectionsRepository=s,this.collectionsNewRepository=r,this.userGroupsRepository=i,this.featureFlips=a,this.context=o}}W=(0,r.__decorate)([(0,x.W)(k.k),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===F?Object:F,void 0===z.D?Object:z.D,void 0===M.G?Object:M.G,void 0===K.U?Object:K.U,void 0===j.x?Object:j.x,void 0===N.P?Object:N.P,void 0===P.f?Object:P.f])],W);var q=s(91969),B=s(53344);const $=e=>e.map((({id:e,resourceKey:t,proposeSignature:s,proposeSignatureUsingAlias:r,acceptSignature:i,alias:a,permission:o})=>({login:e,collectionKey:t,proposeSignature:s,proposeSignatureUsingAlias:r,acceptSignature:i,alias:a,permission:o}))),Y=e=>e.map((({id:e,resourceKey:t,proposeSignature:s,acceptSignature:r,permission:i})=>({groupUUID:e,collectionKey:t,proposeSignature:s,acceptSignature:r,permission:i})));var Q=s(11819);class H{async createCollection(e){const t=await(0,g.z)(this.serverApiClient.v1.sharingUserdevice.createCollection((e=>{const{collectionId:t,collectionName:s,users:r,userGroups:i,publicKey:a,privateKey:o,teamId:n}=e;return{collectionUUID:t,collectionName:s,publicKey:a,privateKey:o,teamId:n,users:$(r),userGroups:i?Y(i):void 0}})(e)));if((0,v.hx)(t))throw new Error("Failed to create shared collection from private one");const s=(0,v.db)(t).data.collections?.find((t=>t.uuid===e.collectionId));if(!s)throw new Error("Unable to find collection");return s}async renameCollection(e){const{collectionId:t,revision:s,updatedName:r}=e,i=await(0,g.z)(this.serverApiClient.v1.sharingUserdevice.renameCollection({collectionUUID:t,revision:s,updatedName:r}));if((0,v.hx)(i))throw new Error("Failed to rename shared collection")}async addItemGroupsToCollection(e){const t=[];for(let s=0;s<e.itemGroups.length;s+=100)t.push(e.itemGroups.slice(s,s+100));let s=e.revision;for(const r of t){const t=await(0,g.z)(this.serverApiClient.v1.sharingUserdevice.addItemGroupsToCollection({collectionUUID:e.collectionId,itemGroups:r.map((({id:e,proposeSignature:t,acceptSignature:s,permission:r,resourceKey:i,auditLogData:a})=>({uuid:e,proposeSignature:t,acceptSignature:s,permission:r,itemGroupKey:i,auditLogDetails:a?(0,Q.B)(a):void 0}))),revision:s}));if((0,v.hx)(t))throw new Error("Failed to add items to collection");const i=(0,v.db)(t).data;if(!i.collections?.length)throw new Error("Failed to add items to collection");s=i.collections[0].revision}}async deleteCollection(e,t){const s={collectionUUID:e,revision:t},r=await(0,g.z)(this.serverApiClient.v1.sharingUserdevice.deleteCollection(s));if((0,v.hx)(r))throw new Error("Failed to delete shared collection")}async inviteCollectionMembers({collectionId:e,revision:t,users:s,userGroups:r}){const i={collectionUUID:e,revision:t,users:s?$(s):void 0,userGroups:r?Y(r):void 0},a=this.serverApiClient.v1.sharingUserdevice.inviteCollectionMembers(i),o=await(0,g.z)(a);if((0,v.hx)(o)||!o.data.data.collections)throw new Error("Failed to add members to collection");return o.data.data.collections[0]}async updateCollectionMembers({collectionId:e,revision:t,users:s,userGroups:r}){const i={collectionUUID:e,revision:t,users:s,userGroups:r?.map((({groupId:e,permission:t})=>({groupUUID:e,permission:t})))},a=this.serverApiClient.v1.sharingUserdevice.updateCollectionMembers(i),o=await(0,g.z)(a);if((0,v.hx)(o)||!o.data.data.collections)throw new Error("Failed to update collection members");return o.data.data.collections[0]}async revokeCollectionMembers({collectionId:e,revision:t,userGroupIds:s,userLogins:r}){const i=this.serverApiClient.v1.sharingUserdevice.revokeCollectionMembers({collectionUUID:e,revision:t,userLogins:r,userGroupUUIDs:s}),a=await(0,g.z)(i);if((0,v.hx)(a)||!a.data.data.collections)throw new Error("Failed to revoke access to collection");return a.data.data.collections[0]}async removeItemGroupsFromCollection(e,t){const s=await(0,g.z)(this.serverApiClient.v1.sharingUserdevice.removeItemGroupsFromCollection({collectionUUID:e.uuid,itemGroupUUIDs:t,revision:e.revision}));if((0,v.hx)(s))throw new Error("Failure to remove items from collection")}async removeItemGroupCollectionAccess(e){const{collectionId:t,itemGroupId:s,itemGroupRevision:r,auditLogData:i}=e,a=await(0,g.z)(this.serverApiClient.v1.sharingUserdevice.revokeItemGroupMembers({revision:r,groupId:s,collections:[t],auditLogDetails:i?(0,Q.B)(i):void 0}));if((0,v.hx)(a))throw new Error("Failure to remove collection member from an item group")}constructor(e){this.serverApiClient=e}}H=(0,r.__decorate)([(0,d.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===B.l?Object:B.l])],H);var J=s(31105),Z=s(11797);const X=e=>e===Z.Yt.Manager?y.y3.Admin:y.y3.Limited,ee=e=>({login:e.login,permission:X(e.role)}),te=e=>({groupId:e.groupId,permission:X(e.role)});class se{async execute({body:e}){const{collectionId:t,userRecipients:s,userGroupRecipients:r}=e,i=await this.collectionsRepository.getCollection(t);if(!i)throw new Error("Collection not found");const a=await this.sharingCollectionsService.updateCollectionMembers(i,s?.map(ee),r?.map(te)),o=(await this.collectionsRepository.getCollections()).filter((e=>e.uuid!==a.uuid));return await this.collectionsRepository.updateCollections([...o,a]),(0,v.Vp)(void 0)}constructor(e,t){this.sharingCollectionsService=e,this.collectionsRepository=t}}se=(0,r.__decorate)([(0,x.W)(J.c),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===m?Object:m,void 0===M.G?Object:M.G])],se);var re=s(61076),ie=s(87065),ae=s(69885),oe=s(48844),ne=s(63144),ce=s(56618),de=s(28489),le=s(10722),ue=s(62149),pe=s(32336);const he=e=>pe.T_.safeParse(e).success;class me extends((0,ne.Q)({persist:!0,scope:ue.F.User,storeName:"collections-store",storeTypeGuard:he,storage:{initialValue:{collections:(0,de.Ay)({}),sharedCollectionsAccess:(0,de.Ay)({})},typeGuard:he,schemaVersion:2,migrateStorageSchema:()=>({collections:{},sharedCollectionsAccess:{}})},capacity:ce.Y.Unlimited,codec:le.E,isCache:!0})){}class ge{getUserRoleInCollectionCarbon$(e,t,s){const r=t||s;if(!r)throw new Error("No target user to get role in collection");return this.userGroupsRepository.acceptedUserGroupIdsForLogin$(r).pipe((0,re.V)(this.collectionsRepository.collection$(e)),(0,ie.U)((([e,t])=>{if(!t)throw new Error("Shared collection not found");const s=t.users?.find((e=>e.login===r)),i=s?.permission===y.y3.Admin&&s.status===y.qb.Accepted,a=t.userGroups?.filter((t=>e.includes(t.uuid))),o=a?.some((e=>e.permission===y.y3.Admin));return i||o?Z.Yt.Manager:Z.Yt.Editor})))}getUserRoleInCollectionGraphene$(e,t,s){const r=t||s;if(!r)throw new Error("No target user to get role in collection");return this?.userGroupsRepository.acceptedUserGroupIdsForLogin$(r).pipe((0,re.V)(this.store.state$),(0,ie.U)((([t,s])=>{const{sharedCollectionsAccess:i}=s,a=i[e];if(!a)throw new Error("Shared collection not found");const o=a.users.find((e=>e.name===r)),n=o?.permission===y.y3.Admin&&o.status===y.qb.Accepted,c=a.userGroups.filter((e=>t.includes(e.id))).some((e=>e.permission===y.y3.Admin));return n||c?Z.Yt.Manager:Z.Yt.Editor})))}getGroupRoleInCollection$(e,t){return this.collectionsRepository.getGroupRoleInCollection$(e,t)}canShareItems(e){return 0===e.length?(0,ae.of)((0,v.Vp)(!0)):this.sharingItemsClient.queries.getSharedItemsForItemIds({itemIds:e}).pipe((0,oe.Qn)((e=>e.sharedItems.every((e=>e.permission===y.y3.Admin)))))}constructor(e,t,s,r){this.collectionsRepository=e,this.userGroupsRepository=t,this.sharingItemsClient=s,this.store=r}}ge=(0,r.__decorate)([(0,d.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===M.G?Object:M.G,void 0===j.x?Object:j.x,void 0===S.s?Object:S.s,void 0===me?Object:me])],ge);var ve=s(46449),ye=s(14947);class _e{execute(){const e=this.collectionsRepository.collections$(),t=this.getCurrentUserLogin();return e.pipe((0,ie.U)((e=>{const s=e.filter((e=>e.authorLogin===t));return(0,v.Vp)(s.length)})))}getCurrentUserLogin(){return this.context.get(P.l.UserName)}constructor(e,t){this.collectionsRepository=e,this.context=t}}_e=(0,r.__decorate)([(0,ve.e)(ye.C),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===M.G?Object:M.G,void 0===P.f?Object:P.f])],_e);var Se=s(63792),fe=s(27790);class we{async execute({body:e}){const{collection:t,itemId:s}=e,r=await(0,g.z)(this.sharingItemsClient.queries.getSharedItemForId({itemId:s}));if((0,v.hx)(r)||!r.data.sharedItem)throw new Error("Item group to be removed from collection cannot be found");const{sharedItemId:i,revision:a}=r.data.sharedItem;return await this.sharingCommon.updateItemGroupMembers({groupId:i,collections:[{collectionUUID:t.collectionId,permission:t.permission}],revision:a}),await this.sharingSync.scheduleSync(),(0,v.Vp)(void 0)}constructor(e,t,s){this.sharingCommon=e,this.sharingSync=t,this.sharingItemsClient=s}}we=(0,r.__decorate)([(0,x.W)(Se.a),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===fe.b_?Object:fe.b_,void 0===z.D?Object:z.D,void 0===S.s?Object:S.s])],we);const Ie=({id:e,name:t,revision:s,publicKey:r,privateKey:i})=>({uuid:e,name:t,revision:s,publicKey:r,privateKey:i});class be{async getCollectionsByIds(e){const t=await this.store.getState();return e.reduce(((e,s)=>{const r=t.collections[s];return r&&e.push(Ie(r)),e}),(0,de.Ay)([]))}async getCollections(){const e=await this.store.getState();return Object.values(e.collections).map((e=>Ie(e)))}collections$(){return this.store.state$.pipe((0,ie.U)((e=>Object.values(e.collections).map((e=>Ie(e))))))}collection$(e){return this.collections$().pipe((0,ie.U)((t=>t.find((t=>t.uuid===e)))))}async getCollection(e){const t=(await this.store.getState()).collections[e];if(t)return Ie(t)}async updateCollections(){}getGroupRoleInCollection$(e,t){return this.store.state$.pipe((0,ie.U)((s=>{const{sharedCollectionsAccess:r}=s,i=r[e];if(!i)throw new Error("Shared collection not found");const a=i.userGroups.find((e=>e.id===t));return a?.permission===y.y3.Admin?Z.Yt.Manager:Z.Yt.Editor})))}usersAndGroupsInCollection(e){return this.store.state$.pipe((0,ie.U)((t=>{const{sharedCollectionsAccess:s}=t,r=e.flatMap((e=>s[e]?s[e].users.map((e=>({id:e.name,label:e.name,status:e.status??y.qb.Pending,permission:e.permission}))):[])),i=e.flatMap((e=>s[e]?s[e].userGroups.map((e=>({id:e.id,label:e.name,status:e.status??y.qb.Pending,permission:e.permission}))):[]));return(0,v.Vp)({userGroups:i,users:r})})))}constructor(e){this.store=e}}be=(0,r.__decorate)([(0,d.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===me?Object:me])],be);var Ee=s(162),Ce=s(43978);class Ae{async getCollectionsByIds(e){return(await this.getRepo()).getCollectionsByIds(e)}async getCollections(){return(await this.getRepo()).getCollections()}collections$(){return(0,Ee.D)(this.getRepo()).pipe((0,Ce.w)((e=>e.collections$())))}collection$(e){return(0,Ee.D)(this.getRepo()).pipe((0,Ce.w)((t=>t.collection$(e))))}async getCollection(e){return(await this.getRepo()).getCollection(e)}async updateCollections(e){return(await this.getRepo()).updateCollections(e)}getGroupRoleInCollection$(e,t){return(0,Ee.D)(this.getRepo()).pipe((0,Ce.w)((s=>s.getGroupRoleInCollection$(e,t))))}usersAndGroupsInCollection(e){return(0,Ee.D)(this.getRepo()).pipe((0,Ce.w)((t=>t.usersAndGroupsInCollection(e))))}async getRepo(){const{userFeatureFlip:e}=this.featureFlips.queries,t=await(0,g.z)(e({featureFlip:G.d.SharingSyncGrapheneMigrationDev}));return(0,v.hx)(t)?this.legacyRepo:(0,v.db)(t)?this.repo:this.legacyRepo}constructor(e,t,s){this.legacyRepo=e,this.repo=t,this.featureFlips=s}}Ae=(0,r.__decorate)([(0,d.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===q.V?Object:q.V,void 0===be?Object:be,void 0===N.P?Object:N.P])],Ae);class Re{async getCollections(){const{collections:e}=await this.store.getState();return e}async getCollectionsById(e){const{collections:t}=await this.store.getState();return e.reduce(((e,s)=>(t[s]&&e.push(t[s]),e)),(0,de.Ay)([]))}async setCollections(e,t){const s=await this.store.getState();await this.store.set(e.reduce(((e,r)=>(e.collections[r.id]=r,e.sharedCollectionsAccess[r.id]=t[r.id]??s.sharedCollectionsAccess[r.id],e)),(0,de.Ay)({collections:{},sharedCollectionsAccess:{}})))}sharedCollectionsAccessForId$(e){return this.store.state$.pipe((0,ie.U)((({sharedCollectionsAccess:t})=>t[e])))}constructor(e){this.store=e}}Re=(0,r.__decorate)([(0,d.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===me?Object:me])],Re);var Te=s(77802),Oe=s(50436);const De=e=>e.login,Ue=e=>e.groupId,Fe=e=>e.length>0?e.map(De):void 0;class Pe{async execute({body:e}){const{teamId:t,collectionName:s,privateCollectionId:r,users:i,groups:a,defaultItemPermissions:o,itemIds:n}=e,c=(0,Oe.R)(),d=await this.sharingCollections.createCollection(c,t,s,i.map(ee),a.map(te)),l={collectionId:c,permission:o};if(n.length>0)try{const e=this.getCurrentUserLogin();if(!e)throw new Error("No loged in user available when adding items to collections");const t=await this.sharingCollectionItems.addItemsToCollections([(0,V.E)(d,[],e)],n,[l]);if((0,v.hx)(t))throw new Error(t.error.tag)}catch(e){const t=await this.sharingCollectionsGateway.revokeCollectionMembers({collectionId:d.uuid,revision:d.revision,userGroupIds:(u=a,u.length>0?u.map(Ue):void 0),userLogins:Fe(i)});if(await this.sharingCollectionsGateway.deleteCollection(t.uuid,t.revision),await this.sharingSync.scheduleSync(),e instanceof Error&&e.message===_.Pf)return(0,v.Rn)((0,_.LG)());throw e}var u;const{commands:p}=this.vaultClient;return r?await p.deleteCollection({id:r}):await this.sharingSync.scheduleSync(),(0,v.Vp)(void 0)}getCurrentUserLogin(){return this.context.get(P.l.UserName)}constructor(e,t,s,r,i,a){this.sharingCollections=e,this.sharingCollectionsGateway=t,this.sharingCollectionItems=s,this.vaultClient=r,this.sharingSync=i,this.context=a}}Pe=(0,r.__decorate)([(0,x.W)(_.I4),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===m?Object:m,void 0===l?Object:l,void 0===F?Object:F,void 0===Te.C?Object:Te.C,void 0===z.D?Object:z.D,void 0===P.f?Object:P.f])],Pe);var xe=s(21998);class Ne{async execute({body:e}){const{id:t}=e,s=await this.collectionsRepository.getCollection(t);if(!s)throw new Error("Failed to find collection revision");return await this.sharingCollectionsApi.deleteCollection(s.uuid,s.revision),await this.sharingSync.scheduleSync(),(0,v.Vp)(void 0)}constructor(e,t,s){this.sharingSync=e,this.collectionsRepository=t,this.sharingCollectionsApi=s}}Ne=(0,r.__decorate)([(0,x.W)(xe.U),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===z.D?Object:z.D,void 0===M.G?Object:M.G,void 0===l?Object:l])],Ne);var Ge=s(22210),ke=s(35635);class Le{async execute({body:e}){const{collectionId:t,userRecipients:s,userGroupRecipients:r}=e,{userFeatureFlip:i}=this.featureFlips.queries,a=await(0,g.z)(i({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"}));if((0,v.hx)(a))throw new Error("Cannot retrieve FF for invite collection member command");return!!(0,v.d6)(a)&&!!(0,v.db)(a)?this.executeWithGrapheneState$(t,s,r):this.executeWithCarbonState$(t,s,r)}async executeWithGrapheneState$(e,t,s){const{sharedCollectionsAccess:r,collections:i}=await this.store.getState(),a=i[e],o=r[e];if(!a||!o)throw new Error(`Collection ${e} not found when inviting collection member`);const{revision:n,id:c}=a,d=await this.currentUserGetter.getCurrentUserWithKeys(),l=await this.sharingDecryption.decryptSharedCollectionKey(a,d);if(!l)throw new Error("Cannot decrypt collection key.");const u=t?.map(ee),p=s?.map(te),h=await this.sharingCollectionsService.inviteCollectionMembers(c,n,l,u||[],p||[]);return this.updateSharedCollectionsAccess(i,r,e,h),(0,v.Vp)(void 0)}async executeWithCarbonState$(e,t,s){const r=await this.collectionsRepository.getCollection(e);if(!r)throw new Error("Collection not found");const i=t?.map(ee),a=s?.map(te),o=await this.sharingDecryption.decryptCollectionKey(r);if(!o)throw new Error("Cannot decrypt collection key.");const n=await this.sharingCollectionsService.inviteCollectionMembers(r.uuid,r.revision,o,i||[],a||[]),c=(await this.collectionsRepository.getCollections()).filter((e=>e.uuid!==n.uuid));return await this.collectionsRepository.updateCollections([...c,n]),(0,v.Vp)(void 0)}async updateSharedCollectionsAccess(e,t,s,r){return await this.store.set({collections:e,sharedCollectionsAccess:{...t,[s]:{users:r.users?.map((e=>({id:e.login,name:e.login,permission:e.permission,status:e.status})))??[],userGroups:r.userGroups?.map((e=>({id:e.uuid,name:e.name,permission:e.permission,status:e.status})))??[]}}})}constructor(e,t,s,r,i,a){this.collectionsRepository=e,this.sharingCollectionsService=t,this.featureFlips=s,this.store=r,this.currentUserGetter=i,this.sharingDecryption=a}}Le=(0,r.__decorate)([(0,x.W)(Ge.Q),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===M.G?Object:M.G,void 0===m?Object:m,void 0===N.P?Object:N.P,void 0===me?Object:me,void 0===ke.a?Object:ke.a,void 0===R.c?Object:R.c])],Le);var Me=s(94020),Ke=s(57452);class je{async prepareAuditLogDetails(e){const{userFeatureFlips:t}=this.featureFlips.queries,s=await(0,g.z)(t().pipe((0,oe.Qn)((e=>e.audit_logs_sharing&&e.send_activity_log)))),r=!!(0,v.d6)(s)&&(s.data??!1),i=await(0,g.z)(this.currentSpaceGetter.get());if((0,v.hx)(i))throw new Error("Error fetching current space when moving shared collection items to business space");if(!i.data.areSensitiveLogsEnabled||!r)return;const a=await(0,g.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[E.U.Credential],ids:[e]}));if((0,v.hx)(a))throw new Error("Unable to find selected item");const o=(0,v.db)(a),n=o.credentialsResult.matchCount?o.credentialsResult.items[0]:void 0,c=n?new A.Y(n.URL).getRootDomain():"";return{domain:n?c:void 0,type:n?y.y2.Credential:y.y2.SecureNote}}async removeItemToCollection(e,t){const s=await(0,g.z)(this.sharingItemsClient.queries.getSharedItemForId({itemId:e}));if((0,v.hx)(s)||!s.data.sharedItem)throw new Error("Item group to be removed from collection cannot be found");const{sharedItemId:r,revision:i}=s.data.sharedItem,a=await this.prepareAuditLogDetails(e);await this.sharingCollectionsGateway.removeItemGroupCollectionAccess({collectionId:t,itemGroupId:r,itemGroupRevision:i,auditLogData:a})}async execute({body:e}){const{collectionIds:t,itemId:s}=e;for(const e of t)await this.removeItemToCollection(s,e);return await this.sharingSync.scheduleSync(),(0,v.Vp)(void 0)}constructor(e,t,s,r,i,a){this.sharingCollectionsGateway=e,this.sharingSync=t,this.currentSpaceGetter=s,this.featureFlips=r,this.vaultItemsCrudClient=i,this.sharingItemsClient=a}}je=(0,r.__decorate)([(0,x.W)(Me.B),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===l?Object:l,void 0===z.D?Object:z.D,void 0===Ke.n?Object:Ke.n,void 0===N.P?Object:N.P,void 0===C.L?Object:C.L,void 0===S.s?Object:S.s])],je);var Ve=s(46733);class ze{async execute({body:e}){const{collectionId:t,newName:s}=e,r=await this.collectionsRepository.getCollection(t);if(!r)throw new Error("Failed to find collection revision");return await this.sharingCollections.renameCollection(r,s),await this.sharingSync.scheduleSync(),(0,v.Vp)(void 0)}constructor(e,t,s){this.sharingCollections=e,this.collectionsRepository=t,this.sharingSync=s}}ze=(0,r.__decorate)([(0,x.W)(Ve.r),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===m?Object:m,void 0===M.G?Object:M.G,void 0===z.D?Object:z.D])],ze);var We=s(88621);class qe{async execute({body:e}){const{collectionId:t,userGroupIds:s,userLogins:r}=e,i=await this.collectionsRepository.getCollection(t);if(!i)throw new Error("Cannot access the requested collection.");const{revision:a}=i,o=await this.sharingCollectionsGateway.revokeCollectionMembers({collectionId:t,revision:a,userGroupIds:s,userLogins:r}),n=(await this.collectionsRepository.getCollections()).filter((e=>e.uuid!==o.uuid));return await this.collectionsRepository.updateCollections([...n,o]),(0,v.Vp)(void 0)}constructor(e,t){this.collectionsRepository=e,this.sharingCollectionsGateway=t}}qe=(0,r.__decorate)([(0,x.W)(We.q),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===M.G?Object:M.G,void 0===l?Object:l])],qe);var Be=s(76001);class $e{async execute({body:e}){return await this.collectionsRepository.updateCollections(e.collections),(0,v.Vp)(void 0)}constructor(e){this.collectionsRepository=e}}$e=(0,r.__decorate)([(0,x.W)(Be.M),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===M.G?Object:M.G])],$e);var Ye=s(91132),Qe=s(93986);class He{async execute(){const e=await(0,g.z)(this.currentSpaceGetter.get());if((0,v.hx)(e))throw new Error("Error fetching current space when moving shared collection items to business space");const t=(0,v.db)(e).teamId;if(!t)return(0,v.Vp)(void 0);const s=await(0,g.z)(this.itemGroupsGetter.get());if((0,v.hx)(s))throw new Error("Error fetching shared collection items to move to business space");const r=(0,v.db)(s).reduce(((e,t)=>t.collections?.some((e=>e.status===y.qb.Accepted))&&t.items?.[0].itemId?[...e,t.items[0].itemId]:e),[]);if(r.length){if((await Promise.all(r.map((e=>this.moveItemToBusinessSpace(e,t))))).some(v.hx))throw new Error("Error when moving shared collection items to business space")}return(0,v.Vp)(void 0)}async moveItemToBusinessSpace(e,t){const{commands:s}=this.vaultItemsCrudClient,r=await(0,g.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[E.U.Credential,E.U.SecureNote],ids:[e]}));if((0,v.hx)(r))return Promise.resolve((0,v.Rn)(void 0));const i=(0,v.db)(r).credentialsResult,a=(0,v.db)(r).secureNotesResult,o=i.matchCount>0,n=a.matchCount>0;if(!o&&!n)return Promise.resolve((0,v.Vp)(void 0));return(o?i.items[0]:a.items[0]).spaceId===t?Promise.resolve((0,v.Vp)(void 0)):s.updateVaultItem({vaultItemType:o?E.U.Credential:E.U.SecureNote,id:e,content:{spaceId:t},shouldSkipSync:!0})}constructor(e,t,s){this.itemGroupsGetter=e,this.vaultItemsCrudClient=t,this.currentSpaceGetter=s}}He=(0,r.__decorate)([(0,x.W)(Ye.g),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Qe.E?Object:Qe.E,void 0===C.L?Object:C.L,void 0===Ke.n?Object:Ke.n])],He);var Je=s(6136),Ze=s(62760),Xe=s(13312);class et{isCollectionsSharingEnabled(e){return e.isSharingEnabled&&e.isCollectionsSharingEnabled}execute({body:e}){const{collectionId:t,userId:s}=e,{queries:{queryCollections:r}}=this.vaultOrganization;return r({ids:[t]}).pipe((0,re.V)(this.currentSpace.get(),this.featureFlips.queries.userFeatureFlip({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"})),(0,Ce.w)((([e,r,i])=>{if((0,v.hx)(e))throw new Error("Error accessing private collections");if((0,v.hx)(r))throw new Error("Error accessing current space info");if((0,v.hx)(i))throw new Error("Cannot retrieve FF for invite collection member command");const a=this.isCollectionsSharingEnabled((0,v.db)(r)),o=!!(0,v.d6)(i)&&!!(0,v.db)(i),n=(0,v.db)(e).collections.find((({id:e})=>e===t));if(n)return this.getPermissionsForPrivateCollection(n,a);const c=this.context.get(P.l.UserName);return o?this.sharingAccess.getUserRoleInCollectionGraphene$(t,s,c).pipe((0,ie.U)((e=>{const t=e===Z.Yt.Manager;return{canShare:a&&t,canEditRoles:t,canEdit:t,canDelete:t,role:e,sharingDisabledReason:a?Z.Hz.EditorRole:Z.Hz.DisabledInTAC}})),(0,Je.x)(Ze.shallowEqualObjects),(0,ie.U)(v.Vp)):this.sharingAccess.getUserRoleInCollectionCarbon$(t,s,c).pipe((0,ie.U)((e=>{const t=e===Z.Yt.Manager;return{canShare:a&&t,canEditRoles:t,canEdit:t,canDelete:t,role:e,sharingDisabledReason:a?Z.Hz.EditorRole:Z.Hz.DisabledInTAC}})),(0,Je.x)(Ze.shallowEqualObjects),(0,ie.U)(v.Vp))})))}getPermissionsForPrivateCollection(e,t){if(!t)return(0,ae.of)((0,v.Vp)({canShare:!1,canEditRoles:!0,canEdit:!0,canDelete:!0,role:Z.Yt.Manager,sharingDisabledReason:Z.Hz.DisabledInTAC}));const s=e.vaultItems.map((({id:e})=>e));return this.sharingAccess.canShareItems(s).pipe((0,ie.U)((e=>{if((0,v.hx)(e))throw new Error("Error checking if user can share a collection");const t=(0,v.db)(e);return{canShare:t,canEditRoles:!0,canEdit:!0,canDelete:!0,role:Z.Yt.Manager,sharingDisabledReason:t?void 0:Z.Hz.LimitedRightItems}})),(0,Je.x)(Ze.shallowEqualObjects),(0,ie.U)(v.Vp))}constructor(e,t,s,r,i){this.sharingAccess=e,this.vaultOrganization=t,this.currentSpace=s,this.context=r,this.featureFlips=i}}et=(0,r.__decorate)([(0,ve.e)(Xe.y),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ge?Object:ge,void 0===Te.C?Object:Te.C,void 0===Ke.n?Object:Ke.n,void 0===P.f?Object:P.f,void 0===N.P?Object:N.P])],et);var tt=s(41869);class st{execute({body:e}){const{collectionId:t,groupId:s}=e;return this.sharingAccess.getGroupRoleInCollection$(t,s).pipe((0,ie.U)((e=>(0,v.Vp)(e))))}constructor(e){this.sharingAccess=e}}st=(0,r.__decorate)([(0,ve.e)(tt.L),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===ge?Object:ge])],st);var rt=s(10829);class it{execute({body:e}){const{targetId:t}=e,{userFeatureFlip:s}=this.featureFlips.queries;return s({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"}).pipe((0,Ce.w)((e=>{if((0,v.hx)(e))throw new Error("Cannot retrieve FF for invite collection member command");return!!(0,v.d6)(e)&&!!(0,v.db)(e)?this.executeWithGrapheneState$(t):this.executeWithCarbonState$(t)})))}executeWithGrapheneState$(e){return this.userGroupsRepository.acceptedUserGroupIdsForLogin$(e).pipe((0,re.V)(this.store.state$),(0,ie.U)((([t,s])=>{const r=[],{collections:i,sharedCollectionsAccess:a}=s;for(const s in a){if(!a[s])continue;if(a[s].users.some((t=>t.name===e))){r.push(Ie(i[s]));continue}if(a[s].userGroups.some((t=>t.id===e))){r.push(Ie(i[s]));continue}a[s].userGroups.some((e=>t.includes(e.id)))&&r.push(Ie(i[s]))}return(0,v.Vp)({collections:r})})))}executeWithCarbonState$(e){return this.userGroupsRepository.acceptedUserGroupIdsForLogin$(e).pipe((0,re.V)(this.collectionsRepository.getCollections()),(0,ie.U)((([t,s])=>{const r=s.filter((s=>{const r=s.users?.some((t=>t.login===e));if(r)return!0;const i=s.userGroups,a=i?.some((t=>t.uuid===e));if(a)return!0;const o=i?.some((e=>t.includes(e.uuid)));return o}));return(0,v.Vp)({collections:r})})))}constructor(e,t,s,r){this.collectionsRepository=e,this.userGroupsRepository=t,this.featureFlips=s,this.store=r}}it=(0,r.__decorate)([(0,ve.e)(rt.Q),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===M.G?Object:M.G,void 0===j.x?Object:j.x,void 0===N.P?Object:N.P,void 0===me?Object:me])],it);var at=s(7134),ot=s(13575);const nt=e=>{if(!e.itemId||!e.sharedItemId)throw new Error("Corrupted item group");return{id:e.itemId,type:E.U.Credential}},ct=(e,t,s)=>{const r=((e,t,s)=>({name:e.name,id:e.uuid,spaceId:s,isShared:!0,vaultItems:t.filter((t=>t.recipientIds.collectionIds?.some((t=>t===e.uuid)))).map(nt)}))(e,t,s);if(ot.JQ.safeParse(r).success)return r;throw new Error("Failure to convert shared collection")};class dt{execute({body:e}){const{itemIds:t}=e;return this.collectionsRepository.collections$().pipe((0,re.V)(this.currentSpaceGetter.get(),this.sharingItemsClient.queries.getSharedItemsForItemIds({itemIds:t})),(0,ie.U)((([e,s,r])=>{if((0,v.hx)(s)||(0,v.hx)(r))throw new Error("Unable to access sharing data");const i=r.data.sharedItems,a=e.map((e=>ct(e,i,s.data.teamId))).flatMap((e=>e.vaultItems)),o=t.filter((e=>a.some((t=>t.id===e))));return(0,v.Vp)(o)})))}constructor(e,t,s){this.currentSpaceGetter=e,this.collectionsRepository=t,this.sharingItemsClient=s}}dt=(0,r.__decorate)([(0,ve.e)(at.q),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Ke.n?Object:Ke.n,void 0===M.G?Object:M.G,void 0===S.s?Object:S.s])],dt);var lt=s(34282);class ut{execute({body:e}){const t=e.collectionIds?e.collectionIds:[];return this.collectionsRepository.collections$().pipe((0,ie.U)((e=>(0,v.Vp)(e.filter((e=>!t.length||t.includes(e.uuid)))))))}constructor(e){this.collectionsRepository=e}}ut=(0,r.__decorate)([(0,ve.e)(lt.$),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===M.G?Object:M.G])],ut);class pt{execute(){return this.collectionsRepository.collections$().pipe((0,re.V)(this.currentSpaceGetter.get(),this.sharingItemsClient.queries.getSharedItems()),(0,ie.U)((([e,t,s])=>{if((0,v.hx)(t))throw new Error("Failed to load shared collections");if((0,v.hx)(s))throw new Error("Failed to load shared items data");return(0,v.Vp)(e.map((e=>ct(e,s.data.sharedItems,t.data.teamId))))})))}constructor(e,t,s){this.collectionsRepository=e,this.currentSpaceGetter=t,this.sharingItemsClient=s}}pt=(0,r.__decorate)([(0,ve.e)(ot.MO),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===M.G?Object:M.G,void 0===Ke.n?Object:Ke.n,void 0===S.s?Object:S.s])],pt);var ht=s(54665);class mt{execute({body:e}){const{collectionIds:t}=e;return this.collectionsRepository.usersAndGroupsInCollection(t)}constructor(e){this.collectionsRepository=e}}mt=(0,r.__decorate)([(0,ve.e)(ht.O),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===M.G?Object:M.G])],mt);var gt=s(13186),vt=s(75028),yt=s(14139),_t=s(41613);class St{}St=(0,r.__decorate)([(0,i.Yl)({api:a.a,stores:[me,c.C],providers:[m,O,ge,F,q.V,be,{provide:l,useClass:H},{provide:M.G,useClass:Ae},{provide:K.U,useClass:Re}],exports:[M.G,K.U],handlers:{commands:{addItemsToCollections:W,createSharedCollection:Pe,deleteSharedCollection:Ne,inviteCollectionMembers:Le,updateCollectionMembers:se,removeItemFromCollections:je,renameCollection:ze,revokeCollectionMembers:qe,updateSharedCollections:$e,updatePermissionForCollectionItem:we,moveCollectionItemsToBusinessSpace:He},events:{},queries:{getCollectionPermissionsForUser:et,getCollectionRoleForGroup:st,getCollectionsForUserOrGroup:it,getItemIdsInSharedCollections:dt,getSharedCollectionsCount:_e,getSharedCollections:ut,sharedCollectionsWithItems:pt,usersAndGroupsInCollection:mt}},imports:[o.n,n.D,vt.k,gt.I,yt.y,_t.u],requiredFeatureFlips:["sharing_web_invalidSignatureAutoRevoke_prod","monetization_extension_starterRepackagingCollection"]})],St)},63784:(e,t,s)=>{s.d(t,{C:()=>c});var r=s(63144),i=s(56618),a=s(62149),o=s(32336);const n=e=>o.cx.safeParse(e).success;class c extends((0,r.Q)({capacity:i.Y._010KB,persist:!1,scope:a.F.User,storeName:"collections-legacy-store",storeTypeGuard:n,initialValue:{sharedCollections:[]}})){}},54250:(e,t,s)=>{s.d(t,{x:()=>r});const r=async(e,t,s=5,r=10)=>{const i=e.length>=20?Math.ceil(e.length/r):s,a=[];for(let t=0;t<e.length;t+=i)a.push(e.slice(t,t+i));const o=a.map((e=>t(e)));return Promise.all(o)}},11819:(e,t,s)=>{s.d(t,{B:()=>a});var r=s(13252);const i=e=>{switch(e){case r.y2.Credential:return"AUTHENTIFIANT";case r.y2.Secret:return"SECRET";default:return"SECURENOTE"}},a=({domain:e,type:t})=>({captureLog:!0,domain:e,type:i(t)})},13186:(e,t,s)=>{s.d(t,{I:()=>A});var r=s(491),i=s(86006),a=s(60399),o=s(92587),n=s(53344),c=s(48844),d=s(87279),l=s(28489);const u=/[<>]/g;var p=s(98798);function h(e,t){const s=(0,p.B5)(e);return{type:s,name:t||`Untitled ${s}`}}const m=e=>e.map((({id:e,resourceKey:t,proposeSignature:s,proposeSignatureUsingAlias:r,acceptSignature:i,alias:a,permission:o})=>({userId:e,groupKey:t,proposeSignature:s,proposeSignatureUsingAlias:r,acceptSignature:i,alias:a,permission:o})));var g=s(27790),v=s(54250);class y{async getPublicKeysForUsers(e){const t=await(0,a.z)(this.serverApiClient.v1.sharingUserdevice.getUsersPublicKey({logins:e}).pipe((0,c.DZ)((()=>{throw new Error("Cannot get public keys of requested users.")})),(0,c.lk)((e=>(0,d.Vp)(e.data)))));if((0,d.hx)(t))throw new Error("Cannot get public keys of requested users.");return t.data.data.map((e=>{return{login:e.login??(t=e.email,t.trim().toLowerCase().replace(u,"")),publicKey:e.publicKey};var t}))}async createItemGroup({users:e,item:t,itemTitle:s,groupId:r}){const i=await(0,a.z)(this.serverApiClient.v1.sharingUserdevice.createItemGroup({groupId:r,items:[t],users:m(e),itemsForEmailing:[h(t.itemType,s)]}));if((0,d.hx)(i))throw new Error("Failed to create item group");const o=(0,d.db)(i).data.itemGroups?.find((e=>e.groupId===r));if(!o)throw new Error("Error creating item group");return o}async createMultipleItemGroups(e){const t=(await(0,v.x)(e,(async e=>{const t=e.map((({users:e,item:t,itemTitle:s,groupId:r})=>({groupId:r,items:[t],users:m(e),itemsForEmailing:[h(t.itemType,s)]}))),s=await(0,a.z)(this.serverApiClient.v1.sharingUserdevice.createMultipleItemGroups({itemgroups:t}));if((0,d.hx)(s))throw new Error("Failed to create item groups.");return(0,d.db)(s)}))).reduce(((e,t)=>({itemGroups:e.itemGroups.concat(t.data.itemGroups??[]),itemGroupErrors:e.itemGroupErrors.concat(t.data.itemGroupErrors??[])})),(0,l.Ay)({itemGroups:[],itemGroupErrors:[]}));if(t.itemGroupErrors.length)throw new Error("Failed to create some of multiple item groups");if(!t.itemGroups.length)throw new Error("No item groups have been created");return t.itemGroups}async updateItemGroupMembers(e){const{groupId:t,revision:s,users:r,groups:i,collections:o}=e,n=await(0,a.z)(this.serverApiClient.v1.sharingUserdevice.updateItemGroupMembers({groupId:t,revision:s,collections:o,groups:i,users:r}));if((0,d.hx)(n)){if("BusinessError"===n.error.tag&&n.error.code===g.wI)return(0,d.Rn)((0,g.ge)());throw new Error("Updating members of item groups have failed")}const c=(0,d.db)(n).data;return(0,d.Vp)(c.itemGroups)}async revokeItemGroupMembers(e){const{itemGroupId:t,revision:s,userLogins:r,collectionIds:i,userGroupIds:o}=e,n=await(0,a.z)(this.serverApiClient.v1.sharingUserdevice.revokeItemGroupMembers({groupId:t,revision:s,collections:i,users:r,groups:o}));if((0,d.hx)(n)){if("BusinessError"===n.error.tag&&n.error.code===g.wI)return(0,d.Rn)((0,g.ge)());throw new Error("Revoking members of item groups have failed")}const c=(0,d.db)(n).data;return(0,d.Vp)(c.itemGroups)}async refuseItemGroup(e){const{itemGroupId:t,revision:s}=e,r=await(0,a.z)(this.serverApiClient.v1.sharingUserdevice.refuseItemGroup({groupId:t,revision:s}));if((0,d.hx)(r))throw new Error("Refusing item group have failed");const i=(0,d.db)(r).data;if(!i.itemGroups?.length)throw new Error("No members of item groups have been revoked");if(i.itemGroupErrors?.length)throw new Error("Revoking of some members of item groups failed");return i.itemGroups}async deleteItemGroup(e){const{groupId:t,revision:s}=e,r=await(0,a.z)(this.serverApiClient.v1.sharingUserdevice.deleteItemGroup({groupId:t,revision:s}));if((0,d.hx)(r))throw new Error("Failed to delete item group");return(0,d.Vp)(void 0)}constructor(e){this.serverApiClient=e}}y=(0,r.__decorate)([(0,o.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===n.l?Object:n.l])],y);var _=s(40217),S=s(80629),f=s(85337),w=s(6554),I=s(41511),b=s(75028),E=s(41613),C=s(14139);class A{}A=(0,r.__decorate)([(0,i.Yl)({sharedModuleName:"sharing-common",providers:[_.k,S.D,f.o,w.E,{provide:g.b_,useClass:y}],exports:[_.k,S.D,f.o,w.E,g.b_],imports:[E.u,b.k,I.n,C.y]})],A)},40217:(e,t,s)=>{s.d(t,{k:()=>p});var r=s(491),i=s(92587),a=s(10370),o=s(13252),n=s(50436),c=s(99291),d=s(6554),l=s(27790),u=s(98798);class p{async prepareCreateItemGroupModel(e){const t=(0,n.R)(),s=await this.sharingCrypto.createResourceKey(),r=await this.sharingUsers.createSignedUserInvites([],{resourceKey:s,uuid:t}),i=await this.sharingCrypto.createResourceKey(),o=await this.sharingCrypto.encryptSecureData(s,i),c=await this.sharingCrypto.encryptSharingItem(i,e);return{groupId:t,item:{itemId:e.Id,itemType:(0,u.l7)(e),itemKey:(0,a.s)(o),content:(0,a.s)(c)},itemTitle:e.Title,users:r}}convertToSharedItem(e){const t=e.items?.[0];if(!t)throw new Error("Newly created item group is missing an item");const s=e.users?.[0];if(!s)throw new Error("Newly created item group is missing an admin");const{itemKey:r,itemId:i}=t;if(!s.groupKey)throw new Error("Newly created item group is missing a resource key");return{isLastAdmin:!0,sharedItemId:e.groupId,itemKey:r,itemId:i,accessLink:{accessType:o.Uv.User,encryptedResourceKey:s.groupKey,permission:o.y3.Admin},recipientIds:{userIds:[s.userId],collectionIds:null,userGroupIds:null},permission:o.y3.Admin,revision:e.revision}}async createItemGroup(e){const t=await this.prepareCreateItemGroupModel(e);return this.sharingApi.createItemGroup(t)}async createMultipleItemGroups(e){const t=await Promise.all(e.map((e=>this.prepareCreateItemGroupModel(e))));return(await this.sharingApi.createMultipleItemGroups(t)).map(this.convertToSharedItem)}constructor(e,t,s){this.sharingApi=e,this.sharingCrypto=t,this.sharingUsers=s}}p=(0,r.__decorate)([(0,i.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===l.b_?Object:l.b_,void 0===c.O?Object:c.O,void 0===d.E?Object:d.E])],p)},80629:(e,t,s)=>{s.d(t,{D:()=>u});var r=s(491),i=s(87279),a=s(60399),o=s(41842),n=s(92587),c=s(90993),d=s(4174),l=s(50756);class u{async scheduleSync(){const{commands:e}=this.syncClient;return await this.waitOnSyncToFinish(),await e.sync({trigger:l.Trigger.Sharing}),(0,i.Vp)(void 0)}async runSync(){return await this.scheduleSync(),await this.waitOnSyncToFinish(),(0,i.Vp)(void 0)}waitOnSyncToFinish(){return(0,a.z)(this.syncClient.queries.syncProgress().pipe((0,o.h)(i.d6),(0,o.h)((e=>e.data.status!==c.L.IN_PROGRESS))))}constructor(e){this.syncClient=e}}u=(0,r.__decorate)([(0,n.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===d.Q?Object:d.Q])],u)},85337:(e,t,s)=>{s.d(t,{o:()=>u});var r=s(491),i=s(28489),a=s(92587),o=s(13252),n=s(89720),c=s(99291),d=s(71996),l=s(35635);class u{async createSignedUserGroupInvites(e,t){return(await this.createSignedUserGroupInvitesPerResource(e,[t]))[t.uuid]}async createSignedUserGroupInvitesPerResource(e,t){const s=await this.getUserGroupsWithKeys(e),r=await Promise.all(t.map((async e=>{const t=await Promise.all(s.map((t=>this.createInvite(t,e))));return{resource:e,invites:t}}))),i={};return r.forEach((({resource:e,invites:t})=>{i[e.uuid]=t})),i}async getUserGroupsWithKeys(e){const t=await this.currentUserGetter.getCurrentUserWithKeys(),s=await this.userGroupsRepository.getUserGroupsForIds(e.map((e=>e.groupId)));return Promise.all(s.map((async s=>{const r=e.find((e=>e.groupId===s.groupId))?.permission??o.y3.Limited,i=s.groupKey;if(!i)throw new Error("Unable to get encrypted user group key.");const a=await this.sharingCrypto.decryptResourceKeyToClearText(t.privateKey,s.privateKey,i);return{permission:r,groupId:s.groupId,publicKey:s.publicKey,clearUserGroupPrivateKey:a}})))}async createInvite(e,t){const{groupId:s,publicKey:r,clearUserGroupPrivateKey:a,permission:o}=e,{proposeSignature:n,acceptSignature:c,resourceKey:d}=await this.sharingInvitesCrypto.createSignedInvite(s,t,r,a);if(!d)throw new Error("Could not create resource key when generating user group invite for shared item");return(0,i.Ay)({permission:o,proposeSignature:n,acceptSignature:c,id:s,resourceKey:d})}constructor(e,t,s,r){this.userGroupsRepository=e,this.sharingCrypto=t,this.sharingInvitesCrypto=s,this.currentUserGetter=r}}u=(0,r.__decorate)([(0,a.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===n.x?Object:n.x,void 0===c.O?Object:c.O,void 0===d.h?Object:d.h,void 0===l.a?Object:l.a])],u)},6554:(e,t,s)=>{s.d(t,{E:()=>d});var r=s(491),i=s(92587),a=s(13252),o=s(27790),n=s(71996),c=s(35635);class d{async createSignedUserInvites(e,t,s=!0){const r=e.length?await this.sharingGateway.getPublicKeysForUsers(e.map((e=>e.login))):[],i=await this.currentUserGetter.getCurrentUserWithKeys(),o=[...s?[{login:i.login,publicKey:i.publicKey,permission:a.y3.Admin}]:[],...r.map((t=>({...t,permission:e.find((e=>e.login===t.login))?.permission??a.y3.Limited})))];return Promise.all(o.map((e=>this.createInvite(e,t,i))))}async createSignedUserInvitesPerResource(e,t){const s=e.length?await this.sharingGateway.getPublicKeysForUsers(e.map((e=>e.login))):[],r=s.map((e=>e.login)),i=e.filter((e=>!r.includes(e.login))).map((({login:e})=>({login:e,publicKey:null}))),o=[...s,...i].map((t=>({...t,permission:e.find((e=>e.login===t.login))?.permission??a.y3.Limited}))),n=await Promise.all(t.map((async e=>{const t=await Promise.all(o.map((t=>this.createInvite(t,e))));return{resource:e,invites:t}}))),c={};return n.forEach((({resource:e,invites:t})=>{c[e.uuid]=t})),c}async createInvite(e,t,s){const r=s?.login===e.login;return{...await this.invitesCryptoService.createSignedInvite(e.login,t,e.publicKey,r?s.privateKey:void 0),id:e.login,alias:e.login,permission:r?a.y3.Admin:e.permission}}constructor(e,t,s){this.currentUserGetter=e,this.invitesCryptoService=t,this.sharingGateway=s}}d=(0,r.__decorate)([(0,i.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===c.a?Object:c.a,void 0===n.h?Object:n.h,void 0===o.b_?Object:o.b_])],d)},27790:(e,t,s)=>{s.d(t,{b_:()=>o,ge:()=>a,wI:()=>i});var r=s(96168);const i="INVALID_ITEM_GROUP_REVISION",a=(0,r.Vj)(i,"Invalid revision when trying to update item group member");class o{}},75028:(e,t,s)=>{s.d(t,{k:()=>u});var r=s(491),i=s(86006),a=s(99291),o=s(44801),n=s(71996),c=s(16624),d=s(14139),l=s(41613);class u{}u=(0,r.__decorate)([(0,i.Yl)({sharedModuleName:"sharing-crypto",providers:[a.O,o.c,n.h],exports:[a.O,o.c,n.h],imports:[d.y,c.D,l.u]})],u)},99291:(e,t,s)=>{s.d(t,{O:()=>C});var r=s(491),i=s(92587),a=s(81929),o=s(36041),n=s(48702),c=s(60679),d=s(14260),l=s(61805),u=s(49504),p=s(92698),h=s(15996),m=s(10370),g=s(54066),v=s(86286),y=s(9034),_=s(83168),S=s(4761),f=s(7502),w=s(89685),I=s(87279),b=s(14122),E=s(92324);class C{async createResourceKey(){return await this.keyGeneratorAes256.generate()}async encryptSecureData(e,t){return await this.kwc5Encryptor.encrypt(e,t)}async decryptSecureData(e,t){return await this.kwc5Decryptor.decrypt(e,t)}async createProposeSignature(e,t){const s=await this.hmacSigner.sign(e,t);return(0,m.s)(s)}async createRecipientKeyPair(e){const{publicKey:t,privateKey:s}=await this.rsaKeyPairGenerator.generate(),r=(0,g.u)((0,v.R)(s)),i=await this.encryptSecureData(e,r);return{publicKey:(0,y.y)(t),privateKey:(0,m.s)(i)}}async createAcceptSignature(e,t,s){const r=`${t}-accepted-${(0,m.s)(s)}`,i=(0,g.u)(r),a=await this.rsaSigner.sign((0,_.B)(e),i);return(0,m.s)(a)}async verifyAcceptSignature(e,t,s,r){const i=`${s}-accepted-${(0,m.s)(r)}`,a=(0,g.u)(i);return await this.rsaVerifier.verify((0,S.M)(e),(0,f.R)(t),a)}async encryptResourceKey(e,t){return await this.rsaEncryptor.encrypt(e,t)}async decryptResourceKey(e,t){return await this.rsaDecryptor.decrypt(e,t)}async decryptResourceKeyToClearText(e,t,s){const r=await this.decryptResourceKey((0,_.B)(e),(0,f.R)(s)),i=await this.decryptSecureData(r,(0,f.R)(t));return(0,w.v)(i)}async encryptSharingItem(e,t){const{commands:{carbon:s}}=this.client,r=await s({name:"convertItemToDashlaneXml",args:[{item:t}]}),i=(a=r,(0,I.hx)(a)||"string"!=typeof a.data.carbonResult.xml?null:a.data.carbonResult.xml);var a;if(""===i||null===i)throw new Error("Unable to convert item to XML");const o=(0,E.w)(i);return await this.encryptSecureData(e,o)}async decryptContentAndConvertXMLToVaultItem(e,t){const s=(0,f.R)(t),r=await this.decryptSecureData(e,s),i=(0,E.Q)(r),a=await this.client.commands.convertDashlaneXmlToItem({xml:i});if((0,I.hx)(a))return null;const o=(0,I.db)(a);return o.success?o.item:null}async decryptEncapsulatedPrivateKey(e,t,s){const r=await this.decryptResourceKey(e,(0,f.R)(t)),i=await this.decryptSecureData(r,(0,f.R)(s));return(0,_.B)((0,w.v)(i))}constructor(e,t,s,r,i,a,o,n,c,d){this.client=e,this.hmacSigner=t,this.keyGeneratorAes256=s,this.rsaKeyPairGenerator=r,this.kwc5Decryptor=i,this.kwc5Encryptor=a,this.rsaDecryptor=o,this.rsaEncryptor=n,this.rsaSigner=c,this.rsaVerifier=d}}C=(0,r.__decorate)([(0,i.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===b._?Object:b._,void 0===a.q?Object:a.q,void 0===o.c?Object:o.c,void 0===n.e?Object:n.e,void 0===c.$?Object:c.$,void 0===d.o?Object:d.o,void 0===l.g?Object:l.g,void 0===u.H?Object:u.H,void 0===p.k?Object:p.k,void 0===h.u?Object:h.u])],C)},44801:(e,t,s)=>{s.d(t,{c:()=>h});var r=s(491),i=s(92587),a=s(63877),o=s(7502),n=s(83168),c=s(13252),d=s(99291),l=s(89720),u=s(78262),p=s(35635);class h{async decryptItemGroupKey(e){const t=await this.currentUserGetter.getCurrentUserWithKeys(),{accessLink:s}=e;return this.decryptItemGroupKeyFromAccessLink(s,t)}async decryptItemGroupKeyFromAccessLink(e,t){return e?.accessType===c.Uv.User?this.decryptResourceKeyViaUserMember(e,t):e?.accessType===c.Uv.UserGroup?this.decryptViaGroupMember(e,t):e?.accessType===c.Uv.CollectionUser?this.decryptViaCollectionUserMember(e,t):e?.accessType===c.Uv.CollectionUserGroup?this.decryptViaCollectionUserGroupMember(e,t):null}async decryptSharedItemContent(e,t){try{const s=await this.decryptItemGroupKey(e);if(!s)return null;const r=await this.sharingCrypto.decryptSecureData(s,(0,o.R)(e.itemKey));return await this.sharingCrypto.decryptContentAndConvertXMLToVaultItem(r,t)}catch(e){return null}}async decryptSharedCollectionKey(e,t){const{accessLink:s}=e;return s?.accessType===u.o.User?this.decryptResourceKeyViaUserMember(s,t):s?.accessType===u.o.UserGroup?this.decryptViaGroupMember(s,t):void 0}async decryptSharedCollectionKeyForCurrentUser(e){const t=await this.currentUserGetter.getCurrentUserWithKeys();return this.decryptSharedCollectionKey(e,t)}async decryptResourceKeyViaUserMember(e,t){try{return await this.sharingCrypto.decryptResourceKey((0,n.B)(t.privateKey),(0,o.R)(e.encryptedResourceKey))}catch{return null}}async decryptUserGroupKey(e,t){return this.sharingCrypto.decryptResourceKey((0,n.B)(e.privateKey),(0,o.R)(t))}async decryptViaGroupMember(e,t){const{encryptedResourceKey:s,groupEncryptedKey:r,groupPrivateKey:i}=e;if(!r||!i)return null;try{const e=await this.sharingCrypto.decryptEncapsulatedPrivateKey((0,n.B)(t.privateKey),r,i);return await this.sharingCrypto.decryptResourceKey(e,(0,o.R)(s))}catch(e){return null}}async decryptViaCollectionUserMember(e,t){const{encryptedResourceKey:s,collectionEncryptedKey:r,collectionPrivateKey:i}=e;if(!r||!i)return null;const a=await this.sharingCrypto.decryptEncapsulatedPrivateKey((0,n.B)(t.privateKey),r,i);return await this.sharingCrypto.decryptResourceKey(a,(0,o.R)(s))}async decryptViaCollectionUserGroupMember(e,t){const{encryptedResourceKey:s,collectionEncryptedKey:r,collectionPrivateKey:i,groupEncryptedKey:a,groupPrivateKey:c}=e;if(!(r&&i&&a&&c))return null;const d=await this.sharingCrypto.decryptEncapsulatedPrivateKey((0,n.B)(t.privateKey),a,c),l=await this.sharingCrypto.decryptEncapsulatedPrivateKey(d,r,i);return await this.sharingCrypto.decryptResourceKey(l,(0,o.R)(s))}async decryptCollectionKey(e,t=a.qb.Accepted){const s=await this.currentUserGetter.getCurrentUserWithKeys(),r=e.users?.find((e=>e.login===s.login&&e.status===t&&e.collectionKey));if(r?.collectionKey)return await this.decryptCollectionKeyViaUserMember(r,s);const i=Object.values(await this.userGroupsRepository.getUserGroups()).filter((e=>e.users.some((e=>e.userId===s.login&&e.status===a.qb.Accepted&&e.groupKey))||e.groupKey&&e.acceptedUsers?.some((e=>e===s.login)))),o=e.userGroups?.find((e=>i.some((t=>t.groupId===e.uuid))&&e.status===t&&e.collectionKey));return o?.collectionKey?await this.decryptCollectionKeyViaGroupMember(o,s,i):null}async decryptCollectionKeyViaUserMember(e,t){if(!e.collectionKey)return null;try{return await this.sharingCrypto.decryptResourceKey((0,n.B)(t.privateKey),(0,o.R)(e.collectionKey))}catch{return null}}async decryptCollectionKeyViaGroupMember(e,t,s){if(!e.collectionKey)return null;try{const r=s.find((({groupId:t})=>t===e.uuid));if(!r?.groupKey)return null;const i=await this.sharingCrypto.decryptEncapsulatedPrivateKey((0,n.B)(t.privateKey),r.groupKey,r.privateKey);return await this.sharingCrypto.decryptResourceKey(i,(0,o.R)(e.collectionKey))}catch{return null}}constructor(e,t,s){this.sharingCrypto=e,this.currentUserGetter=t,this.userGroupsRepository=s}}h=(0,r.__decorate)([(0,i.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===d.O?Object:d.O,void 0===p.a?Object:p.a,void 0===l.x?Object:l.x])],h)},71996:(e,t,s)=>{s.d(t,{h:()=>d});var r=s(491),i=s(92587),a=s(4761),o=s(10370),n=s(54066),c=s(99291);class d{async createSignedInvite(e,t,s,r){const i=s?await this.sharingCrypto.encryptResourceKey((0,a.M)(s),t.resourceKey):void 0,c=i?(0,o.s)(i):void 0,d=(0,n.u)(e);return{proposeSignature:await this.sharingCrypto.createProposeSignature(t.resourceKey,d),acceptSignature:r?await this.sharingCrypto.createAcceptSignature(r,t.uuid,t.resourceKey):void 0,resourceKey:c,proposeSignatureUsingAlias:!s}}constructor(e){this.sharingCrypto=e}}d=(0,r.__decorate)([(0,i.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===c.O?Object:c.O])],d)},82181:(e,t,s)=>{s.d(t,{o:()=>r});const r=e=>{if(!e)return!1;const t=e;return!!t.pendingItemGroups&&!!t.pendingUserGroups}},76403:(e,t,s)=>{s.d(t,{p:()=>Ne});var r=s(491),i=s(86006),a=s(95940),o=s(41511),n=s(16624),c=s(7165),d=s(63144),l=s(56618),u=s(62149),p=s(11797);const h=c.z.object({pendingCollections:c.z.array(p.MX)}),m=e=>h.safeParse(e).success;class g extends((0,d.Q)({capacity:l.Y._010KB,persist:!1,scope:u.F.User,storeName:"pending-shared-collections-state",storeTypeGuard:m,initialValue:{pendingCollections:[]}})){}var v=s(41393),y=s(60141),_=s(14474),S=s(66717),f=s(60399),w=s(87065),I=s(92587),b=s(48844),E=s(87279),C=s(44449);class A{async getSharedItemContentLegacy(e){const t=this.inviteGetter.get().pipe((0,b.Qn)((t=>{const s=t.pendingItemGroups.find((t=>t.itemGroupId===e));if(!s)throw new Error("Pending item group not found when accepting/refusing invite");if(s.items.length<1)throw new Error("Missing item content for pending item group when accepting/refusing invite");return s.items[0]}))),s=await(0,f.z)(t);if((0,E.hx)(s))throw new Error("Failed to retrieve item content for pending item group when accepting/refusing invite");return s.data}async getSharedItemContent(e){const t=this.store.state$.pipe((0,w.U)((t=>{const s=t.find((t=>t.sharedItemId===e));if(!s)throw new Error("Pending item group not found when accepting/refusing invite");return s})));return(0,f.z)(t)}constructor(e,t){this.inviteGetter=e,this.store=t}}A=(0,r.__decorate)([(0,I.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===C.V?Object:C.V,void 0===y.f?Object:y.f])],A);var R=s(82874),T=s(53344),O=s(27122),D=s(63877),U=s(89720),F=s(44801),P=s(35635),x=s(99291),N=s(80629);class G{async execute({body:e}){const{userGroupId:t}=e,s=await this.userGroupsRepository.getUserGroupForId(t),r=await this.currentUserGetter.getCurrentUserWithKeys(),i=s.groupKey;if(!i)throw new Error("Unable to get user group key");const a=await this.sharingDecryption.decryptUserGroupKey(r,i),o=await this.sharingCrypto.createAcceptSignature(r.privateKey,t,a);return await(0,f.z)(this.serverApiClient.v1.sharingUserdevice.acceptUserGroup({acceptSignature:o,groupId:t,provisioningMethod:D.ET.USER,revision:s.revision})),await this.sharingSync.scheduleSync(),(0,E.Vp)(void 0)}constructor(e,t,s,r,i,a){this.serverApiClient=e,this.sharingDecryption=t,this.currentUserGetter=s,this.sharingCrypto=r,this.sharingSync=i,this.userGroupsRepository=a}}G=(0,r.__decorate)([(0,R.W)(O.Q),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.l?Object:T.l,void 0===F.c?Object:F.c,void 0===P.a?Object:P.a,void 0===x.O?Object:x.O,void 0===N.D?Object:N.D,void 0===U.x?Object:U.x])],G);var k=s(43651),L=s(6489),M=s(64549),K=s(5482);class j{async execute(e){const{body:{collectionId:t}}=e,{userFeatureFlip:s}=this.featureFlips.queries,r=await(0,f.z)(s({featureFlip:L.d.SharingSyncGrapheneMigrationDev})),i=!!(0,E.d6)(r)&&!!(0,E.db)(r),a=await this.currentUserGetter.getCurrentUserWithKeys(),{collectionKey:o,revision:n}=i?await this.getCollectionKeyAndRevisionNew(t,a):await this.getCollectionKeyAndRevisionLegacy(t),c=await this.sharingCrypto.createAcceptSignature(a.privateKey,t,o),d=await(0,f.z)(this.serverApiClient.v1.sharingUserdevice.acceptCollection({collectionUUID:t,revision:n,acceptSignature:c}));return(0,E.hx)(d)?(0,E.Rn)(new M.nu):(await this.sharingSync.scheduleSync(),(0,E.Vp)(void 0))}async getCollectionKeyAndRevisionNew(e,t){const s=await this.collectionsRepository.getCollectionsById([e]);if(!s.length)throw new Error("Pending Collection not found new path");const r=await this.sharingDecryption.decryptSharedCollectionKey(s[0],t);if(!r)throw new Error("Unable to decrypt Collection Key for pending collection new path");return{collectionKey:r,revision:s[0].revision}}async getCollectionKeyAndRevisionLegacy(e){const t=(await this.oldStore.getState()).pendingCollections.find((({uuid:t})=>t===e));if(!t)throw new Error("Pending Collection not found legacy path");const s=await this.sharingDecryption.decryptCollectionKey(t,D.qb.Pending);if(!s)throw new Error("Unable to decrypt Collection Key for pending collection legacy path");return{collectionKey:s,revision:t.revision}}constructor(e,t,s,r,i,a,o,n){this.serverApiClient=e,this.sharingCrypto=t,this.sharingDecryption=s,this.oldStore=r,this.collectionsRepository=i,this.sharingSync=a,this.currentUserGetter=o,this.featureFlips=n}}j=(0,r.__decorate)([(0,R.W)(M.cD),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.l?Object:T.l,void 0===x.O?Object:x.O,void 0===F.c?Object:F.c,void 0===g?Object:g,void 0===K.U?Object:K.U,void 0===N.D?Object:N.D,void 0===P.a?Object:P.a,void 0===k.P?Object:k.P])],j);var V=s(83405),z=s(98798);const W=e=>{const t=(0,z.l7)(e);return{type:(0,z.B5)(t),name:e.Title}},q=e=>({type:e.itemType,name:e.title});var B=s(50520),$=s(93986);class Y{async execute(e){const{userFeatureFlip:t}=this.featureFlips.queries,s=await(0,f.z)(t({featureFlip:L.d.SharingSyncGrapheneMigrationDev}));return!!(0,E.d6)(s)&&!!(0,E.db)(s)?this.executeWithNewState(e):this.executeWithCarbonState(e)}async executeWithCarbonState({body:e}){const{itemGroupId:t}=e,s=await(0,f.z)(this.itemGroupsGetter.getForItemGroupId(t));if((0,E.hx)(s))throw new Error("Error fetching item groups when trying to accept shared item");const r=(0,E.db)(s);if(!r)throw new Error("Item group not found");const i=await this.currentUserGetter.getCurrentUserWithKeys(),a=r.users?.find((e=>e.userId===i.login));if(!a?.groupKey)throw new Error("Item group key not found");const o=await this.sharingDecryption.decryptResourceKeyViaUserMember({encryptedResourceKey:a.groupKey},i);if(!o)throw new Error("Failed to decrypt item group key");const n=await this.sharingCrypto.createAcceptSignature(i.privateKey,t,o),c=await this.sharedItemContent.getSharedItemContentLegacy(t);return await(0,f.z)(this.serverApiClient.v1.sharingUserdevice.acceptItemGroup({acceptSignature:n,groupId:t,revision:r.revision,itemsForEmailing:[W(c)]})),await this.sharingSync.scheduleSync(),(0,E.Vp)(void 0)}async executeWithNewState({body:e}){const{itemGroupId:t}=e,s=(await this.sharedItemsRepository.getSharedItemsIndex())[t];if(!s)throw new Error("Item group not found");const r=await this.currentUserGetter.getCurrentUserWithKeys(),i=await this.sharingDecryption.decryptItemGroupKey(s);if(!i)throw new Error("Failed to decrypt item group key");const a=await this.sharingCrypto.createAcceptSignature(r.privateKey,t,i),o=await this.sharedItemContent.getSharedItemContent(t);return await(0,f.z)(this.serverApiClient.v1.sharingUserdevice.acceptItemGroup({acceptSignature:a,groupId:t,revision:s.revision,itemsForEmailing:[q(o)]})),await this.sharingSync.scheduleSync(),(0,E.Vp)(void 0)}constructor(e,t,s,r,i,a,o,n,c){this.serverApiClient=e,this.itemGroupsGetter=t,this.sharedItemsRepository=s,this.sharingDecryption=r,this.currentUserGetter=i,this.sharingCrypto=a,this.sharingSync=o,this.sharedItemContent=n,this.featureFlips=c}}Y=(0,r.__decorate)([(0,R.W)(V.C),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.l?Object:T.l,void 0===$.E?Object:$.E,void 0===B.z?Object:B.z,void 0===F.c?Object:F.c,void 0===P.a?Object:P.a,void 0===x.O?Object:x.O,void 0===N.D?Object:N.D,void 0===A?Object:A,void 0===k.P?Object:k.P])],Y);var Q=s(37210);class H{async execute(e){const{body:{collectionId:t}}=e,s=(await this.pendingCollectionsStore.getState()).pendingCollections.find((({uuid:e})=>e===t));if(!s)throw new Error("Pending Collection not found");const r=await(0,f.z)(this.serverApiClient.v1.sharingUserdevice.refuseCollection({collectionUUID:t,revision:s.revision}));return(0,E.hx)(r)?(0,E.Rn)(new Q.R$):(0,E.Vp)(void 0)}constructor(e,t){this.serverApiClient=e,this.pendingCollectionsStore=t}}H=(0,r.__decorate)([(0,R.W)(Q.UC),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.l?Object:T.l,void 0===g?Object:g])],H);var J=s(82567),Z=s(14122),X=s(51571),ee=s(96500),te=s(13134),se=s(13252);const re=e=>(e.spaces??[]).filter((e=>"accepted"===e.status));class ie{async execute(e){const{userFeatureFlip:t}=this.featureFlips.queries,s=await(0,f.z)(t({featureFlip:L.d.SharingSyncGrapheneMigrationDev}));return!!(0,E.d6)(s)&&!!(0,E.db)(s)?this.executeWithGrapheneState(e):this.executeWithCarbonState(e)}async executeWithGrapheneState(e){const{body:{itemGroupId:t}}=e,s=(await this.sharedItemsRepository.getSharedItemsIndex())[t];if(!s)throw new Error("Shared item not found while refusing invite");const r=await this.sharedItemContent.getSharedItemContent(t),i=await this.prepareAuditLogDetails(r);return await(0,f.z)(this.serverApiClient.v1.sharingUserdevice.refuseItemGroup({groupId:t,revision:s.revision,itemsForEmailing:[q(r)],auditLogDetails:i})),await this.sharingSync.scheduleSync(),(0,E.Vp)(void 0)}async executeWithCarbonState(e){const{body:{itemGroupId:t}}=e,s=await(0,f.z)(this.itemGroupsGetter.getForItemGroupId(t));if((0,E.hx)(s))throw new Error("Failed to retrieve item group for pending item group with");const r=(0,E.db)(s);if(void 0===r)return(0,E.Rn)(new X.fL);const i=await this.sharedItemContent.getSharedItemContentLegacy(t),a=await this.prepareAuditLogDetailsLegacy(i);return(0,f.z)(this.serverApiClient.v1.sharingUserdevice.refuseItemGroup({groupId:r.groupId,revision:r.revision,itemsForEmailing:[W(i)],auditLogDetails:a}).pipe((0,b.DZ)((e=>{if("BusinessError"===e.tag)return(0,X.fr)(e.code);throw new Error(e.message)})),(0,b.lk)((e=>{if(void 0===e.data.itemGroupErrors||0===e.data.itemGroupErrors.length)return(0,E.Vp)(void 0);if(e.data.itemGroupErrors.length>0)throw new Error("Error when refusing an item group invite");throw new Error("Unknown server error")})),(0,J.b)((async e=>{(0,E.d6)(e)&&await this.sharingSync.scheduleSync()}))))}async prepareAuditLogDetails(e){const{queries:{carbonState:t}}=this.carbonLegacyClient,s=t({path:"userSession.localSettings.premiumStatus"}).pipe((0,b.Qn)((e=>{const t=re(e);return t.length?t[0]:void 0}))),r=await(0,f.z)(s);if((0,E.hx)(r))return;const i=(0,E.db)(r)?.info.collectSensitiveDataAuditLogsEnabled;return i?((e,t)=>{const s=!!t.spaceId&&e;let r;if(t.itemType===se.y2.Credential){const e={...t,itemType:se.y2.Credential};r=new te.Y(e.url).getRootDomain()||""}const i=(0,z.HU)(t.itemType);return s?{captureLog:s,domain:r,type:i}:void 0})(i,e):void 0}async prepareAuditLogDetailsLegacy(e){const{queries:{carbonState:t}}=this.carbonLegacyClient,s=t({path:"userSession.localSettings.premiumStatus"}).pipe((0,b.Qn)((e=>re(e)[0]))),{userFeatureFlips:r}=this.featureFlips.queries,i=await(0,f.z)(r().pipe((0,b.Qn)((e=>e.audit_logs_sharing&&e.send_activity_log))));if(!(!!(0,E.d6)(i)&&(i.data??!1)))return;const a=await(0,f.z)(s);if((0,E.hx)(a))return;const o=(0,E.db)(a)?.info.collectSensitiveDataAuditLogsEnabled;return o?((e,t)=>{const s=!!t?.SpaceId&&e,r=t&&(0,ee.G)(t),i=r?new te.Y(t.Url).getRootDomain():"",a=r?i||"":void 0,o=(0,z.l7)(t);return s?{captureLog:s,domain:a,type:o}:void 0})(o,e):void 0}constructor(e,t,s,r,i,a,o){this.carbonLegacyClient=e,this.serverApiClient=t,this.sharedItemContent=s,this.sharedItemsRepository=r,this.itemGroupsGetter=i,this.featureFlips=a,this.sharingSync=o}}ie=(0,r.__decorate)([(0,R.W)(X.gm),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Z._?Object:Z._,void 0===T.l?Object:T.l,void 0===A?Object:A,void 0===B.z?Object:B.z,void 0===$.E?Object:$.E,void 0===k.P?Object:k.P,void 0===N.D?Object:N.D])],ie);var ae=s(11050);class oe{async execute(e){const{body:{userGroupId:t}}=e,s=await this.userGroupsRepository.getUserGroupForId(t),{groupId:r,revision:i}=s;return await(0,f.z)(this.serverApiClient.v1.sharingUserdevice.refuseUserGroup({groupId:r,revision:i,provisioningMethod:D.ET.USER}).pipe((0,b.DZ)((e=>{if("BusinessError"===e.tag)return(0,ae.cz)(e.code);throw new Error(e.message)})),(0,b.lk)((e=>{if(void 0===e.data.userGroupErrors||0===e.data.userGroupErrors.length)return(0,E.Vp)(void 0);if(e.data.userGroupErrors.length>0)throw new Error(`Error for user group ${e.data.userGroupErrors[0].groupId}: ${e.data.userGroupErrors[0].message}`);throw new Error("Unknown server error")})),(0,J.b)((async e=>{(0,E.d6)(e)&&await this.sharingSync.scheduleSync()}))))}constructor(e,t,s){this.serverApiClient=e,this.userGroupsRepository=t,this.sharingSync=s}}oe=(0,r.__decorate)([(0,R.W)(ae.Fo),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===T.l?Object:T.l,void 0===U.x?Object:U.x,void 0===N.D?Object:N.D])],oe);var ne=s(16712),ce=s(97675);class de{execute({body:e}){const t=e,s=this.getCurrentUserLogin(),r=t.filter((e=>(e.users||[]).some((e=>e.login===s&&e.status===se.qb.Pending))));return this.store.set({pendingCollections:r}),Promise.resolve((0,E.Vp)(void 0))}getCurrentUserLogin(){return this.context.get(ne.l.UserName)}constructor(e,t){this.store=e,this.context=t}}de=(0,r.__decorate)([(0,R.W)(ce.r),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===g?Object:g,void 0===ne.f?Object:ne.f])],de);var le=s(16433),ue=s(43978),pe=s(85390),he=s(46449),me=s(57885),ge=s(69956);const ve=e=>void 0!==e.referrer&&void 0!==e.permission,ye=(e,t)=>e.map((e=>{const s=(e.users||[]).find((e=>e.login===t&&e.status===se.qb.Pending));return{uuid:e.uuid,name:e.name,referrer:s?.referrer,permission:s?.permission}})).filter(ve),_e=e=>"admin"===e.permission?se.y3.Admin:se.y3.Limited,Se=e=>{const t={vaultItemId:e.items[0].Id,title:e.items[0].Title,spaceId:e.items[0].SpaceId,referrer:e.referrer,sharedItemId:e.itemGroupId,permission:_e(e),revision:0},s=e.items[0];return(0,ee.G)(s)?{...t,itemType:se.y2.Credential,url:s.Url,linkedDomains:s.LinkedServices?.associated_domains.map((e=>e.domain)),email:s.Email,login:s.Login,secondaryLogin:s.SecondaryLogin}:(0,ge.gi)(s)?{...t,itemType:se.y2.SecureNote,color:s.Type,secured:s.Secured}:{...t,itemType:se.y2.Secret,secured:s.Secured}},fe=e=>({id:e.groupId,name:e.name,referrer:e.referrer,permission:_e(e)}),we=e=>({id:e.uuid,name:e.name,referrer:e.referrer,permission:_e(e)});class Ie{execute(){const{userFeatureFlip:e}=this.featureFlips.queries;return e({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"}).pipe((0,le.q)(1),(0,ue.w)((e=>!!(0,E.d6)(e)&&!!(0,E.db)(e)?this.executeWithNewState$():this.executeWithCarbonState$())))}executeWithNewState$(){return(0,pe.a)([this.pendingUserGroupsStore.state$,this.pendingCollectionsStore.state$,this.pendingItemsStore.state$]).pipe((0,w.U)((([e,t,s])=>(0,E.Vp)({pendingSharedItems:s,pendingUserGroups:e,pendingCollections:t}))))}executeWithCarbonState$(){const e=this.inviteGetter.get(),t=this.store.state$,s=this.getCurrentUserLogin();return(0,pe.a)([e,t]).pipe((0,w.U)((([e,t])=>{const r=(0,E.d6)(e)?e.data:{pendingItemGroups:[],pendingUserGroups:[]},i=s?ye(t.pendingCollections,s):[];return(0,E.Vp)({pendingSharedItems:r.pendingItemGroups.map(Se),pendingUserGroups:r.pendingUserGroups.map(fe),pendingCollections:i.map(we)})})))}getCurrentUserLogin(){return this.context.get(ne.l.UserName)}constructor(e,t,s,r,i,a,o){this.inviteGetter=e,this.store=t,this.context=s,this.featureFlips=r,this.pendingUserGroupsStore=i,this.pendingItemsStore=a,this.pendingCollectionsStore=o}}Ie=(0,r.__decorate)([(0,he.e)(me.q),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===C.V?Object:C.V,void 0===g?Object:g,void 0===ne.f?Object:ne.f,void 0===k.P?Object:k.P,void 0===_.t?Object:_.t,void 0===y.f?Object:y.f,void 0===v.K?Object:v.K])],Ie);var be=s(5650);class Ee{execute(){const e=this.getCurrentUserLogin();if(void 0===e)throw new Error("Unable to get pending collections, user login not found");return this.store.state$.pipe((0,w.U)((t=>{const s=ye(t.pendingCollections,e);return(0,E.Vp)(s)})))}getCurrentUserLogin(){return this.context.get(ne.l.UserName)}constructor(e,t){this.store=e,this.context=t}}Ee=(0,r.__decorate)([(0,he.e)(be.D),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===g?Object:g,void 0===ne.f?Object:ne.f])],Ee);var Ce=s(6136),Ae=s(71763),Re=s(82181);class Te{execute(){const{userFeatureFlip:e}=this.featureFlips.queries;return e({featureFlip:L.d.SharingSyncGrapheneMigrationDev}).pipe((0,le.q)(1),(0,ue.w)((e=>!!(0,E.d6)(e)&&!!(0,E.db)(e)?this.executeWithNewState$():this.executeWithCarbonState$())))}executeWithNewState$(){const e=this.pendingItemsStore.state$,t=this.pendingUserGroupsStore.state$,s=this.pendingCollectionInvitesStore.state$;return(0,pe.a)([s,e,t]).pipe((0,w.U)((([e,t,s])=>{const r=e.length>0,i=t.length>0,a=s.length>0;return r||i||a})),(0,Ce.x)(),(0,w.U)(E.Vp))}executeWithCarbonState$(){const{queries:{carbonState:e}}=this.carbonLegacyClient,t=e({path:"userSession.sharingSync"}).pipe((0,b.Qn)((e=>{if(!(0,Re.o)(e))throw new Error("Bad SharingSync format");return e}))),s=this.pendingCollectionsStore.state$;return(0,pe.a)([t,s]).pipe((0,w.U)((([e,t])=>{const s=(0,E.d6)(e)?e.data:{pendingItemGroups:[],pendingUserGroups:[]},r=s.pendingItemGroups.length>0,i=s.pendingUserGroups.length>0,a=t.pendingCollections.length>0;return r||i||a})),(0,Ce.x)(),(0,w.U)(E.Vp))}constructor(e,t,s,r,i,a){this.carbonLegacyClient=e,this.pendingCollectionsStore=t,this.pendingCollectionInvitesStore=s,this.pendingItemsStore=r,this.pendingUserGroupsStore=i,this.featureFlips=a}}Te=(0,r.__decorate)([(0,he.e)(Ae._),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===Z._?Object:Z._,void 0===g?Object:g,void 0===v.K?Object:v.K,void 0===y.f?Object:y.f,void 0===_.t?Object:_.t,void 0===k.P?Object:k.P])],Te);var Oe=s(36093),De=s(75028),Ue=s(13186),Fe=s(14139),Pe=s(41613),xe=s(64222);class Ne{}Ne=(0,r.__decorate)([(0,i.Yl)({api:a.t,stores:[g,v.K,y.f,_.t],handlers:{commands:{acceptUserGroupInvite:G,acceptCollectionInvite:j,acceptSharedItemInvite:Y,refuseCollectionInvite:H,refuseItemGroupInvite:ie,refuseUserGroupInvite:oe,updatePendingCollections:de},events:{},queries:{getInvites:Ie,getPendingCollections:Ee,hasInvites:Te}},imports:[o.n,n.D,De.k,Ue.I,Fe.y,Pe.u,Oe.F,xe.a],providers:[S.M,A],exports:[S.M],requiredFeatureFlips:["audit_logs_sharing","send_activity_log"]})],Ne)},66717:(e,t,s)=>{s.d(t,{M:()=>c});var r=s(491),i=s(92587),a=s(41393),o=s(60141),n=s(14474);class c{setCollectionInvites(e){this.collectionsStore.set(e)}setUserGroupInvites(e){this.userGroupssStore.set(e)}setSharedItemInvites(e){this.itemsStore.set(e)}getSharedItemsInvites(){return this.itemsStore.getState()}constructor(e,t,s){this.collectionsStore=e,this.userGroupssStore=t,this.itemsStore=s}}c=(0,r.__decorate)([(0,i.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===a.K?Object:a.K,void 0===n.t?Object:n.t,void 0===o.f?Object:o.f])],c)},41393:(e,t,s)=>{s.d(t,{K:()=>u});var r=s(7165),i=s(18091),a=s(63144),o=s(56618),n=s(62149),c=s(10722);const d=r.z.array(i.ju),l=e=>d.safeParse(e).success;class u extends((0,a.Q)({persist:!0,storage:{initialValue:[],typeGuard:l,schemaVersion:1},scope:n.F.User,storeName:"pending-collection-invites-state",storeTypeGuard:l,codec:c.E,isCache:!0,capacity:o.Y.Unlimited})){}},60141:(e,t,s)=>{s.d(t,{f:()=>u});var r=s(7165),i=s(18091),a=s(63144),o=s(56618),n=s(62149),c=s(10722);const d=r.z.array(i.jd),l=e=>d.safeParse(e).success;class u extends((0,a.Q)({persist:!0,storage:{initialValue:[],typeGuard:l,schemaVersion:1},scope:n.F.User,storeName:"pending-shared-items-invites-state",storeTypeGuard:l,codec:c.E,isCache:!0,capacity:o.Y.Unlimited})){}},14474:(e,t,s)=>{s.d(t,{t:()=>u});var r=s(7165),i=s(18091),a=s(63144),o=s(56618),n=s(62149),c=s(10722);const d=r.z.array(i.ju),l=e=>d.safeParse(e).success;class u extends((0,a.Q)({persist:!0,storage:{initialValue:[],typeGuard:l,schemaVersion:1},scope:n.F.User,storeName:"pending-user-group-invites-state",storeTypeGuard:l,codec:c.E,isCache:!0,capacity:o.Y.Unlimited})){}},11047:(e,t,s)=>{s.d(t,{K4:()=>l,t9:()=>u,$h:()=>d});var r=s(13252),i=s(92936);const a=(e,t)=>e?.filter((e=>t.some((t=>t.uuid===e.uuid))&&e.status===r.qb.Accepted&&e.itemGroupKey)),o=(...e)=>e.find((e=>e?.link))??e[0],n=({permission:e,status:t})=>e===r.y3.Admin&&t===r.qb.Accepted,c=(e,t,s,c)=>{const d=((e,t)=>{const s=e.users?.filter((e=>e.userId===t&&e.status===r.qb.Accepted&&e.groupKey)),a=e.users?.some((({userId:e,permission:s,rsaStatus:i,status:a})=>e!==t&&s===r.y3.Admin&&"sharingKeys"===i&&a===r.qb.Accepted))??!1;if(s?.length){const e=s[0];if(e.groupKey){const{permission:t,acceptSignature:o,proposeSignature:n}=e;return{link:{permission:t,acceptSignature:o,proposeSignature:n,encryptedResourceKey:e.groupKey,accessType:r.Uv.User},permission:(0,i.u)(s),otherAdminsFound:a}}}return{permission:r.y3.Limited,otherAdminsFound:a}})(e,t),l=Boolean(d?.otherAdminsFound)||Boolean(e.groups?.some(n))||Boolean(e.collections?.some(n));if(null!==d&&d.permission===r.y3.Admin)return{...d,otherAdminsFound:l};const u=s.filter((e=>e.users.some((e=>e.userId===t&&e.status===r.qb.Accepted&&!e.proposeSignatureUsingAlias&&e.groupKey)))),p=((e,t,s)=>{const a=e.groups?.filter((e=>s.some((t=>t.groupId===e.groupId))&&e.status===r.qb.Accepted&&e.groupKey));if(a?.length){const e=a[0],o=(0,i.u)(a);if(e.groupKey){const{permission:i,acceptSignature:a,proposeSignature:n}=e,c=s.find((t=>t.groupId===e.groupId)),d=c?.users.find((e=>e.userId===t));if(d?.groupKey)return{link:{permission:i,acceptSignature:a,proposeSignature:n,encryptedResourceKey:e.groupKey,groupEncryptedKey:d.groupKey,groupPrivateKey:c?.privateKey,groupPublicKey:c?.publicKey,accessType:r.Uv.UserGroup},permission:o}}}return null})(e,t,u);if(null!==p&&p.permission===r.y3.Admin)return{...o(d,p),permission:r.y3.Admin,otherAdminsFound:l};const h=((e,t,s)=>{const o=s.filter((e=>e.users?.some((e=>e.login===t&&e.status===r.qb.Accepted&&!e.proposeSignatureUsingAlias&&e.collectionKey)))),n=a(e.collections,o);if(n?.length){const e=n[0],s=(0,i.u)(n);if(e.itemGroupKey){const{permission:i,acceptSignature:a,proposeSignature:n}=e,c=o.find((t=>t.uuid===e.uuid)),d=c?.users?.find((e=>e.login===t));if(d&&c&&c.privateKey&&d.collectionKey)return{link:{permission:i,acceptSignature:a,proposeSignature:n,encryptedResourceKey:e.itemGroupKey,collectionEncryptedKey:d.collectionKey,collectionPrivateKey:c.privateKey,collectionPublicKey:c.publicKey,accessType:r.Uv.CollectionUser},permission:s}}}return null})(e,t,c);if(null!==h&&h.permission===r.y3.Admin)return{...o(d,p,h),permission:r.y3.Admin,otherAdminsFound:l};const m=((e,t,s,o)=>{const n=o.filter((e=>e.userGroups?.some((e=>s.some((t=>t.groupId===e.uuid))&&e.status===r.qb.Accepted&&e.collectionKey)))),c=a(e.collections,n);if(c?.length){const e=c[0],a=(0,i.u)(c);if(e.itemGroupKey){const{permission:i,acceptSignature:o,proposeSignature:c}=e,d=n.find((t=>t.uuid===e.uuid)),l=d?.userGroups?.find((e=>s.some((t=>t.groupId===e.uuid))));if(!l)return null;const u=s.find((({groupId:e})=>e===l.uuid)),p=u?.users.find((({userId:e})=>e===t));if(l.collectionKey&&d&&p?.groupKey)return{link:{permission:i,acceptSignature:o,proposeSignature:c,encryptedResourceKey:e.itemGroupKey,collectionEncryptedKey:l.collectionKey,collectionPrivateKey:d.privateKey,collectionPublicKey:d.publicKey,groupPrivateKey:u?.privateKey,groupEncryptedKey:p.groupKey,accessType:r.Uv.CollectionUserGroup},permission:a}}}return null})(e,t,u,c);return{...o(d,p,h,m),permission:m?.permission??r.y3.Limited,otherAdminsFound:l}},d=(e,t,s,i)=>{const{link:a,permission:o,otherAdminsFound:n}=c(e,i,t,s);if(!a)throw new Error("No access to a requested shared item");const{items:d,revision:l,groupId:u,groups:p,collections:h,users:m}=e,g=d?.[0];if(!g)throw new Error("No items associated with item group");const{itemId:v,itemKey:y}=g;return{permission:o,accessLink:a,itemId:v,itemKey:y,sharedItemId:u,revision:l,isLastAdmin:o===r.y3.Admin&&!n,recipientIds:{userIds:m?.map((({userId:e})=>e))??null,collectionIds:h?.map((({uuid:e})=>e))??null,userGroupIds:p?.map((({groupId:e})=>e))??null}}},l=e=>({users:e.users?.map((e=>({id:e.userId,name:e.alias,permission:e.permission,status:e.status})))??[],userGroups:e.groups?.map((e=>({id:e.groupId,name:e.name,permission:e.permission,status:e.status})))??[],collections:e.collections?.map((e=>({id:e.uuid,name:e.name,permission:e.permission,status:e.status})))??[]}),u=(e,t)=>({permission:e.permission,status:e.status,recipientId:e.id,recipientName:e.name,recipientType:t})},50520:(e,t,s)=>{s.d(t,{z:()=>r});class r{}},36093:(e,t,s)=>{s.d(t,{F:()=>Pt});var r,i=s(491),a=s(86006),o=s(41511),n=s(61582),c=s(23122),d=s(50520);!function(e){e.SHARED_ITEM_IS_NOT_FOUND="ITEM_GROUP_IS_NOT_FOUND",e.INSUFFICIENT_PERMISSION_PRIVILEGES="INSUFFICIENT_PERMISSION_PRIVILEGES",e.INVALID_REVISION="INVALID_ITEM_GROUP_REVISION",e.NOT_A_MEMBER_CANNOT_SHARE_WITH_USER_GROUP="NOT_A_MEMBER_CANNOT_SHARE_WITH_USER_GROUP",e.SHARING_DISABLED_BY_TEAM="SHARING_DISABLED_BY_TEAM",e.USER_IS_NOT_MEMBER_OF_TEAM="USER_IS_NOT_MEMBER_OF_TEAM",e.SERVER_ERROR="SERVER_ERROR"}(r||(r={}));class l{}var u=s(92587),p=s(53344),h=s(60399);const m=e=>e.map((({id:e,resourceKey:t,proposeSignature:s,proposeSignatureUsingAlias:r,acceptSignature:i,alias:a,permission:o})=>({...t?{}:{proposeSignatureUsingAlias:!0},userId:e,groupKey:t,proposeSignature:s,proposeSignatureUsingAlias:r,acceptSignature:i,alias:a,permission:o}))),g=e=>e.map((({id:e,resourceKey:t,proposeSignature:s,acceptSignature:r,permission:i})=>({groupId:e,groupKey:t,proposeSignature:s,acceptSignature:r,permission:i}))),v=(e,t)=>({type:t,name:e||`Untitled ${t}`});var y=s(87279),_=s(28489),S=s(54250),f=s(11819);class w{async inviteMultipleItemGroupsMembers(e){const t=await(0,S.x)(e,(async e=>{const t=e.map((({sharedItem:e,users:t,userGroups:s})=>{const{sharedItemId:r,revision:i,auditLogData:a,itemType:o,title:n}=e;return{groupId:r,revision:i,users:t?.length?m(t):void 0,groups:s?.length?g(s):void 0,auditLogDetails:a?(0,f.B)(a):void 0,itemsForEmailing:[v(n,o)]}})),s=await(0,h.z)(this.serverApiClient.v1.sharingUserdevice.inviteMultipleItemGroupMembers({itemgroups:t}));if((0,y.hx)(s))throw new Error("Failed to add members to item group");return(0,y.db)(s)})),s=t.reduce(((e,t)=>({itemGroups:e.itemGroups.concat(t.data.itemGroups??[]),itemGroupErrors:e.itemGroupErrors.concat(t.data.itemGroupErrors??[])})),(0,_.Ay)({itemGroups:[],itemGroupErrors:[]})),r=s.itemGroupErrors.map((({groupId:e,message:t})=>({sharedItemId:e,error:this.mapServerError(t),revision:s.itemGroups.find((t=>t.groupId===e))?.revision})));return(0,y.Vp)({errors:r})}mapServerError(e){switch(e){case r.USER_IS_NOT_MEMBER_OF_TEAM:return r.USER_IS_NOT_MEMBER_OF_TEAM;case r.INSUFFICIENT_PERMISSION_PRIVILEGES:return r.INSUFFICIENT_PERMISSION_PRIVILEGES;case r.NOT_A_MEMBER_CANNOT_SHARE_WITH_USER_GROUP:return r.NOT_A_MEMBER_CANNOT_SHARE_WITH_USER_GROUP;case r.SHARED_ITEM_IS_NOT_FOUND:return r.SHARED_ITEM_IS_NOT_FOUND;case r.INVALID_REVISION:return r.INVALID_REVISION;case r.SHARING_DISABLED_BY_TEAM:return r.SHARING_DISABLED_BY_TEAM;default:return r.SERVER_ERROR}}constructor(e){this.serverApiClient=e}}w=(0,i.__decorate)([(0,u.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===p.l?Object:p.l])],w);var I=s(30309),b=s(13134),E=s(32725),C=s(13252);const A=e=>{switch(e){case r.SHARED_ITEM_IS_NOT_FOUND:return E.z.ITEM_DOESNT_EXIST;case r.INVALID_REVISION:return E.z.INVALID_REVISION;default:return E.z.SHARING_FAILED}},R=(e,t,s)=>{const r=s.find((e=>e.Id===t));if(!r)throw new Error("Vault item not found when trying to share");const{Id:i,kwType:a,Title:o}=r,n={id:i,title:o,error:A(e)};if(a===I.dJ.KWAuthentifiant){const e=r,t=new b.Y(e.Url).getRootDomain();return{...n,type:C.y2.Credential,domain:t,text:e.Email||e.Login}}return a===I.dJ.KWSecureNote?{...n,type:C.y2.SecureNote,color:r.Type}:{...n,type:C.y2.Secret}},T=(e,t)=>{const s=t.find((t=>t.Id===e.itemId));if(!s)throw new Error("Vault item not found when trying to share");const{kwType:r}=s,i=r===I.dJ.KWAuthentifiant?C.y2.Credential:r===I.dJ.KWSecureNote?C.y2.SecureNote:C.y2.Secret,a=r===I.dJ.KWAuthentifiant?new b.Y(s.Url).getRootDomain():void 0,o=i===C.y2.Credential?{type:i,domain:a}:void 0;return{itemType:i,sharedItemId:e.sharedItemId,revision:e.revision,title:s.Title,auditLogData:o}};var O=s(44801),D=s(85337),U=s(6554);class F{async inviteRecipients(e,t,s,r,i){const a=(await this.createItemsInvites(s,e.map((e=>({login:e,permission:i}))),t.map((e=>({groupId:e,permission:i}))))).map((({sharedItem:e,users:t,userGroups:s})=>({sharedItem:T(e,r),users:t,userGroups:s}))),o=await this.sharingItemsGateway.inviteMultipleItemGroupsMembers(a);if((0,y.hx)(o))throw new Error("Server error when sharing items");return(0,y.db)(o).errors?.map((({error:e,sharedItemId:t})=>{const i=s.find((e=>e.sharedItemId===t));if(!i)throw new Error("Error when creating invite params for sharing an item");return R(e,i.itemId,r)}))??[]}async createItemsInvites(e,t,s){const r=await Promise.all(e.map((async e=>{const t=await this.sharingDecryption.decryptItemGroupKey(e);if(null===t)throw new Error("Unable to decrypt item group key");return{resourceKey:t,uuid:e.sharedItemId}}))),i=await this.sharingUsers.createSignedUserInvitesPerResource(t,r),a=await this.sharingUserGroups.createSignedUserGroupInvitesPerResource(s,r);return e.map((e=>({sharedItem:e,users:i[e.sharedItemId],userGroups:a[e.sharedItemId]})))}constructor(e,t,s,r){this.sharingItemsGateway=e,this.sharingDecryption=t,this.sharingUserGroups=s,this.sharingUsers=r}}F=(0,i.__decorate)([(0,u.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===l?Object:l,void 0===O.c?Object:O.c,void 0===D.o?Object:D.o,void 0===U.E?Object:U.E])],F);var P=s(63144),x=s(62149);class N extends((0,P.Q)({storeName:"share-items-errors-state",scope:x.F.User,persist:!1,initialValue:{hasErrors:!1}})){}var G=s(87065),k=s(43978),L=s(69885),M=s(6136),K=s(57452);class j{get(){return this.currentSpaceGetter.get().pipe((0,G.U)((e=>{if((0,y.hx)(e))throw new Error("Problem retrieving current space information to assess sharing capacity");return(0,y.db)(e).sharedItemsLimit})),(0,k.w)((e=>void 0===e?(0,L.of)(!0):this.sharedItemsRepository.sharedItems$().pipe((0,G.U)((e=>e.length)),(0,M.x)(),(0,G.U)((t=>e-t))))))}constructor(e,t){this.currentSpaceGetter=e,this.sharedItemsRepository=t}}j=(0,i.__decorate)([(0,u.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===K.n?Object:K.n,void 0===d.z?Object:d.z])],j);var V=s(51612),z=s(523),W=s(22952);class q{async get(e){const t=await this.credentialsGetter.getCarbonCredentialsByItemIds(e),{notes:s,notesErrors:r}=await this.getSharableNotes(e);return{credentials:t,notes:s,notesErrors:r,secrets:await this.secretsGetter.getCarbonSecretsByItemIds(e)}}async getSharableNotes(e){return(await this.notesGetter.getCarbonNotesByItemIds(e)).reduce(((e,t)=>(t.Attachments?.length?e.notesErrors.push((e=>{const{Id:t,Title:s}=e;return{id:t,title:s,error:E.z.ITEM_HAS_ATTACHMENTS,type:C.y2.SecureNote,color:e.Type}})(t)):e.notes.push(t),e)),{notes:(0,_.Ay)([]),notesErrors:(0,_.Ay)([])})}constructor(e,t,s){this.credentialsGetter=e,this.notesGetter=t,this.secretsGetter=s}}q=(0,i.__decorate)([(0,u.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===V.J?Object:V.J,void 0===z.H?Object:z.H,void 0===W.F?Object:W.F])],q);var B=s(40217);class ${async run(e){const{vaultItemIds:t,permission:s,userLogins:r,userGroupIds:i}=e,{credentials:a,secrets:o,notes:n,notesErrors:c}=await this.shareableItems.get(t),d=[...n,...a,...o],{alreadySharedItems:l,alreadySharedItemsErrors:u,alreadySharedItemIds:p}=await(0,h.z)(this.getAlreadySharedItems(d,t)),m=d.filter((e=>!p.includes(e.Id))),g=[...l,...m.length?await this.sharingItemsService.createMultipleItemGroups(m):[]],v=[...c,...u,...g.length?await this.sharingItemsInvitesService.inviteRecipients(r,i,g,d,s):[]];return{hasChanges:g.length>0,errors:v}}getAlreadySharedItems(e,t){return this.sharedItemsRepository.sharedItemsForIds$(t).pipe((0,G.U)((t=>t.reduce(((t,s)=>(s.permission===C.y3.Limited?t.alreadySharedItemsErrors.push(((e,t)=>R(r.INSUFFICIENT_PERMISSION_PRIVILEGES,e,t))(s.itemId,e)):t.alreadySharedItems.push(s),t.alreadySharedItemIds.push(s.itemId),t)),{alreadySharedItems:(0,_.Ay)([]),alreadySharedItemsErrors:(0,_.Ay)([]),alreadySharedItemIds:(0,_.Ay)([])}))))}constructor(e,t,s,r){this.sharingItemsInvitesService=e,this.sharingItemsService=t,this.sharedItemsRepository=s,this.shareableItems=r}}$=(0,i.__decorate)([(0,u.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===F?Object:F,void 0===B.k?Object:B.k,void 0===d.z?Object:d.z,void 0===q?Object:q])],$);var Y=s(7165),Q=s(56618),H=s(10722),J=s(88981);const Z=Y.z.object({sharedItemId:Y.z.string(),vaultItemId:Y.z.string(),revision:Y.z.number(),savedToVault:Y.z.boolean().optional()}),X=Y.z.object({indexPerVaultItemId:Y.z.record(Z),sharedItems:Y.z.record(J.m$),sharedAccess:Y.z.record(J.Im)}),ee=e=>X.safeParse(e).success;class te extends((0,P.Q)({persist:!0,storage:{initialValue:{indexPerVaultItemId:{},sharedItems:{},sharedAccess:{}},typeGuard:ee,schemaVersion:3,migrateStorageSchema:()=>({indexPerVaultItemId:{},sharedItems:{},sharedAccess:{}})},scope:x.F.User,storeName:"shared-items-state",storeTypeGuard:ee,codec:H.E,isCache:!0,capacity:Q.Y.Unlimited})){}var se=s(162),re=s(43651),ie=s(6489);class ae{async getVaultItemsIndex(){const{indexPerVaultItemId:e}=await this.store.getState();return e}async getSharedItemsIndex(){const{sharedItems:e}=await this.store.getState();return e}async setSharedItems(e,t){if(!e||!t)return void this.store.set({indexPerVaultItemId:{},sharedItems:{},sharedAccess:{}});const s=await this.store.getState();await this.store.set(e.reduce(((e,{sharedItem:r,revision:i})=>(e.sharedItems[r.sharedItemId]=r,e.indexPerVaultItemId[r.itemId]={sharedItemId:r.sharedItemId,vaultItemId:r.itemId,revision:i},e.sharedAccess[r.sharedItemId]=t[r.sharedItemId]??s.sharedAccess[r.sharedItemId],e)),(0,_.Ay)({sharedItems:{},indexPerVaultItemId:{},sharedAccess:{}})))}sharedItems$(){return this.store.state$.pipe((0,G.U)((({sharedItems:e})=>Object.values(e))))}sharedItemsForIds$(e){return this.store.state$.pipe((0,G.U)((({sharedItems:t,indexPerVaultItemId:s})=>e.reduce(((e,r)=>{const i=s[r];if(i){const s=t[i.sharedItemId];s&&e.push(s)}return e}),(0,_.Ay)([])))))}sharedItemForId$(e){return this.store.state$.pipe((0,G.U)((({sharedItems:t,indexPerVaultItemId:s})=>s[e]?t[s[e].sharedItemId]:null)))}sharedAccess$(){return this.store.state$.pipe((0,G.U)((({sharedAccess:e})=>Object.values(e))))}sharedAccessForId$(e){return this.store.state$.pipe((0,G.U)((({sharedAccess:t,indexPerVaultItemId:s})=>{const r=s[e];if(!r)return null;const i=r.sharedItemId;return{sharedItemId:i,...t[i]}})))}sharedAccessForIds$(e){return this.store.state$.pipe((0,G.U)((({sharedAccess:t,indexPerVaultItemId:s})=>e.reduce(((e,r)=>{const i=s[r];if(i){const s=t[i.sharedItemId];s&&e.push(s)}return e}),(0,_.Ay)([])))))}constructor(e){this.store=e}}ae=(0,i.__decorate)([(0,u.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===te?Object:te])],ae);var oe=s(61076),ne=s(14122),ce=s(11047),de=s(93986),le=s(74929),ue=s(71275);const pe=(e,t,s,r)=>e.reduce(((e,i)=>{if("items"===i.type)try{const a=(0,ce.$h)(i,t,s,r);e.push(a)}catch(e){}return e}),(0,_.Ay)([])),he=(e,t,s,r)=>{if(!e)return null;try{return(0,ce.$h)(e,t,s,r)}catch(e){return null}};class me{userId$(){const{queries:{carbonState:e}}=this.carbonLegacyClient;return e({path:"state.userSession.account.login"}).pipe((0,G.U)((e=>{if((0,y.d6)(e)&&"string"==typeof e.data)return e.data;throw new Error("No active login")})))}combineWithCollectionsAndUserGroups(e,t){return e.pipe((0,oe.V)(this.userGroupsGetter.getCarbonUserGroups$(),this.collectionsRepository.collections$(),this.userId$()),(0,G.U)((([e,s,r,i])=>{if((0,y.hx)(e))throw new Error("Error when retrieving item groups");return t((0,y.db)(e),s,r,i)})))}sharedItems$(){return this.combineWithCollectionsAndUserGroups(this.itemGroupsGetter.get(),pe)}sharedItemsForIds$(e){return this.combineWithCollectionsAndUserGroups(this.itemGroupsGetter.getForItemsIds(e),pe)}sharedItemForId$(e){return this.combineWithCollectionsAndUserGroups(this.itemGroupsGetter.getForItemId(e),he)}sharedAccess$(){return this.itemGroupsGetter.get().pipe((0,G.U)((e=>{if((0,y.hx)(e))throw new Error("Error when retrieving item groups for shared access");return(0,y.db)(e).map((e=>(0,ce.K4)(e)))})))}sharedAccessForId$(e){return this.combineWithCollectionsAndUserGroups(this.itemGroupsGetter.getForItemId(e),(e=>e?{sharedItemId:e.groupId,...(0,ce.K4)(e)}:null))}sharedAccessForIds$(e){return this.itemGroupsGetter.getForItemsIds(e).pipe((0,G.U)((e=>{if((0,y.hx)(e))throw new Error("Cannot get shared access for items");return(0,y.db)(e).map((e=>(0,ce.K4)(e)))})))}getSharedItemsIndex(){return Promise.reject(new Error("not supported"))}getVaultItemsIndex(){return Promise.reject(new Error("not supported"))}async setSharedItems(){throw new Error("not supported")}constructor(e,t,s,r){this.itemGroupsGetter=e,this.userGroupsGetter=t,this.collectionsRepository=s,this.carbonLegacyClient=r}}me=(0,i.__decorate)([(0,u.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===de.E?Object:de.E,void 0===le.B?Object:le.B,void 0===ue.G?Object:ue.G,void 0===ne._?Object:ne._])],me);class ge{sharedItems$(){return(0,se.D)(this.getRepo()).pipe((0,k.w)((e=>e.sharedItems$())))}sharedItemForId$(e){return(0,se.D)(this.getRepo()).pipe((0,k.w)((t=>t.sharedItemForId$(e))))}sharedItemsForIds$(e){return(0,se.D)(this.getRepo()).pipe((0,k.w)((t=>t.sharedItemsForIds$(e))))}sharedAccess$(){return(0,se.D)(this.getRepo()).pipe((0,k.w)((e=>e.sharedAccess$())))}sharedAccessForId$(e){return(0,se.D)(this.getRepo()).pipe((0,k.w)((t=>t.sharedAccessForId$(e))))}sharedAccessForIds$(e){return(0,se.D)(this.getRepo()).pipe((0,k.w)((t=>t.sharedAccessForIds$(e))))}async getSharedItemsIndex(){return(await this.getRepo()).getSharedItemsIndex()}async getRepo(){const{userFeatureFlip:e}=this.featureFlips.queries,t=await(0,h.z)(e({featureFlip:ie.d.SharingSyncGrapheneMigrationDev}));return(0,y.hx)(t)?this.legacyRepo:(0,y.db)(t)?this.repo:this.legacyRepo}async getVaultItemsIndex(){return(await this.getRepo()).getVaultItemsIndex()}async setSharedItems(e,t){return(await this.getRepo()).setSharedItems(e,t)}constructor(e,t,s){this.repo=e,this.legacyRepo=t,this.featureFlips=s}}ge=(0,i.__decorate)([(0,u.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===ae?Object:ae,void 0===me?Object:me,void 0===re.P?Object:re.P])],ge);class ve{async refuseSharedItem(e){const t=await(0,h.z)(this.sharedItemRepository.sharedItemForId$(e));if(!t)throw new Error("Failed to retrieve shared item to refuse");await(0,h.z)(this.serverApiClient.v1.sharingUserdevice.refuseItemGroup({groupId:t.sharedItemId,revision:t.revision}))}constructor(e,t){this.serverApiClient=e,this.sharedItemRepository=t}}ve=(0,i.__decorate)([(0,u.GS)(),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===p.l?Object:p.l,void 0===d.z?Object:d.z])],ve);var ye=s(82874),_e=s(2741),Se=s(27790),fe=s(80629);class we{async execute({body:e}){const{sharedItemId:t,revision:s,users:r,groups:i}=await this.getItemGroup(e),a=await this.commonGateway.updateItemGroupMembers({groupId:t,revision:s,users:r,groups:i});if((0,y.hx)(a)){if(a.error.tag===Se.wI){await this.sharingSync.scheduleSync();const{sharedItemId:t,revision:s}=await this.getItemGroup(e);return await this.commonGateway.updateItemGroupMembers({groupId:t,revision:s,users:r,groups:i}),(0,y.Vp)(void 0)}throw new Error("Revoke shared item failed after retry attempt")}return await this.sharingSync.scheduleSync(),(0,y.Vp)(void 0)}async getItemGroup(e){const{vaultItemId:t,recipient:s,permission:r}=e,i=await(0,h.z)(this.sharedItemRepository.sharedItemForId$(t));if(!i)throw new Error("Failed to retrieve item group to revoke share item");const{sharedItemId:a,revision:o}=i;return{sharedItemId:a,revision:o,users:s.type===C.IP.User?[{userId:s.alias,permission:r}]:void 0,groups:s.type===C.IP.Group?[{groupId:s.groupId,permission:r}]:void 0}}constructor(e,t,s){this.sharingSync=e,this.commonGateway=t,this.sharedItemRepository=s}}we=(0,i.__decorate)([(0,ye.W)(_e.W),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===fe.D?Object:fe.D,void 0===Se.b_?Object:Se.b_,void 0===d.z?Object:d.z])],we);var Ie=s(98721);class be{async execute({body:e}){const{revision:t,itemGroupId:s,userLogins:r,userGroupIds:i}=await this.getItemGroup(e),a=await this.commonGateway.revokeItemGroupMembers({revision:t,itemGroupId:s,userLogins:r,userGroupIds:i});if((0,y.hx)(a)){if(a.error.tag===Se.wI){await this.sharingSync.scheduleSync();const{revision:t,itemGroupId:s}=await this.getItemGroup(e);return await this.commonGateway.revokeItemGroupMembers({revision:t,itemGroupId:s,userLogins:r,userGroupIds:i}),(0,y.Vp)(void 0)}throw new Error("Revoke shared item failed after retry attempt")}return await this.sharingSync.scheduleSync(),(0,y.Vp)(void 0)}async getItemGroup(e){const{vaultItemId:t,recipient:s}=e,r=await(0,h.z)(this.sharedItemRepository.sharedItemForId$(t));if(!r)throw new Error("Failed to retrieve item group to revoke share item");const{sharedItemId:i,revision:a}=r;return{revision:a,itemGroupId:i,userLogins:s.type===C.IP.User?[s.alias]:void 0,userGroupIds:s.type===C.IP.Group?[s.groupId]:void 0}}constructor(e,t,s){this.sharingSync=e,this.commonGateway=t,this.sharedItemRepository=s}}be=(0,i.__decorate)([(0,ye.W)(Ie.V),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===fe.D?Object:fe.D,void 0===Se.b_?Object:Se.b_,void 0===d.z?Object:d.z])],be);var Ee=s(24701);class Ce{async execute({body:e}){return await this.sharedItemsService.refuseSharedItem(e.vaultItemId),(0,y.Vp)(void 0)}constructor(e){this.sharedItemsService=e}}Ce=(0,i.__decorate)([(0,ye.W)(Ee.l),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===ve?Object:ve])],Ce);var Ae=s(41182),Re=s(95038),Te=s(40102),Oe=s(11108),De=s(16433),Ue=s(62760),Fe=s(16712),Pe=s(46449),xe=s(89720);class Ne{getCurrentUserLogin(){return this.context.get(Fe.l.UserName)}execute({body:e}){const{itemId:t}=e,{userFeatureFlip:s}=this.featureFlips.queries;return s({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"}).pipe((0,De.q)(1),(0,k.w)((e=>!!(0,y.d6)(e)&&!!(0,y.db)(e)?this.executeWithGrapheneState$(t):this.executeWithCarbonState$(t))))}executeWithGrapheneState$(e){return this.sharedItemsRepository.sharedAccessForId$(e).pipe((0,k.w)((e=>{if(!e)return(0,L.of)({isShared:!1,isSharedViaUserGroup:!1});const t=this.getCurrentUserLogin();if(!t)throw new Error("No user login found to check sharing status for item");return this.userGroupRepository.acceptedUserGroupIdsForLogin$(t).pipe((0,G.U)((t=>({isShared:!0,isSharedViaUserGroup:e.userGroups.some((({id:e,status:s})=>t.includes(e)&&"accepted"===s))}))))})),(0,M.x)(Ue.shallowEqualObjects),(0,G.U)(y.Vp))}executeWithCarbonState$(e){return this.itemGroupGetter.getForItemId(e).pipe((0,k.w)((e=>{if((0,y.hx)(e))throw new Error("Error when retrieving item group to check sharing status");const t=(0,y.db)(e);if(!t)return(0,L.of)({isShared:!1,isSharedViaUserGroup:!1});const s=this.getCurrentUserLogin();if(!s)throw new Error("No user login found to check sharing status for item");return this.userGroupRepository.acceptedUserGroupIdsForLogin$(s).pipe((0,G.U)((e=>({isShared:!0,isSharedViaUserGroup:t.groups?.some((({groupId:t,status:s})=>e.includes(t)&&"accepted"===s))??!1}))))})),(0,M.x)(Ue.shallowEqualObjects),(0,G.U)(y.Vp))}constructor(e,t,s,r,i){this.itemGroupGetter=e,this.userGroupRepository=t,this.sharedItemsRepository=s,this.context=r,this.featureFlips=i}}Ne=(0,i.__decorate)([(0,Pe.e)(Re.S),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===de.E?Object:de.E,void 0===xe.x?Object:xe.x,void 0===d.z?Object:d.z,void 0===Fe.f?Object:Fe.f,void 0===re.P?Object:re.P])],Ne);class Ge{execute({body:e}){const{itemId:t}=e;return this.sharedItemsRepository.sharedItemForId$(t).pipe((0,G.U)((e=>(0,y.Vp)({isLastAdmin:Boolean(e?.isLastAdmin)}))))}constructor(e){this.sharedItemsRepository=e}}Ge=(0,i.__decorate)([(0,Pe.e)(Oe.X),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===d.z?Object:d.z])],Ge);class ke{async execute({body:e}){const{vaultItemId:t}=e,s=await(0,h.z)(this.sharingStatusForItemQueryHandler.execute(new Re.S({itemId:t}))),{isSharedViaUserGroup:r,isShared:i}=(0,y.f2)(s,{success:Ae.y,failure:e=>{throw new Error("Unexpected failure while attempting to retrieve sharing status of item to be deleted",{cause:{failure:e}})}});if(!i)return(0,y.Vp)(void 0);if(r)return(0,y.Rn)((0,Te.Vf)());const a=await(0,h.z)(this.getIsLastAdminForItemQueryHandler.execute(new Oe.X({itemId:t}))),{isLastAdmin:o}=(0,y.f2)(a,{success:Ae.y,failure:e=>{throw new Error("Unexpected failure while attempting to determine if we're the last admin of shared item to be deleted",{cause:{failure:e}})}});return o?(0,y.Rn)((0,Te.V$)()):(await this.sharedItemsService.refuseSharedItem(t),(0,y.Vp)(void 0))}constructor(e,t,s){this.sharingStatusForItemQueryHandler=e,this.getIsLastAdminForItemQueryHandler=t,this.sharedItemsService=s}}ke=(0,i.__decorate)([(0,ye.W)(Te.OL),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===Ne?Object:Ne,void 0===Ge?Object:Ge,void 0===ve?Object:ve])],ke);var Le=s(41842),Me=s(89358),Ke=s(43656),je=s(64978);const Ve=async(e,t=2)=>{const s=[...e];let r=0;for(;s.length;){const e=s.splice(0,t).map((e=>e()));r+=(await Promise.all(e)).length}return r};class ze{async execute(e){const{body:{vaultItemIds:t,pendingInvitesIds:s,shouldRunSync:r}}=e;if(!t.length&&!s.length)return r&&this.sharingSync.scheduleSync(),(0,y.Vp)(void 0);const i=s.map((e=>()=>this.refusePendingInvite(e))),a=await Ve(i),o=await this.getRevokeSharedItemsTasks(t),n=await Ve(o);return(r||(a>0||n>0))&&this.sharingSync.scheduleSync(),(0,y.Vp)(void 0)}async refusePendingInvite(e){const{commands:{refuseItemGroupInvite:t}}=this.sharingInvitesClient,s=await t({itemGroupId:e});if((0,y.hx)(s))throw new Error("Failure to refuse pending invite for a force categorized item");return(0,y.db)(s)}async getRevokeSharedItemsTasks(e){if(!e.length)return[];const[t,s]=await Promise.all([this.getCurrentUserLogin(),(0,h.z)(this.sharedItemsRepository.sharedItemsForIds$(e))]);return s.map((e=>()=>this.revokeSharedItem(e,t)))}async revokeSharedItem({isLastAdmin:e,revision:t,recipientIds:{userIds:s,collectionIds:r,userGroupIds:i},sharedItemId:a,itemId:o,permission:n},c){const d=s?.filter((e=>e!==c));if(e&&(d||r||i)){const e=await this.commonGateway.revokeItemGroupMembers({itemGroupId:a,revision:t,userLogins:d?.length?d:void 0,collectionIds:r??void 0,userGroupIds:i??void 0});if((0,y.hx)(e))throw new Error("Revoke shared item failed in remote control");return await this.sharingSync.scheduleSync(),(0,y.Vp)(e)}const l=await this.commonGateway.refuseItemGroup({itemGroupId:a,revision:t});return n===C.y3.Admin?this.duplicateVaultItem(o):l}async duplicateVaultItem(e){const{commands:{duplicateVaultItem:t}}=this.carbonClient,s=await t({vaultItemId:e});if((0,y.hx)(s))throw new Error("Failed to duplicate a shared item that is revoked because of forced catgorization");return(0,y.db)(s)}getCurrentUserLogin(){return(0,h.z)(this.sessionClient.queries.selectedOpenedSession().pipe((0,Le.h)(y.d6),(0,G.U)(y.db),(0,Le.h)((e=>"string"==typeof e&&""!==e))))}constructor(e,t,s,r,i,a){this.sharedItemsRepository=e,this.commonGateway=t,this.carbonClient=s,this.sessionClient=r,this.sharingSync=i,this.sharingInvitesClient=a}}ze=(0,i.__decorate)([(0,ye.W)(Ke.v),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===d.z?Object:d.z,void 0===Se.b_?Object:Se.b_,void 0===ne._?Object:ne._,void 0===Me.x?Object:Me.x,void 0===fe.D?Object:fe.D,void 0===je.h?Object:je.h])],ze);var We=s(33472);class qe{async execute({body:e}){const{vaultItemIds:t}=e,s=await(0,h.z)(this.isSharingAllowedService.get());if("boolean"==typeof s?!s:t.length>s)return(0,y.Rn)((0,We.Kb)());let r=!1,i=null;const{hasChanges:a,errors:o}=await this.shareItemsService.run(e);if(r=a,i=o,this.hasInvalidRevisionErrors(o)){const{hasChanges:s,errors:a}=await this.runShareAttempt({...e,vaultItemIds:t.filter((e=>o.find((t=>t.id===e))))});i=a,r=r||s}return r&&this.sharingSync.scheduleSync(),i.length?(this.sharedItemsErrorsStore.set({hasErrors:!0,errors:i}),(0,y.Rn)((0,We.$u)())):(this.sharedItemsErrorsStore.set({hasErrors:!1}),(0,y.Vp)(void 0))}hasInvalidRevisionErrors(e){return e.find((({error:e})=>e===E.z.INVALID_REVISION))}async runShareAttempt(e){return await this.sharingSync.runSync(),this.shareItemsService.run(e)}constructor(e,t,s,r){this.isSharingAllowedService=e,this.sharedItemsErrorsStore=t,this.sharingSync=s,this.shareItemsService=r}}qe=(0,i.__decorate)([(0,ye.W)(We.S2),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===j?Object:j,void 0===N?Object:N,void 0===fe.D?Object:fe.D,void 0===$?Object:$])],qe);var Be=s(7502),$e=s(10370),Ye=s(95196),Qe=s(92324),He=s(99291);class Je{async execute({body:e}){const{itemContent:t,itemId:s}=e,r=await this.sharedItemsRepository.getVaultItemsIndex(),i=await(0,h.z)(this.sharedItemsRepository.sharedItemForId$(s));if(!i)throw new Error("Shared item not found when trying to update its content");const a=r[i.itemId].revision,o=await this.sharingDecryption.decryptItemGroupKey(i);if(!o)throw new Error("Shared item key cannot be decrypted when trying to update its content");const n=await this.sharingCrypto.decryptSecureData(o,(0,Be.R)(i.itemKey)),c=(0,Qe.w)(t),d=await this.sharingCrypto.encryptSecureData(n,c);return await(0,h.z)(this.serverApi.v1.sharingUserdevice.updateItem({content:(0,$e.s)(d),itemId:s,timestamp:a})),(0,y.Vp)(void 0)}constructor(e,t,s,r){this.sharedItemsRepository=e,this.sharingCrypto=t,this.sharingDecryption=s,this.serverApi=r}}Je=(0,i.__decorate)([(0,ye.W)(Ye.l),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===d.z?Object:d.z,void 0===He.O?Object:He.O,void 0===O.c?Object:O.c,void 0===p.l?Object:p.l])],Je);var Ze=s(89623);class Xe{execute(){return this.sharedItemsRepository.sharedAccess$().pipe((0,G.U)((e=>(0,y.Vp)({sharedAccess:e}))))}constructor(e){this.sharedItemsRepository=e}}Xe=(0,i.__decorate)([(0,Pe.e)(Ze.w),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===d.z?Object:d.z])],Xe);var et=s(38661);class tt{execute({body:e}){const{itemIds:t}=e;return this.sharedItemsRepository.sharedAccessForIds$(t).pipe((0,G.U)((e=>(0,y.Vp)({sharedAccess:e}))))}constructor(e){this.sharedItemsRepository=e}}tt=(0,i.__decorate)([(0,Pe.e)(et.D),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===d.z?Object:d.z])],tt);var st=s(80160);class rt{execute(){return this.sharedItemsRepository.sharedItems$().pipe((0,G.U)((e=>(0,y.Vp)({sharedItems:e}))))}constructor(e){this.sharedItemsRepository=e}}rt=(0,i.__decorate)([(0,Pe.e)(st.w),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===d.z?Object:d.z])],rt);var it=s(90878);class at{execute({body:e}){const{itemId:t}=e;return(0,se.D)(this.repo.sharedItemForId$(t)).pipe((0,G.U)((e=>(0,y.Vp)({sharedItem:e}))))}constructor(e){this.repo=e}}at=(0,i.__decorate)([(0,Pe.e)(it.L),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===d.z?Object:d.z])],at);var ot=s(54933);class nt{execute(){return this.isSharingAllowedService.get().pipe((0,G.U)((e=>(0,y.Vp)("boolean"==typeof e?e:e>0))))}constructor(e){this.isSharingAllowedService=e}}nt=(0,i.__decorate)([(0,Pe.e)(ot.B),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===j?Object:j])],nt);var ct=s(48844),dt=s(38638);class lt{execute(){return this.premiumSpaceGetter.get().pipe((0,k.w)((e=>{if((0,y.hx)(e))throw new Error("Error retrieving space for user");return(0,y.db)(e).teamId?this.serverApiClient.v1.sharingUserdevice.getTeamLogins().pipe((0,ct.Qn)((e=>({userLogins:e.data.teamLogins}))),(0,ct.DZ)((e=>{throw e}))):(0,L.of)((0,y.Vp)({userLogins:[]}))})))}constructor(e,t){this.serverApiClient=e,this.premiumSpaceGetter=t}}lt=(0,i.__decorate)([(0,Pe.e)(dt.G),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===p.l?Object:p.l,void 0===K.n?Object:K.n])],lt);var ut=s(36155);class pt{execute(){return this.currentSpaceGetter.get().pipe((0,ct.Qn)((e=>e.isSharingEnabled)))}constructor(e){this.currentSpaceGetter=e}}pt=(0,i.__decorate)([(0,Pe.e)(ut.N),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===K.n?Object:K.n])],pt);var ht=s(95803);class mt{execute({body:e}){const{itemIds:t}=e;return this.sharedItemsRepository.sharedItemsForIds$(t).pipe((0,G.U)((e=>(0,y.Vp)({sharedItems:e}))))}constructor(e){this.sharedItemsRepository=e}}mt=(0,i.__decorate)([(0,Pe.e)(ht.z),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===d.z?Object:d.z])],mt);var gt=s(46234);class vt{execute({body:e}){const{itemId:t}=e;return this.sharedItemsRepository.sharedItemForId$(t).pipe((0,G.U)((e=>(0,y.Vp)({permission:e?.permission}))))}constructor(e){this.sharedItemsRepository=e}}vt=(0,i.__decorate)([(0,Pe.e)(gt.C),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===d.z?Object:d.z])],vt);var yt=s(62176);class _t{execute({body:e}){const{itemIds:t}=e;return this.sharedItemsRepository.sharedItemsForIds$(t).pipe((0,G.U)((e=>(0,y.Vp)(e.reduce(((e,t)=>(e[t.itemId]=t.permission,e)),{})))))}constructor(e){this.sharedItemsRepository=e}}_t=(0,i.__decorate)([(0,Pe.e)(yt.R),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===d.z?Object:d.z])],_t);var St=s(47670);class ft{execute({body:e}){const{itemId:t}=e,{userFeatureFlip:s}=this.featureFlips.queries;return s({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"}).pipe((0,De.q)(1),(0,k.w)((e=>!!(0,y.d6)(e)&&!!(0,y.db)(e)?this.executeWithNewState$(t):this.executeWithCarbonState$(t))))}executeWithNewState$(e){return this.sharedItemsRepository.sharedAccessForId$(e).pipe((0,G.U)((e=>{if(!e)return(0,y.Vp)(void 0);const t=e.sharedItemId,s=e.users.map((e=>(0,ce.t9)(e,C.IP.User))),r=e.userGroups.map((e=>(0,ce.t9)(e,C.IP.Group))),i=e.collections.map((e=>(0,ce.t9)(e,C.IP.Collection))),a={itemGroupId:t,count:s.length+r.length+i.length,users:s,groups:r,collections:i};return(0,y.Vp)(a)})))}executeWithCarbonState$(e){return this.itemGroupsGetter.getForItemId(e).pipe((0,G.U)((e=>{if((0,y.hx)(e))throw new Error("Error when retrieving item group for shared access");const t=(0,y.db)(e);if(!t)return;const s=t.users?.map((e=>({permission:e.permission,status:e.status,recipientId:e.userId,recipientName:e.alias,recipientType:C.IP.User}))).filter((e=>!["revoked","refused"].includes(e.status??""))).sort(((e,t)=>e.recipientName.localeCompare(t.recipientName))),r=t.groups?.map((e=>({permission:e.permission,status:e.status,recipientId:e.groupId,recipientName:e.name,recipientType:C.IP.Group}))).filter((e=>!["revoked","refused"].includes(e.status))).sort(((e,t)=>e.recipientName.localeCompare(t.recipientName))),i=t.collections?.map((e=>({permission:e.permission,status:e.status,recipientId:e.uuid,recipientName:e.name,recipientType:C.IP.Collection}))).filter((e=>!["revoked","refused"].includes(e.status))).sort(((e,t)=>e.recipientName.localeCompare(t.recipientName)));return{users:s??[],groups:r??[],collections:i??[],itemGroupId:t.groupId}})),(0,k.w)((e=>e?.groups.length?this.userGroupsGetter.getCarbonUserGroups$().pipe((0,G.U)((t=>({...e,groups:e.groups.map((e=>({...e,recipientName:t.find((t=>t.groupId===e.recipientId))?.name??e.recipientName})))})))):(0,L.of)(e))),(0,k.w)((e=>e?.collections.length?this.collectionsRepository.collections$().pipe((0,G.U)((t=>({...e,collections:e.collections.map((e=>({...e,recipientName:t.find((t=>t.uuid===e.recipientId))?.name??e.recipientName})))})))):(0,L.of)(e))),(0,G.U)((e=>(0,y.Vp)(e?{...e,count:e.users.length+e.groups.length+e.collections.length}:void 0))))}constructor(e,t,s,r,i){this.itemGroupsGetter=e,this.userGroupsGetter=t,this.collectionsRepository=s,this.sharedItemsRepository=r,this.featureFlips=i}}ft=(0,i.__decorate)([(0,Pe.e)(St.v),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===de.E?Object:de.E,void 0===le.B?Object:le.B,void 0===ue.G?Object:ue.G,void 0===d.z?Object:d.z,void 0===re.P?Object:re.P])],ft);var wt=s(39672),It=s(39431),bt=s(22449);class Et{getVaultItems(e,t,s,r){return this.vaultClient.queries.search({searchQuery:s,vaultItemTypes:e,propertyFilters:null!==r?[{property:"spaceId",value:r}]:void 0,ids:t})}execute({body:e}){const{userFeatureFlip:t}=this.featureFlips.queries;if(!e.userId&&!e.groupId)throw new Error("No userId and no groupId has been provided");return t({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"}).pipe((0,De.q)(1),(0,k.w)((t=>!!(0,y.d6)(t)&&!!(0,y.db)(t)?this.executeWithGrapheneState$(e):this.executeWithCarbonState$(e))))}executeWithGrapheneState$(e){const{userId:t,groupId:s,query:r,spaceId:i}=e;return this.sharedItemsStore.state$.pipe((0,k.w)((({sharedAccess:e,sharedItems:a})=>{const o=[];for(const r in e)t?e[r].users.some((e=>e.id===t))&&o.push(a[r].itemId):s&&e[r].userGroups.some((e=>e.id===s&&e.status!==C.qb.Revoked))&&o.push(a[r].itemId);return this.getVaultItems([It.U.Credential,It.U.SecureNote,It.U.Secret],o,r,i).pipe((0,G.U)((e=>{if(!(0,y.d6)(e))throw new Error("Unable to retrieve vault items");const t=e.data.credentialsResult.items,s=e.data.secureNotesResult.items,r=e.data.secretsResult.items;return(0,y.Vp)({sharedCredentials:t,sharedSecureNotes:s,sharedSecrets:r})})))})))}executeWithCarbonState$(e){const{userId:t,groupId:s,query:r,spaceId:i}=e;return this.itemGroupGetter.get().pipe((0,k.w)((e=>{if(!(0,y.d6)(e))throw new Error("Incorrect type");const a=e.data.filter((e=>t?e.users?.filter((e=>e.userId===t)).length:s?e.groups?.filter((e=>e.groupId===s&&e.status!==C.qb.Revoked)).length:void 0)).flatMap((e=>e.items?.map((e=>e.itemId))||[]));return this.getVaultItems([It.U.Credential,It.U.SecureNote,It.U.Secret],a,r,i).pipe((0,G.U)((e=>{if(!(0,y.d6)(e))throw new Error("Unable to retrieve vault items");const t=e.data.credentialsResult.items,s=e.data.secureNotesResult.items,r=e.data.secretsResult.items;return(0,y.Vp)({sharedCredentials:t,sharedSecureNotes:s,sharedSecrets:r})})))})))}constructor(e,t,s,r){this.vaultClient=e,this.itemGroupGetter=t,this.featureFlips=s,this.sharedItemsStore=r}}Et=(0,i.__decorate)([(0,Pe.e)(wt.v),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===bt.T?Object:bt.T,void 0===de.E?Object:de.E,void 0===re.P?Object:re.P,void 0===te?Object:te])],Et);var Ct=s(52715);class At{execute(){return this.itemGroups.get().pipe((0,ct.Qn)((e=>e.reduce(((e,t)=>[...e,...t.items?.map((e=>e.itemId))??[]]),[]))))}constructor(e){this.itemGroups=e}}At=(0,i.__decorate)([(0,Pe.e)(Ct.c),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===de.E?Object:de.E])],At);class Rt{execute(){return this.store.state$.pipe((0,G.U)((e=>e.hasErrors?(0,y.Vp)(e.errors.reduce(((e,t)=>{const{id:s,type:r,title:i,error:a}=t,o={id:s,title:i,reason:a};switch(r){case C.y2.Credential:e.credentialsErrors.push({...o,domain:t.domain,text:t.text});break;case C.y2.SecureNote:e.notesErrors.push({...o,color:t.color});break;default:e.secretsErrors.push({...o})}return e}),{credentialsErrors:(0,_.Ay)([]),notesErrors:(0,_.Ay)([]),secretsErrors:(0,_.Ay)([])})):(0,y.Vp)({credentialsErrors:[],notesErrors:[],secretsErrors:[]}))))}constructor(e){this.store=e}}Rt=(0,i.__decorate)([(0,Pe.e)(E.f),(0,i.__metadata)("design:type",Function),(0,i.__metadata)("design:paramtypes",[void 0===N?Object:N])],Rt);var Tt=s(64222),Ot=s(14139),Dt=s(13186),Ut=s(75028),Ft=s(41613);class Pt{}Pt=(0,i.__decorate)([(0,a.Yl)({api:n.X,providers:[F,j,$,ve,q,me,ae,{provide:d.z,useClass:ge},{provide:l,useClass:w}],exports:[d.z],stores:[N,te],handlers:{commands:{updateSharedItemPermission:we,revokeSharedItem:be,refuseSharedItem:Ce,refuseSharedItemBeforeDeletion:ke,remoteControlSharedItems:ze,shareItems:qe,updateSharedItemContent:Je},events:{},queries:{getSharedAccess:Xe,getSharedAccessForItemIds:tt,getSharedItems:rt,getSharedItemForId:at,isSharingAllowed:nt,getSharingTeamLogins:lt,sharingEnabled:pt,getSharedItemsForItemIds:mt,getSharingStatusForItem:Ne,getPermissionForItem:vt,getPermissionForItems:_t,getIsLastAdminForItem:Ge,sharedAccessForItem:ft,getUserSharedVaultItems:Et,sharedItemsIds:At,shareItemsErrors:Rt}},imports:[o.n,Ot.y,Dt.I,Tt.a,Ut.k,Ft.u],requiredFeatureFlips:[c.o.SharingItemsGrapheneMigrationDev]})],Pt)},41613:(e,t,s)=>{s.d(t,{u:()=>X});var r=s(491),i=s(86006),a=s(87581),o=s(41842),n=s(43978),c=s(92587),d=s(87279),l=s(20980);class u{getUsersAndGroupsInCollectionsInSpace(e){const{sharedCollectionsWithItems:t,usersAndGroupsInCollection:s}=this.sharingCollectionsClient.queries;return t().pipe((0,o.h)(d.d6),(0,n.w)((t=>{const r=t.data.reduce(((t,s)=>(s.spaceId!==e&&null!==e||t.push(s.id),t)),[]);return s({collectionIds:r})})))}getUsersAndGroupsInCollections(){const{getSharedCollections:e,usersAndGroupsInCollection:t}=this.sharingCollectionsClient.queries;return e({}).pipe((0,o.h)(d.d6),(0,n.w)((e=>{const s=e.data.map((e=>e.uuid));return t({collectionIds:s})})))}constructor(e){this.sharingCollectionsClient=e}}u=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===l.L?Object:l.L])],u);var p=s(162),h=s(39431),m=s(50879),g=s(35594);class v{getSharedVaultItemsForSpaceId(e){return this.sharingItemsClient.queries.getSharedItems().pipe((0,n.w)((t=>{if((0,d.hx)(t))throw new Error("Unable to find items in item group");const s=(0,d.db)(t).sharedItems.map((e=>e.itemId)),r=this.vaultItemsCrud.queries.query({vaultItemTypes:[h.U.Credential,h.U.SecureNote,h.U.Secret],ids:s,propertyFilters:null!==e?[{property:"spaceId",value:e}]:void 0});return(0,p.D)(r)})))}constructor(e,t){this.vaultItemsCrud=e,this.sharingItemsClient=t}}v=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===m.L?Object:m.L,void 0===g.s?Object:g.s])],v);var y=s(7165),_=s(63144),S=s(56618),f=s(62149),w=s(10722);const I=y.z.object({groupId:y.z.string(),name:y.z.string(),revision:y.z.number(),publicKey:y.z.string(),privateKey:y.z.string(),acceptedUsers:y.z.array(y.z.string()),allUsers:y.z.array(y.z.string()),groupKey:y.z.string().optional()}),b=y.z.object({userGroups:y.z.record(I)}),E=e=>b.safeParse(e).success;class C extends((0,_.Q)({persist:!0,storage:{initialValue:{userGroups:{}},typeGuard:E,schemaVersion:1},scope:f.F.User,storeName:"sharing-user-groups-state",storeTypeGuard:E,codec:w.E,isCache:!0,capacity:S.Y.Unlimited})){}var A=s(89720),R=s(60399),T=s(43651),O=s(6489),D=s(87065),U=s(13252),F=s(28489);class P{async getUserGroups(){const{userGroups:e}=await this.userGroupsStore.getState();return Object.keys(e).reduce(((t,s)=>{const{groupId:r,name:i,revision:a,acceptedUsers:o,privateKey:n,publicKey:c,groupKey:d}=e[s];return t[s]={groupId:r,name:i,revision:a,privateKey:n,publicKey:c,users:[],acceptedUsers:o,groupKey:d},t}),(0,F.Ay)({}))}setUserGroups(e,t){const s=e.reduce(((e,{groupId:s,name:r,revision:i,users:a,privateKey:o,publicKey:n})=>{const c=[],d=[];let l="";return a.forEach((e=>{e.status===U.qb.Accepted&&c.push(e.userId),e.userId===t&&(l=e.groupKey??""),d.push(e.userId)})),e.userGroups[s]={groupId:s,name:r,revision:i,acceptedUsers:c,publicKey:n,privateKey:o,groupKey:l,allUsers:d},e}),{userGroups:(0,F.Ay)({})});this.userGroupsStore.set(s)}async getUserGroup(e){const{userGroups:t}=await this.userGroupsStore.getState(),s=t[e];if(!s)return null;const{groupId:r,name:i,revision:a,acceptedUsers:o,privateKey:n,publicKey:c,groupKey:d}=s;return{groupId:r,name:i,revision:a,privateKey:n,publicKey:c,groupKey:d,users:[],acceptedUsers:o}}async getUserGroupsForIds(e){const{userGroups:t}=await this.userGroupsStore.getState();return e.reduce(((e,s)=>{const r=t[s];if(r){const{groupId:t,name:s,revision:i,acceptedUsers:a,privateKey:o,publicKey:n,groupKey:c}=r;e.push({groupId:t,name:s,revision:i,privateKey:o,publicKey:n,groupKey:c,users:[],acceptedUsers:a})}return e}),(0,F.Ay)([]))}async getUserGroupForId(e){const t=await this.getUserGroupsForIds([e]);if(!t.length)throw new Error("Failed to retrieve user group by id");return t[0]}acceptedUserGroupIdsForLogin$(e){return this.userGroupsStore.state$.pipe((0,D.U)((t=>Object.values(t.userGroups).filter((t=>t.acceptedUsers.includes(e))).map((e=>e.groupId)))))}constructor(e){this.userGroupsStore=e}}P=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===C?Object:C])],P);var x=s(16712),N=s(74929);class G{getCurrentUserLogin(){return this.context.get(x.l.UserName)}async getUserGroups(){const e=await this.userGroupsGetter.getCarbonUserGroups(),t={},s=this.getCurrentUserLogin();return e.forEach((e=>{const{groupId:r,name:i,revision:a,privateKey:o,publicKey:n,users:c}=e,d=c.find((e=>e.userId===s))?.groupKey??"",l=c.reduce(((e,t)=>(t.status===U.qb.Accepted&&e.push(t.userId),e)),[]);t[e.groupId]={acceptedUsers:l,groupId:r,name:i,revision:a,privateKey:o,publicKey:n,users:c,groupKey:d}})),t}setUserGroups(){throw new Error("Setting the user group index is not supported in the legacy user groups repository adapter")}async getUserGroup(e){const t=await this.userGroupsGetter.getCarbonUserGroupForGroupId(e);if(!t)throw new Error("Getting a user group by id failed");const s=this.getCurrentUserLogin(),r=t.users.find((e=>e.userId===s))?.groupKey??"";return{...t,groupKey:r}}async getUserGroupsForIds(e){const t=this.getCurrentUserLogin();return(await this.userGroupsGetter.getCarbonUserGroupForGroupIds(e)).map((e=>{const s=e.users.find((e=>e.userId===t))?.groupKey??"";return{...e,groupKey:s}}))}async getUserGroupForId(e){const t=await this.userGroupsGetter.getCarbonUserGroupForGroupId(e);if(!t)throw new Error("Failed to retrieve user group by id");const s=this.getCurrentUserLogin(),r=t.users.find((e=>e.userId===s))?.groupKey??"";return{...t,groupKey:r}}acceptedUserGroupIdsForLogin$(e){return this.userGroupsGetter.getCarbonUserGroups$().pipe((0,D.U)((t=>t.filter((t=>t.users.some((t=>t.userId===e&&t.status===U.qb.Accepted)))).map((e=>e.groupId)))))}constructor(e,t){this.context=e,this.userGroupsGetter=t}}G=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===x.f?Object:x.f,void 0===N.B?Object:N.B])],G);class k{async getUserGroup(e){return(await this.getRepo()).getUserGroup(e)}async getUserGroupsForIds(e){return(await this.getRepo()).getUserGroupsForIds(e)}async getUserGroupForId(e){return(await this.getRepo()).getUserGroupForId(e)}async getUserGroups(){return(await this.getRepo()).getUserGroups()}async setUserGroups(e,t){return(await this.getRepo()).setUserGroups(e,t)}acceptedUserGroupIdsForLogin$(e){return(0,p.D)(this.getRepo()).pipe((0,n.w)((t=>t.acceptedUserGroupIdsForLogin$(e))))}async getRepo(){const{userFeatureFlip:e}=this.featureFlips.queries,t=await(0,R.z)(e({featureFlip:O.d.SharingSyncGrapheneMigrationDev}));return(0,d.hx)(t)?this.legacyRepo:(0,d.db)(t)?this.repo:this.legacyRepo}constructor(e,t,s){this.repo=e,this.legacyRepo=t,this.featureFlips=s}}k=(0,r.__decorate)([(0,c.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===P?Object:P,void 0===G?Object:G,void 0===T.P?Object:T.P])],k);var L=s(16433),M=s(46449),K=s(35863),j=s(31839),V=s(14122);class z{execute(){const{userFeatureFlip:e}=this.featureFlips.queries;return e({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"}).pipe((0,L.q)(1),(0,n.w)((e=>!!(0,d.d6)(e)&&!!(0,d.db)(e)?this.executeWithGrapheneState$():this.executeWithCarbonState$())))}executeWithGrapheneState$(){return(0,p.D)(this.userGroupsRepo.getUserGroups()).pipe((0,D.U)((e=>{const t=[];for(const s in e){const r=e[s];t.push({id:r.groupId,name:r.name,users:r.acceptedUsers??[]})}return(0,d.Vp)(t)})))}executeWithCarbonState$(){const e={dataQuery:{sortToken:{sortCriteria:[{field:"name",direction:K.S.Ascend}],uniqField:"id"},filterToken:{filterCriteria:[]}},spaceId:""};return this.carbonLegacyClient.queries.getUserGroups(e).pipe((0,D.U)((e=>{if((0,d.hx)(e))throw new Error("Unable to carbon user group data.");const t=(0,d.db)(e).items.map((e=>({id:e.id,itemCount:e.itemCount,name:e.name,users:e.users.map((e=>e.id))})));return(0,d.Vp)(t)})))}constructor(e,t,s){this.userGroupsRepo=e,this.carbonLegacyClient=t,this.featureFlips=s}}z=(0,r.__decorate)([(0,M.e)(j.J),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===A.x?Object:A.x,void 0===V._?Object:V._,void 0===T.P?Object:T.P])],z);var W=s(53529),q=s(93314);class B{execute({body:e}){const{spaceId:t,sortDirection:s}=e,{userFeatureFlip:r}=this.featureFlips.queries;return r({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"}).pipe((0,L.q)(1),(0,n.w)((e=>!!(0,d.d6)(e)&&!!(0,d.db)(e)?this.executeWithGrapheneState$(t,s):this.executeWithCarbonState$(t,s))))}executeWithCarbonState$(e,t){const s={dataQuery:{sortToken:{sortCriteria:[{field:"id",direction:t}],uniqField:"id"},filterToken:{filterCriteria:[]}},spaceId:e};return this.carbonLegacyClient.queries.getSharingUsers(s).pipe((0,D.U)((e=>{if((0,d.hx)(e))throw new Error("Unable to get carbon user data.");const t=(0,d.db)(e).items;return(0,d.Vp)(t)})))}executeWithGrapheneState$(e,t){return null!==e?this.executeWithSpace(e,t):this.executeWithoutSpace(t)}executeWithoutSpace(e){return this.sharingItemsClient.queries.getSharedAccess().pipe((0,o.h)(d.d6),(0,D.U)((t=>{const s=(0,d.db)(t).sharedAccess,r=this.getSharingUsersFromSharedAccess(s,e);return(0,d.Vp)(r)})))}executeWithSpace(e,t){return this.getVaultItemIdsInSpace(e).pipe((0,n.w)((e=>this.sharingItemsClient.queries.getSharedAccessForItemIds({itemIds:e}))),(0,o.h)(d.d6),(0,D.U)((e=>{const s=(0,d.db)(e).sharedAccess,r=this.getSharingUsersFromSharedAccess(s,t);return(0,d.Vp)(r)})))}getCurrentUserLogin(){return this.context.get(x.l.UserName)}getVaultItemIdsInSpace(e){return this.recipientItems.getSharedVaultItemsForSpaceId(e).pipe((0,o.h)(d.d6),(0,D.U)((e=>{const t=(0,d.db)(e);return[...t.credentialsResult.items.map((e=>e.id)),...t.secureNotesResult.items.map((e=>e.id)),...t.secretsResult.items.map((e=>e.id))]})))}getSharingUsersFromSharedAccess(e,t){const s=this.getCurrentUserLogin(),r=new Map;e.forEach((e=>{e.users.forEach((e=>{if(e.id===s||"accepted"!==e.status)return;const t=r.has(e.id)?r.get(e.id).itemCount:0;r.set(e.id,{id:e.id,itemCount:t+1})}))}));return Array.from(r.values()).sort(((e,s)=>t===q.S.Ascend?e.id.localeCompare(s.id):s.id.localeCompare(e.id)))}constructor(e,t,s,r,i){this.context=e,this.recipientItems=t,this.sharingItemsClient=s,this.carbonLegacyClient=r,this.featureFlips=i}}B=(0,r.__decorate)([(0,M.e)(W.K),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===x.f?Object:x.f,void 0===v?Object:v,void 0===g.s?Object:g.s,void 0===V._?Object:V._,void 0===T.P?Object:T.P])],B);var $=s(61076),Y=s(70633);class Q{execute({body:e}){const{sortDirection:t}=e,{userFeatureFlip:s}=this.featureFlips.queries;return s({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"}).pipe((0,L.q)(1),(0,n.w)((e=>!!(0,d.d6)(e)&&!!(0,d.db)(e)?this.executeWithGrapheneState$(t):this.executeWithCarbonState$(t))))}executeWithGrapheneState$(e){return this.sharingItemsClient.queries.getSharedAccess().pipe((0,$.V)(this.userGroupsRepo.getUserGroups()),(0,D.U)((([t,s])=>{if((0,d.hx)(t))throw new Error("Unable to find shared access data.");const r=(0,d.db)(t).sharedAccess,i=new Map;r.forEach((e=>{e.userGroups.forEach((e=>{if("accepted"!==e.status)return;const t=s[e.id];if(!t)return;const r=i.has(e.id)?i.get(e.id).itemCount:0,a=i.get(e.id)?.users.length?i.get(e.id)?.users:t.acceptedUsers;i.set(e.id,{id:e.id,name:e.name,users:a??[],itemCount:r+1})}))}));const a=Array.from(i.values()).sort(((t,s)=>e===K.S.Ascend?t.name.localeCompare(s.name):s.name.localeCompare(t.name)));return(0,d.Vp)(a)})))}executeWithCarbonState$(e){const t={dataQuery:{sortToken:{sortCriteria:[{field:"name",direction:e}],uniqField:"id"},filterToken:{filterCriteria:[]}},spaceId:""};return this.carbonLegacyClient.queries.getUserGroups(t).pipe((0,D.U)((e=>{if((0,d.hx)(e))throw new Error("Unable to carbon user group data.");const t=(0,d.db)(e).items.map((e=>({id:e.id,itemCount:e.itemCount,name:e.name,users:e.users.map((e=>e.id))})));return(0,d.Vp)(t)})))}constructor(e,t,s,r){this.sharingItemsClient=e,this.userGroupsRepo=t,this.carbonLegacyClient=s,this.featureFlips=r}}Q=(0,r.__decorate)([(0,M.e)(Y.f),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===g.s?Object:g.s,void 0===A.x?Object:A.x,void 0===V._?Object:V._,void 0===T.P?Object:T.P])],Q);var H=s(48782);class J{execute({body:e}){const{id:t}=e,{userFeatureFlip:s}=this.featureFlips.queries;return s({featureFlip:"sharingVault_web_sharingSyncGrapheneMigration_dev"}).pipe((0,L.q)(1),(0,n.w)((e=>!!(0,d.d6)(e)&&!!(0,d.db)(e)?this.executeWithGrapheneState$(t):this.executeWithCarbonState$(t))))}executeWithGrapheneState$(e){return(0,p.D)(this.userGroupsRepo.getUserGroupForId(e)).pipe((0,D.U)((e=>{const t={id:e.groupId,name:e.name,users:e.acceptedUsers??[]};return(0,d.Vp)(t)})))}executeWithCarbonState$(e){return this.carbonLegacyClient.queries.getUserGroup(e).pipe((0,D.U)((e=>{if((0,d.hx)(e))throw new Error("Unable to get carbon user group.");const t=(0,d.db)(e);if(!t)throw new Error("Unable to get carbon user group.");const s={id:t.id,name:t.name,users:t.users.map((e=>e.id))};return(0,d.Vp)(s)})))}constructor(e,t,s){this.carbonLegacyClient=e,this.featureFlips=t,this.userGroupsRepo=s}}J=(0,r.__decorate)([(0,M.e)(H.e),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===V._?Object:V._,void 0===T.P?Object:T.P,void 0===A.x?Object:A.x])],J);var Z=s(14139);class X{}X=(0,r.__decorate)([(0,i.Yl)({api:a.A,providers:[v,u,P,G,{provide:A.x,useClass:k}],stores:[C],handlers:{commands:{},events:{},queries:{getAllAcceptedGroups:z,getSharingUsers:B,getSharingGroups:Q,getSharingGroupById:J}},imports:[Z.y],exports:[A.x]})],X)},89720:(e,t,s)=>{s.d(t,{x:()=>r});class r{}},58158:(e,t,s)=>{s.d(t,{P:()=>fe});var r=s(491),i=s(60399),a=s(82874),o=s(53344),n=s(87279),c=s(76763),d=s(28489),l=s(92587),u=s(89720);const p=(e,t)=>e.reduce(((e,s)=>{const r=t[s.id];return r?r.revision<s.revision?e.updatedIds.push(s.id):e.unchanged.push(r):e.newIds.push(s.id),e}),{newIds:(0,d.Ay)([]),updatedIds:(0,d.Ay)([]),unchanged:(0,d.Ay)([])});var h=s(66717),m=s(13252),g=s(96500),v=s(69956);var y=s(44801),_=s(99291);class S{async isUserGroupValid(e,t){const{publicKey:s,login:r}=t,i=e.users.find((e=>e.userId===r));if(!i?.groupKey?.length)return!1;if(i.status===m.qb.Pending)return i;if(i.status!==m.qb.Accepted)return!1;if(!i.acceptSignature)return!1;const a=await this.sharingDecryption.decryptResourceKeyViaUserMember({encryptedResourceKey:i.groupKey},t);return!!a&&this.sharingCrypto.verifyAcceptSignature(s,i.acceptSignature,e.groupId,a)}async isSharedItemValid(e,t){return this.isSharedItemAccessValid(e.sharedItemId,e.accessLink,t)}async isSharedItemAccessValid(e,t,s){const{publicKey:r}=s;if(!t?.acceptSignature)return{isValid:!1};const{acceptSignature:i}=t,a=await this.sharingDecryption.decryptItemGroupKeyFromAccessLink(t,s);if(!a)return{isValid:!1};const o=await this.sharingCrypto.verifyAcceptSignature((e=>{switch(e.accessType){case m.Uv.UserGroup:return e.groupPublicKey;case m.Uv.CollectionUserGroup:case m.Uv.CollectionUser:return e.collectionPublicKey}})(t)??r,i,e,a);return o?{isValid:!0,itemGroupKey:a}:{isValid:!1}}constructor(e,t){this.sharingDecryption=e,this.sharingCrypto=t}}S=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===y.c?Object:y.c,void 0===_.O?Object:_.O])],S);class f{async getUserGroupChangesFromSummary(e){const t=await this.userGroupsRepo.getUserGroups(),{newIds:s,updatedIds:r,unchanged:i}=p(e,t);return{newUserGroupIds:s,updateUserGroupIds:r,unchangedUserGroups:i}}async syncUserGroups(e,t,s){const{validatedUserGroups:r,pendingInvites:i}=await e.reduce((async(e,t)=>{if("users"!==t.type)return e;const r=await this.validationService.isUserGroupValid(t,s),i=await e;if(r&&i.validatedUserGroups.push(t),"boolean"!=typeof r){const{referrer:e,permission:s}=r;i.pendingInvites.push({referrer:e,permission:s,id:t.groupId,name:t.name})}return e}),Promise.resolve({validatedUserGroups:(0,d.Ay)([]),pendingInvites:(0,d.Ay)([])}));r.length&&(this.userGroupsRepo.setUserGroups(t.concat(r),s.login),this.pendingInvitesService.setUserGroupInvites(i))}constructor(e,t,s){this.userGroupsRepo=e,this.validationService=t,this.pendingInvitesService=s}}f=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===u.x?Object:u.x,void 0===S?Object:S,void 0===h.M?Object:h.M])],f);var w=s(5482),I=s(21003),b=s(91969);class E{async getCollectionsChangesFromSummary(e){const t=await this.collectionsRepo.getCollections(),{newIds:s,updatedIds:r,unchanged:i}=p(e,t);return{newCollectionIds:s,updatedCollectionIds:r,unchangedCollections:i}}async syncCollections(e,t,s){const r=Object.values(await this.userGroupsRepo.getUserGroups()),{validatedCollections:i,pendingInvites:a,validatedSharedCollectionAccess:o}=await e.reduce((async(e,t)=>{const i=(0,I.E)(t,r,s.login),a=t.users?.find((e=>e.login===s.login&&e.status===m.qb.Pending)),o=a||await this.isCollectionValid(i,s),n=await e;if(o&&(n.validatedCollections.push(i),n.validatedSharedCollectionAccess[i.id]=(0,b.c)(t)),a){const{referrer:e,permission:t}=a;n.pendingInvites.push({referrer:e,permission:t,id:i.id,name:i.name})}return e}),Promise.resolve({validatedCollections:(0,d.Ay)([]),pendingInvites:(0,d.Ay)([]),validatedSharedCollectionAccess:(0,d.Ay)({})}));i.length&&this.collectionsRepo.setCollections(t.concat(i),o),a.length&&this.pendingInvitesService.setCollectionInvites(a)}async isCollectionValid(e,t){const{publicKey:s}=t;if(!e.accessLink?.acceptSignature)return!1;const{acceptSignature:r}=e.accessLink,i=await this.sharingDecryption.decryptSharedCollectionKey(e,t);return!!i&&this.sharingCrypto.verifyAcceptSignature(s,r,e.id,i)}constructor(e,t,s,r,i){this.collectionsRepo=e,this.userGroupsRepo=t,this.sharingCrypto=s,this.sharingDecryption=r,this.pendingInvitesService=i}}E=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===w.U?Object:w.U,void 0===u.x?Object:u.x,void 0===_.O?Object:_.O,void 0===y.c?Object:y.c,void 0===h.M?Object:h.M])],E);var C=s(68327),A=s(54691),R=s(50520),T=s(39431),O=s(50879),D=s(14122);class U{async runVaultUpdates(e,t){const s=await Promise.all(e.map((async e=>{const s=t[e.itemId];if(!s)return null;const r=await this.decryptItemContent(s,e.content);return{vaultItemId:e.itemId,id:s.sharedItemId,revision:e.timestamp,itemToSave:r}}))),{itemRevisions:r,itemsToSave:i}=s.reduce(((e,t)=>{if(t){t.itemToSave&&e.itemsToSave.push(t.itemToSave);const{id:s,vaultItemId:r,revision:i}=t;e.itemRevisions.push({sharedItemId:s,vaultItemId:r,revision:i,savedToVault:!0})}return e}),{itemRevisions:(0,d.Ay)([]),itemsToSave:(0,d.Ay)([])}),a=await this.carbonLegacyClient.commands.saveSharedItemsToVault({items:i});return(0,n.hx)(a)?null:r}decryptItemContent(e,t){return this.sharingDecryption.decryptSharedItemContent(e,t)}async getVaultItemsPerType(e){const t=await(0,i.z)(this.vaultItemsCrudClient.queries.query({vaultItemTypes:[T.U.Credential,T.U.Secret,T.U.SecureNote],ids:e}));if((0,n.hx)(t))throw new Error("Could not access the vault items to run sharing sync");return(0,n.db)(t)}async deleteVaultItems(e){const t=await this.getVaultItemsPerType(e);t.credentialsResult.matchCount&&this.vaultItemsCrudClient.commands.deleteVaultItems({vaultItemType:T.U.Credential,ids:t.credentialsResult.items.map((e=>e.id))}),t.secureNotesResult.matchCount&&this.vaultItemsCrudClient.commands.deleteVaultItems({vaultItemType:T.U.SecureNote,ids:t.secureNotesResult.items.map((e=>e.id))}),t.secretsResult.matchCount&&this.vaultItemsCrudClient.commands.deleteVaultItems({vaultItemType:T.U.Secret,ids:t.secretsResult.items.map((e=>e.id))})}constructor(e,t,s){this.sharingDecryption=e,this.vaultItemsCrudClient=t,this.carbonLegacyClient=s}}U=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===y.c?Object:y.c,void 0===O.L?Object:O.L,void 0===D._?Object:D._])],U);var F=s(92936);var P=s(78262);const x=(e,t)=>{const s=((e,t)=>{const s={permission:m.y3.Limited};if(!e)return s;for(const r of e)if(r.status===m.qb.Accepted&&r.itemGroupKey){if(r.permission===m.y3.Admin&&(s.permission=m.y3.Admin),!s.collection||s.collection.accessLink?.accessType!==P.o.User){const e=t.find((e=>e.id===r.uuid&&e.accessLink));e&&(s.collection=e,s.member=r)}if(s.permission===m.y3.Admin&&s.collection?.accessLink?.accessType===P.o.User)break}return s})(e.collections,t);if(s.collection&&s.member){const{collection:e,member:t}=s,{permission:r,acceptSignature:i,proposeSignature:a,itemGroupKey:o}=t;if(o&&e.accessLink?.accessType===P.o.User){const{encryptedResourceKey:t}=e.accessLink;if(t){return{link:{permission:r,acceptSignature:i,proposeSignature:a,encryptedResourceKey:o,collectionEncryptedKey:t,collectionPrivateKey:e.privateKey,collectionPublicKey:e.publicKey,accessType:m.Uv.CollectionUser},permission:s.permission}}}}return null},N=(...e)=>e.find((e=>e?.link))??e[0],G=({permission:e,status:t})=>e===m.y3.Admin&&t===m.qb.Accepted,k=(e,t,s,r)=>{const i=((e,t)=>{const s=e.users?.filter((e=>e.userId===t&&(e.status===m.qb.Accepted||e.status===m.qb.Pending)&&e.groupKey)),r=e.users?.some((({userId:e,permission:s,rsaStatus:r,status:i})=>e!==t&&s===m.y3.Admin&&"sharingKeys"===r&&i===m.qb.Accepted))??!1;if(s?.length){const e=s[0];if(e.groupKey){const{permission:t,acceptSignature:i,proposeSignature:a}=e;return{link:{permission:t,acceptSignature:i,proposeSignature:a,encryptedResourceKey:e.groupKey,accessType:m.Uv.User},permission:(0,F.u)(s),otherAdminsFound:r}}}return{permission:m.y3.Limited,otherAdminsFound:r}})(e,t),a=Boolean(i?.otherAdminsFound)||Boolean(e.groups?.some(G))||Boolean(e.collections?.some(G));if(null!==i&&i.permission===m.y3.Admin)return{...i,otherAdminsFound:a};const o=((e,t)=>{const s=e.groups?.filter((e=>t.some((t=>t.groupId===e.groupId))&&e.status===m.qb.Accepted&&e.groupKey));if(s?.length){const e=s[0],r=(0,F.u)(s);if(e.groupKey){const{permission:s,acceptSignature:i,proposeSignature:a}=e,o=t.find((t=>t.groupId===e.groupId));if(o?.groupKey)return{link:{permission:s,acceptSignature:i,proposeSignature:a,encryptedResourceKey:e.groupKey,groupEncryptedKey:o.groupKey,groupPrivateKey:o.privateKey,groupPublicKey:o.publicKey,accessType:m.Uv.UserGroup},permission:r}}}return null})(e,s);if(null!==o&&o.permission===m.y3.Admin)return{...N(i,o),permission:m.y3.Admin,otherAdminsFound:a};const n=x(e,r);return{...N(i,o,n),permission:(0,F.u)([i,o,n]),otherAdminsFound:a}};var L=s(11047);const M=(e,t)=>e.reduce(((e,s)=>(e[t(s)]=s,e)),(0,d.Ay)({}));var K=s(27790),j=s(6554);class V{async checkPublicKeysAndResendInvites(e,t,s){const r=(e.users||[]).filter((e=>"publicKey"===e.rsaStatus&&!0===e.proposeSignatureUsingAlias)).map((e=>this.resendPublicKeyInvite(e,t,s)));await Promise.all(r)}async resendPublicKeyInvite(e,t,s){try{const r=await this.sharingUsersService.createSignedUserInvites([{login:e.userId,permission:e.permission}],{resourceKey:s,uuid:t.sharedItemId},!1);if(!r.length)throw new Error("Cannot create signed user invite");await this.sharingCommonGateway.updateItemGroupMembers({revision:t.revision,groupId:t.sharedItemId,users:[{userId:e.userId,groupKey:r[0].resourceKey,proposeSignature:r[0].proposeSignature}]})}catch(e){this.exceptionLoggingClient.commands.reportAnomaly({criticality:C.h_.CRITICAL,message:"Error when trying to resend the public key",moduleName:"SharingSyncModule",useCaseName:"sharing-sync-resend-invites.service",applicationComponent:"Sharing",anomalyType:"exception",origin:"uncaughtException"})}}constructor(e,t,s){this.sharingUsersService=e,this.sharingCommonGateway=t,this.exceptionLoggingClient=s}}V=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===j.E?Object:j.E,void 0===K.b_?Object:K.b_,void 0===A.G?Object:A.G])],V);class z{async resolvePendingInvites(e,t,s,r){const i=M(e,(e=>e.itemId)),a=(await this.pendingInvitesService.getSharedItemsInvites()).filter((e=>t.some((t=>t.sharedItemId===e.sharedItemId&&!t.accessLink?.acceptSignature)))),o=M(a,(e=>e.sharedItemId)),n=await s.reduce((async(e,t)=>{const s=await this.resolvePendingInvite(t,i,r,o);return s&&(await e).push(s),e}),Promise.resolve((0,d.Ay)([])));return this.pendingInvitesService.setSharedItemInvites(n),n}async resolvePendingInvite(e,t,s,r){const i=s[e.sharedItemId],a=r[e.sharedItemId];if(i||a){const s=i??{permission:a.permission,referrer:a.referrer,sharedItemId:e.sharedItemId,vaultItemId:e.itemId},r=await this.decryptItemContentAndConvertToInvite(t,e,s);if(r)return r}if(a)return a}async decryptItemContentAndConvertToInvite(e,t,s){const r=e[t.itemId];if(r){const e=await this.vaultUpdatesService.decryptItemContent(t,r.content);if(e)return((e,t,s,r)=>{const i={vaultItemId:e.itemId,title:t.Title,spaceId:t.SpaceId,referrer:s.referrer,sharedItemId:e.sharedItemId,permission:s.permission,revision:r};return(0,g.G)(t)?{...i,itemType:m.y2.Credential,url:t.Url,linkedDomains:t.LinkedServices?.associated_domains.map((e=>e.domain)),email:t.Email,login:t.Login,secondaryLogin:t.SecondaryLogin}:(0,v.gi)(t)?{...i,itemType:m.y2.SecureNote,color:t.Type,secured:t.Secured}:{...i,itemType:m.y2.Secret,secured:t.Secured}})(t,e,s,r.timestamp)}}constructor(e,t){this.vaultUpdatesService=e,this.pendingInvitesService=t}}z=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===U?Object:U,void 0===h.M?Object:h.M])],z);var W=s(86342),q=s(77802);class B{async deleteLastAdminSharedItem(e){let t,s;const r=await this.vaultUpdatesService.getVaultItemsPerType([e.itemId]);if(r.credentialsResult.matchCount){t=T.U.Credential;const{id:e,...i}=r.credentialsResult.items[0];s=i}else if(r.secureNotesResult.matchCount){t=T.U.SecureNote;const{id:e,...i}=r.secureNotesResult.items[0];s=i}else{if(!r.secretsResult.matchCount)return;{t=T.U.Secret;const{id:e,...i}=r.secretsResult.items[0];s=i}}const a=await this.vaultItemsCrudClient.commands.createVaultItem({vaultItemType:t,content:s,shouldSkipSync:!1});if(!(0,n.d6)(a))return;const o=await this.sharingCommonGateway.deleteItemGroup({groupId:e.sharedItemId,revision:e.revision});if(!(0,n.d6)(o))return this.exceptionLoggingClient.commands.reportAnomaly({criticality:C.h_.CRITICAL,message:"Error when trying to delete an item group during the unshare item process",moduleName:"SharingSyncModule",useCaseName:"sharing-sync-last-admin.service",applicationComponent:"Sharing",anomalyType:"exception",origin:"uncaughtException"}),void await this.vaultItemsCrudClient.commands.deleteVaultItems({ids:[a.data.id],vaultItemType:t});const c=await(0,i.z)(this.vaultOrganizationClient.queries.queryCollections({}));if(await this.vaultItemsCrudClient.commands.deleteVaultItems({ids:[e.itemId],vaultItemType:t,ignoreSharing:!0}),(0,n.d6)(c)&&c.data.collections.length>0){const t=c.data.collections.filter((t=>t.vaultItems.some((t=>t.id===e.itemId)))),s={vaultItems:[{id:e.itemId,type:T.U.Credential}]},r={vaultItems:[{id:a.data.id,type:T.U.Credential}]};for(const e of t)await this.vaultOrganizationClient.commands.updateCollection({id:e.id,collection:s,operationType:W.C.SUBSTRACT_VAULT_ITEMS}),await this.vaultOrganizationClient.commands.updateCollection({id:e.id,collection:r,operationType:W.C.APPEND_VAULT_ITEMS})}}constructor(e,t,s,r,i){this.vaultUpdatesService=e,this.sharingCommonGateway=t,this.vaultItemsCrudClient=s,this.vaultOrganizationClient=r,this.exceptionLoggingClient=i}}B=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===U?Object:U,void 0===K.b_?Object:K.b_,void 0===O.L?Object:O.L,void 0===q.C?Object:q.C,void 0===A.G?Object:A.G])],B);class ${async getItemsChangesFromSummary(e,t){const s=await this.sharedItemsRepo.getVaultItemsIndex(),{newItemsIds:r,updatedItemsIds:i,unchangedItems:a}=e.reduce(((e,r)=>{const i=s[r.id];return i?i.revision<r.timestamp||!i.savedToVault&&t.includes(i.sharedItemId)?e.updatedItemsIds.push(r.id):e.unchangedItems.push(i):e.newItemsIds.push(r.id),e}),{newItemsIds:(0,d.Ay)([]),updatedItemsIds:(0,d.Ay)([]),unchangedItems:(0,d.Ay)([])});return{newItemsIds:r,updatedItemsIds:i,unchangedItems:a}}async getSharedItemsChangesFromSummary(e){const t=await this.sharedItemsRepo.getSharedItemsIndex(),{newIds:s,updatedIds:r,unchanged:i}=p(e,t);return{newItemGroupIds:s,updatedItemGroupIds:r,unchangedItemGroups:i,currentSharedItems:t}}async syncSharedItems(e,t,s,r,i){const a=Object.values(await this.userGroupsRepo.getUserGroups()),o=Object.values(await this.collectionsRepo.getCollections()),{validatedSharedItems:n,pendingInvitesWithoutContent:c,validatedSharedAccess:l,sharedItemsToDelete:u}=await e.reduce((async(e,t)=>{if("items"!==t.type)return e;const s=t.groupId,r=await e,n=await this.syncSharedItem(t,a,o,i);if(n){const{sharedItem:e,sharedAccess:a,pendingInvite:o}=n;if(((e,t)=>{const s=e.collections;if(s&&s.length>0)return!1;const{users:r,groups:i}=e,a=!i||0===i.filter((e=>e.status===m.qb.Accepted||e.status===m.qb.Pending)).length,o=r&&1===r.filter((e=>e.status===m.qb.Accepted||e.status===m.qb.Pending)).length&&r[0].userId===t&&r[0].status===m.qb.Accepted&&r[0].permission===m.y3.Admin;return a&&!!o})(t,i.login))try{await this.sharingSyncLastAdmin.deleteLastAdminSharedItem(e),r.sharedItemsToDelete.push(e.sharedItemId)}catch(e){this.exceptionLoggingClient.commands.reportAnomaly({criticality:C.h_.CRITICAL,message:"Error when trying to unshare an item",moduleName:"SharingSyncModule",useCaseName:"sharing-sync-items.service",applicationComponent:"Sharing",anomalyType:"exception",origin:"uncaughtException"})}else r.validatedSharedItems.push(e),r.validatedSharedAccess[t.groupId]=a,o&&(r.pendingInvitesWithoutContent[s]=o)}return e}),Promise.resolve({validatedSharedItems:(0,d.Ay)([]),pendingInvitesWithoutContent:(0,d.Ay)({}),validatedSharedAccess:(0,d.Ay)({}),sharedItemsToDelete:(0,d.Ay)([])})),p=n.length>0,h=u.length>0,g=t.concat(n),v=M(g.filter((e=>e.accessLink?.acceptSignature)),(e=>e.itemId));let y=r,_=null;s.length&&(_=await this.vaultUpdatesService.runVaultUpdates(s,v),_?.length&&(y=y.concat(_)));const S=await this.pendingInvitesService.resolvePendingInvites(s,t,g,c),f=_?.length;if(p||f||h){const e=M(y,(e=>e.vaultItemId)),t=M(S,(e=>e.sharedItemId)),s=g.reduce(((s,r)=>{if(u.includes(r.sharedItemId))return s;const i=e[r.itemId];if(i){const{revision:e,savedToVault:t}=i;s.push({sharedItem:r,revision:e,savedToVault:t})}else{const e=t[r.sharedItemId];if(e){const{revision:t}=e;s.push({sharedItem:r,revision:t,savedToVault:!1})}}return s}),(0,d.Ay)([]));this.sharedItemsRepo.setSharedItems(s,l)}else r.length||this.sharedItemsRepo.setSharedItems()}async deleteItems(e,t){const s=await this.sharedItemsRepo.getSharedItemsIndex(),r=Object.values(s).filter((e=>!e.accessLink?.acceptSignature)),i=Object.values(t).filter((t=>!e.find((e=>e.id===t.itemId)))),a=r.concat(i).map((e=>e.itemId));a.length&&this.vaultUpdatesService.deleteVaultItems(a)}async syncSharedItem(e,t,s,r){const i=((e,t,s,r)=>{const i=k(e,r,t,s),{items:a,revision:o,groupId:n,groups:c,collections:d,users:l}=e,u=a?.[0];if(!u)throw new Error("No items associated with item group");const{itemId:p,itemKey:h}=u,g=i?.permission===m.y3.Admin&&!i.otherAdminsFound;return{permission:i?.permission??m.y3.Limited,accessLink:i?.link,itemId:p,itemKey:h,sharedItemId:n,revision:o,isLastAdmin:g,recipientIds:{userIds:l?.map((({userId:e})=>e))??null,collectionIds:d?.map((({uuid:e})=>e))??null,userGroupIds:c?.map((({groupId:e})=>e))??null}}})(e,t,s,r.login),a=await this.validationService.isSharedItemValid(i,r);a.isValid&&this.sharingSyncResendInvites.checkPublicKeysAndResendInvites(e,i,a.itemGroupKey);const o=e.users?.find((e=>e.userId===r.login&&e.status===m.qb.Pending));if(a.isValid||o){if(o){const{referrer:t,permission:s}=o,{sharedItemId:r,itemId:a}=i;return{sharedItem:i,sharedAccess:(0,L.K4)(e),pendingInvite:{referrer:t,permission:s,sharedItemId:r,vaultItemId:a}}}return{sharedItem:i,sharedAccess:(0,L.K4)(e)}}}constructor(e,t,s,r,i,a,o,n,c){this.sharedItemsRepo=e,this.userGroupsRepo=t,this.collectionsRepo=s,this.vaultUpdatesService=r,this.validationService=i,this.pendingInvitesService=a,this.sharingSyncResendInvites=o,this.sharingSyncLastAdmin=n,this.exceptionLoggingClient=c}}$=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===R.z?Object:R.z,void 0===u.x?Object:u.x,void 0===w.U?Object:w.U,void 0===U?Object:U,void 0===S?Object:S,void 0===z?Object:z,void 0===V?Object:V,void 0===B?Object:B,void 0===A.G?Object:A.G])],$);var Y=s(10705),Q=s(63144),H=s(56618),J=s(62149),Z=s(10722),X=s(15292);const ee=e=>X.m.safeParse(e).success;class te extends((0,Q.Q)({persist:!0,storage:{initialValue:{},typeGuard:ee,schemaVersion:1},scope:J.F.User,storeName:"team-admin-data-store",storeTypeGuard:ee,codec:Z.E,isCache:!0,capacity:H.Y.Unlimited})){}const se=(e,t)=>{const{groupId:s,name:r,revision:i,users:a,privateKey:o,publicKey:n}=e;return{groupId:s,name:r,revision:i,publicKey:n,privateKey:o,groupKey:a.find((e=>e.userId===t))?.groupKey??void 0,users:[]}};class re{async getTeamAdminSharingDataSummary(e,t,s){const{specialItemGroup:r,specialItems:i,specialUserGroup:a}=await this.store.getState();if(!a)return;const o=e.find((({revision:e,id:t})=>a.groupId===t&&a.revision===e)),n=r?t.find((({revision:e,id:t})=>r.groupId===t&&r.revision===e)):void 0,c=i?s.filter((({id:e,timestamp:t})=>{const s=i[e];return s?.timestamp===t})):void 0;return{itemGroupId:n?.id,userGroupId:o?.id,itemIds:c?.map((({id:e})=>e))}}async syncTeamAdminSharingData(e,t,s,r,i){const a=await this.store.getState(),o={specialUserGroup:e?.userGroupId?a.specialUserGroup:void 0,specialItemGroup:e?.itemGroupId?a.specialItemGroup:void 0,specialItems:e?.itemIds?.reduce(((e,t)=>{const s=a.specialItems?.[t];return s&&(e[t]=s),e}),(0,d.Ay)({}))},n=t?.find((e=>"teamAdmins"===e.type));if(n){if(!await this.validationService.isUserGroupValid(n,i))return void this.store.set({});o.specialUserGroup=n}const c=s?.find((e=>"userGroupKeys"===e.type));if(c&&o.specialUserGroup){const e=k(c,i.login,[se(o.specialUserGroup,i.login)],[]);if(!(await this.validationService.isSharedItemAccessValid(c.groupId,e?.link,i)).isValid)return void this.store.set({});o.specialItemGroup=c}o.specialItemGroup?.items&&r?.forEach((e=>{const t=o.specialItemGroup?.items?.find((t=>t.itemId===e.itemId));t&&(o.specialItems||(o.specialItems={}),o.specialItems[e.itemId]=e)})),(0,Y.Z)(o,a)||this.store.set(o)}constructor(e,t){this.store=e,this.validationService=t}}re=(0,r.__decorate)([(0,l.GS)(),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===te?Object:te,void 0===S?Object:S])],re);var ie=s(35635);class ae{async execute({body:e}){const{summary:t}=e,{collections:s,userGroups:r,itemGroups:a,items:o}=t,c=await this.currentUserGetter.getCurrentUserWithKeys(),{newUserGroupIds:d,updateUserGroupIds:l,unchangedUserGroups:u}=await this.userGroupsService.getUserGroupChangesFromSummary(r),{newCollectionIds:p,updatedCollectionIds:h,unchangedCollections:m}=await this.collectionsService.getCollectionsChangesFromSummary(s),{newItemGroupIds:g,updatedItemGroupIds:v,unchangedItemGroups:y,currentSharedItems:_}=await this.itemsService.getSharedItemsChangesFromSummary(a),{newItemsIds:S,updatedItemsIds:f,unchangedItems:w}=await this.itemsService.getItemsChangesFromSummary(o,v),I=await this.teamAdminSharingDataService.getTeamAdminSharingDataSummary(r,a,o);let b=d.concat(l),E=g.concat(v),C=S.concat(f);if(I){const{itemGroupId:e,itemIds:t,userGroupId:s}=I;e&&(E=E.filter((t=>t!==e))),s&&(b=b.filter((e=>e!==s))),t?.length&&(C=C.filter((e=>!t.includes(e))))}const A=p.concat(h);if(b.length||E.length||C.length||A.length){const e=await(0,i.z)(this.serverApiClient.v1.sharingUserdevice.postSharingUserdevice({collectionIds:A,userGroupIds:b,itemGroupIds:E,itemIds:C}));if((0,n.hx)(e))throw new Error("Error getting sharing updates");const{data:t}=(0,n.db)(e),{userGroups:s,collections:r,itemGroups:a,items:d}=t;s?.length&&await this.userGroupsService.syncUserGroups(s,u,c),r?.length&&await this.collectionsService.syncCollections(r,m,c),(a||d)&&await this.itemsService.syncSharedItems(a??[],y,d??[],w,c),await this.teamAdminSharingDataService.syncTeamAdminSharingData(I,s,a,d,c),await this.itemsService.deleteItems(o,_)}return(0,n.Vp)(void 0)}constructor(e,t,s,r,i,a){this.serverApiClient=e,this.currentUserGetter=t,this.itemsService=s,this.userGroupsService=r,this.collectionsService=i,this.teamAdminSharingDataService=a}}ae=(0,r.__decorate)([(0,a.W)(c.N),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===o.l?Object:o.l,void 0===ie.a?Object:ie.a,void 0===$?Object:$,void 0===f?Object:f,void 0===E?Object:E,void 0===re?Object:re])],ae);var oe=s(86006),ne=s(41511),ce=s(29390),de=s(6489),le=s(87065),ue=s(46449);class pe{execute(){return this.store.state$.pipe((0,le.U)((e=>(0,n.Vp)(e))))}constructor(e){this.store=e}}pe=(0,r.__decorate)([(0,ue.e)(X.k),(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[void 0===te?Object:te])],pe);var he=s(76403),me=s(14139),ge=s(75028),ve=s(41613),ye=s(64222),_e=s(36093),Se=s(13186);class fe{}fe=(0,r.__decorate)([(0,oe.Yl)({api:ce.k,providers:[U,$,E,f,z,V,B,re,S],stores:[te],handlers:{commands:{runSharingSync:ae},events:{},queries:{getTeamAdminSharingData:pe}},imports:[ne.n,me.y,ge.k,ve.u,ye.a,_e.F,he.p,Se.I],requiredFeatureFlips:[de.d.SharingSyncGrapheneMigrationDev]})],fe)},92324:(e,t,s)=>{s.d(t,{Q:()=>l,w:()=>d});var r=s(43293),i=s(54066),a=s(21131),o=s(63065),n=s(89685),c=s(7499);const d=e=>{const t=(0,r.N)(e),s=(0,i.u)(t);return(0,a.n)(s)},l=e=>{const t=(0,o.L)(e),s=(0,n.v)(t);return(0,c.e)(s)}},50436:(e,t,s)=>{s.d(t,{R:()=>i});var r=s(78776);const i=()=>`{${(0,r.Z)().toUpperCase()}}`},92936:(e,t,s)=>{s.d(t,{u:()=>a});var r=s(13252);const i=(e,t)=>t?.permission===r.y3.Admin?t.permission:e,a=e=>e.reduce(i,r.y3.Limited)},98798:(e,t,s)=>{s.d(t,{B5:()=>o,HU:()=>a,l7:()=>i});var r=s(13252);function i(e){switch(e?.kwType){case"KWAuthentifiant":return"AUTHENTIFIANT";case"KWSecureNote":return"SECURENOTE";default:return"SECRET"}}function a(e){switch(e){case r.y2.Credential:return"AUTHENTIFIANT";case r.y2.SecureNote:return"SECURENOTE";default:return"SECRET"}}function o(e){switch(e){case"AUTHENTIFIANT":return"password";case"SECURENOTE":return"note";default:return"secret"}}},78262:(e,t,s)=>{var r;s.d(t,{o:()=>r}),function(e){e.User="user",e.UserGroup="group"}(r||(r={}))},21003:(e,t,s)=>{s.d(t,{E:()=>c});var r=s(13252),i=s(92936),a=s(78262);const o=({permission:e,status:t})=>e===r.y3.Admin&&t===r.qb.Accepted,n=(e,t,s)=>{const n=((e,t)=>{const s=e.users?.some((({login:e,permission:s,rsaStatus:i,status:a})=>e!==t&&s===r.y3.Admin&&"sharingKeys"===i&&a===r.qb.Accepted))??!1,i=e.users?.find((e=>e.login===t&&(e.status===r.qb.Accepted||e.status===r.qb.Pending)&&e.collectionKey));if(i&&i.collectionKey){const{permission:e,acceptSignature:t,proposeSignature:r}=i;return{link:{permission:e,acceptSignature:t,proposeSignature:r,encryptedResourceKey:i.collectionKey,accessType:a.o.User},permission:i.permission,otherAdminsFound:s}}return{permission:r.y3.Limited,otherAdminsFound:s}})(e,t),c=Boolean(n?.otherAdminsFound)||Boolean(e.userGroups?.some(o))||Boolean(e.users?.some(o));if(null!==n&&n.permission===r.y3.Admin)return{...n,otherAdminsFound:c};const d=((e,t)=>{const s=e.userGroups?.filter((e=>t.some((t=>t.groupId===e.uuid))&&e.status===r.qb.Accepted&&e.collectionKey));if(s?.length){const e=s[0],r=(0,i.u)(s);if(e.collectionKey){const{permission:s,acceptSignature:i,proposeSignature:o}=e,n=t.find((t=>t.groupId===e.uuid));if(n?.groupKey)return{link:{permission:s,acceptSignature:i,proposeSignature:o,encryptedResourceKey:e.collectionKey,groupEncryptedKey:n.groupKey,groupPrivateKey:n.privateKey,accessType:a.o.UserGroup},permission:r}}}return null})(e,s.filter((e=>e.users.some((e=>e.userId===t&&e.status===r.qb.Accepted&&e.groupKey))||e.groupKey&&e.acceptedUsers?.some((e=>e===t)))));return{...n?.link?n:d,permission:d?.permission===r.y3.Admin||n?.permission===r.y3.Admin?r.y3.Admin:r.y3.Limited,otherAdminsFound:c}},c=(e,t,s)=>{const{link:i,permission:a,otherAdminsFound:o}=n(e,s,t),c=a===r.y3.Admin&&!o,{name:d,privateKey:l,publicKey:u,revision:p,uuid:h}=e;return{id:h,name:d,privateKey:l,publicKey:u,revision:p,accessLink:i,isLastAdmin:c,isAccepted:!0,permission:a}}}}]);